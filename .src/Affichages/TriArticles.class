' Gambas class file

Private Arttable[7] As String
Private Dbl As Boolean = False
Private sel As String
Private Tri2Art As String
Private Bart As Boolean
Private B2art As Boolean
Private Org As String
Private $Org As String
Private Origine As String
Private $Centrale As String = ""
Private NbEnreg As Integer = 0 ' Enregistrement de départ de la sélection
Private lg As Integer
Private chkfocus As Boolean = True

'************************************** Gestion des articles *****************************************************
Public Sub _new(Barticle As Boolean, B2article As Boolean, TriArticle As String, sOrg As String, sFour As String, Centrale As String)
  
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  lg = Int(Colart.height / colart.Rows.Height) - 1
  Me.Center
  Origine = sOrg
  If IsNull(sFour) Then CB2.Text = ""
  If Origine = "Commande" And If Not IsNull(sFour) Then
    CB2.Text = sFour
  Endif
  If Origine = "ModifCom" And If Not IsNull(sFour) Then
    CB2.Text = sFour
  Endif
  If Origine = "Receipt" And If Not IsNull(sFour) Then
    CB2.Text = sFour
  Endif
  If Origine = "Receipta" And If Not IsNull(sFour) Then
    CB2.Text = sFour
  Endif
  If Origine = "Commande" Or If Origine = "ModifCom" Or If Origine = "Receipta" Or If Origine = "Receipt" Or If origine = "TarCli" Or If origine = "TarTypeCli" Then $Org = "C"
  $Centrale = Centrale
  Bart = Barticle
  B2art = B2article
  Tri2Art = TriArticle
  Triart()
  If $Org = "C" And If Not IsNull(CB2.Text) Then
    FourMan()
    org = "Fournisseur"
    Deb7()
  Else
    If $Org = "C" And If IsNull(CB2.Text) Then
      Deb7()
    Else
      Deb5()
      CB2.Text = ""
    Endif
  Endif
  Cb1.Text = "Equivalent"
  CO.Text = "Code"
  It.Text = "Intitulé"
  Colart.MoveTo(0, 0)
  'Try colart.Current.EnsureVisible
  Colart.SetFocus
  
End

Public Sub CO_click()
  
End

Public Sub CO_DblClick()
  
  Art_Dblclk()
  
End

Public Sub CO_GotFocus()
  
  Try Utils.ObsGotf(Co)
  CO.Select
  CO.SetFocus
  chkfocus = False
  sel = ""
  Cb1.Text = "Equivalent"
  CO.Text = ""
  It.Text = "Intitulé"
  Tri2Art = "art_code"
  NbEnreg = 0
  Dbl = ""
  If $Org = "C" Then
    Deb7()
  Else
    If Not IsNull(CB2.text) Then
      Deb1()
    Else
      Deb5()
    Endif
  Endif
  chkfocus = True
  
End

Public Sub CO_LostFocus()
  
  Try Utils.ObsLstf(CO)
  
End

Public Sub CO_KeyPress()
  
  Chkinput()
  If Key.code = Key.Escape Or Key.code = Key.F2 Then Me.close()
  If key.code = key.Down Then
    Colart.SetFocus
    Colart.MoveTo(0, 0)
  Endif
  If key.code = key.Right Then IT.SetFocus
  
End

'Public Sub Cb1_Click()

'End

Public Sub Cb1_DblClick()
  
  Art_Dblclk()
  
End

Public Sub Cb1_GotFocus()
  
  Try Utils.ObsGotf(Cb1)
  If chkfocus = True Then
    sel = ""
    Select Case Cb1.Text
      Case "Equivalent"
        Tri2Art = "art_cequ"
        'Case "Fournisseur" 
        'Tri2Art = "art_cfour"
      Case "Barre" 
        Tri2Art = "art_cbarre"
        'Case "Centrale" 
        'Tri2Art = "art_refcentrale"
      Case "CN8" 
        Tri2Art = "art_cn8"
      Case "Casier"
        Tri2Art = "art_casier"
      Case "Caracteristique"
        Tri2Art = "art_crst"
      Case Else
        Tri2Art = "art_cequ"
    End Select
    It.Text = "Intitulé"
    CO.Text = "Code"
    NbEnreg = 0
    Dbl = ""
    If $Org = "C" Then
      Deb7()
    Else
      If Not IsNull(CB2.text) Then
        Deb1()
      Else
        Deb5()
      Endif
    Endif
    Cb1.Text = ""
    Cb1.Select
  Endif
  
End

Public Sub Cb1_LostFocus()
  
  Try Utils.ObsLstf(Cb1)
  
End

Public Sub Cb1_KeyPress()
  
  Chkinput()
  If Key.code = Key.Escape Or Key.code = Key.F2 Then Me.close()
  If key.code = key.Down Then
    Colart.SetFocus
    Colart.MoveTo(0, 0)
  Endif
  
End

Public Sub It_GotFocus()
  
  Try Utils.ObsGotf(it)
  IT.Select
  IT.SetFocus
  sel = ""
  Cb1.Text = "Equivalent"
  CO.Text = "Code"
  It.Text = ""
  Tri2Art = "art_design"
  NbEnreg = 0
  Dbl = ""
  If $Org = "C" Then
    Deb7()
  Else
    If Not IsNull(CB2.text) Then
      Deb1()
    Else
      Deb5()
    Endif
  Endif
  
End

Public Sub It_DblClick()
  
  Art_Dblclk()
  
End

Public Sub It_LostFocus()
  
  Try Utils.ObsLstf(It)
  
End

Public Sub It_KeyPress()
  
  Chkinput()
  If key.code = key.f2 Or If key.code = key.Escape Then Me.close()
  If key.code = key.Down Then
    Colart.SetFocus
    Colart.MoveTo(0, 0)
  Endif
  If key.code = key.Left Then CO.SetFocus
  If key.code = key.Right Then Cb1.SetFocus
  
End

Public Sub Art_Dblclk()
  
  If $Org = "C" Then
    If Dbl = False Then
      Deb8()
      Dbl = True
    Else
      Deb7()
      Dbl = False
    Endif
  Else
    If Not IsNull(CB2.text) Then
      If Dbl = False Then
        Deb2()
        Dbl = True
      Else
        Deb1()
        Dbl = False
      Endif
    Else
      If Dbl = False Then
        Deb6()
        Dbl = True
      Else
        Deb5()
        Dbl = False
      Endif
    Endif
  Endif
  
End

Public Sub ChkInput()
  
  If InStr("\"&", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    If Not IsNull(CB2.Text) Then
      If $Org = "C" Then
        Deb7()
      Else
        Deb1()
      Endif
    Else
      If $Org = "C" Then
        Deb7()
      Else
        Deb5()
      Endif
    Endif
  Else
    Stop Event
  Endif
  
End

Public Sub triart()
  
  With ColArt
    .Columns.count = 7
    .Columns[0].Width = CO.Width
    .Columns[1].Width = It.Width
    .Columns[2].Width = Cb1.Width
    .Columns[3].Width = FO.Width
    .Columns[4].Width = PHTX.Width
    .Columns[4].Alignment = 2
    .Columns[5].Width = PVXTTC.Width
    .Columns[5].Alignment = 2
    .Columns[6].Width = QTESTK.Width - 22
    .Columns[6].Alignment = 3
  End With
  
End

Public Sub colart_Data(Row As Integer, Column As Integer)
  
  Dim sline As String
  
  With Utils
    ArtTable[0] = "art_code"
    ArtTable[1] = "art_design"
    If Tri2Art = "art_code" Then
      ArtTable[2] = "art_cequ"
    Else
      If Tri2Art = "art_design" Then
        ArtTable[2] = "art_cequ"
      Else
        If Tri2Art = "art_four" Then
          ArtTable[2] = "art_cequ"
        Else
          If Tri2Art = "art_fam" Then
            ArtTable[2] = "art_cequ"
          Else
            If Tri2Art = "art_casier" Then
              ArtTable[2] = "art_casier"
            Else
              If Tri2Art = "art_crst" Then
                ArtTable[2] = "art_crst"
              Else
                If Tri2Art = "art_cequ" Then
                  ArtTable[2] = "codequ"
                Else
                  If Tri2Art = "art_cbarre" Then
                    ArtTable[2] = "codeb"
                  Else
                    ArtTable[2] = Tri2Art
                  Endif
                Endif
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
    ArtTable[3] = "art_fam"
    ArtTable[4] = "art_pvht"
    ArtTable[5] = "art_pvttc"
    ArtTable[6] = "art_qte"
    .rs2.MoveTo(Row)
    If Tri2Art = "art_crst" Then
      For Each sline In Split(Str(.rs2[Arttable[Column]]), "\n")
        colart.data.Text = sline
        Break
      Next
    Else
      Try colart.data.Text = Str(.rs2[Arttable[Column]])
    Endif
  End With
  
End

Public Sub Deb1()
  
  Dim lpd, tri2 As String
  Dim Selection As String
  
  Selection = "'" & CB2.text & "'"
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If org = "Fournisseur"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_four = " & Selection & "  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_four = " & Selection & "  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  If org = "Famille"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_fam = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_fam = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\"  and art_fam = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  'Endif
  If org = "Centrale"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_centrale = " & Selection & "  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  and art_centrale = " & Selection & "  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\"  and art_centrale = " & Selection & "  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  Colart.Refresh
  
End

Public Sub Deb2()
  
  Dim lpd, Tri2 As String
  Dim Selection As String
  
  Selection = "'" & CB2.text & "'"
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If org = "Fournisseur"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  If org = "Famille"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Selection & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  If org = "Centrale"
    If Tri2Art = "art_design" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Selection & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      If Tri2Art = "art_cequ" Then
        tri2 = "codequ"
        lpd = "codequ"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Tri2Art = "art_cbarre" Then
          tri2 = "codeb"
          lpd = "codeb"
          Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Else
          Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" and art_four = " & Selection & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
        Endif
      Endif
    Endif
  Endif
  Colart.Refresh
  
End

Public Sub Deb5()
  
  Dim lpd, tri2 As String
  
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If Tri2Art = "art_design" Then
    'If Bart = False Then Utils.Base2(colart, "select art_code, art_design, art_cequ, art_cbarre, art_cfour, art_fam, art_pvht, art_pvttc, art_qte, art_cn8 FROM " & Cbase.Table("TabArt") & " where  " & Tri2Art & " like  \"%" & sel & "%\" and art_qte > " & 0 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    If Bart = True Then Utils.Base2(colart, "SELECT art_code, art_design, art_cequ,  art_cbarre, art_cfour, art_fam, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
  Else
    'If Bart = False Then Utils.Base2(colart, "select art_code, art_design, art_fam, art_cequ, art_cfour,  art_cbarre, art_pvht, art_pvttc, art_qte, art_cn8 FROM " & Cbase.Table("TabArt") & " where  " & Tri2Art & " like  \"" & sel & "%\" and art_qte > " & 0 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    If Tri2Art = "art_cequ" Then
      tri2 = "codequ"
      lpd = "codequ"
      Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      If Tri2Art = "art_cbarre" Then
        tri2 = "codeb"
        lpd = "codeb"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Else
        If Bart = True Then Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier, art_crst FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      Endif
    Endif
    'If Bart = True Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour,  art_cbarre, art_pvht, art_pvttc, art_qte, art_cn8 FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
  Endif
  Colart.Refresh
  
End

Public Sub Deb6()
  
  Dim lpd, tri2 As String
  
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If Tri2Art = "art_design" Then
    If Bart Then Utils.Base2(colart, "SELECT art_code, art_design, art_cequ,  art_cbarre, art_cfour, art_fam, art_pvht, art_pvttc, art_qte, art_cn8, art_casier from " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
  Else
    If Tri2Art = "art_cequ" Then
      tri2 = "codequ"
      lpd = "codequ"
      Utils.Base2(colart, "select * from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
    Else
      If Tri2Art = "art_cbarre" Then
        tri2 = "codeb"
        lpd = "codeb"
        Utils.Base2(colart, "select * from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2 & " Like \"" & sel & "%\"  order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      Else
        If Bart = True Then Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      Endif 
    Endif
  Endif
  Colart.Refresh
  
End

'On est en provenance des commandes
Public Sub Deb7()
  
  Dim lpd As String
  Dim Fournisseur As String
  
  Fournisseur = CB2.text
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If Tri2Art = "art_design" Then
    If Not IsNull(CB2.Text) Then
      If org = "Fournisseur" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      If org = "Famille" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      If org = "Centrale" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Endif
  Endif
  If Tri2Art = "art_cbarre" Then
    'Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" AND art_suspendu <> " & 1 & " and art_centrale = " & $Centrale & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    If org = "Fournisseur" Then Utils.Base2(colart, "select art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2Art & " Like \"" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & "   order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
  Else
    If Not IsNull(CB2.Text) Then
      'If org = "Fournisseur" Then Utils.Base2(colart, "select art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8 from " & Cbase.Table("TabCdBarre") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where " & tri2Art & " Like \"" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & "   order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      If org = "Fournisseur" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      If org = "Famille" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
      If org = "Centrale" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" AND art_suspendu <> " & 1 & " order by " & lpd & " limit " & NbEnreg & ", " & lg & "")
    Endif
  Endif
  'Endif
  Colart.Refresh
  
End

Public Sub Deb8()
  
  Dim lpd As String
  Dim Fournisseur As String
  
  Fournisseur = CB2.text
  If Tri2Art = "art_code" Then
    lpd = "lpad(art_code,15,' ')"
  Else
    lpd = Tri2Art
  Endif
  If Tri2Art = "art_design" Then
    If Not IsNull(CB2.Text) Then
      If org = "Fournisseur" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      If org = "Famille" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      If org = "Centrale" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
    Endif
  Else
    If Tri2Art = "art_refcentrale" Then
      Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" AND art_suspendu <> " & 1 & " and art_centrale = " & $Centrale & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
    Else
      If Not IsNull(CB2.Text) Then
        If org = "Fournisseur" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_four = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
        If org = "Famille" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_fam = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
        If org = "Centrale" Then Utils.Base2(colart, "SELECT art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"%" & sel & "%\" and art_centrale = " & Fournisseur & " AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      Else
        Utils.Base2(colart, "SELECT  art_code, art_design, art_fam, art_cequ, art_cfour, art_cbarre, art_refcentrale, art_paht, art_pvht, art_pvttc, art_qte, art_cn8, art_casier  FROM " & Cbase.Table("TabArt") & " where " & Tri2Art & " like  \"" & sel & "%\" AND art_suspendu <> " & 1 & " order by " & lpd & " desc limit " & NbEnreg & ", " & lg & "")
      Endif
    Endif
  Endif
  Colart.Refresh
  
End

Public Sub Colart_MouseWheel()
  
  If mouse.Delta = -1 Then
    If Colart.Rows.Count = lg Then NbEnreg = NbEnreg + lg
  Else
    If Colart.Rows.Count <= lg Then NbEnreg = NbEnreg - lg
  Endif
  Deplacement()
  'Endif
  Try Colart.MoveTo(0, 0)
  'Try Colart.Current.EnsureVisible
  Try Colart.SetFocus
  
End

Public Sub Remonter_Click()
  
  If Colart.Rows.Count <= lg Then NbEnreg = NbEnreg - lg
  Deplacement()
  Try Colart.MoveTo(0, 0)
  'Try Colart.Current.EnsureVisible
  Try Colart.SetFocus
  
End

Public Sub Descendre_Click()
  
  If Colart.Rows.Count = lg Then NbEnreg = NbEnreg + lg
  Deplacement()
  Try Colart.MoveTo(0, 0)
  'Try Colart.Current.EnsureVisible
  Try Colart.SetFocus
  
End

Public Sub Remonter_KeyPress()
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  If key.code = key.PageDown Then Remonter_Click()
  If key.code = key.PageUp Then Descendre_Click()
  
End

Public Sub Descendre_KeyPress()
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  If key.code = key.PageDown Then Remonter_Click()
  If key.code = key.PageUp Then Descendre_Click()
  
End

Public Sub Frame1_KeyPress()
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  
End

Public Sub Deplacement()
  
  If NbEnreg < 0 Then NbEnreg = 0
  If $Org = "C" Then
    If Dbl = True Then
      Deb8()
    Else
      Deb7()
    Endif
  Else
    If Not IsNull(CB2.text) Then
      If Dbl = True Then
        Deb2()
      Else
        Deb1()
      Endif
    Else
      If Dbl = True Then
        Deb6()
      Else
        Deb5()
      Endif
    Endif
  Endif
  
End

Public Sub colart_Click()
  
  Variables.bsel = True
  Variables.ArtCode = colart[colart.row, 0].Text
  
  Select Case Origine
      
    Case "Facture"
      Facture.Bsel = True
      Facture.Codearticle = colart[colart.row, 0].Text
      
    Case "FactureMat"
      FactureMat.Bsel = True
      FactureMat.Codearticle = colart[colart.row, 0].Text
      
    Case "Commande"
      Variables.Bselection = True
      Variables.ArtCode = colart[colart.row, 0].Text
      
    Case "ModifCom"
      ModifCom.Bsel = True
      ModifCom.Codearticle = colart[colart.row, 0].Text
      
    Case "EdArt1"
      EdArt1.Bsel = True
      EdArt1.Codearticle = colart[colart.row, 0].Text
      
    Case "EdArt2"
      EdArt2.Bsel = True
      EdArt2.Codearticle = colart[colart.row, 0].Text
      
    Case "EdArt3"
      EdArt3.Bsel = True
      EdArt3.Codearticle = colart[colart.row, 0].Text
      
    Case "Etigond"
      Variables.Bsel = True
      Variables.Codearticle = colart[colart.row, 0].Text
      
    Case "Etiqart"
      Variables.Bsel = True
      Variables.Codearticle = colart[colart.row, 0].Text
      
    Case "Etiqcasier"
      Variables.Bsel = True
      Variables.Codearticle = colart[colart.row, 0].Text
      
    Case "FpromoArt"
      FpromoArt.Bsel = True
      FpromoArt.Codearticle = colart[colart.row, 0].Text
      
    Case "Prodcomposes"
      Prodcomposes.Bsel = True
      Prodcomposes.Codearticle = colart[colart.row, 0].Text
      
    Case "Mvtex"
      Mvtex.Bsel = True
      Mvtex.Codearticle = colart[colart.row, 0].Text
      
    Case "EdStk"
      EdStk.Bsel = True
      EdStk.Codearticle = colart[colart.row, 0].Text
      
    Case "Histovart"
      Histovart.Bsel = True
      Histovart.Codearticle = colart[colart.row, 0].Text
      
    Case "Btqart"
      Btqart.Bsel = True
      Btqart.Codearticle = colart[colart.row, 0].Text
      
    Case "SupprArt"
      SupprArt.Bsel = True
      SupprArt.Codearticle = colart[colart.row, 0].Text
      
    Case "Depots"
      MvtDepots.Bsel = True
      MvtDepots.Codearticle = colart[colart.row, 0].Text
      
    Case "TarCli"
      TarCli.Bsel = True
      TarCli.Codearticle = colart[colart.row, 0].Text
      
    Case "TarTypeCli"
      TarTypeCli.Bsel = True
      TarTypeCli.Codearticle = colart[colart.row, 0].Text
      
    Case "Calcstock"
      Calcstock.Bsel = True
      Calcstock.Codearticle = colart[colart.row, 0].Text
      
  End Select
  Me.close
  
End

Public Sub colart_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colart_Click()
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  If Key.code = Key.Up Then
    If Colart.Row = 0 Then
      Descendre_Click()
    Endif
  Endif
  If Key.code = Key.down Then
    If Colart.Row = lg - 1 Then
      Remonter_Click()
    Endif
  Endif
  If Key.code = Key.PageDown Then
    Remonter_Click()
  Endif
  
  If Key.code = Key.PageUp Then
    Descendre_Click()
  Endif
  
End

'***************************************************************
'* On appelle la liste des fournisseurs  ou des familles       *
'***************************************************************
Public Sub FourMan()
  
  Dim Rfour As Result
  
  Rfour = Utils.db.Exec("SELECT fo_nom FROM " & Cbase.Table("TabFour") & " where fo_code = &1", CB2.Text)
  If Rfour.Available Then
    Fnom.Text = Rfour!fo_nom
  Else
    Message.Warning("Attention ! Ce fournisseur n'existe pas.")
  Endif
  
End

Public Sub Button1_Click()
  
  Dim Rfour As Result
  Dim Rfam As Result
  Dim Rcentrale As Result
  
  If Org = "Fournisseur" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rfour = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFour") & " ")
      If Rfour.Available Then
        Do
          Colist.Add(Rfour!fo_code, Rfour!fo_code)
          Colist.Item[0] = Rfour!fo_code
          Colist.Item[1] = Rfour!fo_nom
        Loop Until Rfour.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif
  If Org = "Famille" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rfam = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFam") & " ")
      If Rfam.Available Then
        Do
          Colist.Add(Rfam!code_fam, Rfam!code_fam)
          Colist.Item[0] = Rfam!code_fam
          Colist.Item[1] = Rfam!libell_fam
        Loop Until Rfam.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif
  If Org = "Centrale" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rcentrale = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCentrales") & " ")
      If Rcentrale.Available Then
        Do
          Colist.Add(Rcentrale!code, Rcentrale!code)
          Colist.Item[0] = Rcentrale!code
          Colist.Item[1] = Rcentrale!libelle
        Loop Until Rcentrale.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif
  
End

'**************************************************
'* Selection d'un fournisseur a la souris         *
'**************************************************
Public Sub Colist_Click()
  
  CB2.text = Colist.Item[0]
  Fnom.text = Colist.Item[1]
  Colist.clear
  Colist.visible = False
  Deb1()
  CB2.SetFocus
  
End

'***********************************************************
'* Selection d'un fournisseur/famille manuellement         *
'***********************************************************
Public Sub Colist_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colist_Click()
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colist.visible = False
    Colist.clear
    CB2.SetFocus
    Stop Event
  Endif
  
End

Public Sub CB2_KeyPress()
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then Me.close()
  
End

Public Sub CB2_GotFocus()
  
  Try Utils.ObsGotf(Cb2)
  
End

Public Sub CB2_LostFocus()
  
  Dim CoulZns As Integer ' Variable pour la couleur du background des zones de saisie
  Dim Frmt As New String[]
  
  Frmt = Utils.FColr(Settings["/Coul/Znss"])
  CoulZns = Val(Frmt[0])
  CB2.Background = CoulZns
  
End

Public Sub CB2_Click()
  
  CB2.SetFocus
  CB2.Select
  Org = CB2.text
  Button1_Click()
  
End
