' Gambas class file

Private CoTable As New String[5]
Private Dbl As Boolean = False
Private sel As String
Private NbEnreg As Integer = 0 ' Enregistrement de départ de la sélection
Private Tri As String
Private Type As String
Private Type2 As String
Private lg As Integer
Private origine As String
Private scompte As String

'************************************** Gestion des comptes comptables *****************************************************
Public Sub _new(sTri As String, sType As String, stype2 As String, sOrg As String)

  Utils.Observers(Me)
  lg = Int(Colco2.height / Colco2.Rows.Height) - 1
  Comptabilite.sCmpt = ""
  Tri = sTri
  Type = sType
  Type2 = stype2
  Origine = sOrg
  Tris()
  If Type = "G" Or If Type = "B" Then
    Co.SetFocus
    Co.Select
  Else
    Intit.SetFocus
  Endif
  Colco2.MoveTo(0, 0)
  Try Colco2.Current.EnsureVisible

End

Public Sub Colco2_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colco2_Click()
  Endif
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Comptabilite.Bsel = False
    Me.Close
  Endif
  If Key.code = Key.Up Then
    If Colco2.Row = 0 Then
      Remonter_Click()
    Endif
  Endif
  If Key.code = Key.down Then
    If Colco2.Row = lg - 1 Then
      Descendre_Click()
    Endif
  Endif
  If Key.code = Key.PageDown Then
    Descendre_Click()
  Endif

  If Key.code = Key.PageUp Then
    Remonter_Click()
  Endif

End

Public Sub Colco2_MouseWheel()

  If mouse.Delta = -1 Then
    If Colco2.Rows.Count = lg Then NbEnreg = NbEnreg + lg
  Else
    If Colco2.Rows.Count <= lg Then NbEnreg = NbEnreg - lg
  Endif
  Deplacement()

End

Public Sub Descendre_Click()

  If Colco2.Rows.Count = lg Then
    NbEnreg = NbEnreg + lg
    Deplacement()
  Endif
  Try Colco2.MoveTo(0, 0)
  Try Colco2.Current.EnsureVisible
  Try Colco2.SetFocus

End

Public Sub Remonter_Click()

  NbEnreg = NbEnreg - lg
  Deplacement()
  Try Colco2.MoveTo(0, 0)
  Try Colco2.Current.EnsureVisible
  Try Colco2.SetFocus

End

Public Sub Descendre_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  If key.code = key.PageDown Then Descendre_Click()
  If key.code = key.PageUp Then Remonter_Click()

End

Public Sub Remonter_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif
  If key.code = key.PageDown Then Descendre_Click()
  If key.code = key.PageUp Then Remonter_Click()

End

Public Sub Deplacement()

  If NbEnreg < 0 Then NbEnreg = 0
  If Dbl = True Then
    Deb5()
  Else
    Deb4()
  Endif

End

Public Sub Colco2_Click()

  Comptabilite.Bsel = True
  Try Comptabilite.sCmpt = Colco2[Colco2.row, 0].Text
  Try Comptabilite.sDesg = Colco2[Colco2.row, 1].Text
  Me.close

End

Public Sub Colco2_Data(Row As Integer, Column As Integer)

  Dim Rscli As Result

  With Utils
    CoTable[0] = "compte_cc"
    CoTable[1] = "intitule_cc"
    CoTable[2] = "type_cc"
    CoTable[3] = "solde"
    CoTable[4] = "coll_cc"
    .rs2.MoveTo(Row)
    Try Colco2.data.Text = Str(.rs2[CoTable[Column]])
    If column = 0 Then scompte = Colco2.data.Text
    If column = 1 And type = "C" Then
      RsCli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", scompte)
      Colco2.data.Text = Rscli!cli_nom & " " & Rscli!cli_pnm & " " & Rscli!cli_cd_ptl & " " & Rscli!cli_ville
    Else
      If column = 1 And type = "F" Then
        RsCli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFour") & " where fo_code = &1", scompte)
        Colco2.data.Text = Rscli!fo_nom & " " & Rscli!fo_pnm & " " & Rscli!fo_cd_ptl & " " & Rscli!fo_ville
      Endif
    Endif
    If column = 2 Then Colco2.Data.Alignment = 3
    If column = 3 Then
      Colco2.data.Text = Format$(Val(.cpoint(Colco2.data.Text)), "0.00")
      Colco2.Data.Alignment = 2
    Endif
  End With
Catch

End

Public Sub Tris()

  With Colco2
    .Columns.count = 5
    .Columns[0].Width = CO.Width
    .Columns[1].Width = Intit.Width
    Try .Columns[2].Width = Ty.Width
    Try .Columns[3].Width = Sol.Width
    Try .Columns[4].Width = Co2.Width
  End With

End

Public Sub Co_GotFocus()

  Try Utils.ObsGotf(Co)
  Co_Click()

End

Public Sub Co_LostFocus()

  Try Utils.ObsLstf(CO)

End

Public Sub Intit_GotFocus()

  Try Utils.ObsGotf(intit)
  Intit_Click()

End

Public Sub Intit_LostFocus()

  Try Utils.ObsLstf(Intit)

End

Public Sub Co_Click()

  sel = ""
  Dbl = ""
  Co.Text = ""
  Intit.Text = "Intitulé"
  Tri = "cast(compte_cc AS char)"
  NbEnreg = 0
  Dbl = ""
  Deb4()

End

Public Sub Co_Dblclick()

  Dbclk()

End

Public Sub Co_KeyPress()

  If InStr("\"&'", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    If Left$(sel, 1) = "6" Or If Left$(sel, 1) = "7" Then
      Deb6()
    Else
      Deb4()
    Endif
  Endif
  If key.code = key.Esc Or Key.code = key.f2 Then
    Me.close
  Endif
  If key.Code = key.F1 Then Doc.Open("Lettrage")
  If key.code = key.Down Then Colco2.SetFocus
  If key.code = key.Right Then Intit.SetFocus

End

Public Sub Intit_Click()

  sel = ""
  Dbl = ""
  Co.Text = "Code"
  Intit.Text = ""
  Tri = "intitule_cc"
  NbEnreg = 0
  Dbl = ""
  Deb4()

End

Public Sub Intit_Dblclick()

  Dbclk()

End

Public Sub Intit_KeyPress()

  If InStr("\"&'", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    Deb4()
  Endif
  If key.code = key.Esc Or Key.code = key.f2 Then
    Me.close
  Endif
  If key.Code = key.F1 Then Doc.Open("Lettrage")
  If key.code = key.Down Then Colco2.SetFocus
  If key.code = key.Right Then Co.SetFocus
  If key.code = key.Left Then Co.SetFocus
Catch

End

Public Sub Dbclk()

  If Not Dbl Then
    Deb5()
    Dbl = True
  Else
    Deb4()
    Dbl = False
  Endif

End

Public Sub Ref()

  Tri = "cast(compte_cc AS char)"
  Tris()

End

Public Sub Deb2()

  Utils.Base2(Colco2, "select * from " & Cbase.Table("TabComptes") & " where " & Tri & " like  \"" & sel & "%\"  and cprincipal = " & "0" & "  order by " & Tri & "")
  Colco2.Refresh

End

Public Sub Deb3()

  Utils.Base2(Colco2, "select * from " & Cbase.Table("TabComptes") & " where " & Tri & " like  \"" & sel & "%\"  and cprincipal = " & "0" & "    order by " & Tri & " Desc")
  Colco2.Refresh

End

Public Sub Deb4()

  If Origine = "Lettrage" Then
    If Type = "G" And Type2 = "B" Then
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type2 & "%\"  and cprincipal = " & "0" & "  and lettrable = " & 1 & "  or type_cc like  \"" & Type & "%\" and coll <> " & 1 & "  and cprincipal = " & "0" & "  and lettrable <> False order by " & Tri & " limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type & "%\"  and lettrable <> false order by " & Tri & " limit " & NbEnreg & ", " & lg & " ")
    Endif
  Else
    If Type = "G" And Type2 = "B" Then
      'Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type2 & "%\" and cprincipal = " & "0" & "  or type_cc like  \"" & Type & "%\" and coll <> " & 1 & "  and cprincipal = " & "0" & " order by " & Tri & " limit " & NbEnreg & ", " & lg & "")
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc <>  \"" & Type2 & "%\" and cprincipal = " & "0" & "  or type_cc <>  \"" & Type & "%\" and coll <> " & 1 & "  and cprincipal = " & "0" & " order by " & Tri & " limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type & "%\" order by " & Tri & " limit " & NbEnreg & ", " & lg & " ")
    Endif
  Endif
  Colco2.Refresh

End

Public Sub Deb5()

  If Origine = "Lettrage" Then
    If Type = "G" And Type2 = "B" Then
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type2 & "%\"  and cprincipal = " & "0" & " and lettrable = " & 1 & " Or type_cc Like \"" & Type & "%\" And coll <> " & 1 & " and lettrable <> false  order by " & Tri & " Desc  limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type & "%\" and lettrable <> false  order by " & Tri & " Desc  limit " & NbEnreg & ", " & lg & "")
    Endif
  Else
    If Type = "G" And Type2 = "B" Then
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type2 & "%\"  and cprincipal = " & "0" & " Or type_cc Like \"" & Type & "%\" And coll <> " & 1 & " and lettrable <> false  order by " & Tri & " Desc  limit " & NbEnreg & ", " & lg & "")
    Else
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & Type & "%\" order by " & Tri & " Desc  limit " & NbEnreg & ", " & lg & "")
    Endif
  Endif
  Colco2.Refresh

End

Public Sub Deb6()

  If Type = "G" Then
    Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & "G" & "%\" order by " & Tri & "")
  Else
    If Type = "B" Then
      Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"%" & sel & "%\" and type_cc like  \"" & "B" & "%\" order by " & Tri & "")
    Endif
  Endif

End

Public Sub Deb7()

  If Type <> "B" Then
    '  Utils.Base2(Colco, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\" and coll <> " & 1 & " or " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type2 & "%\" and coll <> " & 1 & " order by " & Tri & " Desc")
  Else
    '  Utils.Base2(Colco, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\" and coll <> " & 1 & " or " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type2 & "%\" order by " & Tri & " Desc")
  Endif

End

'Pour un journal de trésorerie on ne récupère pas les comptes banque

Public Sub Deb8()

  If Type <> "B" Then
    Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\"  and coll <> " & 1 & "  and cprincipal = " & "0" & "  order by " & Tri & " limit " & NbEnreg & ", " & lg & "")
  Else
    Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\"  and comptr_cc = " & 0 & "  and cprincipal = " & "0" & "  order by " & Tri & " limit " & NbEnreg & ", " & lg & "")
  Endif
  Colco2.Refresh

End

Public Sub Deb9()

  If Type <> "B" Then
    Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\" and coll <> " & 1 & "  and cprincipal = " & "0" & "  order by " & Tri & " Desc limit " & NbEnreg & ", " & lg & "")
  Else
    Utils.Base2(Colco2, "SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE " & Tri & " like  \"" & sel & "%\" and type_cc like  \"" & Type & "%\" and comptr_cc = " & 0 & "  and cprincipal = " & "0" & "  order by " & Tri & " Desc limit " & NbEnreg & ", " & lg & "")
  Endif
  Colco2.Refresh

End
