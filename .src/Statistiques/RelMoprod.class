' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : RelvMoProd.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 18/07/2009
'# Relevés de la MO et des produits par client
'################################################
'
dte As String
dte1 As String
dte2 As String
jour As String
son As Integer = Start.Son
Clitable[9] As String
Coulfond As New String[]
PosY As Integer
Stats As Collection
Tri As String
Sens As String
sel As String
Dbl As String
CoulB As Integer ' Variable pour la couleur du background
CoulF As Integer ' Variable pour la couleur du Foreground
Private pdf As Cdocuments

Public Sub Form_Open()

  Dim Frmt As New String[]

  Coulfond = Utils.Coulfd()
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Fnets"])
  Utils.Observers(Me)
  Music.Load(Start.Musique)
  Me.Center
  jour = Format$(Now, "dd.mm.yyyy")
  ex1()
  Utils.Observers(Me)
  dteN0_GotFocus()
  dteN0.SetFocus

End

Public Sub Cmpt_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

'*****************************************
'*    On genere les dates de travail     *
'*****************************************
Public Sub Ex1()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    dteN0.Text = .Calc_mois(dte)
    jour = Format$(Now, "dd.mm.yyyy")
    dteN1.Text = jour
    dte1 = dteN0.Text
    dte2 = dteN1.Text
  End With

End

Public Sub Cmpt_KeyPress()

  Select Case Last.tag

    Case 1
      If Key.code = Key.enter Or Key.code = Key.Return Then
        dteN0_LostFocus()
        Stop Event
      Endif

    Case 2
      If Key.code = Key.enter Or Key.code = Key.Return Then
        dteN1_LostFocus()
        Stop Event
      Endif

  End Select

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

Public Sub dteN0_GotFocus()

  dteN0.Background = &HAAFF7F&
  dteN0.Select

End

Public Sub dteN0_LostFocus()

  With utils
    dteN0.text = .Cdate_calc(dteN0.text)
    dteN0.Text = .Cdate_aff(dteN0.Text)
    If dteN0.Text = "00.00.0:00" Then dteN0.Text = Format$(Now, "dd.mm.yyyy")
  End With
  dteN0.Background = Color.TextBackground
  dteN1.SetFocus
  dteN1.select
Catch
  dteN0_GotFocus()
  dteN0.setfocus

End

Public Sub dteN1_GotFocus()

  dteN1.Background = &HAAFF7F&

End

Public Sub dteN1_LostFocus()

  With utils
    dteN1.text = .Cdate_calc(dteN1.text)
    dteN1.Text = .Cdate_aff(dteN1.Text)
    If dteN1.Text = "00.00.0:00" Then dteN1.Text = Format$(Now, "dd.mm.yyyy")
  End With
  dteN1.Background = Color.TextBackground
  dteN0.SetFocus
  dteN0.select
Catch
  dteN1_GotFocus()
  dteN1.setfocus

End

Public Sub Button1_Click()

  Dim rrResult As Result
  Dim sResult As Result
  Dim cResult As Result
  Dim b As Boolean = False

  RlCli.Clear
  Me.Mouse = Mouse.Wait
  With Utils
    Message.Info("Soyez patient SVP! Ce traitement peut prendre quelques minutes")
    .db.Exec("DROP TABLE if exists " & Cbase.Table("TabStat") & "")
    .db.EXEC("CREATE TABLE " & Cbase.Table("TabStat") &
      " (code Char(15) NOT NULL," &
      "intitule char(50) ," &
      "qte char(12) ," &
      "type char(1) ," &
      "montant char(12) ," &
      "codecli char(12) ," &
      "intitulecli char(35) ," &
      "numfac char(10) ," &
      "qtefac char(6) ," &
      "nethtfac char(10) ," &
      "PRIMARY KEY (code, codecli, numfac))" & Utils.db.Engine())

    If Not IsNull(dteN0.Text) And If Not IsNull(dteN1.Text) Then
      If RB1.value = True Then
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabBl") & " where datebl >= &1 and datebl <= &2 and type = &3 and imp = &4 order by cdclibl", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text), "F", 1)
      Else
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabBl") & " where datebl >= &1 and datebl <= &2 and type = &3 and imp = &4 and cdclibl = &5", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text), "F", 1, Code.Text)
      Endif
      If cResult.Available Then
        b = True
        Repeat
          rrResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabLigbl") & " where num_ligbl = &1 and typel_ligbl = &2 or num_ligbl = &1 and typel_ligbl = &3", cResult!numbl, "M", "A")
          If rrResult.Available Then
            Repeat
              Sresult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabStat") & " where code = &1 and codecli = &2 and numfac = &3", rrResult!code_ligbl, cResult!cdclibl, cResult!numfac)
              If Not Sresult.Available Then Utils.db.Exec("INSERT INTO " & Cbase.Table("TabStat") & " (code, intitule, codecli, intitulecli, type, numfac, qtefac, nethtfac) VALUES (&1, &2, &3, &4, &5, &6, &7, &8)", rrResult!code_ligbl, rrResult!libel_ligbl, cResult!cdclibl, cResult!nmclibl, rrResult!typel_ligbl, cResult!numfac, rrResult!qte_ligbl, rrResult!netht_ligbl)
            Until rrResult.MoveNext()
          Endif
        Until cResult.MoveNext()
      Endif
      If RB1.value = True Then
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisFac") & " where datefac >= &1 and datefac <= &2 order by cdclifac", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text))
      Else
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisFac") & " where datefac >= &1 and datefac <= &2 and cdclifac = &3", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text), Code.Text)
      Endif
      If cResult.Available Then
        b = True
        Repeat
          rrResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisLigFac") & " where num_ligfac = &1 and typel_ligfac = &2 or num_ligfac = &1 and typel_ligfac = &3", cResult!numfac, "M", "A")
          If rrResult.Available Then
            Repeat
              Sresult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabStat") & " where code = &1 and codecli = &2 and numfac = &3", rrResult!code_ligfac, cResult!cdclifac, cResult!numfac)
              If Not Sresult.Available Then Utils.db.Exec("INSERT INTO " & Cbase.Table("TabStat") & " (code, intitule, codecli, intitulecli, type, numfac, qtefac, nethtfac) VALUES (&1, &2, &3, &4, &5, &6, &7, &8)", rrResult!code_ligfac, rrResult!libel_ligfac, cResult!cdclifac, cResult!nmclifac, rrResult!typel_ligfac, cResult!numfac, rrResult!qte_ligfac, rrResult!netht_ligfac)
            Until rrResult.MoveNext()
          Endif
        Until cResult.MoveNext()
      Endif
      If RB1.value = True Then
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisFacm") & " where datefac >= &1 and datefac <= &2 order by cdclifac", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text))
      Else
        cResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisFacm") & " where datefac >= &1 and datefac <= &2 and cdclifac = &3", .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text), Code.Text)
      Endif
      If cResult.Available Then
        b = True
        Repeat
          rrResult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabHisLigFacm") & " where num_ligfac = &1 and typel_ligfac = &2 or num_ligfac = &1 and typel_ligfac = &3", cResult!numfac, "M", "A")
          If rrResult.Available Then
            Repeat
              Sresult = Utils.db.Exec("SELECT * from " & Cbase.Table("TabStat") & " where code = &1 and codecli = &2 and numfac = &3", rrResult!code_ligfac, cResult!cdclifac, cResult!numfac)
              If Not Sresult.Available Then Utils.db.Exec("INSERT INTO " & Cbase.Table("TabStat") & " (code, intitule, codecli, intitulecli, type, numfac, qtefac, nethtfac) VALUES (&1, &2, &3, &4, &5, &6, &7, &8)", rrResult!code_ligfac, rrResult!libel_ligfac, cResult!cdclifac, cResult!nmclifac, rrResult!typel_ligfac, cResult!numfac, rrResult!qte_ligfac, rrResult!netht_ligfac)
            Until rrResult.MoveNext()
          Endif
        Until cResult.MoveNext()
      Endif
      If b = True Then
        MajTab()
      Else
        Message.Info("Il n'y a aucune donnée pour ce client")
      Endif
      Me.Mouse = Mouse.Default
    Else
      If son Then
        Music.Play
      Endif
      Message.Info("Veuillez saisir votre date SVP")
      If IsNull(dteN1.Text) Then
        dteN1_GotFocus()
        dteN1.SetFocus
      Else
        dteN0_GotFocus()
        dteN0.SetFocus
      Endif
    Endif
  End With
Catch

End

Public Sub MajTab()

  Dim rResult As Result
  Dim Moresult As Result
  Dim Cliresult As Result
  Dim tri2 As String
  Dim Intcli As String

  Stats = New Collection
  If RB3.Value = True Then
    tri = "codecli"
    tri2 = "code"
  Else
    tri = "code"
    tri2 = "codecli"
  Endif
  If RB4.Value = True Then
    Try Rlcli.Add("MO", "Main d'oeuvre")
    Try Rlcli.Add("ART", "Articles")
  Endif
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " order by " & tri & ", " & tri2 & "")
  If rResult.Available Then
    Repeat
      Cliresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", rResult!codecli)
      Intcli = Cliresult!cli_rs_soc & " " & Cliresult!cli_nom
      If RB3.value Then
        Try Rlcli.Add(rResult!codecli, rResult!codecli & " " & Intcli)
        Moresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " where codecli = &1 order by type, " & tri & ", code, numfac ", rResult!codecli)
      Else
        Moresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " where codecli = &1 order by type, " & tri & ", codecli, numfac ", rResult!codecli)
      Endif
      If Moresult.Available Then
        Repeat
          Rlcli.MoveFirst()
          Repeat
            Rlcli.Item.Selected = True
            If RB3.Value = True Then
              If Rlcli.Item.Key = rResult!codecli Then
                If MoResult!type = "M" Then
                  Try Rlcli.Add(rResult!codecli & "MO", "Main d'oeuvre", Picture["Icones/Mo.png"], Rlcli.Item.Key)
                  Try Rlcli.Add(rResult!codecli & Moresult!code, Moresult!code & String$(15 - Len(Moresult!code), " ") & Moresult!intitule & String$(50 - Len(Moresult!intitule), " ") & Moresult!qte & String$(10 - Len(Moresult!qte), " "),, rResult!codecli & "MO")
                  Try Rlcli.Add(rResult!codecli & ";" & Moresult!code & Moresult!numfac, "Facture numéro " & Moresult!numfac & " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " ") & " Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "),, rResult!codecli & Moresult!code)
                Else
                  Try Rlcli.Add(rResult!codecli & "ART", "Articles", Picture["Icones/Article.png"], Rlcli.Item.Key)
                  Try Rlcli.Add(rResult!codecli & Moresult!code, Moresult!code & String$(15 - Len(Moresult!code), " ") & Moresult!intitule & String$(50 - Len(Moresult!intitule), " ") & Moresult!qte & String$(10 - Len(Moresult!qte), " "),, rResult!codecli & "ART")
                  Try Rlcli.Add(rResult!codecli & ";" & Moresult!code & Moresult!numfac, "Facture numéro " & Moresult!numfac & " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " ") & " Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "),, rResult!codecli & Moresult!code)
                Endif
              Endif
            Endif
            If RB4.Value = True Then
              If MoResult!type = "M" Then
                Try Rlcli.Add(Moresult!code, Moresult!code & String$(15 - Len(Moresult!code), " ") & Moresult!intitule & String$(50 - Len(Moresult!intitule), " ") & Moresult!qte & String$(10 - Len(Moresult!qte), " "),, "MO")
                Try Rlcli.Add(rResult!codecli & Moresult!code, rResult!codecli & " " & rResult!intitulecli,, Moresult!code)
                Try Rlcli.Add(rResult!codecli & ";" & Moresult!code & Moresult!numfac, "Facture numéro " & Moresult!numfac & " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " ") & " Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "),, rResult!codecli & Moresult!code)
              Else
                Try Rlcli.Add(Moresult!code, Moresult!code & String$(15 - Len(Moresult!code), " ") & Moresult!intitule & String$(50 - Len(Moresult!intitule), " ") & Moresult!qte & String$(10 - Len(Moresult!qte), " "),, "ART")
                Try Rlcli.Add(rResult!codecli & Moresult!code, rResult!codecli & " " & rResult!intitulecli,, Moresult!code)
                Try Rlcli.Add(rResult!codecli & ";" & Moresult!code & Moresult!numfac, "Facture numéro " & Moresult!numfac & " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " ") & " Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "),, rResult!codecli & Moresult!code)
              Endif
            Endif
          Until Rlcli.MoveNext()
        Until Moresult.MoveNext()
      Endif
      Wait 0.01
    Until rResult.MoveNext()
  Endif
Catch

End

Public Sub Button4_Click()

  Dim rResult As Result
  Dim Moresult As Result
  Dim Cliresult As Result
  Dim tri2 As String
  Dim tri3 As String
  Dim Filename As String
  Dim b As Integer
  Dim b2 As Integer
  Dim nom As String
  Dim Code As String
  Dim Type As String

  Filename = User.Home & "/tmp/HistoMoArt.pdf"
  Stats = New Collection
  Shell "cd " & User.Home & ""
  pdf = New Cdocuments("Portrait", "mm", "A4")
  pdf.Open()
  pdf.AliasNbPages()
  If RB3.value Then
    If Rlcli.Count > 0 Then
      Me.Mouse = Mouse.Wait
      tri = "codecli"
      tri2 = "code"
      pdf.EnteteN("Impression des historiques des ventes Client/MO et Produit")
      posy = 13
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " order by " & tri & ", " & tri2 & "")
      If rResult.Available Then
        Repeat
          If Nom <> rResult!codecli Then
            Cliresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", rResult!codecli)
            b = 1
            b2 = 1
            pdf.Lines(Posy)
            PosY += 5
            pdf.level2RL(rResult!codecli, Cliresult!cli_nom, "", "", "", "G", posy)
            PosY += 5
            Moresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " where codecli = &1 order by type, " & tri & ", code, numfac ", rResult!codecli)
            If Moresult.Available Then
              Repeat
                If MoResult!type = "M" Then
                  If b = 1 Then
                    pdf.level2RL("Main d'oeuvre", "", "", "", "", "G", posy)
                    PosY += 5
                  Endif
                  pdf.Level2RL(Moresult!code, Moresult!intitule, "Facture numéro " & Moresult!numfac, " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " "), "Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "), "N", Posy)
                  PosY += 5
                  b = 0
                Else
                  If b2 = 1 Then
                    pdf.Level2RL("Articles", "", "", "", "", "G", Posy)
                    PosY += 5
                  Endif
                  pdf.Level2RL(Moresult!code & String$(15 - Len(Moresult!code), " "), Moresult!intitule & String$(50 - Len(Moresult!intitule), " "), "Facture numéro " & Moresult!numfac, " Qté = " & Moresult!qtefac & String$(10 - Len(Moresult!qtefac), " "), " Pv net HT " & Moresult!nethtfac & String$(10 - Len(Moresult!nethtfac), " "), "N", Posy)
                  PosY += 5
                  b2 = 0
                Endif
                If PosY >= 273 Then
                  pdf.Baspage()
                  pdf.EnteteN("Impression des historiques des ventes Client/MO et Produit")
                  PosY = 13
                  pdf.Lines(Posy)
                  PosY += 5
                Endif
              Until Moresult.MoveNext()
            Endif
            Nom = rResult!codecli
          Endif
        Until rResult.MoveNext()
        pdf.Footer()
        pdf.Output(Filename, False)
        Visualiseur.Prog_Editeur(Filename)
      Else
        If son Then
          Music.Play
        Endif
        message(" Aucune impression pour cette demande", "OK")
      Endif
      Me.mouse = Mouse.Default
    Else
      Message.Warning("Veuillez lancer le traitement avant l'impression SVP !")
    Endif
  Endif
  If RB4.value Then
    If Rlcli.Count > 0 Then
      Me.Mouse = Mouse.Wait
      tri = "type"
      tri2 = "code"
      tri3 = "numfac"
      pdf.Baspage()
      pdf.EnteteN("Impression des historiques des ventes Client/MO et Produit")
      PosY = 13
      pdf.Lines(PosY)
      PosY += 5
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " order by type, code, codecli, numfac")
      If rResult.Available Then
        Repeat
          If type <> rResult!type Then
            If rResult!type = "A" Then
              PosY += 5
              pdf.Level5RL("Articles", Posy)
              PosY += 5
            Else
              pdf.EnteteN("Impression des historiques des ventes MO et Produit/Client")
              PosY = 13
              pdf.Lines(Posy)
              PosY += 5
              pdf.Level5RL("Main d'oeuvre", Posy)
              PosY += 5
              b = 1
            Endif
          Endif
          If code <> rResult!code Then
            pdf.lines(Posy)
            PosY += 5
            pdf.Level4RL(rResult!code, rResult!intitule, Posy)
            PosY += 5
            b = 0
          Endif
          Moresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStat") & " where codecli = &1 and code = &2 and numfac = &3 order by numfac", rResult!codecli, rResult!code, rResult!numfac)
          Repeat
            Cliresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", rResult!codecli)
            pdf.Level2RL(rResult!codecli, Cliresult!cli_nom, "Facture numéro " & MoResult!numfac, " Qté = " & MoResult!qtefac & String$(10 - Len(MoResult!qtefac), " "), "Pv net HT " & MoResult!nethtfac & String$(10 - Len(MoResult!nethtfac), " "), "N", Posy)
            PosY += 5
            Controle()
          Until Moresult.MoveNext()
          Code = rResult!code
          type = rResult!type
        Until rResult.MoveNext()
        pdf.Footer()
        pdf.Output(Filename, False)
        Visualiseur.Prog_Editeur(Filename)
      Else
        If son Then
          Music.Play
        Endif
        message(" Aucune impression pour cette demande", "OK")
      Endif
      Me.mouse = Mouse.Default
    Else
      Message.Warning("Veuillez lancer le traitement avant l'impression SVP !")
    Endif
  Endif

End

Public Sub Controle()

  If PosY >= 273 Then
    If RB3.Value = True Then
      pdf.EnteteN("Impression des historiques des ventes Client/MO et Produit")
    Else
      pdf.EnteteN("Impression des historiques des ventes MO et Produit/Client")
    Endif
    PosY = 30
    pdf.lines(posy)
    PosY += 5
  Endif

End

Public Sub RB1_Click()

  Label4.visible = False
  Code.visible = False
  Int.visible = False
  ToggleButton3.Visible = False
  Colcli.visible = False
  HBox4.visible = False

End

Public Sub RB2_Click()

  Label4.visible = True
  Code.visible = True
  Int.visible = True
  ToggleButton3.Visible = True
  ToggleButton3_click()

End

Public Sub RB3_Click()

  Rlcli.clear

End

Public Sub RB4_Click()

  Rlcli.clear

End

'**************************************
'*      Affichage d'une facture       *
'**************************************
Public Sub Rlcli_click()

  Dim Rcli As Result
  Dim rart As Result
  Dim sline As String
  Dim Lg As Integer = 1
  Dim CClient As String
  Dim iPos As Integer
  Dim numbl As String

  Totalfac.Text = "0,00"
  Colrcp3.clear
  Colrcp3.Columns.count = 7
  Colrcp3.Columns[0].Width = 50
  Colrcp3.Columns[1].Width = 140
  Colrcp3.Columns[2].Width = 300
  Colrcp3.Columns[3].Width = 60
  Colrcp3.Columns[4].Width = 80
  Colrcp3.Columns[5].Width = 80
  Colrcp3.Columns[6].Width = 80
  Colrcp3.Columns[0].Text = "Ligne"
  Colrcp3.Columns[1].Text = "Code"
  Colrcp3.Columns[2].Text = "Designation"
  Colrcp3.Columns[3].Text = "Qté "
  Colrcp3.Columns[3].Alignment = 2
  Colrcp3.Columns[4].Text = "Px brut ht"
  Colrcp3.Columns[4].Alignment = 2
  Colrcp3.Columns[5].Text = "Remise"
  Colrcp3.Columns[5].Alignment = 2
  Colrcp3.Columns[6].Text = "Px net ht"
  Colrcp3.Columns[6].Alignment = 2
  With Utils
    If Rlcli.Count Then
      iPos = InStr(Rlcli.Item.key, ";")
      CClient = Left$(Rlcli.Item.key, iPos - 1)
      Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " WHERE cli_code = &1", CClient)
      codecli.Text = Rcli!cli_code
      nomcli.Text = Rcli!cli_nom
      numfac.Text = Right$(Rlcli.Item.key, 10)
      Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabHisFac") & " WHERE numfac = &1 union SELECT * FROM " & Cbase.Table("TabHisFacm") & " WHERE numfac = &1 ", Numfac.Text)
      If Rcli.Available Then datef.Text = .Cdate_Aff(Rcli!datefac)
      Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabHisLigFac") & " WHERE num_ligfac = &1 union SELECT * FROM " & Cbase.Table("TabHisLigFacm") & " WHERE num_ligfac = &1", Numfac.Text)
      If Rcli.Available Then
        Panel3.Visible = True
        Colrcp3.Visible = True
        Do
          If Rcli!typel_ligfac <> "C" Then
            Colrcp3.Add(Rcli!numlig_ligfac, Rcli!numlig_ligfac)
            Colrcp3.Item[1] = Rcli!code_ligfac
            rart = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " WHERE art_code = &1", Rcli!code_ligfac)
            If rart.Available Then
              Colrcp3.Item[2] = .CDec(rart!art_dec, Rcli!qte_ligfac)
            Endif
            If Not Colrcp3.Item[3] Then Colrcp3.Item[3] = Rcli!qte_ligfac
            Colrcp3.Item[2] = Rcli!libel_ligfac
            Colrcp3.Item[4] = Rcli!brut_ligfac
            If Not Colrcp3.Item[3] Then Colrcp3.Item[3] = 0
            Colrcp3.Item[5] = Rcli!rem_ligfac
            Colrcp3.Item[6] = Rcli!netht_ligfac & "  "
            If Colrcp3.Item[6] Then Totalfac.Text = Format$(Val(Totalfac.Text) + (Val(Rcli!netht_ligfac) * Val(Rcli!qte_ligfac)), "0.00")
          Else
            If Rcli!typel_ligfac = "C"
              For Each sline In Split(Rcli!com_ligfac, "\n")
                Colrcp3.Add(Rcli!numlig_ligfac & Lg, Rcli!numlig_ligfac & Lg)
                Colrcp3.Item[0] = Rcli!numlig_ligfac
                Colrcp3.Item[2] = sline
                Inc lg
              Next
            Endif
          Endif
        Loop Until Rcli.MoveNext()
        Nlgf.Text = Colrcp3.count
      Else
        Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabBl") & " WHERE numfac = &1", Numfac.Text)
        If Rcli.Available Then
          datef.Text = .Cdate_Aff(Rcli!datebl)
          numbl = Rcli!numbl
        Endif
        If Not IsNull(numbl) Then
          Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigbl") & " WHERE num_ligbl = &1", Numbl)
          If Rcli.Available Then
            Panel3.Visible = True
            Colrcp3.Visible = True
            Do
              If Rcli!typel_ligbl <> "C" Then
                Colrcp3.Add(Rcli!numlig_ligbl, Rcli!numlig_ligbl)
                rart = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " WHERE art_code = &1", Rcli!code_ligbl)
                If rart.Available Then
                  Colrcp3.Item[3] = .CDec(rart!art_dec, Rcli!qte_ligbl)
                Endif
                If Not Colrcp3.Item[2] Then Colrcp3.Item[2] = Rcli!qte_ligbl
                Colrcp3.Item[1] = Rcli!code_ligbl
                Colrcp3.Item[2] = Rcli!libel_ligbl
                Colrcp3.Item[4] = Rcli!brut_ligbl
                If Not Colrcp3.Item[3] Then Colrcp3.Item[3] = Rcli!qte_ligbl
                Colrcp3.Item[5] = Rcli!rem_ligbl
                Colrcp3.Item[6] = Rcli!netht_ligbl
                If Colrcp3.Item[6] Then Totalfac.Text = Format$(Val(Totalfac.Text) + (Val(Rcli!netht_ligbl) * Val(Rcli!qte_ligbl)), "0.00")
              Else
                If Rcli!typel_ligbl = "C"
                  For Each sline In Split(Rcli!com_ligbl, "\n")
                    Colrcp3.Add(Rcli!numlig_ligbl & Lg, Rcli!numlig_ligbl & Lg)
                    Colrcp3.Item[0] = Rcli!numlig_ligbl
                    Colrcp3.Item[2] = sline
                    Inc lg
                  Next
                Endif
              Endif
            Loop Until Rcli.MoveNext()
            Nlgf.Text = Colrcp3.count
          Endif
        Endif
      Endif
    Endif
  End With
Catch

End

Public Sub Button2_Click()

  Panel3.Visible = False
  Colrcp3.Clear

End

'******************************************* Gestion des clients *************************************************
'**********************************************************
'*      Le bouton sert a rechercher les clients           *
'**********************************************************
Public Sub ToggleButton3_click()

  Tri = "cli_nom"
  sens = "Asc"
  If Colcli.visible = False Then
    Colcli.visible = True
    HBox4.visible = True
    comptetiers(tri, sens)
    N1.SetFocus
  Else
    Colcli.visible = False
    HBox4.visible = False
  Endif

End

Public Sub Tris()

  With colcli
    .Columns.count = 7
    .Columns[0].Width = C1.Width
    .Columns[1].Width = N1.Width
    .Columns[2].Width = 80
    .Columns[3].Width = 187
    .Columns[4].Width = 187
    .Columns[5].Width = Cp1.Width
    .Columns[6].Width = V1.Width
    .Columns[0].Text = "Code"
    .Columns[1].Text = "Nom"
    P1.Text = "  Prénom                   Adresse1                               Adresse2"
    .Columns[5].Text = "Cp"
    .Columns[6].Text = "Ville"
  End With

End

'**********************************************************
'*       On recupere les données du compte saisi          *
'**********************************************************
Public Sub compteMan()

  Dim rResult As Result

  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", Code.Text)
  If Not rResult.available Then
    If Son Then
      Music.Play
    Endif
    Try Message.Warning("Attention ! Veuillez saisir un compte existant SVP.", "Ok")
  Endif

End

'**********************************************************
'*               recherche des clients                    *
'**********************************************************
Public Sub Colcli_Data(Row As Integer, Column As Integer)

  Dim Frmt As New String[]
  Dim Frmt2 As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Fnets"])
  Frmt2 = Utils.FColr(Start.LocalSettings["/Coul/Znaff"])
  If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then
    CoulB = Val(Frmt[0])
    CoulF = Val(Frmt2[0])
  Else
    CoulB = &HF9F9BD&
    CoulF = &HEBD0C2&
  Endif
  With Utils
    CliTable[0] = "cli_code"
    CliTable[1] = "cli_nom"
    CliTable[2] = "cli_pnm"
    CliTable[3] = "cli_adr1"
    CliTable[4] = "cli_adr2"
    CliTable[5] = "cli_cd_ptl"
    CliTable[6] = "cli_ville"
    .rs2.MoveTo(Row)
    Try Colcli.data.Text = Str(.rs2[CliTable[Column]])
    If Not Error Then
      If (row Mod 2) = 0 Then
        Colcli.Data.Background = CoulB
      Else
        Colcli.Data.Background = CoulF
      Endif
    Endif
  End With

End
'************************************
'*   Affichage du gridview ColCli   *
'************************************

Public Sub compteTiers(tri As String, sens As String)

  Tris()
  Utils.Base2(colcli, "select * from " & Cbase.Table("TabCli") & " order by " & Tri & " " & sens & " ")
  Colcli.MoveTo(0, 0)
  Colcli.SetFocus

End

'******************************************
'*      Selection du  code client         *
'******************************************
Public Sub ColCli_Click()

  Dim Clitab As Result

  Try Clitab = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " where cli_code = &1", colcli[colcli.row, 0].Text)
  If Not Error Then
    Code.Text = Clitab!cli_code
    Int.text = Clitab!cli_nom
  Endif
  code.SetFocus
  Colcli.Visible = False
  Hbox4.visible = False

End

'***********************************************************
'* Gestion du gridview ColCli lors d'une saisie manuelle *
'***********************************************************
Public Sub ColCli_KeyPress()

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    ColCli_Click()
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    If Colcli.Visible = True Then
      ColCli.visible = False
      HBox4.Visible = False
      ColCli.clear
      Code.SetFocus
      Code.Select
      Stop Event
    Endif
  Endif

End

Public Sub Deb3()

  Utils.Base2(colcli, "select * from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & "")

End

Public Sub Deb4()

  Utils.Base2(colcli, "select * from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & " desc ")

End

Public Sub Dbclk()

  If Not Dbl Then
    Deb4()
    Dbl = "1"
  Else
    Deb3()
    Dbl = ""
  Endif

End

Public Sub C1_Click()

  sel = ""
  Dbl = ""
  C1.Text = ""
  N1.Text = "Nom"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "cli_code"
  Deb3()

End

Public Sub C1_Dblclick()

  Dbclk()

End

Public Sub N1_Click()

  sel = ""
  Dbl = ""
  C1.Text = "Code"
  N1.Text = ""
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "cli_nom"
  Deb3()

End

Public Sub N1_Dblclick()

  Dbclk()

End

Public Sub Cp1_Click()

  sel = ""
  Dbl = ""
  cp1.Text = ""
  C1.Text = "Code"
  N1.Text = "Nom"
  V1.Text = "Ville"
  Tri = "cli_cd_ptl"
  Deb3()

End

Public Sub Cp1_Dblclick()

  Dbclk()

End

Public Sub V1_Click()

  sel = ""
  Dbl = ""
  cp1.Text = "CP"
  C1.Text = "Code"
  N1.Text = "Nom"
  V1.Text = ""
  Tri = "cli_ville"
  Deb3()

End

Public Sub V1_Dblclick()

  Dbclk()

End

Public Sub C1_KeyPress()

  Chkinput()

End

Public Sub N1_KeyPress()

  ChkInput()

End

Public Sub A1_KeyPress()

  ChkInput()

End

Public Sub Cp1_KeyPress()

  ChkInput()

End

Public Sub V1_KeyPress()

  ChkInput()

End

Public Sub C1_GotFocus()

  Try Utils.ObsGotf(C1)
  C1_Click()

End

Public Sub C1_LostFocus()

  Try Utils.ObsLstf(C1)

End

Public Sub N1_GotFocus()

  Try Utils.ObsGotf(N1)
  N1_Click()

End

Public Sub N1_LostFocus()

  Try Utils.ObsLstf(N1)

End

Public Sub cp1_GotFocus()

  Try Utils.ObsGotf(Cp1)
  cp1_Click()

End

Public Sub cp1_LostFocus()

  Try Utils.ObsLstf(Cp1)

End

Public Sub V1_GotFocus()

  Try Utils.ObsGotf(V1)
  V1_Click()

End

Public Sub V1_LostFocus()

  Try Utils.ObsLstf(V1)

End

Public Sub ChkInput()

  If InStr("\"&'", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    Deb3()
  Else
    Stop Event
  Endif

End

Public Sub Button3_Click()

  Me.Close

End

Public Sub Button7_Click()

  Doc.Open("RelMo")

End
