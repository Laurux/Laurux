' Gambas class file

Adr As String
Siret As String
Tel As String
Tvaintra As String
iQte As Integer = 0 ' Variable pour quantité
Fcinq As Boolean = False ' idem
Qt1 As Boolean = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/qt1"] 'Variable pour validation automatique du code barre
iComm As Integer = 0 ' Variable pour commentaire
iRem As Integer = 0 ' Variable pour remise
iRemq As Integer = 0 ' variable pour remise quantitatives
iremT As Integer = 0 ' variable pour remise sur total
ibarre As Integer = 0 ' Variable pour code barre
iModif As Integer = 0 ' Variable pour modification ligne
iNlg As Integer = 0 ' Variable pour numéro de ligne à modifier
iAvoir As Integer = 0 ' initialise l'avoir
sAvoir As String ' Texte de l'avoir en haut de ticket'
snavoir As String ' variable pour nom de l'avoir
Numavoir As String ' variable pour numéro du ticket de l'avoir
iAttente As Integer = 0 'Si mise en attente du ticket
iRattente As Integer = 0 'Si ticket en cours est un ticket qui était en attente
ipaiement As Integer = 0 ' pour savoir si le paiement a été appelé
icarte As Integer = 0
snmcarte As String
icheque As Integer = 0
snmcheque As String
bcheque As Boolean = False ' variable pour imprimer les chéques
icredit As Integer = 0
snmcredit As String
iachat As Integer = 0
snmachat As String
ichequecad As Integer = 0
snmchequecad As String
snmreduc As String
icartef As Integer = 0 'si on traite une carte de fidélité
scartef As String
snmcartef As String
ftpoint As Float = 0 'total des points du clients
ftpoint2 As Float = 0
Ftpointg As Float = 0 'total des points gagnés par le client (éventuellement sans les remises et les promos)
fbonusv As Float = 0 'Valeur générant un bonus
fbonus As Float = 0 'Valeur du bonus
fbonusg As Float = 0 'total des boni gagnés
frem As Boolean = False ' flag pour savoir si on s'occupe des remises pour les cartes de fidélité
fpromo As Boolean = False ' flag pour savoir si on s'occupe des promotions pour les cartes de fidélité
Chkart As Boolean = True 'si on doit regarder le code produit
Ntk As String ' Numéro de ticket
Numtk As String ' Numéro du ticket rappelé
Ncaisse As String 'Numéro de caisse
FndCaisse As Float
hForm As FCalc
hForm2 As Fondcaisse
sDec As String
Tva As String
TxTva As String
mtva As String
Artpu As String
pvht As String
paht As String
Totalht As String = "0"
Tottva As String = "0"
totaltva As Float = 0
Nbdec As String
Nbd As String
sel As String
Tri As String
Rms As New String[] ' Tableau des remises quantitatives
artrmq As String ' remise quantitative
Clicaisse As String ' nom client caisse
CodeclientDefault As String ' code client caisse par défault
Clicompte As Integer 'si 1 bon de caisse pour client en compte, si 0 client caisse
Public Clicode As String ' code client compte ou caisse exported
Coulfc As Integer
Datetk As LDate
Datetk2 As LDate
Client As String
Client2 As String
Caissiere As String
$Caissiere As String
Pointille As String
Imprimante As String
Famille As String
'Mvt As String ' flag encaissement HV
'TypEnc As String ' type encaissement hors vente
Dtck As String 'dernier ticket enregistré (sert par impression de facture)
Entetet As String ' entete société pour facture
Entetcli As String ' entete client compte pour facture
admin As Integer = 0
rResult As Result
mdpadmin As String
org As String
Static Private $iSpc As New String[20]
Static Private $iSpc2 As New String[20]
GestMdp As Integer = 0
Public Bsel As Boolean = False
Private Clinom As String
Private Clipnm As String
Private Clicp As String
Private Cliburdist As String
Private $Cli As String ' variable pour nom des clients divers en recherche tickets
Private $Nomd As String ' nom client divers
sDon As Integer = 1 'flag pour savoir s'il y a des données a imprimer sur bande z. 0 pas de donnée, 1 on imprime.
Tkz As Integer = 0
Ecole As Boolean
Typeimp As String
Texte_Vis As String
Txtvis As String 'Texte de bienvenue
Promo As Boolean = False
Cpromo As String ' code promo en cours
Apromo As Boolean 'flag pour savoir si le produit est en promo
Bloc As String = ""
totgain As Float = 0 'Bonus
Boni As Float = 0 'Bonus utilisé
BonusArt As Float = 0 'remise du produit pour calcul des points gagnés
Ctrlstk As Boolean
tx As Float
devises As String
Crt As Boolean = False
Public origine As String = "Caisse"
Private sIacompte As String 'Libellé de l'acompte
Private slinda As String 'numéro d'index de l'acompte
Private numr As Integer ' Numero ecriture provisoire
Private numr2 As Integer ' numero ecriture définitif
Private numecr As String
Private jour As String
Private Photo As String
Private Colvente As Float ' variable pour Colisage de vente
Private Pvht2 As Float ' Variable pour le prix de vente du colisage
Private sBalance As Boolean ' gestion de la balance électronique
Private pdf As Cfacture
Private Nbf As Integer
Private bt As Integer = 0
Private iligne As Integer = 0
Public Codearticle As String
Public $Vendeur As Boolean = False
Public Ba4 As Boolean
Private slind As String 'Index des clients divers pour facturettes
Private Zone As String
Private $saisie As String
Private TouchFam As Boolean = False
Private btn As ImageButton
Private codeA As New String[72]
Private ToucheS As New String[110]
Private hpan As Panel
Private hbutton As ImageButton
Private Pan As Boolean = False
Private mtrem As String = "0"
Private nbc As Integer = 1
Private Prix As String
Private bFam As Boolean = False
Private mavoir As String
Private rremT As String = "0"
Private iart As Integer = 0
Private Touche_P As String
Private BA6X As Socket
Private bAffUSB As Boolean
Private $depot As String
Private bretro As Boolean = False
Private bmodifregl As Boolean = False
Private Val_retro As String ' variable pour coeff retrocession
Private Blexists As Boolean = False
Private RecapSoldeCli As Boolean = False
Private $keyObserver As Observer

' Méthode de connexion au module BA6X
Public Sub InitBA6X(uneAdresseIP As String, unPort As Integer)
  'Tentative de connexion pour afficheur BA63

  BA6X = New Socket
  BA6X.Connect(uneAdresseIP, unPort)
  'Dans l'attente de connexion (échec ou réussite)
  Do While (BA6X.Status <> 7) And (BA6X.Status > 0)
    Wait 0.1
  Loop
  If BA6X.Status <> 7 Then
    Try message.Error("Impossible de joindre l'afficheur USB, vérifiez votre installation !")
    bAffUSB = False
  Endif

End

Public Sub PrintBA6X(uneLigneHaut As String, uneLigneBas As String)

  Dim sBuf As String

  sBuf = "print|" & uneLigneHaut & "|" & uneLigneBas
  'Si le socket est operationnel
  If BA6X.Status > 0 Then
    Write #BA6X, sBuf, Len(sBuf)
  End If

End

Public Sub Form_Open()

  Dim Frmt As String[]
  Dim tab As String
  
  Utils.Observers(Me)
  $keyObserver = New Observer(Me) As "KeyObserver"
  Music.Load(Start.Musique)
  SetObservers(Me, Me)
  Balloon.Delay = 1500
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/recapsoldecli"] Then
    RecapSoldeCli = True
  Endif
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/tactile"] Then
    Button38.Visible = True
    Button39.Visible = True
  Else
    Button38.Visible = False
    Button39.Visible = False
    Me.Height = Me.height - (Me.Height / 3.47)
  Endif
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabPromo") & " where datedeb <= &1 and datefin >= &1", Format$(Now, "yyyy-mm-dd"))
  If rResult.Available Then
    Promo = True
    Cpromo = rResult!code
  Endif
  Try nbf = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/nbf"]
  If IsNull(nbf) Then nbf = 1
  Try Txtvis = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Txt_viseur"]
  If IsNull(Txtvis) Then Txtvis = "Bienvenue"
  Try bAffUSB = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/affusbwn"]
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCliCaisse") & "")
  Clicaisse = rResult!nom
  clicode = rResult!code
  CodeclientDefault = rResult!code
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Focus"])
  Coulfc = Val(Frmt[0])
  Init_LigTk()
  Init_Columnview1()
  ColTka.Columns.count = 5
  ColTka.Columns[0].Width = 20
  ColTka.Columns[0].Text = " Caisse"
  ColTka.Columns[1].Width = 80
  ColTka.Columns[1].Text = " Numéro"
  ColTka.Columns[2].Width = 130
  ColTka.Columns[2].Text = " Date"
  ColTka.Columns[3].Width = 60
  ColTka.Columns[3].Text = " Montant"
  ColTka.Columns[4].Width = 60
  ColTka.Columns[4].Text = " Client"
  ColumnView1.Columns[2].Alignment = 2
  'If Imprimante = "DéfautA4" Then
  'pointille = String$(38, "-")
  'Else
  Pointille = String$(34, "-")
  'Endif
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabSoc") & " where cd_sc = &1", Start.Societe)
  If IsNull(rResult!type_sc) Then
    Adr = rResult!int_sc & "\n" & rResult!adr1_sc & "\n" & rResult!adr2_sc & "\n" & rResult!cp_sc & " " & rResult!burdis_sc
  Else
    Adr = rResult!type_sc & " " & rResult!int_sc & "\n" & rResult!adr1_sc & "\n" & rResult!adr2_sc & "\n" & rResult!cp_sc & " " & rResult!burdis_sc
  Endif
  If IsNull(Start.LocalSettings["/Soc" & Start.Societe & "/Siret"]) Then
    siret = "Siret : " & rResult!siret_sc
  Else
    Siret = Start.LocalSettings["/Soc" & Start.Societe & "/Siret"] & " : " & rResult!siret_sc
  Endif
  Tel = "Tel : " & rResult!tel_sc
  Tvaintra = "Tva intra : " & rResult!tvaintra_sc
  Datetk = LDate(Now)
  Client = "Client : " & Clicaisse & "\n"
  Ncaisse = Split(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Ncai"], ";")[0]
  Caissiere = Split(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Ncai"], ";")[1]
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabVendeurs") & " where code = &1", Caissiere)
  Caissiere = rResult!nom
  $Caissiere = rResult!nom & "\n"
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCaisses") & " where code = &1 ", Ncaisse)
  Imprimante = rResult!imp
  Typeimp = rResult!typeimp
  $depot = rResult!depot
  Ent_tk(Null)
  TotalTk.Text = "0,00"
  If Left$(Imprimante, 4) = "/dev" Then
    Init_sport()
    Aff_viseur(Txtvis)
  Endif
  Try sBalance = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/balance"]
  If sBalance = True Then Init_sport2()
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximp"] Then Button37.visible = True
  
  'Entete_Tck("0")
  Qte.Text = "1"
  rticket.text = "0"
  Tab = "Fiches_LibelAvoirs"
  rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If rResult.Available Then sAvoir = rResult!libelav
  Tbremq_Create()
  Try Ctrlstk = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ctrlstk"]
  If Error Then Ctrlstk = False
  If IsNull(Ctrlstk) Then Ctrlstk = False
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
  If rResult.Available Then
    Val_retro = rResult!coretro
    devises = rResult!devise
    If IsNull(devises) Then devises = "Euros"
  Endif

  createPanel()
  Cbutton(Panel17)
  InitTouche()
  'ClavFam()
  
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/touchfam"] Then TouchFam = True
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tfamilles"] Then
    Panel17.Visible = True
    Pan = False
  Else
    Pan = True
  Endif
  
  Cart.SetFocus
  Zone = "Article"

Catch
  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub SetObservers(hClass As Object, hCont As Container)

  Dim hCtrl As Object
  Dim hOBS As Observer

  For Each hCtrl In hCont.Children
    If hCtrl Is Button Then
      hOBS = New Observer(hCtrl) As "Obs"
    Endif
    If hCtrl Is ImageButton Then
      hOBS = New Observer(hCtrl) As "Obs2"
    Endif
    If hCtrl Is Container Then SetObservers(hClass, hCtrl)
  Next

End

Public Sub Obs_Enter()

  Last.Font = Font["" ",Bold," ""]
  'Last.background = Color.Lighter(Color.Buttonbackground)

End

Public Sub Obs_Leave()

  Last.Font = Font["" "," "," ""]
  'Last.background = Color.Buttonbackground

End

Public Sub Obs2_Enter()

  Last.Font = Font["" ",Bold," ""]

End

Public Sub Obs2_Leave()

  Last.Font = Font["" "," "," ""]

End

Public Sub InitTouche()

  Dim rTch As Result

  rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " where cai = &1 order by touche", Ncaisse)
  If rTch.Available Then
    Repeat
      Try Me.Controls[rTch!touche].Name = rTch!touche
      If Not Error Then
        Btn = Me.Controls[rTch!touche]
        btn.Text = rTch!libelle
        codeA[Btn.Tag] = rTch!code
        Try ToucheS[btn.tag] = Utils.convBool(rTch!touche_s)
        Try Btn.Background = rTch!coul
        Try btn.Picture = Picture[rTch!fond]
      Endif
    Until rTch.MoveNext()
  Endif

End

Public Sub Timer1_Timer()

  Dim heuretk As String

  Datetk = LDate(Now)
  heuretk = Datetk.LT
  Entete.Text = Left$(Entete.text, Len(Entete.text) - Len(heuretk)) & heuretk

End

Public Sub Form_Close()

  If LigTk.count > 0 Then
    message.Warning("Vous avez un ticket en cours. Vous ne pouvez pas quitter !")
    Stop Event
    Cart.SetFocus
    Zone = "Article"
  Else
    Try sport.Close
    Try sport2.Close
    If Exist(User.home & "/Ticket.ps") Then Kill User.home & "/Ticket.ps"
    'Fermeture du socket pour communication avec afficheur BA6X
    If bAffUSB Then Close #BA6X
    Me.CLOSE
  Endif

End

Public Sub Ent_tk(numtk As String)

  Dim numero_tk As String
  Dim rResult2 As Result

  Entete.text = Adr & "\n" & Siret & " \n" & Tvaintra & "\n" & Tel & "\n"
  Entete.Text &= "Caissier(e) : " & $Caissiere
  If Imprimante = "DéfautA4" Then
    Entete.text = Entete.text & "Bonjour" & "\n"
  Else
    If Imprimante = "Défaut80" Then
      Entete.text = Entete.text & "Bonjour" & "\n"
    Else
      Entete.text = Entete.text & "Bonjour "
    Endif
  Endif
  If Imprimante = "DéfautA4" Then
    Entete.Text = Entete.Text & Pointille & Pointille & Left$(Pointille, 26) & "\n"
  Else
    If Imprimante = "Défaut80" Then
      Entete.Text = Entete.Text & Pointille & Pointille & Left$(Pointille, 10) & "\n"
    Else
      If Typeimp = "6000III" Then Entete.Text = Entete.Text & Pointille & "\n"
      If Typeimp = "Tmu950" Then Entete.Text = Entete.Text & Left$(Pointille, 26) & "\n"
    Endif
  Endif
  
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCaisses") & " where code = &1", Ncaisse)
  Ecole = rResult!ecole
  
  If numtk == Null
    If rResult!cutk <> Null Then
      'On prend le dernier ticket attribué pour cette caisse si celui ci n'avait pas été validé
      numero_tk = rResult!cutk
    Else
      'Sinon on attribut un nouveau numero de ticket et on l'affecte a cette caisse
      rResult2 = Utils.db.LockIncrement("cutk", Cbase.Table("TabParam"), "0000000")
      Utils.db.Exec("Update " & Cbase.Table("TabCaisses") & " set cutk = &1 where code = &2", rResult2!cutk, Ncaisse)
      numero_tk = rResult2!cutk
    Endif
  Else
    'Il s'agit d'un rappel de ticket en attente
    numero_tk = numtk
  Endif
  
  Ntk = numero_tk

  If Imprimante = "DéfautA4" Or If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximp2"] Then
    Entete.Text = Entete.Text & "Ticket No " & numero_tk & Space$(40) & datetk.LT '& "\n"
  Else
    If Imprimante = "Défaut80" Then
      Entete.Text = Entete.Text & "Ticket No " & numero_tk & Space$(10) & datetk.LT '& "\n"
    Else
      Entete.Text = Entete.Text & "Ticket No " & numero_tk & Space$(3) & datetk.LT & "\n"
    Endif
  Endif
Catch

  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Sub arrondi(arr As String, Arttc As String) As String

  Try Arttc = Format$(Val(Utils.CPoint(Arttc)), "0.00")
  If Not Arttc Then Arttc = "0,00"
  If arr = "0,05" Then
    If Right$(Arttc) Like "[34567]*" Then
      Arttc = Left$(Arttc, (Len(Arttc) - 1)) & "5"
    Else
      Arttc = Round(Val(Arttc), -1)
    Endif
  Endif

  If arr = "0,10" Then
    Arttc = Round(Val(Arttc), -1)
  Endif

  If arr = "0,50" Then
    If Abs(Val(Arttc)) <= Abs(Val(Left$(Arttc, (Len(Arttc) - 2)) & 25)) Then
      Arttc = Left$(Arttc, (Len(Arttc) - 2)) & "00"
    Else
      If Abs(Val(Arttc)) <= Abs(Val(Left$(Arttc, (Len(Arttc) - 2)) & 75)) Then
        Arttc = Left$(Arttc, (Len(Arttc) - 2)) & "50"
      Endif
      If Abs(Val(Arttc)) >= Abs(Val(Left$(Arttc, (Len(Arttc) - 2)) & 76)) Then
        Arttc = Round(Val(Arttc))
      Endif
    Endif
  Endif

  If arr = "1,00" Then
    Arttc = Round(Val(Arttc))
  Endif

  Return Format$(Val(Utils.CPoint(Arttc)), "0.00")

End

'**************************************
'* On Selectionne l'article saisi     *
'**************************************
Public Sub Art_man()

  Dim Sk As String
  Dim Rarts As Result
  Dim Artrm As String
  Dim Artht As String
  Dim sRem As String
  Dim pmp As String
  Dim Materiel, bstocke As Boolean ' si le produit est un materiel
  Dim arr As String
  Dim ecotaxe As String
  Dim Valeur_Ecotaxe As String
  Dim Taxepv As String
  Dim Valeur_Copp As String

  With utils
    bt = 0
    Inc iligne
    Inc iNlg
    Bloc = iligne
    Apromo = False
    If Left$(Cart.Text) = "*" Then
      Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
      Cart.Text = "*" & Utils.Find_Cbarre(Cart.Text)
    Endif
    Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
    If Rarts.Available Then
      sk = .cpoint(Rarts!art_qte)
      If IsNull(sk) Then sk = "0"
      bstocke = Rarts!art_stocke
      If bstocke And Ctrlstk And Val(sk) <= 0 Then
        If Start.son Then
          Music.Play
        Endif
        Try Message.Warning("Saisie impossible! Le stock de ce produit est égal ou inférieur à zéro.")
        bt = 1
      Else
        If IsNull(Remise.text) Then Remise.text = "0,00"
        Materiel = Rarts!art_mat
        Famille = Rarts!art_fam
        Nbd = Rarts!art_nbd
        Nbdec = .Find_Nbdec(Nbd)
        Pvht = Format$(Rarts!art_pvht, Nbdec)
        Try Colvente = Rarts!art_colvte
        If Error Then colvente = 0
        Try Pvht2 = Rarts!art_pvht2
        If Error Then pvht2 = 0
        arr = Rarts!art_cdarr
        Tva = Rarts!art_tva
        Txtva = Rarts!art_tva
        If bretro Then
          pvht = Format$(Rarts!art_prvt * Val(Val_retro), Nbdec)
          Calc_TTC()
        Endif
        If Colvente <> 0 And Val(qte.Text) >= Colvente Then
          Pvht = Format$(Val(Utils.CPoint(Pvht2)), Nbdec)
          Calc_TTC()
        Endif
        Pmp = Rarts!art_pmp
        Try BonusArt = Rarts!art_bonus
        If Error Then BonusArt = 0
        If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
        If apromo = True Then
          Pvht = Format$(ArtPromo.Prix_Promo(Cart.text, Cpromo), Nbdec)
          Pvht = Format(Val(Pvht), Nbdec)
          Pvttc.Text = Format$(ArtPromo.Prix_Promottc(Cart.text, Cpromo), Nbdec)
          Pvttc.Text = Format$(Val(Pvttc.Text), "0.00")
          Artpu = Pvttc.Text
        Endif
        Calc_Tva()
        Ecotaxe = Rarts!art_ect
        If Rarts!art_eco Then
          Valeur_Ecotaxe = Rarts!art_eco
          Valeur_Ecotaxe = Val(.CPoint(Valeur_Ecotaxe)) + (Val(.CPoint(Valeur_Ecotaxe)) * tva / 100)
          Valeur_Ecotaxe = Format$(Val(.cpoint(Valeur_Ecotaxe)), "0.00")
        Endif
        Taxepv = Rarts!art_cpp
        If Rarts!art_copp Then
          Valeur_Copp = Rarts!art_copp
          Valeur_Copp = Val(.CPoint(Valeur_Copp)) + (Val(.CPoint(Valeur_Copp)) * tva / 100)
          Valeur_Copp = Format$(Val(.cpoint(Valeur_Copp)), "0.00")
        Endif
        Try Rms[0, 0] = Str(Rarts["qte1"])
        Try Rms[0, 1] = Str(Rarts["qte2"])
        Try Rms[0, 2] = Str(Rarts["rem1"])
        Try Rms[1, 0] = Str(Rarts["qte3"])
        Try Rms[1, 1] = Str(Rarts["qte4"])
        Try Rms[1, 2] = Str(Rarts["rem2"])
        Try Rms[2, 0] = Str(Rarts["qte5"])
        Try Rms[2, 1] = Str(Rarts["qte6"])
        Try Rms[2, 2] = Str(Rarts["rem3"])
        Try Rms[3, 0] = Str(Rarts["qte7"])
        Try Rms[3, 1] = Str(Rarts["qte8"])
        Try Rms[3, 2] = Str(Rarts["rem4"])
        Try Rms[4, 0] = Str(Rarts["qte9"])
        Try Rms[4, 1] = Str(Rarts["qte10"])
        Try Rms[4, 2] = Str(Rarts["rem5"])
        Try Rms[5, 0] = Str(Rarts["qte11"])
        Try Rms[5, 1] = Str(Rarts["qte12"])
        Try Rms[5, 2] = Str(Rarts["rem6"])
        If Apromo = False Then
          If iRemq = 0 Then Remises_quantitatives()
        Endif
        If iRemq = 1 Then Artpu = Format$(Val(.CPoint(Artpu)) - (Val(.CPoint(Artpu)) * Val(.CPoint(Artrmq)) / 100), "0.00")
        If apromo = True Then
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = "*** Produit en promotion ***"
          LigTk.Item[8] = bloc
          Inc iNlg
        Endif
        LigTk.Add(iligne, iligne)
        LigTk.Item[0] = iNlg
        LigTk.Item[1] = Cart.Text
        LigTk.Item[12] = Rarts!art_tva
        If iModif = 0 Then
          LigTk.Item[2] = Left$(Rarts!art_design, 32)
        Else
          LigTk.Item[2] = Left$(Design.Text, 32)
        Endif

        If Len(Design.Text) >= 13 Then
          Texte_Vis = Mid$(.Replace(LigTk.Item[2]), 1, 10)
        Else
          Texte_Vis = .Replace(LigTk.Item[2])
        Endif

        If iModif = 1 Then
          'Si modif du prix on conserve la gestion d'arrondi
          'BL incohérent en gestion compte
          Artpu = arrondi(arr, Pvttc.Text)
        Endif
        If Val(Qte.text) < 0 Then
          Artpu = "-" & Artpu
          LigTk.Item[3] = Artpu
        Else
          LigTk.Item[3] = Artpu
        Endif
        Decimal()
        LigTk.Item[4] = Qte.text
        Texte_vis = Texte_vis & Space$(16 - Len(Texte_vis))
        'Texte_vis = Left$(texte_vis, 14)
        LigTk.Item[5] = "A"
        If Colvente <> 0 And Val(qte.Text) >= Colvente Then
        Else
          calc_HT()
        Endif
        If iqte = 1 Or If Val(.cpoint(artpu)) < 0 Then
          pvht = Format$(Val(.cpoint(pvht)) * Val(.cpoint(qte.Text)), nbdec)
          If Val(.cpoint(artpu)) < 0 Then pvht = "-" & pvht
          Artht = pvht
          Try Valeur_Ecotaxe = Format$(Val(.cpoint(Valeur_Ecotaxe)) * Val(.cpoint(qte.Text)), "0.00")
          Try Valeur_Copp = Format$(Val(.cpoint(Valeur_Copp)) * Val(.cpoint(qte.Text)), "0.00")
          Mtva = Val(.cpoint(Mtva)) * Val(.cpoint(qte.Text))
          If Val(.cpoint(artpu)) < 0 Then Mtva = "-" & Mtva
        Endif
        LigTk.Item[6] = Pvht
        LigTk.Item[8] = bloc
        LigTk.Item[9] = Mtva
        LigTk.Item[10] = tva
        LigTk.Item[11] = Artpu
        If Val(.CPoint(Remise.text)) <> 0 Then
          pvht = Format$(Val(.CPoint(pvht)) - (Val(.CPoint(pvht)) * Val(.CPoint(Remise.text)) / 100), "0.00")
          Artrm = Val(.CPoint(LigTk.Item[6])) - Val(.CPoint(pvht))
        Endif
        If Ecotaxe <> 0 And Not IsNull(Ecotaxe) Then
          Inc iligne
          Inc iNlg
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = ""
          LigTk.Item[2] = " Dont Eco-taxe "
          If Val(Qte.text) < 0 Then
            LigTk.Item[3] = "-" & Valeur_Ecotaxe
          Else
            LigTk.Item[3] = Valeur_Ecotaxe
          Endif
          LigTk.Item[11] = LigTk.Item[3]
          LigTk.Item[5] = "O"
          LigTk.Item[8] = bloc
        Endif
        If Taxepv <> 0 And Not IsNull(Taxepv) Then
          Inc iligne
          Inc iNlg
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = ""
          LigTk.Item[2] = " Dont Taxe copie privée "
          If Val(Qte.text) < 0 Then
            LigTk.Item[3] = "-" & Valeur_Copp
          Else
            LigTk.Item[3] = Valeur_Copp
          Endif
          LigTk.Item[11] = LigTk.Item[3]
          LigTk.Item[5] = "O"
          LigTk.Item[6] = Pvht
          LigTk.Item[8] = bloc
        Endif
        If Val(.CPoint(Remise.text)) <> 0 Then
          Inc iligne
          Inc iNlg
          sRem = Format$(Val(.CPoint(Artpu)) - (Val(.CPoint(Artpu)) * Val(.CPoint(Remise.text)) / 100), "0.00")
          artpu = sRem
          Mtva = Format$((Val(.CPoint(artpu)) * Val(.cpoint(Qte.text))) - Val(.CPoint(pvht)), "0.00")
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = Cart.Text
          LigTk.Item[2] = Format$(Val(.cpoint(Remise.Text)), "0.00") & " % de Remise "
          LigTk.Item[3] = sRem
          LigTk.Item[4] = Qte.text
          LigTk.Item[5] = "S"
          LigTk.Item[6] = Pvht
          LigTk.Item[7] = artrm
          LigTk.Item[8] = bloc
          LigTk.Item[9] = Mtva
          LigTk.Item[10] = tva
          LigTk.Item[11] = sRem
          LigTk.Item[12] = Rarts!art_tva

        Endif
        If iQte = 1 Then
          Inc iligne
          Inc iNlg
          If Val(.CPoint(Remise.text)) <> 0 Then
            Artpu = Val(.cpoint(sRem)) * Val(.cpoint(Qte.text))

          Else
            Artpu = Val(.cpoint(Artpu)) * Val(.cpoint(Qte.text))
          Endif
          Artpu = Format$(Artpu, Nbdec)
          If Val(Qte.text) < 0 Then Artpu = "-" & Artpu
          If Val(Qte.text) < 0 Then
            If Val(.CPoint(pvht)) > 0 Then pvht = "-" & pvht
          Endif
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = ""
          LigTk.Item[2] = Space$(3) & "\tPrix total"
          LigTk.Item[3] = Artpu
          LigTk.Item[5] = "T"
          LigTk.Item[6] = Pvht
          LigTk.Item[7] = artrm
          LigTk.Item[8] = bloc
          LigTk.Item[9] = Mtva
          LigTk.Item[10] = tva
          LigTk.Item[11] = Artpu
          LigTk.Item[12] = Rarts!art_tva
          iQte = 0
        Else
          If iRem = 1 Then
            Artpu = sRem
            LigTk.Item[11] = Artpu
          Endif
        Endif
        Ligtk.MoveLast()
        'LigTk.item.Selected = True
        Ligtk.item.EnsureVisible
        Texte_Vis = Texte_vis & Pvttc.Text
        TotalTk.Text = Format$(Val(.cpoint(TotalTk.Text)) + Val(.cpoint(Artpu)), Nbdec)
        Remise.Text = "0,00"
        iRem = 0
        iremq = 0
        ibarre = 0
        iqte = 0
        TextLabel7.Visible = False
        Remise.Visible = False
        Cart.SetFocus
        Zone = "Article"
        Aff_viseur(Texte_vis, "Qte: x" & Qte.text & " = " & Str$(Artpu))
        Raz()
        Cart.SetFocus
        Zone = "Article"
      Endif
    Else
      If Start.son Then
        Music.Play
      Endif
      Try message.Warning(" Cet article n'existe pas ! ")
      bt = 1
      Cart.SetFocus
      Cart.Select
      Zone = "Article"
    Endif
  End With
Catch
  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub calc_total()

  With utils
    Totalht = Val(.cpoint(Totalht)) + (Val(.cpoint(Pvht)) * Val(.cpoint(Qte.text)))
    Totalht = Format$(Totalht, "0.00")
  End With

End

Public Sub Ouv_Tiroir()

  If Left$(Imprimante, 4) = "/dev" Then
    Try Print #Sport, Chr$(&H1B) & "p" & Chr$(0);
    Try Print #Sport, Chr$(&H1D) & "a" & Chr$(1);
  Endif

End

Public Sub Aff_viseur(Texte_aff As String, Optional Texte_Sup As String = "")

  If Left$(Imprimante, 4) = "/dev" Then
    Try Print #Sport, Chr$(&H1B) & "=" & Chr$(2);
    Try Print #sport, Chr$(&H1B) & "@";
    Try Print #Sport, Texte_aff;
    Try Print #Sport, Chr$(&H1B) & "=" & Chr$(1);
  Endif

  'Imprime sur l'afficheur USB BA6X si disponible
  If bAffUSB = True Then
    PrintBA6X(Texte_aff, Texte_Sup)
  Endif

End

Public Sub Cart_MouseDown()

  Zone = "Article"
  'ClavFam()

End

Public Sub Design_MouseDown()

  Zone = "Design"

End

Public Sub Pvttc_MouseDown()

  Zone = "Pvttc"

End

Public Sub Qte_Mousedown()

  Zone = "Qte"

End

Public Sub Cart_GotFocus()

  $saisie = ""
  Zone = "Article"

End

Public Sub Design_GotFocus()

  $saisie = ""
  Zone = "Design"
  Design.select

End

Public Sub Cart_KeyPress()

  With utils
    If Key.code = Key.Esc Then
      'La fenetre de paiement est affiché
      If Frame2.visible Then
        If ipaiement = 0 Then
          Frame2.visible = False
          Cart.ReadOnly = False
          Qte.ReadOnly = False
        Else
          Inpm.SetFocus
          Inpm.Select
          Zone = "Inpm"
          Return
        Endif
      Else
        Photos_MouseDown()
      Endif
    Endif
    If Key.code = Key.F1 Then Doc.Open("Laurux.PosIndexParCategories")
    If Key.Alt Then
      If Key.code = 86 Then 'CTRL+X
        If Ligtk.Count = 0 Then
          Svendeur.showmodal()
          If $Vendeur Then
            Caissiere = Start.$Cai
            rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabVendeurs") & " where code = &1", Left$(Caissiere, 2))
            Caissiere = rResult!nom
            $Caissiere = rResult!nom & "\n"
            Ent_tk(Null)
          Endif
        Endif
      Endif
    Endif
    If key.Control Then
      'Modification du règlement
      If Key.code = 77 Then 'CTRL+M
        If Ligtk.Count = 0 Then
          bmodifregl = True
          Inc iligne
          Inc iNlg
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = "***  Ticket modif reglement  ***"
          LigTk.Item[5] = "C"
          LigTk.Item[8] = iligne
          Inc iNlg
          Init_Reg()
          Button6_Click()
        Else
          bmodifregl = False
          Message.Warning("La Modification d'un règlement se détermine en début de ticket !")
        Endif
      Endif
      'Appel client divers
      If Key.code = 78 Then 'CTRL+N
        iavoir = 0
        ClientsDivers()
      Endif
      'Ticket rétrocession
      If Key.code = 82 Then 'CTRL+R
        If Ligtk.Count = 0 Then
          bretro = True
          Inc iligne
          Inc iNlg
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = "***  Ticket retrocession  ***"
          LigTk.Item[5] = "C"
          LigTk.Item[8] = iligne
          Inc iNlg
        Else
          bretro = False
          Message.Warning("La rétrocession se détermine en début de ticket !")
        Endif
      Endif
      'Saisie d'un code vendeur
      If Key.code = 88 Then
        If Ligtk.Count = 0 Then
          Svendeur.showmodal()
          If $Vendeur Then
            Caissiere = Start.$Cai
            rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabVendeurs") & " where code = &1", Left$(Caissiere, 2))
            Caissiere = rResult!nom
            $Caissiere = rResult!nom & "\n"
            Ent_tk(Null)
          Endif
        Endif
      Endif

      If Key.code = 84 Then Ouv_Tiroir()
      If key.code = key.F2 Then Btn_Find_Click()
      If key.code = key.F3 Then Btn_EntreeEnc_Click()
      If key.code = key.F4 Then Button20_Click()
      If key.code = key.F6 Then Button21_Click()
      If key.code = key.F5 Then button24_Click()
      If key.code = key.F7 Then Button25_Click()
      If Key.code = key.F8 Then CartesFidelite()
      If Key.code = key.F9 Then
        Panel17.visible = False
        Button33_Click()
      Endif
      If key.code = key.F12 Then
        If Crt = True Then
          Message.Warning("Saisie d'un client en compte impossible sur une carte de fidélité !")
        Else
          Button30_Click()
        Endif
      Endif
      If key.code = Key.F11 Then
        mdp_admin()
        If GestMdp = 1 Then
          org = "CtrlF11"
          If Start.son Then
            Music.Play
          Endif
          Frame8.visible = True
          Mdp.SetFocus
          Zone = "Mdp"
        Else
          Ouv_Tiroir()
          Cart.SetFocus
          Zone = "Article"
        Endif
      Endif
    Else
      If Key.code = Key.F2 Then
        If IsNull(RemTot.text) Then
          sel = Cart.Text
          AppArt()
        Else
          Message.Warning("Saisie impossible une remise sur le total a été effectuée !")
          Cart.SetFocus
        Endif
      Else
        If Key.code = Key.F3 Then
          Button4_Click
        Else
          If Key.code = Key.F7 Then
            Button6_Click
          Else
            If Key.code = Key.F8 Then
              Button7_Click
            Else
              If Key.code = Key.F9 Then
                Button8_Click
              Else
                If Key.code = Key.F10 Then
                  Button9_Click
                Else
                  If Key.code = Key.F11 Then
                    Button10_Click
                  Else
                    If key.code = key.F12 Then
                      Button26_Click()
                    Else
                      If Key.code = Key.F4 Then Button1_Click()
                      If Key.code = Key.F5 Then
                        iQte = 1
                        Fcinq = True
                      Endif
                      If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
                        If iComm = 1 Then
                          Valid_commentaire()
                        Else
                          If IsNull(RemTot.text) Then
                            Stop Event
                            Valid_Cart()
                          Else
                            Message.Warning("Saisie impossible une remise sur le total a été effectuée !")
                            Cart.SetFocus
                          Endif
                        Endif
                        Chkart = True
                      Endif
                    Endif
                  Endif
                Endif
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  End With

End

Public Sub panel17_KeyPress()

  If Key.code = Key.Esc Then
    Panel17.visible = False
    Cart.SetFocus
  Endif

End

Public Sub aff_Photo()

  Dim hImage As Image

  Try hImage = Image.Load(Photo)
  If Not Error Then
    Draw.Begin(Photos)
    Draw.Image(hImage, 0, 0, Photos.Width, Photos.Height)
    Draw.End
  Endif
Catch
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Photos_MouseDown()

  Photos.clear
  Panel10.visible = False

End

Public Sub Prix_promo()

  If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
  If apromo = True Then Balloon.Info(("Ce produit est actuellement en promotion"), Cart)
  If apromo = True Then
    Pvht = Format$(ArtPromo.Prix_Promo(Cart.text, Cpromo), Nbdec)
    Pvht = Format(Val(Pvht), Nbdec)
    Pvttc.Text = Format$(ArtPromo.Prix_Promottc(Cart.text, Cpromo), Nbdec)
    Pvttc.Text = Format$(Val(Pvttc.Text), "0.00")
    Artpu = Pvttc.Text
  Endif

End

'*********************************
'*  Validation de la quantité    *
'*********************************
Public Sub Qte_GotFocus()

  $saisie = ""
  Qte.select
  Zone = "Qte"

End

Public Sub Qte_KeyPress()

  Panel10.Visible = False
  Photos.Clear
  Photo = ""
  If key.Control Then
    If Key.code = 84 Then Ouv_Tiroir()
  Endif
  If Not IsNull(Design.text) Then
    If Key.code = Key.F3 Then
      Button4_Click()
      Design.SetFocus
      Design.Select
    Else
      If Key.code = Key.F10 Then
        If sBalance = True Then
          Recup_Poids()
          Wait 0.05
          SPort2_Read()
          Valid_Qte()
        Endif
      Else
        If Key.code = Key.F6 Then
          Button3_Click()
        Else
          If Key.code = Key.F5 Then
            Qte.SetFocus
            Try Qte.Selected = True
            Zone = "Qte"
            Button2_Click()
          Else
            If Key.code = Key.F8 Then
              mdp_admin()
              If GestMdp = 1 Then
                org = "F8"
                If Start.son Then
                  Music.Play
                Endif
                Frame8.visible = True
                Mdp.SetFocus
                Zone = "Mdp"
              Else
                TextLabel7.Visible = True
                Remise.Visible = True
                RemqShow()
              Endif
            Else
              ChkPrx()
              If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
                Stop Event
                Valid_Qte()
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  Else
    Message.Warning("Veuillez saisir un code article SVP !")
    Cart.SetFocus
    Cart.Select
    Zone = "Article"
  Endif

End

Public Sub Valid_Qte()

  If IsNull(Val(utils.cpoint(qte.text))) Then
    Message.Warning("Vérifiez votre saisie SVP !")
    qte.SetFocus
    Qte.Select
    Zone = "Qte"
  Else
    If Val(utils.cpoint(qte.text)) <> 0 Then
      If iRem = 0 Then
        If Init_Art() <> True Then
          Message.Warning("La quantité saisie n'est pas autorisée pour cet article!")
          qte.SetFocus
          Qte.Select
          Zone = "Qte"
        Else
          If bt <> 1 Then calc_total()
        Endif
      Else
        Remise.SetFocus
        Zone = "Remise"
      Endif
      iQte = 0
    Else
      Message.Warning("La saisie d'une quantité égale à zéro n'est pas autorisée !")
      qte.SetFocus
      Qte.Select
      Zone = "Qte"
    Endif
  Endif

End

Public Sub Valid_commentaire()

  Inc iligne
  Inc iNlg
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[2] = Cart.Text
  LigTk.Item[5] = "C"
  LigTk.Item[8] = iligne
  TextLabel1.Text = "Article"
  Zone = "Article"
  Cart.Clear
  iComm = 0
  iRem = 0
  iQte = 0
  Qte.text = "1"
  Cart.SetFocus
  'ClavFam()

End

Public Sub Valid_HorsVte(Acompte As Boolean, Enc As Boolean, Libelle As String, Acptcli As String)

  Inc iligne
  Inc iNlg
  bloc = iligne
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  If Acompte = True
    LigTk.Item[2] = "Encaissement Acompte"
  Else If Enc = True Then
    LigTk.Item[2] = "Encaissement Hors Vente"
  Else
    LigTk.Item[2] = "Sortie Hors Vente"
  Endif
  LigTk.Item[5] = "C"
  LigTk.Item[8] = bloc
  Inc iNlg
  Inc iligne
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[1] = Acptcli
  LigTk.Item[2] = Libelle
  If Acompte = True
    LigTk.Item[5] = "EA"
  Else If Enc = True Then
    LigTk.Item[5] = "EH"
  Else
    LigTk.Item[5] = "SH"
    Especes2.Text = "-" & Especes2.Text 
  Endif
  LigTk.Item[3] = Especes2.Text
  LigTk.Item[4] = 1
  LigTk.Item[6] = Especes2.Text 'HT = TTC
  LigTk.Item[8] = bloc
  LigTk.Item[9] = 0
  LigTk.Item[10] = ""
  LigTk.Item[11] = Especes2.Text
  
  TotalTk.Text = Format$(Val(Utils.cpoint(TotalTk.Text)) + Val(LigTk.Item[3]), "0.00")
  Frame5.Visible = False
  Especes2.Clear
  Nmc3.Clear
  AcptClicpt.Clear
  
  TextLabel1.Text = "Article"
  Zone = "Article"
  Cart.Clear
  iComm = 0
  iRem = 0
  iQte = 0
  Qte.text = "1"
  Cart.SetFocus
  'ClavFam()

End


Public Sub Valid_Cart() As Boolean

  Dim Rarts As Result
  Dim cbarr As String
  Dim ret As Boolean

  If Left$(Cart.Text, 1) = "*" Then
    If Len(Cart.Text) = 14 And Mid$(Cart.Text, 2, 6) = "299999" Then
      Cart.Text = Mid$(Cart.Text, 8, 6)
      Crt = True
      Codearticle = Cart.Text
    Else
      If Len(Cart.text) <= 7 Then
        Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text) - 1)
        Cart.Text = Format$(Cart.text, "000000")
        Crt = True
      Else
        cbarr = Mid$(Cart.Text, 2, Len(Cart.Text) - 1)
        Cart.Text = Utils.Find_cbarre(cbarr)
        ibarre = 1
      Endif
    Endif
  Endif
  If Crt = True Then
    If Clicompte = 0 Then
      RecupCarte()
      ret = True
    Else
      Message.Warning("Saisie d'une carte impossible sur un client en compte !")
      Crt = False
      ret = False
    Endif
  Endif
  If Chkart = True Then
    Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
    If Not Rarts.Available Then
      Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_cequ = &1", Cart.Text)
    Endif
    If Not Rarts.Available Then
      Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_cfour = &1", Cart.Text)
    Endif
    If Rarts.Available And Len(Cart.Text) <> 0 Then
      Cart.Text = Rarts!art_code
      Nbd = Rarts!art_nbd
      Nbdec = Utils.Find_Nbdec(Nbd)
      Design.Text = Rarts!art_design
      Pvttc.Text = Format$(Rarts!art_pvttc, Nbdec)
      Artpu = Pvttc.Text
      'Une fois l'article trouvé on bloque les champs
      Design.ReadOnly = True
      Pvttc.ReadOnly = True
      Design.Background = &H00BFBFBF&
      Pvttc.Background = &H00BFBFBF&
      Pvht = Format$(Rarts!art_pvht, Nbdec)
      Paht = Format$(Rarts!art_paht, Nbdec)
      Tva = Rarts!art_tva
      Txtva = Rarts!art_tva
      If bretro Then
        If bretro Then pvht = Format$(Rarts!art_prvt * Val(Val_retro), Nbdec)
        Calc_TTC()
      Endif
      Tva = Rarts!art_tva
      If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
      If apromo = True Then Balloon.Info(("Ce produit est actuellement en promotion"), Cart)
      If apromo = True Then Prix_Promo()
      Try Rms[0, 0] = Str(Rarts["qte1"])
      Try Rms[0, 1] = Str(Rarts["qte2"])
      Try Rms[0, 2] = Str(Rarts["rem1"])
      Try Rms[1, 0] = Str(Rarts["qte3"])
      Try Rms[1, 1] = Str(Rarts["qte4"])
      Try Rms[1, 2] = Str(Rarts["rem2"])
      Try Rms[2, 0] = Str(Rarts["qte5"])
      Try Rms[2, 1] = Str(Rarts["qte6"])
      Try Rms[2, 2] = Str(Rarts["rem3"])
      Try Rms[3, 0] = Str(Rarts["qte7"])
      Try Rms[3, 1] = Str(Rarts["qte8"])
      Try Rms[3, 2] = Str(Rarts["rem4"])
      Try Rms[4, 0] = Str(Rarts["qte9"])
      Try Rms[4, 1] = Str(Rarts["qte10"])
      Try Rms[4, 2] = Str(Rarts["rem5"])
      Try Rms[5, 0] = Str(Rarts["qte11"])
      Try Rms[5, 1] = Str(Rarts["qte12"])
      Try Rms[5, 2] = Str(Rarts["rem6"])
      Photo = Rarts!art_photo
      If Not IsNull(Photo) Then
        Panel10.Visible = True
        Photos.Clear
        aff_Photo()
      Endif
      If ibarre = 1 Then
        If Qt1 = True Then
          iQte = 0
        Else
          iQte = 1
        Endif
        If Fcinq = True Then iQte = 1
        Fcinq = False
        If iQte = 0 Then
          'IF Panel10.Visible = TRUE THEN
          'WAIT 2
          'Panel10.Visible = FALSE
          'ENDIF
          Qte.text = "1"
          If iRem = 1 Then
            Remise.SetFocus
            Zone = "Remise"
          Else
            If Init_Art() = False Then
              Message.Warning("La quantité saisie n'est pas autorisée pour cet article!")
              qte.SetFocus
              Qte.Select
              Zone = "Qte"
            Else
              calc_total()
            Endif
          Endif
        Else
          Qte.SetFocus
          Qte.Select
          Zone = "Qte"
        Endif
      Else
        If Val(Pvttc.text) = 0 Then
          modif_Tk()
          Pvttc.SetFocus
          Pvttc.Select
          Zone = "Pvttc"
        Else
          Qte.SetFocus
          Qte.Select
          Zone = "Qte"
        Endif
      Endif
      ret = True
    Else
      If Start.son Then
        Music.Play
      Endif
      If ibarre = 1 Then
        Message.Warning("Le code barre (" & cbarr & ") n'existe pas !")
        ibarre = 0
      Else
        Message.Warning("Le produit (" & Cart.Text & ") n'existe pas !")
      Endif
      Cart.Text = ""
      iart = 1
      ret = False
    Endif
  Endif

  Chkart = True
  Crt = False
  
  Return ret

End

Public Sub Remise_GotFocus()

  $saisie = ""
  Remise.select

End

Public Sub Valid_Remise()

  bt = 0

  Remise.Text = Utils.cpoint(Remise.Text)
  If Val(Remise.Text) = Null Then
    If Start.son Then
      Music.Play
    Endif
    Try message.Warning("Veuillez verifier votre saisie SVP !")
    bt = 1
    Remise.SetFocus
    Remise.Select
  Else
    Remise.Text = Format$(Val(Utils.cpoint(Remise.Text)), "0.00")
  Endif
  If bt <> 1 Then
    If Val(Utils.cpoint(Remise.Text)) <> 0 Then
      Qte.SetFocus
      Qte.Select
      Zone = "Qte"
      irem = 0
      Stop Event
    Endif
  Endif
Catch
  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  Remise.SetFocus
  Remise.Select

End

'*********************************
'*  Validation de la remise    *
'*********************************
Public Sub Remise_KeyPress()

  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Remise()
    Qte.SetFocus
    Qte.Select
    Zone = "Qte"
    irem = 0
  Endif
  If Key.code = Key.F6 Or key.code = key.esc Then
    If Tbrem.visible = True Then
      Tbrem.Clear
      Tbrem.Visible = False
    Else
      TextLabel7.Visible = False
      Remise.Visible = False
      Qte.SetFocus
      Qte.Select
      Zone = "Qte"
      irem = 0
    Endif
  Endif
  If Key.code = Key.F8 Then RemqShow()

End

Public Sub RemqShow()

  If Tbrem.visible = True Then
    Tbrem.clear
    Tbrem.visible = False
  Else
    Tbrem.visible = True
    Tbrem.raise
    Tbrem.clear
    Tbrem.Refresh
    Try Tbrem[0, 0].Text = Rms[0, 0]
    Try Tbrem[0, 1].Text = Rms[0, 1]
    Try Tbrem[0, 2].Text = Rms[0, 2]
    Try Tbrem[1, 0].Text = Rms[1, 0]
    Try Tbrem[1, 1].Text = Rms[1, 1]
    Try Tbrem[1, 2].Text = Rms[1, 2]
    Try Tbrem[2, 0].Text = Rms[2, 0]
    Try Tbrem[2, 1].Text = Rms[2, 1]
    Try Tbrem[2, 2].Text = Rms[2, 2]
    Try Tbrem[3, 0].Text = Rms[3, 0]
    Try Tbrem[3, 1].Text = Rms[3, 1]
    Try Tbrem[3, 2].Text = Rms[3, 2]
    Try Tbrem[4, 0].Text = Rms[4, 0]
    Try Tbrem[4, 1].Text = Rms[4, 1]
    Try Tbrem[4, 2].Text = Rms[4, 2]
    Try Tbrem[5, 0].Text = Rms[5, 0]
    Try Tbrem[5, 1].Text = Rms[5, 1]
    Try Tbrem[5, 2].Text = Rms[5, 2]
  Endif

End

Public Sub Init_Art() As Boolean

  If Not IsNull(RemTot.Text) Then
    If Message.Warning("Il est impossible de rajouter un article une fois une remise totale saisie!\nVoulez-vous la supprimer?", "Oui", "Non") = 2 Then Return True
    iremT = 0
    RemTot.Clear
    Valid_Remtot("0")
  Endif
  
  Recup_dec()
  Decimal()
  
  If Val(Utils.cpoint(Qte.Text)) = 0 Then Return False
  
  If Left$(Cart.Text) = "*" Then
    Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    Cart.Text = Utils.Find_cbarre(Cart.Text)
  Endif
  If Abs(Val(Utils.cpoint(Qte.Text))) <> 1 Then iQte = 1
  Art_man()
  
  Return True

End

Public Sub Raz()

  Cart.clear
  Qte.Text = "1"
  Design.Clear
  Pvttc.Clear

End

Public Sub Button40_Click()

  AppArt()

End

Public Sub AppArt()

  If IsNull(RemTot.text) Then
    If Frame2.Visible = False Then
      SelectionArt()
    Endif
  Else
    Cart.SetFocus
  Endif

End

Public Sub Button2_Click()

  If Not IsNull(Cart.Text) And Not IsNull(Design.Text) Then
    iQte = 1
    hForm = New FCalc
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then
      Try Qte.Text = Format$(Val(Utils.cpoint(FCalc.Resultat)), "0.000")
      Recup_dec()
      Decimal()
    Endif
    If Error Then Qte.Text = "1"
  Else
    Message.Warning("Veuillez saisir un article SVP !")
  Endif

End

Public Sub Recup_dec()

  Dim Rdec As Result

  If Left$(Cart.Text, 1) = "*" Then
    Rdec = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Mid$(Cart.Text, 2, Len(Cart.Text)))
  Else
    Rdec = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
  Endif
  If Rdec.Available Then
    sDEC = Rdec!art_dec
  Endif

End

'*********************************
'* Calcul du nombre de decimal   *
'*********************************
Public Sub Decimal()

  With Utils
    Qte.Text = .CPoint(Qte.Text)
    If IsNull(Val(Qte.text)) Then Qte.Text = "1"
    If sDEC = "0" Then
      Qte.Text = Format$(Val(Utils.cpoint(Qte.Text)), "0")
    Else
      If sDEC = "2" Then
        Qte.Text = Format$(Val(Utils.cpoint(Qte.Text)), "0.00")
      Else
        If sdec = "3" Then
          Qte.Text = Format$(Val(Utils.cpoint(Qte.Text)), "0.000")
        Endif
      Endif
    Endif
  End With

End

'*****************************************
'* On récupère les remises quantitatives *
'*****************************************
Public Sub Remises_quantitatives()

  Dim i As Integer

  With Utils
    For i = 0 To Rms.Bounds[0] - 1
      If IsNull(Rms[i, 2]) Then
        Break
      Else
        If Val(Utils.cpoint(Qte.Text)) >= Val(.Cpoint(rms[i, 0])) And Val(Utils.cpoint(qte.Text)) <= Val(.Cpoint(rms[i, 1])) Then
          Try Artrmq = Rms[i, 2]
          If Val(.CPoint(Artrmq)) > 0 Then iRemq = 1
          Break
        Endif
      Endif
    Next
  End With

End

Public Sub Button1_Click()

  TextLabel1.Text = "Commentaire"
  Icomm = 1
  Cart.Clear
  Qte.Clear
  Zone = "Commentaire"
  If TouchFam Then Fermer2()
  Cart.SetFocus

End

Public Sub Button3_Click()

  $saisie = ""
  If apromo = True Then
    Message.Warning("Saisie de remise impossible, ce produit est en promotion")
  Else
    If Not IsNull(Cart.text) Then
      mdp_admin()
      If GestMdp = 1 Then
        org = "F6"
        If Start.son Then
          Music.Play
        Endif
        Frame8.visible = True
        Mdp.SetFocus
        Zone = "Mdp"
      Else
        irem = 1
        TextLabel7.Visible = True
        Remise.Visible = True
        Remise.SetFocus
        Remise.select
        Zone = "Remise"
      Endif
    Else
      Message.Warning("Veuillez saisir un produit avant d'effectuer une remise en %")
    Endif
  Endif

End

Public Sub Button4_Click()

  mdp_admin()
  If GestMdp = 1 Then
    org = "F3"
    If Start.son Then
      Music.Play
    Endif
    Frame8.visible = True
    Mdp.SetFocus
    Zone = "Mdp"
  Else
    modif_Tk()
  Endif

End

Public Sub modif_Tk()

  If Not IsNull(Cart.Text) Then
    Design.ReadOnly = False
    Pvttc.ReadOnly = False
    Design.Background = &FFFFFF&
    Pvttc.Background = &FFFFFF&
    iModif = 1
    Zone = "Design"
    Design.SetFocus
    Design.select
  Endif
  admin = 0

End

Public Sub Design_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Pvttc.SetFocus
    Pvttc.Select
    Zone = "Pvttc"
    Stop Event
  Endif

End

Public Sub Pvttc_GotFocus()

  $saisie = ""
  Pvttc.select
  Zone = "Pvttc"

End

Public Sub pvttc_LostFocus()

  'Protection benefique meme en mode sans admin
  'Modif_tk est accessible via F3
  'If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/admin"] Then
  Design.ReadOnly = True
  Pvttc.ReadOnly = True
  Design.Background = &H00BFBFBF&
  Pvttc.Background = &H00BFBFBF&
  'Endif
  TestPvttc()

End

Public Sub Pvttc_KeyPress()

  If key.Control Then
    If Key.code = 84 Then Ouv_Tiroir()
  Endif
  ChkPrx()
  If Key.code = Key.F3 Then Button4_Click()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    bFam = False
    Stop Event
    TestPvttc()
  Endif

End

Public Sub TestPvttc()

  bt = 0

  If Pvttc.ReadOnly = True Then Return

  With Utils
    Pvttc.Text = .cpoint(Pvttc.Text)
    If Val(PvTTc.Text) = Null Then
      If Start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      bt = 1
      Pvttc.SetFocus
      Pvttc.Select
    Else
      PvTTc.Text = Format$(Val(PvTTc.Text), nbdec)
    Endif
    If bt <> 1 Then
      calc_HT()
      If Val(.cpoint(PvTTc.Text)) <> 0 Then
        calc_HT()
        Prix = Pvttc.text
        If Not bFam Then
          Pvht = Format$(Val(Utils.cpoint(Pvttc.Text)) / tx, nbdec)
          If Val(Pvht) < Val(paht) Then
            If Start.son Then
              Music.Play
            Endif
            Try message.warning("ATTENTION ! Le Prix de vente est inférieur au prix d'achat", "OK")
            Pvttc.ReadOnly = False
            Pvttc.Background = &FFFFFF&
            Pvttc.SetFocus
            Pvttc.Select
            Zone = "Pvttc"
            bFam = True
          Else
            Qte.SetFocus
            Qte.Select
            Zone = "Qte"
            Stop Event
          Endif
        Endif
        If Not bFam Then
          Qte.SetFocus
          Qte.Select
          Zone = "Qte"
        Else
          Zone = "Pvttc"
        Endif
      Else
        Try message.warning("ATTENTION ! Le Prix de vente est égal à Zero", "OK")
        Pvttc.ReadOnly = False
        Pvttc.Background = &FFFFFF&
        Pvttc.SetFocus
        Pvttc.Select
        Zone = "Pvttc"
      Endif
    Endif
  End With

Catch
  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  Pvttc.SetFocus
  Pvttc.Select

End

'****************************
'* On calcule la tva        *
'****************************
Public Sub Calc_Tva()

  Dim Rtvaav As Result

  With utils
    Rtvaav = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTvav") & " WHERE code_tva = &1", Tva)
    If Rtvaav.Available Then
      TxTva = Rtvaav!code_tva
      Tva = Rtvaav!taux_tva
    Endif
  End With

End

Public Sub calc_HT()

  Calc_Tva()
  tx = (1 + (Val(Utils.cpoint(Tva)) / 100))
  Pvht = Format$(Val(Utils.cpoint(Artpu)) / tx, nbdec)
  Mtva = Val(Utils.cpoint(Artpu)) - Val(Utils.cpoint(Pvht))

End

Public Sub Calc_TTC()

  Calc_Tva()
  Pvttc.Text = Format$(Val(Utils.cpoint(Pvht)) + (Val(Utils.cpoint(Pvht)) * Tva / 100), Nbdec)
  Artpu = Pvttc.Text
  Mtva = Val(Utils.cpoint(Artpu)) - Val(Utils.cpoint(Pvht))

End

Public Sub Button5_Click()

  ClavFam()

End

'******************** Gestion des remises sur le total du ticket ***************************
Public Sub Button33_Click()

  If (Blexists = True) Then
    Message.Warning("La saisie d'une remise sur total est impossible lorsque des BL sont règlés en caisse!")
    Return
  Endif
  With Utils
    'If IsNull(RemTot.text) Then
      If Val(.cpoint(TotalTk.text)) <> 0 Then
        If Frame1.Visible = True Then
          Frame1.visible = False
          'RemTot.Clear
          'iremT = 0
        Else
          mdp_admin()
          If GestMdp = 1 Then
            org = "CtrlF9"
            If Start.son Then
              Music.Play
            Endif
            Frame8.visible = True
            Mdp.SetFocus
            Zone = "Mdp"
          Else
            Frame1.Visible = True
            RemTot.SetFocus
            iremT = 1
            Zone = "Remtot"
          Endif
        Endif
      Endif
    'Else
    '  Message.Warning("On ne peut pas faire deux remises sur le total du ticket !")
    '  Cart.SetFocus
    'Endif
  End With

End

Public Sub RemTot_KeyPress()

  With utils
    ChkPrx()
    If key.code = key.Esc Then
      Frame1.Visible = False
      'RemTot.Clear
      'iremT = 0
      Cart.SetFocus
      Zone = "Article"
    Endif
    If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
      Valid_Remtot(RemTot.Text)
    Endif
  End With

End

Public Sub Valid_Remtot(RemiseTotal As String)

  Dim sremT As String
  Dim mremT As String
  Dim Nbd As String
  Dim Nbdec As String
  Dim numl As Integer
  Dim rarts As Result

  'On supprime les lignes de remise sur total
  LigTk.MoveFirst
  For numl = 1 To LigTk.count
    Try LigTk.Item.Selected = True
    If Not Error Then
      If LigTk.Item[5] = "MT" Then
        LigTk.Current.Delete
        Numl = 1
        LigTk.MoveFirst
      Else
        LigTk.MoveNext()
      Endif
    Endif
  Next

  'On recalcul sans remise
  Recalc_Tottk()
  rremt = 0

  'On applique la nouvelle remise
  With Utils
    If Not IsNull(RemiseTotal) And If IsNumber(.cpoint(RemiseTotal)) Then
      If Val(.cpoint(RemiseTotal)) >= 0 And If Val(.cpoint(RemiseTotal)) <= 100 Then
        LigTk.Movelast()
        Repeat
          LigTk.item.Selected = True
          If LigTk.Item[5] = "A" Or If LigTk.Item[5] = "S" Then
            'on recupere le nombre de decimal de la ligne
            Rarts = Utils.db.Exec("SELECT art_nbd FROM " & Cbase.Table("TabArt") & " where art_code = &1", LigTk.Item[1])
            If Rarts.Available Then
              Nbd = Rarts!art_nbd
              Nbdec = Utils.Find_Nbdec(Nbd)
            Else
              Nbdec = "0.00"
            Endif
    
            mremT = Format$((Val(utils.CPoint(LigTk.Item[11])) * Val(utils.CPoint(RemiseTotal)) / 100), Nbdec)
            LigTk.Item[11] = Format$(Val(utils.CPoint(LigTk.Item[3])) - Val(.CPoint(mremT)), Nbdec)
            rremT = Val(utils.CPoint(rremT)) + (Abs(Val(utils.CPoint(mremT))) * Val(utils.CPoint(LigTk.Item[4])))
            tva = LigTk.Item[12]
            Calc_Tva()
            Try tx = (1 + (Val(.cpoint(Tva)) / 100))
            Try Pvht = Abs(Val(utils.cpoint(LigTk.Item[11]))) / tx
            Try Pvht = Format$(Pvht * Val(utils.CPoint(LigTk.Item[4])), Nbdec)
            Try Mtva = Format$(Val(Utils.cpoint(LigTk.Item[11])) * Val(utils.CPoint(LigTk.Item[4])) - Val(Utils.cpoint(Pvht)), Nbdec)
            LigTk.Item[6] = Pvht
            LigTk.Item[7] = "0"
            LigTk.Item[9] = Mtva
            LigTk.Item[10] = tva
          Endif
          If LigTk.Item[2] = Space$(15) & "Prix total " Then
            'LigTk.Item[11] = LigTk.Item[3]
            Try LigTk.Item[11] = Format$(Val(utils.CPoint(LigTk.Item[3])) - (Val(utils.CPoint(LigTk.Item[3])) * Val(utils.CPoint(RemiseTotal)) / 100), "0.00")
            tva = LigTk.Item[12]
            Calc_Tva()
            tx = (1 + (Val(.cpoint(Tva)) / 100))
            Try LigTk.Item[6] = Format$(Abs(Val(utils.cpoint(LigTk.Item[11]))) / tx, "0.00")
            Try LigTk.Item[9] = Format$(Val(utils.CPoint(LigTk.Item[11])) - Val(utils.CPoint(LigTk.Item[6])), "0.00")
          Endif
          If LigTk.Item[5] = "MT" Then Break
          If LigTk.Item[5] = "S" Then
            LigTk.MovePrevious()
            LigTk.Item.Selected = True
          Endif
        Until Ligtk.MovePrevious()
        Ligtk.MoveLast()
        Ligtk.item.Selected = True
        If Val(.cpoint(RemiseTotal)) > 0
          Inc iligne
          Inc iNlg
          Bloc = iligne
          sremT = Format$(Val(.CPoint(TotalTk.text)) - (Val(utils.CPoint(TotalTk.text)) * Val(utils.CPoint(RemiseTotal)) / 100), "0.00")
          rremT = Format$(Val(.CPoint(TotalTk.text)) - Val(utils.CPoint(sremT)), "0.00")
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = "total Ticket brut " & Format$(Val(.CPoint(TotalTk.text)), "0.00")
          LigTk.Item[5] = "MT"
          LigTk.Item[8] = bloc
          Inc iligne
          Inc iNlg
          TotalTk.text = sremT
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = RemiseTotal & "% de Remise sur total soit -" & Format$(Val(.CPoint(rremT)), "0.00")
          LigTk.Item[5] = "MT"
          LigTk.Item[8] = bloc
          Inc iligne
          Inc iNlg
          LigTk.Add(iligne, iligne)
          LigTk.Item[0] = iNlg
          LigTk.Item[2] = "Total ticket net " & Format$(Val(.CPoint(TotalTk.text)), "0.00")
          LigTk.Item[5] = "MT"
          LigTk.Item[8] = bloc
          Cart.clear
          Qte.Text = "1"
          Design.clear
          Cart.SetFocus
          Zone = "Article"
          'ClavFam()
        Else
          'RemTot est égal a 0
          RemTot.Clear
          iremT = 0
        Endif
      Else
        Message.Warning("La saisie d'une remise (en %) inféreur à zéro ou supérieur à 100 n'est pas autorisée !")
        iremT = 0
        RemTot.Clear
        RemTot.SetFocus
      Endif
    Endif
  End With

  Frame1.Visible = False
  RenameLigne()

End


Public Sub Button6_Click()

  Aff_viseur("Total ticket " & TotalTk.text)
  'Empeche le passage en règlement si attente de mot de passe
  If (Frame8.visible = True)
    Return
  Endif
  If Clicompte = 1 And CodeclientDefault <> clicode Then
    If Aff_bastk() = True Then
      Button15_Click()
    Else
      Message.Error("Impression impossible ! Aucune ligne sur ticket client " & clicode & " " & clinom & " " & clipnm)
    Endif
  Else
    If Panel17.visible Then Fermer2()
    If iavoir = 1 And Val(TotalTk.Text) > 0 Then
      Aff_bastk()
      Button15_Click()
    Else
      If Frame2.visible = True And ColumnView1.Count = 0 Then
        Frame2.visible = False
        Especes.Clear
        Carte.Clear
        Cheque.Clear
        ColumnView1.Clear
      Else
        If ColumnView1.Count = 0 Then
          If LigTk.Count <> 0 Then
            Frame2.Visible = True
            Mticket.Text = TotalTk.text
            Rticket.text = TotalTk.Text
            Cart.ReadOnly = True
            Qte.ReadOnly = True
            ipaiement = 1
            Inpm.SetFocus
            Inpm.Select
            Zone = "Inpm"
          Endif
        Endif
      Endif
    Endif
  Endif

End

Public Sub Ticket_Attente() As Boolean

  If IsNull(RemTot.text) Then
    If Start.son Then
      Music.Play
    Endif
    If LigTk.Count > 0 Then
      If Start.son Then
        Music.Play
      Endif
      If Message.Warning("Attention ! Etes-vous sur de vouloir mettre ce ticket en attente ?", "Oui", "Non") = 1 Then
        iAttente = 1
        Enrg_Tk(False)
        iRattente = 0
        LigTk.clear
        Ent_tk(Null)
        TotalTk.Text = "0,00"
        Init_LigTk()
        iQte = 0
        iRem = 0
        iAttente = 0
        iRattente = 0
        iAvoir = 0
        Artpu = 0
        Pvht = 0
        Totalht = 0
        Colvente = 0
        Pvht2 = 0
        Cart.SetFocus
        Zone = "Article"
        'ClavFam()
        Return True
      Else
        Return False
      Endif
    Endif
  Else
    If Start.son Then
      Music.Play
    Endif
    Message.Warning("Mise en attente impossible ! Une remise sur total a été effectuée.")
  Endif

End

Public Sub Button7_Click()

  Ticket_Attente()

End

Public Sub Button8_Click()

  Dim Tab As String
  Dim RpTicket As Result
  Dim RCaisse As Result

  If TouchFam Then Fermer2()
  If ColTka.Visible = True Then
    ColTka.Clear
    ColTka.visible = False
    'ClavFam()
    Cart.SetFocus
    Zone = "Article"
  Else
    ColTka.visible = True  
    Tab = "Fiches_EntTicketz"
    RpTicket = Utils.db.Exec("SELECT * FROM " & Tab & " where statut = &1 order by caisse asc, numero desc", "1")
    If RpTicket.Available Then
      Repeat
        Try ColTka.Add(RpTicket!numero, RpTicket!numero)
        ColTka.Item[0] = RpTicket!caisse
        ColTka.Item[1] = RpTicket!numero
        ColTka.Item[2] = LDate(RpTicket!date).LT
        ColTka.Item[3] = RpTicket!mttc
        ColTka.Item[4] = RpTicket!client
      Until RpTicket.MoveNext()
      ColTka.MoveFirst
      ColTka.SetFocus
      ColTka.Item.Selected = True
    Endif
      
      

  Endif

End

Public Sub ColTka_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then ColTka_Click()
  If Key.code = Key.F9 Or If Key.code = Key.Esc Then
    ColTka.Clear
    ColTka.visible = False
  Endif

End

Public Sub ColTka_Click()

  Dim Mtk As String
  Dim RTck As Result
  Dim Tab As String
  Dim Clitab As Result
  Dim Caisse As String

  Caisse = ColTka.Item[0]
  Tab = "Fiches_EntTicketz"
  If LigTk.Count > 0 Then
    If Ticket_Attente() == False Then
      Return
    Endif
  Endif

  LigTk.Clear
  Init_LigTk()
  iNlg = 0
  Totalht = 0
  Numtk = ColTka.Item[1]
  Datetk.L = ColTka.Item[2]
  Mtk = ColTka.Item[3]
  ColTka.visible = False
  ColTka.clear
  RTck = Utils.db.Exec("SELECT * FROM " & Tab & " where numero = &1", Numtk)
  Client2 = Rtck!client
  $Cli = Rtck!nom

  Ent_tk(numtk)

  TotalTk.Text = RTck!mttc
  If (RTck!type = 1) Then
    Clicompte = 1
    clicode = RTck!client
    Try Clitab = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " as c inner join  " & Cbase.Table("TabComptes") & " as a on a.compte_cc = c.cli_code where cli_code = &1", Clicode)
    If Not Error Then
      Bdc.Text = "Bon de caisse " & Clitab!cli_nom & " " & Clitab!cli_pnm
    Else
      Bdc.Text = "Bon de caisse " & clicode
    Endif
  Endif

  Tab = "Fiches_LigTicketz"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numero = &1 order by cast(numlig as unsigned)", Numtk)
  If rResult.Available Then
    Repeat
      Inc iligne
      Inc iNlg
      Try LigTk.Add(rResult!numlig, rResult!numlig)
      LigTk.Item[0] = rResult!numlig
      LigTk.Item[1] = rResult!code
      LigTk.Item[2] = rResult!intitule
      LigTk.Item[3] = rResult!montant
      LigTk.Item[4] = rResult!qte
      LigTk.Item[5] = rResult!type
      LigTk.Item[6] = rResult!mht
      LigTk.Item[7] = rResult!mrem
      LigTk.Item[8] = rResult!block
      LigTk.Item[9] = rResult!mtva
      LigTk.Item[10] = rResult!tva
      LigTk.Item[11] = rResult!montant
      If rResult!type = "A" Then
        Totalht = Val(Utils.cpoint(Totalht)) + (Val(utils.cpoint(rResult!mht)))
        Totalht = Format$(Totalht, "0.00")
      Endif
      'verifie si BLs règlé dans ce ticket
      If rResult!type = "BL" Then
        Blexists = True
      Endif
    Until rResult.MoveNext()
    'On met le flag ticket Rappelé
    iRattente = 1
  Endif
  Cart.SetFocus
  Zone = "Article"
  'ClavFam()

  'Le Ticket garde son numéro mais change de caisse lors du rappel
  'On le supprime de la table des tickets Ent & Lignes
  'il sera enregistre plus tard par la nouvelle caisse
  Tab = "Fiches_EntTicketz"
  RTck = Utils.db.Exec("SELECT * FROM " & Tab & " where statut = &1 and numero = &2", 1, Numtk)
  If RTck.Available Then
    Utils.db.Exec("DELETE FROM " & Tab & " where statut = &1 and numero = &2", 1, Numtk)
    Tab = "Fiches_LigTicketz"
    Utils.db.Exec("DELETE FROM " & Tab & " where numero = &1", Numtk)
  Endif

End

'******************************** SUPPRESSION DU TICKET **********************************
Public Sub Button9_Click()

  mdp_admin()
  If GestMdp = 1 Then
    org = "F10"
    If Start.son Then
      Music.Play
    Endif
    Frame8.visible = True
    Mdp.SetFocus
    Zone = "Mdp"
  Else
    If IsNull(RemTot.Text) Then
      suppr_Tk()
    Else
      Message.Warning("Suppression impossible ! Une remise sur total a été effectuée.")
    Endif
  Endif

End

Public Sub suppr_Tk()

  Dim Tab As String
  Dim sup As Integer
  Dim numero_tk As String

  Tab = "Fiches_EntTicketz"
  If iRattente = 0 Then
    numero_tk = Ntk
  Else
    numero_tk = numtk
  Endif
  If LigTk.Count > 0 Then
    If Start.son Then
      Music.Play
    Endif
    If ipaiement = 0 Then
      sup = Message.Warning("Attention ! Etes-vous sur de vouloir supprimer ce ticket ? ", "Oui", "Non")
    Else
      sup = 1
    Endif
    If sup = 1 Then
      Try Utils.db.Exec("Update " & Cbase.Table("TabBl") & " set numtick = &1 where numtick = &2", Null, numero_tk)
      rResult = Utils.db.Exec("select * FROM " & Tab & " where caisse = &1 and numero = &2", Ncaisse, numero_tk)
      If rResult.Available Then
        Message.Warning("Ceci ne devrait pas arriver!")
      Else
        Enrg_Tk(True)
      Endif
      LigTk.Clear
      Init_LigTk()
      Ent_tk(Null)
      TotalTk.Text = "0,00"
      Cart.SetFocus
      Zone = "Article"
      iQte = 0
      iRem = 0
      iAttente = 0
      iRattente = 0
      iAvoir = 0
      inlg = 0
      iligne = 0
      Tottva = 0
      Totalht = 0
      Clicompte = 0
      rremT = 0
      RemTot.Text = ""
      bretro = False
      bmodifregl = False
    Endif
  Else
    Bdc.Text = ""
    Clicompte = 0
  Endif

End

'*****************************************
'*          Gestion des avoirs           *
'*****************************************
Public Sub Button10_Click()

  If Frame3.Visible = True Then
    Frame3.Visible = False
    iavoir = 0
    Cart.SetFocus
    Zone = "Article"
  Else
    If LigTk.Count = 0 Then
      mdp_admin()
      If GestMdp = 1 Then
        org = "F11"
        If Start.son Then
          Music.Play
        Endif
        Frame8.visible = True
        Mdp.SetFocus
        Zone = "Mdp"
      Else
        iAvoir = 1
        Frame3.Visible = True
        Nmc.SetFocus
      Endif
    Else
      If Start.son Then
        Music.Play
      Endif
      Try Message.Warning("Un avoir se détermine en début de ticket !\n Veuillez annuler votre saisie en cours SVP.")
    Endif
  Endif

End

Public Sub button17_Click()

  Dim i As Integer = 0
  Dim sline As String

  If iavoir = "1" Then
    Inc iligne
    Inc iNlg
    snavoir = Nmc.Text
    LigTk.Add(iligne, iligne)
    LigTk.Item[0] = iNlg
    LigTk.Item[2] = "Avoir " & Nmc.Text
    LigTk.Item[5] = "TA"
    Inc iligne
    Inc iNlg
    For Each sline In Split(sAvoir, "\n")
      Inc i
      LigTk.Add(iligne, iligne)
      LigTk.Item[0] = iNlg
      LigTk.Item[2] = sline
      LigTk.Item[5] = "TA"
      Inc iligne
      Inc iNlg
      If i = 4 Then Break
    Next
    LigTk.Add(iligne, iligne)
    LigTk.Item[0] = iNlg
    LigTk.Item[2] = " "
    LigTk.Item[5] = "C"
  Else
    $Cli = Nmc.Text
  Endif
  Frame3.Visible = False
  Nmc.Clear
  Cart.SetFocus
  Zone = "Article"
  $saisie = ""

End

Public Sub Nmc_KeyPress()

  If Key.code = Key.F11 Or key.code = Key.esc Then
    Frame3.Visible = False
    iavoir = 0
    Cart.SetFocus
    Zone = "Article"
  Endif
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then button17_Click()

End

'*****************************************
'*         Gestion des especes           *
'*****************************************

Public Sub Button11_Click()

  init_paiement()
  'If Mvt = "E" Then
  '  Frame5.Visible = True
  '  Frame5.Raise
  '  Frame5.text = "Encaissement hors vente en espèces"
  '  TypEnc = "E"
  '  Nmc3.SetFocus
  '  Zone = "Nmc3"
  'Else
    'init_paiement()
    Especes.visible = True
    Especes.text = Rticket.Text
    Especes.SetFocus
    Especes.Select
    Zone = "Especes"
    Aff_viseur("Reglement especes")
  'Endif

End

Public Sub Especes_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Valid_Especes()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Especes()

  If Not IsNull(Especes.text) Then
    Especes.Text = Utils.cpoint(Especes.Text)
    If Val(Especes.Text) = Null Then
      If Start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Especes.SetFocus
      Especes.Select
      Zone = "Especes"
    Else
      'If Val(Especes.Text) <> 0 And Val(Rticket.Text) > 0 Then
      If Val(Especes.Text) <> 0 Or Val(Mticket.Text) <> 0 Then
        Especes.Text = Format$(Val(Especes.Text), "0.00")
        Calc_reste(Especes.text)
        Try ColumnView1.Add("N", "N")
        If Not Error Then
          ColumnView1.Item[0] = "N"
          ColumnView1.Item[1] = "Especes : "
          ColumnView1.Item[2] = Especes.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "N" Then
              'If Val(Utils.cpoint(Especes.Text)) < 0 Then
              '  Especes.Text = Abs(Val(Utils.cpoint(Especes.Text)))
              '  ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Especes.Text)), "0.00")
              'Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Especes.Text)), "0.00")
              'Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        'If Val(Utils.cpoint(Rticket.Text)) < 0 And bmodifregl = False Then
        If Val(Utils.cpoint(Especes.Text)) > 0 And Val(Utils.cpoint(Especes.Text)) > Val(Mticket.Text) And bmodifregl = False Then
          Try ColumnView1.Add("Q", "Q")
          If Not Error Then
            ColumnView1.Item[0] = "Q"
            ColumnView1.Item[1] = "Montant rendu : "
            ColumnView1.Item[2] = Format$(Abs(Val(Utils.cpoint(Rticket.Text))), "0.00")
          Else
            ColumnView1.MoveFirst()
            Repeat
              If ColumnView1.Item[0] = "Q" Then
                If Val(Utils.cpoint(Especes.Text)) < 0 Then
                  Especes.Text = Abs(Val(Utils.cpoint(Especes.Text)))
                  ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Especes.Text)), "0.00")
                Else
                  ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Especes.Text)), "0.00")
                Endif
              Endif
            Until ColumnView1.MoveNext()
          Endif
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "Q" Then
              ColumnView1.Item.Delete()
              ColumnView1.MoveFirst()
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Especes.Clear
        Especes.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Else
        'On autorise l'enregistement d'un ticket null espèce pour un echange d'article
        'avec meme valeur
        If Ligtk.Count > 0 Then
          Especes.Text = Format$(Val(Especes.Text), "0.00")
          Calc_reste(Especes.text)
          Try ColumnView1.Add("N", "N")
          If Not Error Then
            ColumnView1.Item[0] = "N"
            ColumnView1.Item[1] = "Especes : "
            ColumnView1.Item[2] = Especes.Text
          Endif
          Especes.Clear
          Especes.Visible = False
          Delete_Reglements_Tk()
          Aff_bastk()
          Inpm.SetFocus
        Else
          Message.Error("Règlement impossible ! Aucune ligne sur ticket")
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*         Gestion des cartes            *
'*****************************************
Public Sub Button12_Click()

  init_paiement()
  'If Mvt = "E" Then
  '  Frame5.Visible = True
  '  Frame5.text = "Encaissement hors vente par carte"
  '  TypEnc = "C"
  '  Nmc3.SetFocus
  '  Zone = "Nmc3"
  'Else
    Aff_viseur("Reglement par carte")
    If Frame4.Visible = True Then
      Frame4.Visible = False
      'Panel12.visible = False
      icarte = 0
      Inpm.SetFocus
    Else
      If Not Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximpc"] Then
        Frame4.visible = True
        icarte = 1
        Nmc2.clear
        If icartef = 1 Then Nmc2.Text = Label1.Text
        Nmc2.SetFocus
        Zone = "Nmc2"
      Else
        icarte = 1
        Button19_click()
      Endif
    Endif
  'Endif

End

Public Sub Nmc2_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Frame4.Visible = False
    'Panel12.visible = False
    Button19_click()
  Endif
  If Key.code = Key.f2 Or key.code = key.F3 Or key.code = key.F4 Or key.code = key.F5 Or key.code = key.F6 Or key.code = key.Esc Then
    Nmc2.Clear
    Frame4.Visible = False
    'Panel12.visible = False
    init_paiement()
    Inpm.SetFocus
  Endif

End

Public Sub button19_Click()

  If icarte = 1 Then
    snmcarte = Nmc2.Text
    init_paiement()
    Carte.text = Rticket.Text
    carte.visible = True
    carte.SetFocus
    carte.Select
    Zone = "Carte"
  Endif
  If icheque = 1 Then
    snmcheque = Nmc2.Text
    Bcheque = True
    init_paiement()
    Cheque.text = Rticket.Text
    Cheque.visible = True
    Cheque.SetFocus
    Cheque.Select
    Zone = "Cheque"
  Endif
  If icredit = 1 Then
    snmcredit = Nmc2.Text
    init_paiement()
    If Val(Rticket.Text) <> 0 Then
      Credit.text = Rticket.Text
      credit.visible = True
      credit.SetFocus
      credit.Select
      Zone = "Credit"
    Endif
  Endif
  If iachat = 1 Then
    snmachat = Nmc2.Text
    init_paiement()
    If Val(Rticket.Text) <> 0 Then
      Bachat.text = Rticket.Text
      Bachat.visible = True
      Bachat.SetFocus
      Bachat.Select
      Zone = "Bachat"
    Endif
  Endif
  If ichequecad = 1 Then
    snmchequecad = Nmc2.Text
    init_paiement()
    If Val(Rticket.Text) <> 0 Then
      chequecad.text = Rticket.Text
      chequecad.visible = True
      chequecad.SetFocus
      chequecad.Select
      Zone = "Chequecad"
    Endif
  Endif
  icarte = 0
  icredit = 0
  iachat = 0
  ichequecad = 0
  'Nmc2.Clear
  Frame4.Visible = False
  $saisie = ""

End

Public Sub carte_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Carte()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Carte()

  If Not IsNull(Carte.text) Then
    Carte.Text = Utils.cpoint(Carte.Text)
    If Val(Carte.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Carte.SetFocus
      Carte.Select
      Zone = "Carte"
    Else
      If Val(Carte.Text) <> 0 Then
        Carte.Text = Format$(Val(Carte.Text), "0.00")
        Calc_reste(Carte.text)
        Try ColumnView1.Add("U", "U")
        If Error Then
          ColumnView1.Add("U" & nbc, "U" & nbc)
          Inc nbc
        Endif
        'If Not Error Then
        ColumnView1.Item[0] = "U"
        ColumnView1.Item[1] = "Carte " & snmcarte
        ColumnView1.Item[2] = carte.Text
        ' Else
        ' ColumnView1.MoveFirst()
        'Repeat
        'If ColumnView1.Item[0] = "U" Then
        ' If Val(Utils.cpoint(carte.Text)) < 0 Then
        '  carte.Text = Abs(Val(Utils.cpoint(carte.Text)))
        ' ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(carte.Text)), "0.00")
        ' Else
        ' ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(carte.Text)), "0.00")
        'Endif
        'Break
        'Endif
        'Until ColumnView1.MoveNext()
        'Endif
        carte.Clear
        Carte.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*         Gestion des chèques           *
'*****************************************
Public Sub Button13_Click()

  init_paiement()
  'If Mvt = "E" Then
  '  Frame5.Visible = True
  '  Frame5.text = "Encaissement hors vente par chèque"
  '  TypEnc = "H"
  '  Nmc3.SetFocus
  '  Zone = "Nmc3"
  'Else
    Aff_viseur("Reglement par cheque")
    If Frame4.Visible = True Then
      Frame4.Visible = False
      'Panel12.visible = False
      icheque = 0
      Inpm.SetFocus
    Else
      If Not Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximpn"] Then
        Nmc2.clear
        Frame4.visible = True
        icheque = 1
        If icartef = 1 Then Nmc2.Text = Label1.Text
        Nmc2.SetFocus
        Zone = "Nmc2"
      Else
        icheque = 1
        Button19_click()
      Endif
    Endif
  'Endif

End

Public Sub Cheque_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Cheque()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Cheque()

  If Not IsNull(Cheque.text) Then
    Cheque.Text = Utils.cpoint(Cheque.Text)
    If Val(Cheque.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Cheque.SetFocus
      Cheque.Select
      Zone = "Cheque"
    Else
      If Val(Cheque.Text) <> 0 Then
        Cheque.Text = Format$(Val(Cheque.Text), "0.00")
        If Message.Question("Voulez-vous imprimer le chèque ?", "Oui", "Non") = 1 Then
          Imp_Cheque()
        Else
          bcheque = False
        Endif
        Calc_reste(Cheque.text)
        Try ColumnView1.Add("V", "V")
        If Error Then
          ColumnView1.Add("V" & nbc, "V" & nbc)
          Inc nbc
        Endif
        'If Not Error Then
        ColumnView1.Item[0] = "V"
        ColumnView1.Item[1] = "Cheque " & snmcheque
        ColumnView1.Item[2] = Cheque.Text
        'Else
        'ColumnView1.MoveFirst()
        'Repeat
        'If ColumnView1.Item[0] = "V" Then
        'If Val(Utils.cpoint(Cheque.Text)) < 0 Then
        'Cheque.Text = Abs(Val(Utils.cpoint(Cheque.Text)))
        'ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Cheque.Text)), "0.00")
        'Else
        'ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Cheque.Text)), "0.00")
        'Endif
        'Endif
        'Until ColumnView1.MoveNext()
        'Endif
        Cheque.Clear
        Cheque.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*         Gestion du crédit             *
'*****************************************
Public Sub Button14_Click()

  init_paiement()
  If Frame4.Visible = True Then
    Frame4.Visible = False
    'Panel12.visible = False
    icredit = 0
    Inpm.SetFocus
  Else
    Frame4.visible = True
    icredit = 1
    If icartef = 1 Then Nmc2.Text = Label1.Text
    Nmc2.SetFocus
    Zone = "Nmc2"
  Endif

End

Public Sub credit_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Credit()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Credit()

  If Not IsNull(Credit.text) Then
    Credit.Text = Utils.cpoint(Credit.Text)
    If Val(Credit.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Credit.SetFocus
      Credit.Select
      Zone = "Credit"
    Else
      If Val(Credit.Text) <> 0 And Val(Rticket.Text) > 0 Then
        Credit.Text = Format$(Val(Credit.Text), "0.00")
        Calc_reste(Credit.text)
        Try ColumnView1.Add("W", "W")
        If Not Error Then
          ColumnView1.Item[0] = "W"
          ColumnView1.Item[1] = "Credit " & snmcredit
          ColumnView1.Item[2] = credit.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "W" Then
              If Val(Utils.cpoint(Credit.Text)) < 0 Then
                credit.Text = Abs(Val(Utils.cpoint(Credit.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Credit.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Credit.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        credit.Clear
        Credit.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*      Gestion des bons d'achat         *
'*****************************************
Public Sub Button16_Click()

  init_paiement()
  If Frame4.Visible = True Then
    Frame4.Visible = False
    'Panel12.visible = False
    iachat = 0
    Inpm.SetFocus
  Else
    Frame4.visible = True
    iachat = 1
    If icartef = 1 Then Nmc2.Text = Label1.Text
    Nmc2.SetFocus
    Zone = "Nmc2"
  Endif

End

Public Sub Bachat_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    iachat = 0
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Bachat()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Bachat()

  If Not IsNull(Bachat.text) Then
    Bachat.Text = Utils.cpoint(Bachat.Text)
    If Val(Bachat.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Bachat.SetFocus
      Bachat.Select
      Zone = "Bachat"
    Else
      If Val(Bachat.Text) <> 0 Then
        Bachat.Text = Format$(Val(Bachat.Text), "0.00")
        Calc_reste(Bachat.text)
        Try ColumnView1.Add("X", "X")
        If Not Error Then
          ColumnView1.Item[0] = "X"
          ColumnView1.Item[1] = "Bon achat " & snmachat
          ColumnView1.Item[2] = Bachat.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "X" Then
              If Val(Utils.cpoint(Bachat.Text)) < 0 Then
                Bachat.Text = Abs(Val(Utils.cpoint(Bachat.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Bachat.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Bachat.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Bachat.Clear
        Bachat.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) = 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'***********************************
'*      Gestion des avoirs         *
'***********************************
Public Sub Button18_Click()

  Dim rlib As Result

  init_paiement()
  If Bavoir.visible = True Then
    Bavoir.Clear
    Bavoir.Visible = False
  Endif
  If Cavoirs.visible = True Then
    Cavoirs.Clear
    Cavoirs.Visible = False
  Else
    init_paiement()
    If Val(Rticket.Text) <> 0 Then
      Cavoirs.Visible = True
      Cavoirs.Columns.count = 4
      Cavoirs.Columns[0].text = "No ticket"
      Cavoirs.Columns[0].Width = 80
      Cavoirs.Columns[1].Width = 240
      Cavoirs.Columns[1].text = "Nom du client"
      Cavoirs.Columns[2].text = "Date"
      Cavoirs.Columns[2].Width = 100
      Cavoirs.Columns[3].Width = 80
      Cavoirs.Columns[3].text = "Montant"
      Cavoirs.Columns[3].Alignment = 2
      rlib = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAvoirs") & "")
      If rlib.Available Then
        Repeat
          Cavoirs.Add(rlib!ntk, rlib!ntk)
          Cavoirs.Item[0] = rlib!ntk
          Cavoirs.Item[1] = rlib!intitule
          Cavoirs.Item[2] = LDate(rlib!dte).LT
          Cavoirs.Item[3] = Format$(rlib!montant, "0.00")
        Until rlib.MoveNext()
      Endif
      Cavoirs.MoveFirst()
      Try Cavoirs.Current.Selected = True
      Cavoirs.SetFocus
    Endif
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub cavoirs_keyPress()

  If Key.code = Key.F8 Or If key.code = key.Esc Then
    Cavoirs.Clear
    Cavoirs.Visible = False
    Inpm.SetFocus
  Endif
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Bavoir.Text = Cavoirs.Item[3]
    mavoir = Bavoir.Text
    Numavoir = Cavoirs.Item[0]
    Cavoirs.Clear
    Cavoirs.Visible = False
    Bavoir.visible = True
    Bavoir.SetFocus
    Bavoir.Select
    Zone = "Bavoir"
  Endif

End

Public Sub Bavoir_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Bavoir()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Bavoir()

  If Not IsNull(Bavoir.text) Then
    Bavoir.Text = Utils.cpoint(Bavoir.Text)
    If Val(Bavoir.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Bavoir.SetFocus
      Bavoir.Select
      Zone = "Bavoir"
    Else
      If Val(Bavoir.Text) <> 0 And Val(Rticket.Text) > 0 Then
        Bavoir.Text = Format$(Val(Bavoir.Text), "0.00")
        Calc_reste(Bavoir.text)
        Try ColumnView1.Add("Z" & Numavoir, "Z" & Numavoir)
        If Not Error Then
          ColumnView1.Item[0] = "Z"
          ColumnView1.Item[1] = "Avoir No " & Numavoir
          ColumnView1.Item[2] = Bavoir.Text
          'Else
          'ColumnView1.MoveFirst()
          'Repeat
          'If ColumnView1.Item[0] = "Z" Then
          'ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Bavoir.Text)), "0.00")
          'Break
          'Endif
          'Until ColumnView1.MoveNext()
        Endif
        If Bavoir.Text < mavoir Then
          Try ColumnView1.Add("Q", "Q")
          ColumnView1.Item[0] = "Q"
          ColumnView1.Item[1] = "Montant rendu : "
          ColumnView1.Item[2] = Format$(Abs(Val(Utils.cpoint(Rticket.Text))), "0.00")
          Aff_bastk()
        Endif
        Bavoir.Clear
        mavoir = False
        If Val(Rticket.Text) = 0 Then
          Bavoir.Visible = False
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Endif
      Endif
    Endif
  Endif

End

Public Sub Cavoirs_Click()

  Bavoir.Text = Cavoirs.Item[3]
  mavoir = Bavoir.text
  Numavoir = Cavoirs.Item[0]
  Cavoirs.Clear
  Cavoirs.Visible = False
  Bavoir.visible = True
  Bavoir.SetFocus
  Bavoir.Select
  Zone = "Bavoir"
  $saisie = ""

End

'*****************************************
'*      Gestion des chèques cadeau       *
'*****************************************
Public Sub Button27_Click()

  init_paiement()
  If Frame4.Visible = True Then
    Frame4.Visible = False
    'Panel12.visible = False
    ichequecad = 0
    Inpm.SetFocus
  Else
    Frame4.visible = True
    ichequecad = 1
    If icartef = 1 Then Nmc2.Text = Label1.Text
    Nmc2.SetFocus
    Zone = "Nmc2"
  Endif

End

Public Sub Chequecad_KeyPress()

  If key.code = Key.F1 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()

  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Chequecad()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Chequecad()

  If Not IsNull(Chequecad.text) Then
    Chequecad.Text = Utils.cpoint(Chequecad.Text)
    If Val(Chequecad.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Chequecad.SetFocus
      Chequecad.Select
      Zone = "Chequecad"
    Else
      If Val(Chequecad.Text) <> 0 And Val(Rticket.Text) > 0 Then
        Chequecad.Text = Format$(Val(Chequecad.Text), "0.00")
        Calc_reste(Chequecad.text)
        Try ColumnView1.Add("Y", "Y")
        If Not Error Then
          ColumnView1.Item[0] = "Y"
          ColumnView1.Item[1] = "Cheque cadeau " & snmchequecad
          ColumnView1.Item[2] = Chequecad.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "Y" Then
              If Val(Utils.cpoint(Chequecad.Text)) < 0 Then
                Chequecad.Text = Abs(Val(Utils.cpoint(Chequecad.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Chequecad.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Chequecad.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Chequecad.Clear
        Chequecad.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*      Gestion des bons de réduction    *
'*****************************************
Public Sub Button36_Click()

  init_paiement()
  Breduc.visible = True
  Breduc.text = "0,00"
  Breduc.SetFocus
  Breduc.Select
  Zone = "Breduc"

End

Public Sub Breduc_KeyPress()

  If key.code = Key.F11 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()

  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Breduc()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Breduc()

  If Not IsNull(Breduc.text) Then
    Breduc.Text = Utils.cpoint(Breduc.Text)
    If Val(Breduc.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Breduc.SetFocus
      Breduc.Select
      Zone = "Breduc"
    Else
      If Val(Breduc.Text) <> 0 Then
        Breduc.Text = Format$(Val(Breduc.Text), "0.00")
        Calc_reste(Breduc.text)
        Try ColumnView1.Add("E", "E")
        If Not Error Then
          ColumnView1.Item[0] = "E"
          ColumnView1.Item[1] = "Bon reduction " & snmreduc
          ColumnView1.Item[2] = Breduc.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "E" Then
              If Val(Utils.cpoint(Breduc.Text)) < 0 Then
                Chequecad.Text = Abs(Val(Utils.cpoint(Breduc.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Breduc.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Breduc.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Breduc.Clear
        Breduc.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'******************************************
'*      Gestion des chèques entreprise    *
'******************************************
Public Sub Button53_Click()

  init_paiement()
  Tresto.visible = True
  Tresto.text = "0,00"
  Tresto.SetFocus
  Tresto.Select
  Zone = "Tresto"

End

Public Sub Tresto_KeyPress()

  If key.code = Key.F12 Or key.code = Key.esc Then
    init_paiement()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()

  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Tresto()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Tresto()

  If Not IsNull(Tresto.text) Then
    Tresto.Text = Utils.cpoint(Tresto.Text)
    If Val(Tresto.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Tresto.SetFocus
      Tresto.Select
      Zone = "Tresto"
    Else
      If Val(Tresto.Text) <> 0 Then
        Tresto.Text = Format$(Val(Tresto.Text), "0.00")
        Rticket.text = Val(Utils.cpoint(Rticket.text)) - Val(Utils.cpoint(Tresto.Text))
        If Val(Utils.cpoint(Rticket.Text)) < 0 Then Rticket.Text = "0.00"
        Rticket.Text = Format$(Rticket.Text, "0.00")
        Try ColumnView1.Add("1", "1")
        If Not Error Then
          ColumnView1.Item[0] = "1"
          ColumnView1.Item[1] = "Chèque entreprise "
          ColumnView1.Item[2] = Tresto.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "1" Then
              If Val(Utils.cpoint(Tresto.Text)) < 0 Then
                Tresto.Text = Abs(Val(Utils.cpoint(Tresto.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Tresto.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Tresto.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Tresto.Clear
        Tresto.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'*****************************************
'*         Gestion du bonus          *
'*****************************************
Public Sub Button31_Click()

  If Val(Utils.cpoint(fbonusg)) = 0 Then
    Message.Info("Il n'y a pas de bonus en cours!")
  Else
    init_paiement()
    Aff_viseur("Bonus")
    Bonus.Visible = True
    'Totgain = fbonusg
    Bonus.text = Format$(Val(Utils.cpoint(fbonusg)), "0.00")
    Bonus.SetFocus
    Bonus.Select
    Zone = "Bonus"
  Endif

End

Public Sub Bonus_KeyPress()

  If key.code = Key.F9 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkBs()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Bonus()
    'Bonus.ReadOnly = FALSE
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Bonus()

  If Val(Bonus.Text) > Val(Utils.cpoint(fbonusg)) Then
    Message.Error("Le montant saisi ne peut pas être supérieur au bonus !")
    Return
  Endif
  If Not IsNull(Bonus.text) Then
    Bonus.Text = Utils.cpoint(Bonus.Text)
    If Val(Bonus.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Bonus.SetFocus
      Bonus.Select
      Zone = "Bonus"
    Else
      If Val(Bonus.Text) <> 0 And Val(Rticket.Text) > 0 Then
        Bonus.Text = Format$(Val(Bonus.Text), "0.00")
        Calc_reste(Bonus.text)
        Try ColumnView1.Add("B", "B")
        If Not Error Then
          ColumnView1.Item[0] = "B"
          ColumnView1.Item[1] = "Bonus " & Label2.text & " :"
          ColumnView1.Item[2] = Bonus.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "B" Then
              If Val(Utils.cpoint(Bonus.text.Text)) < 0 Then
                Bonus.text.Text = Abs(Val(Utils.cpoint(Bonus.text.Text)))
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) - Val(Utils.cpoint(Bonus.text.Text)), "0.00")
              Else
                ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[2])) + Val(Utils.cpoint(Bonus.text.Text)), "0.00")
              Endif
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Boni = Val(Utils.cpoint(ColumnView1.Item[2]))
        Bonus.Clear
        Bonus.Visible = False
        If Val(Utils.cpoint(Rticket.Text)) <= 0 Then
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

'********************************************* On ajoute les points de fidélité en bas de ticket **********************
Public Sub pointsF()

  Dim rlib As Result
  Dim rbonus As Result
  Dim Txtbfac As String
  Dim sline As String
  Dim i As Integer = 1
  Dim Block As String
  Dim pu As String = "0"
  Dim totf As Float = 0
  Dim numl As Integer
  Dim prom As Boolean = False
  Dim abonus As Float

  rlib = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLibelTicket") & "")
  If rlib.Available Then Txtbfac = rlib!libeltk
  Delete_Reglements_Tk()
  Aff_bastk()
  Inc iNlg
  With Utils
    LigTk.MoveFirst
    Try LigTk.Item.Selected = True
    Try Block = LigTk.Current[8]
    For numl = 1 To LigTk.count
      Try LigTk.Item.Selected = True
      If Not Error Then
        If LigTk.Item[2] = "*** Produit en promotion ***" Then prom = True
        If LigTk.current[8] = Block Then
          If LigTk.Item[5] = "A" Then
            Pu = LigTk.Current[3]
            Pu = Val(Utils.cpoint(pu)) * Val(Utils.cpoint(LigTk.Current[4]))
            Pu = Format$(pu, "0.00")
            If prom = True Then
              If fpromo = False Then pu = "0"
            Endif
          Else
            If LigTk.Item[5] = "M" Or If LigTk.Item[5] = "S" Then
              If frem = True Then
                Pu = LigTk.Current[3]
                Pu = Val(Utils.cpoint(pu)) * Val(Utils.cpoint(LigTk.Current[4]))
                Pu = Format$(pu, "0.00")
              Else
                Pu = "0"
              Endif
            Endif
          Endif
          rbonus = Utils.db.Exec("SELECT art_bonus FROM " & Cbase.Table("TabArt") & " where art_code = &1", LigTk.Item[1])
          Try abonus = rbonus!art_bonus
          If Error Then abonus = 0
          If rbonus.Available Then pu = Val(.cpoint(pu)) - (Val(.cpoint(pu)) * abonus / 100)
        Endif
      Endif
      LigTk.MoveNext()
      Try LigTk.Item.Selected = True
      If Block <> LigTk.Current[8] Then
        totf = totf + Val(Utils.cpoint(pu))
        Block = LigTk.Current[8]
        Prom = False
        pu = "0"
      Endif
    Next
    If icartef = 1 Then
      If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/recapbonus"] <> "0" Then
        Try LigTk.Add("Da", "Da")
        If Not Error Then
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = "Pts avant "
          LigTk.Item[2] = Format$(ftpoint, "0.00")
        Endif
        Try LigTk.Add("Dc", "Dc")
        If Not Error Then
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = "Pts acquis "
          LigTk.Item[2] = Format$(totf, "0.00")
          Ftpointg = totf
        Endif
        Try LigTk.Add("Dt", "Dt")
        If Not Error Then
          LigTk.Item[0] = iNlg
          LigTk.Item[1] = "Tot points "
          LigTk.Item[2] = Format$(Val(Utils.cpoint(ftpoint)) + totf, "0.00")
          ftpoint = ftpoint + totf
        Endif
      Else
        Ftpointg = totf
        ftpoint = ftpoint + totf
      Endif
    Endif
    Inc iligne
    Inc iNlg
    LigTk.Columns[2].Width = 340
    For Each sline In Split(Txtbfac, "\n")
      Inc i
      LigTk.Add(iligne, iligne)
      LigTk.Item[0] = iNlg
      LigTk.Item[1] = ""
      LigTk.Item[2] = sline
      LigTk.Item[5] = "K"
      Inc iNlg
      Inc iligne
      If i = 4 Then Break
    Next
    LigTk.Columns[2].Width = 240
  End With

End

'***********************************
'*     Gestion des acomptes        *
'***********************************
Public Sub Button35_Click()

  Dim rlib As Result

  init_paiement()
  If Bacompte.visible = True Then
    Bacompte.Clear
    Bacompte.Visible = False
  Endif
  If Cacomptes.visible = True Then
    Cacomptes.Clear
    Cacomptes.Visible = False
    Inpm.SetFocus
  Else
    init_paiement()
    If Val(Rticket.Text) <> 0 Then
      Cacomptes.Visible = True
      Cacomptes.Columns.count = 5
      Cacomptes.Columns[0].Width = 0
      Cacomptes.Columns[1].Width = 250
      Cacomptes.Columns[1].text = "Intitulé"
      Cacomptes.Columns[2].Width = 120
      Cacomptes.Columns[2].text = "Réglement"
      Cacomptes.Columns[3].Width = 80
      Cacomptes.Columns[3].text = "Montant"
      Cacomptes.Columns[3].Alignment = 2
      Cacomptes.Columns[4].Width = 60
      Cacomptes.Columns[4].text = "Date"
      Cacomptes.Columns[4].Alignment = 2
      rlib = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAcomptes") & "")
      If rlib.Available Then
        Repeat
          Cacomptes.Add(rlib!lind, rlib!lind)
          Cacomptes.Item[0] = rlib!lind
          Cacomptes.Item[1] = rlib!intitule
          If rlib!type = "G" Then Cacomptes.Item[2] = "Especes"
          If rlib!type = "P" Then Cacomptes.Item[2] = "Carte"
          If rlib!type = "H" Then Cacomptes.Item[2] = "Cheque"
          Cacomptes.Item[3] = Format$(Val(Utils.cpoint(rlib!montant)), "0.00")
          Cacomptes.Item[4] = Utils.Cdate_Aff(rlib!date)
        Until rlib.MoveNext()
      Endif
      Cacomptes.MoveFirst()
      Try Cacomptes.Current.Selected = True
      Cacomptes.SetFocus
    Endif
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub cacomptes_keyPress()

  If Key.code = Key.F10 Or If key.code = key.Esc Then
    Cacomptes.Clear
    Cacomptes.Visible = False
    Inpm.SetFocus
  Endif
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Bacompte.Text = Cacomptes.Item[3]
    Cacomptes.Clear
    Cacomptes.Visible = False
    Bacompte.visible = True
    Bacompte.SetFocus
    Bacompte.Select
    Zone = "Bacompte"
  Endif

End

Public Sub Bacompte_KeyPress()

  If key.code = Key.F10 Or key.code = Key.esc Then
    init_paiement()
    inpm.SetFocus()
  Endif
  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  ChkPrx()
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Valid_Bacompte()
  Endif
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Valid_Bacompte()

  If Not IsNull(Bacompte.text) Then
    Bacompte.Text = Utils.cpoint(Bacompte.Text)
    If Val(Bacompte.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Bacompte.SetFocus
      Bacompte.Select
      Zone = "Bacompte"
    Else
      If Val(Bacompte.Text) <> 0 And Val(Rticket.Text) > 0 Then
        Bacompte.Text = Format$(Val(Bacompte.Text), "0.00")
        Calc_reste(Bacompte.text)
        Try ColumnView1.Add("RA", "RA")
        If Not Error Then
          ColumnView1.Item[0] = "RA"
          ColumnView1.Item[1] = "acompte " & sIacompte
          ColumnView1.Item[2] = Bacompte.Text
        Else
          ColumnView1.MoveFirst()
          Repeat
            If ColumnView1.Item[0] = "RA" Then
              ColumnView1.Item[2] = Format$(Val(Utils.cpoint(ColumnView1.Item[3])) + Val(Utils.cpoint(Bacompte.Text)), "0.00")
              Break
            Endif
          Until ColumnView1.MoveNext()
        Endif
        Bacompte.Clear
        Bacompte.Visible = False
        If Val(Rticket.Text) = 0 Then
          Aff_bastk()
          Bacompte.Visible = False
          Ouv_Tiroir()
          pointsF()
          Button15.SetFocus
        Else
          Inpm.SetFocus
        Endif
      Endif
    Endif
  Endif

End

Public Sub Cacomptes_Click()

  If Val(Utils.cpoint(TotalTk.text)) < Val(Utils.cpoint(Cacomptes.Item[3])) Then
    Message.Warning("Attention ! Vous ne pouvez pas saisir un\nacompte supérieur au montant du ticket !")
    Cacomptes.Clear
    Cacomptes.Visible = False
  Else
    slinda = Cacomptes.Item[0]
    Bacompte.Text = Cacomptes.Item[3]
    sIacompte = Cacomptes.Item[2]
    Cacomptes.Clear
    Cacomptes.Visible = False
    Bacompte.visible = True
    Bacompte.SetFocus
    Bacompte.Select
    Zone = "Bacompte"
  Endif

End

'*********************************************On gère les mouvements d'espèces hors vente******************************
'***************************************************
'*     Gestion des entrées / sortie hors vente     *
'***************************************************
Public Sub Btn_EntreeEnc_Click()

  If Clicompte = 1 Then
    Message.Info("Vous ne pouvez pas saisir un mouvement hors vente sur un bon de caisse")
    Return
  Endif
  mdp_admin()
  If GestMdp = 1 Then
    org = "EF3"
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Frame8.visible = True
    Mdp.SetFocus
    Zone = "Mdp"
  Else
    If Frame5.Visible = True Then
      Frame5.Visible = False
    Else
      Frame5.text = "Encaissement Hors vente"
      Frame5.Visible = True
      AcptClicpt.Visible = False
      AcptChClicpt.Visible = False
      MvtHV_Entree.value = True
      Nmc3.SetFocus
      Zone = "Nmc3"
      Frame5.Raise
    Endif
  Endif

End

Public Sub horsven_evkeypress()
  
  If Key.code = Key.Esc Or If Key.code = Key.F1 Or If Key.code = Key.F2 Or If Key.code = Key.F3 Then
    Frame5.Visible = False
    MvtHV_Sortie.Value = True
    AcomptesE.Value = False
    AcptClicpt.Clear
    Nmc3.Clear
    Especes2.Clear
    Cart.SetFocus
    Zone = "Article"
  Endif
  
End


Public Sub MvtHV_Sortie_Click()

  If MvtHV_Sortie.value = True Then
    Frame5.text = "Decaissement Hors vente"
    Nmc3.Text = "Origine: "
    Nmc3.SetFocus
    AcomptesE.Enabled = False
    AcptClicpt.Visible = False
    AcptChClicpt.Visible = False
    AcomptesE.Value = False
    AcptClicpt.Clear
  Endif

End

Public Sub MvtHV_Entree_Click()

  If MvtHV_Entree.value = True Then
    Frame5.text = "Encaissement Hors vente"
    Nmc3.SetFocus
    AcomptesE.Enabled = True
    If AcomptesE.Value = True Then
      AcptClicpt.Visible = True
      AcptChClicpt.Visible = True
    Else
      AcptClicpt.Clear
      Nmc3.Text = "Origine: "
    Endif
  Endif

End


Public Sub AcomptesE_Click()

  If AcomptesE.Enabled Then
    If AcomptesE.Value = True Then
      Frame5.text = "Acompte recu en caisse"
      Nmc3.Text = "Acompte recu de "
      AcptClicpt.Visible = True
      AcptChClicpt.Visible = True
      AcptClicpt.SetFocus
    Else
      Frame5.text = "Encaissement Hors vente"
      Nmc3.Text = "Origine: "
      AcptClicpt.Visible = False
      AcptChClicpt.Visible = False
      AcptClicpt.Clear
    Endif
    MvtHV_Entree.value = True
    MvtHV_Sortie.value = False
  Else
    AcomptesE.Value = False
    MvtHV_Entree.value = False
    AcptClicpt.Visible = False
    AcptChClicpt.Visible = False
    MvtHV_Sortie.value = True
    AcptClicpt.Clear
  Endif

End

Public Sub AcptChClicpt_Click()
  
  Dim hForm As Triclients
  Dim rResult As Result
  
  hForm = New Triclients("Caisse")
  hForm.Showmodal()
  If Bsel = True Then
    rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", Clicode)
    If rResult.Available Then
      AcptClicpt.Text = Clicode
      Nmc3.Text = "Acompte recu de " & rResult!cli_nom & " " & rResult!cli_pnm
      Zone = "Especes2"
      Especes2.SetFocus
      'On restaure alors le compte client caisse
      Clicode = CodeclientDefault
    Endif
  Endif
  
End


Public Sub AcptClicpt_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Nmc3.SetFocus
    Zone = "Nmc3"
    Stop Event
  Endif
  horsven_evkeypress()

End

Public Sub Nmc3_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Or If Key.Code = Key.Tab Then
    Especes2.SetFocus
    Zone = "Especes2"
    Stop Event
  Endif
  horsven_evkeypress()

End

Public Sub Especes2_GotFocus()

  $saisie = ""
  Zone = "Especes2"

End

Public Sub Especes2_KeyPress()

  ChkPrx(1) 'la valeur doit etre forcement positive car en cas de sortie hors vente un "-" sera ajouté
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Btn_Valid_HorsEnc.SetFocus
    Stop Event
  Endif
  horsven_evkeypress()

End

Public Sub Btn_Valid_HorsEnc_KeyPress()

  Btn_Valid_HorsEnc_Click()

End

Public Sub Btn_Valid_HorsEnc_Click()

  Mvt_HorsEnc(MvtHV_Entree.Value)

End

Public Sub Mvt_HorsEnc(Enc As Boolean)

  If Not IsNull(Especes2.text) Then
    Especes2.Text = Utils.cpoint(Especes2.Text)
    If Val(Especes2.Text) = Null Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Especes2.SetFocus
      Especes2.Select
      Zone = "Especes2"
    Else
      
      If Nmc3.Text = "" Then
        Message.Error("Vous devez saisir un libelle aux mouvements hors vente!")
      Else
        Especes2.Text = Format$(Val(Especes2.Text), "0.00")
        Frame5.Visible = False
        HBox5.visible = True
        AcomptesE.Visible = True
        Valid_HorsVte(AcomptesE.Value, Enc, Nmc3.Text, AcptClicpt.Text)
      Endif
      
    Endif
  Endif

End

'*****************************************
'*   Gestion de la recherche en caisse   *
'*****************************************
Public Sub Btn_Find_Click()

  Message.Info("Non implementé")

End

'**********************************************
'*    On imprime le mouvement d'espèces       *
'**********************************************

' Public Sub Imp_Especes(tpesp As String)
' 
'   Dim Posx As Integer
'   Dim Posy As Integer
'   Dim Filename As String
'   Dim Tpe As String
'   Dim Tpe2 As String
'   Dim Tpe3 As String
'   Dim sline As String
' 
'   Filename = User.home & "/Ticket.pdf"
'   If Imprimante = "DéfautA4" Then
'     pdf = New Cfacture("P", "mm", "A4")
'   Else
'     If Imprimante = "Défaut80" Then
'       pdf = New Cfacture("P", "mm", "80mm")
'     Endif
'   Endif
'   pdf.Open()
'   pdf.AliasNbPages()
'   pdf.newPage()
'   Posy = 4
'   If Mvt = "E" Then
'     If TypEnc = "E" Then
'       If AcomptesE.Value = True Then
'         Tpe = "Acompte en espèces "
'       Else
'         Tpe = "Hors vente en espèces "
'       Endif
'       tpesp = "G"
'     Endif
'     If TypEnc = "C" Then
'       If AcomptesE.Value = True Then
'         Tpe = "Acompte par carte "
'       Else
'         Tpe = "Hors vente par carte "
'       Endif
'       tpesp = "P"
'     Endif
'     If TypEnc = "H" Then
'       If AcomptesE.Value = True Then
'         Tpe = "Acompte en Chèque "
'       Else
'         Tpe = "Hors vente par chèque "
'       Endif
'       tpesp = "H"
'     Endif
'   Else
'     If tpesp = "S" Then
'       Tpe = "Sortie espèces "
'       tpesp = "F"
'     Endif
'   Endif
'   If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Then
'     For Each sline In Split(Entete.Text, "\n")
'       If Left$(sline, 6) = "Ticket" Then Break
'       pdf.Entete(sline, Posx, Posy, "B", "")
'       Posy += 5
'     Next
'     Posy += 3
'     pdf.Level2("Caisse No " & Ncaisse & " " & Tpe & " le " & Format$(Now, "dd-mm-yyyy  hh-nn"), "", "", Posy)
'     Posy += 8
'     pdf.Lines2(Posy)
'     posy += 8
'     pdf.Level2(Nmc3.text & " " & Format$(Val(utils.cpoint(Especes2.text)), "0.00"), "", "", Posy)
'     Posy += 8
'     pdf.Lines2(Posy)
'     pdf.Output(Filename, False)
'     Impression.Ticket(Filename, "1")
'   Else
'     If Left$(Imprimante, 4) = "/dev" Then
'       Entete_Tck("")
'       'Print #Sport, "Ticket No " & Ntk & Space$(35) & datetk
'       Tpe = Utils.Replace(tpe)
'       Print #Sport, Pointille
'       If Len(tpe) > 26 Then
'         tpe2 = Left$(tpe, 23)
'         tpe3 = Mid$(tpe, Len(tpe2) + 2, Len(tpe) - Len(tpe2))
'       Endif
'       If tpesp = "F" Then
'         Print #Sport, "Caisse No " & Ncaisse & " " & tpe
'         Print #Sport, " le " & Format$(Now, "dd-mm-yyyy  hh-nn")
'       Else
'         If Len(tpe) <= 26 Then
'           Print #Sport, "Caisse No " & Ncaisse & " " & Tpe & " le " & Format$(Now, "dd-mm-yyyy  hh-nn")
'         Else
'           Print #Sport, "Caisse No " & Ncaisse & " " & Tpe2
'           Print #Sport, Tpe3 & " le " & Format$(Now, "dd-mm-yyyy  hh-nn")
'         Endif
'       Endif
'       Print #Sport, Nmc3.text & " " & Format$(Val(utils.cpoint(Especes2.text)), "0.00")
'       Print #Sport, Pointille
'       Print #Sport, " "
'       Print #Sport, " "
'       'Entete_Tck("1")
'       Ouv_Tiroir()
'     Endif
'   Endif
'   Maj_Mespeces(Nmc3.text, tpesp, Especes2.Text, "1")
'   If AcomptesE.Value = True Then Maj_Acomptes(Nmc3.text, tpesp, Especes2.Text, tpe)
'   Especes2.Clear
'   Nmc3.Clear
'   Mvt = ""
'   TypEnc = ""
'   Frame2.Visible = False
'   HBox5.visible = True
'   AcomptesE.Visible = True
'   Cart.SetFocus
'   Zone = "Article"
' 
' End

' Public Sub Maj_Mespeces(intitule As String, Reg As String, smnt As String, sqte As String)
' 
'   Dim TabReglt As String
' 
'   TabReglt = "Fiches_Reglts" & Ncaisse
'   Utils.db.Exec("INSERT INTO " & TabReglt & " (intitule, type, montant, qte, date) VALUES (&1, &2, &3, &4, &5)", Intitule, Reg, smnt, sqte, Format$(Now, "dd-mm-yyyy"))
' 
' End

Public Sub Maj_Acomptes(intitule As String, smnt As String, libelac As String)

  Dim rJnl As Result
  Dim CptCaisse As String

  With Utils
    'TODO à deplacer au moulinage a partir de la ligne du ticket
    
    'On recupère les données pour la trésorerie.(journal et comptes de virement interne)
    'rJnl = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & " ")
    'If rJnl.Available Then
    '  Jour = rJnl!jrnal2
    'Endif
    'numecr = "numecriture"
    'numr = Ecritures(numecr)
    'numr = numr + 1
    'numecr = "numecriture2"
    'numr2 = Ecritures(numecr)
    'numr2 = numr2 + 1
    ' on met à jour la table des acomptes
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabAcomptes") & " (intitule, type, montant, date) VALUES (&1, &2, &3, &4)", Left$(Intitule, 35), Left$(libelac, 15), Val(.cpoint(smnt)), Format$(Now, "yyyy-mm-dd"))

    'On met à jour la trésorerie
    'rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabJour") & " where code_jo = &1", jour)
    'CptCaisse = rResult!cde_banque
    'Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour, numero, compte, intitule, dte, numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jour, numr, clicode, "Acompte en Caisse", Format$(Now, "yyyy-mm-dd"), Ntk, Ntk, libelac, 0, Val(.cpoint(smnt)), 1, 0, 1, 0, 1, Format$(Now, "yyyy-mm-dd"), numr2)
    'Sha1Calc.CalcSha1("Fiches_Mvt", numr)
    'maj_solde(clicode, sMnt)
    'Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jour, numr, Clicaisse, "Acompte en Caisse", Format$(Now, "yyyy-mm-dd"), Ntk, Ntk, libelac, Val(.cpoint(smnt)), 0, 1, 0, 1, 0, 1, Format$(Now, "yyyy-mm-dd"), numr2)
    'Sha1Calc.CalcSha1("Fiches_Mvt", numr)
    'maj_solde(CptCaisse, sMnt)
    'Maj_Collectif(clicode, Clicaisse, libelac, smnt)
    ' On met à jour le numéro d'écriture
    'Utils.db.Exec("UPDATE " & Cbase.Table("TabParam") & " set numecriture = &1, numecriture2 = &2", numr, numr2)
  End With

End

' On met à jour le collectif
' Public Sub Maj_Collectif(Cpt As String, intit As String, libelac As String, Mnt As String)
' 
'   Dim Coll As String
'   Dim cResult As Result
' 
'   With Utils
'     cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpt)
'     coll = cResult!coll_cc
'     Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour, numero, compte, collectif, intitule, dte, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef, numdoc, numlot) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19})", Jour, numr, coll, 1, Intit, Format$(Now, "yyyy-mm-dd"), Libelac, 0, Val(.cpoint(mnt)), 1, 0, 1, 0, 0, 1, 0, numr2, Ntk, Ntk)
'     maj_solde(coll, Mnt)
'   End With
' 
' End

' On met à jour le solde des comptes
' Public Sub maj_solde(Coll As String, Mnt As String)
' 
'   Dim cResult As Result
'   Dim Sld As Float
' 
'   With utils
'     cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
'     If cResult!solde = "" Then
'       Sld = Val(.cpoint(mnt))
'     Else
'       Sld = cResult!solde + Val(.cpoint(mnt))
'     Endif
'     Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
'   End With
' 
' End
' 
' '*****************************************************
' '*  Récuperation du dernier numéro d'écriture        *
' '*****************************************************
' Public Function Ecritures(dernumecr As String) As String
' 
'   Dim Params As Result
'   Dim nro As String
' 
'   Params = Utils.db.Exec("SELECT " & dernumecr & " FROM " & Cbase.Table("TabParam") & " ")
'   If Params.Available Then
'     If IsNull(Params["" & numecr & ""]) Then
'       nro = 0
'     Else
'       nro = Params["" & numecr & ""]
'     Endif
'   Endif
'   Return nro
' 
' End

'****************************************Fin de la gestion des mouvements d'espèces hors vente******************************

'*****************************************
'*      Gestion du fond de caisse        *
'*****************************************
Public Sub button21_Click()

  hForm2 = New Fondcaisse
  hForm2.Showmodal()

End

'*****************************************
'*        on imprime le ticket           *
'*****************************************
Public Sub button15_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then Button15_Click()
  If Key.code = key.F7 Or If key.code = key.Esc Then
    If ColumnView1.count = 0 And bmodifregl = False Then
      Init_Reg()
    Else
      If message.Question("Attention ! Un réglement a été saisi. Sortir de la saisie des réglements va supprimer le ticket.\nVoulez-vous supprimer le ticket?", "Oui", "Non") = 1 Then
        Button9_Click()
        Init_Reg()
      Else
        Return
      Endif
    Endif
  Endif

End

Public Sub Button15_Click()

  If bmodifregl = True And (Val(Mticket.Text) <> 0 Or Val(Rticket.Text) <> 0) Then
    Message.Warning("Un ticket de modification de règlement doit avoir un solde à zero!")
    Return
  Endif
  If iavoir = 1 Then
    If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Then
      Defaut_Tk()
    Else
      Serial_Tk()
    Endif
  Else
    If Clicompte = 1 And clicode <> CodeclientDefault And LigTk.count > 0 Then
      'IF NOT IsNull(clicode) THEN
      'rcli = Utils.db.Exec(" select * from " & Cbase.Table("TabCli") & " where cli_code = &1", clicode)
      'Entetcli = rcli!cli_rs_soc & " " & rcli!cli_nom & " " & rcli!cli_pnm & "\n" & rcli!cli_adr1 & "\n" & rcli!cli_adr2 & "\n" & rcli!cli_cd_ptl & " " & rcli!cli_ville & "\n"
      'ENDIF
      Defaut_Tk()
      '$iSpc.clear
      '$iSpc2.Clear
      'impressionbon(clicode)
    Else
      If Abs(Val(Utils.cpoint(Rticket.Text))) = 0 And LigTk.count > 0 Or If TextLabel5.text = "A rendre :" Then
        'Aff_bastk()
        If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Then
          Defaut_Tk()
        Else
          Serial_Tk()
        Endif
      Else
        If Start.son Then
          If Start.son Then
            Music.Play
          Endif
        Endif
        Try Message.Error("Impression de ticket impossible ! \n Le solde est différent de zéro.")
      Endif
    Endif
  Endif

End

Public Sub Button37_Click()

  If Clicompte = 1 And If LigTk.count > 0 Then
    Defaut_Tk()
  Else
    If ((Abs(Val(Utils.cpoint(Rticket.Text))) = 0) Or TextLabel5.text = "A rendre :") And If LigTk.count > 0 And ColumnView1.Count > 0 Then
      If ecole = False Then
        If IsNull($depot) Then
          Maj_Quantite()
        Else
          Maj_QteDep()
        Endif
      Endif
      Enrg_Tk(False)
      'Entete_Tck("1")
      Tottva = 0
      Totalht = 0
      Aff_viseur(Txtvis)
      'ClavFam()
    Else
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Try Message.Error("Sortie de ticket impossible ! \n Ticket vide ou solde différent de zéro.")
    Endif
  Endif

End

Public Sub button37_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then Button37_Click()
  If Key.code = key.F7 Or If key.code = key.Esc Then
    If ColumnView1.count = 0 Then
      Init_Reg()
    Else
      If message.Question("Attention ! Un réglement a été saisi. Sortir de la saisie des réglements va supprimer le ticket.\nQue voulez-vous faire ?\n 1- Continuer la saisie et modifier les règlements,\n 2- Sortir et supprimer le ticket.", "1 ", "2 ") = 1 Then
        Return
      Else
        Button9_Click()
        Init_Reg()
      Endif
    Endif
  Endif

End

Public Sub Entete_Tck(origine As String)

  Dim ispc As Integer = 0 'Compteur des lignes d'entete
  Dim sline As String
  Dim i As Integer
  Dim Ent As New String[]

  With Utils
    If Left$(Imprimante, 4) = "/dev" Then
      If TypeImp = "6000III" Then
        'If origine = "1" Then Print #sport, Chr$(&H1D) & "V" & Chr$(66) & Chr$(0); ' on coupe le papier
        Print #Sport, Chr$(&H1B) & "c0" & Chr$(2)
        Print #Sport, Chr$(&H1B) & "a" & Chr$(1); 'on centre l 'entete
        For Each sline In Split(Entete.Text, "\n")
          Ent.Add(sline)
        Next
        For i = 0 To Ent.Count - 3
          If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(24); 'on imprime en double hauteur la premiere ligne d 'entete
          Print #Sport, .Replace(Ent[i])
          If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(4); 'on remet le caractere normal
          Inc ispc
        Next
        ispc = 0
        Print #Sport, Chr$(&H1B) & "a" & Chr$(0); ' On remet la justification a gauche
      Endif
      If TypeImp = "Tmu950" Then
        For i = 1 To 2
          If i = 1 Then
            Print #Sport, Chr$(&H1B) & "c0" & Chr$(2); 'On active "receipt"
          Else
            Print #Sport, Chr$(&H1B) & "c0" & Chr$(1); 'On active "journal"
          Endif
          Print #Sport, Chr$(&H1B) & "a" & Chr$(1); 'on centre l 'entete
          For Each sline In Split(Entete.Text, "\n")
            If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(17); 'on imprime en double hauteur la premiere ligne d 'entete
            If ispc = 8 And i = 1 And origine = "1" Then Print #sport, Chr$(&H1B) & "m"; ' on coupe le papier
            Print #Sport, .Replace(sline)
            If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(1); 'on remet le caractere normal
            Inc ispc
          Next
          ispc = 0
        Next
        Print #Sport, Chr$(&H1B) & "a" & Chr$(0); ' On remet la justification a gauche
      Endif
    Endif
  End With

End

Public Sub Serial_Tk()

  With Utils
    If ColumnView1.Count > 0 Or iavoir = 1 Or If clicompte = 1 Then
      Entete_Tck("1")
      If TypeImp = "6000III" Then
        'Print #Sport, "Ticket No " & Ntk & Space$(3) & datetk
        imp_ligtk()
      Endif
      If TypeImp = "Tmu950" Then
        Print #Sport, "Ticket No " & Ntk & Space$(3) & datetk.LT
        imp_ligtk2()
      Endif
      If Bcheque = True Then
        If Message.Question("Voulez-vous imprimer le chèque ?", "Oui", "Non") = 1 Then
          Imp_Cheque()
        Endif
        Bcheque = False
      Endif
      If ecole = False Then
        If IsNull($depot) Then
          Maj_Quantite()
        Else
          Maj_QteDep()
        Endif
      Endif
      Enrg_Tk(False)
      'Entete_Tck("1")
      Tottva = 0
      Totalht = 0
      Print #sport, Chr$(&H1D) & "V" & Chr$(66) & Chr$(0); ' on coupe le papier
      Aff_viseur(Txtvis)
      'ClavFam()
    Else
      Frame2.Visible = False
      'ClavFam()
      Cart.SetFocus
      Zone = "Article"
    Endif
  End With

End

Public Sub imp_ligtk()

  Dim Lignes As Integer = 0
  Dim $Ligne As String

  LigTk.MoveFirst()
  Print #Sport, "Ticket No " & Ntk & Space$(3) & datetk.LT
  Print #Sport, " "
  'On imprime les coordonnées du compte si client compte
  If clicompte = 1 Then
    Print #Sport, "Bon de caisse ", clicode & " " & Utils.Replace(clinom) & " " & Utils.Replace(clipnm)
    Print #Sport, "Bon chiffre au prix public TTC"
  Endif
  'On imprime le numéro de carte si c'est une carte
  If Left$(Bdc.text, 5) = "Carte" Then
    Print #Sport, Bdc.Text
  Endif
  Repeat
    LigTk.Item.Selected = True
    Inc Lignes
    If LigTk.Item[5] = "K" Then
      Print #Sport, Chr$(&H1B) & "a" & Chr$(1); 'on centre la ligne
    Endif
    If Left$(LigTk.Item[2], 3) = "---" Then
      Print #Sport, Pointille;
    Else
      If LigTk.Item[5] = "K" Then
        Print #Sport, Utils.Replace(Left$(LigTk.Item[2], 50))
      Else
        If LigTk.Item[5] <> "MT" Then
          $Ligne = Left$(LigTk.Item[2], 23)
          $Ligne = $Ligne & String$(23 - Len($Ligne), " ")
        Else
          $Ligne = LigTk.Item[2]
        Endif
        Print #Sport, Utils.Replace($Ligne);
      Endif
    Endif
    If LigTk.Item[5] = "A" Then
      Print #sport, Space$(9 - Len(LigTk.Item[3])) & LigTk.Item[3];
    Else
      If LigTk.Item[2] = Space$(15) & "Prix total " Then
        Print #sport, Format$(Val(utils.CPoint(LigTk.Item[3])), "0.00");
      Else
        Print #sport, Space$(9 - Len(LigTk.Item[3])) & LigTk.Item[3];
      Endif
    Endif
    Print #sport, Space$(9 - Len(LigTk.Item[4])) & LigTk.Item[4]
  Until LigTk.MoveNext()
  Print #Sport, Chr$(&H1B) & "a" & Chr$(0); ' On remet la justification a gauche
  Print #sport, Chr$(13); Chr$(10);

End

Public Sub imp_ligtk2()

  Dim i As Integer
  Dim Lignes As Integer = 0
  Dim $Ligne As String

  With Utils
    For i = 1 To 2
      If i = 1 Then
        Print #Sport, Chr$(&H1B) & "c0" & Chr$(2);
      Else
        Print #Sport, Chr$(&H1B) & "c0" & Chr$(1);
      Endif
      LigTk.MoveFirst()
      If clicompte = 1 Then
        Print #Sport, "Bon de caisse ", clicode & " " & .Remplace(clinom) & " " & .Remplace(clipnm)
        Print #Sport, "Bon chiffre au prix public TTC"
      Endif
      Repeat
        LigTk.Item.Selected = True
        Inc Lignes
        If LigTk.Item[5] = "K" Then
          Print #Sport, Chr$(&H1B) & "a" & Chr$(1); 'on centre la ligne
        Endif
        If Left$(LigTk.Item[2], 3) = "---" Then
          Print #Sport, Pointille;
        Else
          If Lignes < LigTk.count Then
            $Ligne = .Replace(Left$(LigTk.Item[2], 21))
            $Ligne = $Ligne & String$(21 - Len($Ligne), " ")
            Print #Sport, $Ligne;
          Else
            Print #Sport, .Replace(Left$(LigTk.Item[2], 40));
          Endif
        Endif
        Print #sport, Space$(9 - Len(LigTk.Item[3])) & LigTk.Item[3];
        Print #sport, Space$(9 - Len(LigTk.Item[4])) & LigTk.Item[4]
      Until LigTk.MoveNext()
      Print #Sport, Chr$(&H1B) & "a" & Chr$(0); ' On remet la justification a gauche
      Print #sport, Chr$(13); Chr$(10);
    Next
  End With

End

Public Sub Imp_Cheque()

  Dim sEntier As String
  Dim sDizaine As String
  Dim sline As String
  Dim ipos As Integer
  Dim dbline As Integer = 0
  Dim nb As Integer
  Dim $Monnaie As String = " Euros "
  Dim $Centimes As String = " centimes"

  With Utils
    If Typeimp = "6000III" Then
      Nb = 60
      Print #Sport, Chr$(&H1B); "c0"; Chr$(4);
      Print #Sport, Chr$(&H1B) & "!" & Chr$(4);
    Endif
    If Typeimp = "Tmu950" Then
      nb = 70
      Wait 1
      Print #Sport, Chr$(&H1B) & "c0" & Chr$(4);
    Endif
    sEntier = Cheque.Text
    sDizaine = sEntier
    iPos = InStr(sEntier, ",")
    If ipos <> 0 Then
      sDizaine = Right$(sDizaine, 2)
      sDizaine = numtostring.nbtostring(sDizaine)
    Else
      sDizaine = ""
    Endif
    If ipos <> 0 Then sEntier = Left$(sEntier, iPos - 1)
    sEntier = numtostring.nbtostring(sEntier)
    If Not IsNull(sDizaine) Then
      If Right$(sDizaine, 2) = "un" Then
        sDizaine = Left$(sDizaine, Len(sDizaine) - 2) & "et " & Right$(sDizaine, 2)
        $centimes = " centime"
      Else
        $centimes = " centimes"
      Endif
    Else
      $Centimes = ""
    Endif
    If sEntier = "un" Or If sEntier = "zéro" Then $Monnaie = " Euro "
    sEntier = sEntier & $Monnaie & sDizaine & $centimes
    sDizaine = ""
    Print #Sport, Chr$(&H1B); "c0"; Chr$(4);
    Print #Sport, Space$(1)
    Print #Sport, Space$(1)
    Print #Sport, Space$(1)
    For Each sline In Split(sEntier, " ")
      If Len(sDizaine) + Len(sline) > 75 Then
        Print #sport, sDizaine
        sDizaine = ""
        sDizaine = sline & " "
      Else
        sDizaine = sDizaine & sline & " "
        dbline = 1
      Endif
    Next
    If Len(sEntier) < 75 Then dbline = 0
    If dbline = 0 Then
      Print #sport, sDizaine
    Else
      Print #sport, sDizaine
    Endif
    If Len(sEntier) < 75 Then
      Print #Sport, Space$(1)
    Endif
    Print #Sport, Space$(1)
    Print #sport, .Replace(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ordre"]);
    Print #sport, Space$(nb) & Cheque.Text
    Print #Sport, Space$(1)
    Print #sport, Space$(nb) & .Replace(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/lieu"])
    Print #sport, Space$(nb) & Format$(Now, "dd.mm.yyyy")
    Print #Sport, Chr$(&HC);
  End With
  Bcheque = False

End

Public Sub Imp_Cheque1()

  Dim sEntier As String
  Dim sDizaine As String
  Dim sline As String
  Dim ipos As Integer
  Dim dbline As Integer = 0
  Dim nb As Integer
  Dim $Monnaie As String = " Euros "
  Dim $Centimes As String = " centimes"

  With Utils
    If Typeimp = "6000III" Then
      Nb = 60
      Print #Sport, Chr$(&H1B); "c0"; Chr$(4);
      Print #Sport, Chr$(&H1B) & "!" & Chr$(4);
    Endif
    If Typeimp = "Tmu950" Then
      nb = 70
      Wait 1
      Print #Sport, Chr$(&H1B) & "c0" & Chr$(4);
    Endif
    LigTk.MoveFirst()
    Repeat
      LigTk.Item.Selected = True
      If Right$(LigTk.Item[5], 1) = "V" Then
        sEntier = LigTk.Item[3]
        sDizaine = sEntier
        iPos = InStr(sEntier, ",")
        If ipos <> 0 Then
          sDizaine = Right$(sDizaine, 2)
          sDizaine = numtostring.nbtostring(sDizaine)
        Else
          sDizaine = ""
        Endif
        If ipos <> 0 Then sEntier = Left$(sEntier, iPos - 1)
        sEntier = numtostring.nbtostring(sEntier)
        If Not IsNull(sDizaine) Then
          If Right$(sDizaine, 2) = "un" Then
            sDizaine = Left$(sDizaine, Len(sDizaine) - 2) & "et " & Right$(sDizaine, 2)
            $centimes = " centime"
          Else
            $centimes = " centimes"
          Endif
        Else
          $Centimes = ""
        Endif
        If sEntier = "un" Or If sEntier = "zéro" Then $Monnaie = " Euro "
        sEntier = sEntier & $Monnaie & sDizaine & $centimes
        sDizaine = ""
        Print #Sport, Chr$(&H1B); "c0"; Chr$(4);
        Print #Sport, Space$(1)
        Print #Sport, Space$(1)
        Print #Sport, Space$(1)
        For Each sline In Split(sEntier, " ")
          If Len(sDizaine) + Len(sline) > 75 Then
            Print #sport, sDizaine
            sDizaine = ""
            sDizaine = sline & " "
          Else
            sDizaine = sDizaine & sline & " "
            dbline = 1
          Endif
        Next
        If Len(sEntier) < 75 Then dbline = 0
        If dbline = 0 Then
          Print #sport, sDizaine
        Else
          Print #sport, sDizaine
        Endif
        If Len(sEntier) < 75 Then
          Print #Sport, Space$(1)
        Endif
        Print #Sport, Space$(1)
        Print #sport, .Replace(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ordre"]);
        Print #sport, Space$(nb) & LigTk.Item[3]
        Print #Sport, Space$(1)
        Print #sport, Space$(nb) & .Replace(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/lieu"])
        Print #sport, Space$(nb) & Format$(Now, "dd.mm.yyyy")
        Print #Sport, Chr$(&HC);
        Break
      Endif
    Until LigTk.MoveNext()
  End With
  Bcheque = False

End

Public Sub Defaut_Tk()

  Dim Posy As Integer
  Dim Filename As String
  Dim sline As String
  Dim i As Integer
  Dim rcli As Result

  If ColumnView1.Count > 0 Or iavoir = 1 Or clicompte = 1 Then
    Filename = User.home & "/Ticket.pdf"
    If Imprimante = "DéfautA4" Then
      pdf = New Cfacture("P", "mm", "A4")
      Ba4 = True
    Else
      If Imprimante = "Défaut80" Then
        pdf = New Cfacture("P", "mm", "80mm")
        Ba4 = False
      Endif
    Endif
    pdf.Open()
    pdf.AliasNbPages()
    pdf.newPage()
    Posy = 12
    For Each sline In Split(Entete.Text, "\n")
      If i < 2 Then
        pdf.Entete2(sline, 4, Posy, "B", Ba4)
      Else
        If i = 9 Then
          pdf.Entete(sline, 4, Posy, "", Ba4)
        Else
          If i <> 8 Then pdf.Entete2(sline, 4, Posy, "", Ba4)
        Endif
      Endif
      Posy += 5
      Inc i
    Next
    pdf.Logo2("tk", Ba4) 'On imprime le logo
    'on imprime la ligne de bon si c'est un bon de caisse.
    If clicompte = 1 Then
      rcli = Utils.db.Exec(" select * from " & Cbase.Table("TabCli") & " where cli_code = &1", clicode)
      Entetcli = rcli!cli_rs_soc & " " & rcli!cli_nom & "\n" & rcli!cli_pnm & "\n" & rcli!cli_adr1 & "\n" & rcli!cli_adr2 & "\n" & rcli!cli_cd_ptl & "\n" & rcli!cli_ville & "\n"
      Posy = 18
      i = 1
      For Each sline In Split(Entetcli, "\n")
        If i <= 2 Then
          pdf.Entete3(sline, Posy, "B", Ba4)
        Else
          pdf.Entete3(sline, Posy, "", Ba4)
        Endif
        Posy += 5
        Inc i
      Next
      If Ba4 Then
        PosY = 75
      Else
        Posy = 68
      Endif
      pdf.Com("Bon de caisse " & clicode & " " & clinom & " " & clipnm, Posy)
      Posy += 5
      pdf.Com("Les prix mentionnés sont les prix public TTC", Posy)
      Posy += 8
    Endif
    'On imprime le numéro de carte si c'est une carte
    If Left$(Bdc.text, 5) = "Carte" Then
      pdf.Com(Bdc.Text, Posy)
      Posy += 5
    Endif
    Posy += 3
    pdf.Level2T(4, posy)
    Posy += 8
    LigTk.MoveFirst()
    Repeat
      LigTk.Item.Selected = True
      pdf.Level1(LigTk.Item[1], LigTk.Item[2], LigTk.Item[3], LigTk.Item[4], 4, Posy, LigTk.Item[5])
      Posy += 4
    Until LigTk.MoveNext()
    pdf.Output(Filename, False)
    If Clicompte = "1" Then
      Impression.Ticket(Filename, Nbf)
    Else
      Impression.Ticket(Filename, "1")
    Endif
    If ecole = False Then
      If IsNull($depot) Then
        Maj_Quantite()
      Else
        Maj_QteDep()
      Endif
    Endif
    Enrg_Tk(False)
    Tottva = 0
    Totalht = 0
    'ClavFam()
  Else
    Frame2.Visible = False
    'ClavFam()
    Cart.SetFocus
    Zone = "Article"
  Endif

End

'********************************** Initialisation des ports *********************************************
Public Sub Init_sport()

  If Sport.Status = Net.Active Then Close Sport
  Sport.PortName = Imprimante
  If Typeimp = "Tmu950"
    Sport.Speed = "9600"
  Else
    Sport.Speed = "19200"
  Endif
  Sport.Parity = 0
  Sport.DataBits = 8
  Sport.StopBits = 1
  Sport.FlowControl = 0
  Try Sport.Open()
  Try Print #Sport, Chr$(&H1B) & "@"; 'On initialise l'imprimante.
  Try Print #Sport, Chr$(&H1B) & "t" & Chr$(2); 'Character code table
  Try Print #Sport, Chr$(&H1B) & "R" & Chr$(1); 'International character set
  If Error Then
    Message.Warning("Ouverture du port imprimante " & Sport.PortName & " impossible !\nVérifiez vos connexions SVP !")
    Quit
  Endif

End

'************* gestion du port de la balance éléctronique **************************
Public Sub Init_sport2()

  If Sport2.Status = Net.Active Then Close Sport2
  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Tropper" Then
    Sport2.PortName = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/portb"]
    Sport2.Speed = "9600"
    Sport2.Parity = 0
    Sport2.DataBits = 8
    Sport2.StopBits = 1
    Sport2.FlowControl = 0
  Else If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Mettler Toledo" Then
    Sport2.PortName = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/portb"]
    Sport2.Speed = "9600"
    Sport2.Parity = 0
    Sport2.DataBits = 7
    Sport2.StopBits = 1
    Sport2.FlowControl = 0
  Else If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Precia Molen" Then
    Sport2.PortName = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/portb"]
    Sport2.Speed = "9600"
    Sport2.Parity = 0
    Sport2.DataBits = 8
    Sport2.StopBits = 0
    Sport2.FlowControl = 0
  Endif
  Try Sport2.Open()
  If Error Then Message.Warning("Ouverture du port balance " & Sport2.PortName & " impossible !\nVérifiez vos connexions SVP !")

End

Public Sub SPort2_Read()

  Dim s As String

  Read #Sport2, s, Lof(Sport2)
  Try Qte.text = Format$(Val(Utils.cpoint(Right$(s, 6))), "0.000")

End

Public Sub Recup_Poids()

  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Tropper" Then
    Print #Sport2, "P"; Chr$(13); Chr$(10)
  Else If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Mettler Toledo" Then
    Print #Sport2, "W"; Chr$(13)
  Else If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/Tbalance"] = "Precia Molen" Then
    Print #Sport2, Chr$(1); Chr$(5); Chr$(48); Chr$(51); Chr$(76); Chr$(13); Chr$(10)
  Endif

End

Public Sub Button34_Click()

  If sBalance = True Then
    Recup_Poids()
    Wait 0.3
    SPort2_Read()
    Valid_Qte()
  Endif

End
'********************************** Fin de la gestion des ports *********************************************

'*******************************************************
'*          On gère le mot de passe admin               *
'*******************************************************

Public Sub mdp_admin()

  If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/admin"] = True Then GestMdp = 1

End

Public Sub Mdp_KeyPress()

  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Valid_Mdp()
  Else
    If key.code = key.Esc Or If key.code = key.F6 Then
      Mdp.Clear
      Frame8.visible = False
      Qte.SetFocus
      Qte.select
      Zone = "Qte"
    Endif
  Endif

End

Public Sub Valid_Mdp()

  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabVendeurs") & " where admin = &1", "-1")
  If rResult.Available Then
    For Each rResult
      mdpadmin = hexdblKey.crypt("de", rResult!mdp, "Laurux")
      If mdpadmin = Mdp.Text Then
        admin = 1
        Mdp.Clear
        Frame8.visible = False
        Break
      Endif
    Next
  Else
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Message.Warning("Aucun administrateur n'a été déclaré dans la table des vendeurs !")
    admin = 0
    Mdp.Clear
    Frame8.visible = False
    Cart.SetFocus
    Zone = "Article"
  Endif
  If admin = 0 Then
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Message.Error("Le mot de passe n'est pas valable ! Vérifiez votre saisie SVP !")
    Mdp.Select
    Zone = "Mdp"
  Endif
  If admin = 1 Then
    If Org = "F3" Then modif_Tk()
    If org = "F10" Then suppr_Tk()
    If org = "F11" Then
      iAvoir = 1
      Frame3.Visible = True
      Nmc.SetFocus
    Endif
    If Org = "F2" Then
      Message.Info("Non Implementé")
    Endif
    If Org = "EF3" Then
      'Mvt = "E"
      If Frame2.Visible = True Then
        Frame2.Visible = False
      Else
        Frame2.Visible = True
        Inpm.SetFocus
      Endif
    Endif
    If org = "F6" Then
      irem = 1
      TextLabel7.Visible = True
      Remise.Visible = True
      Remise.SetFocus
      Remise.select
      Zone = "Remise"
    Endif
    If org = "F8" Then
      TextLabel7.Visible = True
      Remise.Visible = True
      RemqShow()
      irem = 1
    Endif
    If org = "CtrlF9" Then
      Frame1.Visible = True
      RemTot.SetFocus
      iremT = 1
      Zone = "Remtot"
    Endif
    If org = "B24" Then
      If Val(Utils.cpoint(TotalTk.Text)) = 0 Then
        Ticketz()
      Else
        Message.Warning("Il y a un ticket en cours ! Bande Z impossible !")
        Cart.setfocus
      Endif
    Endif
    If org = "CtrlF11" Then
      Ouv_Tiroir()
      Cart.SetFocus
      Zone = "Article"
    Endif
    If org = "Credit" Then
      Frame4.visible = True
      icredit = 1
      If icartef = 1 Then Nmc2.Text = Label1.Text
      Nmc2.SetFocus
      Zone = "Nmc2"
    Endif
  Endif

End

'*******************************************************
'*          On initialise les paiements                *
'*******************************************************
Public Sub init_paiement()

  Cheque.Visible = False
  Cheque.Clear
  icheque = 0
  Credit.Visible = False
  Credit.Clear
  icredit = 0
  Carte.Visible = False
  Carte.Clear
  icarte = 0
  Especes.Visible = False
  Especes.Clear
  Breduc.Visible = False
  Breduc.Clear
  Bachat.Visible = False
  Bachat.Clear
  iachat = 0
  Bavoir.Visible = False
  Bavoir.Clear
  iavoir = 0
  Chequecad.Visible = False
  Chequecad.Clear
  ichequecad = 0
  Bonus.Visible = False
  Bonus.Clear
  Bacompte.Clear
  Bacompte.visible = False
  Tresto.Clear
  Tresto.Visible = False
  Nmc2.Clear

End

'*******************************************************
'*      On gère les boutons de l'impression            *
'*******************************************************
Public Sub Inpm_KeyPress()

  If Key.code = key.F1 Then Button11_Click()
  If Key.code = key.F2 Then Button12_Click()
  If Key.code = key.F3 Then Button13_Click()
  If Key.code = key.F4 Then Button14_Click()
  If Key.code = key.F5 Then Button16_Click()
  If Key.code = key.F6 Then Button27_Click()
  If Key.code = key.F8 Then Button18_Click()
  If Key.code = key.F9 Then Button31_Click()
  If Key.code = key.F10 Then Button35_Click()
  If Key.code = key.F11 Then Button36_Click()
  If Key.code = key.F12 Then Button53_Click()
  If Key.code = key.F7 Or If key.code = key.Esc Then
    If ColumnView1.count = 0 And bmodifregl = False Then
      Init_Reg()
    Else
      If message.Question("Attention ! Un réglement a été saisi. Sortir de la saisie des réglements va supprimer le ticket.\nQue voulez-vous faire ?\n 1- Continuer la saisie et modifier les règlements,\n 2- Sortir et supprimer le ticket.", "1 ", "2 ") = 1 Then
        Return
      Else
        Button9_Click()
        Init_Reg()
      Endif
    Endif
  Endif

End

'*******************************************************
'*          On affiche le reste à payer                *
'*******************************************************
Public Sub Calc_reste(Montant As String)

  Rticket.text = Val(Utils.cpoint(Rticket.text)) - Val(Utils.cpoint(Montant))
  Rticket.Text = Format$(Rticket.Text, "0.00")
  If Val(Utils.cpoint(Rticket.Text)) < 0 Then
    TextLabel5.Text = "A rendre :"
    Aff_viseur("A rendre :" & Format$(Abs(Val(Rticket.text)), "#######.00"))
  Else
    TextLabel5.Text = "Reste à payer :"
    Aff_viseur("Reste à payer :" & Format$(Abs(Val(Rticket.text)), "#######.00"))
  Endif

End

'**********************************************************
'*      Creation table temporaire pour totalisation       *
'**********************************************************
Public Sub TabTva()

  Dim Tatva As String = "Tottva"

  Utils.db.Exec("DROP TABLE IF EXISTS  Tottva")
  Utils.db.Exec("CREATE TABLE " & Tatva &
    "(code VarChar(10) NOT NULL," &
    "mtva VarChar(15)," &
    "PRIMARY KEY (code))" & "ENGINE = MYISAM")

End

'*******************************************************
'*          On affiche le bas du ticket                *
'*******************************************************

Public Sub Aff_bastk() As Boolean

  Dim rtva, lBl As Result
  Dim Tatva As String = "Tottva"
  Dim ttva, ttvam As Float = 0
  Dim mttc, mht As Float = 0
  Dim brem, btot As Boolean = False
  Dim $code As String
  Dim bloc As String

  Ligtk.MoveFirst()
  If Ligtk.Count <= 0 Then
    Return False
  Endif
  Mtrem = RemTot.text
  If IsNull(mtrem) Then mtrem = "0"
  Totaltva = 0
  Totalht = 0
  TabTva()
  Repeat
    LigTk.Item.Selected = True
    If Not IsNull(LigTk.Item[10]) Then
      If LigTk.Item[5] = "MT" Then mtrem = 0
      If LigTk.Item[5] <> "T" And If LigTk.Item[5] <> "MT" And If LigTk.Item[5] <> "C" Then
        If LigTk.Item[5] = "A" And If Val(LigTk.Item[0]) <= LigTk.count Then
          'mttc = Val(Utils.cpoint(LigTk.Item[11]))
          mht = Val(Utils.cpoint(LigTk.Item[6]))
          mttc = Val(Utils.cpoint(LigTk.Item[11])) * Abs(Val(Utils.cpoint(LigTk.Item[4])))
          $code = LigTk.Item[10]
          bloc = LigTk.Item[8]
          While Not IsNull(LigTk.Item)
            If LigTk.Item[8] <> bloc Then
              LigTk.MovePrevious() 'on revient sur la dernière ligne du bloc
              Break
            Endif
            If LigTk.Item[5] = "S" Then
              'on applique la remise
              brem = True
              mht = Val(Utils.cpoint(LigTk.Item[6]))
              mttc = Val(Utils.cpoint(LigTk.Item[11])) * Abs(Val(Utils.cpoint(LigTk.Item[4])))
            Else If LigTk.Item[5] = "T" 'total qte
              btot = True
            Else If LigTk.Item[5] = "O" 'eco taxe / copie privé
              'do nothing
            Else If LigTk.Item[5] = "A" 'article lui-meme
              'do nothing
            Else
              Message("Unsupported line: " & LigTk.Item[5], "OK")
            Endif
            Ligtk.MoveNext()
          Wend
        Endif
        
        Totalht = totalht + mht
        ttvam = mttc - mht
        rtva = Utils.db.Exec(" select * from " & Tatva & " where code = &1", $code)
        If Not rtva.Available Then
          If $code <> "" Then
            Utils.db.Exec("INSERT INTO " & Tatva & " (code, mtva) VALUES (&1, &2)", $code, Format$(ttvam, "0.00"))
            totaltva = totaltva + ttvam
          Endif
        Else
          ttva = Val(Utils.cpoint(rtva!mtva)) + ttvam
          totaltva = totaltva + ttvam
          Utils.db.Exec("UPdate  " & Tatva & "  SET mtva = &2 WHERE code = &1", $code, Format$(ttva, "0.00"))
        Endif
      Endif
    Else
      'Hors vente HT = TTC
      If LigTk.Item[5] = "EH" Or LigTk.Item[5] = "SH" Or LigTk.Item[5] = "EA" Then
        Try mht = Val(Utils.cpoint(LigTk.Item[6]))
        Totalht = totalht + mht
      Endif
      'Cas du Règlement des BL depuis la caisse. Il faut recalculer le montant de TVA à partir des lignes
      If LigTk.Item[5] = "BL" Then
        Try mht = Val(Utils.cpoint(LigTk.Item[6]))
        Totalht = totalht + mht
        lBl = Utils.db.Exec(" select * from " & Cbase.Table("TabLigbl") & " where num_ligbl = &1 and typel_ligbl = \"A\"", LigTk.Item[7])
        If lBl.Available Then
          Repeat
            Tva = lBl!tx_ligbl
            Calc_Tva()
            ttvam = Val(Utils.cpoint(lBl!nettc_ligbl)) - Val(Utils.cpoint(lBl!netht_ligbl))
            rtva = Utils.db.Exec(" select * from " & Tatva & " where code = &1", Tva)
            If Not rtva.Available Then
              Utils.db.Exec("INSERT INTO " & Tatva & " (code, mtva) VALUES (&1, &2)", Tva, Format$(ttvam, "0.00"))
              totaltva = totaltva + ttvam
            Else
              ttva = Val(Utils.cpoint(rtva!mtva)) + ttvam
              totaltva = totaltva + ttvam
              Utils.db.Exec("UPdate  " & Tatva & "  SET mtva = &2 WHERE code = &1", Tva, Format$(ttva, "0.00"))
            Endif
          Until lBl.MoveNext()
        Endif
      Endif
    Endif
    brem = False
    btot = False
  Until LigTk.MoveNext()
  Inc iligne
  Inc iNlg
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[1] = ""
  LigTk.Item[2] = Pointille
  LigTk.Item[5] = "L"
  Inc iligne
  Inc iNlg
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[1] = ""
  LigTk.Item[2] = "Total HT  "
  LigTk.Item[3] = Format$(Val(utils.cpoint(Totalht)), "0.00")
  LigTk.Item[11] = LigTk.Item[3]
  LigTk.Item[5] = "BH"
  Inc iligne
  Inc iNlg
  rtva = Utils.db.Exec(" select * from " & Tatva & "")
  Repeat
    If rtva.Available Then
      LigTk.Add(iligne, iligne)
      LigTk.Item[0] = iNlg
      LigTk.Item[1] = ""
      LigTk.Item[2] = "TVA " & rtva!code
      LigTk.Item[3] = Format$(Val(Utils.cpoint(rtva!mtva)), "0.00")
      LigTk.Item[11] = LigTk.Item[3]
      LigTk.Item[5] = "BA"
      Inc iligne
      Inc iNlg
    Endif
  Until rtva.MoveNext()
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[1] = ""
  LigTk.Item[2] = "Total TTC "
  LigTk.Item[3] = Format$(Val(Utils.cpoint(TotalTk.Text)), "0.00")
  LigTk.Item[11] = LigTk.Item[3]
  LigTk.Item[5] = "BC"
  ColumnView1.MoveFirst()
  If iavoir = 0 And If Clicompte = 0 Then
    Repeat
      ColumnView1.Item.Selected = True
      If Val(utils.cpoint(ColumnView1.Item[2])) <> 0 Then
        Inc iligne
        Inc iNlg
        LigTk.Add(ColumnView1.Item[0] & iligne, ColumnView1.Item[0] & iligne)
        LigTk.Item[5] = ColumnView1.Item[0]
        LigTk.Item[0] = iNlg
        LigTk.Item[1] = ""
        LigTk.Item[2] = ColumnView1.Item[1]
        LigTk.Item[3] = ColumnView1.Item[2]
        LigTk.Item[11] = LigTk.Item[3]
        'LigTk.Item[5] = "R" & ColumnView1.Item[0]
      Endif
    Until ColumnView1.MoveNext()
  Else If Clicompte = 1 Then
        Inc iligne
        Inc iNlg
        LigTk.Add(iligne, iligne)
        LigTk.Item[5] = "M"
        LigTk.Item[0] = iNlg
        LigTk.Item[1] = clicode
        LigTk.Item[2] = Clinom & " " & Clipnm
        LigTk.Item[3] = Format$(Val(Utils.cpoint(TotalTk.Text)), "0.00")
        LigTk.Item[11] = LigTk.Item[3]
  Endif
  Inc iligne
  Inc iNlg
  LigTk.Add(iligne, iligne)
  LigTk.Item[0] = iNlg
  LigTk.Item[1] = ""
  Inc iligne
  Inc iNlg
  
  Return True

End

'*********************************************
'*        On enregistre le ticket            *
'*********************************************
Public Sub Enrg_Tk(Supprime As Boolean)

  Dim rLastTk As Result
  Dim rFam As Result
  Dim Fam As String
  Dim snumlig As String ' numero de ligne
  Dim scode As String ' code du produit
  Dim sdesign As String ' libellé de la ligne
  Dim smontant As String 'montant de la ligne ttc
  Dim smontantht As String 'montant de la ligne ht
  Dim sqte As String ' quantité
  Dim stype As String ' type de ligne
  Dim sstatut As Integer = 0 ' si ticket mis en attente
  Dim ssuppr As Integer = 0 ' si ticket est supprime
  Dim sespeces As String
  Dim smespeces As String
  Dim sreduc As String
  Dim smreduc As String
  Dim scarte As String
  Dim smcarte, smcarte2 As String = "0"
  Dim nmcarte As String
  Dim scheque As String
  Dim smcheque, tcheque As String = "0"
  Dim nmcheque As String
  Dim scredit As String
  Dim smcredit As String
  Dim scavoir As String
  Dim smavoir As String
  Dim sacompte As String
  Dim smacompte As String
  Dim sachat As String
  Dim smachat As String
  Dim schequecad As String
  Dim smchequecad As String
  Dim sbonus As String
  Dim smbonus As String
  Dim nmbonus As String
  Dim sresto As String
  Dim smresto As String
  Dim smht As String
  Dim smtva As String
  Dim smttc As String
  Dim smrem As String
  Dim Tab As String
  Dim Tiketx As String
  Dim mntAv As String
  Dim MntFam As String
  Dim QteFam As String
  Dim Totpoint, Totp, Totg As Float = 0
  Dim Esp As Float = 0 'Montant des especes versées
  Dim prev_numero As String
  Dim numero_tk As String
  Dim lasttk_valid As String
  Dim scartef As String

  Datetk = LDate(Now)
  If iRattente = 0 Then
    numero_tk = Ntk
  Else
    numero_tk = numtk
  Endif
  'On recupère le dernier ticket validé dans la table des paramètres
  rLastTk = Utils.db.Exec("Select dntk From " & Cbase.Table("TabParam"))
  If rLastTk.Available Then
    prev_numero = rLastTk!dntk
  Else
    prev_numero = ""
  Endif
  
  Dtck = numero_tk
  Mtrem = RemTot.text
  RemTot.Clear
  If IsNull(mtrem) Then mtrem = "0"
  LigTk.MoveFirst()
  With utils
    'Ticket avec Règlement a enregistrer
    If iAttente = 0 And Supprime = False Then
      Repeat
        LigTk.Item.Selected = True
        If LigTk.Item[5] = "BH" Then smht = LigTk.Item[3]
        If LigTk.Item[5] = "BA" Then smtva = LigTk.Item[3]
        If LigTk.Item[5] = "BC" Then smttc = LigTk.Item[3]
        If Right$(LigTk.Item[5], 1) = "N" Then
          sespeces = "N"
          Esp += Val(utils.cpoint(LigTk.Item[3]))
          smespeces = Esp
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "Q" Then
          Esp -= Val(utils.cpoint(LigTk.Item[3]))
          smespeces = Esp
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "U" Then
          scarte = "U"
          nmcarte = LigTk.Item[2]
          smcarte = LigTk.Item[3]
          sstatut = 0
          smcarte2 = Val(.cpoint(smcarte2)) + Val(.cpoint(smcarte))
        Endif
        If Right$(LigTk.Item[5], 1) = "V" Then
          scheque = "V"
          nmcheque = LigTk.Item[2]
          smcheque = LigTk.Item[3]
          sstatut = 0
          tcheque = Val(.cpoint(tcheque)) + Val(.cpoint(smcheque))
        Endif
        If Right$(LigTk.Item[5], 1) = "W" Then
          scredit = "W"
          smcredit = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "X" Then
          sachat = "X"
          smachat = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "Y" Then
          schequecad = "Y"
          smchequecad = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "Z" Then
          scavoir = "Z"
          smavoir = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "B" Then
          sbonus = "B"
          nmbonus = LigTk.Item[2]
          smbonus = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "E" Then
          sreduc = "E"
          smreduc = LigTk.Item[3]
          sstatut = 0
        Endif
        If Right$(LigTk.Item[5], 1) = "1" Then
          sresto = "1"
          smresto = LigTk.Item[3]
          sstatut = 0
        Endif
        If LigTk.Item[5] = "EA" Then ' pour les acomptes
          sacompte = "D"
          smacompte = LigTk.Item[3]
          Maj_Acomptes(LigTk.Item[2], smacompte, "Caisse")
          sstatut = 0
        Endif
        If LigTk.Item[5] = "RA" Then ' pour les acomptes
          sacompte = "C"
          smacompte = LigTk.Item[3]
          Utils.db.Exec("DELETE FROM  " & Cbase.Table("TabAcomptes") & " WHERE lind = &1", slinda)
          sstatut = 0
        Endif
        If Clicompte = 1 And LigTk.Item[5] = "BC" Then 'On enregistre le montant TTC en compte client
          sstatut = 0
          smttc = LigTk.Item[3]
        Endif
      Until LigTk.MoveNext()
    Else
      'Ticket en Attente
      If iAttente Then sstatut = 1
      'Ticket a supprimer
      If Supprime Then ssuppr = 1
      smht = Totalht
      smtva = Format$(Val(Utils.cpoint(TotalTk.Text)) - Val(Utils.cpoint(Totalht)), "0.00")
      smttc = TotalTk.text
    Endif

    If IsNull(scartef) Then scartef = $Cli
    If Not IsNull($Nomd) Then $Cli = $Nomd

    Tab = "Fiches_LigTicketz"
    'On enregistre toutes les lignes du ticket
    LigTk.MoveFirst()
    Repeat
      LigTk.Item.Selected = True
      snumlig = LigTk.Item[0]
      scode = LigTk.Item[1]
      sdesign = LigTk.Item[2]
      smontant = LigTk.Item[11]
      sqte = LigTk.Item[4]
      stype = LigTk.Item[5]
      If stype = "A" Or stype = "S" Then
        rFam = Utils.db.Exec(" select * from " & Cbase.Table("TabArt") & " where art_code = &1", scode)
        Fam = rFam!art_fam
      Endif
      smontantht = LigTk.Item[6]
      smrem = Utils.cpoint(LigTk.Item[7])
      If IsNull(smrem) Then smrem = 0
      bloc = LigTk.Item[8]

      If stype = "T" Or stype = "BL" Then
        Try smtva = Format$(Val(utils.cpoint(LigTk.Item[9])), "0.00")
      Else
        Try smtva = Format$((Val(utils.cpoint(smontant)) * Abs(Val(Utils.cpoint(sqte)))) - Val(Utils.cpoint(smontantht)), "0.00")
      Endif
      If Error Then smtva = ""

      'On enregistre chaques lignes du ticket
      Utils.db.Exec("INSERT INTO " & Tab & " (numero, numlig, code, intitule, montant, qte, type, fam, mht, mrem, mtva, block, tva, date) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14})", numero_tk, snumlig, Left$(scode, 15), sdesign, smontant, sqte, stype, fam, smontantht, smrem, smtva, LigTk.Item[8], LigTk.Item[10], Datetk.DT)

    Until LigTk.MoveNext()

    'Puis on calcule les totaux
    LigTk.MoveFirst()
    Repeat
      LigTk.Item.Selected = True
      snumlig = LigTk.Item[0]
      scode = LigTk.Item[1]
      sdesign = LigTk.Item[2]
      smontant = LigTk.Item[11]
      sqte = LigTk.Item[4]
      stype = LigTk.Item[5]
      smontantht = LigTk.Item[6]
      smrem = Utils.cpoint(LigTk.Item[7])
      bloc = LigTk.Item[8]
      If stype = "A" Then
        rFam = Utils.db.Exec(" select * from " & Cbase.Table("TabArt") & " where art_code = &1", scode)
        Fam = rFam!art_fam
      Endif
      'Uniquement Ticket avec Règlement dans statistique ticket X/Z
      If iAttente = 0 And Supprime = False Then
        If stype = "A" Then
          If mtrem <> "0" Then smontant = Val(utils.CPoint(smontant)) - (Val(utils.CPoint(smontant)) * Val(utils.CPoint(mtrem)) / 100)
          If mtrem <> "0" Then smontantht = Val(utils.CPoint(smontantht)) - (Val(utils.CPoint(smontantht)) * Val(utils.CPoint(mtrem)) / 100)
          LigTk.MoveNext()
          LigTk.Item.Selected = True
          stype = LigTk.Item[5]
          If stype = "O" Then
            LigTk.MoveNext()
            Try LigTk.Item.Selected = True
            Try stype = LigTk.Item[5]
          Endif
          If stype <> "M" And If stype <> "S" And If stype <> "T" Then
            LigTk.MovePrevious()
            LigTk.Item.Selected = True
            stype = LigTk.Item[5]
          Else
            If stype <> "T" Then smontantht = LigTk.Item[6]
            If mtrem <> "0" Then smontantht = Val(utils.CPoint(smontantht)) - (Val(utils.CPoint(smontantht)) * Val(utils.CPoint(mtrem)) / 100)
            smrem = Utils.cpoint(LigTk.Item[7])
          Endif
        Endif
      Endif
    Until LigTk.MoveNext()
    
    
    'On enregistre le total si ticket non supprimé, ni en attente, ni en client compte (BL n'est pas un encaissement)  
    If iAttente = 0 And Supprime = False And clicompte = 0 Then
      rResult = Utils.db.Exec(" select * from Fiches_Caisses where code = &1", Ncaisse)
      Totp = rResult!fndtotp + Val(.cpoint(smttc))
      Totg = rResult!fndtotg + Val(.cpoint(smttc))
      Utils.db.Exec("UPdate Fiches_Caisses  SET fndtotp = &1, fndtotg = &2 WHERE code = &3", Totp, Totg, Ncaisse)
    Endif
    If scavoir = "Z" Then
      rResult = Utils.db.Exec(" select * from " & Cbase.Table("TabAvoirs") & " where ntk = &1", Numavoir)
      If rResult.Available Then mntAv = rResult!montant
      If Val(Utils.cpoint(mntav)) = Val(Utils.cpoint(smavoir)) Then
        Utils.db.Exec("DELETE FROM  " & Cbase.Table("TabAvoirs") & " WHERE ntk = &1", Numavoir)
      Else
        mntav = Val(Utils.cpoint(mntav)) - Val(Utils.cpoint(smavoir))
        Utils.db.Exec("UPdate  " & Cbase.Table("TabAvoirs") & "  SET montant = &1 WHERE ntk = &2", Mntav, Numavoir)
      Endif
    Endif
    If iavoir = 1 Then
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabAvoirs") & " (intitule, dte, montant, montantdu, ntk) VALUES (&1, &2, &3, &4, &5)", snavoir, datetk.DT, Val(utils.cpoint(TotalTk.Text)), 0, numero_tk)
    Endif
    
    Tab = "Fiches_EntTicketz"
    'On enregistre dans la table Ent_Ticket
    Utils.db.Exec("INSERT INTO " & Tab & " (caisse, numero, date, client, scheque, mcheque, nmcheque, scarte, mcarte, nmcarte, sespeces, mespeces, scredit, mcredit, mht, mtva, mttc, statut, savoir, scavoir, mavoir, type, vendeur, carte, points, sbonus, mbonus, sresto, mresto, sbachat, mbachat, nom, suppr, retro) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27}, &{28}, &{29}, &{30}, &{31}, &{32}, &{33}, &{34})", Ncaisse, numero_tk, datetk.DT, clicode, scheque, tcheque, nmcheque, scarte, smcarte2, nmcarte, sespeces, smespeces, scredit, smcredit, smht, smtva, smttc, sstatut, iavoir, scavoir, smavoir, clicompte, Caissiere, Left(scartef, 13), ftpointg, sbonus, smbonus, sresto, smresto, sachat, smachat, Left$($Cli, 35), ssuppr, bretro)
    If numero_tk = prev_numero Then
      Message.Error("Erreur de chainage des tickets (" & numero_tk & "), ceci ne devrait pas arriver!")
      prev_numero = ""
    Endif
    Sha1Calc.CalcSha1T(Tab, numero_tk, prev_numero)
    'Lors de l'enregistrement d'un ticket on supprime le flag ticketz, il sera remis par la génération du livre de caisse
    Utils.db.Exec("Update " & Cbase.Table("TabCaisses") & " set tkz = &2 where code = &1", NCaisse, 0)

    'Si ce n'est pas un ticket mis en attente on met a jour le numero du dernier Ticket validé
    If iAttente = 0 Then
      Utils.db.Exec("UPdate  " & Cbase.Table("TabParam") & "  SET dntk = &1", numero_tk)
    Endif

    'On autorise la caisse a se reattribuer un nouveau numéro si le ticket n'est pas un tiquet rappelé
    If iRattente = 0
        Utils.db.Exec("Update " & Cbase.Table("TabCaisses") & " set cutk = &1 where code = &2", Null, Ncaisse)
    Endif
        
    Totpoint = Ftpoint
    Totgain = totgain + fbonusg
    Totgain = totgain - boni
    Utils.db.Exec("UPdate " & Cbase.Table("TabCarte") & "  SET   tp2 = &2, tg2 = &3 WHERE code = &1", scartef, Totpoint, Totgain)
    If Totpoint <> 0 Then
      Do
        If Totpoint >= fbonusv Then
          Totpoint = Totpoint - fbonusv
          Totgain = totgain + fbonus
          Utils.db.Exec("UPdate " & Cbase.Table("TabCarte") & "  SET   tp2 = &2, tg2 = &3 WHERE code = &1", scartef, Totpoint, Totgain)
        Endif
        If fBonusv = 0 Then Break
        If Totpoint < fbonusv Then Break
      Loop
    Endif
    ColumnView1.Clear
    Init_Reg()
    LigTk.clear
    Bdc.clear
    Nmc2.Clear
    Ent_tk(Null)
    TotalTk.Text = "0,00"
    Zone = "Article"
    iQte = 0
    iRem = 0
    RemTot.Clear
    iAttente = 0
    iRattente = 0
    iAvoir = 0
    Clicompte = 0
    inlg = 0
    iligne = 0
    Init_LigTk()
    Label1.Text = ""
    Label2.Text = ""
    Label3.Text = ""
    Label4.Text = ""
    scartef = ""
    $Cli = ""
    $Nomd = ""
    ftpointg = 0
    ftpoint = 0
    icartef = 0
    Boni = 0
    Totgain = 0
    bretro = False
    bmodifregl = False
    Cart.ReadOnly = False
    Cart.SetFocus
  End With

End

Public Sub Init_LigTk()

  LigTk.Columns.count = 5
  LigTk.Columns[0].Width = 0
  LigTk.Columns[1].Width = 80
  LigTk.Columns[2].Width = 220
  LigTk.Columns[3].Width = 65
  LigTk.Columns[3].Alignment = 2
  LigTk.Columns[4].Width = 40
  LigTk.Columns[4].Alignment = 2
  clicode = CodeclientDefault
  TextLabel5.text = "Reste à payer :"
  Clicompte = 0
  Bdc.Text = ""
  Blexists = False

End

Public Sub Init_Columnview1()

  ColumnView1.Columns.count = 3
  ColumnView1.Columns[0].Width = 0
  ColumnView1.Columns[1].Text = "Mode de réglement"
  ColumnView1.Columns[1].Width = 240
  ColumnView1.Columns[2].Text = "Montant"
  ColumnView1.Columns[2].Width = 100
  ColumnView1.Columns[2].Alignment = 2

End

Public Sub Init_Reg()

  Frame2.visible = False
  Especes.Clear
  Carte.Clear
  Cheque.Clear
  Bachat.Clear
  Chequecad.Clear
  Bavoir.Clear
  Bonus.Clear
  ColumnView1.Clear
  Cart.SetFocus
  Zone = "Article"
  Cart.Select
  Rticket.text = "0"
  Mticket.text = "0"
  Cart.ReadOnly = False
  Qte.ReadOnly = False
  ipaiement = 0

End

'******************************************************* Gestion des facturettes *************************************************

Public Sub Button26_Click()

  If Frame6.Visible = True Then
    Frame6.Visible = False
    Nticket.Clear
    Cart.SetFocus
    Zone = "Article"
  Else
    Entetcli = ""
    $iSpc.clear
    $iSpc2.Clear
    If LigTk.count > 0 Then
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      If Message.Warning("Il y a un Ticket en cours ! \n Voulez-vous annuler votre saisie et continuer l'impression d'une facturette ?", "Oui", "Non") = 1 Then
        Frame6.Visible = True
        Nticket.text = Dtck
        Nticket.SetFocus
        Nticket.select
        Zone = "Nticket"
      Else
        Cart.setfocus
        Zone = "Article"
      Endif
    Else
      If Panel17.visible Then Fermer2()
      Frame6.Visible = True
      Nticket.text = Dtck
      Nticket.SetFocus
      Nticket.select
      Zone = "Nticket"
      'Cart.setfocus
    Endif
  Endif

End

Public Sub Nticket_KeyPress()
  ChkNtk()
  If key.code = key.Esc Or If Key.code = key.F12 Then
    Frame6.Visible = False
    Nticket.Clear
    Cart.SetFocus
    Zone = "Article"
  Endif
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    Valid_Nticket()
  Endif

End

Public Sub Valid_Nticket()

  Dim Tabe As String
  Dim rntck As Result
  Dim rcli As Result

  If Not IsNull(Nticket.Text) Then
    Tabe = "Fiches_EntTicketz"
    rntck = Utils.db.Exec(" select * from " & Tabe & " where numero = &1 and statut = &2", Nticket.Text, "0")
    If rntck.Available Then
      Datetk2 = LDate(rntck!date)
      If rntck!type = 0 Then
        Frame6.Visible = False
        Frame7.Visible = True
        Nmc4.SetFocus
        clicompte = 0
        Zone = "Nmc4"
      Else
        clicompte = 1
        rcli = Utils.db.Exec(" select * from " & Cbase.Table("TabCli") & " where cli_code = &1", rntck!client)
        Entetcli = rcli!cli_rs_soc & " " & rcli!cli_nom & " " & rcli!cli_pnm & "\n" & rcli!cli_adr1 & "\n" & rcli!cli_adr2 & "\n" & rcli!cli_cd_ptl & " " & rcli!cli_ville & "\n"
        Entetet = Adr & "\n" & Siret & " \n" & Tvaintra & "\n" & Tel & "\n"
        Entetet = Entetet & "Caissier(e) : " & $Caissiere
        Entetet = Entetet & Pointille & "\n"
        
        If clicompte = 1 Then
          If Imprimante = "DéfautA4" Then
            Entetet = Entetet & "Bon de caisse No " & Nticket.text & Space$(35) & Datetk2.LT & "\n"
          Else
            If Imprimante = "Défaut80" Then
              Entetet = Entetet & "Bon de caisse No " & Nticket.text & Space$(3) & Datetk2.LT & "\n"
            Else
              Entetet = Entetet & "Bon de caisse No " & Nticket.text & Space$(3) & datetk2.LT
            Endif
          Endif
        Endif
        If Left$(Imprimante, 4) = "/dev" Then
          Serial_Facture()
        Else
          Defaut_Facture()
        Endif
        
        Frame6.Visible = False
        Nticket.Clear
        Cart.SetFocus
        Zone = "Article"
      Endif
      
    Else
      If Start.son Then
        If Start.son Then
          Music.Play
        Endif
      Endif
      Message.Error("Ce numèro de ticket n'existe pas !")
      Nticket.SetFocus
      Nticket.Select
    Endif
  Endif

End

Public Sub impressionbon(clientc As String)

  Dim rcli As Result

  If Not IsNull(clientc) Then
    rcli = Utils.db.Exec(" select * from " & Cbase.Table("TabCli") & " where cli_code = &1", clientc)
    Entetcli = rcli!cli_rs_soc & " " & rcli!cli_nom & " " & rcli!cli_pnm & "\n" & rcli!cli_adr1 & "\n" & rcli!cli_adr2 & "\n" & rcli!cli_cd_ptl & " " & rcli!cli_ville & "\n"
  Endif
  Entetet = Adr & "\n" & Siret & " \n" & Tvaintra & "\n" & Tel & "\n"
  Entetet = Entetet & "Caissier(e) : " & $Caissiere
  Entetet = Entetet & Pointille & "\n"
  If clicompte = 1 Then
    If Imprimante = "DéfautA4" Then
      Entetet = Entetet & "Bon de caisse No " & Nticket.text & "\n" & Datetk2.LT & "\n"
    Else
      If Imprimante = "Défaut80" Then
        Entetet = Entetet & "Bon de caisse No " & Nticket.text & Space$(3) & Datetk2.LT & "\n"
      Else
        Entetet = Entetet & "Bon de caisse No " & Nticket.text & Space$(3) & datetk2.LT
      Endif
    Endif
  Else
    If Left$(Imprimante, 4) = "/dev" Then
      Entetet = Entetet & "Reimpression du ticket No " & Nticket.text & Space$(3) & datetk2.LT
    Else
      Entetet = Entetet & "Reimpression du ticket No " & Nticket.text & Space$(3) & datetk2.LT & "\n"
    Endif
    Serial_Facture()
  Endif
  Frame6.Visible = False
  Frame7.Visible = False
  Nticket.Clear
  Cart.SetFocus
  Zone = "Article"

End

Public Sub ChkNtk()

  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return And key.code <> 37 And key.code <> 42 And key.code <> 43 And key.code <> 45 And key.code <> 47 Then
      Stop Event
    Endif
  Endif

End

Public Sub Nmc4_KeyPress()

  If key.code = key.Escape Or key.code = key.F12 Then
    Frame7.Visible = False
    Nmc4.Clear
    Nmc5.Clear
    Nmc6.Clear
    impressionbon("")
    Cart.SetFocus
    Zone = "Article"
  Else If key.code = key.F2 And Start.LocalSettings["/Soc" & Start.Societe & "/caisse/histocli"] Then
    ClientsDivers()
  Else If Key.Code = Key.Tab
    Stop Event
    Nmc5.SetFocus()
  Endif

End

Public Sub Nmc5_KeyPress()

  If key.code = key.Escape Or key.code = key.F12 Then
    Frame7.Visible = False
    Nmc4.Clear
    Nmc5.Clear
    Nmc6.Clear
    impressionbon("")
    Cart.SetFocus
    Zone = "Article"
  Else If key.code = key.F2 And Start.LocalSettings["/Soc" & Start.Societe & "/caisse/histocli"] Then
    ClientsDivers()
  Else If Key.Code = Key.Tab
    Stop Event
    Nmc6.SetFocus()
  Endif

End

Public Sub Nmc6_KeyPress()

  If key.code = key.Escape Or key.code = key.F12 Then
    Frame7.Visible = False
    Nmc4.Clear
    Nmc5.Clear
    Nmc6.Clear
    impressionbon("")
    Cart.SetFocus
    Zone = "Article"
  Else If key.code = key.F2 And Start.LocalSettings["/Soc" & Start.Societe & "/caisse/histocli"] Then
    ClientsDivers()
  Else If Key.Code = Key.Tab
    Stop Event
    Nmc4.SetFocus()
  Endif

End


Public Sub button42_Click()
    ClientsDivers()
End


Public Sub button29_Click()
  ' on imprime

  If Not IsNull(Nmc4.Text) Then
    If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/histocli"] Then Enrg_Clientd(Caisse.Codearticle)
    Ent_tk2()
    If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Or If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximp2"] Then
      Defaut_Facture()
    Else
      Serial_Facture()
    Endif
    Frame6.Visible = False
    'ClavFam()
    Nticket.Clear
    Cart.SetFocus
    Zone = "Article"
  Else
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Message.Warning("Vous devez saisir les coordonnées du client\n avant d'imprimer la facture !")
  Endif

End

Public Sub Ent_tk2()

  Entetet = Adr & "\n" & Siret & " \n" & Tvaintra & "\n" & Tel & "\n"
  Entetet = Entetet & "Caissier(e) : " & $Caissiere
  Entetet = Entetet & Pointille & Left$(pointille, 30) & "\n"
  'IF Imprimante = "DéfautA4" THEN Entetet = Entetet & "Facture No " & Nticket.text & Space$(35) & Datetk2 & "\n"
  'IF Imprimante = "/dev/ttyS0" THEN Entetet = Entetet & "Facture No " & Nticket.text & Space$(3) & datetk2
  Entetet = Entetet & "Facture No " & Nticket.text & Space$(10) & "Le " & Datetk2.LT & "\n"

Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Serial_Facture()

  Dim Tabl As String
  Dim rntck As Result
  Dim sline As String
  Dim i As Integer = 0
  Dim intit As String
  Dim ispc As Integer = 0 'Compteur des lignes d'entete

  Tabl = "Fiches_LigTicketz"
  With Utils
    i = 0
    Datetk = LDate(Now)
    'Entete_Tck("1")
    Print #Sport, Chr$(&H1B); "c0"; Chr$(4); ' On activel'imprimante cheque
    For Each sline In Split(Entete.Text, "\n")
      If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(17); 'on imprime en double hauteur la premiere ligne d 'entete
      'If ispc = 8 And i = 1 And origine = "1" Then Print #sport, Chr$(&H1B) & "m"; ' on coupe le papier
      Print #Sport, .Replace(sline)
      If ispc = 0 Then Print #Sport, Chr$(&H1B) & "!" & Chr$(1); 'on remet le caractere normal
      Inc ispc
    Next
    Wait 0.5
    If clicompte <> 1 Then
      For Each sline In Split(Nmc4.Text, "\n")
        Inc i
        $iSpc2.Add(sline)
      Next
    Else
      For Each sline In Split(Entetcli, "\n")
        Inc i
        $iSpc2.Add(sline)
      Next
    Endif
    'Print #Sport, Chr$(&H1B); "c0"; Chr$(4); ' On activel'imprimante cheque
    Print #Sport, "Facture numero " & Nticket.text & "  " & datetk.LT
    Print #Sport, " "
    For i = 0 To 2
      Try Print #Sport, .Replace($iSpc2[i])
    Next
    Print #Sport, Pointille
    Print #Sport, " "
    rntck = Utils.db.Exec(" select * from " & Tabl & " where numero = &1 order by lind", Nticket.Text)
    If rntck.Available Then
      Repeat
        If rntck!type <> "K"
          Intit = .Replace(rntck!intitule)
          Intit = Left$(Intit, 30)
          Intit = Intit & String$(31 - Len(Intit), " ")
          Print #Sport, intit;
          Print #Sport, rntck!montant & Space$(10 - Len(rntck!montant));
          Print #Sport, rntck!qte
        Endif
      Until rntck.MoveNext()
    Endif
    Nmc4.clear
    Nmc5.clear
    Nmc6.clear
    Frame7.visible = False
    Cart.SetFocus
    Zone = "Article"
    ' Print #sport, Chr$(&H1D) & "V" & Chr$(66) & Chr$(0); ' on coupe le papier
    Print #Sport, Chr$(&HC);
    'Entete_Tck("1")
  End With
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

Public Sub Defaut_Facture()

  Dim Tabl As String
  Dim rntck As Result
  Dim Posx As Integer = 4
  Dim Posy As Integer = 2
  Dim Filename As String
  Dim sline As String
  Dim i As Integer = 0
  Dim ipos As Integer

  Tabl = "Fiches_LigTicketz"
  Filename = User.home & "/Ticket.pdf"
  If Imprimante = "DéfautA4" Or If Start.LocalSettings["/Soc" & Start.Societe & "/caisse/choiximp2"] Then
    pdf = New Cfacture("P", "mm", "A4")
    Ba4 = True
  Else
    If Imprimante = "Défaut80" Then
      pdf = New Cfacture("P", "mm", "80mm")
      Ba4 = False
    Endif
  Endif
  If Ba4 Then
    ipos = 90
  Else
    ipos = 60
  Endif
  pdf.Open()
  pdf.AliasNbPages()
  pdf.newPage()
  For Each sline In Split(Entetet, "\n")
    'Inc i
    $iSpc.add(sline)
  Next
  i = 0
  Posy = 4
  If clicompte <> 1 Then
    $iSpc2.Add(Nmc4.Text)
    $iSpc2.Add(Nmc5.Text)
    For Each sline In Split(Nmc6.Text, "\n")
      'Inc i
      $iSpc2.Add(sline)
    Next
  Else
    For Each sline In Split(Entetcli, "\n")
      'Inc i
      $iSpc2.Add(sline)
    Next
  Endif
  i = 0
  pdf.Entete2($iSpc[i], Posx, Posy, "B", Ba4)
  If Ba4 Then
    Posy += 5
  Else
    Posy += 5
  Endif
  For i = 1 To 10
    If Left$($iSpc[i], 5) = "-----" Then
      If Ba4 Then
        Posy += 8
      Else
        Posy += 6
      Endif
      pdf.Lines(Posy)
    Else
      Try pdf.Entete($iSpc[i], Posx, Posy, "", Ba4)
      If i = 3 Then
        Try pdf.Entete2($iSpc2[i - 3], Posx + ipos, Posy, "B", Ba4)
      Else
        Try pdf.Entete2($iSpc2[i - 3], Posx + ipos, Posy, "", Ba4)
      Endif
    Endif
    pdf.Logo2("fac", Ba4) 'On imprime le logo
    If Ba4 Then
      Posy += 5
    Else
      Posy += 4
    Endif
  Next
  If Ba4 Then
    Posy += 6
  Else
    Posy += 3
  Endif
  pdf.Level2F(posy)
  If Ba4 Then
    Posy += 10
  Else
    Posy += 8
  Endif
  rntck = Utils.db.Exec(" select * from " & Tabl & " where numero = &1 order by lind", Nticket.Text)
  If rntck.Available Then
    Repeat
      If rntck!type <> "K"
        If Left$(rntck!intitule, 5) = "-----" Then
          Posy += 3
          pdf.Lines2(Posy)
          Posy += 2
        Else
          pdf.Level4(rntck!code, rntck!intitule, rntck!montant, rntck!qte, PosY)
          If Ba4 Then
            Posy += 5
          Else
            Posy += 5
          Endif
        Endif
      Endif
    Until rntck.MoveNext()
  Endif
  pdf.Output(Filename, False)
  If Clicompte = "1" Then
    Impression.Facture(Filename, Nbf)
  Else
    Impression.Facture(Filename, 1)
  Endif
  Nmc4.clear
  Nmc5.clear
  Nmc6.clear
  Frame7.visible = False
  Try Kill Filename
  Cart.SetFocus
  Zone = "Article"
Catch
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  Try message.Error(Error.Text & " " & Error.where)

End

'*************************************** Gestion des tickets X et Z et fermeture caisse **********************************************

'On imprime les tickets X
Public Sub Button20_Click()

  Dim sIntitule As String

  sIntitule = "Caisse No" & Ncaisse & " : Impression du ticket X le " & Format$(Now, "dd-mm-yyyy  hh-nn")
  If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Then
    Defaut_Ticketxz(sIntitule, False)
  Else
    sIntitule = Utils.Replace(sIntitule)
    Serial_Ticketxz(sIntitule, "x")
    Defaut_Ticketxz(sIntitule, False)
  Endif

End

' **************************************** On imprime la bande Z *****************************************************
Public Sub button24_Click()

  mdp_admin()
  If GestMdp = 1 Then
    org = "B24"
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Frame8.visible = True
    Mdp.SetFocus
    Zone = "Mdp"
  Else
    If Val(Utils.cpoint(TotalTk.Text)) = 0 Then
      If Not IsNull(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ChmZ"]) Then
        Ticketz()
      Else
        Message.Error("Impression Bande Z impossible ! Le chemin de l'historique n'est pas défini dans les préférences de la caisse")
      Endif
    Else
      Message.Warning("Il y a un ticket en cours ! Bande Z impossible !")
      Cart.setfocus
    Endif
  Endif
Catch
  Message.Error("Impression Bande Z impossible ! Le chemin de l'historique n'est pas défini dans les préférences de la caisse")

End

Public Sub Ticketz()

  Dim rtx, rtx2 As Result
  Dim Tabx As String
  Dim Tabz As String
  Dim Tabtx, Tabtz As String
  Dim Tabrgx As String
  Dim Tabrgz As String
  Dim Tiketx As String
  Dim Tiketz As String
  Dim sintitule As String
  Dim qte As String
  Dim montant As String

  Tabz = "Fiches_EntTicketz"
  Tiketz = "Fiches_LigTicketz"
  If Start.son Then
    If Start.son Then
      Music.Play
    Endif
  Endif
  If ecole = False Then
    rtx = Utils.db.Exec(" select * from " & Tabz & " where caisse = &1 and statut = &2", NCaisse, 1)
    If rtx.Available Then
      message.Warning("Il reste des tickets en attente pour votre caisse ! Ticket Z impossible !")
    Else
      If message.Question("Cette opération va valider les fichiers de caisse!\nVous pourrez alors changer le fond de caisse initial.\nVoulez-vous continuer ?", "Oui", " Non") = 1 Then
        sIntitule = "Caisse No" & Ncaisse & " : Impression du ticket Z le " & Format$(Now, "dd-mm-yyyy  hh-nn")
        ' on imprime la bande z
        Tkz = 1
        If Imprimante = "DéfautA4" Or If Imprimante = "Défaut80" Then
          Defaut_Ticketxz(sIntitule, True)
          Dupli()
        Else
          Serial_Ticketxz(sIntitule, "z")
          Defaut_Ticketxz(sIntitule, False)
          Dupli()
        Endif
        If sDon Then
          If Start.son Then
            If Start.son Then
              Music.Play
            Endif
          Endif
          message.Info("Traitement terminé !")
          Me.mouse = Mouse.Default
        Endif
        Utils.db.Exec("UPDATE  " & Cbase.Table("TabCaisses") & "  SET tkz = &2 WHERE code = &1", Ncaisse, 1)
      Endif
    Endif
  Else
    Message.Warning("Cette opération n'est pas permise sur une caisse école !")
  Endif
  Cart.SetFocus
  Zone = "Article"
Catch
  Me.mouse = Mouse.Default
  If Start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  Return

End

'****************************************************************************
'*      CALCUL MARGE PAR ARTICLE                                            *
'****************************************************************************

Private Function margeart(code As String, qte As String, mht As String, rem As String) As Float

  Dim res As Result
  Dim marge As Float
  Dim fmht, fqte As Float

  marge = 0
  res = utils.db.Exec("SELECT * FROM Fiches_Art WHERE art_code=&1", code)
  If res.Available Then
    If IsNull(rem) Then rem = "0"
    fmht = CFloat(Trim(Replace(mht, ",", "."))) - CFloat(Trim(Replace(rem, ",", ".")))
    fqte = CFloat(Trim(Replace(qte, ",", ".")))
    Try marge = fmht - (fqte * res!art_prvt)
    If Error Then marge = fmht - (fqte * res!art_paua)
  Endif
  Return marge

End

Public Sub Defaut_Ticketxz(sintitule As String, org As Boolean)

  Dim Filename As String

  If Org Then
    Filename = User.home & "/TicketZ.pdf"
  Else
    Filename = User.home & "/TicketX.pdf"
  Endif
  
  sDon = Moulinage.Livre_caisse(Ncaisse, "0", org, Null, "A4", Filename)
  If SDon
    If org Then DupliZ(Filename)
  Else
    Message.Info("Aucune donnée n'est a traiter !")
    Cart.SetFocus
  Endif

End

Public Sub DupliZ(Zfile As String)

  Dim chemin As String

  If Not Exist(Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ChmZ"]) Then
    Try Mkdir Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ChmZ"]
    If Error Then
      Message.Error("Problème lors de la création d'un répertoire\nMerci de créer manuellement un répertoire nommé  : & Chemin'")
    Endif
  Else
    Chemin = Start.LocalSettings["/Soc" & Start.Societe & "/caisse/ChmZ"]
    Chemin = chemin & "/" & Format$(Now, "yyyy")
    If Not Exist(chemin) Then Try Mkdir chemin
    Chemin = Chemin & "/" & Format$(Now, "mm")
    If Not Exist(chemin) Then Try Mkdir chemin
    If Error Then
      Message.Error("Problème lors de la création d'un répertoire\nMerci de créer manuellement un répertoire nommé :  " & Chemin)
    Endif
    Shell "cd " & User.Home & "" Wait
    Shell "cp " & Zfile & " " & chemin & "/" & "Ticket.pdf" & Format$(Now, "ddmmyyyy-hh-nn") Wait
    Wait 0.5
  Endif

End

Public Sub Serial_Ticketxz(sintitule As String, origine As String)

  Dim rTkx, rttva, rTkhv, rTkFam As Result
  Dim Tabx As String
  Dim Tabe, Tabl As String
  Dim Tabr As String
  Dim sFam As String = 0
  Dim sFam2 As String = 0
  Dim sMtfam As String = 0
  Dim sMtreg As String = 0
  Dim sreg As String
  Dim sqte, tintitule As String
  Dim totcaisse As String = 0
  Dim totventes As String = 0
  Dim Fdc As String = "0"
  Dim Totnbtck, Boncaisse As Integer = 0
  Dim Pnm, itva As Float = 0
  Dim sLfam As String
  Dim Enc As Boolean = False
  Dim tcheque, tcarte, tespece, tmttc As Float

  Try sLfam = Replace$(rTkFam!libelle, "\n", " ")
  Tabe = "Fiches_EntTicketz" '& Ncaisse
  Tabx = "Fiches_Fam" 
  'Tabx = "Fiches_Ticketx" & Ncaisse
  'Tabr = "Fiches_Reglts" & Ncaisse
  Tabl = "Fiches_LigTicketz" '& Ncaisse
  With Utils
    rTkx = Utils.db.Exec("select * from  " & Cbase.Table("TabCaisses") & " WHERE code = &1", Ncaisse)
    Try Fdc = Format$(rTkx!fndc, "0.00")
    totcaisse = Val(.cpoint(Totcaisse)) + Val(.cpoint(Fdc))
    rTkx = Utils.db.Exec(" select * from " & Tabe & " where statut = &1 and caisse = &2", "0", Ncaisse)
    If rTkx.Available Then
      Entete_Tck("1")
      If origine = "x" Then
        Print #Sport, Chr$(&H1B) & "c0" & Chr$(2);
      Else
        Print #Sport, Chr$(&H1B) & "c0" & Chr$(1);
      Endif
      Totnbtck = rTkx.count
      If rTkx.Available Then
        Repeat
          ' Les clients comptes génère des BL il n'y a donc pas de vente/d'encaissement
          ' l'encaissement pourra avoir lieu en caisse lors du règlement de BL
          If rTkx!type = 1 Then Continue
          If rTkx!savoir = 1 Then
            Try totventes = Val(.cpoint(Totventes)) - Val(.cpoint(rTkx!mttc))
          Else
            Try totventes = Val(.cpoint(Totventes)) + Val(.cpoint(rTkx!mttc))
          Endif
          If rTkx!scheque = "V" Then tcheque = tcheque + Val(.cpoint(rTkx!mcheque))
          If rTkx!scarte = "U" Then tcarte = tcarte + Val(.cpoint(rTkx!mcarte))
          If rTkx!sespeces = "N" Then tespece = tespece + Val(.cpoint(rTkx!mespeces))
        Until rTkx.MoveNext()
      Endif
      rTkx = Utils.db.Exec(" select * from " & Tabl & " as l inner join " & Tabe & " as e on e.numero = l.numero where e.statut = &1 and e.suppr !=1 and e.caisse = &2 order by l.type", "0", Ncaisse)
      If rTkx.Available Then
        Print #Sport, Left$(sintitule, 35)
        Print #Sport, Mid$(sintitule, 37, Len(sintitule) - 35)
        Print #Sport, "Caissier(e) " & $caissiere
        Print #Sport, pointille
        Print #Sport, "Fond de caisse initial " & Fdc
        Print #Sport, pointille
        Print #Sport, "Mouvements hors ventes "
        Print #sport, ""
        Repeat
          If rTkx!type = "F" Or If rTkx!type = "G" Or If rTkx!type = "H" Or If rTkx!type = "P" Then
            If rTkx!type = "F" Then sreg = "Sortie especes" & rTkx!intitule
            If rTkx!type = "G" Then sreg = "Entree especes " & rTkx!intitule
            If rTkx!type = "H" Then sreg = "Entree cheques " & rTkx!intitule
            If rTkx!type = "P" Then sreg = "Entree cartes " & rTkx!intitule
            sreg = Left$(sreg, 23)
            sMtreg = Format$(Val(.cpoint(rTkx!montant)), "0.00")
            If rTkx!type = "F" Then sMtreg = "-" & sMtreg
            If rTkx!type = "F" Then
              totcaisse = Val(.cpoint(Totcaisse)) - Val(.cpoint(rTkx!montant))
            Else
              If rTkx!type = "G" Then totcaisse = Val(.cpoint(Totcaisse)) + Val(.cpoint(rTkx!montant))
            Endif
            sqte = rTkx!qte
            If rTkx!type = "F" Or If rTkx!type = "G" Or If rTkx!type = "P" Or If rTkx!type = "H" Then
              Print #Sport, sreg & Space$(23 - Len(sreg)) & sMTreg & Space$(10 - Len(sMTreg)) & sqte
            Endif
          Endif
        Until rTkx.MoveNext()
      Endif
      
      Print #Sport, pointille
      rTkx = Utils.db.Exec(" select  sum(replace(mttc, ',', '.')) as tmttc from " & Tabe & " where statut = &1 and suppr = &2 and caisse =&3", "0", 1, NCaisse)
      If rTkx.Available Then Try tmttc = rTkx!tmttc
      rTkx = Utils.db.Exec(" select * from " & Tabe & " where statut = &1 and suppr = &2 and caisse =&3", "0", 1, NCaisse)
      If rTkx.Available Then
        Print #Sport, " Tickets annulés :  " & Format$(tmttc, "0.00") & " : " & rTkx.Count
        Print #sport, ""
        Repeat
          Print #Sport, " Tickets " & rTkx!numero & " : " & Format$(Val(.cpoint(rTkx!mttc)), "0.00")
          Print #sport, ""
        Until rTkx.MoveNext()
      Endif
      Print #Sport, pointille
      rTkhv = Utils.db.Exec(" select count(*) as cnt, l.type, sum(cast(REPLACE(l.montant,',','.') as decimal(7,2))) as totmontant, DATE(e.date) as ddate from " & Tabl & " as l left join " & Tabe & " as e on l.numero = e.numero where l.type is not Null and e.statut = &1 and e.caisse = &2 and e.suppr != 1 group by l.type, DATE(e.date)", "0", Ncaisse)
      If rTkhv.Available Then
        Print #Sport, "Mouvements ventes "
        Print #sport, ""
        Repeat
          If rTkhv!type = "N" Then sreg = "Tot. rglts par especes "
          'If rTkhv!type = "Q" Then sreg = "Tot. rendu monnaie "
          If rTkhv!type = "U" Then sreg = "Tot. rglts par cartes "
          If rTkhv!type = "V" Then sreg = "Tot. rglts par cheques "
          If rTkhv!type = "B" Then sreg = "Tot. bonus utilises "
          If rTkhv!type = "E" Then sreg = "Tot. bons de reduction "
          If rTkhv!type = "X" Then sreg = "Tot. bons achat "
          If rTkhv!type = "Y" Then sreg = "Tot. cheques cadeaux "
          If rTkhv!type = "W" Then sreg = "Tot. credits "
          If rTkhv!type = "Z" Then sreg = "Tot. avoirs "
          If rTkhv!type = "1" Then sreg = "Tot. Cheques entreprise"
          If rTkhv!type = "M" Then sreg = "Tot. clients compte "
          If rTkhv!totmontant <> Null Then
            sMtreg = Format$(Val(.cpoint(rTkhv!totmontant)), "0.00")
          Else
            sMtreg = "0.00"
          Endif
          sqte = rTkhv!cnt
          If Val(sqte) > 0 Then
            If rTkhv!type = "E" Or If rTkhv!type = "B" Or If rTkhv!type = "N" Or If rTkhv!type = "U" Or If rTkhv!type = "V" Or If rTkhv!type = "X" Or If rTkhv!type = "Y" Or If rTkhv!type = "W" Or If rTkhv!type = "Z" Or If rTkhv!type = "M" Or If rTkhv!type = "1" Then
              sreg &= " du " & LDate(rTkhv!ddate).L
              Print #Sport, .Replace(sreg) & Space$(45 - Len(sreg)) & sMTreg & Space$(10 - Len(sMTreg)) & sqte
            Endif
          Endif
        Until rTkhv.MoveNext()
      Endif
      
      totcaisse = Val(.cpoint(Totcaisse)) + tespece
      Print #Sport, "Total ventes " & Format$(Val(.cpoint(Totventes)), "0.00")
      Print #Sport, pointille
      Print #Sport, "Fond de caisse " & Format$(Val(.cpoint(Totcaisse)), "0.00")
      FndCaisse = Totcaisse
      Print #Sport, pointille
      'rTkx = Utils.db.Exec(" select * from " & Tabe & " where type = &1", "1")
      'If rTkx.Available Then
        'totventes = 0
      '  Repeat
      '    Try totventes = Val(.cpoint(Boncaisse)) + Val(.cpoint(rTkx!mttc))
      '  Until rTkx.MoveNext()
      '  Print #Sport, "Total bons de caisse " & Format$(Val(.cpoint(Boncaisse)), "0.00")
      '  Print #Sport, pointille
      'Endif
      If tkz = 1 Then
        Print #Sport, pointille
        Print #Sport, "Nombre de tickets : ", Totnbtck
        Try Pnm = Totventes / Totnbtck
        If Not Error Then
          Print #Sport, "Panier moyen : " & Format$(Pnm, "0.00")
          Print #Sport, pointille
        Endif
        Tkz = 0
      Endif
      'Recapitulatif TVA sur les ticket avec un encaissement
      rttva = Utils.db.Exec("select * from  " & Tabl & " as l inner join " & Tabe & " as e on e.numero = l.numero WHERE left(intitule,3) = &1 and e.type = &2 and e.suppr != 1 and e.statut = &3 and e.caisse=&4 order by intitule", "TVA", 0, "0", Ncaisse)
      If rttva.Available Then
        Print #Sport, "Recapitulatif TVA"
        tintitule = rttva!intitule
        Repeat
          If tintitule <> rttva!intitule Then
            Print #Sport, Tintitule, itva
            itva = 0
          Endif
          itva = itva + Val(utils.cpoint(rttva!montant))
          tintitule = rttva!intitule
        Until rttva.MoveNext()
        Print #Sport, Tintitule, itva
        Print #Sport, pointille
        Tkz = 0
      Endif
      Print #Sport, Chr$(&H1B); "!"; Chr$(2);
      
      Print #Sport, pointille
      rTkx = Utils.db.Exec(" select * from Fiches_Caisses where code = &1", Ncaisse)
      'pdf.Level2("Total période (sur encaissement)", Format$(Val(.cpoint(rTkx!fndtotp)), "0.00"), "", Posy)
      ' Posy += 5
      ' pdf.Lines2(Posy)
      Print #Sport, "Total général (sur encaissement)" & Format$(Val(.cpoint(rTkx!fndtotg)), "0.00")
      Print #Sport, pointille
    
      rTkFam = Utils.db.Exec("select sum(cast(replace(l.qte,',','.') as decimal(7,2))) as totalfamqte, fam, sum(cast(replace(l.mht,',','.') as decimal(7,2))) as totalfamht, libell_fam from " & Tabl & " as l left join " & Tabe & " as e on l.numero = e.numero left join " & Tabx & " on l.fam = code_fam where l.fam is not Null and l.type = &1 and e.statut = &2 and e.suppr != 1 and e.caisse = &3 group by fam", "A", "0", Ncaisse)
      If rTkFam.Available Then
        Print #Sport, "Total ventes HT par familles"
        Print #sport, ""
        Repeat
          sFam = "Famille " & Left$(rTkFam!fam, 2)
          Print #sport, Utils.Replace(rTkFam!libell_fam) & " " & Format$(Val(utils.cpoint(rTkFam!totalfamht)) / Totventes * 100, "0.00") & " %" & " =>  total: " & rTkFam!totalfamht & " qte: " & rTkFam!totalfamqte
        Until rTkFam.MoveNext()
        Print #Sport, pointille
      Endif

      Print #Sport, ""
      Print #Sport, pointille
      Print #Sport, ""
      Print #Sport, ""
      Print #Sport, ""
      If origine <> "x" Then Print #sport, Chr$(&H1B) & "m";
      Print #sport, Chr$(&H1D) & "V" & Chr$(66) & Chr$(0); ' on coupe le papier
      
      sDon = 1
    Else
      Message.Info("Aucune donnée n'est a traiter !")
      sDon = 0
    Endif
  End With
  If origine = "x" Then
    Print #sport, ""
    'Entete_Tck("1")
  Endif

End

Public Sub Dupli()

  Dim chemin As String

  Chemin = User.Home & "/HistoTickets-" & User.name
  If Not Exist(chemin) Then Mkdir chemin
  Chemin = Chemin & "/" & Format$(Now, "yyyy")
  If Not Exist(chemin) Then Try Mkdir chemin
  Chemin = Chemin & "/" & Format$(Now, "mm")
  If Not Exist(chemin) Then Try Mkdir chemin
  Shell "cp " & User.home & "/" & "Ticket.pdf" & " " & chemin Wait
  Shell "mv " & chemin & "/" & "Ticket.pdf " & chemin & "/" & "Ticket" & Format(Now, "yyyymmddhhnnss") & ".pdf" Wait

End

Public Sub Button25_Click()

  Me.CLOSE

End

'****************************************Gestion des articles**************************************************

Public Sub SelectionArt()

  Dim MyForm As TriArticles

  Bsel = False
  sel = ""
  Tri = "art_code"
  MyForm = New TriArticles(True, "", Tri, "Caisse", "", "")
  MyForm.Showmodal()
  If Bsel = True Then
    Cart.text = Codearticle
    Aff_Art()
  Else
    Cart.SetFocus
    Zone = "Article"
  Endif

End

Public Sub ChkPrx(Optional Sign As Integer = 0)

  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return And key.code <> 37 And key.code <> 42 And key.code <> key.F3 Then
      If sign < 0 And key.code = 43 Then
        Stop Event 
      Else If sign > 0 And key.code = 45 Then
        Stop Event
      Else If sign = 0 And key.code <> 43 And key.code <> 45 Then
        Stop Event
      Endif
    Endif
  Endif

End

Public Sub ChkBs()

  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return And key.code <> 37 And key.code <> 42 And key.code <> 43 And key.code <> 45 And key.code <> 47 And key.code <> key.F3 Then
      Stop Event
    Endif
  Endif

End

Public Sub Aff_Art()

  Dim rarts As Result

  Apromo = False
  Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
  If Rarts.Available Then
    Design.Text = Rarts!art_design
    Nbd = Rarts!art_nbd
    Nbdec = Utils.Find_Nbdec(Nbd)
    Tva = Rarts!art_tva
    Paht = Format$(Rarts!art_paht, Nbdec)
    Pvht = Format$(Rarts!art_pvht, Nbdec)
    Pvttc.Text = Format$(Rarts!art_pvttc, Nbdec)
    Tva = Rarts!art_tva
    Txtva = Rarts!art_tva
    If bretro Then
      If bretro Then pvht = Format$(Rarts!art_prvt * Val(Val_retro), Nbdec)
      Calc_TTC()
    Endif
    Artpu = Pvttc.Text
    Photo = Rarts!art_photo
    If Not IsNull(Photo) Then
      Panel10.Visible = True
      Photos.Clear
      aff_Photo()
    Endif
  Endif
  If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
  If apromo = True Then Balloon.Info(("Ce produit est actuellement en promotion"), Cart)
  If apromo = True Then Prix_Promo()
  If Val(Pvttc.text) = 0 Then
    modif_Tk()
    Design.SetFocus
    Design.Select
  Else
    Qte.SetFocus
    Qte.Select
    Zone = "Qte"
  Endif

End

'******************************************* Gestion des clients *************************************************
Public Sub Ajout_Reg_Bl(numtick As String) As Boolean

  Dim rBl As Result
  Dim Blexists As Boolean = False

  'Remove all previously created BL lines
  Ligtk.MoveFirst()
  Repeat
    Try LigTk.item.Selected = True
    If Not Error Then
      While LigTk.Item[5] = "BL"
        TotalTk.Text = Format$(Val(Utils.cpoint(TotalTk.Text)) - LigTk.Item[3], "0.00")
        LigTk.current.delete
        Ligtk.MoveFirst()
        Try LigTk.Item.Selected = True
        If Error Then Break
      Wend
    Endif
  Until Ligtk.MoveNext()
  RenameLigne()

  rBl = Utils.db.Exec("Select * from " & Cbase.Table("TabBl") & " where numtick = &1", numtick)
  If rBl.Available Then
    Blexists = True
    Repeat
      Inc iligne
      Inc iNlg
      Qte.text = "1"
      LigTk.Add(iligne, iligne)
      LigTk.Item[0] = iNlg
      LigTk.Item[1] = rBl!nmclibl
      LigTk.Item[2] = "Règlement BL " & rBl!numbl
      LigTk.Item[3] = rBl!totalttc
      LigTk.Item[4] = Qte.text
      LigTk.Item[5] = "BL"
      LigTk.Item[6] = rBl!totalht
      LigTk.Item[7] = rBl!numbl
      LigTk.Item[8] = iligne
      LigTk.Item[9] = rBl!totalttc - rBl!totalht
      LigTk.Item[11] = rBl!totalttc
      iComm = 0
      iRem = 0
      iQte = 1
      pvht = rBl!totalht
      TextLabel1.Text = "Article"
      calc_total()
      TotalTk.Text = Format$(Val(Utils.cpoint(TotalTk.Text)) + rBl!totalttc, "0.00")
      Remise.Text = "0,00"
      TextLabel7.Visible = False
      Remise.Visible = False
    Until rBl.MoveNext()
    Zone = "Article"
    Cart.Clear
    Cart.SetFocus
  Endif

  Return Blexists

End
'**********************************************************
'*      Le bouton sert a rechercher les clients           *
'**********************************************************

Public Sub Button30_click()

  Dim MyForm As Triclients
  Dim MyForm2 As Tribl
  Dim numero_tk As String

  If iRattente = 0 Then
    numero_tk = Ntk
  Else
    numero_tk = numtk
  Endif

  bsel = False
  If clicompte = 0 Then

    Select Case Message.Question("Que voulez-vous faire ?\n1- Saisir un nouveau bon de caisse\n2- Règler des bons de caisses\n3 -Sortir", "1", "2", "3")
      Case 1
        If (Blexists = False) Or If ((Blexists = True) And Message.Question("Il y a déjà des règlements de Bon de caisse\nVoulez-vous les supprimer ?", "Oui", "Non") = 1) Then
          'Ceci revient a supprimer la selection des BL
          If (Blexists = True) Then
            Try Utils.db.Exec("Update " & Cbase.Table("TabBl") & " set numtick = &1 where numtick = &2", Null, numero_tk)
            Blexists = Ajout_Reg_Bl(numero_tk)
          Endif
          MyForm = New Triclients("Caisse")
          MyForm.Showmodal()
          If Bsel = True Then
            Recup_Client()
          Endif
        Endif
      Case 2
        MyForm = New Triclients("Caisse")
        MyForm.Showmodal()
        If Bsel = True Then
          MyForm2 = New Tribl(Clicode, numero_tk)
          MyForm2.Showmodal()
          Blexists = Ajout_Reg_Bl(numero_tk)
        Endif
      Case 3
        'do nothing
    End Select
  Else
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    If Message.Question("Il y a déjà un bon de caisse en cours de saisie\nVoulez-vous le supprimer ?", "Oui", "Non") = 1 Then
      Clicompte = 0
      Bdc.Text = ""
    Endif
  Endif

End

'******************************************
'*      Selection du  code client         *
'******************************************
Public Sub Recup_Client()

  Dim Clitab As Result
  Dim Clibl As Result
  Dim AffSolde As String
  Dim solde, soldebl, encours As Float

  Try Clitab = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " as c inner join  " & Cbase.Table("TabComptes") & " as a on a.compte_cc = c.cli_code where cli_code = &1", Clicode)
  If Not Error Then
    Try encours = Val(Utils.cpoint(Clitab!cli_plaf_ecrs))
    If Error Then encours = 0
    soldebl = 0
    Clibl = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabBl") & " where cdclibl = &1 and imp = 0 and numtick is Null", Clicode)
    If Clibl.Available Then
      Repeat
        If Clibl!totalttc <> Null Then soldebl = soldebl + Val(Utils.cpoint(Clibl!totalttc))
      Until Clibl.MoveNext()
    Endif
    solde = Val(Utils.cpoint(Clitab!solde))
    If encours > 0 Then
      If encours < (solde + soldebl) Then
        If RecapSoldeCli Then
          AffSolde = "Saisie impossible!\nL'encours actuel (" & (solde + soldebl) & ") a dépassé\nle plafond défini (" & encours & ") pour ce ce compte!\nVoulez-vous autoriser le dépassement"
        Else
          AffSolde = "Saisie impossible!\nL'encours actuel a dépassé le plafond défini pour ce ce compte!\nVoulez-vous autoriser le dépassement"
        Endif
        If message.Question(AffSolde, "Non", "Oui") = 2 Then
          mdp_admin()
          If GestMdp = 1 Then
            org = "EF12"
            If Start.son Then
              Music.Play
            Endif
            Frame8.visible = True
            Mdp.SetFocus
            Zone = "Mdp"
          Endif
        Else
          Return
        Endif
      Endif
    Endif
  Endif
  Clinom = Clitab!cli_nom
  Clipnm = Clitab!cli_pnm
  Clicp = Clitab!cli_cd_ptl
  Cliburdist = Clitab!cli_ville
  Bdc.Text = "Bon de caisse " & Clitab!cli_nom & " " & Clitab!cli_pnm
  If RecapSoldeCli Then
    Bdc.Text = Bdc.Text & " (solde = " & Format$((solde + soldebl), "0.00") & ")"
  Endif
  Clicompte = 1
  $Cli = Clinom & " " & Clitab!cli_pnm
  Cart.SetFocus
  Zone = "Article"

End

'******************************************* Gestion des clients divers (utilisé pour les facturettes) *************************************************
'**********************************************************
'*      Le bouton sert a rechercher les clients           *
'**********************************************************
Public Sub ClientsDivers()

  Dim MyForm As Tricartes

  Bsel = False
  sel = ""
  If clicompte = 0 Then
    MyForm = New Tricartes(-1)
    MyForm.Showmodal()
    If Bsel = True Then
      RecupClientd(Codearticle)
    Endif
  Else
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Message.Warning("Il y a un bon de caisse en cours de saisie ! Appel des cartes impossible")
    Cart.setfocus
  Endif

End

'******************************************
'*           Selection du  code client  divers           *
'******************************************
Public Sub RecupClientd(codeclid As String, Optional Update_Field As Boolean = True) As Boolean

  Dim Rcarte As Result
  
  $Cli = ""
  Rcarte = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCarte") & " where code = &1", codeclid)
  If Rcarte.Available Then
    'scartef = Rcarte!code
    $Cli = Rcarte!code
    $Nomd = Rcarte!nom
    If Update_Field Then
      Nmc4.Text = Rcarte!nom
      Nmc5.Text = Rcarte!pnm
      Nmc6.Text = Rcarte!adr1
    Endif
    Return True
  Else
    Return False
  Endif

End

Public Sub Enrg_Clientd(codeclid As String)

  Dim CResult As Result
  Dim Cd, der As String
  
  If RecupClientd(codeclid, False) Then
    Utils.db.Exec("UPdate  " & Cbase.Table("TabCarte") & "  SET  nom = &1, pnm = &2, adr1 = &3, datec = &4, datef = &5 WHERE code = &6", Nmc4.Text, Nmc5.Text, Nmc6.Text, Now, Now, codeclid) ' TODO A remplacer par LDate
  Else
    Try CResult = Utils.db.Exec("SELECT code FROM " & Cbase.Table("TabCarte") & " order by code")
    If CResult.Available Then
      CResult.MoveLast
      der = CResult!code
      Cd = Val(der) + 1
      Cd = Format$(Cd, "000000")
    Else
      Cd = "000001"
    Endif
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabCarte") & " (code,nom,pnm,adr1,datec,datef,rem,promo,tp1,tp2,tg1,tg2,divers) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13})", Cd, Nmc4.Text, Nmc5.Text, Nmc6.Text, Now, Now, 0, 0, 0, 0, 0, 0, -1) ' TODO A remplacer par LDate
  Endif

End

'******************************************* Gestion des cartes de fidélité *************************************************
'**********************************************************
'*      CTRL + F8 pour appeler les cartes de fidélité     *
'**********************************************************
Public Sub Button32_Click()

  CartesFidelite()

End

Public Sub CartesFidelite()

  Dim MyForm As Tricartes

  Bsel = False
  sel = ""
  If clicompte = 0 Then
    MyForm = New Tricartes(0)
    MyForm.Showmodal()
    If Bsel = True Then
      RecupCarte()
    Endif
  Else
    If Start.son Then
      If Start.son Then
        Music.Play
      Endif
    Endif
    Message.Warning("Il y a un bon de caisse en cours de saisie ! Appel des cartes impossible")
    Cart.setfocus
  Endif

End

Public Sub RecupCarte()

  Dim Rcarte As Result
  Dim icartef As Integer

  Rcarte = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCarte") & " where code = &1", Codearticle)
  If Rcarte.Available Then
    icartef = 1
    $Cli = Rcarte!nom
    scartef = Codearticle
    snmcartef = Rcarte!nom & " " & Rcarte!pnm
    ftpoint = Rcarte!tp2
    ftpoint2 = ftpoint
    fbonusv = Rcarte!tp1
    fbonus = Rcarte!tg1
    fbonusg = Rcarte!tg2
    frem = Rcarte!rem
    fpromo = Rcarte!promo
    Label1.Text = snmcartef
    Label2.Text = "Carte " & scartef
    Label3.Text = "Points " & Format$(ftpoint, "0.00")
    Label4.Text = "Bonus " & Format$(fbonusg, "0.00")
    Bdc.Text = Label2.Text & " " & Label1.Text
    Cart.Clear
    Chkart = False
    Cart.SetFocus
    Zone = "Article"
  Endif

End

'**************************************** Gestion du stock *****************************************************************
'**********************************************
'*        Maj de la quantite en stock         *
'**********************************************
Public Sub Maj_Quantite()

  Dim Qstock As Float
  Dim Qline As Float
  Dim rStk As Result

  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabArt") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
  With utils
    If LigTk.Count <> 0 Then
      LigTk.MoveFirst
      Repeat
        LigTk.Item.Selected = True
        If LigTk.Item[5] = "A" Then
          rStk = Utils.db.Exec("select * from " & Cbase.Table("TabArt") & " where art_code = &1", LigTk.Item[1])
          If rStk.Available Then
            If rStk!art_stocke Then
              Qline = Val(LigTk.Item[4])
              If IsNull(rStk!art_qte) Then
                Message.Error("Article stocké, mais quantité indefini dans la base!")
                Qstock = 0
              Else
                Qstock = rStk!art_qte
              Endif
              If iavoir = 1 Then
                Qstock = Qstock + Qline
              Else
                Qstock = Qstock - Qline
              Endif
              Utils.db.Exec("UPDATE  " & Cbase.Table("TabArt") & "  SET art_qte = &2 WHERE art_code = &1", LigTk.Item[1], Qstock)
              If Promo Then Apromo = ArtPromo.art_Promo(LigTk.Item[1], Cpromo)
              If Apromo = True Then ArtPromo.Maj_qteplus(LigTk.Item[1], Cpromo, Qline)
            Endif
          Endif
        Endif
      Until LigTk.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")

End


'****************************************************
'*        Maj de la quantite en stock Depot         *
'****************************************************

Public Sub Maj_QteDep()

  Dim Qstock As Float
  Dim Qline As Float
  Dim rStk As Result

  Utils.db.Exec("LOCK TABLES Fiches_StkDepots WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
  With utils
    If LigTk.Count <> 0 Then
      LigTk.MoveFirst
      Repeat
        LigTk.Item.Selected = True
        If LigTk.Item[5] = "A" Then
          rStk = Utils.db.Exec("select * from Fiches_StkDepots where codea = &1 and coded = &2", LigTk.Item[1], $depot)
          If rStk.Available Then
            Qline = Val(LigTk.Item[4])
            If IsNull(rStk!art_qte) Then
              Message.Error("Article stocké, mais quantité indefini dans la base!")
              Qstock = 0
            Else
              Qstock = rStk!art_qte
            Endif
            If iavoir = 1 Then
              Qstock = Qstock + Qline
            Else
              Qstock = Qstock - Qline
            Endif
            Utils.db.Exec("UPDATE  Fiches_StkDepots  SET qte = &3 WHERE codea = &1 and coded = &2", LigTk.Item[1], $depot, Qstock)
            If Promo Then Apromo = ArtPromo.art_Promo(LigTk.Item[1], Cpromo)
            If Apromo = True Then ArtPromo.Maj_qteplus(LigTk.Item[1], Cpromo, Qline)
          Endif
        Endif
      Until LigTk.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")

End


Public Sub Tbremq_Create()

  Dim tb As Integer
  Dim $r As String

  Tbrem.Width = 360
  Tbrem.Height = 170
  Tbrem.x = remise.X - 60
  Tbrem.y = remise.Y - 180
  Tbrem.Border = True
  Tbrem.header = 3
  Tbrem.Columns.Count = 3
  Tbrem.Rows.Count = 6
  Tbrem.Columns.Width = 86
  Tbrem.Rows.Height = 24
  Tbrem.Columns[0].text = "Val mini"
  Tbrem.Columns[1].text = "Val maxi"
  Tbrem.Columns[2].text = "Remise"
  For tb = 0 To 5
    $R = "Remise " & tb
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
  Next
  Tbrem.visible = False

End

Public Sub Tbrem_Click()

  Dim iRow As Integer

  irow = tbrem.row
  Tbrem.MoveTo(irow, 2)
  Try Remise.Text = Format(Val(Utils.cpoint(Tbrem.Current.Text)), "0.00")
  Tbrem.Clear
  Tbrem.Visible = False
  Remise.SetFocus
  Remise.Select
  Zone = "Remise"
  iRem = 1

End

Public Sub Delete_Reglements_Tk()

  Dim numl As Integer

  If ColumnView1.count > 0 Then
    Ligtk.MoveFirst()
    For numl = 0 To ligtk.count - 1
      Try LigTk.item.Selected = True
      Try Ligtk.MoveNext()
      If Not Error Then
        If IsNull(LigTk.Current[8]) Then
          LigTk.Current.Delete
        Endif
      Endif
    Next
  Endif
  RenameLigne()

End

'On supprime / sort des lignes de règlements
Public Sub ColumnView1_KeyPress()

  If Key.code = Key.Esc And ColumnView1.Count = 0 Then
    Init_Reg()
  Else If key.code = key.Delete Then
    ColumnView1_Delete()
  Endif

End

Public Sub ColumnView1_Activate()

  ColumnView1_Delete()

End

Public Sub ColumnView1_Delete()

  If ColumnView1.count > 0 Then
    If message.Question("Voulez-vous supprimer les lignes de règlements ?", "Oui", "Non") = 1 Then
      Delete_Reglements_Tk()
      ColumnView1.Clear
      Rticket.text = Mticket.Text
      TextLabel5.Text = "Reste à payer :"
      inpm.SetFocus()
    Endif
  Endif

End

Public Sub LigTk_KeyPress()

  If key.code = key.Delete Then
    Ligtk_Delete()
  Endif

End

Public Sub Suppr_Click()

  Ligtk_Delete()

End

Public Sub LigTk_Activate()

  Ligtk_Delete()

End


Public Sub Recalc_Tottk()

  Dim Tligne As String
  Dim numl As Integer
  Dim pu, quantite As String
  Dim tot As String
  Dim Rem, Trem As Boolean = False
  Dim bloc As String

  Blexists = False
  LigTk.MoveFirst
  TotalTk.Text = 0
  Mticket.Text = TotalTk.text
  Rticket.text = TotalTk.Text
  Totalht = 0

  For numl = 1 To LigTk.count
    Try LigTk.Item.Selected = True
    If Not Error Then

      If LigTk.Item[5] = "BL" Then
        Blexists = True
        TotalTk.Text = Format$(Val(Utils.cpoint(TotalTk.Text)) + Val(Utils.cpoint(LigTk.Current[11])), "0.00")
        Totalht = Val(Utils.cpoint(Totalht)) + Val(Utils.cpoint(LigTk.Current[6]))
      Endif
      
      If LigTk.Item[5] = "C" Then
        'commentaire do nothing
      Endif

      If LigTk.Item[5] = "A" Then
        Tligne = LigTk.Item[5]
        Pu = LigTk.Item[3]
        quantite = LigTk.Item[4]
        Tot = LigTk.Item[6]
        rem = False
        bloc = LigTk.Item[8]
        
        While Not IsNull(LigTk.Item)
            If LigTk.Item[8] <> bloc Then
              LigTk.MovePrevious() 'on revient sur la dernière ligne du bloc
              Break
            Endif
            If LigTk.Item[5] = "S" Then
              'on applique la remise
              rem = True
              Pu = LigTk.Item[3]
              Tot = LigTk.Item[6]
              'mttc = Val(Utils.cpoint(LigTk.Item[11])) * Abs(Val(Utils.cpoint(LigTk.Item[4])))
            Else If LigTk.Item[5] = "T" 'total qte
              'btot = True
            Else If LigTk.Item[5] = "O" 'eco taxe / copie privé
              'do nothing
            Else If LigTk.Item[5] = "A" 'article lui-meme
              'do nothing
            Else
              Message("Unsupported line: " & LigTk.Item[5], "OK")
            Endif
            Ligtk.MoveNext()
          Wend

          TotalTk.Text = Format$(Val(Utils.cpoint(TotalTk.Text)) + (Val(Utils.cpoint(pu)) * Abs(Val(Utils.cpoint(quantite)))), "0.00")
          Totalht = Val(Utils.cpoint(Totalht)) + Val(Utils.cpoint(Tot))
          Totalht = Format$(Totalht, "0.00")

      Endif
 
      LigTk.MoveNext()
 
    Endif
  Next
  Mticket.Text = TotalTk.text
  Rticket.text = TotalTk.Text

End



Public Sub Ligtk_Delete()

  Dim Block, $Block As String
  Dim numl As Integer

  If ColumnView1.count = 0 Then
    If message.Question("Voulez-vous supprimer cette ligne ?\nLes lignes de remise sur total seront également supprimées.", "Oui", "Non") = 1 Then
      Ligtk.MoveFirst()
      Repeat
        If LigTk.Item.Selected = True Then
          If LigTk.Item[2] = "***  Ticket retrocession  ***" Then bretro = False
          If LigTk.Item[2] = "***  Ticket modif reglement  ***" Then bmodifregl = False
          Try Block = LigTk.Current[8]
          Repeat
            Try LigTk.item.Selected = True
            If Not Error Then
              If Val(LigTk.Item[8]) = Val(Block) Then
                If LigTk.Current[5] = "BL" Then
                  Utils.db.Exec("Update " & Cbase.Table("TabBl") & " set numtick = &1 where numbl = &2", Null, LigTk.Current[7])
                Endif
                LigTk.current.delete
                Ligtk.MoveFirst()
                Try LigTk.Item.Selected = True
              Else
                Try Ligtk.MoveNext()
              Endif
            Endif
            Try $Block = LigTk.Item[8]
            If Error Then Break
          Until Val(LigTk.Item[8]) > Val(Block)
          Break
        Endif
      Until Ligtk.MoveNext()

      'on recalcul sans remise et on renomme les lignes
      Valid_Remtot("0")

      'On recalcule le total du ticket
      Recalc_Tottk()
      
      Cart.Text = ""
      Qte.Text = "1"
      Remise.Text = "0,00"
      iRem = 0
      iremq = 0
      ibarre = 0
      iqte = 0
      TextLabel7.Visible = False
      Remise.Visible = False
      Cart.SetFocus
      Cart.Select
      Zone = "Article"
      
    Endif
  Else
    Message.Warning("Suppression impossible, un règlement a été saisi !")
  Endif
Catch

End

Public Sub RenameLigne()

  Dim nlig As Integer = 1

  LigTk.MoveFirst()
  Repeat
    Try LigTk.item.Selected = True
    If Not Error Then
      If Not IsNull(LigTk.Current[0]) Then
        LigTk.Current[0] = nlig
        iNlg = nlig
        Inc nlig
      Endif
    Endif
  Until LigTk.MoveNext()
  
  iNlg = nlig - 1


End

Public Sub Button38_Click()

  Select Case Zone
    Case "Design"
      Pvttc.SetFocus
      Pvttc.Select
      Zone = "Pvttc"

    Case "Qte"
      Valid_Qte()
      Cart.SetFocus()

    Case "Commentaire"
      Valid_commentaire()
      Cart.SetFocus()

    Case "Article"
      Valid_Cart()

    Case "Remise"
      Valid_Remise()

    Case "Pvttc"
      TestPvttc()
  End Select

End

Public Sub Button39_Click()

  Select Case Zone
    Case "Especes"
      Valid_Especes()

    Case "Carte"
      Valid_Carte()

    Case "Cheque"
      Valid_Cheque()

    Case "Chequecad"
      Valid_Chequecad()

    Case "Credit"
      Valid_Credit()

    Case "Bachat"
      Valid_Bachat()

    Case "Bacompte"
      Valid_Bacompte()

    Case "Bavoir"
      Valid_Bavoir()

    Case "Bonus"
      Valid_Bonus()

    Case "Breduc"
      Valid_Breduc()

    Case "Tresto"
      Valid_Tresto()

  End Select

End

Public Sub Button41_Click()

  Valid_Nticket()

End

Public Sub Button43_Click()

  If Not IsNull(Zone) Then
    If Zone = "Especes" Then
      Especes.Text = ""
    Endif
    If Zone = "Carte" Then
      Carte.Text = ""
    Endif
    If Zone = "Especes" Then
      Especes.Text = ""
    Endif
    If Zone = "Credit" Then
      Credit.Text = ""
    Endif
    If Zone = "Bachat" Then
      Bachat.Text = ""
    Endif
    If Zone = "Chequecad" Then
      Chequecad.Text = ""
    Endif
    If Zone = "Bavoir" Then
      Bavoir.Text = ""
    Endif
    If Zone = "Bonus" Then
      Bonus.Text = ""
    Endif
    If Zone = "Breduc" Then
      Breduc.Text = ""
    Endif
    If Zone = "Tresto" Then
      Breduc.Text = ""
    Endif
    If Zone = "Bacompte" Then
      Bacompte.Text = ""
    Endif
    If Zone = "Remtot" Then
      Bacompte.Text = ""
    Endif
  Endif

End

Public Sub Button44b_click()

  If Not IsNull(Zone) Then
    If Zone = "Nmc3" Then
      Nmc3.Text = ""
    Endif
    If Zone = "Especes2" Then
      Especes2.Text = ""
    Endif
  Endif

End

Public Sub Button46_click()

  If Not IsNull(RemTot.text) Then
    Valid_Remtot(RemTot.text)
  Else
    Frame1.visible = False
  Endif

End

Public Sub Button47_Click()

  Nmc4.Text = Nmc4.text & "\n"
  $saisie = Nmc4.Text

End

Public Sub Button50_Click()

  Zone = "Nticket"

End

Public Sub Entree_Click()

  Select Case Zone

    Case "Article"
      If iComm = 1 Then
        Valid_commentaire()
      Else
        Valid_Cart()
      Endif
      Stop Event

    Case "Design"
      Pvttc.SetFocus
      Pvttc.select
      Stop Event

    Case "Pvttc"
      bFam = False
      TestPvttc()
      Stop Event

    Case "Qte"
      Valid_Qte()
      Stop Event

    Case "Remise"
      Valid_Remise()
      Stop Event

    Case "Nticket"
      Valid_Nticket()
      Stop Event
  End Select

  If Zone = "Mdp" Then
    Valid_Mdp()
  Endif

  If Zone = "Nmc3" Then
    Especes2.SetFocus
  Endif
  $saisie = ""

End

Public Sub Panel12_KeyPress()

  If zone = "Qte" Then Qte.Text = Qte.Text & Key.code

End

Public Sub Efface_Click()

  If Zone = "Mdp" Then
    Mdp.text = ""
  Endif

  If Zone = "Article" Then
    Cart.Text = ""
  Endif

  If Zone = "Design" Then
    Design.Text = ""
  Endif

  If Zone = "Qte" Then
    Qte.Text = "1"
  Endif

  If Zone = "Pvttc" Then
    Pvttc.Text = "0,00"
  Endif

  If zone = "Commentaire" Then
    Cart.Text = ""
  Endif

  If zone = "Remise" Then
    Remise.Text = "0,00"
    irem = 0
  Endif

  If zone = "Especes" Then
    Especes.Text = "0,00"
  Endif

  If zone = "Carte" Then
    Carte.Text = "0,00"
  Endif

  If zone = "Cheque" Then
    Cheque.Text = "0,00"
  Endif

  If zone = "Tresto" Then
    Tresto.Text = "0,00"
  Endif

  If zone = "Credit" Then
    Credit.Text = "0,00"
  Endif

  If zone = "Bachat" Then
    Bachat.Text = "0,00"
  Endif

  If zone = "Chequecad" Then
    Chequecad.Text = "0,00"
  Endif

  If zone = "Bavoir" Then
    Bavoir.Text = "0,00"
  Endif

  If zone = "Bonus" Then
    Bonus.Text = "0,00"
  Endif

  If zone = "Bacompte" Then
    Bacompte.Text = "0,00"
  Endif

  If zone = "Breduc" Then
    Breduc.Text = "0,00"
  Endif

  If zone = "Nmc" Then
    Nmc.Text = ""
  Endif

  If zone = "Nmc2" Then
    Nmc2.Text = ""
  Endif

  If zone = "Nmc3" Then
    Nmc3.Text = ""
  Endif

  If Zone = "Especes2" Then
    Especes2.Text = "0,00"
  Endif

  If zone = "Remtot" Then
    RemTot.Text = "0,00"
  Endif

  If zone = "Nticket" Then
    Nticket.Text = ""
  Endif

  If zone = "Nmc4" Then
    Nmc4.Text = "0,00"
  Endif

  $saisie = ""

End

Public Sub Clav_click()

  If Zone = "Mdp" Then
    alpha()
    Mdp.text = $saisie
  Endif

  If Zone = "Article" Then
    Alpha()
    Cart.Text = $saisie
  Endif

  If Zone = "Design" Then
    Alpha()
    Design.Text = $saisie
  Endif

  If Zone = "Qte" Then
    Numerique()
    Qte.Text = $saisie
  Endif

  If Zone = "Pvttc" Then
    Numerique()
    Pvttc.Text = $saisie
  Endif

  If zone = "Commentaire" Then
    Alpha()
    Cart.Text = $saisie
  Endif

  If zone = "Remise" Then
    Alpha()
    Remise.Text = $saisie
    irem = 0
  Endif

  If zone = "Especes" Then
    Numerique()
    Especes.Text = $saisie
  Endif

  If zone = "Carte" Then
    Numerique()
    Carte.Text = $saisie
  Endif

  If zone = "Cheque" Then
    Numerique()
    Cheque.Text = $saisie
  Endif

  If zone = "Tresto" Then
    Numerique()
    Tresto.Text = $saisie
  Endif

  If zone = "Credit" Then
    Numerique()
    Credit.Text = $saisie
  Endif

  If zone = "Bachat" Then
    Numerique()
    Bachat.Text = $saisie
  Endif

  If zone = "Chequecad" Then
    Numerique()
    Chequecad.Text = $saisie
  Endif

  If zone = "Bavoir" Then
    Numerique()
    Bavoir.Text = $saisie
  Endif

  If zone = "Bonus" Then
    Numerique()
    Bonus.Text = $saisie
  Endif

  If zone = "Bacompte" Then
    Numerique()
    Bacompte.Text = $saisie
  Endif

  If zone = "Breduc" Then
    Alpha()
    Breduc.Text = $saisie
  Endif

  If zone = "Nmc" Then
    Alpha()
    Nmc.Text = $saisie
  Endif

  If zone = "Nmc2" Then
    Alpha()
    Nmc2.Text = $saisie
  Endif

  If zone = "Nmc3" Then
    Alpha()
    Nmc3.Text = $saisie
  Endif

  If Zone = "Especes2" Then
    Numerique()
    Especes2.Text = $saisie
  Endif

  If zone = "Remtot" Then
    Numerique()
    RemTot.Text = $saisie
  Endif

  If zone = "Nticket" Then
    Numerique()
    Nticket.Text = $saisie
  Endif

  If zone = "Nmc4" Then
    Alpha()
    Nmc4.Text = $saisie
  Endif

End

Public Sub Numerique()

  If Len(Last.name) = 2 Then
    $saisie = $saisie & Right$(Last.name, 1)
  Else
    If Last.name = "Point" Then
      $saisie = $saisie & "."
    Else
      If Last.name = "Efface" Then
        $saisie = Left$($saisie, Len($saisie) - 1)
      Endif
    Endif
  Endif

End

Public Sub Alpha()

  If Len(Last.name) = 1 Then
    $saisie = $saisie & Last.name
  Else
    If Len(Last.name) = 2 Then
      $saisie = $saisie & Right$(Last.name, 1)
    Else
      If Last.name = "Point" Then
        $saisie = $saisie & "."
      Else
        If Last.name = "Etoile" Then
          $saisie = $saisie & "*"
        Else
          If Last.name = "Espace" Then
            $saisie = $saisie & " "
          Else
            If Last.name = "Efface" Then
              $saisie = Left$($saisie, Len($saisie) - 1)
            Else
              If Last.name = "Entree" Then
                If zone = "Nmc4" Then $saisie = $saisie & Chr$(13) & Chr$(10)
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  Endif

End

Public Sub Button48_Click()

  Nticket.Clear
  Frame6.Visible = False

End

Public Sub Button49_Click()

  Nmc4.Clear
  Nmc5.Clear
  Nmc6.Clear
  Frame7.Visible = False

End

Public Sub Button52_Click()

  Nmc.Clear
  Frame3.Visible = False

End

Public Sub ClavFam()

  If Not Panel17.visible Then
    Panel17.Visible = True
    Cart.SetFocus
  Else
    Fermer2()
  Endif

End

Public Sub Clav2_Click()

  Touche_P = Last.name
  If ToucheS[Last.Tag] = 0 Or If IsNull(ToucheS[Last.Tag]) Then
    If Last.tag <> 105 Then
      If Upper$(Last.text) = "REMISE %" Then
        If Not IsNull(Cart.text) Then
          Button3_Click()
        Else
          Message.Warning("Veuillez saisir un produit avant d'effectuer une remise en %")
        Endif
      Else
        If Upper$(Last.text) = "APPEL QTE" Then
          iqte = True
          If Pvttc.text <> "0,00" Then
            TestPvttc()
          Else
            Message.Warning("Veuillez saisir un produit avant d'affecter une remise en % SVP !")
            Pvttc.setfocus
            Pvttc.select
          Endif
        Else
          If Upper$(Last.Text) = "FACTURETTE" Then
            Button26_Click()
          Else
            If Upper$(Last.Text) = "REMISE\nSUR TOTAL" Then
              Panel17.Visible = False
              Button33_Click()
            Else
              If Not IsNull(ToucheS[Last.Tag]) Then
                Raz()
                Cart.Text = codeA[Last.Tag]
                Valid_Cart()
                If iart = 0 Then
                  Qte.text = 1
                  bFam = True
                  iModif = 1
                  If Pvttc.text <> "0,00" Then
                    Qte.setfocus
                    Qte.select
                  Else
                    Pvttc.setfocus
                    Pvttc.Select
                  Endif
                  Famille = Cart.Text
                  Zone = "Pvttc"
                Endif
              Else
                iart = 0
                Raz()
                Cart.SetFocus
              Endif
            Endif
          Endif
        Endif
      Endif
    Else
      If Pan Then
        hpan.Delete
        Pan = False
        'Panel17.Visible = False
        'Raz()
        Cart.SetFocus
        Zone = "Article"
      Else
        Panel17.Visible = False
        'Raz()
        Cart.SetFocus
        Zone = "Article"
      Endif
    Endif
  Else
    Raz()
    createPanel()
    hpan.visible = True
    Cbutton(Panel17)
    Init2()
  Endif

End

Public Sub Clav3_Click()

  Dim DesignA As String

  Touche_P = Last.name
  If Upper$(Last.text) = "REMISE %" Then
    If Not IsNull(Cart.text) Then
      Button3_Click()
    Else
      Message.Warning("Veuillez saisir un produit avant d'effectuer une remise en %")
    Endif
  Else
    If Upper$(Last.text) = "APPEL QTE" Then
      iqte = True
      If Pvttc.text <> "0,00" Then
        TestPvttc()
      Else
        Message.Warning("Veuillez saisir un produit avant d'affecter une remise en % SVP !")
        Pvttc.setfocus
        Pvttc.select
      Endif
    Else
      If Upper$(Last.Text) = "FACTURETTE" Then
        Button26_Click()
      Else
        If Not IsNull(Last.text) Then
          Cart.Text = codeA[Last.Tag]
          DesignA = Last.text
          Design.Text = Replace$(DesignA, "\n", " ")
          Qte.text = 1
          If Upper$(Last.Text) = "REMISE\nSUR TOTAL" Then
            Panel17.Visible = False
            Button33_Click()
          Else
            Raz()
            Cart.Text = codeA[Last.Tag]
            Valid_Cart()
            If iart = 0 Then
              Qte.text = 1
              bFam = True
              iModif = 1
              If Pvttc.text <> "0,00" Then
                Qte.setfocus
                Qte.select
              Else
                Pvttc.setfocus
                Pvttc.Select
              Endif
              Famille = Cart.Text
              Zone = "Pvttc"
            Else
              iart = 0
              Raz()
              Cart.SetFocus
            Endif
          Endif
        Else
          Raz()
        Endif
      Endif
    Endif
  Endif

End

Public Sub Fermer2()

  Panel17.Visible = False
  Cart.setfocus

End

Public Sub Entree2_Click()

End

Public Sub F1_Click()

  Doc.Open("Laurux.PosIndexParCategories")
  
End

Public Sub F2_Click()

  Button6_Click()

End

Public Sub Echap_Click()

  If ColumnView1.count <> 0 Then
    If message.Question("Attention ! Un réglement a été saisi. Sortir de la saisie des réglements va supprimer le ticket.\nQue voulez-vous faire ?\n 1- Continuer la saisie et modifier les règlements,\n 2- Sortir et supprimer le ticket.", "1 ", "2 ") = 1 Then
      Return
    Else
      Button9_Click()
      Init_Reg()
    Endif
  Endif

  Select Case Zone

    Case "Article"
      Photos_MouseDown()
      Zone = "Article"

    Case "Remise"
      Tbrem.Clear
      Tbrem.Visible = False
      Zone = "Article"

    Case "Remtot"
      Frame1.Visible = False
      Cart.SetFocus
      Zone = "Article"

    Case "Nmc"
      Frame3.Visible = False
      iavoir = 0
      Cart.SetFocus
      Zone = "Article"

    Case "Especes"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Carte"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Cheque"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Tresto"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Credit"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Bachat"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Chequecad"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Bavoir"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Bonus"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Bacompte"
      init_paiement()
      Cacomptes.Visible = False
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Breduc"
      init_paiement()
      inpm.SetFocus()
      Zone = "Inpm"

    Case "Nmc2"
      Nmc2.Clear
      Frame4.Visible = False
      init_paiement()
      Inpm.SetFocus
      Zone = "Inpm"

    Case "Nmc3"
      Frame5.Visible = False
      MvtHV_Sortie.Value = True
      AcomptesE.Value = False
      Nmc3.Clear
      'If IsNull(Especes2.Text) Then mvt = ""
      Especes2.Clear
      'If mvt = "E" Then
      '  Inpm.SetFocus
      '  Zone = "Inpm"
      'Else
      Cart.SetFocus
      Zone = "Article"
      'Endif

    Case "Espece2"
      If Key.code = Key.Esc Or If Key.code = Key.F1 Or If Key.code = Key.F2 Or If Key.code = Key.F3 Then
        Frame5.Visible = False
        Nmc3.Clear
        Especes2.Clear
        'If mvt = "E" Then
        '  Inpm.SetFocus
        '  Zone = "Inpm"
        'Else
        Cart.SetFocus
        Zone = "Article"
        'Endif
      Endif

    Case "Nticket"
      Frame6.Visible = False
      Nticket.Clear
      Cart.SetFocus
      Zone = "Article"

    Case "Nmc4"
      Frame7.Visible = False
      Nmc4.Clear
      impressionbon("")
      Cart.SetFocus
      Zone = "Article"

    Case "Mdp"
      Frame8.Visible = False
      Cart.SetFocus
      Zone = "Article"

      'Case "Reglt"
      ' Button6_Click()
      'Cart.SetFocus
      'Zone = "Article"

    Case Else
      If Frame2.Visible Then
        Frame2.visible = False
        Cart.SetFocus
        Zone = "Article"
      Endif
  End Select

End

Public Sub createPanel()

  hpan = New Panel(Panel17)
  hpan.W = Panel17.w
  hpan.H = Panel17.H - 50
  hpan.x = 0
  hpan.Y = 0
  hpan.border = Border.Etched
  hpan.Background = Color.Background
  hpan.visible = False

End

'****************************************************
'*      Création des boutons des sous-familles      *
'****************************************************
Public Sub Cbutton(oObj As Object)

  Dim hClass As Object

  For Each hClass In oObj.Children
    If hClass.Tag And If hClass Is ImageButton Then
      Hbutton = New (ImageButton, hpan) As "Clav3"
      hbutton.Name = Touche_P & "B" & Right$(hClass.Name, Len(hClass.name) - 1)
      hbutton.W = hClass.w
      hbutton.H = hClass.H
      hbutton.x = hClass.x
      hbutton.Y = hClass.y
      hbutton.Tag = 35 + hClass.tag
    Endif
  Next
  Pan = True

End

Public Sub Init2()

  Dim rTch As Result
  Dim i As Integer
  Dim t As String = "B"
  Dim sf As Boolean = False

  For i = 36 To 71
    t = "B" & i
    Try btn = Me.Controls[t]
    Try btn.Text = ""
  Next
  i = Len(Touche_P)
  rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " where cai = &1 order by touche", Ncaisse)
  If rTch.Available Then
    Repeat
      If Left(rTch!touche, i) = Touche_p And Mid(rTch!touche, i + 1, 1) = "B" Then
        Try Me.Controls[rTch!touche].Name = rTch!touche
        If Not Error Then
          Btn = Me.Controls[rTch!touche]
          btn.Text = rTch!libelle
          CodeA[btn.tag] = rTch!code
          Try Btn.Background = rTch!coul
          Try btn.Picture = Picture[rTch!fond]
          sf = True
        Endif
      Endif
    Until rTch.MoveNext()
  Endif
  If Not sf Then
    hpan.Delete
    Pan = False
    Message.Info("Il n'existe aucune sous-famille pour ce bouton !")
  Endif

End

Public Sub KeyObserver_Keypress()
  
  If Key.Code = Key.F11 Then
    If Me.FullScreen Then
      Me.FullScreen = False
    Else
      Me.FullScreen = True
      Me.Center()
    Endif
  Endif
  
End
