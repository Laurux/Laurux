' Gambas class file

Private $resreg As Result
Private $snumed As String[]
Private $tabl As Collection

Public Sub _new(tabl As Collection, mois As String, anne As String, edit As Boolean)

  Dim ressoc, respar, res As Result
  Dim i As Integer
  Dim dte1, dte2 As Date
  
  $tabl = tabl
  $snumed = New String[]
  For Each Caleditcmat.ddcl In tabl
    $snumed.Add(tabl.Key)
  Next
  ReportHlig.DataCount = $snumed.Count
'  ReportHss.DataCount = $snumed.Count
  ReportHBox14.DataCount = $snumed.Count
  datej.Text = Format(Now, "dd/mm/yyyy")
  datj1.Text = Format(Now, "dd/mm/yyyy")
  datj2.Text = Format(Now, "dd/mm/yyyy")
  pg1.Text = "Page : " & Me.PageCount
  ressoc = Utils.db.Exec("SELECT * FROM Fiches_Societes")
  rs.Text = ressoc!type_sc & " " & ressoc!int_sc
  
  respar = Utils.db.Exec("SELECT * FROM Fiches_Parametres")
  If respar!arrete Then
    dtedeb.Text = "  " & respar!arrete
    dte1 = Date(Right(respar!arrete, 4), Val(Left(respar!arrete, 2)), 1)
    dte1 = DateAdd(dte1, gb.Month, 1)
    dte2 = DateAdd(dte1, gb.Month, 11)
    Reportnom.Text = ressoc!type_sc & " " & ressoc!int_sc & " " & "Exercice du : " & Format(Month(dte1), "00") & "/" & Format(Year(dte1), "0000") & " au : " & Format(Month(dte2), "00") & "/" & Format(Year(dte2), "0000")
  Endif
  ni.Text = ressoc!ident
  lieu.Text = ressoc!burdis_sc
  adr1.Text = ressoc!adr1_sc
  adr2.Text = ressoc!adr2_sc
  cpvil.Text = ressoc!cp_sc & " " & ressoc!burdis_sc 
  dte1 = Date(anne, Val(mois), 1)
  dte2 = Date(anne, Val(mois), Utils.lastday(dte1))
  res = Utils.db.Exec("SELECT vignette FROM Fiches_ligregie WHERE dtmouv BETWEEN &1 AND &2 AND cloture=&3 AND vignette IS NOT NULL ORDER BY vignette", Format(dte1, "yyyymmdd"), Format(dte2, "yyyymmdd"), edit)
  If res.Available Then
    res.MoveFirst
    vignette.Text = res!vignette & " à  "
    res.MoveLast
    vignette.Text &= res!vignette
  Endif
  dtedecl.Text = Format(dte1, "mmmm yyyy")
  periode.Text = mois & "/" & anne
  
  'ReportPageBreak1.ForceNewPage = True
  

  Application.Busy = 0


End

Public Sub lib_Data(Index As Integer)

  Dim res As Result
  
  res = Utils.db.Exec("SELECT * FROM Fiches_regie WHERE code=&1", $snumed[Index])
  lib.Font = font["-4"]
  lib.Data = res!nom

End

'vae debut de péridode
Public Sub vaehldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaehldp.Font = font["-4"]
  vaehldp.Data = convers(Caleditcmat.ddcl.totvol.vae.vdp, "h")
  
End

Public Sub vaeldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaeldp.Font = font["-4"]
  vaeldp.Data = convers(Caleditcmat.ddcl.totvol.vae.vdp, "l")

End

Public Sub vaecldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaecldp.Font = font["-4"]
  vaecldp.Data = convers(Caleditcmat.ddcl.totvol.vae.vdp, "c")

End

'vae entrée
Public Sub vaehle_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaehle.Font = font["-4"]
  vaehle.Data = convers(Caleditcmat.ddcl.totvol.vae.ven, "h")
  
End

Public Sub vaele_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaele.Font = font["-4"]
  vaele.Data = convers(Caleditcmat.ddcl.totvol.vae.ven, "l")

End

Public Sub vaecle_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaecle.Font = font["-4"]
  vaecle.Data = convers(Caleditcmat.ddcl.totvol.vae.ven, "c")

End

'vae sortie
Public Sub vaehls_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaehls.Font = font["-4"]
  vaehls.Data = convers(Caleditcmat.ddcl.totvol.vae.vso, "h")
  
End

Public Sub vaels_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaels.Font = font["-4"]
  vaels.Data = convers(Caleditcmat.ddcl.totvol.vae.vso, "l")

End

Public Sub vaecls_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaecls.Font = font["-4"]
  vaecls.Data = convers(Caleditcmat.ddcl.totvol.vae.vso, "c")

End

'vae fin de période
Public Sub vaehlfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaehlfp.Font = font["-4"]
  vaehlfp.Data = convers(Caleditcmat.ddcl.totvol.vae.vfp, "h")
  
End

Public Sub vaelfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaelfp.Font = font["-4"]
  vaelfp.Data = convers(Caleditcmat.ddcl.totvol.vae.vfp, "l")

End

Public Sub vaeclfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaeclfp.Font = font["-4"]
  vaeclfp.Data = convers(Caleditcmat.ddcl.totvol.vae.vfp, "c")

End

'vap debut période
Public Sub vaphldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaphldp.Font = font["-4"]
  vaphldp.Data = convers(Caleditcmat.ddcl.totvol.vap.vdp, "h")
  
End

Public Sub vapldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapldp.Font = font["-4"]
  vapldp.Data = convers(Caleditcmat.ddcl.totvol.vap.vdp, "l")

End

Public Sub vapcldp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapcldp.Font = font["-4"]
  vapcldp.Data = convers(Caleditcmat.ddcl.totvol.vap.vdp, "c")

End

'vap entrée
Public Sub vaphle_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaphle.Font = font["-4"]
  vaphle.Data = convers(Caleditcmat.ddcl.totvol.vap.ven, "h")
  
End

Public Sub vaple_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaple.Font = font["-4"]
  vaple.Data = convers(Caleditcmat.ddcl.totvol.vap.ven, "l")

End

Public Sub vapcle_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapcle.Font = font["-4"]
  vapcle.Data = convers(Caleditcmat.ddcl.totvol.vap.ven, "c")

End

'vap sortie
Public Sub vaphls_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaphls.Font = font["-4"]
  vaphls.Data = convers(Caleditcmat.ddcl.totvol.vap.vso, "h")
  
End

Public Sub vapls_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapls.Font = font["-4"]
  vapls.Data = convers(Caleditcmat.ddcl.totvol.vap.vso, "l")

End

Public Sub vapcls_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapcls.Font = font["-4"]
  vapcls.Data = convers(Caleditcmat.ddcl.totvol.vap.vso, "c")

End

'vap fin de période
Public Sub vaphlfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaphlfp.Font = font["-4"]
  vaphlfp.Data = convers(Caleditcmat.ddcl.totvol.vap.vfp, "h")
  
End

Public Sub vaplfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vaplfp.Font = font["-4"]
  vaplfp.Data = convers(Caleditcmat.ddcl.totvol.vap.vfp, "l")

End

Public Sub vapclfp_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  vapclfp.Font = font["-4"]
  vapclfp.Data = convers(Caleditcmat.ddcl.totvol.vap.vfp, "c")

End

Public Sub qihl_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qihl.Font = font["-4"]
  qihl.Data = convers(Caleditcmat.ddcl.qteimp, "h")

End

Public Sub qil_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qil.Font = font["-4"]
  qil.Data = convers(Caleditcmat.ddcl.qteimp, "l")

End

Public Sub qicl_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qicl.Font = font["-4"]
  qicl.Data = convers(Caleditcmat.ddcl.qteimp, "c")

End

Public Sub tarif_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  tarif.Font = font["-4"]
  tarif.Data = Format(Caleditcmat.ddcl.tarifdr, "0.0000")

End

Public Sub montant_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  montant.Font = font["-3"]
  montant.Data = Format(Caleditcmat.ddcl.droit, "0.00")

End

Public Sub ReportLlibss_Data(Index As Integer)

  If index = 0 Then ReportLlibss.Data = "Sécurité Sociale (taux en litre)" Else ReportLlibss.Data = " "

End

Public Sub qihlss_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qihlss.Font = font["-4"]
  qihlss.Data = convers(Caleditcmat.ddcl.volumess, "h")

End

Public Sub qilss_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qilss.Font = font["-4"]
  qilss.Data = convers(Caleditcmat.ddcl.volumess, "l")

End

Public Sub qiclss_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  qiclss.Font = font["-4"]
  qiclss.Data = convers(Caleditcmat.ddcl.volumess, "c")

End

Public Sub tarifss_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  tarifss.Font = font["-4"]
  tarifss.Data = Format(Caleditcmat.ddcl.tarifss, "0.0000")

End

Public Sub montss_Data(Index As Integer)

  Caleditcmat.ddcl = $tabl[$snumed[Index]]
  montss.Font = font["-4"]
  montss.Data = Format(Caleditcmat.ddcl.secu, "0.00")

End

Public Sub vaehldp2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vae.vdp
  Next

  vaehldp2.Data = convers(tot, "h")
  vaeldp2.Text = convers(tot, "l")
  vaecldp2.Text = convers(tot, "c")
  
End

Public Sub vaehle2_Data(Index As Integer)

  Dim tot As Float

  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vae.ven
  Next

  vaehle2.Data = convers(tot, "h")
  vaele2.Text = convers(tot, "l")
  vaecle2.Text = convers(tot, "c")
  
End

Public Sub vaehls2_Data(Index As Integer)

  Dim tot As Float

  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vae.vso
  Next

  vaehls2.Data = convers(tot, "h")
  vaels2.Text = convers(tot, "l")
  vaecls2.Text = convers(tot, "c")
  
End

Public Sub vaehlfp2_Data(Index As Integer)

  Dim tot As Float

  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vae.vfp
  Next

  vaehlfp2.Data = convers(tot, "h")
  vaelfp2.Text = convers(tot, "l")
  vaeclfp2.Text = convers(tot, "c")
  
End

Public Sub vaphldp2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vap.vdp
  Next

  vaphldp2.Data = convers(tot, "h")
  vapldp2.Text = convers(tot, "l")
  vapcldp2.Text = convers(tot, "c")
  
End

Public Sub vaphle2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vap.ven
  Next

  vaphle2.Data = convers(tot, "h")
  vaple2.Text = convers(tot, "l")
  vapcle2.Text = convers(tot, "c")
  
End

Public Sub vaphls2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vap.vso
  Next

  vaphls2.Data = convers(tot, "h")
  vapls2.Text = convers(tot, "l")
  vapcls2.Text = convers(tot, "c")
  
End

Public Sub vaphlfp2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.totvol.vap.vfp
  Next

  vaphlfp2.Data = convers(tot, "h")
  vaplfp2.Text = convers(tot, "l")
  vapclfp2.Text = convers(tot, "c")
  
End

Public Sub montant2_Data(Index As Integer)

  Dim tot As Float
  
  For Each Caleditcmat.ddcl In $tabl
    tot += Caleditcmat.ddcl.droit + Caleditcmat.ddcl.secu
  Next
  montant2.Data = Format(tot, "0.00")
  
End

Private Function convers(vol As Float, choix As String) As String
  
  Dim f As Float
  
  Select Case choix
    Case "h"
      vol = vol / 100
      vol = Fix(vol)
    Case "l"
      If Abs(vol) < 100 Then
        vol = Fix(vol)
      Else
        f = Abs(vol / 100)
        f = Round(Fix(f) * 100)
        f = Abs(vol) - f
        vol = Fix(f)
      Endif
    Case "c"
      vol = Round(vol, -2)
      vol = Frac(vol)
      vol = Round(vol * 100)
  End Select
  If vol = 0 Then
    Return "  "
  Else
    Return Str(vol)
  Endif
End
