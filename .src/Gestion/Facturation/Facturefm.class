' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'################################################
'# nom du fichier           : Facturefm.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/09/2007
'# Facturation fin de mois
'################################################
'

son As Integer = Start.Son
b As Integer
'Tab As String
'Tab2 As String
rResult As Result
CblRslt As Result
numbl As Result
Nfac As String
Jnl As String
cpt As String
Intit As String
numecr As String
numr As Integer
numrd As Integer
numr2 As Integer ' numero ecriture définitif
cptRem As String
Ctva As String
Ctx As String
cpttva As String
IntitTva As String
Txtleg As String
Txtleg2 As String
numeroFac As String
Remmo As String
Remart As String
Mgart As String ' Montant marge article
Mgmo As String ' Montant marge mo
Ttva As Float
dateech As String
Filename As String
jour As String
Nbl As Integer
Nlgn As String
Totalmo As String
Totalart As String
Totalrem As String
totalht As String
Totht As String
typeL As String
Fam As String
Ardi As String
nbdec As String
Totttc As String
Brutht As String
Rem As String
TotEuros As String = "0"
nom As String
Mttc As String
adr211 As String
adr222 As String
numbonl As String
intituleb As String
Bonl As Result
dtex As String
dte As String
Devises As String
PosY As Integer
Visudoc As Boolean
Coulfond As New String[]
Private ty As String
Private scourriel As String
Private spiece As String
Private sclient As String
Private nmclient As String
Private sclient2 As String
Public Bsel As Boolean = False
Public Cclient As String
Private Ccli As String
Private dateech2 As String
Private pdf As Object
Private Rs2 As String
Private Vic As String
Private Vichq As String
Private Viautre As String
Private Cptreglt As String
Private Reglmt As String
Private Prxdec As Boolean = Start.LocalSettings["/Soc" & Start.Societe & "/Prxdec"]
Private Codecli As String
Private NomCli As String
Private adr1 As String
Private adr2 As String
Private cpcli As String
Private villecli As String
Private bnumfac As Boolean = False
Private Liste As Boolean = False
Private $soption As String
Private $sreq As String
Private $obs As Observer
Private frais As String = "0"
Private $bl As String = "Fiches_Bl"
Private $process As Boolean = False
Private $ligbl As String = "Fiches_Ligbl"
Private $fac As String = "Fiches_HistoFac"
Private $ligfac As String = "Fiches_HistoLigfac"

'**********************************************************
'*initialisation écrans et gestion onglet client          *
'**********************************************************
Public Sub _New()

  Dim res As Result
  Dim Dppc As Date
  Dim Tab As String = "Fiches_Parametres"
  Dim $lp, $imp As String

  $soption = utils.Option()
  rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If rResult.Available Then
    devises = rResult!devise
    If IsNull(devises) Then devises = "Euros"
  Endif
  Coulfond = Utils.Coulfd()
  Utils.Observers(Me)
  Music.Load(Start.Musique)
  ' On gère les imprimantes
  Shell "lpc status 2>&1" To $imp
  For Each $lp In Split($imp, "\n")
    If Right($lp) = ":" Then Cimp.add(Left($lp, -1))
  Next
  Try Cimp.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Cimp"]
  Me.Center

  Colbl.Columns.count = 6
  Colbl.Columns[0].Width = 80
  Colbl.Columns[1].Width = 150
  Colbl.Columns[2].Width = 60
  Colbl.Columns[3].Width = 120
  Colbl.Columns[4].Width = 100
  Colbl.Columns[0].Text = "Code"
  Colbl.Columns[0].Alignment = 1
  Colbl.Columns[1].Text = "Nom"
  Colbl.Columns[1].Alignment = 1
  Colbl.Columns[2].Text = "Cp"
  Colbl.Columns[2].Alignment = 1
  Colbl.Columns[3].Text = "Ville"
  Colbl.Columns[4].Text = "Total ht"
  Colbl.Columns[4].Alignment = 2
  Colbl.Columns[5].Text = "Total ttc"
  Colbl.Columns[5].Alignment = 2

  Coldetail.Columns.count = 4
  Coldetail.Columns[0].Width = 130
  Coldetail.Columns[1].Alignment = 3
  Coldetail.Columns[2].Alignment = Align.Left
  Coldetail.Columns[1].Width = 150
  Coldetail.Columns[2].Width = 120
  Coldetail.Columns[3].Width = 120
  Coldetail.Columns[0].Text = "N° BL"
  Coldetail.Columns[1].Text = "Date BL"
  Coldetail.Columns[2].Text = "montant HT"
  Coldetail.Columns[2].Alignment = 2
  Coldetail.Columns[3].Text = "montant TTC"
  Coldetail.Columns[3].Alignment = 2

  ' On calcule le dernier jour du mois en cours.
  datej.Text = Format$(Now, "dd.mm.yyyy")
  Dppc = Date(Right$(datej.Text, 4), Mid$(datej.Text, 4, 2), Left$(datej.Text, 2))
  If Month(Dppc) < 12 Then
    datej.Text = Day(Date(Year(dppc), Month(dppc) + 1, 1) - 1) & "." & Mid$(datej.Text, 4, 2) & "." & Right$(datej.Text, 4)
  Else
    datej.Text = Day(Date(Year(dppc) + 1, 1, 1) - 1) & "." & Mid$(datej.Text, 4, 2) & "." & Right$(datej.Text, 4)
  Endif
  datej.SelectAll
  Datej.SetFocus

  If $soption = "B" Or $soption = "T" Then Panel2.Visible = True
  combregr.Add("Sans")
  combregr.Add("Décade")
  combregr.Add("Quinzaine")
  combregr.Add("Mensuel")
  res = utils.db.Exec("SELECT * FROM Fiches_Typec")
  Combocli.Add("Tous")
  If res.Available Then
    res.MoveFirst
    Repeat
      Combocli.Add(res!code & " - " & res!libelle)
    Until res.MoveNext()
  Endif
  res = utils.db.Exec("SELECT * FROM Fiches_Commerciaux")
  Combocom.Add("Tous")
  If res.Available Then
    Repeat
      Combocom.Add(res!code & " - " & res!nom)
    Until res.MoveNext()
  Endif
  Combotyp.Add("Toutes")
  Combotyp.Add("Boissons")
  Combotyp.Add("Autres")
  'gestion des dates
  $obs = New Observer(datej) As "dte"
  $obs = New Observer(datei) As "dte"
  $obs = New Observer(dtef) As "dte"

End

Public Sub Form_Close()

  If $process Then
    If Message.Warning("Il y a une édition en cours : Fermer le programme peut provoquer des dommages sur la base de données \n Voulez vous fermer quand même ?", "Oui", "Non") = 2 Then
      Stop Event
    Else
      If Exist(filename) Then Try Kill filename
    Endif
  Endif
  
End
'**************************
'*  On récupère les BL    *
'**************************
Public Sub recup_bl()

  Dim Tab3 As String
  Dim Tab4 As String
  Dim Client As Result
  Dim Bl As Result
  Dim totf As Result
  Dim Total, totalttc As String
  Dim dteN, dateinf As String
  Dim i As Integer
  Dim orientation As Boolean
  Dim gest As Boolean
  Dim ht, ttc, montfrais As Float
  
  Tab3 = "Facturefm"
  Tab4 = "Bl"
  Total = "0"
  Utils.db.Exec("drop Table IF exists " & Tab3 & "")
  Utils.db.Exec("CREATE TABLE " & Tab3 &
    "(code Char(8) NOT NULL," &
    "nom Char(35)," &
    "cp Char(5)," &
    "adr1 Char(35)," &
    "adr2 Char(35)," &
    "ville Char(35)," &
    "totf Char(12)," &
    "tottc Char(12)," &
    "gestbl Decimal(6,2)," &
    "PRIMARY KEY (code, nom)) " & Utils.db.Engine())
  Utils.db.Exec("drop Table IF exists " & Tab4 & "")
  Utils.db.Exec("CREATE TABLE " & Tab4 &
    "(num Char(12) NOT NULL," &
    "code Char(10)," &
    "nom Char(35)," &
    "date date," &
    "ht Char(12)," &
    "ttc Char(12)," &
    "PRIMARY KEY (num)) " & Utils.db.Engine())
  dteN = Right$(datej.Text, 4) & Mid$(datej.Text, 4, 2) & Left$(datej.Text, 2)
  If Radiobutton1.Value = True Then
    codeclient.Background = &HD4D0C8& '&HF9F9BD&
    Client = Utils.db.Exec("SELECT * FROM " & $bl & " Left join " & Cbase.Table("TabCli") & " on cli_code = cdclibl where (type = &1 or type=&2) and totalht <> &3 and  cli_div = &5 and imp <> &4 and cli_div = &5" & $sreq & " order by cdclibl, numbl", "B", "F", 0, 1, Divers.value)
  Else
    Client = Utils.db.Exec("SELECT * FROM " & $bl & " Left join " & Cbase.Table("TabCli") & " on cli_code = cdclibl where (cdclibl = &1 and type = &2 and totalht <> &4 and datebl <= &5 and cli_div = &7)  or (cdclibl = &1 and type = &3 and totalht <> &4 and datebl <= &5 and imp <> &6 and cli_div = &7)  order by cdclibl, numbl", codeclient.Text, "B", "F", 0, dteN, 1, Divers.value)
  Endif
  If Client.Available Then
    Codecli = Client!cdclibl
    Nomcli = Client!nmclibl
    adr1 = Client!adr1bl
    adr2 = Client!adr2bl
    cpcli = Client!cpbl
    villecli = Client!villebl
    Repeat
      If Divers.value And Codecli <> Client!cdclibl Or If Divers.value And Nomcli <> Client!nmclibl Then
        Nomcli = Client!nmclibl
        adr1 = Client!adr1bl
        adr2 = Client!adr2bl
        cpcli = Client!cpbl
        villecli = Client!villebl
        codecli = Client!cdclibl
        gest = False
        montfrais = 0
      Endif
      If Codecli <> Client!cdclibl Then
        gest = False
        montfrais = 0
        Codecli = Client!cdclibl
      Endif
      If Not Divers.value Then
        totf = Utils.db.Exec("SELECT * FROM " & Tab3 & " WHERE code = &1", Client!cdclibl)
      Else
        totf = Utils.db.Exec("SELECT * FROM " & Tab3 & " WHERE code = &1 and nom = &2", Client!cdclibl, Nomcli)
      Endif
      If totf.Available Then
        Total = Format$(Val(totf!totf) + Val(Utils.cpoint(Client!totalht)), "0.00")
        Totalttc = Format$(Val(totf!tottc) + Val(Utils.cpoint(Client!totalttc)), "0.00")
        ht = Val(Utils.cpoint(Client!totalht))
        ttc = Val(Utils.cpoint(Client!totalttc))
        If Utils.totobs([client!gestbl]) <> 0 Then  'Frais de facture : on empeche les frais de se cumuler => seul le 1° sera pris en compte.
          If gest Then
            Total = Format$(Val(Total) - client!gestbl, "0.00")
            Totalttc = Format$(Val(totalttc) - totfrais(client!gestbl), "0.00")
            ht -= client!gestbl
            ttc -= totfrais(client!gestbl)
          Else
            gest = True
            montfrais = client!gestbl
          Endif
        Endif
        If Not Divers.value Then
          Utils.db.Exec("UPdate " & Tab3 & " SET totf = &1, tottc = &2, gestbl=&4 WHERE code = &3", Total, Totalttc, Client!cdclibl, montfrais)
        Else
          Utils.db.Exec("UPdate " & Tab3 & " SET totf = &1, tottc = &2, gestbl=&5 WHERE code = &3 and nom = &4", Total, Totalttc, Client!cdclibl, Nomcli, montfrais)
        Endif
      Else
        
        Try Total = Format$(Client!totalht, "0.00")
        Try Totalttc = Format$(Client!totalttc, "0.00")
        ht = Client!totalht
        ttc = Client!totalttc
        If Utils.totobs([client!gestbl]) <> 0 Then 
          gest = True
          montfrais = client!gestbl
        Endif
        If Not Divers.value Then
          Utils.db.Exec("INSERT INTO " & Tab3 & " (code, nom, cp, ville, totf, tottc,gestbl) Values (&1, &2, &3,&4,&5, &6, &7)", Client!cdclibl, Client!nmclibl, Client!cpbl, Client!villebl, Total, totalttc, montfrais)
        Else
          Utils.db.Exec("INSERT INTO " & Tab3 & " (code, nom, adr1, adr2, cp, ville, totf, tottc, gestbl) Values (&1, &2, &3,&4,&5, &6, &7, &8, &9)", Client!cdclibl, Nomcli, adr1, adr2, cpcli, villecli, Total, totalttc, montfrais)
        Endif
      Endif
      Total = 0
      Bl = Utils.db.Exec("SELECT * FROM " & $ligbl & " where num_ligbl = &1 order by num_ligbl", Client!numbl)
      If Bl.Available Then
        Utils.db.Exec("INSERT INTO " & Tab4 & " (num, code, nom, date, ht, ttc) Values (&1, &2, &3, &4, &5, &6)", Client!numbl, Client!cdclibl, Nomcli, Client!datebl, Format(ht, "0.00"), Format(ttc, "0.00"))
      Endif
    Until Client.MoveNext()
  Endif
  Client = Utils.db.Exec("SELECT * FROM " & Tab3 & " order by nom")
  If Client.Available Then
    Repeat
      Colbl.Add(Client!code & Client!nom, Client!code & Client!nom)
      Colbl.Item[0] = Client!code
      Colbl.Item[1] = Client!nom
      Colbl.Item[2] = Client!cp
      Colbl.Item[3] = Client!ville
      Colbl.Item[4] = Client!totf
      Colbl.Item[5] = Client!tottc
    Until Client.MoveNext()
    client.MoveFirst
  Endif
  'choix du type de facture à imprimer
  If Combotyp.Current.Text <> "Toutes" And Client.Available Then
    Colbl.MoveFirst
    Repeat
      orientation = utils.orientation(Colbl.Item[0], "FM")
      If (orientation And Combotyp.Current.Text = "Autres") Or (Not orientation And Combotyp.Current.Text = "Boissons") Then
        supclient(Colbl.Item[0], Colbl.Item[1])
      Endif
    Until Colbl.MoveNext()
    affclient
  Endif

End

Private Function totfrais(frs As Float) As Float
  
  Dim res As Result
  
  res = Utils.db.Exec("SELECT tvafrais,taux_tva  FROM Fiches_Parametres,Fiches_Tvaav WHERE tvafrais=code_tva")
  If res.Available Then
    frs = frs * (1 + (res!taux_tva / 100))
    Return frs
  Endif
  
End

Public Sub Colbl_Click()

  Dim Client As Result
  Dim Tab4 As String = "Bl"

  Coldetail.clear
  With Utils
    If Not Colbl.Available Then
      Colbl.clear
    Else
      If Divers.value Then
        Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 and nom = &5 order by num", Colbl.Item[0], "B", "F", 0, Colbl.Item[1])
      Else
        Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 order by num", Colbl.Item[0], "B", "F", 0)
      Endif
      sclient = Colbl.Item[0]
      nmclient = Colbl.Item[1]
      If Client.Available Then
        Repeat
          If Divers.value Then
            Coldetail.Add(Client!num & Client!nom, Client!num & Client!nom)
          Else
            Coldetail.Add(Client!num, Client!num)
          Endif
          Coldetail.Item[0] = Client!num
          Coldetail.Item[1] = .Cdate_Aff(Client!date)
          Coldetail.Item[2] = Format$(Val(.cpoint(Client!ht)), "0.00")
          Coldetail.Item[3] = Format$(Val(.cpoint(Client!ttc)), "0.00")
        Until Client.MoveNext()
      Endif
    Endif
  End With

End

Public Sub Colbl_Keypress()

  If Key.code = Key.Delete And Colbl.Count <> 0 Then
    supclient(sclient, nmclient)
    affclient
  Endif

End

Public Sub supclient(sclient As String, nmclient As String)

  Dim Client As Result
  Dim Tab3 As String = "Facturefm"
  Dim Tab4 As String = "Bl"

  If Divers.value Then
    Utils.db.Exec("delete from " & Tab3 & " WHERE code = &1 and nom = &2", sclient, nmclient)
    Utils.db.Exec("delete from " & Tab4 & " WHERE code = &1 and nom = &2", sclient, nmclient)
  Else
    Utils.db.Exec("delete from " & Tab3 & " WHERE code = &1 ", sclient)
    Utils.db.Exec("delete from " & Tab4 & " WHERE code = &1 ", sclient)
  Endif

End

Public Sub affclient()

  Dim client As Result

  Colbl.Clear
  Coldetail.Clear
  Client = Utils.db.Exec("SELECT * FROM Facturefm order by nom")
  If Client.Available Then
    Repeat
      If Divers.value Then
        Colbl.Add(Client!code & Client!nom, Client!code & Client!nom)
      Else
        Colbl.Add(Client!code, Client!code)
      Endif
      Colbl.Item[0] = Client!code
      Colbl.Item[1] = Client!nom
      Colbl.Item[2] = Client!cp
      Colbl.Item[3] = Client!ville
      Colbl.Item[4] = Client!totf
      Colbl.Item[5] = Client!tottc
    Until Client.MoveNext()
  Endif

End

Public Sub Coldetail_Click()

  sclient2 = Coldetail.Item[0]

End

Public Sub Coldetail_Activate()

  Dim MyForm As AFacture

  MyForm = New AFacture(Coldetail.Item[0], sclient, nmclient, Coldetail.Item[1])
  MyForm.Showmodal()

End

Public Sub Coldetail_Keypress()

  Dim Client As Result
  Dim Totalht, totalttc As String = "0"
  Dim Tab4 As String = "Bl"
  Dim cle As String = Colbl.Key

  With Utils
    If Key.code = Key.Delete And Coldetail.Count <> 0 Then
      Utils.db.Exec("delete from " & Tab4 & " WHERE num = &1 ", sclient2)
    Endif
    If Divers.value Then
      Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 and nom = &2 order by num", sclient, nmclient)
    Else
      Client = Utils.db.Exec("SELECT * FROM " & Tab4 & " where code = &1 order by num", sclient)
    Endif
    Coldetail.Clear
    If Client.Available Then
      Repeat
        Coldetail.Add(Client!num, Client!num)
        Coldetail.Item[0] = Client!num
        Coldetail.Item[1] = .Cdate_Aff(Client!date)
        Coldetail.Item[2] = Format$(Val(.cpoint(Client!ht)), "0.00")
        Coldetail.Item[3] = Format$(Val(.cpoint(Client!ttc)), "0.00")
        Totalht = Format$(Val(.cpoint(Totalht)) + Val(.cpoint(Client!ht)), "0.00")
        Totalttc = Format$(Val(.cpoint(Totalttc)) + Val(.cpoint(Client!ttc)), "0.00")
      Until Client.MoveNext()
    Endif
    Colbl.MoveFirst()
    Repeat
      Colbl.Item.Selected = True
      If Colbl.key = cle Then
        'If Colbl.Item[0] = sclient Then
        Colbl.Item[4] = Totalht
        Colbl.Item[5] = Totalttc
        Colbl_Click()
        Break
      Endif
    Until Colbl.MoveNext()

  End With

End

'**********************************************************
'*  On controle si la date saisie est dans les bornes     *
'**********************************************************

Public Sub Quittedate(datej As TextBox)

  Dim dte2 As String
  Dim dte3 As String
  Dim ye As String
  Dim Tab As String = "Fiches_Parametres"

  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dtex = rResult!dteclec ' On recupere la date de fin d'exercice
  dte = rResult!dtepc
  dte = Utils.Cdate_aff(dte)
  dte3 = Right$(dte, 4) & Left$(dte, 2)
  dte2 = rResult!dteclec1
  dte2 = Utils.Cdate_aff(dte2)
  ye = Right$(dte2, 4)
  Ye = Val(Ye) + 1
  With utils
    datej.text = .Cdate_calc(datej.text)
    datej.Text = .Cdate_aff(datej.Text)
    b = 0
    If datej.Text = "00.00.0:00" Then
      datej.Text = Format$(Now, "dd.mm.yyyy")
      b = 1
      datej.SetFocus
    Else
      dte3 = rResult!dtepp
      dte3 = Right$(dte3, 4) & Left$(dte3, 2)
      If Right$(datej.text, 4) & Mid$(datej.text, 4, 2) < dte3 Then
        If son Then
          Music.Play
        Endif
        If Message.Warning("Attention ! La date saisie est inférieure au début de la période en cours.", "Ok") = 1 Then
          datej.SetFocus
          B = 1
        Endif
      Else
        dte3 = rResult!dtepec
        If Left$(dte3, 2) = "12" Then
          Mid(dte3, 4, 4) = Str(Val(Right(dte3, 4)) + 1)
          Mid(dte3, 1, 2) = "01"
        Else
          Mid(dte3, 1, 2) = Format(Val(Left(dte3, 2)) + 1, "00")
        Endif
        dte3 = Right$(dte3, 4) & Left$(dte3, 2)
        If Right$(datej.text, 4) & Mid$(datej.text, 4, 2) > dte3 Then
          If son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! La date saisie est supérieure à la période en cours.", "Ok") = 1 Then
            datej.SetFocus
            B = 1
          Endif
        Else
        Endif
      Endif
    Endif
    'If Right$(datej.Text, 4) & Mid$(datej.Text, 4, 2) & Left$(datej.Text, 2) < Right$(dtex, 4) & Left$(dtex, 2) & Mid$(dtex, 4, 2) Then
    Try numecr = "numecriture"
    'Else
    'Try numecr = "numecriture1"
    'Endif
  End With

End

Public Sub Button1_KeyPress()

  Button1_Click()

End

Public Sub Button1_Click()

  If $process Then Return
  Colbl.Clear
  Coldetail.Clear
  Quittedate(datej)
  If Not datei.ReadOnly And b = 0 Then Quittedate(datei)
  If B <> 1 Then
    requete()
    recup_bl()
  Else
    b = 0
  Endif

End

Public Sub requete()          'construction de la requete sql

  Dim dteN, dateinf, jour As String
  Dim bcond As Boolean
  Dim d As Integer
  Dim dte As Date

  'gestion des dates
  dteN = Right$(datej.Text, 4) & Mid$(datej.Text, 4, 2) & Left$(datej.Text, 2)
  If combregr.Current.Text = "Sans" Then
    $sreq = utils.db.Subst(" AND datebl<=&1 AND cli_regr=&2", dteN, Left(combregr.Current.Text, 1))
  Else
    dateinf = Right$(datei.Text, 4) & Mid$(datei.Text, 4, 2) & Left$(datei.Text, 2)
    $sreq = utils.db.Subst(" AND (datebl BETWEEN &1 AND &2) AND cli_regr=&3", dateinf, dteN, Left(combregr.Current.Text, 1))
    jour = Left(datei.Text, 2)
    bcond = (combregr.Current.Text = "Décade" And jour <> "01" And jour <> "11" And jour <> "21") Or (combregr.Current.Text = "Quinzaine" And jour <> "16" And jour <> "01") Or (combregr.Current.Text = "Mensuel" And jour <> "01")
    If bcond Then
      Message.Error("incohérence dans les dates de début de période, Veuillez vérifier", "OK")
      datei.SelectAll
      datei.SetFocus
    Endif
    dte = Date(Right$(datej.Text, 4), Val(Mid$(datej.Text, 4, 2)), Val(Left$(datej.Text, 2)))
    d = utils.lastday(dte)
    jour = Left(datej.Text, 2)
    bcond = (combregr.Current.Text = "Décade" And jour <> "10" And jour <> "20" And jour <> Str(d)) Or (combregr.Current.Text = "Quinzaine" And jour <> "15" And jour <> Str(d)) Or (combregr.Current.Text = "Mensuel" And jour <> Str(d))
    If bcond Then
      Message.Error("incohérence dans les dates de fin de période, Veuillez vérifier", "OK")
      datei.SelectAll
      datei.SetFocus
    Endif
  Endif
  'tournées
  If Labeltour.Text Then
    $sreq &= utils.db.Subst(" AND cli_tour=&1", Labeltour.Text)
  Endif
  'type client
  If Combocli.Current.Text <> "Tous" Then
    $sreq &= utils.db.Subst(" AND cli_typec=&1", Left(Combocli.Current.Text, 2))
  Endif
  'commercial
  If Combocom.Current.Text <> "Tous" Then
    $sreq &= utils.db.Subst(" AND cli_comm=&1", Left(Combocom.Current.Text, 2))
  Endif

End

Public Sub Button5_Click()

  
  Me.close

End

Public Sub Radiobutton1_Click()

  codeclient.Background = &HD4D0C8& '&HF9F9BD&
  codeclient.ReadOnly = True
  Colbl.clear
  Coldetail.clear
  Rgmt.value = False
  Rgmt.visible = False
  Edit.Visible = False

End

Public Sub Radiobutton2_Click()

  Dim Frmt As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znss"])
  If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then codeclient.Background = Val(Frmt[0])
  codeclient.ReadOnly = False
  Colbl.clear
  Rgmt.visible = True
  Edit.Visible = False
  Coldetail.clear
  codeclient.SetFocus

End

Public Sub codeclient_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", codeclient.Text)
    If rResult.Available Then
      Button1.SetFocus()
    Else
      Message.Error("Ce client n'existe pas !")
      codeclient.Select
      codeclient.SetFocus
    Endif
  Endif

End

Public Sub Togglebutton1_Click()

  Dim MyForm As Triclients

  If Radiobutton2.Value = False Then Radiobutton2.Value = True
  'compteTiers()
  bsel = False
  MyForm = New Triclients("Facturefm")
  MyForm.Showmodal()
  If Bsel = True Then
    codeclient.Text = Cclient
  Else
    Codeclient.SetFocus
  Endif

End

'**********************************************************
'*   Activation de l'écran d'édition des documents        *
'**********************************************************
Public Sub Bl_Edit()

  Dim rParam As Result
  Dim jnal As String

  Edit.Visible = True
  Try Entete.Value = Start.LocalSettings["/Soc" & Start.Societe & "/Entete"]
  Try Reserve.Value = Start.LocalSettings["/Soc" & Start.Societe & "/Conditions"]
  dtef.Text = datej.Text
  dtef.ReadOnly = False
  Try Rcp.Value = Start.LocalSettings["/Soc" & Start.Societe & "/Recap"]
  'Try ChxImp.value = Start.LocalSettings["/Soc" & Start.Societe & "/ChxImp"]
  If radiobutton2.value Or If divers.value And Colbl.count = 1 Then Rgmt.Visible = True
  If divers.value And Colbl.count = 1 Then Codeclient.text = Colbl.Item[0]
  rParam = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
  If rParam.Available Then
    Jnal = rParam!jrnal2
    Vic = rParam!viremc
    Vichq = rParam!viremchq
    Viautre = rParam!virema
  Endif
  If Jnal = "" Or If Vic = "" Or If Vichq = "" Or If Viautre = "" Then
    If start.son Then
      Music.Play
    Endif
    Message.Error("Vous devez completer, dans les parametres, les données relatives au journal de caisse \net aux comptes de virements internes avant d'imprimer vos documents !")
  Else
    Edit.Visible = True
  Endif

End

Public Sub dte_LostFocus()

  If Not Last.ReadOnly Then
    Last.text = Utils.Cdate_calc(Last.text)
    Last.Text = Utils.Cdate_aff(Last.Text)
    If Last.Text = "00.00.0:00" Or If Last.Text = ".." Then
      Last.Text = Format$(Now, "dd.mm.yyyy")
      Last.SetFocus
    Endif
  Endif

End

Public Sub Chximp_Click()

  If Chximp.Value Then
    Cimp.Visible = True
  Else
    Cimp.Visible = False
  Endif

End

Public Sub dtef_LostFocus()

  dtef.text = Utils.Cdate_calc(dtef.text)
  dtef.Text = Utils.Cdate_aff(dtef.Text)
  If dtef.Text = "00.00.0:00" Or If dtef.Text = ".." Then
    dtef.Text = Format$(Now, "dd.mm.yyyy")
    dtef.SetFocus
  Endif

End

Public Sub Button14_Click()

  If $process Then Return
  $process = True
  If ExpMail.Value Then controleMail()
  If Not liste Then
    If visudoc = False Then 
      Button14.Enabled = False
      Button16.Enabled = False
    Endif
    Visudoc = False
    Colbl.MoveFirst()
    If Val(Colbl.item[5]) <> 0 Then
      If Rgmt.Value = True And IsNull(Rglt2.Text) And Not IsNull(Regmt.text) Then
        If IsNull(rglt.text) Then rglt.text = "0,00"
        If Val(Rglt.text) < Val(Colbl.item[5]) Then
          Panel10.Visible = True
          Rglt2.Text = Format$(Val(Colbl.item[5]) - Val(Rglt.text), "0.00")
          b = 0
        Else
          If Val(Rglt.text) = Val(Colbl.item[5]) Then Impression()
        Endif
      Else
        If Rgmt.Value = True And IsNull(regmt.Text) Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Vous n'avez pas saisi le mode de règlement!")
          If visudoc = False Then 
            Button14.Enabled = True
            Button16.Enabled = True
          Endif
          Regmt.SetFocus
        Else
          If b = 0 Then
            Impression()
          Endif
          b = 0
        Endif
      Endif
    Endif
  Else
    Colbl.Clear
    Edit.Visible = False
  Endif

End

'*********************************** On gère l'envoi du document par mail *******************************************

Public Sub controleMail()

  Dim CliMail As String = "Traitement impossible ! Les clients suivants n'ont pas d'adresse courriel"

  Liste = False

  Colbl.MoveFirst()
  Repeat
    rResult = Utils.db.Exec("SELECT * FROM  Fiches_Cli where cli_code = &1", Colbl.Item[0])
    If IsNull(rResult!cli_email) Then
      Climail &= "\n" & rResult!cli_code & " " & rResult!cli_nom
      Liste = True
    Endif
  Until Colbl.MoveNext()
  If liste Then
    Message.Info(Climail)
    Edit.Visible = False
  Endif
  Colbl.MoveFirst()

End

'*********************************** On gère l'envoi du document par mail *******************************************

Public Sub Env_Mail()

  Dim sText As String
  Dim sText2, chemin As String
  Dim piece As String[]
  Dim intitule As String = Start.LocalSettings["/intitule"]

  With Utils
    sText = "Facture"
    If Not IsNull(scourriel) Then
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTmail") & "")
      If rResult.Available Then
        sText &= " No " & Numerofac & " du " & Dtef.Text
        sText2 = Replace$(rResult!intitule, "*", sText)
        Stext2 = "Bonjour,\n\nVeuillez trouver ci-joint votre " & sText & "" & "\n\n" & "\n\nCordialement.\n"
        sText = "Votre " & sText
      Else
        sText &= " No " & Numerofac & " du " & Dtef.Text
        Stext2 = "Bonjour,\n\nVeuillez trouver ci-joint votre " & sText & "" & "\n\n" & "\n\nCordialement.\n\n" & intitule
        sText = "Votre " & sText
      Endif
      Me.mouse = Mouse.Wait
      Wait 0.5
      'EnvMail.Envoi2(scourriel, stext, sText2, spiece)
      piece = Split(spiece, "/")
      spiece = piece[piece.count - 1]
      EnvMail.Envoi(scourriel, stext, sText2, True, Copie.schemin, "application/pdf", spiece)
      Wait 0.5
      Me.mouse = Mouse.Default
    Else
      If start.son Then
        Music.Play
      Endif
      Message.Error("L'adresse mail du client " & CCli & " n'est pas renseignée! Envoi du courriel impossible.")
    Endif
  End With

End

Public Sub Impression()

  Dim Tab As String
  Dim Tab2, Tab3, Tab4, Tab5, Tab6, Tab7, tab8, Tab9, Tab10 As String
  Dim adr11 As String
  Dim adr22 As String
  Dim ville As String
  Dim ville2 As String
  Dim Rs, Libre As String
  Dim Cde As String
  Dim Mail As String
  Dim site As String
  Dim Rcs As String
  Dim Siret As String
  Dim Tvaintra As String
  Dim Cap As String
  Dim Ape As String
  Dim Iban As String
  Dim Tel As String
  Dim portable As String
  Dim Fax As String
  Dim ty2, Tp As String
  Dim Stry As String[]
  Dim code, codi As String
  Dim Txtva As String
  Dim Pu As String
  Dim qte As String
  Dim cptlig As Integer
  Dim Txtbf As String
  Dim P As Integer 'Flag pour lignes si pied de facture
  Dim Npage As Float ' Flag pour calcul nombre de page
  Dim Pge As Integer ' numero de page
  Dim Page As String
  Dim ech As String
  Dim dureech As String
  Dim jours As String
  Dim finmois As Boolean
  Dim Teco As Float
  Dim Toteco As String
  Dim Tmo As String
  Dim Tart As String
  Dim Trem As String
  Dim Bl As Result
  Dim Ligbl As Result
  Dim intitule As String
  Dim Logo As Image
  Dim Imagewidth As Integer
  Dim Imageheight As Integer
  Dim Nbexpl As String
  Dim nbfac As Integer
  Dim TvaCli As String
  Dim Pays As String
  Dim sline As String
  Dim Cfac As Boolean = False
  Dim Acpt As Float = 0
  Dim TotAcpt As Float = 0
  Dim Mtdut As Float = 0
  Dim Mfacttc As Float = 0
  Dim Mrgt As String
  Dim Cresult As Result
  Dim i As Integer
  Dim borientation As Boolean = False
  Dim ccd As Calculconsdroit
  Dim ftottva As Float
  Dim gest As Boolean

  P = 31
  Pge = 1
  tart = 0
  nbfac = 1
  Totht = "0,00"
  Totttc = "0"
  Remart = "0"
  Remmo = "0"
  Totalrem = "0"
  Teco = 0
  Imagewidth = 1000
  Imageheight = 500
  Tab = "Fiches_Parametres"
  Tab2 = "Fiches_Societes"
  Tab3 = "Fiches_LibelFac"
  Tab4 = "Fiches_Echeances"
  Tab5 = "Fiches_Cli"
  Tab6 = "Fiches_Art"
  Tab7 = "Fiches_Mo"
  Tab8 = "Facturefm"                      'liste des clients a facturer
  Tab9 = "Bl"                             'liste des bl à regrouper
  Tab10 = "Totalisation"                  'cde comptable avec leurs totaux pour générer l'ecriture comptable
  Ventilation()
  If $soption = "B" Or $soption = "T" Then
    Utils.db.Exec("LOCK TABLES " & Tab & " read, Fiches_Bl WRITE, Fiches_Ligbl WRITE, Fiches_BlM WRITE, Fiches_LigblM WRITE, " & Tab2 & " WRITE," & Tab3 & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE, " & Tab6 & " WRITE, " & Tab7 & " WRITE, " & Tab8 & " WRITE, " & Tab9 & " WRITE, " & Tab10 & " WRITE," & Cbase.Table("TabTleg") & " WRITE, " & Cbase.Table("TabFam") & " WRITE, " & Cbase.Table("TabComptes") & " WRITE, " & Cbase.Table("TabMvt") & " WRITE, " & Cbase.Table("TabTvav") & " WRITE, Fiches_HistoLigfac WRITE, Fiches_HistoLigfacM WRITE, " & "Fiches_Suivis" & " WRITE, " & "Docs_Clients" & " WRITE, Fiches_ligcons WRITE, Fiches_ligregie WRITE, Fiches_HistoFac WRITE, Fiches_HistoFacM WRITE ")
  Else
    Utils.db.Exec("LOCK TABLES " & Tab & " read, Fiches_Bl WRITE, Fiches_Ligbl WRITE, Fiches_BlM WRITE, Fiches_LigblM WRITE, " & Tab2 & " WRITE," & Tab3 & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE, " & Tab6 & " WRITE, " & Tab7 & " WRITE, " & Tab8 & " WRITE, " & Tab9 & " WRITE, " & Tab10 & " WRITE," & Cbase.Table("TabTleg") & " WRITE, " & Cbase.Table("TabFam") & " WRITE, " & Cbase.Table("TabComptes") & " WRITE, " & Cbase.Table("TabMvt") & " WRITE, " & Cbase.Table("TabTvav") & " WRITE, Fiches_HistoLigfac WRITE, Fiches_HistoLigfacM WRITE, " & "Fiches_Suivis" & " WRITE, " & "Docs_Clients" & " WRITE, Fiches_HistoFac WRITE, Fiches_HistoFacM WRITE ")
  Endif
  If Start.LocalSettings["/Soc" & Start.Societe & "/glogo"] Then Try Logo = Image.Load(Settings["/Soc" & Start.Societe & "/Logo"])
  Shell "cd " & User.Home & ""
  Filename = User.Home & "/tmp/Facture.pdf"
  With Utils
    Quittedate(datej)
    datej.Text = .Cdate_calc(datej.Text)
    datej.Text = .Cdate_aff(datej.Text)
    If datej.Text = "00.00.0:00" Then
      datej.Text = Format$(Now, "dd.mm.yyyy")
      datej.SetFocus
      datej.Select
    Else
      Tmo = "0"
      Txtleg = ""
      Txtleg2 = ""
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTleg") & "")
      If rResult.Available Then Txtleg2 = rResult!intitule
      cptlig = Coldetail.Count
      rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & "")
      If rResult.Available Then Txtbf = rResult!txtfac
      Me.Mouse = Mouse.Wait
      Tab2 = "Fiches_Societes"
      rResult = Utils.db.Exec("SELECT * FROM " & tab2 & " where cd_sc = &1", Start.Societe)
      Rs = rResult!type_sc & " " & rResult!int_sc
      Libre = rResult!libre
      adr11 = rResult!adr1_sc
      adr22 = rResult!adr2_sc
      ville = rResult!cp_sc & "  " & rResult!burdis_sc
      If rResult!villerc_sc Then Rcs = "Rcs : " & rResult!rcs_sc & " " & rResult!villerc_sc
      If rResult!siret_sc Then Siret = Start.LocalSettings["/Soc" & Start.Societe & "/Siret"] & " : " & rResult!siret_sc
      If rResult!tvaintra_sc Then Tvaintra = "Tva intra : " & rResult!tvaintra_sc
      If rResult!cap_sc Then Cap = "Capital : " & rResult!cap_sc
      If rResult!ape_sc Then Ape = "APE : " & rResult!ape_sc
      If rResult!tel_sc Then Tel = "Tel : " & rResult!tel_sc
      If rResult!port_sc Then Portable = "Portable : " & rResult!port_sc
      If rResult!fax_sc Then Fax = "Fax : " & rResult!fax_sc
      If rResult!email_sc Then Mail = "Courriel : " & rResult!email_sc
      If rResult!site Then site = "site : " & rResult!site
      If rResult!banq Then Iban = "Iban : " & rResult!banq & " Bic : " & rResult!bic
      Parametres()
      If Jnl Then
        Colbl.MoveFirst()
        Colbl.Item.Selected = True
        NomCli = Colbl.Item[1]
        Repeat                           'boucle colbl qui liste les clients a éditer
          Variables.bRemise = False
          borientation = utils.orientation(Colbl.Item[0], "FM")
          frais = "0"
          If borientation Then
            pdf = New Cdocuments31("landscape", "mm", "A4")
            Nbexpl = "3"
          Else
            pdf = New Cdocuments("Portrait", "mm", "A4")
          Endif

          pdf.Open()
          pdf.AliasNbPages()
          If borientation Then pdf.SetMargins(10, 2)
          Colbl.Item.Selected = True
          Pge = 1
          Nfac = Format$(Val(Nfac) + 1, "000000")
          numbl = Utils.db.Exec("SELECT * FROM " & $bl & " where cdclibl = &1 order by numbl", Colbl.Item[0])
          If numbl.Count <> 0 Then
            Ventilation()
            If borientation Then
              ccd = New Calculconsdroit(Colbl.Item[0], "FM")
              ccd.comptmat(Right$(dtef.Text, 4) & Nfac)
            Endif
            Repeat
              Bl = Utils.db.Exec("SELECT * FROM " & tab9 & " where num = &1", numbl!numbl)
              If Bl.Count <> 0 Then
                Repeat
                  Ligbl = Utils.db.Exec("SELECT * FROM " & $ligbl & " where num_ligbl = &1", Bl!num)
                  cptlig = cptlig + Ligbl.Count
                Until Bl.MoveNext()
              Endif
            Until numbl.MoveNext()
          Endif
          ' On calcule le nombre de pages
          P = 31
          If Rcp.Value = False And Pied.Value = False Then p = 34
          If borientation Then
            If ccd.nbdecons > 0 Then cptlig += ccd.nbdecons + 1
            P = 15
          Endif
          Npage = Round(Cptlig / p)
          If Cptlig Mod p < (p / 2) And Cptlig Mod p > 0 Then Npage += 1
          Page = "Page " & Pge
          cptlig = 0
          Ecritures(numecr)
          Totalart = "0"
          Totalmo = "0"
          Totalrem = "0"
          Tmo = "0"
          numr = numr + 1
          numr2 = numr2 + 1
          ty = "Facture N° "
          Tp = "Facture "
          If Val(Colbl.Item[4]) < 0 Then
            ty = "Avoir N° "
            Tp = "Avoir "
            Txtleg = ""
          Endif
          If dtef.Text = "" Then
            Syntheses.Message(" Veuillez saisir une date d'édition s'il vous plait.")
            Message.Warning(" Veuillez saisir une date d'édition Svp !", "Ok")
          Else
            If Not Divers.value Then
              CblRslt = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " left join " & Tab8 & " on cli_code = code where cli_code = &1", Colbl.Item[0])
            Else
              CblRslt = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " left join " & Tab8 & " on cli_code = code where cli_code = &1 and nom = &2 order by cli_code, nom", Colbl.Item[0], Colbl.Item[1])
            Endif
            If Utils.totobs([CblRslt!gestbl]) <> 0 Then
              utils.fraisgestion(CblRslt!gestbl)
              Try frais = Format(CblRslt!gestbl, "0.00")
              If Error Then frais = "0,00"
            Endif
            If Not Divers.value Then
              CCli = CblRslt!cli_code
              nom = CblRslt!cli_nom
              ech = CblRslt!cli_cdech
              Rs2 = CblRslt!cli_rs_soc & " " & CblRslt!cli_nom & " " & CblRslt!cli_pnm
              adr211 = CblRslt!cli_adr1
              adr222 = CblRslt!cli_adr2
              ville2 = CblRslt!cli_cd_ptl & " " & CblRslt!cli_ville
              Nbexpl = CblRslt!cli_expl
              Pays = CblRslt!cli_pays
              Cfac = CblRslt!cli_copie
              Reglmt = CblRslt!cli_reg
              scourriel = CblRslt!cli_email
            Else
              CCli = CblRslt!cli_code
              nom = CblRslt!nom
              Rs2 = nom
              adr211 = CblRslt!adr1
              adr222 = CblRslt!adr2
              ville2 = CblRslt!cp & " " & CblRslt!ville
              adr1 = adr211
              adr2 = adr222
              ville = ville2
              Nbexpl = CblRslt!cli_expl
              Cfac = CblRslt!cli_copie
            Endif
            CResult = Utils.db.Exec("SELECT * FROM Fiches_ContactC where code = &1 and fonction = &2", CCli, "COMPTABLE")
            If Cresult.available Then scourriel = CResult!mail
            If Pays = "France" Then Pays = ""
            If Not IsNull(CblRslt!cli_id_tva) Then
              TvaCli = "Tva intracommunautaire " & CblRslt!cli_id_tva
            Else
              Tvacli = ""
            Endif
            If IsNull(Nbexpl) Then Nbexpl = "2"
            Cde = "code client " & Colbl.Item[0]
            If ech Then
              rResult = Utils.db.Exec("SELECT * FROM " & tab4 & " where num = &1", ech)
              If rResult.available Then
                dureech = rResult!duree
                jours = rResult!jours
                finmois = rResult!finmois
                ech = "1"
              Else
                ech = "0"
              Endif
            Else
              ech = "0"
            Endif
            If ech = "1" Then
              dateech = Utils.Calcech(dureech, jours, finmois, datej.Text)
              Dateech2 = dateech
            Else
              dateech = " à réception."
            Endif
            If dureech = "00" Then
              ech = "0"
              dateech = " à réception."
            Endif
            If ech = "0" Or If dureech = "00" Then
              If IsNull(Reglmt) Then
                Txtleg = " Règlement à réception."
              Else
                Txtleg = " Règlement par " & Reglmt & " à réception."
              Endif
            Else
              If IsNull(Reglmt) Then
                Txtleg = "Règlement au " & dateech
              Else
                Txtleg = " Règlement par " & Reglmt & " au " & dateech
              Endif
            Endif
            If radiobutton2.value And Rgmt.value Then
              If IsNull(Regmt2.text) Then
                Txtleg = " Règlement par " & Regmt.Text & " au " & Format$(Now, "dd.mm.yyyy")
              Else
                Txtleg = " Règlement par " & Regmt.Text & " et " & Regmt2.Text & " au " & Format$(Now, "dd.mm.yyyy")
              Endif
            Endif
            If bnumfac Then
              Jour = ty & Right$(dtef.Text, 2) & Mid$(dtef.Text, 4, 2) & nfac & " du " & dtef.Text
              Numerofac = Right$(dtef.Text, 2) & Mid$(dtef.Text, 4, 2) & nfac
            Else
              jour = ty & Right$(dtef.Text, 4) & nfac & " du " & dtef.Text
              numerofac = Right$(dtef.Text, 4) & nfac
            Endif
            If Entete.Value Then
              pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, coln.Value, Libre)
              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
            Else
              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
            Endif
            pdf.Level1F(Jour, Cde, Page, TvaCli)
            If borientation Then PosY = 104 Else PosY = 108
            numbl = Utils.db.Exec("SELECT * FROM " & $bl & " where cdclibl = &1 order by numbl", Colbl.Item[0])
            If numbl.Count <> 0 Then
              Repeat
                If Val(.cpoint(numbl!remmobl)) <> 0 Or Val(.cpoint(numbl!remartbl)) <> 0 Then
                  Variables.bRemise = True
                Endif
              Until numbl.MoveNext()
            Endif
            pdf.Level2F(Coulfond, "", PosY)
            Nbl = 0
            PosY = 114
            Tart = "0"
            Trem = "0"
            Tmo = "0"
            Teco = 0
            If Not Divers.value Then
              numbl = Utils.db.Exec("SELECT * FROM " & $bl & " where cdclibl = &1 order by numbl", Colbl.Item[0])
            Else
              numbl = Utils.db.Exec("SELECT * FROM " & $bl & " where cdclibl = &1 and nmclibl = &2order by numbl", Colbl.Item[0], Colbl.Item[1])
            Endif
            If numbl.Count <> 0 Then
              If borientation Then PosY -= 4
              Repeat                  'boucle entete bl pour 1 client
                numbonl = numbl!numbl
                Bl = Utils.db.Exec("SELECT * FROM " & tab9 & " where num = &1", numbl!numbl)
                If Bl.Count <> 0 Then
                  Try mgart = Val(mgart) + numbl!marge_art
                  Try mgmo = Val(mgmo) + numbl!marge_mo
                  Try Acpt = numbl!acpt
                  Try TotAcpt = TotAcpt + numbl!acpt
                  Try Mfacttc = Mfacttc + numbl!totalttc
                  Toteuros = Val(.cpoint(Toteuros)) + Val(.cpoint(Bl!ht))
                  Ligbl = Utils.db.Exec("SELECT * FROM " & $ligbl & " where num_ligbl = &1", Bl!num)
                  If Ligbl.Count <> 0 Then
                    If Not borientation Then
                      If coln.Value Then pdf.Colonnes(PosY)
                      PosY = PosY + 4
                      If coln.Value Then pdf.Colonnes(PosY)
                    Else
                      If coln.Value Then pdf.Colonnes(PosY - 6)
                    Endif
                    intituleb = "Bon n° " & numbl!numbl & " du " & .Cdate_Aff(numbl!datebl)
                    pdf.Level4bF(intituleb, PosY)
                    PosY = PosY + 4
                    If borientation Then nbl += 1 Else Nbl = Nbl + 2
                    Repeat                    'boucle sur ligne de bl pour 1 bl
                      code = Ligbl!code_ligbl
                      intitule = Ligbl!libel_ligbl
                      Txtva = Ligbl!tx_ligbl
                      Pu = Ligbl!pu_ligbl
                      If Len(pu) - InStr(pu, ",") = 2 Then pu = pu & " "
                      If Prxdec Then Try Pu = Round(Val(pu))
                      qte = Ligbl!qte_ligbl
                      Brutht = Ligbl!brut_ligbl
                      If Len(Brutht) - InStr(Brutht, ",") = 2 Then Brutht = Brutht & " "
                      If Prxdec Then Try Brutht = Round(Val(Brutht))
                      Rem = Ligbl!rem_ligbl
                      totalht = Ligbl!netht_ligbl
                      If Len(totalht) - InStr(totalht, ",") = 2 Then totalht = totalht & " "
                      If Prxdec Then Try Totalht = Round(Val(Totalht))
                      typeL = Ligbl!typel_ligbl
                      If typeL = "C" Or If typeL = "R" Then intitule = Ligbl!com_ligbl
                      Totttc = Ligbl!nettc_ligbl
                      If Len(Totttc) - InStr(Totttc, ",") = 2 Then Totttc = Totttc & " "
                      If Prxdec Then Try Totttc = Round(Val(Totttc))
                      Fam = Ligbl!fam_ligbl
                      If Totttc = "" Then Totttc = "0"
                      If totalht = "" Then totalht = "0"
                      If Brutht = "" Then Brutht = "0"
                      If Remmo = "" Then Remmo = "0"
                      If Rem = "0,00" Then Rem = ""
                      If typeL = "M" Then
                        Remmo = Val(.cpoint(Remmo)) + Val(.cpoint(Brutht)) - Val(.cpoint(totalht))
                        Totalmo = Format$(Val(.cpoint(Totalmo)) + Val(.cpoint(totalht)), "0.00")
                        RemArt = 0
                      Endif
                      If typeL = "A" Then
                        Remart = Val(.cpoint(Remart)) + Val(.cpoint(Brutht)) - Val(.cpoint(totalht))
                        Totalart = Format$(Val(.cpoint(Totalart)) + Val(.cpoint(totalht)), "0.00")
                        Remmo = 0
                        codi = Ligbl!refl_ligbl
                      Endif
                      If typeL = "E" "" Then
                        qte = ""
                        Pu = ""
                        Brutht = "0"
                      Endif
                      If typeL <> "C" And typeL <> "T" And typeL <> "E" And typeL <> "P" And typeL <> "R" And typeL <> "O" Then
                        totht = Format$(Val(totht) + Val(totalht), "0.00")
                        If Prxdec Then
                          pu = Format$(Val(pu), "0")
                          Totalht = Format$(Val(totalht), "0")
                          Brutht = Format$(Val(Brutht), "0")
                          pu = Format$(Val(pu), "0")
                        Endif
                        If IsNull(codi) Then
                          pdf.Level3F(code, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                          If borientation Then pdf.Level3Fbois(ccd.aimprimer, numbl!numbl & Ligbl!numlig_ligbl, PosY)
                        Else
                          pdf.Level3F(codi, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                          If borientation Then pdf.Level3Fbois(ccd.aimprimer, numbl!numbl & Ligbl!numlig_ligbl, PosY)
                        Endif
                        PosY = PosY + 4
                        If Rem Then Totalrem = Format$(Val(.cpoint(Totalrem)) + Val(.cpoint(Remart)) + Val(.cpoint(Remmo)), "0.00")
                        Maj_Totalisation()
                      Endif
                      If typeL = "T" Then
                        pdf.Level4aF(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                      If typeL = "O" Then
                        pdf.Level8F(code, intitule, qte, PosY)
                        PosY = PosY + 4
                      Endif
                      If typeL = "C" Or If typeL = "R" Then
                        For Each sline In Split(Intitule, "\n")
                          pdf.Level4aF(sline, PosY)
                          PosY = PosY + 4
                          Nbl = Nbl + 1
                          If Nbl >= 39 Or (borientation And nbl > p) Then
                            Inc Pge
                            Page = "Page " & Pge
                            pdf.Level12F(Totht, PosY, Devises)
                            If Entete.Value Then
                              pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, False, Libre)
                              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                            Else
                              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
                            Endif
                            pdf.Level1F(Jour, Cde, Page, TvaCli)
                            If borientation Then PosY = 104 Else PosY = 108
                            pdf.Level2F(Coulfond, "", PosY)
                            Nbl = 0
                            If borientation Then PosY = 110 Else PosY = 114
                          Endif
                        Next
                        Nbl = Nbl - 1
                      Endif
                      If typeL = "E" Then
                        intitule = "Dont " & Totalht & " " & devises & "  HT d' Eco-participation"
                        Teco = Teco + Val(Totalht)
                        Coldetail.MoveNext()
                        Try Coldetail.item.Selected = True
                        If Not Error Then
                          If Coldetail.Item[9] = "P" Then
                            Totalht = Coldetail.Current[7]
                            Intitule = Intitule & " et " & Totalht & " " & devises & " HT de taxe copie privée."
                          Else
                            Coldetail.MovePrevious()
                            Coldetail.Item.Selected = True
                          Endif
                        Endif
                        pdf.Level4F(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                      If typeL = "P" Then
                        intitule = "Dont " & Totalht & " " & devises & " HT de taxe copie privée."
                        pdf.Level4F(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                      Nbl = Nbl + 1
                      If Npage > 1 Then
                        If Nbl >= 39 Or (borientation And nbl > p) Then
                          Inc Pge
                          Page = "Page " & Pge
                          pdf.Level12F(Totht, PosY, Devises)
                          If Entete.Value Then
                            pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, False, Libre)
                            pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                          Else
                            pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
                          Endif
                          pdf.Level1F(Jour, Cde, Page, TvaCli)
                          If borientation Then PosY = 104 Else PosY = 108
                          pdf.Level2F(Coulfond, "", PosY)
                          Nbl = 0
                          If borientation Then PosY = 110 Else PosY = 114
                        Endif
                      Endif
                      Remmo = 0
                      RemArt = 0
                    Until Ligbl.MoveNext()
                  Endif
                Endif
              Until numbl.MoveNext()
              If borientation Then
                If ccd.nbdecons > 0 Then
                  pdf.Level4F("Déconsigne", posy)
                  posy += 4
                  Inc nbl
                  For i = 0 To ccd.nbdecons - 1
                    pdf.Level3Fcons(ccd.decons[i], posy)
                    posy += 4
                    Inc nbl
                    If Npage > 1 Then
                      If Nbl > P Then
                        Inc Pge
                        Page = "Page " & Pge
                        pdf.Level12F(Totht, PosY, Devises)
                        If Entete.Value Then
                          pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, False, Libre)
                          pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                        Else
                          pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
                        Endif
                        pdf.Level1F(Jour, Cde, Page, TvaCli)
                        PosY = 104
                        pdf.Level2F(Coulfond, "", PosY)
                        Nbl = 0
                        PosY = 110
                      Endif
                    Endif
                  Next
                Endif
                pdf.Level1F(Jour, Cde, Page, TvaCli)
                If borientation Then PosY = 104 Else PosY = 108
                pdf.Level2F(Coulfond, "", PosY)
                Nbl = 0
                PosY = 114
              Endif
              ' On imprime l'acompte
              If TotAcpt > 0 Then
                Mtdut = Mfacttc - Acpt
                If Prxdec Then
                  Mtdut = Round(Mtdut)
                  Mtdut = Format$(Mtdut, "###########")
                Endif
                If Prxdec Then
                  Mfacttc = Round(Val(Mfacttc))
                  Mfacttc = Format$(Val(Mfacttc), "###########")
                Endif
                Mrgt = "Total acomptes : "
                If Prxdec Then
                  Totacpt = Round(Val(Totacpt))
                  Totacpt = Format$(Val(Totacpt), "###########")
                Endif
                pdf.Level13F(Format$(Mfacttc, "0.00"), Mrgt, Format$(Totacpt, "0.00"), Format$(Mtdut, "0.00"), PosY, Devises, Tp)
                PosY = PosY + 4
                Nbl = Nbl + 1
              Endif
              PosY = 240
              If Teco <> 0 Then
                Toteco = "  Total Eco-participation : " & Teco & " " & devises & " ht."
                pdf.Level5F(TotEco, PosY)
                Toteco = 0
              Endif
              Nbl = Nbl + 1
              'PosY = PosY + 4Calc_tva
              If Val(.cpoint(TotalRem)) <> 0 Then
                Trem = "Total remise : " & Totalrem & " ht"
              Else
                Trem = ""
              Endif
              If Val(.cpoint(Totalart)) <> 0 Then
                Tart = "Total article : " & Totalart & " ht"
              Else
                Tart = ""
              Endif
              If Val(.cpoint(Totalmo)) <> 0 Then
                Tmo = "Total MO : " & Totalmo & " ht"
              Else
                Tmo = ""
              Endif
              PosY = 240
              If borientation Then posy = 155
              If (Pied.Value And Rcp.Value) Or Utils.totobs([frais]) <> 0 Then
                pdf.Level6F(Tmo, Tart, Trem, Txtbf, frais, PosY)
                PosY = PosY + 4
              Else
                If Rcp.Value And Not Pied.Value Then
                  Txtbf = ""
                  pdf.Level6F(Tmo, Tart, Trem, Txtbf, frais, PosY)
                  PosY = PosY + 4
                Else
                  If Not Rcp.Value And Pied.Value Then
                    Tmo = ""
                    Tart = ""
                    Trem = ""
                    pdf.Level6F(Tmo, Tart, Trem, Txtbf, frais, PosY)
                    PosY = PosY + 4
                  Endif
                Endif
              Endif
              PosY = 258
              If borientation Then
                ftottva = Mfacttc - (Val(totht) + Val(frais) + ccd.totht)
                pdf.Level17F(totht, Format(ftottva, "0.00"), frais, ccd.ascise, ccd.droit, ccd.secu, ccd.poid(), ccd.totvolume, ccd.totap, ccd.consigne, ccd.deconsigne, rs, tel, PosY)
                posy = 171
                ccd.Totalisation
              Endif
              pdf.Level7F(Coulfond, PosY, "", "", "")
              PosY = PosY + 5
              Calc_tva(borientation)
              Utils.db.Exec("INSERT INTO " & Tab10 & "(compte, intitule, totalht, codetva) VALUES (&1, &2, &3, &4)", Colbl.Item[0], nom, Mttc, ".")
              Verif_solde()
              Nfac = numerofac
              Maj_Compta()
              Majnum()
              Ventilation()
              If radioButton1.Value And UCase$(Reglmt) = "TRAITE" Or If radioButton1.Value And UCase$(Reglmt) = "LCR" Then Maj_Traite()
              Toteuros = 0
            Endif
          Endif
          If Start.LocalSettings["/Soc" & Start.Societe & "/Pdf5"] Or If Start.LocalSettings["/Soc" & Start.Societe & "/Pdf6"] Then
            If Exist(Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminV"]) Then
              pdf.EnteteV()
              Posy = 4
              For Each intitule In Split(File.Load(Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminV"]), "\n")
                pdf.Level4V(intitule, Posy)
                Posy = Posy + 3
                If Posy > 280 Then
                  pdf.EnteteV()
                  Posy = 5
                Endif
              Next
            Endif
          Endif
          pdf.Output(Filename, False)
          Impression.Facture(Filename, Val(Nbexpl), Cimp.Text)
          Wait 1
          ty = ""
          Nom = Replace$(Nom, " ", "")
          Nom = Replace$(Nom, "/", "")
          Nom = Replace$(Nom, "'", "")
          Stry = Split("F" & numerofac & Nom, " ")
          For Each ty2 In Stry
            ty = ty & ty2
          Next
          If Cfac Then
            Copie.Dupli2(Filename, User.home & "/Impressions", ty, dtef.Text, Ccli, "Facs")
            Copie.Dupli2CPT(numrd, copie.spiece, Ccli, ty)
          Else
            Copie.Dupli(User.Home & "/tmp/Facture.pdf", "/Impressions", ty, dtef.Text)
          Endif
          sPiece = Copie.spiece
          If ExpMail.value And Not IsNull(sPiece) Then Env_Mail()
          If ExpMail.value And IsNull(sPiece) Then Message.Info("Envoi impossible, chemin PDF non renseigné!")
          Nbl = 0
          P = 31
          Inc nbfac
          Maj_Parametres()
          Acpt = 0
          Totacpt = 0
          Mfacttc = 0
          Totalrem = 0
          Remmo = 0
          Remart = 0
          Rglt.Clear
          Rglt2.Clear
          Rgmt.value = False
        Until Colbl.MoveNext()
        Edit.Visible = False
        Message.Info("Traitement terminé !")
      Else
        If son Then
          Music.Play
        Endif
        Message.Warning(" Impression impossible ! Veuillez saisir un code journal dans les parametres Svp !", "Ok")
      Endif
    Endif
  End With
  Me.Mouse = Mouse.Arrow
  Utils.db.Exec("UNLOCK TABLES")
  Colbl.Clear
  Coldetail.Clear
  Button14.Enabled = True
  Button16.Enabled = True
  $process = False
  Button1_Click()

End

'**********************************************************
'*                   Recup parametres                     *
'**********************************************************
Public Sub Parametres()

  Dim Tab As String = "Fiches_Parametres"

  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    Nfac = rResult!dnfac
    Jnl = rResult!jrnal
    Try bnumfac = rResult!nfac
    If Error Then bnumfac = False
  Endif
  Nfac = VerifNumfac.Dnfac(Nfac)
  Nfac = Format$(Val(Nfac) - 1, "000000")

End

'**********************************************************
'*                   Maj parametres                     *
'**********************************************************
Public Sub Maj_Parametres()

  Dim Nfac2 As String
  Dim Tab As String = "Fiches_Parametres"

  With Utils
    Nfac2 = Val(Right$(Nfac, 6))
    Nfac2 = Format$(Nfac2, "000000")
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnfac = &1", Nfac2)
    Nfac = Nfac2
  End With

End

'**********************************************************
'*      Creation table temporaire pour totalisation       *
'**********************************************************
Public Sub Ventilation()

  Dim Tab5 As String

  Tab5 = "Totalisation"
  Try Utils.db.Exec("LOCK TABLES " & Tab5 & " WRITE")
  Utils.db.Exec("DROP TABLE IF EXISTS  Totalisation ")
  Utils.db.Exec("CREATE TABLE " & Tab5 &
    "(compte Char(8) NOT NULL," &
    "intitule Char(40)," &
    "totalht Char(25)," &
    "totaltva Char(25)," &
    "codetva Char(2) not NULL," &
    "PRIMARY KEY (compte,codetva))" & Utils.db.Engine())

End
'**********************************************************
'*                   Maj Totalisation                     *
'**********************************************************

Public Sub Maj_Totalisation()

  Dim Mtva As String
  Dim Totht As String
  Dim Tottva As String
  Dim Remise As String
  Dim Tab, Tab3, Tab4, Tab5 As String
  Dim rrResult As Result

  Tab = "Fiches_Fam"
  Tab5 = "Totalisation"
  Tab3 = "Fiches_Comptes"
  Tab4 = "Fiches_Tvaav"
  TotTva = "O.OO"
  With utils
    ' Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE, " & Cbase.Table("TabComptes") & " WRITE")
    ' On recupere le compte vente et le code TVa de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " Where code_fam = &1", Fam)
    If rResult.Available Then
      cpt = rResult!compt_fam
      Ctva = rResult!cdtva_fam
      cptRem = rResult!cptrem_fam
    Endif
    ' On recupere les données du compte vente de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", cpt)
    If rResult.Available Then
      Intit = rResult!intitule_cc
    Endif
    'On recupere le compte de TVA et son taux de TVA
    rResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " Where code_tva = &1", Ctva)
    If rResult.Available Then
      cpttva = rResult!cc_tva
      Ttva = rResult!taux_tva
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", cpttva)
    If rResult.Available Then
      IntitTva = rResult!intitule_cc
    Endif
    'On calcule le montant de la TVA
    Mtva = Format$(Val(.cpoint(Totttc)) - (Val(.cpoint(totalht))), "0.00")
    'Si ce n'est pas un compte TVA on regarde si le compte existe deja dans la table temporaire
    If Left$(cpt, 4) <> "4457" Then
      rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 AND codetva = &2", cpt, 0)
    Else
      'Sinon on recupere le compte TVA correspondant au taux
      rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and codetva = &2", cpt, Ctva)
    Endif
    'Si le compte existe dans la table temporaire
    If rrResult.Available Then
      Totht = Format$(Val(.cpoint(rrResult!totalht)) + Val(.cpoint(totalht)), "0.00")
      TotTva = Format$(Val(.cpoint(rrResult!totaltva)) + Val(.cpoint(Mtva)), "0.00")
      If Prxdec Then
        Totht = Round(Val(Totht))
        TotTva = Round(Val(TotTva))
      Endif
      'Si ce n'est pas un compte TVA on met a jour sans le code TVA
      If Left$(cpt, 4) <> "4457" Then
        Utils.db.Exec("UPdate " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva =&4 Where compte = &1 and codetva = &5", cpt, Intit, Totht, TotTva, 0)
      Else
        'Si c'est un compte TVA on met a jour avec le code TVA
        Utils.db.Exec("UPdate " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva =&4 Where compte = &1 and codetva = &5", cpt, Intit, Totht, TotTva, Ctva)
      Endif
    Else
      'Si le compte n'existe pas dans la table temporaire
      Totht = Format$(Val(.cpoint(totalht)), "0.00")
      If Prxdec Then Totht = Round(Val(Totht))
      'Si ce n'est pas un compte TVA on crée avec un code TVA a zéro
      If Left$(cpt, 4) <> "4457" Then
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", cpt, Intit, Totht, Mtva, 0)
      Else
        'Sinon on crée avec le code TVA
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", cpt, Intit, Totht, Mtva, Ctva)
      Endif
    Endif
    rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and codetva = &2", cpttva, Ctva)
    If rrResult.Available Then
      TotTva = Format$(Val(.cpoint(rrResult!totaltva)) + Val(.cpoint(Mtva)), "0.00")
      Totht = Format$(Val(.cpoint(rrResult!totalht)) + Val(.cpoint(totalht)), "0.00")
      If Prxdec Then
        TotTva = Round(Val(TotTva))
        Totht = Round(Val(Totht))
      Endif
      Utils.db.Exec("UPdate " & Tab5 & " set compte = &1, intitule =&2, totaltva =&3, codetva = &4, totalht = &5 Where compte = &1 and codeTva = &4", cpttva, Intittva, Tottva, Ctva, Totht)
    Else
      Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totaltva, codetva, totalht) VALUES (&1, &2, &3, &4, &5)", cpttva, Intittva, Mtva, Ctva, Totht)
    Endif
    Totht = 0
    Remise = 0
  End With

End

Public Sub Verif_solde()

  Dim hResult As Result
  Dim sCompte As String
  Dim sTotalD As String = "0"
  Dim sTotalC As String = "0"
  Dim sdif As Float

  With utils
    hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " order by compte")
    If hResult.Available Then
      Repeat
        If Left$(hResult!compte, 3) = "411" Then
          sTotalD = hResult!totalht
        Else
          If Left$(hResult!compte, 3) = "445" Then
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totaltva))
          Else
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totalht))
          Endif
          sCompte = hResult!compte
        Endif
      Until hResult.MoveNext()
      hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " Where compte = &1", sCompte)
      If Val(.cpoint(sTotalD)) < Val(.cpoint(sTotalC)) Then
        sDif = Val(.cpoint(sTotalC)) - Val(.cpoint(sTotalD))
        sDif = Val(.cpoint(hResult!totalht)) - sDif
        Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
      Else
        If Val(.cpoint(sTotalD)) > Val(.cpoint(sTotalC)) Then
          sDif = Val(.cpoint(sTotalD)) - Val(.cpoint(sTotalC))
          sDif = Val(.cpoint(hResult!totalht)) + sDif
          Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
        Endif
      Endif
    Endif
  End With

End

'**********************************************************
'*                   Maj comptabilité                     *
'**********************************************************
Public Sub Maj_Compta()

  Dim cpt, jnal, $intitule As String
  Dim coll As String
  Dim collectif As String
  Dim Libel As String
  Dim Mtc As Float
  Dim Mtd As Float
  Dim Sld, Montantcheque, totf As Float
  Dim Valid As Integer
  Dim Prov As Integer
  Dim Tresor As Integer
  Dim pointee As Integer
  Dim lettree As Integer
  Dim cloturee As Integer
  Dim relance As Integer
  Dim rrResult As Result
  Dim Tmvt, Tab, Tab2, Tab3, Tab5, Tab6 As String
  Dim jl, hresult As Result

  Tmvt = "Fiches_Mvt"
  Tab = "Fiches_Parametres"
  Tab2 = "Totalisation"
  Tab3 = "Fiches_Comptes"
  Tab5 = "Fiches_Journaux"
  Tab6 = "Fiches_Cli"
  Valid = 1
  Prov = 0
  Tresor = 0
  pointee = 0
  lettree = 0
  cloturee = 1
  relance = 0
  numecr = "numecriture"
  numr = Ecritures(numecr)
  numr = numr + 1
  numrd = numr
  numecr = "numecriture2"
  numr2 = Ecritures(numecr)
  numr2 = numr2 + 1
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & "")
    If rResult.Available Then
      Repeat
        collectif = ""
        cpt = rResult!compte
        Intit = rResult!intitule
        If Left$(cpt, 3) = "411" Then
          rrResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", cpt)
          coll = rrResult!coll_cc
          collectif = "1"
          $intitule = rrResult!intitule_cc
          If Val(.cpoint(Mttc)) > 0 Then
            Libel = "Facture " & Intit
          Else
            Libel = "Avoir " & Intit
          Endif
          If rResult!totalht <> "" And Val(.cpoint(rResult!totalht)) > 0 Then
            Mtd = Val(.cpoint(rResult!totalht))
            Mtc = 0
            Totf = Mtd
          Else
            Mtc = Abs(Val(.cpoint(rResult!totalht)))
            Mtd = 0
            Totf = Mtc
          Endif
          If radiobutton2.value Then
            If IsNull(rglt.text) Then Rglt.Text = "0"
            If IsNull(rglt2.text) Then Rglt2.Text = "0"
            If Val(rglt.Text) + Val(rglt2.Text) = Val(rResult!totalht) And Rgmt.Value = True Then
              If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Chèque" Then Lettree = 1
              If Not IsNull(Regmt2.text) Then
                If Regmt2.text = "Espèces" Or If Regmt2.text = "Carte" Or If Regmt2.text = "Chèque" Then
                  Lettree = 1
                Else
                  Lettree = 0
                Endif
              Endif
            Else
              Lettree = 0
            Endif
          Else
            Lettree = 0
          Endif
          Utils.db.Exec("INSERT INTO " & Tmvt & "(jour, numero, compte, collectif, intitule, dte, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef,dteval) VALUES (&1, &2, &3, &4, &5, &6, &7, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18},&{19})", Jnl, numr, coll, collectif, Intit, .Cdate_Dbase(dtef.Text), numerofac, Left$(Libel, 50), Mtd, Mtc, Valid, Prov, Tresor, pointee, lettree, cloturee, relance, numr2, Now)
          rrResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", coll)
          If rrResult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = rrResult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPdate " & Tab3 & " set solde = &2 Where compte_cc = &1", coll, Sld)
          collectif = ""
        Endif
        If Left$(cpt, 3) <> "411" And Left$(cpt, 3) <> "445" Then
          If Left$(rResult!compte, 3) <> "709" Then
            If Val(.cpoint(rResult!totalht)) > 0 Then
              Mtc = Val(.cpoint(rResult!totalht))
              Mtd = 0
            Else
              Mtd = Val(.cpoint(rResult!totalht))
              Mtc = 0
            Endif
          Else
            If Val(Mttc) > 0 Then
              If Val(.cpoint(rResult!totalht)) > 0 Then
                Mtd = Val(.cpoint(rResult!totalht))
                Mtc = 0
              Else
                Mtc = Val(.cpoint(rResult!totalht))
                Mtd = 0
              Endif
            Else
              If Val(.cpoint(rResult!totalht)) > 0 Then
                Mtd = Val(.cpoint(rResult!totalht))
                Mtc = 0
              Else
                Mtc = Val(.cpoint(rResult!totalht))
                Mtd = 0
              Endif
            Endif
          Endif
        Endif
        If Left$(cpt, 3) = "445" Then
          If rResult!totaltva <> "" And Val(rResult!totaltva) > 0 Then
            Mtc = Val(rResult!totaltva)
            Mtd = 0
          Else
            Mtd = Abs(Val(rResult!totaltva))
            Mtc = 0
          Endif
        Endif
        If Val(.cpoint(Mttc)) > 0 Then
          Libel = "Facture " & nom
        Else
          Libel = "Avoir " & nom
        Endif
        Mtd = Abs(mtd)
        Mtc = Abs(Mtc)
        If Prxdec Then
          Mtd = Round(Mtd)
          Mtc = Round(Mtc)
        Endif
        'Utils.db.Exec("INSERT INTO " & Tmvt & "(jour, numero, compte, intitule, dte, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnl, numr, cpt, Intit, .Cdate_Dbase(dtef.Text), Right$(Dtef.text, 2) & Mid$(Dtef.text, 4, 2) & Nfac, Libel, Mtd, Mtc, Valid, Prov, Tresor, pointee, lettree, cloturee, relance, numr2)
        Utils.db.Exec("INSERT INTO " & Tmvt & "(jour, numero, compte, intitule, dte, dateech, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", Jnl, numr, Cpt, Intit, .Cdate_Dbase(dtef.Text), .Cdate_Dbase(dateech2), numerofac, Left$(Libel, 50), Mtd, Mtc, Valid, Prov, Tresor, Pointee, lettree, Cloturee, Relance, numr2)
        rrResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", cpt)
        If rrResult!solde = "" Then
          Sld = Mtd - Mtc
        Else
          Sld = rrResult!solde + Mtd - Mtc
        Endif
        Utils.db.Exec("UPdate " & Tab3 & " set solde = &2 Where compte_cc = &1", cpt, Sld)
        Mtd = 0
        Mtc = 0
        sld = 0
      Until rResult.MoveNext()
      Sha1Calc.CalcSha1("Fiches_Mvt", Numr)
      'Maj_Parametres()
      ' On gère la première écriture de trésorerie
      If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Chèque" Then
        If Not IsNull(Rglt.Text) And Rgmt.value = True Then
          jl = Utils.db.Exec("SELECT * FROM " & Tab & "")
          If Regmt.text = "Espèces" Then
            Jnal = jl!jrnal2
          Else
            Jnal = jl!jrnal3
          Endif
          Numr = numr + 1
          cloturee = 1
          If Val(Rglt.Text) > 0 Then
            Mtc = Val(rglt.Text)
            Mtd = 0
          Else
            Mtd = Val(rglt.Text)
            Mtc = 0
          Endif
          jl = Utils.db.Exec("SELECT * FROM " & Tab5 & " where code_jo = &1", jnal)
          If Regmt.text = "Espèces" Then
            Cptreglt = jl!cde_banque
          Else
            If Regmt.text = "Carte" Then Cptreglt = Vic
            If Regmt.text = "Chèque" Then Cptreglt = Vichq
            If Not Start.LocalSettings["/Soc" & Start.Societe & "/Carte"] Or If Not Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
              Cptreglt = jl!cde_banque
            Endif
          Endif
          Libel = "Rglt " & Regmt.Text & " " & $intitule
          If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Paypal" Then
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Codeclient.Text, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
          Else
            If Regmt.text = "Chèque" Then
              If totf > 0 Then Montantcheque = Val(rglt.Text)
              'On mouvemente la table des bordereaux de chèques.
              If Not Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
                Utils.db.Exec("INSERT INTO " & "Fiches_BordereauxC" & "(code, nom, montant,dateremise,banque,nfacture ) VALUES (&1, &2, &3, &4, &5,&6)", Codeclient.Text, Rs2, Montantcheque, .Cdate_Dbase(Dtef.Text), jnal, Numerofac)
              Else
                If Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
                  Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Codeclient.Text, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
                  Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
                Endif
              Endif
            Endif
          Endif
          If Val(Rglt.Text) > 0 Then
            Mtd = Mtc
            Mtc = 0
          Else
            Mtc = Mtd
            Mtd = 0
          Endif
          If Regmt.text <> "Chèque" Or If Regmt.text = "Chèque" And Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Cptreglt, Left$(Regmt.text & " " & rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, 0, cloturee, .Cdate_Dbase(Dtef.Text))
          Endif
          Sha1Calc.CalcSha1("Fiches_Mvt", Numr)
          '*******************************On recalcule les soldes des comptes************************************
          If Val(rglt.Text) > 0 Then
            Mtc = Val(rglt.Text)
            Mtd = 0
          Else
            Mtd = Abs(Val(rglt.Text))
            Mtc = 0
          Endif
          'Pour le compte client
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Codeclient.Text)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Codeclient.Text, Sld)
          Mtd = 0
          'Pour le collectif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
          Mtd = 0
          Mtc = 0
          'Pour le compte de trésorerie
          Mtd = Val(rglt.Text)
          If Val(rglt.Text) > 0 Then
            Mtd = Val(rglt.Text)
            Mtc = 0
          Else
            Mtc = Val(rglt.Text)
            Mtd = 0
          Endif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cptreglt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Cptreglt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Endif
      Utils.db.Exec("UPDATE " & Tab & " set numecriture = &1, numecriture2 = &2", numr, numr2)

      ' On gère la seconde écriture de trésorerie
      If Regmt2.text = "Espèces" Or If Regmt2.text = "Carte" Or If Regmt2.text = "Chèque" Then
        If Val(Rglt2.Text) > 0 And Rgmt.value = True Then
          jl = Utils.db.Exec("SELECT * FROM " & Tab & "", jnal)
          If Regmt2.text = "Espèces" Then
            Jnal = jl!jrnal2
          Else
            Jnal = jl!jrnal3
          Endif
          Numr = numr + 1
          cloturee = 1
          If Val(rglt2.Text) > 0 Then
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Else
            Mtd = Abs(Val(rglt2.Text))
            Mtc = 0
          Endif
          jl = Utils.db.Exec("SELECT * FROM " & Tab5 & " where code_jo = &1", jnal)
          If Regmt2.text = "Espèces" Then
            Cptreglt = jl!cde_banque
          Else
            If Regmt2.text = "Carte" Then Cptreglt = Vic
            If Regmt2.text = "Chèque" Then Cptreglt = Vichq
            If Not Start.LocalSettings["/Soc" & Start.Societe & "/Carte"] Or If Not Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
              Cptreglt = jl!cde_banque
            Endif
          Endif
          Libel = "Rglt " & Regmt2.Text & " " & $intitule
          If Regmt2.text = "Espèces" Or If Regmt2.text = "Carte" Or If Regmt2.text = "Paypal" Then
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Codeclient.Text, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
          Else
            If Regmt2.text = "Chèque"
              If Totf > 0 Then Montantcheque = Val(rglt2.Text)
              'On mouvemente la table des bordereaux de chèques.
              If Not Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
                Utils.db.Exec("INSERT INTO " & "Fiches_BordereauxC" & "(code, nom, montant,dateremise,banque,nfacture ) VALUES (&1, &2, &3, &4, &5,&6)", Codeclient.Text, Rs2, Montantcheque, .Cdate_Dbase(Dtef.Text), jnal, Numerofac)
              Else
                If Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
                  Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Codeclient.Text, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
                  Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, Left$(rs2, 40), .Cdate_Dbase(Dtef.Text), Numerofac, Numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
                Endif
              Endif
            Endif
          Endif
          If Val(rglt2.Text) > 0 Then
            Mtd = Mtc
            Mtc = 0
          Else
            Mtc = Mtd
            Mtd = 0
          Endif
          If Regmt2.text <> "Chèque" Or If Regmt2.text = "Chèque" And Start.LocalSettings["/Soc" & Start.Societe & "/Cheque"] Then
            Utils.db.Exec("INSERT INTO " & Tmvt & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Cptreglt, Left$(Regmt2.text & " " & rs2, 40), .Cdate_Dbase(Dtef.Text), numerofac, numerofac, Left$(Libel, 50), mtd, mtc, 1, 0, 1, 0, cloturee, .Cdate_Dbase(Dtef.Text))
          Endif
          Sha1Calc.CalcSha1("Fiches_Mvt", Numr)
          '*******************************On recalcule les soldes des comptes************************************

          If Val(rglt2.Text) > 0 Then
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Else
            Mtd = Val(rglt2.Text)
            Mtc = 0
          Endif
          'Pour le compte client
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Codeclient.Text)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Codeclient.Text, Sld)
          Mtd = 0
          'Pour le collectif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
          Mtd = 0
          Mtc = 0
          'Pour le compte de trésorerie
          If Val(rglt2.Text) > 0 Then
            Mtd = Val(rglt2.Text)
            Mtc = 0
          Else
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Endif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cptreglt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Cptreglt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Endif
    Endif
    Utils.db.Exec("UPDATE " & Tab & " set numecriture = &1, numecriture2 = &2", numr, numr2)
  End With

End

'**********************************************************
'*       Calcul de la Tva pour le bas de facture          *
'**********************************************************
Public Sub Calc_tva(borientation As Boolean)

  Dim cpt As String
  Dim Mtva As String
  Dim Mtva2 As String
  Dim Mttc2 As String
  Dim efacs As String
  Dim Mht As String
  Dim Ttx As Float
  Dim Tva As String
  Dim CResult As Result
  Dim entf As String
  Dim cptrst As Result
  Dim efac As Result
  Dim NbTx As Integer ' flag pour calcul du nombre de taux de tva utilisé dans la facture
  Dim ImpAuto As Boolean = False
  Dim Tab As String = "Fiches_Tvaav"
  Dim Tab2 As String = "Totalisation"

  Entf = $fac
  Efacs = "Fiches_Cli"
  Nbtx = 1
  Tva = "0"
  If Start.LocalSettings["/Soc" & Start.Societe & "/AutoEnt"] <> 0 Then
    ImpAuto = True
  Else
    ImpAuto = False
  Endif
  If IsNull(Start.LocalSettings["/Soc" & Start.Societe & "/AutoEnt"]) Then ImpAuto = False
  With Utils
    cptrst = Utils.db.Exec("SELECT * FROM " & Tab & "")
    If cptrst.Available Then
      Repeat
        Ttx = cptrst!taux_tva
        Ctx = cptrst!code_tva
        Cresult = Utils.db.Exec("SELECT * FROM " & Tab2 & " Where codetva = &1", Ctx)
        If Cresult.Available Then
          Repeat
            cpt = CResult!compte
            If Left$(cpt, 3) = "445" Then
              Mtva2 = Format$(Val(CResult!totaltva), ",0.00")
              If IsNull(Mtva2) Then Mtva2 = "0,00"
              Mht = Format$(Val(CResult!totalht), ",0.00")
              Mttc = Val(CResult!totalht) * (1 + (Ttx / 100))
              Mtva2 = Val(Utils.cpoint(Mttc)) - Val(CResult!totalht)
              If IsNull(Mht) Then Mht = "0,00"
              If Prxdec Then
                Mtva2 = Round(Val(Mtva2))
                Mtva2 = Format$(Val(Mtva2), ",0")
                Mht = Round(Val(Mht))
                Mht = Format$(Val(Mht), ",0")
              Endif
              If Val(Mtva2) <> 0 Then
                If Prxdec Then
                  Mtva = Format$(Val(.cpoint(Mtva2)), "0")
                  ctx = Format$(Val(ctx), "0")
                  Mtva2 = Format$(Val(.cpoint(Mtva2)), "0")
                Else
                  Mtva = Mtva2
                  Mtva2 = Format$(Val(.cpoint(Mtva2)), "0.00")
                Endif
                Tva = Val(.cpoint(Tva)) + Val(.cpoint(Mtva2))
                Tva = Format$(Val(.cpoint(Tva)), "0.00")
                If ImpAuto = False Then pdf.Level9F(Ctx, Mht, Ttx, Mtva2, Mttc, PosY)
                PosY = PosY + 3
                Inc Nbtx
              Endif
            Endif
          Until Cresult.MoveNext()
        Else
          Mtva = "0,00"
        Endif
      Until cptrst.MoveNext()
    Endif
    Posy = 274
    If Not Reserve.Value Then
      'Txtleg = ""
      Txtleg2 = ""
    Endif
    Mttc = Format$(Val(.cpoint(Toteuros)) + Val(.cpoint(Tva)), "0.00")
    If Prxdec Then
      Tva = Format$(Val(Tva), "0")
    Else
      Tva = Format$(Val(Tva), "0.00")
    Endif
    If Prxdec Then
      Mttc2 = Format$(Val(Mttc), "0" & " " & devises)
      Toteuros = Format$(Toteuros, "0")
    Else
      Mttc2 = Mttc & " " & devises
      Toteuros = Format$(Toteuros, "0.00")
    Endif
    If borientation Then PosY = 191
    pdf.Level10F(Toteuros, Tva, Mttc2, Txtleg, PosY - 6, "", "", "")
    If Start.LocalSettings["/Soc" & Start.Societe & "/Coupon"] Then pdf.Level15F(CCli, numerofac, Mttc2, PosY, Devises)
    PosY = PosY + 8
    pdf.Level11F(Txtleg2, PosY)
    efac = Utils.db.Exec("SELECT * FROM " & efacs & " where cli_code = &1", Colbl.Item[0])
    If dateech = " à réception." Then dateech = dtef.text
    If Not Divers.value Then
      Utils.db.Exec("INSERT INTO " & Entf & "(numfac,datefac,cdclifac,cvclifac, nmclifac, rmofac, rartfac, pnmclifac, adr1fac, adr2fac, cpfac, villefac, Exofac, remmofac, remartfac, totfac, reg, ech, numerobl, acpt, mreg, marge_art, marge_mo, totfacttc,gestfac) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16},&{17},&{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25})", numerofac, .Cdate_Dbase(datej.Text), Colbl.Item[0], efac!cli_rs_soc, efac!cli_nom, 0, 0, efac!cli_pnm, efac!cli_adr1, efac!cli_adr2, efac!cli_cd_ptl, efac!cli_ville, "0", .cpoint(Remmo), .cpoint(Remart), Val(Toteuros), "", .Cdate_Dbase(dateech), "", 0, "", mgart, mgmo, Val(Mttc), Val(frais))
    Else
      Utils.db.Exec("INSERT INTO " & Entf & "(numfac,datefac,cdclifac,cvclifac, nmclifac, rmofac, rartfac, pnmclifac, adr1fac, adr2fac, cpfac, villefac, Exofac, remmofac, remartfac, totfac, reg, ech, numerobl, acpt, mreg, marge_art, marge_mo, totfacttc,gestfac) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16},&{17},&{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25})", numerofac, .Cdate_Dbase(datej.Text), Colbl.Item[0], "", Nom, 0, 0, "", adr1, adr2, cpcli, villecli, "0", .cpoint(Remmo), .cpoint(Remart), Val(Toteuros), "", .Cdate_Dbase(dateech), "", 0, "", mgart, mgmo, Val(Mttc), Val(frais))
    Endif
    Nlgn = "0000"
    Totht = "0"
    mgart = "0"
    mgmo = "0"
    Ent_Archives()

  End With

End

Public Sub Maj_Traite()

  Dim Traite As String
  Dim Accept As Boolean = False

  If UCase$(Reglmt) = "TRAITE" Then
    Accept = True
  Else
    Accept = False
  Endif
  Traite = "Fiches_Traites"
  If dateech = " à réception." Then dateech = dtef.text
  Utils.db.Exec("insert into  " & Traite & "  (code, nom, numfac, montant, datech, date, acceptee, ecartee) value (&1, &2, &3, &4, &5, &6, &7, &8)", CCli, Rs2, numerofac, Mttc, Utils.Cdate_Dbase(dateech), Utils.Cdate_Dbase(dtef.Text), Accept, 0)

End

'***************************************************
'*                   Maj  Archives                 *
'***************************************************
Public Sub Ent_Archives()

  Dim Entbonl As Result
  Dim Ligbonl As Result
  Dim rTva As Result
  Dim Ligf As String
  Dim bn As String
  Dim Dt As String
  Dim TauxTva As String

  Dt = numerofac
  Ligf = $ligfac
  Bn = "Bl"
  With Utils
    If Not Divers.value Then
      Bonl = Utils.db.Exec("SELECT * FROM " & Bn & " where code = &1 order by num", Colbl.Item[0])
    Else
      Bonl = Utils.db.Exec("SELECT * FROM " & Bn & " where code = &1 and nom = &2 order by num", Colbl.Item[0], Colbl.Item[1])
    Endif
    If Bonl.Available Then
      Repeat
        Entbonl = Utils.db.Exec("SELECT * FROM " & $bl & " where numbl = &1", Bonl!num)
        Ligbonl = Utils.db.Exec("SELECT * FROM " & $ligbl & " where num_ligbl = &1", Bonl!num)
        If Ligbonl.Available Then
          intituleb = "Bon n° " & Entbonl!numbl & " du " & .Cdate_Aff(Entbonl!datebl)
          Nlgn = Format$(Val(Nlgn) + 1, "0000")
          Utils.db.Exec("INSERT INTO " & Ligf & "(num_ligfac,numlig_ligfac, com_ligfac, typel_ligfac) VALUES (&1, &2, &3, &4)", Dt, Nlgn, intituleb, "C")
          Repeat
            Nlgn = Format$(Val(Nlgn) + 1, "0000")
            Try rTva = Utils.db.Exec("select * from " & Cbase.Table("TabTvav") & " where code_tva = &1", Ligbonl!tx_ligbl)
            If rTva.available Then TauxTva = rTva!taux_tva
            If $soption = "P" Or $soption = "T" Then
              Utils.db.Exec("INSERT INTO " & Ligf & "(num_ligfac,numlig_ligfac,code_ligfac,libel_ligfac, fam_ligfac, pu_ligfac, qte_ligfac, brut_ligfac, rem_ligfac, netht_ligfac, tx_ligfac, nettc_ligfac, typel_ligfac, tm_ligfac, com_ligfac, bloc, mtx_ligfac, mrgart_ligfac, mrgmo_ligfac,tour_ligfac,tipp_ligfac, dtligbl_ligfac, numbl_ligfac) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23})", Dt, Nlgn, Ligbonl!code_ligbl, Ligbonl!libel_ligbl, Ligbonl!fam_ligbl, Ligbonl!pu_ligbl, Ligbonl!qte_ligbl, Ligbonl!brut_ligbl, Ligbonl!rem_ligbl, Ligbonl!netht_ligbl, Ligbonl!tx_ligbl, Ligbonl!nettc_ligbl, Ligbonl!typel_ligbl, Ligbonl!tm_ligbl, Ligbonl!com_ligbl, Ligbonl!block_ligbl, TauxTva, Ligbonl!mrgart_ligbl, Ligbonl!mrgmo_ligbl, Ligbonl!tour_ligbl, Ligbonl!tipp_ligbl, Ligbonl!dte_ligbl, Ligbonl!num_ligbl)
            Else
              Utils.db.Exec("INSERT INTO " & Ligf & "(num_ligfac,numlig_ligfac,code_ligfac,libel_ligfac, fam_ligfac, pu_ligfac, qte_ligfac, brut_ligfac, rem_ligfac, netht_ligfac, tx_ligfac, nettc_ligfac, typel_ligfac, tm_ligfac, com_ligfac, bloc, mtx_ligfac, mrgart_ligfac, mrgmo_ligfac,tour_ligfac,  dtligbl_ligfac, numbl_ligfac) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22})", Dt, Nlgn, Ligbonl!code_ligbl, Ligbonl!libel_ligbl, Ligbonl!fam_ligbl, Ligbonl!pu_ligbl, Ligbonl!qte_ligbl, Ligbonl!brut_ligbl, Ligbonl!rem_ligbl, Ligbonl!netht_ligbl, Ligbonl!tx_ligbl, Ligbonl!nettc_ligbl, Ligbonl!typel_ligbl, Ligbonl!tm_ligbl, Ligbonl!com_ligbl, Ligbonl!block_ligbl, TauxTva, Ligbonl!mrgart_ligbl, Ligbonl!mrgmo_ligbl, Ligbonl!tour_ligbl, Ligbonl!dte_ligbl, Ligbonl!num_ligbl)
            Endif
            If $soption = "B" Or $soption = "T" Then
              Utils.db.Exec("UPDATE Fiches_ligcons SET num=&1,type='F',numlig=&3 WHERE num=&2 And type='B' AND numlig=&4", Dt, Entbonl!numbl, Entbonl!numbl & Nlgn, Entbonl!numbl & Ligbonl!numlig_ligbl)  'on met le n° facture, type à F et on renome le n° ligne dans le fichier ligne de consigne
              utils.db.Exec("UPDATE Fiches_ligregie SET numlig=&1, type='S' WHERE num=&2 AND numlig=&3 AND type='C'", Entbonl!numbl & Nlgn, Dt, Entbonl!numbl & Ligbonl!numlig_ligbl) 'on met a jour le n° de ligne pour qu'il corresponde à celui de la facture
            Endif
          Until Ligbonl.MoveNext()
        Endif
        If $soption = "B" Or $soption = "T" Then
          Utils.db.Exec("UPDATE Fiches_ligcons SET num=&1,type='F' WHERE num=&2 AND type='B' AND numlig='D'", Dt, Entbonl!numbl)  'on met les n°factures sur les lignes de déconsigne
        Endif
        Bl_Sup()
      Until Bonl.MoveNext()
    Endif
    'UNTIL Colbl.MoveNext()
  End With

End

'*****************************************************
'*  Récuperation du dernier numéro d'écriture        *
'*****************************************************
Public Function Ecritures(numecr As String) As String

  Dim Params As Result
  Dim Tab As String
  Dim nro As String

  Tab = "Fiches_Parametres"
  Params = Utils.db.Exec("SELECT " & numecr & " FROM " & Tab & " ")
  If Params.Available Then
    If IsNull(Params["" & numecr & ""]) Then
      nro = 0
    Else
      nro = Params["" & numecr & ""]
    Endif
  Endif
  Return nro

End

'************************************************
'*  Mise a jour du dernier numéro d'écriture    *
'************************************************
Public Sub Majnum()

  Dim Tab As String

  Tab = "Fiches_Parametres"
  Utils.db.Exec("UPDATE " & Tab & " set numecriture = &1, numecriture2 = &2", numr, numr2)

End

'**********************************************************
'*      Suppression Bon après édition de facture          *
'**********************************************************
Public Sub Bl_Sup()

  Utils.db.Exec("DELETE FROM " & $bl & " where numbl = &1", Bonl!num)
  Utils.db.Exec("DELETE FROM " & $ligbl & " where num_ligbl = &1", Bonl!num)

End

Public Sub Button9_Click()

  If $process Then Return
  If Colbl.Count <> 0 Then
    Bl_Edit()
  Else
    Message.Warning("Veuillez lancer votre traitement avant d'imprimer SVP ! ")
  Endif

End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Function ard(Puttc As String) As String

  If Not PuTTc Then PuTTc = "0,00"
  If ardi = "0,05" Then
    If Right$(Puttc) Like "[34567]*" Then
      Puttc = Left$(Puttc, (Len(Puttc) - 1)) & "5"
    Else
      Puttc = Round(Val(Puttc), -1)
      If typeL = "A" Then Puttc = Format$(Puttc, nbdec)
    Endif
  Endif

  If ardi = "0,10" Then
    Puttc = Round(Val(Puttc), -1)
    If typeL = "A" Then Puttc = Format$(Puttc, nbdec)
  Endif

  If ardi = "0,50" Then
    If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 25)) Then
      Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "00"
    Else
      If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 75)) Then
        Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "50"
      Endif
      If Abs(Val(Puttc)) >= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 76)) Then
        Puttc = Round(Val(Puttc))
        If typeL = "A" Then Puttc = Format$(Puttc, nbdec)
      Endif
    Endif
  Endif

  If ardi = "1,00" Then
    Puttc = Round(Val(Puttc))
    If typeL = "A" Then Puttc = Format$(Puttc, nbdec)
  Endif
  Return Puttc

End

Public Sub Button16_Click()

  Me.Close

End

Public Sub Button28_Click()

  Impression()
  Regmt2.text = ""
  Rglt2.text = ""
  Panel10.visible = False

End

Public Sub dte_DblClick()

  If DateChooser1.visible = False Then
    If Not Last.ReadOnly Then
      DateChooser1.visible = True
      DateChooser1.Raise
      DateChooser1.Tag = Last
    Endif
  Else
    DateChooser1.Visible = False
  Endif

End

Public Sub DateChooser1_Activate()

  DateChooser1.tag.text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  DateChooser1.Visible = False

End

Public Sub dte_KeyPress()

  If Key.code = Key.Escape Then
    If DateChooser1.Visible = True Then DateChooser1.Visible = False
  Endif
  If Key.code = Key.F2 Then
    If DateChooser1.Visible = True Then
      DateChooser1.Visible = False
    Else
      If Not Last.ReadOnly Then
        DateChooser1.Visible = True
        DateChooser1.Raise
        DateChooser1.Tag = Last
      Endif
    Endif
  Endif

End

Public Sub Rgmt_Click()

  If Rgmt.Value = True Then
    HBox6.Visible = True
    HBox5.Visible = True
    Rglt.text = Colbl.Item[5]
  Else
    HBox6.Visible = False
    HBox5.Visible = False
    Rglt.clear
  Endif

End

Public Sub Regmt_Change()

  If Regmt.text = "Virement" Or If Regmt.text = "Traite" Or If Regmt.text = "Lcr" Then
  Else
    Rglt.ReadOnly = False
  Endif

End

Public Sub rglt_LostFocus()

  Try Rglt.text = Format$(Val(Utils.cpoint(Rglt.text)), "0.00")
  If Error Then
    Message.Warning("Veuillez vérifier votre saisie SVP !")
    Rglt.Select
    Rglt.setfocus
  Endif

End

'**********************************************
'*     Affichage de la documentation Html     *
'**********************************************
Public Sub Button7_Click()

  Doc.Open("FacturesFinMois")

End

Public Sub Divers_Click()

  Button1_Click()

End

Public Sub Buttour_Click()

  Dim rtour As Rechtour

  rtour = New Rechtour As "tourne"
  rtour.Showmodal

End

Public Sub tourne_trouve(value As String)

  Labeltour.Text = value

End

Public Sub combregr_Click()

  If combregr.Current.Text = "Sans" Then
    datei.Clear
    datei.Background = &HD4D0C8&
    datei.ReadOnly = True
  Else
    datei.Background = Color.TextBackground
    datei.ReadOnly = False
    datei.SetFocus
    datei.SelectAll
  Endif

End

Public Sub Checentr_Click()

  If Checentr.Value Then
    $bl = "Fiches_BlM"
    $ligbl = "Fiches_LigblM"
    $fac = "Fiches_HistoFacM"
    $ligfac = "Fiches_HistoLigfacM"
  Else
    $bl = "Fiches_Bl"
    $ligbl = "Fiches_Ligbl"
    $fac = "Fiches_HistoFac"
    $ligfac = "Fiches_HistoLigfac"
  Endif

End
