' Gambas class file

'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à  The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA

'################################################
'# Nom du fichier           : Facture.class
'# Auteur                   : Jacky Tripoteau
'# Date de création         : 01/02/2005
'# Gestion de la facturation
'################################################
'
hForm As Fcalc
Factbl[10] As String
Motable[4] As String
n As Integer
Nv As Integer
Nbl As Integer
T As Integer ' Flag qui determine le message a afficher en cas de modif de prix
Tp As String
Tp2 As String
Tri As String
Tribl As String
Tribl2 As String
tab As String
Tab2 As String
Tab3 As String
Tab4 As String
Tab5 As String
Tab6 As String
tabmo As String
sel As String
arr As String
Atype As String
typeL As String
Cdivers As String
Nlgn As String
Nbd As String
Nbdec As String
Totalmo As String
Totalart As String
Totalrem As String
Totalmottc As String
Totalartttc As String
Totalremttc As String
Totalht As String
Totalttc As String
Ttva As Float
Tx As Float
B As Integer = 0
ChkFocus As Integer = 2 'gère la perte de focus. 0 gestion normale, 1 gestion suite à modif, 2 gestion bloquée pour faire une recherche (clic sur togglebutton 2)
Chkf As Integer = 0
Nvc As Integer
ye2 As Integer
dte As String
dte2 As String
dte3 As String
Nfac As String
rResult As Result
Rligbl As Result
Filename As String
Jour As String
Jnl As String
Intit As String
numecr As String
numr As Integer ' Numero ecriture provisoire
numr2 As Integer ' numero ecriture définitif
numrd As Integer 'numéro d'écriture pour la GED
Cpt As String
CptRem As String
Ctva As String
Ctx As String
Cpttva As String
IntitTva As String
Txtleg As String
Txtleg2 As String
Remmo As String
Remart As String
Stk As Boolean
Ecotaxe As Boolean
Valeur_ecotaxe As Float
Ecotaxe2 As Boolean
Valeur_ecotaxe2 As Float
Taxepv As Boolean
Valeur_Copp As Float
Tva550 As Integer
Codetva As String
Artdsg2 As String
dateech As String
Impfac As Integer ' Flag pour savoir si la facture à été imprimée
qteecot As Float
Bloc As String 'numéro de bloc de la ligne séléctionnée
Ardi As String
Paht As String
Pmp As String
Codeart As String
Nvart As String ' Flag pour savoir s'il s'agit d'un nouveau produit
Modif As String ' Flag pour savoir si la ligne est en modification
NlgModif As String ' Flag pour récuperer le numéro de ligne modifiée
qte_Cbarre As String = "0" 'Flag pour saisie des quantités en lecture code barre par F9
Imp As String ' Impression facture
Editfac As String ' Flag pour savoir si on peut imprimer la facture
Nmfac As String ' Numéro de facture si facture déjà imprimée
Dfac As String ' Date de facture si facture déjà imprimée
CoulB As Integer ' Variable pour la couleur du background
CoulF As Integer ' Variable pour la couleur du Foreground
Fnt As String ' Variable pour la police
'ikey As Integer ' Position du document selectionné
ChangePu As String ' flag bruht pour art
ChangeB As String ' flag bruht pour mo
ChangeP As String ' flag puht net pour mo et art
ChangeTx As String ' flag Txhr pour mo
ChangeR As String ' Flag pour Rem pour mo et art
ChangeT As String ' Flag pour Nettc pour mo et art
ChangeTm As String ' Flag pour Temps/montant Mo
Numfac As String ' utilisé pour archivage facture
Dtefac As String ' utilisé pour archivage facture
Ech As String ' utilisé pour archivage facture
Val_retro As String ' variable pour coeff retrocession
Colvente As Float ' variable pour Colisage de vente
PVHT2 As Float ' Variable pour le prix de vente du colisage
Prg As String
Typec As String ' Type client pour remises par type client
RemType As String ' montant de la remise pour le produit selectionné et le type client
Dbl As String
Tabcli As String
Private Rms As New String[6, 3] ' Tableau des remises quantitatives
Mrgmo As Float = 0
Mrgart As Float = 0
PosY As Integer
Visudoc As Boolean
Devises As String
Coulfond As New String[]
Rs2 As String
Artbarre As String
Private $Desc As Boolean
pdx As String
Gmateriel As Boolean 'si gestion du materiel dans les preferences
Materiel As Boolean ' si le produit est un materiel
Tmat As String = "Fiches_Materiels"  'table des materiels
rmat As Result
Produit As String
Blocnum As String
Numligbl2 As String
Mnetht As String
Mnettc As String
Lbarre As Integer = 0 'permet de savoir si on fait une lecture code barre dans coldetail
Majnumserie As Integer = 1
l5 As String = "" ' valeur de la derniere ligne du bloc selectionné
Nlgapp As String ' flag pour récupéré le numéro de ligne à modifier
Impcar As Boolean = False ' flag pour impression des caractéristiques
Promo As Boolean = False
Cpromo As String ' code promo en cours
Apromo As Boolean 'flag pour savoir si le produit est en promo
bNet As Boolean = False 'flag pour savoir si on gère la mention "Net" en remise
Pdc As Boolean = False ' si le produit est un produit composé
Avr As Boolean = True 'flag pour savoir si on duplique un devis ou si on fait un avoir
Commentaire As String
PrvtMo As Float
TxhtMo As Float
ComboTest As Boolean = False
CptVente As Boolean = True
Private spiece As String
Private spvcons As String ' Prix de vente conseillé
Private sreg As String
Private ImpAuto As Boolean = False
Private Franchise As Boolean = False
Private Prxdec As Boolean = False
Private sDsg As String ' dernière désignation. Rappelée par * dans zone désignation
Private sArt As String ' dernier code article. Rappelé par * dans zone code article
Public Codearticle As String
Public CodeClient As String
Public numeroFac As String
Public Bsel As Boolean = False
Public bRemise As Boolean = False
Private sel2 As String
Private hColbl As Boolean = False
Private Proform As String = Start.Proform
Private Commande As String = Start.Commande
Private Devis As String = Start.Devis
Private Devis2 As String = Start.Devis2
Private Bon As String = Start.Bon
Private Facture As String = Start.Facture
Private pdf As Cdocuments
Private pdf2 As Cdocuments2
Private Tcli As Boolean = False
Private Tcoeff As Float = 0
Private ComboCom As Boolean = False
Private TvaCli As String
Private Equ As Boolean = False
Private Chkbtn As Boolean = True
Private encours As String
Private bencours As Boolean
Private soldecompte As Float
Private Pays As String
Public Codepostal As String
Public Bureaudistributeur As String
Public EnvoiMail As String
Private Dtab As String
Private Aban As String
Private ar$ As String
Private Coefdep As Float
Private XX As String
Private $UV As String
Private $crst As String
Private $Four As String
Private $Fam As String
Private typedoc As String
Private date2doc As Date
Private date1doc As Date
Private dt As String[] = Scan(Format$(Now, "yyyy/mm/dd"), "*/*/*")
Private $numbl As String
Private Nmuser As String 'nom user
Private Ecran As String
Private $photo As String

'**********************************************************
'*initialisation écrans et gestion onglet client          *
'**********************************************************
Public Sub _New()
  
  Dim rdep As Result
  Dim Frmt As New String[]
  'Dim n As Integer = 30
  
  date1doc = Date(dt[0], dt[1], dt[2])
  date2doc = date1doc - n
  Frame4.Visible = False
  ComboCom = True
  Coldetail.Columns.count = 17
  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If rResult.Available Then
    Val_retro = rResult!coretro
    devises = rResult!devise
    If IsNull(devises) Then devises = "Euro"
  Endif
  Try Gmateriel = Settings["/Soc" & Start.Societe & "/Materiel"]
  If Error Then Gmateriel = False
  Tabcli = "Fiches_Cli"
  Try Tva550 = Settings["/Soc" & Start.Societe & "/Tva550"]
  If Tva550 Then
    Codetva = Settings["/Soc" & Start.Societe & "/Codetva"]
  Else
    tvar.Visible = False
  Endif
  If Settings["/Soc" & Start.Societe & "/Depannage"] Then Depg.Visible = True
  If Settings["/Soc" & Start.Societe & "/Fht"] Then
    sFacht.Value = True
    sTTC.value = True
  Endif
  If Not Settings["/Soc" & Start.Societe & "/Gestion"] Then
    ToggleButton7.Visible = True
    Solde.Visible = True
    TextLabel37.Visible = True
  Endif
  If Settings["/Soc" & Start.Societe & "/AutoEnt"] <> 0 Then
    ImpAuto = True
  Else
    ImpAuto = False
  Endif
  If Settings["/Soc" & Start.Societe & "/Faca"] Then BfacA.visible = True
  If IsNull(Settings["/Soc" & Start.Societe & "/AutoEnt"]) Then ImpAuto = False
  If Settings["/Soc" & Start.Societe & "/Franchise"] <> 0 Then
    Franchise = True
  Else
    Franchise = False
  Endif
  If IsNull(Settings["/Soc" & Start.Societe & "/Franchise"]) Then Franchise = False
  Frmt = Utils.FColr(Settings["/Coul/Focus"])
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  Prxdec = Settings["/Soc" & Start.Societe & "/Prxdec"]
  If Prxdec Then 
    ar$ = "0"
  Else
    ar$ = "0,00"
  Endif
  Artqte.Text = "1,00"
  Music.Load(Start.Musique)
  Balloon.delay = 1000
  If Settings["/Soc" & Start.Societe & "/Poids"] <> "0" Then
    TextLabel65.Visible = True
    PdxArt.Visible = True
    TextLabel64.Visible = True
    Poids.Visible = True
  Else
    '    HPanel1.Width = 720
  Endif
  If Settings["/Soc" & Start.Societe & "/Depots"] Then
    Panel8.visible = True
    Rdep = Utils.db.Exec("select * from " & Cbase.Table("TabDepots") & " order by code")
    If Rdep.Available Then
      Dep.Add("")
      Repeat
        If Left$(Rdep!code, 2) <> "01" Then Dep.Add(Rdep!code & "-" & Rdep!libelle)
      Until Rdep.MoveNext()
    Endif
  Else
    Panel8.visible = False
  Endif
  If Not IsNull(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) And If Settings["/Soc" & Start.Societe & "/CodeVendeur"] <> "0" Then
    sVendeur.Text = Mid$(Settings["/Soc" & Start.Societe & "/CodeVendeur"], 3, Len(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) - 2)
    TextLabel70.Text = "Vendeur connecté"
  Else
    TextLabel70.Text = ""
  Endif
  Me.center
  n = 1
  T = 0
  Modif = 0
  Tp = "B"
  Prg = "1"
  Visudoc = False
  Randomize
  With Colbl
    .Columns.count = 9
    .Columns[0].Width = 1
    .Columns[1].Width = TYB.Width - 2
    .Columns[2].Width = NUMB.Width
    .Columns[3].Width = DAB.Width
    .Columns[4].Width = COB.width
    .Columns[5].Width = NOB.Width
    .Columns[6].Width = PRB.Width
    .Columns[7].Width = NUMF.Width
    .Columns[8].Width = 1
    
  End With
  CleanArt()
  Coldetail.Columns.count = 20
  Coldetail.Columns[0].Text = "N° Lg"
  Coldetail.Columns[1].Text = "Code"
  Coldetail.Columns[2].Alignment = Align.TopLeft
  Coldetail.Columns[2].Text = "Désignation"
  Coldetail.Columns[3].Alignment = 2
  Coldetail.Columns[3].Text = "Px Unitaire"
  Coldetail.Columns[4].Alignment = 2
  Coldetail.Columns[4].Text = "Qté/Tps"
  Coldetail.Columns[5].Alignment = 2
  Coldetail.Columns[5].Text = "Px brut"
  Coldetail.Columns[6].Alignment = 2
  Coldetail.Columns[6].Text = "Remise"
  Coldetail.Columns[7].Alignment = 2
  Coldetail.Columns[7].Text = "Px net"
  Coldetail.Columns[8].Alignment = 2
  Coldetail.Columns[8].Text = "Px TTC"
  Coldetail.Columns[9].Alignment = 3
  Coldetail.Columns[9].Text = "TL"
  lcoldetail()
  solde.Text = "0,00"
  If Not IsNull(Settings["/Soc" & Start.Societe & "/Taxe"]) Then
    TextLabel47.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
    TextLabel50.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
    TextLabel94.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
  Endif
  If Settings["/Soc" & Start.Societe & "/Factdef"] Then
    BFac.value = True
  Else
    If Settings["/Soc" & Start.Societe & "/Bldef"] Then
      Bbon.value = True
    Else
      If Settings["/Soc" & Start.Societe & "/Devisdef"] Then
        Bdevis.value = True
      Endif
    Endif
  Endif
  NOB.Text = "Nom client"
  
End

Public Sub Form_Open()
  
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabPromo") & " where datedeb <= &1 and datefin >= &1", Format$(Now, "yyyy-mm-dd"))
  If rResult.Available Then
    Promo = True
    Cpromo = rResult!code
  Endif
  Tbremq_Create()
  sel = ""
  Dbl = "1"
  ComboCom = True
  Titre()
  TriBl = "numbl"
  tribl2 = "numbl"
  Deb2()
  If $Desc = False Then
    Deb1()
  Else
    Deb2()
  Endif
  If Settings["/Soc" & Start.Societe & "/MoArt"] = True Then
    Motm_Click()
  Else
    If Settings["/Soc" & Start.Societe & "/ComArt"] = True Then
      Com_Click()
    Else
      BArt_Click()
    Endif
  Endif
  Imp = "0"
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  If Not Error Then
    Nlg.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlg.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  If Not Settings["/Soc" & Start.Societe & "/Afour"] Then
    ArtFour.Visible = False
    TextLabel41.Text = "Famille"
  Else
    ArtFour.Visible = True
    TextLabel41.Text = "Fournisseur"
  Endif
  ChkFocus = 2
  Datej.SetFocus
  
End

Public Sub lcoldetail()
  
  Dim WidthCol As String
  Dim s As String
  Dim spl As New String[11]
  
  Try WidthCol = Settings["/Soc" & Start.Societe & "/Col/LcolF"]
  If Not IsNull(WidthCol) Then
    WidthCol = Trim(WidthCol)
    If Right(WidthCol, 1) = ";" Then WidthCol = Left(WidthCol, Len(WidthCol) - 1)
    For Each s In Split(LCase(WidthCol), ";")
      spl = Scan(s, "*:*")
      Select Case Trim(spl[0])
        Case "col0"
          Try Coldetail.Columns[0].Width = spl[1]
        Case "col1"
          Try Coldetail.Columns[1].Width = spl[1]
        Case "col2"
          Try Coldetail.Columns[2].Width = spl[1]
        Case "col3"
          Try Coldetail.Columns[3].Width = spl[1]
        Case "col4"
          Try Coldetail.Columns[4].Width = spl[1]
        Case "col5"
          Try Coldetail.Columns[5].Width = spl[1]
        Case "col6"
          Try Coldetail.Columns[6].Width = spl[1]
        Case "col7"
          Try Coldetail.Columns[7].Width = spl[1]
        Case "col8"
          Try Coldetail.Columns[8].Width = spl[1]
        Case "col9"
          Try Coldetail.Columns[9].Width = spl[1]
      End Select
    Next
  Else
    Coldetail.Columns[0].Width = 50
    Coldetail.Columns[1].Width = 140
    Coldetail.Columns[2].Width = 350
    Coldetail.Columns[3].Width = 92
    Coldetail.Columns[4].Width = 60
    Coldetail.Columns[5].Width = 92
    Coldetail.Columns[6].Width = 55
    Coldetail.Columns[7].Width = 92
    Coldetail.Columns[8].Width = 92
    Coldetail.Columns[9].Width = 30
    Coldetail.Columns[10].Width = 30
  Endif
  
End

Public Sub CleanChamps()
  
  ComboTest = False
  num.Clear
  Datej.Clear
  Code.Clear
  Code3.Clear
  Cv.Text = ""
  Nom.Clear
  Nombl.clear
  Pnm.Clear
  Adr1.Clear
  Adr1bl.Clear
  Adr2.Clear
  Adr2bl.Clear
  Cp.Clear
  cpbl.Clear
  Burd.Clear
  villebl.Clear
  Telbur.Clear
  Teldom.Clear
  Telport.Clear
  Divers.Clear
  Totht1.Text = ar$
  Totva1.Text = ar$
  Tottc1.Text = ar$
  Txmo.Text = ar$
  Txpieces.Text = ar$
  solde.Text = ar$
  Totalmo = ar$
  Totalart = ar$
  Totalrem = ar$ 
  Totalmottc = ar$
  Totalart = ar$
  Totalartttc = ar$
  Totalht = ar$
  Totalttc = ar$
  Totmo.Text = ar$
  Totart.Text = ar$
  Totrem.Text = ar$
  Totht.Text = ar$
  Tottc.Text = ar$
  Tottva.Text = ar$
  Mrg.Text = ar$
  Exo.Value = False
  Majc.Value = False
  tvar.Value = False
  Retro.value = False
  Livraison.value = False
  Marge.Text = ar$
  MargeMo.Text = ar$
  Txmo.Text = "0,00"
  Txpieces.Text = "0,00"
  Rem.text = "0,00"
  Mrgmo = 0
  Mrgart = 0
  Acpt.Text = "0,00"
  Macompte.Clear
  Apromo = False
  Courriel.Clear
  Dep.Text = ""
  Dep.Enabled = True
  Cdivers = False
  Rglt.Clear
  Rglt2.Clear
  Rgmt.value = False
  XX = ""
  
End

Public Sub ChkPrx()
  
  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif
  
End

'**********************************************************
'*      Gestion des touches sur le panel Entete           *
'**********************************************************
Public Sub Entete2_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    
    Select Case Last.tag
        
      Case 1
        QuitteDate()
        If b <> "1" Then
          Code.SetFocus
          Code.Select
        Else
          Datej.SetFocus
          Datej.Select
          b = "0"
        Endif
        Stop Event
        
      Case 2
        If Impfac <> "1" And Not IsNull(code.text) Then
          Cli_man()
          If Val(solde.Text) > 0 Then
            code.Background = &HF51B03&
            Solde.Background = &HF51B03&
          Else
            Code.Background = Color.TextBackground
            Solde.Background = Color.TextBackground
          Endif
          If b <> 1 Then
            If Cdivers Then
              Cv.SetFocus
            Else
              Button13.SetFocus
            Endif
          Else
            b = 0
            Code.SetFocus
            Code.Select
          Endif
          Stop Event
        Endif
        
      Case 3
        Nom.SetFocus
        Nom.Select
        Stop Event
        
      Case 4
        If Code.Text = "" Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir votre client Svp ", "Ok")
          b = 1
        Endif
        If b <> 1 Then
          Pnm.SetFocus
          Pnm.Select
        Else
          b = 0
          Code.SetFocus
          Code.Select
        Endif
        Stop Event
        
      Case 5
        Adr1.SetFocus
        Adr1.Select
        Stop Event
        
      Case 6
        Adr2.SetFocus
        Adr2.Select
        Stop Event
        
      Case 7
        Cp.SetFocus
        Cp.Select
        Stop Event
        
      Case 8
        Cpman()
        Stop Event
        
      Case 9
        If Cdivers Then 
          Button13.SetFocus
        Else
          Telbur.SetFocus
          Telbur.Select
        Endif
        Stop Event
        
      Case 10
        Teldom.SetFocus
        Teldom.Select
        Stop Event
        
      Case 11
        Telport.SetFocus
        telport.Select
        Stop Event
        
      Case 12
        Txmo.SetFocus
        txmo.Select
        Stop Event
        
      Case 13
        Txpieces.SetFocus
        Txpieces.Select
        Stop Event
        
      Case 14
        Code.SetFocus
        Code.Select
        Stop Event
        
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        RdimColbl()
        Stop Event
        
      Case 2
        SelectionClient()
        Stop Event
        
      Case 3
        RdimColbl()
        Stop Event
        
      Case 8
        ToggleButton8_Click()
        
      Case 15
        'ToggleButton5_Click()
        'Stop Event
        
    End Select
  Endif
  
  If Key.code = Key.F4 Then
    Select Case Last.tag
      Case 2
        FClient.ShowModal() 
    End Select
  Endif
  
  If Key.code = Key.F5 Then
    ConVendeurs.ShowModal()
    If Settings["/Soc" & Start.Societe & "/CodeVendeur"] = "" Then
      sVendeur.Text = ""
      TextLabel70.Text = ""
    Else
      sVendeur.Text = Mid$(Settings["/Soc" & Start.Societe & "/CodeVendeur"], 3, Len(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) - 2)
      TextLabel70.Text = "Vendeur connecté"
    Endif
  Endif
  
  If Key.code = Key.F6 Then
    Select Case Last.tag
      Case 2
        If Settings["/Soc" & Start.Societe & "/Affaire"] Then ChiffreA()
      Case 3
        If Settings["/Soc" & Start.Societe & "/Affaire"] Then ChiffreA() 
      Case 4
        If Settings["/Soc" & Start.Societe & "/Affaire"] Then ChiffreA()
    End Select
  Endif
  
End

'***************************
'*      Gestion du focus.  *
'***************************
Public Sub Entete2_GotFocus()
  
  Try Utils.ObsGotf(Last)
  num.Background = &HD4D0C8&
  If Val(utils.cpoint(solde.Text)) > 0 And Settings["/Soc" & Start.Societe & "/Gestion"] <> "0" Then
    code.Background = &HF51B03&
  Else
    code.Background = Color.TextBackground
  Endif
  
End

Public Sub Entete2_LostFocus()
  
  Try Utils.ObsLstf(Last)
  If IsNull(solde.text) Then solde.text = "0,00"
  If Val(utils.cpoint(solde.Text)) > 0 And Settings["/Soc" & Start.Societe & "/Gestion"] <> "0" Then
    code.Background = &HF51B03&
    solde.Background = &HF51B03&
  Else
    code.Background = Color.TextBackground
    solde.Background = Color.TextBackground
  Endif
  Select Case Last.tag
      
    Case 1
      If Not IsNull(Datej.text) Then
        QuitteDate()
        If b <> "1" Then
          If nv = 0 Then
            Cv.SetFocus
            Cv.Select
          Else
            Code.SetFocus
            Nv = 0
          Endif
        Else
          Datej.SetFocus
          Datej.Select
          b = "0"
        Endif
      Endif
      Stop Event
  End Select
  
End

Public Sub Verif_Encours()
  
  If encours > "0" Then
    If Soldecompte >= Val(utils.cpoint(encours)) Then
      If Message.Question("Attention ! L'encours de ce client est dépassé.\nVoulez-vous continuer ?", "Oui", "Non") = 2 Then
        Raz_client()
        Bencours = False
      Else
        Bencours = True
      Endif
    Else
      b = 0
    Endif
  Else
    b = 0
  Endif
  
End

Public Sub Raz_client()
  
  code.Clear
  Nom.Clear
  Pnm.Clear
  num2.Clear
  Nm.Clear
  Adr1.Clear
  Adr2.Clear
  Cp.Clear
  Burd.Clear
  Telbur.Clear
  Teldom.Clear
  Telport.Clear
  Divers.Clear
  Txmo.Text = "0.00"
  Txpieces.Text = "0.00"
  Encours = "0"
  Livraison.value = False
  solde.Text = Format$("0", "0.00")
  Solde.Background = Color.TextBackground
  code.SetFocus
  b = 1
  
End

'**********************************************************
'*       Gestion des boutons du columnview Entete          *
'**********************************************************

Public Sub Btn_Click()
  
  Select Case Last.tag
      
    Case 1
      Button7_Click()
      
    Case 2
      
    Case 3
      button2_click()
      
    Case 4
      Bl_Suppr()
      
    Case 5
      button4_click()
      
    Case 6
      
      If Exist(filename) Then Try Kill filename
      If Exist(User.home & "/Facture.pdf") Then Try Kill User.home & "/Facture.pdf"
      Settings["/Soc" & Start.Societe & "/Col/LcolF"] = "col0:" & Coldetail.Columns[0].Width & ";" & "col1:" & Coldetail.Columns[1].Width & ";" & "col2:" & Coldetail.Columns[2].Width & ";" & "col3:" & Coldetail.Columns[3].Width & ";" & "col4:" & Coldetail.Columns[4].Width & ";" & "col5:" & Coldetail.Columns[5].Width & ";" & "col6:" & Coldetail.Columns[6].Width & ";" & "col7:" & Coldetail.Columns[7].Width & ";" & "col8:" & Coldetail.Columns[8].Width & ";" & "col9:" & Coldetail.Columns[9].Width
      'Try Settings["/Soc" & Start.Societe & "/Col/LcolEqu"] = "col0:" & hcol.Columns[0].Width & ";" & "col1:" & hcol.Columns[1].Width & ";" & "col2:" & hcol.Columns[2].Width & ";" & "col3:" & hcol.Columns[3].Width & ";" & "col4:" & hcol.Columns[4].Width & ";" & "col5:" & hcol.Columns[5].Width & ";" & "col6:" & hcol.Columns[6].Width & ";" & "col7:" & hcol.Columns[7].Width
      Settings.Save
      Settings.Reload
      Me.Close
      
    Case 7
      Try Lignes_Bon()
      
    Case 8
      Button15_Click()
      
    Case 9
      If num.Text = "" Or Code.Text = "" Then
        If start.son Then
          Music.Play
        Endif
        Try Message.Warning("Votre bon n'est pas numeroté ou vous n'avez pas saisi de code client !", "OK")
      Else
        If Coldetail.Count = 0 Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning(" Impression impossible, aucune ligne n'a été saisie !", "Ok")
        Else
          Button14.Enabled = True
          Bl_Edit()
        Endif
      Endif
      
    Case 10
      
    Case 11
      
    Case 12
      Button12_Click()
      
  End Select
  
End

Public Sub Btn_Keypress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 7
        Lignes_Bon()
    End Select
  Endif
  
  If Key.code = Key.F6 Then
    Select Case Last.tag
      Case 7
        If Settings["/Soc" & Start.Societe & "/Affaire"] Then ChiffreA()
    End Select 
  Endif
  
End

Public Sub Lignes_Bon()
  
  If num.Text = "" Then
    ChkFocus = 2
    Dsg2.SetFocus
    If start.son Then
      Music.Play
    Endif
    Try Message.Warning("Aucune sélection en cours !", "OK")
  Else
    If datej.text = "" Then
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Veuillez saisir la date du bon avant de saisir les lignes de détail !", "OK")
      datej.SetFocus
      datej.Select
    Else
      If Not Code.Text Then
        If start.son Then
          Music.Play
        Endif
        Try Message.Warning("Veuillez saisir un code client Svp ", "Ok")
        Code.SetFocus
        Code.Select
      Else
        If Not Nom.Text Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir un nom pour votre client Svp ", "Ok")
          Nom.SetFocus
          Nom.Select
        Else
          'Utils.db.Exec("UNLOCK TABLES")
          Motm.Value = False
          Com.Value = False
          BArt.Value = True
          BArt_Click()
          Sel = ""
          Panel5.Visible = True
          If sFacht.value = False Then
            sTTC.Value = False
            Textlabel30.text = "Prix HT"
          Else
            sTTC.Value = True
            Textlabel30.text = "Prix HT"
          Endif
          If Settings["/Soc" & Start.Societe & "/Poids"] <> "0" Then
            TextLabel65.Visible = True
            PdxArt.Visible = True
            TextLabel64.Visible = True
            Poids.Visible = True
          Endif
          If Tp = "B" Or If Tp = "F" And ImpFac <> "1" Then
            'Bsuppr = True
            If Panel8.visible = False Then
              Maj_Quantite2()
            Else
              Maj_QteDep2()
            Endif
            'Bsuppr = False
          Endif
          Button4_Click()
          If Not IsNull(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) And Coldetail.count = 0 Then
            Com.Value = True
            Intitule.text = "Vous avez été servi par " & sVendeur.Text
            Enrg_Ligcom()
          Endif
          If Settings["/Soc" & Start.Societe & "/MoArt"] = True Then
            Motm.Value = True
            Motm_Click()
          Else
            If Settings["/Soc" & Start.Societe & "/ComArt"] = True Then
              Com.Value = True
              Com_Click()
            Else
              If Settings["/Soc" & Start.Societe & "/Art"] = True Then
                BArt.Value = True
                BArt_Click()
              Endif
            Endif
          Endif
          b = 0
        Endif
      Endif
    Endif
  Endif
  
End

Public Sub Button15_Click()
  
  Dim sortie As Boolean = True
  Dim iskey As Integer = 0
  
  If Panel11.visible = True Then
    hcol.Clear
    Panel11.visible = False
  Endif
  If Val(Utils.cpoint(Mrg.text)) <= 0 And If Settings["/Soc" & Start.Societe & "/Marge"] Then
    If start.son Then
      Music.Play
    Endif
    If message.Question("Votre document a une marge égale ou inférieure à zéro !\n Que voulez-vous faire ?", "1- Restez en saisie", "2- Sortir") = 1 Then Sortie = False
  Endif
  If Sortie = True Then
    ChkFocus = 2
    If Tp = "B" Or If Tp = "F" And ImpFac <> "1" Then
      If Panel8.visible = False Then
        Maj_Quantite()
      Else
        Maj_QteDep()
      Endif
    Endif
    Razmo()
    Cleanart()
    Comcode.Text = ""
    Nlgcom.Text = ""
    intitule.Text = ""
    sel = ""
    'If Tribl = "code_ligbl" Then
    tribl = "numbl"
    tribl2 = "numbl"
    NOB.Text = "Nom client"
    'Endif
    Tot_Remises()
    Button4_Click()
    $desc = False
    'deb1()
    'Titre()
    NUMB_Click()
    Colbl.SetFocus
    If Nv <> 1 Then
      Repeat
        Colbl.MoveTo(iskey, 0)
        Inc iskey
      Until colbl[colbl.row, 2].Text = num.text
    Else
      Colbl.MoveTo(0, 0)
      Nv = 0
    Endif
    Panel5.Visible = False
    Frame4.visible = False
    Cv.setfocus
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub sTTC_Click()
  
  If Not IsNull(Cart.Text) Then Recup_Tva()
  If sTTC.Value = True Then
    Textlabel30.text = "Prix TTC"
    If artpu.Text <> "0,00" Then
      Artpu.Text = Val(Utils.CPoint(Artbrut.Text)) + (Val(Utils.CPoint(Artbrut.Text)) * Ttva / 100)
      Artpu.Text = Format$(Val(Utils.cpoint(Artpu.Text)) / Val(Utils.cpoint(Artqte.Text)), ar$)
    Endif
  Else
    Textlabel30.text = "Prix HT"
    If artpu.Text <> "0,00" Then Artpu.Text = Format$(Val(Utils.cpoint(Artbrut.Text)) / Val(Utils.cpoint(Artqte.Text)), ar$)
  Endif 
  If Not IsNull(Cart.Text) Then
    Artpu.SetFocus
    Artpu.Select
  Else
    Cart.SetFocus
  Endif
  
End

Public Sub sFacht_Click()
  
  If sFacht.value = False Then
    sTTC.Value = False
    Textlabel30.text = "Prix HT"
  Else
    sTTC.Value = True
    Textlabel30.text = "Prix HT"
  Endif
  
End

Public Sub Tvar_Click()
  
  If Tvar.value = True Then
    sFacht.value = False
    sTTC.Value = False
    Textlabel30.text = "Prix HT"
  Else
    If sFacht.value = False Then
      sTTC.Value = False
      Textlabel30.text = "Prix HT"
    Else
      sTTC.Value = True
      Textlabel30.text = "Prix HT"
    Endif
  Endif
  
End

Public Sub Form_Close()
  
  Dim sortie As Boolean = True
  Dim Tactive As String
  
  Tactive = "Fiches_Docactif"
  Try Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", $numbl, User.name)
  If Panel5.visible = True Then
    If Val(Utils.cpoint(Mrg.text)) <= 0 And If Settings["/Soc" & Start.Societe & "/Marge"] Then
      If start.son Then
        Music.Play
      Endif
      If message.Question("Votre document a une marge égale ou inférieure à zéro !\n Que voulez-vous faire ?", "1- Restez en saisie", "2- Sortir") = 1 Then Sortie = False
    Endif
    If Sortie = True Then
      ChkFocus = 2
      If Tp = "B" Or If Tp = "F" And ImpFac <> "1" Then
        If Panel8.visible = False Then
          Maj_Quantite()
        Else
          Maj_QteDep()
        Endif
      Endif
      Razmo()
      Cleanart()
      Comcode.Text = ""
      Nlgcom.Text = ""
      intitule.Text = ""
      Panel5.Visible = False
      Button4_Click()
      Tot_Remises()
    Endif
  Endif
  
End

'**********************************************************
'*       Gestion du click sur radiobutton Motm            *
'**********************************************************
Public Sub Motm_Click()
  
  ChkFocus = 2
  Panel2.visible = True
  Panel3.Visible = False
  Panel4.visible = False
  CleanArt()
  Razmo()
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  ' On récupère le dernier numéro de ligne
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  If Not Error Then
    Nlg.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlg.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Coldetail.current[0] = Nlgapp Then Break
    Endif
  Until Coldetail.MoveNext()
  Rem.Text = Txmo.Text
  typeL = "M"
  Cmo.Select
  Cmo.SetFocus
  n = 1
  chkfocus = 2
  Modif = "0"
  
End

'********************************************************************
'* Gestion du click sur radiobutton Art pour tous les articles      *
'********************************************************************
Public Sub BArt_Click()
  
  ChkFocus = 2
  Panel2.visible = False
  Panel3.Visible = True
  Panel4.visible = False
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  Cleanart()
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  If Not Error Then
    Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlgart.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Coldetail.current[0] = Nlgapp Then 
        Coldetail.current.EnsureVisible()
        Nlgapp = ""
        Break
      Endif
    Endif
  Until Coldetail.MoveNext()
  Artrm.Text = Txpieces.Text
  typeL = "A"
  Depg.Text = ""
  Cart.SetFocus
  Cart.Select
  N = 1
  Modif = "0"
  ChkFocus = 2
  
End

'*******************************************************************
'* Gestion du click sur radiobutton Art pour les articles en stock *
'*******************************************************************
Public Sub B2Art_Click()
  
  BArt_Click()
  
End

'**********************************************************
'*       Gestion du click sur radiobutton Com             *
'**********************************************************
Public Sub com_Click()
  
  Dim l As String
  
  Panel2.visible = False
  Panel3.Visible = False
  Panel4.Visible = True
  CleanArt()
  Comcode.Text = ""
  Nlgcom.Text = ""
  intitule.Text = ""
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  Try l = Coldetail.current[0]
  Coldetail.MoveLast()
  ChkFocus = 2
  Try Coldetail.item.Selected = True
  If Not Error Then
    Nlgcom.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlgcom.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  typeL = "C"
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Coldetail.current[0] = Nlgapp Then 
        Coldetail.current.EnsureVisible()
        Nlgapp = ""
        Break
      Endif
    Endif
  Until Coldetail.MoveNext()
  Comcode.SetFocus
  Comcode.Select
  N = 1
  chkfocus = 2
  modif = "0"
  
End

'**********************************************************
'*       Gestion du click sur bouton "Nouveau"            *
'**********************************************************
Public Sub Button2_Click()
  
  Dim Tactive As String
  
  Tactive = "Fiches_Docactif"
  Try Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", $numbl, User.name)
  CleanChamps()
  modif = "0"
  Code.ReadOnly = False
  Nom.ReadOnly = False
  Pnm.ReadOnly = False
  tribl = "numbl"
  tribl2 = "numbl"
  Tab = "Fiches_Parametres"
  Tab2 = "Fiches_Bl"
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab2 & " WRITE, " & Cbase.Table("TabCli") & " Write,  " & Tactive & " WRITE")
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    num.Text = rResult!dnbon
  Endif
  If num.Text = "" Then num.Text = "000000"
  num.Text = Val(num.Text) + 1
  num.Text = Format$(num.Text, "000000")
  num2.Text = num.Text
  Datej.Text = Format$(Now, "dd.mm.yyyy")
  rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " where numbl = &1", num.text)
  If rResult.Available Then
    If start.son Then
      Music.Play
    Endif
    Try Message.Warning("Création impossible ce numéro de BL est déjà attribué")
    Num.text = ""
    Coldetail.Clear
  Else
    Nv = 1
    Nvc = 0
    ' on met a jour les parametres
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnbon = &1", num.Text)
    datej.SetFocus
    datej.Select
    Coldetail.Clear
    Button8.Visible = False
    Button6.Visible = True
    Impfac = "0"
    'ikey = ""
    button4_click()
    $desc = False
    deb1()
    Colbl.MoveTo(0, 0)
    $numbl = colbl[colbl.row, 2].Text
    Utils.db.Exec("INSERT INTO " & Tactive & "(numerobl, nom) VALUES (&1, &2)", colbl[colbl.row, 2].Text, User.name)
  Endif
  Utils.db.Exec("UNLOCK TABLES")
  Nv = 1
  If Settings["/Soc" & Start.Societe & "/Factdef"] Then
    BFac.value = True
  Else
    If Settings["/Soc" & Start.Societe & "/Bldef"] Then
      Bbon.value = True
    Else
      If Settings["/Soc" & Start.Societe & "/Devisdef"] Then
        Bdevis.value = True
      Endif
    Endif
  Endif
  'Nv = 0
  If Settings["/Soc" & Start.Societe & "/Fht"] Then
    sFacht.Value = True
    sTTC.value = True
  Endif
  If Impauto Or If Franchise Then
    Exo.Value = True
    Exo.Enabled = False
  Endif
  Dep.Enabled = True
  Dep.Text = ""
  
End

'**********************************************************
'*       Gestion du click sur Bouton "Enregistrer"        *
'**********************************************************
Public Sub Button4_Click()
  
  Dim collectif As String
  Dim Colcpt As String
  Dim type As String
  Dim hresult As Result
  Dim iskey As Integer = 0
  Dim copie As String = Settings["/Soc" & Start.Societe & "/Pdf"]
  'tribl2 = "numbl"
  type = "C"
  $Desc = False
  If Not IsNull(num.Text) Then
    'Tactive = "Fiches_Docactif"
    'Try Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", colbl[colbl.row, 2].Text, User.name)
    If Bcomde.Value Then Tp = "C"
    If Bbon.Value Then Tp = "B"
    If Bdevis.Value Then Tp = "D"
    If Bprof.Value Then Tp = "P"
    If BFac.Value Then Tp = "F"
    With utils
      Tab = "Fiches_Bl"
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numbl = &1", num.text)
      If rResult.Available Then
        Utils.db.Exec("UPdate  " & Tab & "  SET  numbl = &1, datebl = &2, cdclibl =&3,  nmclibl = &4, rmobl = &5, rartbl = &6, type = &7, pnmclibl = &8, adr1bl =&9, adr2bl =&{10}, cpbl =&{11}, villebl =&{12}, exobl = &{13}, cvclibl =&{14}, tvar = &{15}, totalht = &{16}, acpt = &{17}, mreg = &{18}, retro = &{19}, marge_art = &{20}, remmobl = &{21}, remartbl = &{22}, marge_mo = &{23}, totalttc = &{24}, htbl = &{25}, cdep = &{26}, livraison = &{27}  WHERE numbl = &1", num.Text, .Cdate_Dbase(datej.Text), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, tvar.Value, .PointBase(Totht.Text), .PointBase(acpt.Text), .PointBase(Mrgt.Text), Retro.value, .PointBase(Mrgart), .PointBase(Remmo), .PointBase(Remart), .PointBase(Mrgmo), .PointBase(Tottc.Text), sTTC.value, Dep.Text, Livraison.value)
      Else
        Utils.db.Exec("INSERT INTO " & Tab & "(numbl,datebl,cdclibl, nmclibl, rmobl, rartbl, type, pnmclibl, adr1bl, adr2bl, cpbl, villebl, exobl, cvclibl, tvar, imp, acpt, mreg, totalht, retro, marge_art, remmobl, remartbl, marge_mo, totalttc, htbl, cdep, livraison) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15}, &{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27}, &{28})", num.Text, .Cdate_Dbase(datej.Text), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, tvar.Value, 0, .PointBase(acpt.Text), Mrgt.Text, .PointBase(Totht.Text), retro.value, .PointBase(Mrgart), .PointBase(Remmo), .PointBase(Remart), .PointBase(Mrgmo), .PointBase(Tottc.Text), sTTC.value, Dep.text, Livraison.value)
      Endif
      Tab = "Fiches_Cli"
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where cli_code = &1", Code.text)
      If rResult.Available Then
        If Majc.Value And nvc <> 1 Then ' si le client existe et que le bouton Majc est coché alors on met a jour la table des comptes
          Utils.db.Exec("UPdate  " & Tab & "  SET  cli_nom = &2, cli_pnm = &3, cli_adr1 = &4, cli_adr2 = &5, cli_cd_ptl =&6, cli_ville =&7, cli_tel_bur = &8, cli_tel_dom = &9, cli_pble = &{10}, cli_obs = &{11}, cli_rmo =&{12}, cli_rart =&{13}, cli_rs_soc=&{14}, cli_exo=&{15}, cli_email=&{16} WHERE cli_code = &1", code.Text, nom.Text, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Telbur.Text, Teldom.Text, Telport.Text, Divers.Text, Txmo.Text, Txpieces.Text, Cv.Text, Exo.Value, Courriel.Text)
          Utils.db.Exec("UPdate " & Cbase.Table("TabComptes") & " SET intitule_cc = &2 WHERE compte_cc = &1", Code.Text, Nom.Text)
        Else
          If nvc = 1 Then
            Syntheses.Message("Création impossible, ce code client existe déjà !")
            Try Message.Error("Création impossible, ce code client existe déjà !")
            nvc = 0
            Return
          Endif
        Endif
      Else
        If Nvc = 1 Then ' si c'est un nouveau client on met a jour la table des comptes
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " where coll = '1' order by cast(compte_cc AS char)")
          If hresult.Available Then
            Repeat
              Colcpt = hresult!compte_cc
              If Left$(Colcpt, 2) = Left$(Code.Text, 2) Then collectif = Colcpt
            Until hresult.MoveNext()
          Endif
          Utils.db.Exec("insert into " & Cbase.Table("TabComptes") & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, soldep, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12})", Code.Text, Nom.Text, "C", 0, collectif, 0, 0, 0, 0, 0, 0, True)
          Utils.db.Exec("INSERT INTO  " & Tab & "  (cli_code, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville, cli_tel_bur, cli_tel_dom, cli_pble, cli_obs, cli_rmo, cli_rart, cli_rs_soc, cli_exo, cli_collectif , cli_cdech, cli_email, cli_actif, cli_copie) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20})", code.Text, nom.Text, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Telbur.Text, Teldom.Text, Telport.Text, Divers.Text, Txmo.Text, Txpieces.Text, Cv.Text, Exo.Value, collectif, "00", Courriel.Text, "0", Copie)
        Endif
      Endif
      Enrgcp.Ecp(Cp.Text, Burd.Text)
    End With
    If nv <> 1 Then
      Try colbl[colbl.row, 3].Text = Left$(Datej.Text, 6) & Right$(Datej.Text, 2)
      Try colbl[colbl.row, 4].Text = Code.Text
      Try colbl[colbl.row, 5].Text = Nom.Text
      Try colbl[colbl.row, 6].Text = Pnm.Text
      If $Desc = False Then
        Deb1()
      Else
        Deb2()
      Endif
    Endif
    If Nv <> 1 Then
      Repeat
        Colbl.MoveTo(iskey, 0)
        Inc iskey
      Until colbl[colbl.row, 2].Text = num.text
    Else
      Colbl.MoveTo(0, 0)
      Nv = 0
    Endif
  Endif
  Code3.text = code.Text
  Nm.Text = Nom.Text
  Nvc = 0
  B = 0
  'CATCH
  'IF start.son THEN
  '  Music.Play
  'ENDIF
  'TRY message.Error("il semble qu'il y ait un problème sur le BL sélectionné. Merci de vérifier ou (et) de refaire votre sélection !")
  
End

'**************************************************
'*    Gestion des commentaires ( dossier vide )   *
'**************************************************
Public Sub button6_Click()
  
  Tab5 = "Fiches_Cli"
  
  If Not divers.Visible Then
    Divers.Visible = True
  Else
    divers.Visible = False
    Utils.db.Exec("UPDATE  " & Tab5 & "  SET  cli_obs = &2 WHERE cli_code = &1", Code.Text, Divers.Text)
    If Len(Divers.Text) <> 0 Then
      Button8.Visible = True
      Button6.Visible = False
    Else
      Button8.Visible = False
      Button6.Visible = True
    Endif
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'******************************************************
'*  Gestion des commentaires ( dossier mouvementé )   *
'******************************************************
Public Sub button8_Click()
  
  Tab5 = "Fiches_Cli"
  If Not divers.Visible Then
    Divers.Visible = True
  Else
    divers.Visible = False
    Utils.db.Exec("UPDATE  " & Tab5 & "  SET  cli_obs = &2 WHERE cli_code = &1", Code.Text, Divers.Text)
    If Len(Divers.Text) <> 0 Then
      Button8.Visible = True
      Button6.Visible = False
    Else
      Button6.Visible = True
      Button8.Visible = False
    Endif
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'**************************************************
'*          Création d'un nouveau client          *
'**************************************************
Public Sub button1_Click()
  
  If Impfac = "1" Then
    Balloon.Warning(("La facture a été imprimée ! Modification de client impossible."), Code)
  Else
    'Button2_click()
    If IsNull(num.text) Then
      If start.son Then
        Music.Play
      Endif
      Message.Warning("Vous devez d'abord créer ou ouvrir un bon avant de pouvoir créer un nouveau client !")
    Else
      Tab = "Fiches_Parametres"
      Utils.db.Exec("LOCK TABLES " & Tab & " WRITE")
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
      If IsNull(rResult!dnc) Or If rResult!dnc <= 411000 Then
        If start.son Then
          Music.Play
        Endif
        Try Message.Error("Il y a un problème pour la création des comptes clients \n Veuillez controler les paramètres SVP !")
      Else
        Code.Text = rResult!dnc
        If Val(Code.Text) = 411999 Then
          Code.Text = 4111000
        Else
          If Val(Code.Text) = 4119999 Then
            Code.Text = 41110000
          Else
            Code.Text = Val(Code.Text) + 1
          Endif
        Endif
        Utils.db.Exec("UPDATE  " & Tab & "  SET  dnc = &1", Code.Text)
        Utils.db.Exec("UNLOCK TABLES")
      Endif
      Cv.Clear
      Nom.Clear
      Pnm.Clear
      Adr1.Clear
      Adr2.Clear
      Cp.Clear
      Burd.Clear
      Courriel.Clear
      Telbur.Clear
      Telport.Clear
      TelDom.Clear
      Solde.Text = "0,00"
      Txmo.Text = "0,00"
      Txpieces.Text = "0,00"
      Cv.SetFocus
      Cv.Select
      Majc.Value = True
      Nvc = 1
      Typec = ""
    Endif
  Endif
  
End

'**************************************************
'*    Gestion d'une selection manuelle d'un bon    *
'**************************************************
Public Sub Colbl_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Then Colbl_Click()
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  If Key.code = key.Esc Or Key.code = key.f2 Then
    RdimColbl()
    Stop Event
  Endif
  
End

Public Sub RdimColbl()
  
  If Not hColbl Then
    colbl.Height = Me.Window.Height / 1.02
    hColbl = True
    Deb1()
  Else
    colbl.Height = Me.Window.Height / 4.70
    hColbl = False
  Endif
  
End

'*****************************************************
'*        Gestion des ouvertures des documents       *
'*****************************************************
Public Sub NumUtil() As Boolean
  
  Dim rParam As Result
  Dim Tactive As String
  Dim Bok As String
  
  Tactive = "Fiches_Docactif"
  'Try Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", colbl[colbl.row, 2].Text, User.name)
  rParam = Utils.db.Exec("SELECT * FROM " & Tactive & " where numerobl = &1 and nom <> &2", colbl[colbl.row, 2].Text, User.name)
  If rParam.Available Then
    bok = False
    Nmuser = rParam!nom
    Ecran = ""
  Else
    rParam = Utils.db.Exec("SELECT * FROM " & Tactive & " where numerobl = &1 and nom = &2 and ecran <> &3", colbl[colbl.row, 2].Text, User.name, Desktop.Current)
    If rParam.Available Then
      bok = False
      Nmuser = rParam!nom
      Ecran = rParam!ecran
    Else
      bok = True
      Try Utils.db.Exec("INSERT INTO " & Tactive & "(numerobl, nom, ecran) VALUES (&1, &2, &3)", colbl[colbl.row, 2].Text, User.name, Desktop.Current)
    Endif
  Endif
  Return bok
  
End

'*****************************************************
'*    Gestion d'une selection d'un bon a la souris   *
'*****************************************************
Public Sub Colbl_Click()
  
  Dim bok As Boolean = False
  Dim Tactive, bureau As String
  
  Tactive = "Fiches_Docactif"
  Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", $numbl, User.name)
  $numbl = colbl[colbl.row, 2].Text
  bencours = False
  CleanChamps()
  dtef.ReadOnly = False
  Dtech.ReadOnly = False
  Nvc = 0
  Panel10.Visible = False
  With utils
    bok = NumUtil()
    If bok Then
      Variables.bRemise = False
      Try rResult = Utils.db.Exec("select * from " & Cbase.Table("TabBl") & " where numbl = &1", colbl[colbl.row, 2].Text)
      If Not Error Then
        'ikey = colbl[colbl.row, 1].Text
        If rResult.count = 0 Then rResult = Utils.db.Exec("select * from " & Cbase.Table("TabBl") & " where numfac = &1", colbl[colbl.row, 2].Text)
        If rResult.Available Then
          Datej.text = .Cdate_Aff(rResult!datebl)
          If Not IsNull(rResult!ech) Then Dtech.text = .Cdate_Aff(rResult!ech)
          num.text = rResult!numbl
          Code.text = rResult!cdclibl
          Impfac = rResult!imp
          If Impfac = "1" Then
            Code.ReadOnly = True
            Code.Background = &HD4D0C8&
          Else
            Code.ReadOnly = False
            'Code.Background = Color.TextBackground
          Endif
          Cv.Text = rResult!cvclibl
          Nom.text = rResult!nmclibl
          Code3.Text = Code.Text
          num2.Text = num.Text
          Nm.Text = Nom.Text
          If Impfac = "1" Then
            Nom.ReadOnly = True
            Nom.Background = &HD4D0C8&
          Else
            Nom.ReadOnly = False
            'Nom.Background = Color.TextBackground
          Endif
          Pnm.Text = rResult!pnmclibl
          If Impfac = "1" Then
            Pnm.ReadOnly = True
            Pnm.Background = &HD4D0C8&
          Else
            Pnm.ReadOnly = False
            'Pnm.Background = Color.TextBackground
          Endif
          Adr1.Text = rResult!adr1bl
          Adr2.text = rResult!adr2bl
          Cp.Text = rResult!cpbl
          Burd.text = rResult!villebl
          If rResult!acpt = "" Then
            Acpt.Text = "0,00"
          Else
            acpt.Text = Format$(Val(.cpoint(rResult!acpt)), "0.00")
          Endif
          Macompte.Text = acpt.Text
          Try Mrgt.Text = rResult!mreg
          If Error Then Mrgt.Text = "0,00"
          Try Mrgmo = rResult!marge_mo
          If Error Then Mrgmo = 0
          Try Mrgart = rResult!marge_art
          If Error Then Mrgart = 0
          If Not Prxdec Then
            Mrg.text = Format$(Val(.cpoint(Mrgmo)) + Val(.cpoint(Mrgart)), "0.00")
          Else
            Mrg.text = Format$(Val(.cpoint(Mrgmo)) + Val(.cpoint(Mrgart)), "0")
          Endif
          If rResult!rmobl = "" Then
            Txmo.Text = "0,00"
          Else
            Try Txmo.Text = Format$(Val(.cpoint(rResult!rmobl)), "0.00")
            If Error Then Txmo.Text = "0,00"
          Endif
          If rResult!rartbl = "" Then
            Txpieces.Text = "0,00"
          Else
            Try Txpieces.Text = Format$(Val(.cpoint(rResult!rartbl)), "0.00")
            If Error Then Txpieces.Text = "0,00"
          Endif
          Tp = rResult!type
          Try Exo.Value = rResult!exobl
          If Impauto Or If Franchise Then
            Exo.Value = True
            Exo.Enabled = False
          Endif
          Try Livraison.value = rResult!livraison
          Try Retro.value = rResult!retro
          Try tvar.Value = rResult!tvar
          Impfac = rResult!imp
          Try sTTC.Value = rResult!htbl
          If Not Error Then
            If rResult!htbl = 0 Then
              sTTC.value = False
              sFacht.Value = False
            Else
              sTTC.value = True
              sFacht.Value = True
            Endif
          Else
            If Settings["/Soc" & Start.Societe & "/Fht"] Then
              sFacht.Value = True
              sTTC.value = True
            Endif
          Endif
          Dep.Text = rResult!cdep
          If Not IsNull(Dep.text) Then Dep.Enabled = False
        Endif
        rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", Code.text)
        If rResult.Available Then
          Pays = rResult!cli_pays
          telbur.Text = rResult!cli_tel_bur
          Teldom.text = rResult!cli_tel_dom
          TelPort.text = rResult!cli_pble
          Divers.text = rResult!cli_obs
          Typec = rResult!cli_typec
          Nbexpl.text = rResult!cli_expl
          TvaCli = rResult!cli_id_tva
          Encours = rResult!cli_plaf_ecrs
          Try Dtab = rResult!cli_datab
          Try Aban = rResult!cli_aban
          'Try Livraison.value = rResult!cli_livraison
          If IsNull(Nbexpl.Text) Then Nbexpl.text = "2"
          If Tp = "D" Then Nbexpl.Text = "1"
          Ech = rResult!cli_cdech
          dtef.Text = Format$(Now, "dd.mm.yyyy")
          Dtech.Text = dateEcheance(Ech)
          Try sreg = rResult!cli_reg
          Recup_Mail()
          'If IsNull(Courriel.Text) Then Courriel.Add(rResult!cli_email, 0)
        Endif
        If Tp = "C" Then Bcomde.Value = True
        If Tp = "B" Then Bbon.Value = True
        If Tp = "P" Then Bprof.Value = True
        If Tp = "D" Then Bdevis.Value = True
        If Tp = "F" Then Bfac.Value = True
        If Tp = "A" Then BfacA.Value = True
        rResult = Utils.db.Exec("select * from " & Cbase.Table("TabComptes") & " where compte_cc = &1", Code.text)
        If rResult.Available Then
          If rResult!solde = "" Then
            solde.Text = Format$("0", "0.00")
          Else
            solde.text = Format$(rResult!solde, "0.00")
          Endif
          Soldecompte = Val(Utils.cpoint(solde.text))
          If Val(solde.Text) > 0 And Settings["/Soc" & Start.Societe & "/Gestion"] = "0" Then
            code.Background = &HF51B03&
          Else
            code.Background = Color.TextBackground
          Endif
        Endif
        If IsNull(Encours) Then encours = "0"
        If b = 0 Then
          If Len(Divers.Text) <> 0 Then
            Button8.Visible = True
            Button6.Visible = False
          Else
            Button8.Visible = False
            Button6.Visible = True
          End If
          Totmo.Text = "0,00"
          Totart.Text = "0,00"
          Totrem.Text = "0,00"
          Totht.Text = "0,00"
          Tottc.Text = "0,00"
          Tottva.Text = "0,00"
          Coldetail.Clear
          Recup_type()
          Recup_ligbl()
          chkfocus = 2
          T = 0
          B = 0
          Nv = 0
          nvc = 0
          'Evite le columnview noir si une seule ligne.Bug Gambas ???
          Panel5.Visible = True
          Panel5.Visible = False
          'End If
          If hColbl Then
            colbl.Height = Me.Window.Height / 4.70
            hColbl = False
          Endif
          If Settings["/Soc" & Start.Societe & "/MoArt"] = True Then
            Motm.Value = True
            Motm_Click()
          Else
            If Settings["/Soc" & Start.Societe & "/ComArt"] = True Then
              Com.Value = True
              Com_Click()
            Else
              BArt.Value = True
              BArt_Click()
            Endif
          Endif
          Maj_libelle()
          If Not bencours Then Verif_Encours()
          Bencours = True
          cv.SetFocus
        Endif
      Else
        code.SetFocus
      Endif
    Else
      If IsNull(ecran) Then
        Message.Warning("Sélection impossible ! Ce document est utilisé par " & Nmuser)  
      Else
        Select Case Ecran
          Case 0 
            bureau = "premier"
          Case 1
            bureau = "deuxième"
          Case 2 
            bureau = "troisième"
          Case 3 
            bureau = "quatrième"
        End Select
        Message.Warning("Sélection impossible ! Ce document est utilisé sur le " & bureau & " bureau virtuel") 
      Endif
    Endif
  End With
  
End

'**********************************************************
'*               Recuperation des lignes de BL            *
'**********************************************************
Public Sub Recup_ligbl()
  
  Dim sline As String
  Dim Lg As Integer = 1
  Dim nlgcar As String
  
  Tab = "Fiches_Ligbl"
  Totalmo = "0,00"
  Totalart = "0,00"
  Totalrem = "0,00"
  Totalmottc = "0,00"
  Totalartttc = "0,00"
  Totalremttc = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Mrgart = 0
  Mrgmo = 0
  Mrg.text = "0,00"
  Poids.text = "0,000"
  chkfocus = 1
  Coldetail.Clear
  With utils
    Rligbl = Utils.db.Exec("select * from " & Tab & " where num_ligbl = &1 order by numlig_ligbl", num.text)
    If Rligbl.Available Then
      Repeat
        If Rligbl!typel_ligbl = "C" Then
          If Rligbl!code_ligbl = "XX" Then XX = Rligbl!com_ligbl
          For Each sline In Split(Rligbl!com_ligbl, "\n")
            Coldetail.Add(Rligbl!numlig_ligbl & Lg, Rligbl!numlig_ligbl & Lg)
            Coldetail.item[0] = Rligbl!numlig_ligbl
            Coldetail.item[1] = Rligbl!code_ligbl
            Coldetail.item[2] = sline
            Coldetail.item[9] = Rligbl!typel_ligbl
            Coldetail.item[16] = Rligbl!block_ligbl
            Inc Lg
          Next
        Else
          If Rligbl!typel_ligbl = "R" Then
            Nlgcar = Format$(Rligbl!numlig_ligbl, "0000")
            For Each sline In Split(Rligbl!com_ligbl, "\n")
              Coldetail.Add(Nlgcar & Lg, Nlgcar & Lg)
              Coldetail.item[0] = Nlgcar
              Coldetail.item[1] = Rligbl!code_ligbl
              Coldetail.item[2] = sline
              Coldetail.item[9] = Rligbl!typel_ligbl
              Coldetail.item[16] = Rligbl!block_ligbl
              Inc Lg
            Next
          Else
            If Rligbl!typel_ligbl = "O" Then
              Coldetail.Add(Rligbl!numlig_ligbl, Rligbl!numlig_ligbl)
              Coldetail.item[0] = Rligbl!numlig_ligbl
              Coldetail.item[1] = Rligbl!code_ligbl
              Coldetail.item[2] = Rligbl!libel_ligbl
              Coldetail.item[4] = Rligbl!qte_ligbl
              Coldetail.item[9] = Rligbl!typel_ligbl
              Coldetail.item[16] = Rligbl!block_ligbl
            Else
              Coldetail.Add(Rligbl!numlig_ligbl, Rligbl!numlig_ligbl)
              Coldetail.item[0] = Rligbl!numlig_ligbl
              Coldetail.item[1] = Rligbl!code_ligbl
              If Rligbl!typel_ligbl = "T" Then
                Coldetail.item[2] = Rligbl!libel_ligbl
                Coldetail.item[9] = Rligbl!typel_ligbl
                Coldetail.item[16] = Rligbl!block_ligbl
              Else
                Coldetail.item[2] = Rligbl!libel_ligbl
                If Len(Rligbl!pu_ligbl) - InStr(Rligbl!pu_ligbl, ",") = 2 Then
                  Coldetail.item[3] = Rligbl!pu_ligbl & "  "
                Else
                  Coldetail.item[3] = Rligbl!pu_ligbl
                Endif
                Coldetail.item[4] = Rligbl!qte_ligbl
                If Len(Rligbl!brut_ligbl) - InStr(Rligbl!brut_ligbl, ",") = 2 Then
                  Coldetail.item[5] = Rligbl!brut_ligbl & "  "
                Else
                  Coldetail.item[5] = Rligbl!brut_ligbl
                Endif
                Coldetail.item[6] = Rligbl!rem_ligbl
                If Val(.cpoint(Coldetail.item[6])) <> 0 Then
                  Variables.bRemise = True
                Endif
                If Len(Rligbl!netht_ligbl) - InStr(Rligbl!netht_ligbl, ",") = 2 Then
                  Coldetail.item[7] = Rligbl!netht_ligbl & "  "
                Else
                  Coldetail.item[7] = Rligbl!netht_ligbl
                Endif
                Coldetail.item[9] = Rligbl!typel_ligbl
                If Len(Rligbl!nettc_ligbl) - InStr(Rligbl!nettc_ligbl, ",") = 2 Then
                  Coldetail.item[8] = Rligbl!nettc_ligbl & "  "
                Else
                  Coldetail.item[8] = Rligbl!nettc_ligbl
                Endif
                Coldetail.item[10] = Rligbl!tm_ligbl
                Coldetail.item[12] = Rligbl!tx_ligbl
                Coldetail.item[13] = Rligbl!fam_ligbl
                Coldetail.item[20] = Rligbl!four_ligbl
                Coldetail.item[14] = Rligbl!dec_ligbl
                Coldetail.item[16] = Rligbl!block_ligbl
                Coldetail.item[17] = Rligbl!pdstotal_ligbl
                If Rligbl!typel_ligbl = "A" Then
                  If Not IsNull(Coldetail.item[17]) Then
                    Poids.text = Format$(Val(.cpoint(Poids.text)) + Coldetail.item[17], "0.000")
                  Endif
                  Coldetail.item[18] = Rligbl!mrgart_ligbl
                  If Not IsNull(Rligbl!mrgart_ligbl) Then Mrgart = Mrgart + Rligbl!mrgart_ligbl
                Endif
                If Rligbl!typel_ligbl = "M" Then
                  Coldetail.item[19] = Rligbl!mrgmo_ligbl
                  If Not IsNull(Rligbl!mrgmo_ligbl) Then Mrgmo = Mrgmo + Rligbl!mrgmo_ligbl
                Endif
                If Not Prxdec Then
                  Mrg.text = Format$(Mrgart + mrgmo, "0.00")
                Else
                  Mrg.text = Format$(Mrgart + mrgmo, "0")
                Endif
                If Rligbl!typel_ligbl <> "E" And Rligbl!typel_ligbl <> "P" And Rligbl!typel_ligbl <> "T" Then
                  CalculTotal()
                Endif
              Endif
            Endif
          Endif
        Endif
      Until Rligbl.MoveNext()
      Totmo.Text = Totalmo
      Totart.Text = Totalart
      Totrem.Text = Totalrem
      Totht.Text = Totalht
      Tottc.Text = Totalttc
      Tottva.Text = Format$(Val(.CPoint(Tottc.Text)) - Val(.CPoint(Totht.Text)), "0.00")
      Totht1.Text = Totht.Text
      Totva1.Text = Tottva.Text
      Tottc1.Text = Tottc.Text
      If Prxdec Then
        Totmo.Text = Round(Val(Totmo.Text))
        Totart.Text = Round(Val(Totart.Text))
        Totrem.Text = Round(Val(Totrem.Text))
        Totht.Text = Round(Val(Totht.Text))
        Tottc.Text = Round(Val(Tottc.Text))
        Tottva.Text = Round(Val(Tottva.Text))
        Totht1.Text = Round(Val(Totht1.Text))
        Totva1.Text = Round(Val(Totva1.Text))
        Tottc1.Text = Round(Val(Tottc1.Text))
      Endif
    Endif
  End With
  Maj_libelle()
  If Coldetail.count <> 0 Then
    Coldetail.MoveLast()
    Try Coldetail.item.Selected = True
    Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
    Nlg.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
    NlgCom.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
    Coldetail.current.EnsureVisible()
  Else
    Nlgart.Text = "0001"
  Endif
  
End

'**************************************************
'*       Calcul du total en bas du document       *
'**************************************************
Public Sub CalculTotal()
  
  Dim Tva As String
  Dim Rtva As Result
  Dim Mtva As Float
  
  Tva = "Fiches_Tvaav"
  With Utils
    Rtva = Utils.db.Exec("select * from " & Tva & " where code_tva = &1", Rligbl!tx_ligbl)
    If Rligbl!typel_ligbl = "M" Then
      Try Totalmo = Format$(Val(.CPoint(Totalmo)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
      Try Totalmottc = Format$(Val(Totalmottc) + (Val(.CPoint(Rligbl!netht_ligbl)) + (Val(.CPoint(Rligbl!netht_ligbl)) * Rtva!taux_tva / 100)), "0.00")
    Else
      If Rligbl!typel_ligbl = "A" Then
        Try Totalart = Format$(Val(.CPoint(Totalart)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
        Try Totalartttc = Format$(Val(Totalartttc) + (Val(.CPoint(Rligbl!netht_ligbl)) + (Val(.CPoint(Rligbl!netht_ligbl)) * Rtva!taux_tva / 100)), "0.00")
      Endif
    Endif
    Try Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(Rligbl!brut_ligbl)) - Val(.CPoint(Rligbl!netht_ligbl))), "0.00")
    Try Totalht = Format$(Val(.CPoint(Totalht)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
    Try Totalttc = Format$(Val(.CPoint(Totalttc)) + Val(.CPoint(Rligbl!nettc_ligbl)), "0.00")
    Try Mtva = Val(.CPoint(Rligbl!brut_ligbl)) - Val(.CPoint(Rligbl!netht_ligbl))
    Try Totalremttc = Format$(Val(Totalremttc) + Mtva + (Mtva * Rtva!taux_tva / 100), "0.00")
    If Settings["/Soc" & Start.Societe & "/Impttc"] Then
      Totalmo = Totalmottc
      Totalart = Totalartttc
      Totalrem = Totalremttc
    Endif
  End With
  
End

'******************************GESTION DU CODE POSTAL*********************************
Public Sub Cpman()
  
  Dim Cpresult As Result
  Dim MyForm2 As Tricp
  
  CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
  If CpResult.Available Then
    If CpResult.count > 1 Then
      MyForm2 = New Tricp("Facture", Cp.Text)
      Try MyForm2.Showmodal()
      If Bsel = True Then
        Cp.text = Codepostal
        Burd.Text = Bureaudistributeur
        Burd.setfocus
      Else
        Burd.clear
        Burd.SetFocus
      Endif
    Else
      Burd.text = CpResult!burdist
      Burd.SetFocus
      Burd.Select
    Endif
  Else
    Burd.SetFocus
    Burd.Select
  Endif
  
End

Public Sub aff_cp()
  
  Dim CpResult As Result
  
  Colcp.visible = True
  Button5.Visible = True
  Colcp.Columns.count = 2
  Colcp.Columns[0].Width = 60
  Colcp.Columns[1].Width = 280
  Colcp.Columns[0].Text = "CP"
  Colcp.Columns[1].Text = "Bureau distributeur"
  If cp.text Then
    CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
  Else
    'CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " order by cp, burdist")
  Endif
  If CpResult.Available Then
    Repeat
      Colcp.Add(CpResult!cp & CpResult!burdist, CpResult!cp & CpResult!burdist)
      Colcp.Item[0] = CpResult!cp
      Colcp.Item[1] = CpResult!burdist
    Until CpResult.MoveNext()
    Colcp.MoveFirst()
    Colcp.item.Selected = True
    Colcp.setfocus
  Endif
  
End

Public Sub Colcp_Click()
  
  Cp.Text = Colcp.Item[0]
  Burd.Text = Colcp.Item[1]
  Colcp.clear
  Colcp.visible = False
  Burd.SetFocus
  Burd.Select
  
End
'****************************************************************
'* Gestion du columnview Colcp lors d'une saisie manuelle       *
'****************************************************************

Public Sub Colcp_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcp.MoveCurrent
    Colcp_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcp.visible = False
    Colcp.clear
    Cp.Select
    Cp.SetFocus
    Stop Event
  Endif
  
End

Public Sub ChkCp()
  
  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif
  
End

Public Sub ToggleButton8_Click()
  
  Dim MyForm2 As Tricp
  
  MyForm2 = New Tricp("Facture", "")
  MyForm2.Showmodal()
  If Bsel = True Then
    Cp.text = Codepostal
    Burd.Text = Bureaudistributeur
  Else
    Cp.SetFocus
  Endif
  
End

'********************************FIN DE GESTION DU CODE POSTAL**************************

'**********************************************************
'*                 Gestion onglet Saisie MO               *
'**********************************************************
Public Sub SelectionMo()
  
  Tabmo = "Fiches_Mo"
  Colmo.Clear
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Endif
  If ColCom.Visible Then
    Colcom.Clear
    ColCom.Visible = False
  Endif
  If Colmo.Visible Then
    Colmo_Close()
  Else
    Colmo.Visible = True
    HBox8.Visible = True
  Endif
  Tri = "mo_code"
  Trimo()
  chkfocus = 2
  Co2.SetFocus
  
End

Public Sub TriMo()
  
  With ColMo
    .Columns.count = 3
    .Columns[0].Width = CO2.Width
    .Columns[1].Width = FO2.Width
    .Columns[2].Width = FAM2.Width
  End With
  
End

Public Sub colmo_Data(Row As Integer, Column As Integer)
  
  ChkFocus = 2
  MoTable[0] = "mo_code"
  MoTable[1] = "mo_design"
  MoTable[2] = "mo_fam"
  Utils.rs4.MoveTo(Row)
  colmo.data.Text = Str(Utils.rs4[motable[Column]])
  ChkFocus = 0
  
End

Public Sub Deb7()
  
  Utils.Base4(ColMo, "select * from " & Tabmo & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & "")
  ColMo.Refresh
  
End

Public Sub Deb8()
  
  Utils.Base4(ColMo, "select * from " & Tabmo & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & " Desc")
  ColMo.Refresh
  
End

Public Sub Ref()
  
  Tri = "mo_code"
  Trimo()
  
End

Public Sub Dbclkmo()
  
  If Not Dbl Then
    Deb8()
    Dbl = "1"
  Else
    Deb7()
    Dbl = ""
  Endif
  
End

Public Sub Colmo_Close()
  
  Colmo.Clear
  Colmo.Visible = False
  HBox8.Visible = False
  Stop Event
  
End

Public Sub Co2_Click()
  
  sel = ""
  Dbl = ""
  Co2.Text = ""
  Fo2.Text = "Intitulé"
  Tri = "mo_code"
  Deb7()
  
End

Public Sub Co2_Dblclick()
  
  sel = ""
  Co2.Text = ""
  Fo2.Text = "Intitulé"
  Tri = "mo_code"
  Dbclkmo()
  
End

Public Sub CO2_GotFocus()
  
  Try Utils.ObsGotf(Co2)
  CO2_Click()
  CO2.SetFocus
  
End

Public Sub CO2_LostFocus()
  
  Try Utils.ObsLstf(CO2)
  
End

Public Sub CO2_KeyPress()
  
  If key.code = key.esc Or key.code = key.F2 Then
    Colmo_Close()
    Cmo.SetFocus
  Else
    If key.code = key.down Then
      Colmo.MoveTo(0, 0)
      Colmo.SetFocus
    Else
      If Key.code = Key.Right Then
        FO2_GotFocus()
      Else
        Chkinput3()
      Endif
    Endif
  Endif
  
End

Public Sub FO2_Click()
  
  sel = ""
  Dbl = ""
  Co2.Text = "Code Mo" ""
  Fo2.Text = ""
  Tri = "mo_design"
  Deb7()
  
End

Public Sub FO2_Dblclick()
  
  sel = ""
  Co2.Text = "Code Mo"
  Fo2.Text = ""
  Tri = "mo_design"
  Dbclkmo()
  
End

Public Sub FO2_GotFocus()
  
  Try Utils.ObsGotf(fo2)
  FO2_Click()
  Fo2.SetFocus
  
End

Public Sub FO2_LostFocus()
  
  Try Utils.ObsLstf(FO2)
  
End

Public Sub FO2_KeyPress()
  
  If key.code = key.esc Or key.code = key.F2 Then
    Colmo_Close()
    Cmo.SetFocus
  Else
    If key.code = key.down Then
      Colmo.MoveTo(0, 0)
      Colmo.SetFocus
    Else
      If Key.code = Key.Right Then
        CO2_GotFocus()
      Else
        Chkinput3()
      Endif
    Endif
  Endif
  
End

Public Sub ChkInput3()
  
  If InStr("\"&", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    Deb7()
  Else
    Stop Event
  Endif
  
End

'***************************************************
'*      Selection d'un code MO a la souris         *
'***************************************************
Public Sub Colmo_Click()
  
  Tabmo = "Fiches_Mo"
  Cmo.Text = colmo[colmo.row, 0].Text
  chkfocus = 1
  Tmont.Text = "1,00"
  With utils
    mo_man()
    Colmo.Clear
    Colmo.visible = False
    HBox8.Visible = False
    'Cmo.SetFocus
  End With
  
End

'***************************************************
'* Selection d'un code Mo manuellement         *
'***************************************************
Public Sub Colmo_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colmo_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Colmo.visible = False
    HBox8.Visible = False
    Colmo.clear
    Cmo.Select
    Cmo.SetFocus
    Stop Event
  Endif
  
End

'**********************************************************
'*         Recuperation de la main d'oeuvre               *
'**********************************************************
Public Sub mo_man()
  
  chkfocus = 1
  If Impfac <> "1" Then
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMo") & " where mo_code = &1", Cmo.Text)
    If rResult.Available Then
      With utils
        Cmo.Text = rResult!mo_code
        libelle.text = rResult!"mo_design"
        cdfam.Text = rResult!mo_fam
        Txhr.Text = Format$(rResult!mo_txht, "0.00")
        Rem.Text = .CPoint(Rem.Text)
        If IsNull(Rem.Text) Then Rem.Text = "0,00"
        Try PrvtMo = rResult!mo_prvt
        If Error Then PrvtMo = 0
        TxhtMo = rResult!mo_txht
        If Not tvar.Value Then
          Tmo.Text = rResult!mo_tva
          Tmo.readonly = True
        Else
          Tmo.Text = Codetva
          Tmo.readonly = False
        Endif
        Tm.text = rResult!mo_tempmont
        If Tm.Text = "1" Then Tm.Text = "T"
        If Tm.Text = "0" Then Tm.Text = "M"
        If Tm.Text = "M" And rResult!mo_valeurht <> 0 Then
          Txhr.Text = Format$(rResult!mo_valeurht, "0.00")
          Brutht.Text = Txhr.Text
          Netht.Text = Brutht.Text
          Arr = rResult!mo_cdarr
          Arrondimo()
        Else
          If rResult!mo_montant <> 0 And Tm.Text = "T" Then
            Tmont.Text = Format$(rResult!mo_montant, "0.00")
            Brutht.Text = Format$(Val(Tmont.Text) * Val(Txhr.Text), "0.00")
            Calc_Net()
          Else
            Brutht.Text = Txhr.Text
            Calc_Net()
          Endif
        Endif
        Impcar = rResult!mo_impcar
        Intit = rResult!mo_crst
        Calc_Rem()
        Calc_TC()
        Try MargeMo.Text = Format$(rResult!mo_marge, "0.00")
        If Error Then Calc_MargeMo()
        If Impauto Or If Franchise Then Calc_moHt()
        libelle.SetFocus
        libelle.Select
      End With
    Else
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Le code MO " & Cmo.Text & " n'existe pas !", "OK")
      Cmo.SetFocus
      Cmo.clear
      b = 1
    Endif
  Else
    If start.son Then
      Music.Play
    Endif
    Colmo.Visible = False
    HBox8.Visible = False
    Try Message.Warning("La facture a été imprimée, ajout de MO impossible")
    b = 1
    Cmo.Clear
    Cmo.SetFocus
    Cmo.Select
  Endif
  
End

'**********************************************************
'*            On veut rechercher une Mo                   *
'**********************************************************
Public Sub ToggleButton2_Click()
  
  chkfocus = 2
  SelectionMo()
  
End

'*******************************
'*    Gestion du panel Mo      *
'*******************************
Public Sub mo_KeyPress()
  
  Dim hform2 As Form
  
  If key.Code = key.F4 Then Movr.ShowModal()
  
  If Cmo.Text Then
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      
      Select Case Last.tag
          
        Case 1
          mo_man()
          If b <> 1 Then
            If Val(Brutht.text) = 0 Then
              libelle.SetFocus
              libelle.Select
            Else
              Tmont.SetFocus
              Tmont.Select
            Endif
          Endif
          b = 0
          Stop Event
          
        Case 2
          Libelle.Text = Utils.Remplace(Libelle.Text)
          If Not Cmo.Text Then
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning("Veuillez saisir une MO SVP", "Ok")
            Cmo.SetFocus
            Cmo.Select
          Else
            If Not Libelle.Text Then
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
              Libelle.SetFocus
              Libelle.Select
            Else
              Tmont.SetFocus
              Tmont.Select
            Endif
          Endif
          Stop Event
          
        Case 3
          Tm.Text = Upper$(Tm.Text)
          If Tm.text <> "T" And Tm.text <> "M" Then Tm.text = "T"
          Txhr.SetFocus
          Txhr.Select
          Stop Event
          
        Case 4
          Calc_Txhr()
          If b = 1 Then
            Txhr.SetFocus
            Txhr.Select
            b = 0
          Else
            'Calc_Net()
            'Calc_TC()
            Tmont.SetFocus
            Tmont.Select
          Endif
          
          Stop Event
          
        Case 5
          Calc_Tmont()
          If b = 1 Then
            Tmont.SetFocus
            Tmont.Select
            b = 0
          Else
            Button10.SetFocus
          Endif
          Stop Event
          
        Case 6
          Calc_brut()
          If b = 1 Then
            Brutht.SetFocus
            Brutht.Select
            b = 0
          Else
            Rem.SetFocus
            Rem.Select
          Endif
          Stop Event
          
        Case 7
          Calc_Rem()
          If b = 1 Then
            Rem.SetFocus
            Rem.Select
            b = 0
          Else
            Netht.SetFocus
            Netht.Select
          Endif
          Stop Event
          
        Case 8
          Calc_Puht()
          If b = 1 Then
            Netht.SetFocus
            Netht.Select
            b = 0
          Else
            Nettc.SetFocus
            Nettc.Select
          Endif
          Stop Event
          
        Case 9
          With Utils
            Nettc.Text = .Cpoint(Nettc.Text)
            If Val(Nettc.Text) = Null Then
              If start.son Then
                Music.Play
              Endif
              Try message.Warning("Veuillez verifier votre saisie SVP !")
              Nettc.SetFocus
              Nettc.Select
            Else
              tx = (1 + Ttva / 100)
              Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
              Calc_PuHt()
              Button10.SetFocus
            Endif
          End With
          Stop Event
      End Select
    Endif
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.F2 Then
    
    Select Case Last.tag
        
      Case 1
        SelectionMo()
        Stop Event
        
    End Select
  Endif
  
  If Key.code = Key.F3 Then
    Button15_Click()
    Bl_Edit()
    Stop Event
  Endif
  
  If Key.code = Key.F5 Then
    hForm = New FCalc
    ChkFocus = 2
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then Last.Text = Format$(Val(FCalc.Resultat), "0.00")
  Endif
  
  If key.Code = key.F6 Then
    Button15_Click()
    Bl_Edit()
    Edit.Visible = False
    Button14_Click()
    Stop Event
  Endif
  
  If key.code = key.F12 Then
    hForm2 = New Suivi(code.text, Cv.Text, Nom.Text, Pnm.Text, Num.Text, datej.Text, "", "", Bdevis.value, Bfac.value, Impfac)
    hForm2.Showmodal()
    Stop Event
  Endif
  
  ChkFocus = 0
  
End

Public Sub Tmo_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then Tmo_LostFocus()
  
End

Public Sub Tmo_LostFocus()
  
  Calc_Tmont()
  Nettc.SetFocus
  Nettc.Select
  
End

Public Sub mo_Lostfocus()
  
  Try Utils.ObsLstf(Last)
  Calc_MargeMo()
  If chkfocus <> 2 And Cmo.text Then
    Select Case Last.tag
        
      Case 1
        If Not IsNull(Cmo.text) Then mo_man()
        If b <> 1 Then
          If Val(Brutht.text) = 0 Then
            libelle.SetFocus
            libelle.Select
          Endif
        Endif
        b = 0
        Stop Event
        
      Case 2
        Libelle.Text = Utils.Remplace(Libelle.Text)
        If Not Cmo.Text Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir une MO SVP", "Ok")
          Cmo.SetFocus
          Cmo.Select
        Else
          If Not Libelle.Text Then
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
            Libelle.SetFocus
            Libelle.Select
          Endif
        Endif
        Stop Event
        
      Case 3
        Tm.Text = Upper$(Tm.Text)
        If Tm.text <> "T" And Tm.text <> "M" Then Tm.text = "T"
        Txhr.SetFocus
        Txhr.Select
        Stop Event
        
      Case 4
        Calc_Txhr()
        If b = 1 Then
          Txhr.SetFocus
          Txhr.Select
          b = 0
        Endif
        
        Stop Event
        
      Case 5
        If chkfocus <> 1 Then
          Calc_Tmont()
          If b = 1 Then
            Tmont.SetFocus
            Tmont.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 6
        If chkfocus <> 1 Then
          Calc_brut()
          If b = 1 Then
            Brutht.SetFocus
            Brutht.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 7
        If chkfocus <> 1 Then
          Calc_Rem()
          If b = 1 Then
            Rem.SetFocus
            Rem.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 8
        If chkfocus <> 1 Then
          Calc_Puht()
          If b = 1 Then
            Netht.SetFocus
            Netht.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 9
        With Utils
          If chkfocus <> 1 Then
            Try changep = .cpoint(Netht.Text)
            Nettc.Text = .Cpoint(Nettc.Text)
            If Val(Nettc.Text) = Null Then
              If start.son Then
                Music.Play
              Endif
              Try message.Warning("Veuillez verifier votre saisie SVP !")
              Nettc.SetFocus
              Nettc.Select
            Else
              tx = (1 + Ttva / 100)
              Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
              Calc_PuHt()
            Endif
          Endif
        End With
        Stop Event
    End Select
    chkfocus = 0
  Endif
  
End

'****************************
'*      Gestion du focus.   *
'****************************
Public Sub mo_GotFocus()
  
  Try Utils.ObsGotf(Last)
  Cdfam.Background = &HD4D0C8&
  Nlg.Background = &HD4D0C8&
  If Val(Utils.cpoint(MargeMo.Text)) <= 0 Then
    MargeMo.Background = &HEF3E1A&
  Else
    MargeMo.Background = &HD4D0C8&
  Endif
  Select Case Last.tag
    Case 4
      Chg()
    Case 5
      Chg()
      Stop Event
    Case 6
      Chg()
      Stop Event
    Case 7
      Chg()
      Stop Event
    Case 8
      Chg()
      Stop Event
    Case 9
      Chg()
      Stop Event
  End Select
  
End

Public Sub Chg()
  
  With Utils
    ChangeTx = .CPoint(Txhr.Text)
    Changeb = .CPoint(Brutht.Text)
    Changep = .CPoint(Netht.Text)
    Changer = .CPoint(Rem.Text)
    Changet = .CPoint(Nettc.Text)
    Changetm = .CPoint(Tmont.Text)
  End With
  
End

Public Sub Razmo()
  
  Cmo.Text = ""
  libelle.Text = ""
  Tm.Text = ""
  Cdfam.Text = ""
  Txhr.Text = "0,00"
  Tmont.Text = "1,00"
  Brutht.Text = "0,00"
  Rem.Text = "0,00"
  MargeMo.Text = "0,00"
  Netht.Text = "0,00"
  Nettc.Text = "0,00"
  Tmo.Text = ""
  ChangeB = ""
  ChangeP = ""
  ChangeTx = ""
  Changer = ""
  ChangeT = ""
  ChangeTm = ""
  MargeMo.text = "0,00"
  If Coldetail.count <> 0 Then
    Coldetail.MoveLast()
    Coldetail.item.Selected = True
    Nlg.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlg.Text = "0001"
  Endif
  
End

'***********************
'*  Calcul du net MO   *
'***********************
Public Sub Calc_Net()
  
  With utils
    If rem.text <> "0,00" Then
      Try Netht.Text = Format$(Val(Brutht.Text) - (Val(Brutht.Text) * Val(rem.Text) / 100), "0.00")
      If Error Then Message.Error(Error.Text & " " & Error.where)
    Else
      Try netht.Text = Format$(Val(Brutht.Text), "0.00")
      If Error Then Message.Error(Error.Text & " " & Error.where)
    Endif
    
  End With
  
End

'*********************
'*  Verif Tx hr MO   *
'*********************
Public Sub Calc_Txhr()
  
  With utils
    Txhr.Text = .CPoint(Txhr.Text)
    If Val(Txhr.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If ChangeTx <> Txhr.Text Then
        Txhr.Text = Format$(Val(Txhr.Text), "0.00")
        Calc_Tmont()
      Endif
      b = 0
    Endif
  End With
  
End

'********************
'*  Verif brut MO   *
'********************
Public Sub Calc_Brut()
  
  With utils
    Brutht.Text = .CPoint(Brutht.Text)
    If Val(Brutht.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Changeb <> Brutht.Text And Tm.text = "T" Then
        chkfocus = 1
        If start.son Then
          Music.Play
        Endif
        'If message.Question(" Vous venez de modifier le prix brut HT. Voulez-vous \n 1- Modifier la quantité \n 2- Modifier le taux horaire ", " 1 ", " 2 ") = "1" Then
        'Brutht.Text = Format$(Val(Brutht.Text), "0.00")
        'Tmont.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Txhr.Text)), "0.00")
        'Else
        'Txhr.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Tmont.Text)), "0.00")
        'Endif
        Brutht.Text = Format$(Val(.CPoint(Brutht.Text)), "0.00")
      Else
        If Changeb <> Brutht.Text And Tm.text = "M" Then Txhr.text = Format$(Val(Brutht.Text), "0.00")
        Brutht.Text = Format$(Val(Brutht.Text), "0.00")
      Endif
      Calc_Net()
      Calc_TC()
      Calc_moHt()
      'Rem.SetFocus
      'rem.Select
      b = 0
    Endif
  End With
  
End

'************************
'*    Verif du T/M      *
'************************
Public Sub Calc_Tmont()
  
  With utils
    Tmont.Text = .CPoint(Tmont.Text)
    If Val(tmont.Text) = 0 Or Val(tmont.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Brutht.Text = Format(Val(Tmont.Text) * Val(Txhr.Text), "0.00")
      Calc_Net()
      Calc_TC()
      Calc_moHt()
      Tmont.Background = Color.TextBackground
      'Montante = Val(Brutht.text)
      b = 0
    Endif
  End With
  
End

'******************
'*  Verif du PU   *
'******************
Public Sub Calc_Puht()
  
  With Utils
    Netht.Text = .CPoint(Netht.Text)
    If Val(Netht.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
        Netht.SetFocus
        Netht.Select
      Endif
    Else
      If changep <> Netht.Text Then
        chkfocus = 1
        Rem.Text = "0,00"
        Netht.Text = Format$(Val(.CPoint(Netht.Text)), "0.00")
        If start.son Then
          Music.Play
        Endif
        If message.Question(" Vous venez de modifier le prix net HT. Voulez-vous \n 1- Modifier la remise \n 2- Modifier le prix brut et le taux horaire ", " 1 ", " 2 ") = "1" Then
          Rem.Text = Format(Val(.CPoint(Brutht.Text)) - Val(.CPoint(Netht.Text)), "0.00")
          Rem.Text = Format$((Val(.CPoint(Rem.Text)) * 100) / Val(.CPoint(brutht.Text)), "0.00")
        Else
          If Val(rem.Text) <> 0 And Val(rem.Text) <> Null Then
            Brutht.Text = Format$(Val(.CPoint(Netht.Text)) / (1 - (Val(.CPoint(Rem.Text)) / 100)), "0.00")
          Else
            Brutht.Text = Format$(Val(.CPoint(Netht.Text)), "0.00")
          Endif
          Txhr.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Tmont.Text)), "0.00")
        Endif
        Calc_TC()
        Calc_moHt()
      Endif
    Endif
  End With
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'************************
'*  Verif de la remise  *
'************************
Public Sub Calc_Rem()
  
  With Utils
    If Rem.Text = "" Then Rem.Text = "0,00"
    rem.Text = .CPoint(rem.Text)
    If Val(Rem.Text) = Null Then
      If start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      rem.Text = Format$(Val(.CPoint(rem.Text)), "0.00")
      NetHt.Text = Format$(Val(brutht.Text) - (Val(brutht.Text) * Val(Rem.Text) / 100), "0.00")
      Calc_TC()
      If Val(Nettc.Text) <> 0 Then Calc_moHt()
      'Montante = Val(Netht.Text)
      b = 0
    Endif
  End With
  
End

'***********************************
'* On gère l' arrondi de la MO     *
'***********************************
Public Sub arrondimo()
  
  If Not Nettc.Text Then Nettc.Text = "0,00"
  If Arr = "0,05" Then
    If Right$(Nettc.Text) Like "[34567]*" Then
      Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 1)) & "5"
    Else
      Nettc.Text = Round(Val(Nettc.Text), -1)
      Nettc.Text = Format$(Nettc.Text, "0.00")
    Endif
  Endif
  
  If Arr = "0,10" Then
    Nettc.Text = Round(Val(Nettc.Text), -1)
    Nettc.Text = Format$(Nettc.Text, "0.00")
  Endif
  
  If Arr = "0,50" Then
    If Abs(Val(Nettc.Text)) <= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 25)) Then
      Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & "00"
    Else
      If Abs(Val(Nettc.Text)) <= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 75)) Then
        Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & "50"
      Endif
      If Abs(Val(Nettc.Text)) >= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 76)) Then
        Nettc.Text = Round(Val(Nettc.Text))
        Nettc.Text = Format$(Nettc.Text, "0.00")
      Endif
    Endif
  Endif
  
  If Arr = "1,00" Then
    Nettc.Text = Round(Val(Nettc.Text))
    Nettc.Text = Format$(Nettc.Text, "0.00")
  Endif
  
End

'***********************
'* Calcul du TTC       *
'***********************
Public Sub Calc_TC()
  
  Tab = "Fiches_Tvaav"
  With Utils
    Ttva = 0
    If Not Exo.Value Then
      rResult = Utils.db.Exec("select * from " & Tab & " where code_tva = &1", Tmo.Text)
      If rResult.Available Then
        Ttva = rResult!taux_tva
      Endif
    Else
      Tmo.Text = ""
    Endif
    Nettc.Text = Format$(Val(Netht.Text) + (Val(Netht.Text) * Ttva / 100), "0.00")
    If Val(Nettc.Text) <> 0 Then Arrondimo()
  End With
  
End

'***********************
'*  Calcul du HT       *
'***********************
Public Sub Calc_moHt()
  
  With Utils
    tx = (1 + Ttva / 100)
    Rem.Text = .CPoint(Rem.Text)
    If Val(Rem.Text) = Null Or Val(.CPoint(Rem.Text)) = 0 Then
      Rem.Text = "0"
      Rem.Text = Format$(Val(.CPoint(Rem.Text)), "0.00")
    Endif
    Nettc.Text = .CPoint(Nettc.Text)
    If Val(Nettc.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Nettc.Text = Format$(Val(.CPoint(Nettc.Text)), "0.00")
    Endif
    Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
    If Val(Rem.Text) <> 0 And Val(Rem.Text) <> Null Then
      Try Brutht.Text = Format$(Val(.CPoint(Netht.Text)) / (1 - (Val(.CPoint(Rem.Text)) / 100)), "0.00")
    Else
      Brutht.Text = Netht.Text
    Endif
    Txhr.Text = Format$(Val(.CPoint(Brutht.Text)) / (Val(.CPoint(Tmont.Text))), "0.00")
    Txhr.Text = Format$(Val(.CPoint(Txhr.Text)), "0.00")
    Calc_MargeMo()
    If Prxdec Then
      Txhr.Text = Round(Val(txhr.text))
      Netht.Text = Round(Val(netht.text))
      Brutht.Text = Round(Val(Brutht.text))
      Nettc.Text = Round(Val(Nettc.text))
    Endif
  End With
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error("Il y a une incohérence dans votre saisie. Veuillez controler SVP !")
  
End

Public Sub Calc_MargeMo()
  
  Dim Txo As Float
  Dim txh As Float
  Dim Txf As Float
  
  Tabmo = "Fiches_Mo"
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMo") & " where mo_code = &1", Cmo.Text)
  If rResult.Available Then
    Try PrvtMo = rResult!mo_prvt
    If Error Then PrvtMo = 1
    TxhtMo = rResult!mo_txht
  Endif
  If Tm.Text = "T" Then
    'On calcule le montant du taux horaire
    'Txh = Val(Utils.cpoint(Txhr.Text)) * Val(Utils.cpoint(Tmont.Text))
    Txh = Val(Utils.cpoint(Netht.Text))
    'Puis le montant du prix de revient
    Txf = PrvtMo * Val(Utils.cpoint(Tmont.Text))
    'On calcule la marge en valeur pour finir.
    MargeMo.text = Format$(Txh - Txf, "0.00")
  Else
    'On calcule à quoi correspond le montant du forfait
    Try Txo = Val(Utils.cpoint(Netht.Text)) / TxhtMo
    'Puis on calcule le montant du taux horaire
    Txh = TxhtMo * txo
    'Puis le montant du prix de revient
    Txf = PrvtMo * tx
    'On calcule la marge en valeur pour finir.
    MargeMo.text = Format$(Txh - Txf, "0.00")
  Endif
  If Val(Utils.cpoint(MargeMo.Text)) < 0 Then
    MargeMo.Background = &HEF3E1A&
  Else
    MargeMo.Background = &HD4D0C8&
  Endif
  
End

'*****************************************************************
'* Gestion des radiobuttons de selection du type de saisie       *
'*****************************************************************
Public Sub Bcomde_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "C"
    If Atype = "B" Or Atype = "F" Then
      If Panel8.visible = False Then
        Maj_Quantite2()
      Else
        Maj_QteDep2()
      Endif
    Endif
    'TextLabel41.Text = "Fournisseur"
    Maj_typeBL()
  Else
    Wrg()
  Endif
  
End

Public Sub Bbon_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "B"
    If Atype = "D" Or Atype = "P" Or Atype = "C" Then
      If Panel8.visible = False Then
        Maj_Quantite()
      Else
        Maj_QteDep()
      Endif
    Endif
    'TextLabel41.Text = "Famille"
    If Gmateriel = True And nv <> 1 And Not IsNull(num.Text) Then
      If start.son Then
        Music.Play
      Endif
      If Atype = "D" Then message.Warning("Attention, transformer un devis en bon de livraison impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
      If Atype = "P" Then message.Warning("Attention, transformer une proforma en bon de livraison impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
      If Atype = "C" Then message.Warning("Attention, transformer une commande en bon de livraison impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
    Endif
    Maj_typeBL()
  Else
    Wrg()
  Endif
  
End

Public Sub Bdevis_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "D"
    If Atype = "B" Or Atype = "F" Then
      If Panel8.visible = False Then
        Maj_Quantite2()
      Else
        Maj_QteDep2()
      Endif
    Endif
    'TextLabel41.Text = "Fournisseur"
    Maj_typeBL()
  Else
    Wrg()
  Endif
  
End

Public Sub Bprof_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "P"
    If Atype = "B" Or Atype = "F" Then
      If Panel8.visible = False Then
        Maj_Quantite2()
      Else
        Maj_QteDep2()
      Endif
    Endif
    'TextLabel41.Text = "Famille"
    Maj_typeBL()
  Else
    Wrg()
  Endif
  
End

Public Sub Bfac_Click()
  
  Atype = Tp
  Tp = "F"
  If Atype = "D" Or Atype = "P" Or Atype = "C" Then
    If Panel8.visible = False Then
      Maj_Quantite()
    Else
      Maj_QteDep()
    Endif
  Endif
  If Gmateriel = True And nv <> 1 And Not IsNull(num.Text) Then
    If start.son Then
      Music.Play
    Endif
    If Atype = "D" Then message.Warning("Attention, transformer un devis en facture impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
    If Atype = "P" Then message.Warning("Attention, transformer une proforma en facture impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
    If Atype = "C" Then message.Warning("Attention, transformer une commande en facture impose de \n rappeler les lignes de matériel pour saisir les numéros de série")
  Endif
  'TextLabel41.Text = "Famille"
  Maj_typeBL()
  
End

Public Sub BfacA_Click()
  
  Atype = Tp
  Tp = "A"
  If Not IsNull(Dtab) And Not IsNull(Aban) Then
    If Impfac <> 1 Then
      If Atype = "D" Or Atype = "P" Or Atype = "C" Then
        If Panel8.visible = False Then
          Maj_Quantite()
        Else
          Maj_QteDep()
        Endif
      Endif
      'Maj_libelle()
      Maj_typeBL()
    Else
      Wrg()
    Endif
  Else
    If Message.Question("Ce client n'est pas un client abonnement! Voulez-vous completer sa fiche ?", "Oui", "Non") = 1 Then
      tp = atype
      Maj_typeBL()
      FClient.ShowModal()
      Maj_typeBL()
    Else
      tp = atype
      Maj_typeBL()  
    Endif
  Endif
  
End

Public Sub Wrg()
  
  If start.son Then
    Music.Play
  Endif
  Bfac.value = True
  Balloon.Warning("Modification du type de document impossible, la facture a été imprimée !", Bfac)
  
End

'****************************
'* On met à  jour le type    *
'****************************
Public Sub Maj_typeBL()
  
  Dim iskey As Integer = 0
  
  Tab = "Fiches_Bl"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numbl = &1", num.text)
  If rResult.Available Then
    Utils.db.Exec("UPDATE  " & Tab & "  SET  type = &2 WHERE numbl = &1", num.Text, Tp)
  Endif
  sel = ""
  TYB.Clear
  If $Desc = False Then
    Deb1()
  Else
    Deb2()
  Endif
  If Nv <> 1 And Not IsNull(num.text) Then
    Repeat
      Colbl.MoveTo(iskey, 0)
      Inc iskey
    Until colbl[colbl.row, 2].Text = num.text
  Else
    Colbl.MoveTo(0, 0)
    Nv = 0
  Endif
  Colbl_Click()
  Maj_libelle()
Catch
  
End

'****************************
'* On enregistre la MO      *
'****************************
Public Sub Button10_Keypress()
  
  If Key.code = 77 Then 'M
    TM.SetFocus
    TM.Select
  Endif
  If Key.code = 88 Then 'X
    Txhr.SetFocus
    Txhr.Select
  Endif
  If Key.code = 80 Then 'P
    Tmont.SetFocus
    Tmont.Select
  Endif
  If Key.code = 66 Then 'B
    Brutht.SetFocus
    Brutht.Select
  Endif
  If Key.code = 82 Then 'R
    Rem.SetFocus
    Rem.Select
  Endif
  If Key.code = 72 Then 'H
    Netht.SetFocus
    Netht.Select
  Endif
  If Key.code = 84 Then 'T
    Nettc.SetFocus
    Nettc.Select
  Endif
  If Key.code = 76 Then 'L
    Libelle.SetFocus
    Libelle.Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Button10_Click()
  Endif
  
End

'**************************************************************
'* On mouvemente le panel Coldetail apres validation de la MO *
'**************************************************************

Public Sub Button10_Click()
  
  If b = 1 Then
    Cmo.SetFocus
    Cmo.Select
    b = 0
  Else
    If Cmo.Text <> "" Then
      rem.Text = Format$(Val(Utils.CPoint(rem.Text)), "0.00")
      If Val(Brutht.text) = 0 Then
        If start.son Then
          Music.Play
        Endif
        If Message.Question("Le prix de cette MO est égal à  zéro !\n Confirmez-vous votre saisie ? ", "Oui", "Non") = 1 Then
          MajColdetailMo()
        Endif
      Else
        MajColdetailMo()
      Endif
    Endif
  Endif
  
End

Public Sub MajColdetailMo()
  
  Dim Enrg As Boolean = True
  
  If Val(Utils.cpoint(MargeMo.Text)) <= 0 And If Settings["/Soc" & Start.Societe & "/Marge"] Then
    If start.son Then
      Music.Play
    Endif
    If Message.Question("Attention ! Votre marge est négative. Voulez-vous ?", "1- Modifier la saisie.", "2- Confirmer la saisie.") = 1 Then Enrg = False
  Endif
  If Enrg = True Then
    libelle.Text = Utils.Remplace(libelle.Text)
    'Mrg.Text = Format$(Val(Utils.cpoint(Mrg.text)) + Val(Utils.cpoint(MargeMo.text)), "0.00")
    If Val(Utils.cpoint(MargeMo.Text)) < 0 Then
      Mrg.Background = &HEF3E1A&
    Else
      Mrg.Background = &HD4D0C8&
    Endif
    Mrgmo = Mrgmo + Val(Utils.cpoint(MargeMo.text))
    If Not IsNull(ChangeTx) And If ChangeTx <> Txhr.text Then
      Calc_Txhr()
      If b = 1 Then
        Txhr.SetFocus
        Txhr.Select
        b = 0
      Else
        Calc_Tmont()
        MajColdetailMo2()
      Endif
    Else
      If Not IsNull(Changeb) And If Changeb <> Brutht.text Then
        Calc_Brut()
        If b = 1 Then
          Brutht.SetFocus
          Brutht.Select
          b = 0
        Else
          MajColdetailMo2()
        Endif
      Else
        If Not IsNull(Changer) And If Changer <> Rem.text Then
          Calc_Rem()
          If b = 1 Then
            Rem.SetFocus
            Rem.Select
            b = 0
          Else
            MajColdetailMo2()
          Endif
        Else
          If Not IsNull(Changep) And If Changep <> NetHt.text Then
            Calc_Puht()
            If b = 1 Then
              NetHt.SetFocus
              NetHt.Select
              b = 0
            Else
              MajColdetailMo2()
            Endif
          Else
            If Not IsNull(Changet) And If Changet <> Nettc.text Then
              Calc_moHt()
              If b = 1 Then
                Nettc.SetFocus
                Nettc.Select
                b = 0
              Else
                MajColdetailMo2()
              Endif
            Else
              If Not IsNull(Changetm) And If Changetm <> Tmont.text Then
                Calc_Tmont()
                If b = 1 Then
                  Tmont.SetFocus
                  Tmont.Select
                  b = 0
                Else
                  MajColdetailMo2()
                Endif
              Else
                MajColdetailMo2()
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
    modif = "0"
  Else
    Tmont.SetFocus
    Tmont.Select
  Endif
  
End

Public Sub MajColdetailMo2()
  
  Dim lg As Integer = 1
  Dim sline As String
  
  If modif = "1" Then
    Coldetail.MoveFirst
    Repeat
      Try Coldetail.item.Selected = True
      If Coldetail.item[0] = Nlg.Text Then
        Break
      Endif
    Until Coldetail.MoveNext()
  Endif
  If N = 1 Then Coldetail.Add(Nlg.text, Nlg.text)
  Coldetail.item[0] = Nlg.text
  Coldetail.item[1] = Cmo.text
  Coldetail.item[2] = libelle.text
  Coldetail.item[3] = Txhr.text
  Coldetail.item[4] = Tmont.text
  Coldetail.item[5] = Brutht.text
  Coldetail.item[6] = rem.text
  Coldetail.item[7] = Netht.text
  Coldetail.item[9] = typeL
  Coldetail.item[8] = Nettc.Text
  Coldetail.item[10] = Tm.text
  Coldetail.item[12] = Tmo.Text
  Coldetail.item[13] = Cdfam.Text
  Bloc = Nlg.text & Cmo.text & Round(Rnd(1000, 9999))
  Enrg_Ligmo()
  If Impcar = True And Modif <> "1" Then
    Coldetail.MoveLast()
    Try Coldetail.item.Selected = True
    If Not Error Then
      Nlg.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
      For Each sline In Split(Intit, "\n")
        Coldetail.Add(Nlg.text & Lg, Nlg.text & Lg)
        Coldetail.item[0] = Nlg.text
        Coldetail.item[2] = sline
        Coldetail.item[9] = "R"
        Coldetail.item[16] = Bloc
        Inc lg
      Next
      Enrg_Ligcar2()
    Endif
  Endif
  Cmo.SetFocus
  Cmo.Select
  Razmo()
  Motm_Click()
  N = 1
  modif = "0"
  
End

'**********************************************************
'*                 Gestion onglet Saisie Articles         *
'**********************************************************
Public Sub SelectionArt()
  
  'Dim sel As String
  Dim MyForm As TriArticles
  
  If Panel11.visible = True Then
    hcol.Clear
    Panel11.visible = False
  Endif
  Bsel = False
  Tab = "Fiches_Art"
  sel = ""
  If Colmo.Visible Then
    Colmo.Clear
    Colmo.Visible = False
    HBox8.Visible = False
  Endif
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Endif
  If ColCom.Visible Then
    Colcom.Clear
    ColCom.Visible = False
  Endif
  ChkFocus = 2
  Tri = "art_code"
  MyForm = New TriArticles(Bart.Value, B2art.Value, Tri, "Facture", "", "")
  MyForm.Showmodal()
  If Bsel = True Then
    Cart.text = Codearticle
    Art_Man(Cart.Text)
  Else
    Cart.SetFocus
  Endif
Catch
  
End

Public Sub Art_Rpl()
  
  Dim Rpl, Rpl2 As Result
  Dim prodru As String = Cart.Text
  
  If stk And Val(Qte.Text) <= 0 And If Tp = "B" Or Tp = "F" Then
    Rpl = utils.db.Exec("SELECT *  From " & Cbase.Table("TabRpl1") & " Left join " & Cbase.Table("TabArt") & " on art_code = coderpl1 WHERE codep = &1 order by coderpl1", Cart.Text)
    If Rpl.count > 1 Then
      hcol.Columns.Count = 3
      hcol.Columns[0].Width = 180
      hcol.Columns[0].Text = "Code"
      hcol.Columns[1].Width = 470
      hcol.Columns[1].Text = "Désignation"
      hcol.Columns[2].Width = 80
      hcol.Columns[2].Text = "Quantité"
      Repeat
        If Rpl!art_qte > 0 Then
          hcol.Add(Rpl!coderpl1, Rpl!coderpl1)
          hcol.item[0] = Rpl!art_code
          hcol.item[1] = Rpl!art_design
          hcol.item[2] = Rpl!art_qte
        Endif
      Until Rpl.MoveNext()
      If hcol.count = 1 Then
        Try Cart.Text = hcol.current[0]
        If start.son Then
          Music.Play
        Endif
        Message.Info("Le produit " & prodru & " est en rupture de stock il est remplacé par " & Cart.Text)
        ArtQte.SetFocus
        ArtQte.Select
      Else
        If hcol.count > 1 Then
          Panel11.Visible = True
          If start.son Then
            Music.Play
          Endif
          Message.Info("Le produit " & prodru & " est en rupture de stock, veuillez sélectionner un produit de remplacement SVP ! " & Cart.Text)
          hcol.SetFocus
        Endif
      Endif
    Else
      If Rpl.count = 1 Then
        Rpl2 = utils.db.Exec("SELECT *  From " & Cbase.Table("TabArt") & " WHERE art_code = &1", Rpl!coderpl1)
        If Rpl2.Available Then
          If Val(Utils.cpoint(Rpl!art_qte)) > 0 Then
            Cart.Text = Rpl!coderpl1
            If start.son Then
              Music.Play
            Endif
            Message.Info("Le produit " & prodru & " est en rupture de stock il est remplacé par " & Cart.Text)
            ArtQte.SetFocus
            ArtQte.Select
          Else
            If start.son Then
              Music.Play
            Endif
            If message.Question("Ce produit n'est plus en stock et il n'y a plus de produits de remplacement\nVoulez-vous continuer la saisie avec ce produit ?", "Oui", "Non") = 1 Then
            Else
              Cleanart()
              Cart.SetFocus
            Endif
          Endif
        Else
          Utils.db.Exec("DELETE FROM " & Cbase.Table("TabRpl1") & " where coderpl1 = &1", Rpl!coderpl1)
        Endif
      Endif
    Endif
  Endif
  
End

Public Sub Art_Equ(Equiv As String)
  
  Dim MyForm As TriEqu
  Dim Rpl As Result
  Dim Bmodif As String = modif
  
  Rpl = utils.db.Exec("select *  from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where codequ = &1 order by codep", Equiv)
  If Rpl.Available Then
    If Rpl.count > 1 Then
      Tri = "art_code"
      MyForm = New TriEqu("Facture", Cart.Text, retro.value, code.text, Typec, Tcli)
      MyForm.Showmodal()
      If Bsel Then 
        Equ = True
        Maj_zonesArt()
      Else
        Cart.SetFocus
        cart.select
      Endif
    Else
      Equ = True
      Cart.text = Rpl!codep
      Maj_zonesArt()
    Endif
  Else
    Equ = True
    Maj_zonesArt()
  Endif
  modif = Bmodif
  
End

Public Sub Art_Equ2(Equiv As String)
  
  Dim Rpl As Result
  Dim affichage As Boolean = False
  Dim WidthCol As String
  Dim s As String
  Dim spl As New String[10]
  
  hcol.AutoResize = False
  hcol.Expand = False
  'hcol.sorted = False
  hcol.font = Font["Serif,-1"]
  Rpl = utils.db.Exec("select *  from " & Cbase.Table("TabCequ") & " as e inner join " & Cbase.Table("TabArt") & " as a on a.art_code = e.codep where codequ = &1 order by codep", Equiv)
  If Rpl.Available Then
    If Rpl.count = 1 And Rpl!art_code <> cart.text Then affichage = True
    If Rpl.count > 1 Then affichage = True
    If affichage = True Then
      hcol.clear
      hcol.Columns.Count = 9
      Try WidthCol = Settings["/Soc" & Start.Societe & "/Col/LcolEqu"]
      If Not IsNull(WidthCol) Then
        WidthCol = Trim(WidthCol)
        If Right(WidthCol, 1) = ";" Then WidthCol = Left(WidthCol, Len(WidthCol) - 1)
        For Each s In Split(LCase(WidthCol), ";")
          spl = Scan(s, "*:*")
          Select Case Trim(spl[0])
            Case "col0"
              Try hcol.Columns[0].Width = spl[1]
            Case "col1"
              Try hcol.Columns[1].Width = spl[1]
            Case "col2"
              Try hcol.Columns[2].Width = spl[1]
            Case "col3"
              Try hcol.Columns[3].Width = spl[1]
            Case "col4"
              Try hcol.Columns[4].Width = spl[1]
            Case "col5"
              Try hcol.Columns[5].Width = spl[1]
            Case "col6"
              Try hcol.Columns[6].Width = spl[1]
            Case "col7"
              Try hcol.Columns[7].Width = spl[1]
            Case "col8"
              Try hcol.Columns[7].Width = spl[1]
          End Select
        Next
      Else
        hcol.Columns[0].Width = 80
        hcol.Columns[1].Width = 380
        hcol.Columns[2].Width = 70
        hcol.Columns[3].Width = 80
        hcol.Columns[4].Width = 80
        hcol.Columns[5].Width = 80
        hcol.Columns[6].Width = 100
        hcol.Columns[7].Width = 80
        hcol.Columns[8].Width = 80
      Endif
      hcol.Columns[0].Text = "Code"
      hcol.Columns[0].Alignment = 0
      hcol.Columns[1].Text = "Désignation"
      hcol.Columns[2].Text = "Quantité"
      hcol.Columns[2].Alignment = 3
      hcol.Columns[3].Text = "Pa HT"
      hcol.Columns[3].Alignment = 2
      hcol.Columns[4].Text = "Pv TTC"
      hcol.Columns[4].Alignment = 2
      hcol.Columns[5].Text = "Famille"
      hcol.Columns[5].Alignment = 3
      hcol.Columns[6].Text = "Fournisseur"
      hcol.Columns[7].Text = "Equivalent"
      hcol.Columns[8].Text = "HT Pro"
      hcol.Columns[8].Alignment = 2
      If affichage = True Then
        Repeat
          Try hcol.Add(Rpl!art_code & Rpl!codequ, Rpl!art_code & Rpl!codequ)
          If Not Error Then
            hcol.item[0] = Rpl!art_code
            hcol.item[1] = Rpl!art_design
            hcol.item[2] = Rpl!art_qte
            hcol.item[3] = Format$(Val(Utils.cpoint(Rpl!art_paht)), "0.00")
            hcol.item[4] = Format$(Val(Utils.cpoint(Rpl!art_pvttc)), "0.00")
            hcol.item[5] = Rpl!art_fam
            hcol.item[6] = Rpl!art_four
            hcol.item[7] = Rpl!codequ
            Tarifclient()
          Endif
        Until Rpl.MoveNext()
      Endif
      Panel11.Visible = True
      Equ = True
      hcol.SetFocus
    Else
      Equ = True
      Maj_zonesArt()
    Endif
  Else
    Equ = True
    Maj_zonesArt()
  Endif 
  
End

Public Sub Tarifclient()
  
  Dim Tarts As Result
  Dim RemCli As Float = 0
  Dim prvt As Float
  Dim Typeremise As String
  
  With Utils
    If retro.value = False Then
      Tarts = Utils.db.Exec("SELECT art_fam, art_pvht FROM " & Cbase.Table("TabArt") & " where art_code = &1", hcol.item[0])
      If Tarts.Available Then
        prvt = Tarts!art_pvht
        Tarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabRemTypec") & " where coder = &1 and codef = &2", Typec, Tarts!art_fam)
        If Tarts.Available Then
          Remcli = Tarts!remise
          Typeremise = "Typec"
          If remcli <> 0 Then
            Try prvt = prvt - (prvt * Remcli / 100)
            Try hcol.item[8] = Format$(Val(.cpoint(prvt)), "0.00")
            'Else
            'prvt = Tarts!art_prvt
          Endif
        Else
          Remcli = 0
          Typeremise = ""
        Endif
      Endif
      Tarts = Utils.db.Exec("SELECT art_fam, art_pvht FROM " & Cbase.Table("TabArt") & " where art_code = &1", hcol.item[0])
      If Tarts.Available Then
        prvt = Tarts!art_pvht
        Tarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("RemCliFam") & " where codec = &1 and codef = &2", Code.text, Tarts!art_fam)
        If Tarts.Available Then
          Remcli = Tarts!remise
          Typeremise = "Clifam"
          If remcli <> 0 Then
            Try prvt = prvt - (prvt * Remcli / 100)
            Try hcol.item[8] = Format$(Val(.cpoint(prvt)), "0.00")
            'Else
            'prvt = Tarts!art_prvt
          Endif
        Else
          If IsNull(Remcli) Then 
            Remcli = 0
            Typeremise = ""
          Endif
        Endif
      Endif
      If Not IsNull(typec) Then
        Tarts = Utils.db.Exec("SELECT art_fam FROM " & Cbase.Table("TabArt") & " where art_code = &1", hcol.item[0])
        If Tarts.Available Then
          Tarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCtcli") & " Left join " & Cbase.Table("TabArt") & " on art_code = &3  where coder = &1 and codef = &2", Typec, Tarts!art_fam, hcol.item[0])
          If Tarts.Available Then
            'If remcli <> 0 Then
            'Try prvt = Tarts!art_prvt - (Tarts!art_prvt * Remcli / 100)
            'Else
            prvt = Tarts!art_prvt
            'Endif
            Try hcol.item[8] = Format$(Val(.cpoint(prvt)) * Val(.cpoint(Tarts!coeff)), "0.00")
          Endif
        Endif
      Endif
      If Tcli Then
        Tarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTcli") & " Left join " & Cbase.Table("TabArt") & " on art_code = &2  where type = &1 and cart = &2", Typec, hcol.item[0])
        If Tarts.Available Then
          'If remcli <> 0 Then
          'Try prvt = Tarts!art_prvt - (Tarts!art_prvt * Remcli / 100)
          'Else
          prvt = Tarts!art_prvt
          'Endif
          Try hcol.item[8] = Format$(Val(.cpoint(prvt)) * Val(.cpoint(Tarts!coef)), "0.00")
        Endif
      Endif
      Tarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTarcli") & " Left join " & Cbase.Table("TabArt") & " on art_code = &2 where ccli = &1 and cart = &2", Code.Text, hcol.item[0])
      If Tarts.Available Then
        prvt = Tarts!art_prvt
        Try hcol.item[8] = Format$(Val(.cpoint(prvt)) * Val(.cpoint(Tarts!coef)), "0.00")
      Endif
    Endif
  End With
  
End

Public Sub hcol_click()
  
  Try Cart.Text = hcol.current[0]
  If Not Error Then
    Try Settings["/Soc" & Start.Societe & "/Col/LcolEqu"] = "col0:" & hcol.Columns[0].Width & ";" & "col1:" & hcol.Columns[1].Width & ";" & "col2:" & hcol.Columns[2].Width & ";" & "col3:" & hcol.Columns[3].Width & ";" & "col4:" & hcol.Columns[4].Width & ";" & "col5:" & hcol.Columns[5].Width & ";" & "col6:" & hcol.Columns[6].Width & ";" & "col7:" & hcol.Columns[7].Width
    hcol.Clear
    Panel11.visible = False
    equ = True
    Maj_zonesArt()
  Endif
  
End

Public Sub hcol_Keypress()
  
  If Key.code = Key.Enter Then hcol_click()
  
  If Key.code = Key.Esc Or If Key.code = Key.f2 Then
    hcol.Clear
    Panel11.visible = False
    Cart.Clear
    Cart.SetFocus
    chkfocus = "2"
  Endif
  
End

'**************************************
'* On Selectionne l'article saisi     *
'**************************************
Public Sub Art_man(Prod As String)
  
  Dim Rarts As Result
  
  TextLabel60.Hide
  Qte.Hide
  Tab = "Fiches_Art"
  chkfocus = 1
  Equ = False
  If Impfac <> 1 Then
    If Left$(Cart.Text, 1) = "*" Then
      Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
      Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
    Endif
    Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_refcentrale = &1", Cart.Text)
    If Not Rarts.Available Then
      Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Cart.Text)
    Endif 
    If Rarts.Available Then
      Stk = Rarts!art_stocke
      Qte.Text = Utils.CPoint(Rarts!art_qte)
      $photo = Rarts!art_photo
      If Not IsNull($photo) Then Artdsg.Background = &h00CAE8CA&
      Art_Rpl()
      Art_Equ(Cart.Text)
      If Equ = False Then
        If Not IsNull(Cart.Text) Then
          If start.son Then
            Music.Play
          Endif
          Try message.Warning(" L'article " & Cart.Text & " n'existe pas ! ")
          b = 1
          Cart.Clear
          Cart.SetFocus
          Cart.Select
        Endif
        b = 1
        Cart.Clear
        Cart.SetFocus
        chkfocus = 2
      Else
        If Panel11.Visible = True Then hcol.SetFocus
      Endif
      qte_Cbarre = "0"
    Else
      Art_Equ(Cart.Text)
      If Equ = False Then
        Try message.Warning(" L'article " & Cart.Text & " n'existe pas ! ")
        b = 1
        Cart.Clear
        Cart.SetFocus
        Cart.Select
      Else
        hcol.SetFocus
      Endif
    Endif
    qte_Cbarre = "0"
  Else
    If start.son Then
      Music.Play
    Endif
    Try Message.Warning(" La facture a été imprimée ! Ajout d'article impossible.")
    b = 1
    Cart.Clear
    Cart.SetFocus
    Cart.Select
  Endif
  
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  b = 1
  Cart.setfocus
  
End

Public Sub Maj_zonesArt()
  
  Dim Remtypec As Result
  Dim Sk As String
  Dim Rarts As Result
  Dim Tresult As Result
  Dim Tartpu As Float
  Dim Tbrlt As String
  
  Qte.Text = "1"
  Artqte.Text = "1"
  Tab = "Fiches_Art"
  Tbrlt = "Fiches_RemTypec"
  Modif = 0
  With Utils
    If Not IsNull(Cart.text) Then
      Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " left join " & Cbase.Table("TabFour") & " on fo_code = art_four where art_code = &1", Cart.Text)
      If Rarts.Available Then
        'Art_Equ2(Rarts!art_cequ) 
        sk = Settings["/Soc" & Start.Societe & "/Ctrlstk"]
        If IsNull(sk) Then
          If start.son Then
            Music.Play
          Endif
          message.Error("Les préférences pour cette société ne sont pas toutes définies !\n Veuillez les completer avant de saisir vos factures SVP.")
          B = 1
        Else
          sk = .cpoint(Rarts!art_qte)
          If IsNull(sk) Then sk = "0"
          If Rarts!art_stocke And Settings["/Soc" & Start.Societe & "/Ctrlstk"] And Val(sk) <= 0 And If Tp = "B" Or Tp = "F" Then
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning("Saisie impossible! Le stock de ce produit est égal ou inférieur à zéro.")
            Cleanart()
            'Artpu.Clear
            b = 1
          Else
            Cleanart()
            Qte.Text = "1"
            Artqte.Text = "1"
            Cart.text = Rarts!art_code
            Artdsg.text = Rarts!art_design
            Maj_libelle()
            Artdsg2 = Rarts!art_design2
            Artfam.Text = Rarts!art_fam
            ArtFour.text = Rarts!art_four
            If TextLabel41.Text = "Famille" Then
              ArtFour.Visible = False
              Frame4.Visible = False
            Else
              ArtFour.Visible = True
              Frm12()
              Frame4.Visible = True
            Endif
            $Four = Rarts!art_four
            $Fam = Rarts!art_fam
            Materiel = Rarts!art_mat
            $crst = Rarts!art_crst
            If Not IsNull($crst) Then
              Artdsg.Tooltip = $crst
              Artqte.Tooltip = $crst
              Artdsg.Background = &h00CAE8CA&
            Else
              Artdsg.Tooltip = ""
              Artqte.Tooltip = ""
              Artdsg.Background = Color.TextBackground
            Endif
            If Materiel Then
              Artqte.ReadOnly = True
            Else
              Artqte.ReadOnly = False
            Endif
            Nbd = Rarts!art_nbd
            Nbdec = .Find_Nbdec(Nbd)
            If Prxdec Then 
              ar$ = "0"
            Else
              ar$ = Nbdec
            Endif
            Paht = Format$(Rarts!art_paht, ar$)
            Pmp = Rarts!art_pmp
            Try coefdep = Rarts!art_coefdep
            If Error Then coefdep = 1
            If Bdevis.Value = False Then
              If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
              If apromo = True Then
                Artpu.Text = Format$(ArtPromo.Prix_Promo(Cart.text, Cpromo), Ar$)
                Artbrut.Text = Format(Val(Artpu.Text), Ar$)
              Endif
              If apromo = True Then Balloon.Info(("Ce produit est actuellement en promotion"), Cart)
            Endif
            If retro.value = False Then
              If Apromo = False Then
                Artpu.Text = Format$(Rarts!art_pvht, Ar$)
                Artbrut.Text = Format(Val(Artpu.Text), Ar$)
                Artrm.Text = Txpieces.Text
              Else
                Artrm.Text = "0,00"
              Endif
            Else
              Artpu.Text = Format$(Rarts!art_paht * Val(Val_retro), Ar$)
              Artbrut.Text = Artpu.Text
              Artrm.Text = "0,00"
            Endif
            If apromo = False Then
              If Retro.value = False And Not IsNull(Typec) And Val(Txpieces.Text) = 0 Then
                If Apromo = False Then
                  Remtypec = Utils.db.Exec("SELECT * FROM " & Tbrlt & " where coder = &1 and codef = &2", Typec, Artfam.Text)
                  If RemTypec.Available And apromo = False Then
                    Artrm.Text = RemTypec!remise
                    RemType = Artrm.Text
                  Endif
                Endif
              Endif
              If Retro.value = False Then
                Remtypec = Utils.db.Exec("SELECT * FROM " & Cbase.Table("RemCliFam") & " where codec = &1 and codef = &2", Code.text, Artfam.Text)
                If RemTypec.Available Then
                  Artrm.Text = RemTypec!remise
                  RemType = Artrm.Text
                Endif
              Endif
            Endif
            Try spvcons = Format$(Rarts!art_pvcons, Ar$)
            $UV = Rarts!art_uv
            If IsNull($UV) Then $UV = "0"
            If Error Then spvcons = "0,00"
            Arttc.ToolTip = "PV TTC conseillé " & spvcons
            arr = Rarts!art_cdarr
            Ecotaxe = Rarts!art_ect
            If Rarts!art_eco Then
              Try Valeur_Ecotaxe = Rarts!art_eco
            Endif
            Ecotaxe2 = Rarts!art_ect2
            If Rarts!art_eco2 Then
              Try Valeur_Ecotaxe2 = Rarts!art_eco2
            Endif
            Taxepv = Rarts!art_cpp
            If Rarts!art_copp Then
              Try Valeur_Copp = Rarts!art_copp
            Endif
            If Not tvar.Value Then
              Arttx.Text = Rarts!art_tva
              Arttx.ReadOnly = True
            Else
              Arttx.Text = Codetva
              Arttx.ReadOnly = False
            Endif
            Dec.Text = Rarts!art_dec
            Impcar = Rarts!art_impcar
            Intit = Rarts!art_crst
            Pdc = Rarts!art_prdcomp
            Try Colvente = Rarts!art_colvte
            Try PVHT2 = Rarts!art_pvht2
            If Rarts!art_stocke Then 
              Quantite()
              ComArt()
            Endif
            Artrm_LF()
            If retro.value = True Then Artqte_LF()
            If retro.value = True Or If Impauto Or If Franchise Then Arttc_LF()
            Pdx = Rarts!art_poids
            If IsNull(Pdx) Then
              Pdx = "0,000"
              Pdxart.Text = Pdx
            Else
              Pdxart.Text = Format$(Pdx, "0.000")
            Endif
            If retro.value = False Then
              If Not IsNull(typec) Then
                Tresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCtcli") & " where coder = &1 and codef = &2", Typec, Artfam.Text)
                If Tresult.Available Then
                  Balloon.Info(("Coefficient de vente par type client " & Typec), Cart)
                  Tcoeff = Tresult!coeff
                  artpu.Text = Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff))
                  Artpu_LF()
                Endif
              Endif
              If Tcli Then
                Tresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTcli") & " where type = &1 and cart = &2", Typec, Cart.Text)
                If Tresult.Available Then
                  Tcoeff = Tresult!coef
                  Tartpu = Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff))
                  If apromo = True And Val(.cpoint(Artpu.Text)) > Val(.cpoint(Tartpu)) Or If apromo = False Then
                    Message.Info("Tarif type client " & Typec)
                    Artrm.Text = "0,00"
                    Artpu.Text = Format$(Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff)), Ar$)
                    Recup_Tva()
                    Artpu_LF()
                  Endif
                Endif
                Tresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTarcli") & " where ccli = &1 and cart = &2", Code.Text, Cart.Text)
                If Tresult.Available Then
                  Tcoeff = Tresult!coef
                  Artrm.Text = "0,00"
                  Tartpu = Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff))
                  If apromo = True And Val(.cpoint(Artpu.Text)) > Val(.cpoint(Tartpu)) Or If apromo = False Then
                    Message.Info("Tarif client")
                    Artpu.Text = Format$(Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff)), Ar$)
                    Recup_Tva()
                    Artpu_LF()
                  Endif
                Endif
              Endif
              If Settings["/Soc" & Start.Societe & "/Depannage"] Then
                If Depg.Text = "Dépannage" Then
                  Tcoeff = Coefdep
                  Artrm.Text = "0,00"
                  Tartpu = Val(.cpoint(artpu.text)) * Val(.cpoint(Tcoeff))
                  Message.Info("Tarif dépannage")
                  Artpu.Text = Format$(Val(.cpoint(artpu.text)) * Val(.cpoint(Tcoeff)), Ar$)
                  Recup_Tva()
                  Artpu_LF()
                Endif
              Endif
            Endif
            Try Rms[0, 0] = Str(Rarts!qte1)
            Try Rms[0, 1] = Str(Rarts!qte2)
            Try Rms[0, 2] = Str(Rarts!rem1)
            Try Rms[1, 0] = Str(Rarts!qte3)
            Try Rms[1, 1] = Str(Rarts!qte4)
            Try Rms[1, 2] = Str(Rarts!rem2)
            Try Rms[2, 0] = Str(Rarts!qte5)
            Try Rms[2, 1] = Str(Rarts!qte6)
            Try Rms[2, 2] = Str(Rarts!rem3)
            Try Rms[3, 0] = Str(Rarts!qte7)
            Try Rms[3, 1] = Str(Rarts!qte8)
            Try Rms[3, 2] = Str(Rarts!rem4)
            Try Rms[4, 0] = Str(Rarts!qte9)
            Try Rms[4, 1] = Str(Rarts!qte10)
            Try Rms[4, 2] = Str(Rarts!rem5)
            Try Rms[5, 0] = Str(Rarts!qte11)
            Try Rms[5, 1] = Str(Rarts!qte12)
            Try Rms[5, 2] = Str(Rarts!rem6)
          Endif
        Endif
        Art_Rpl()
        If Val(Artpu.text) = 0 Then
          Artdsg.SetFocus
          Artdsg.Select
          If sTTC.Value Then
            Textlabel30.text = "Prix TTC"
            Artpu.text = Arttc.Text
          Else
            Textlabel30.text = "Prix HT" 
          Endif
        Else
          If Not IsNull($UV) And If Val($UV) > 0 Then Balloon.Info(("Unité d'emballage à la vente : " & $UV), Artqte)
          ArtQte.SetFocus
          ArtQte.Select
          Textlabel30.text = "Prix HT"
        Endif
      Else
        Try message.Warning(" Le code article " & Cart.Text & " n'existe pas ! ")
        Cart.SetFocus
        Cart.clear
      Endif
    Endif
  End With
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub Depg_Click()
  
  If Depg.Text = "Dépannage" Then
    If Coefdep > 1 Then
      Maj_zonesArt()
      Tcoeff = Coefdep
      Artrm.Text = "0,00"
      Message.Info("Tarif dépannage")
      Artpu.Text = Format$(Val(Utils.cpoint(artpu.text)) * Val(Utils.cpoint(Tcoeff)), Ar$)
      Recup_Tva()
      Artpu_LF()
    Endif
  Else
    Maj_zonesArt()
  Endif
  
End

Public Sub Arttx_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then arttx_LostFocus()
  
End

Public Sub arttx_LostFocus()
  
  Artqte_LF()
  Arttc.SetFocus
  Arttc.Select
  
End

'**********************************************************
'*           Affichage des quantites en stock             *
'**********************************************************
Public Sub Quantite()
  
  Tab = "Fiches_Art"
  With utils
    rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Cart.text)
    If rResult.Available Then
      Stk = rResult!art_stocke
      Qte.Text = .CPoint(rResult!art_qte)
      If IsNull(qte.Text) Then qte.Text = "0"
    Endif
    If Stk Then
      TextLabel60.Show
      Qte.Show
      If Dec.Text = "0" Then Qte.Text = Format$(Val(Qte.Text), "0")
      If Dec.Text = "2" Then Qte.Text = Format$(Val(Qte.Text), "0.00")
      If Dec.Text = "3" Then Qte.Text = Format$(Val(Qte.Text), "0.000")
      If Val(Qte.Text) < 1 Then
        Qte.Background = &HEF3E1A&
      Else
        Qte.Background = &HD4D0C8&
      Endif
    Else
      TextLabel60.Hide
      Qte.Hide
    Endif
  End With
  
End

'***************************************************
'*    On calcule le montant de la marge article    *
'***************************************************
Public Sub Calc_Marge()
  
  Dim rMrg As Result
  
  If Pmp = 0 Then
    rMrg = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFam") & " WHERE code_fam = &1", ArtFam.Text)
    If Not Prxdec Then
      Try Marge.Text = Format$(Val(Artnet.Text) / Val(Utils.cpoint(rMrg!coef_fam)), ar$)
    Else
      Try Marge.Text = Format$(Val(Artnet.Text) / Val(Utils.cpoint(rMrg!coef_fam)), ar$)
    Endif
  Else
    If Not Prxdec Then
      Try Marge.Text = Format$((Val(Artnet.Text)) - (Val(Utils.cpoint(Pmp)) * Val(Utils.cpoint(Artqte.Text))), ar$)
    Else
      Try Marge.Text = Format$((Val(Artnet.Text)) - (Val(Utils.cpoint(Pmp)) * Val(Utils.cpoint(Artqte.Text))), ar$)
    Endif 
  Endif
  
End

'****************************
'* Gestion du panel Art     *
'****************************
Public Sub Art_Mouseup()
  
  Select Case Last.Tag
    Case 3
      If sTTC.Value Then
        Textlabel30.text = "Prix TTC"
        Recup_Tva()
        Artpu.Text = Val(Utils.CPoint(Artbrut.Text)) + (Val(Utils.CPoint(Artbrut.Text)) * Ttva / 100)
        Artpu.Text = Format$(Val(Utils.cpoint(Artpu.Text)) / Val(Utils.cpoint(Artqte.Text)), ar$)
        'Artpu.text = Arttc.Text
      Else
        Textlabel30.text = "Prix HT" 
      Endif
      Artpu.select
  End Select
  If Chkf = 1 Then
    Chkfocus = 0
  Else
    chkfocus = 1
  Endif
  
End

Public Sub Art_Change()
  
  Chkf = 1
  
End

Public Sub ComArt()
  
  Dim Ligcom As Result
  Dim qteclient, qtecom, qtedispo As Float = 0
  Dim msg As String
  
  Ligcom = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigbl") & " left join " & Cbase.Table("TabBl") & "  on numbl = num_ligbl where code_ligbl = &1", Cart.Text)
  If Ligcom.Available Then
    Repeat
      If Ligcom!type = "C" Then Try qteclient = qteclient + Ligcom!qte_ligbl
    Until Ligcom.MoveNext()
  Endif
  Qtecom = Utils.Commande(Cart.Text, "", 1, "Four")
  If Qteclient > 0 Then msg = "Il y a " & Qteclient & " produit(s) dans les commandes clients !"
  If Qtecom > 0 Then msg &= "\nIl y a " & Qtecom & " produit(s) dans les commandes fournisseurs !"
  If Qteclient > 0 Or If Qtecom > 0 Then 
    If stk Then msg &= "\nIl y a " & Qte.text & " produits en stock !"
    qtedispo = Val(utils.cpoint(Qte.text)) + qtecom - qteclient 
    If stk Then 
      msg &= "\nStock disponible = " & qtedispo
    Else
      msg &= "\nProduit non stocké !"
    Endif
    Message.Info(msg)
  Endif
  'Catch
  'If start.son Then
  'Music.Play
  'Endif
  'Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub aff_photo()
  
  Dim hform3 As Fcaras
  
  If Not IsNull($photo) Or If Not IsNull($crst) Then
    ChkFocus = 2
    hForm3 = New Fcaras($photo, $crst)
    hForm3.Showmodal()
    ChkFocus = 0
  Endif 
  
End

Public Sub Art_KeyPress()
  
  Dim Rep As Boolean = False
  Dim hform2 As Form
  
  T = 0
  'On affiche la photo
  If key.Control Then
    If Key.code = 80 Then
      Select Case Last.tag
        Case 2
          aff_photo()
          
        Case 4
          aff_photo()
      End Select
    Endif
  Endif
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        ChkFocus = 2
        If Cart.Text = "*" Then
          CArt.Text = sArt
          Rep = True
        Endif
        sArt = Cart.Text
        If Cart.Text = "" Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir un article SVP", "Ok")
          Cart.SetFocus
          Cart.Select
        Else
          If Lbarre = 1 Then
            Cart.text = "*" & Cart.Text
            Lbarre = 0
          Endif
          If Left$(Cart.Text) = "*" Then
            Artbarre = "1"
            Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
            Cart.Text = Utils.Find_Cbarre(Cart.Text)
            Wait 0.2
            Art_Man(Cart.Text)
          Else
            Artbarre = "0"
            Art_Man(Cart.Text)
            If Rep = True Then Artdsg.Text = sDsg
          Endif
        Endif
        
        If b <> 1 And equ = False Then Artdsg.SetFocus
        Stop Event
        
      Case 2
        ChkFocus = 2
        If Artdsg.Text = "*" Then Artdsg.Text = sDsg
        Artdsg.Text = Utils.Remplace(Artdsg.Text)
        sDsg = Artdsg.Text
        If Not Cart.Text Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir un article SVP", "Ok")
          Cart.SetFocus
          Cart.Select
        Else
          If Not Artdsg.Text Then
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
            Artdsg.SetFocus
            Artdsg.Select
          Else
            Artpu.SetFocus
            Artpu.Select
          Endif
        Endif
        Stop Event
        
      Case 3
        ChkFocus = 2
        Artpu_LF()
        If b = 1 Then
          Artpu.SetFocus
          Artpu.Select
          B = 0
        Else
          Artqte.SetFocus
          Artqte.Select
        Endif
        Stop Event
        
      Case 4
        ChkFocus = 2
        Artqte_LF()
        If b = 1 Then
          Artqte.SetFocus
          Artqte.Select
          b = 0
        Else
          Button11.SetFocus
        Endif
        Stop Event
        
      Case 5
        ChkFocus = 2
        Artbrut_LF()
        'Arttc_LF()
        If b = 1 Then
          Artbrut.SetFocus
          Artbrut.Select
        Else
          Artrm.SetFocus
          Artrm.Select
        Endif
        Stop Event
        
      Case 6
        ChkFocus = 2
        Artrm_LF()
        If b = 1 Then
          Artrm.SetFocus
          Artrm.Select
        Else
          'Artnet_GF()
          Artnet.SetFocus
          Artnet.Select
        Endif
        Stop Event
        
      Case 7
        ChkFocus = 2
        Artnet_LF()
        Arttc_LF()
        If b = 1 Then
          Artnet.SetFocus
          Artnet.Select
        Else
          'Arttc_GF()
          Arttc.SetFocus
          Arttc.Select
        Endif
        Stop Event
        
      Case 8
        ChkFocus = 2
        Recup_Tva()
        Arttc_LF()
        If b = 1 Then
          Arttc.SetFocus
          Arttc.Select
          b = 0
        Else
          Button11.SetFocus
        Endif
        Stop Event
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
  Endif
  
  If Key.code = Key.F2 Then
    Select Case Last.tag
        
      Case 1
        SelectionArt()
        Stop Event
        
    End Select
  Endif
  
  If Key.code = Key.F3 Then
    Button15_Click()
    Bl_Edit()
    Stop Event
  Endif
  
  If key.Code = key.F4 Then
    ChkFocus = 2
    Articles.ShowModal()
    Chkfocus = 0
    Recup_type()
    Stop Event
  Endif
  
  If Key.code = Key.f5 Then
    ChkFocus = 2
    hForm = New Fcalc
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then Last.Text = Format$(Val(FCalc.Resultat), "0.000")
    ChkFocus = 0
  Endif
  
  If key.Code = key.F6 Then
    Button15_Click()
    Bl_Edit()
    Edit.Visible = False
    Button14_Click()
    Stop Event
  Endif
  
  If key.Code = key.F7 Then
    ComArt()
    Stop Event
  Endif
  
  If Key.code = Key.F8 Then
    Select Case Last.tag
        'Case 3
        'Achat.Visible = True
        'Achat.setfocus
        'Achat.select
        
      Case 4
        Achat.Visible = True
        Achat.setfocus
        Achat.select
        
      Case 6
        If Tbrem.visible = True Then
          Tbrem.clear
          Tbrem.visible = False
        Else
          Tbrem.visible = True
          Tbrem.raise
          Tbrem.clear
          Tbrem.Refresh
          Try Tbrem[0, 0].Text = Rms[0, 0]
          Try Tbrem[0, 1].Text = Rms[0, 1]
          Try Tbrem[0, 2].Text = Rms[0, 2]
          Try Tbrem[1, 0].Text = Rms[1, 0]
          Try Tbrem[1, 1].Text = Rms[1, 1]
          Try Tbrem[1, 2].Text = Rms[1, 2]
          Try Tbrem[2, 0].Text = Rms[2, 0]
          Try Tbrem[2, 1].Text = Rms[2, 1]
          Try Tbrem[2, 2].Text = Rms[2, 2]
          Try Tbrem[3, 0].Text = Rms[3, 0]
          Try Tbrem[3, 1].Text = Rms[3, 1]
          Try Tbrem[3, 2].Text = Rms[3, 2]
          Try Tbrem[4, 0].Text = Rms[4, 0]
          Try Tbrem[4, 1].Text = Rms[4, 1]
          Try Tbrem[4, 2].Text = Rms[4, 2]
          Try Tbrem[5, 0].Text = Rms[5, 0]
          Try Tbrem[5, 1].Text = Rms[5, 1]
          Try Tbrem[5, 2].Text = Rms[5, 2]
        Endif
    End Select
    Stop Event
  Endif
  
  If key.code = key.F9 Then
    qte_Cbarre = "1"
    Stop Event
  Endif
  
  If Key.code = Key.F10 Then
    Select Case Last.tag
      Case 3
        If sTTC.Value = True Then
          sTTC.value = False
        Else
          sTTC.value = True
        Endif
    End Select
    Stop Event
  Endif
  
  'On lance la duplication
  If key.Control Then
    If Key.code = 68 Then Dupli3()
  Endif
  
  ' On lance le suivi d'affaire
  If key.code = key.F12 Then
    hForm2 = New Suivi(code.text, Cv.Text, Nom.Text, Pnm.Text, Num.Text, datej.Text, "", "", Bdevis.value, Bfac.value, Impfac)
    hForm2.Showmodal()
    Stop Event
  Endif
  
  If key.code = 4131 Then ChkFocus = 2
  
  If key.code = key.Esc Then
    Select Case Last.tag
        
      Case 6
        Tbrem.clear
        Tbrem.visible = False
    End Select
    Stop Event
  Endif
  
  If Key.code = 68 Then
    Select Case Last.tag
      Case 4
        Dec.SetFocus
        Dec.Select
        Stop Event
    End Select
  Endif
  
End

Public Sub Achat_KeyPress()
  
  If Key.code = Key.F8 Then 
    Achat.visible = False
    ArtQte.SetFocus
    ArtQte.Select
  Endif
  If Key.code = Key.Return Or If Key.code = Key.enter Then 
    Achat.Visible = False
    ArtQte.SetFocus()
    ArtQte.Select
  Endif
  
End

Public Sub Achat_Lostfocus()
  
  With utils
    Achat.Text = .CPoint(Achat.Text)
    If Val(Achat.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        Achat.setfocus
      Endif
    Else
      Achat.visible = False
      T = 0
      Pmp = Achat.Text
      Qte.SetFocus
      Qte.select
    Endif
  End With
  
End

'****************************
'* Gestion du panel Art     *
'****************************
Public Sub Art_Lostfocus()
  
  Try Utils.ObsLstf(Last)
  If chkfocus <> 2 Then
    Select Case Last.tag
        
      Case 1
        If chkfocus <> 1 Then
          If Cart.Text = "" Then
            If Not IsNull(Artdsg.text)
              'If start.son Then
              'Music.Play
              'Endif
              'Try Message.Warning("Veuillez saisir un article SVP", "Ok")
              Cleanart()
              Cart.SetFocus
              Cart.Select
            Endif
          Else
            If Left$(Cart.Text) = "*" Then
              Artbarre = "1"
              Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
              Cart.Text = "*" & Utils.Find_Cbarre(Cart.Text)
              Wait 0.1
              Art_Man(Cart.Text)
            Else
              Artbarre = "0"
              Art_Man(Cart.Text)
              'Art_Equ(Cart.Text)
              'If b <> 1 Then Art_Rpl()
            Endif
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 2
        If chkfocus <> 1 Then
          If Artdsg.Text = "*" Then Artdsg.Text = sDsg
          Artdsg.Text = Utils.Remplace(Artdsg.Text)
          If Not Artdsg.Text Then
            If Not IsNull(Cart.Text) Then
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
              Artdsg.SetFocus
              Artdsg.Select
            Endif
          Else
            sDsg = Artdsg.Text
          Endif
          Stop Event
        Endif
        chkfocus = 0
      Case 3
        If chkfocus <> 1 Then
          Artpu_LF()
          If b = 1 Then
            Artpu.SetFocus
            Artpu.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 4
        If chkfocus <> 1 Then
          Artqte_LF()
          If b = 1 Then
            Artqte.SetFocus
            Artqte.Select
            b = 0
          Else
            If Pdxart.text Then Pdxart.Text = Format$((Val(Utils.cpoint(Artqte.Text)) * Val(Utils.cpoint(Pdx))), "0.000")
            'IF Artbarre = "0" THEN Button11.SetFocus
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 5
        If chkfocus <> 1 Then
          Artbrut_LF()
          Arttc_LF()
          If b = 1 Then
            Artbrut.SetFocus
            Artbrut.Select
          Endif
          Stop Event
        Endif
        If chkfocus <> 2 Then chkfocus = 0
        
      Case 6
        If chkfocus <> 1 Then
          Artrm_LF()
          If b = 1 Then
            Artrm.SetFocus
            Artrm.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 7
        If chkfocus <> 1 Then
          Artnet_LF()
          Arttc_LF()
          If b = 1 Then
            Artnet.SetFocus
            Artnet.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 8
        If chkfocus <> 1 Then
          Recup_Tva()
          Arttc_LF()
          Stop Event
        Endif
        chkfocus = 0
    End Select
  Endif
  
End

'**************************************
'* Gestion des actions  du panel Art  *
'**************************************

Public Sub Artpu_LF()
  
  With utils
    Artpu.Text = .CPoint(Artpu.Text)
    If Val(Artpu.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Val(Artpu.text) <> 0 Then
        Recup_Tva()
        tx = (1 + Ttva / 100)
        If sTTC.value = True Then 
          Arttc.Text = Artpu.Text
          Artpu.Text = Format$(Val(Utils.CPoint(Artpu.Text)) / Tx, "0.00")
        Else
          Arttc.Text = Format$(Val(Utils.CPoint(Artpu.Text)) * Tx, "0.00") 
        Endif
        Textlabel30.text = "Prix HT"
        Artpu.Text = Format$(Val(Artpu.Text), Ar$)
        Artqte_LF()
        b = 0
      Else
        Artrm.text = "0,00"
        Artpu.Text = "0,00"
        Artnet.Text = "0,00"
        Arttc.Text = "0,00"
      Endif
    Endif
    T = 0
  End With
  
End

Public Sub Artqte_LF()
  
  With utils
    Artqte.Text = .CPoint(Artqte.Text)
    If Val(Artqte.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Decimal()
      If InStr(Artqte.text, ",") = 1 Or If InStr(Artqte.text, ",") = 1 And dec.Text = "0" Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Vous ne pouvez pas saisir de décimales sur ce produit ! \n Si vous avez besoin de décimales veuillez modifier la case Décimale")
        b = 1
      Else
        If Colvente <> 0 And Val(Artqte.Text) >= Colvente Then Artpu.Text = Format$(Val(Utils.CPoint(PVHT2)), Ar$)
        If Val(Artbrut.Text) <> 0 Or If Val(Artpu.text) <> 0 Then
          Artbrut.Text = Artpu.Text
          If Apromo = False Then Remises_quantitatives()
          Decimal()
          Artbrut.Text = Format$(Val(.CPoint(Artpu.Text)) * Val(.CPoint(Artqte.Text)), Ar$)
          If Val(Artrm.text) <> 0 Then
            Try Artnet.Text = Format$(Val(.CPoint(Artbrut.Text)) - (Val(.CPoint(Artbrut.Text)) * Val(.CPoint(Artrm.Text)) / 100), Ar$)
          Else
            Artnet.Text = Format(Val(Artbrut.Text), Ar$)
          Endif
          b = 0
          T = 1
          'If tcli Then
          'Calcttc()
          'Else
          'Arttc.Text = Format$(Val(.CPoint(Arttc.Text)) * Val(.CPoint(Artqte.Text)), Ar$)
          'Arttc_LF()
          'Endif
          If Not tcli Then
            
          Endif
          Calcttc()
          Calc_Marge()
          If IsNull(Pdx) Then Pdx = "0,000"
          PdxArt.text = Format$((Val(Utils.cpoint(Artqte.Text)) * Val(Utils.cpoint(Pdx))), "0.000")
        Else
          Artrm.text = "0,00"
        Endif
      Endif
    Endif
  End With
  
End

'****************************************
'*        On récupère les remises       *
'****************************************
Public Sub Remises_quantitatives()
  
  Dim i As Integer
  
  With Utils
    'IF Val(Artrm.Text) = 0 THEN
    If IsNull(Remtype) Then Remtype = 0
    For i = 0 To Rms.Bounds[0] - 1
      If IsNull(Rms[i, 2]) Then
        'TRY Artrm.Text = Val(Artrm.Text) + RemType
        'IF ERROR THEN Artrm.Text = Val(Artrm.Text)
        Break
      Else
        If Val(Utils.cpoint(Artqte.Text)) >= Val(.Cpoint(rms[i, 0])) And Val(Utils.cpoint(Artqte.Text)) <= Val(.Cpoint(rms[i, 1])) Then
          Try Artrm.Text = Val(Txpieces.Text) + RemType + Val(.Cpoint(Rms[i, 2]))
          If Error Then Artrm.Text = Val(Artrm.Text)
          Break
        Endif
      Endif
    Next
    'ENDIF
    Artrm_LF()
  End With
  
End

Public Sub Artbrut_LF()
  
  With utils
    Artbrut.Text = .CPoint(Artbrut.Text)
    If Val(Artbrut.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Artbrut.Text = Format$(Val(Artbrut.Text), Ar$)
      If .CPoint(Artbrut.text) <> ChangeB Then
        chkfocus = 1
        If start.son Then
          Music.Play
        Endif
        If Val(Artbrut.Text) <> 0 And Val(Artpu.text) <> 0 Then
          If Not materiel Then
            If start.son Then
              Music.Play
            Endif
            If message.Question(" Vous venez de modifier le prix brut HT. Voulez-vous \n 1- Modifier la quantité \n 2- Modifier le prix unitaire ", " 1 ", " 2 ") = "1" Then
              Artqte.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artpu.Text)))
              Artqte.Text = .Cdec(Dec.Text, Artqte.Text)
              B = 0
            Else
              Artpu.Text = Format(Val(Artbrut.Text) / Val(Utils.cpoint(Artqte.Text)), Ar$)
              Calc_Marge()
              b = 0
            Endif
          Else
            Artpu.Text = Format(Val(Artbrut.Text) / Val(Utils.cpoint(Artqte.Text)), Ar$)
            Calc_Marge()
            b = 0
          Endif
          Artrm_LF()
        Endif
        If Val(Artbrut.Text) = 0 Then
          Artrm.text = "0,00"
          Artpu.Text = "0,00"
          Artnet.Text = "0,00"
          Arttc.Text = "0,00"
        Endif
      Endif
    Endif
  End With
Catch
  
End

Public Sub Artrm_LF()
  
  With utils
    If Artrm.Text = "N" Or Artrm.Text = "n" Then
      Artrm.text = "0,00"
      bNet = True
      'Balloon.Warning(("La mention 'Net' apparaitra sur la facture"), Artrm)
      ArtNet.Text = Format$(Val(.CPoint(Artbrut.Text)), Ar$)
      ChangeP = ArtNet.Text
      Recup_Tva()
      Arttc.Text = Val(Utils.CPoint(Artnet.Text)) + (Val(Utils.CPoint(Artnet.Text)) * Ttva / 100)
      If Apromo = False Then arrondi()
    Endif
    If Val(Artrm.text) <> 0 Then bNet = False
    If bNet = False Then
      If Retro.value = False Then
        If IsNull(Artrm.Text) Then 
          Artrm.Text = "0,00"
        Endif
        Artrm.Text = .CPoint(Artrm.Text)
        If Val(Artrm.Text) = Null Then
          If chkfocus <> 1 Then
            If start.son Then
              Music.Play
            Endif
            Try message.Warning("Veuillez verifier votre saisie SVP !")
            b = 1
          Endif
        Else
          If Bdevis.Value = False
            If apromo = True Then
              If modif = "1" Then Balloon.Warning((" Remise impossible, article en promotion"), Artrm)
              Artrm.Text = "0,00"
            Endif
          Endif
          If Val(Artrm.text) <= 100 Then
            Artrm.Text = Format$(Val(Artrm.Text), "0.00")
            Try ArtNet.Text = Format$(Val(.CPoint(Artbrut.Text)) - (Val(.CPoint(Artbrut.Text)) * Val(.CPoint(Artrm.Text)) / 100), Ar$)
            b = 0
            Calcttc()
            Calc_Marge()
          Else
            b = 1
            If start.son Then
              Music.Play
            Endif
            Try message.Warning("Saisie impossible ! Vous avez une remise supérieure 100 %", "OK")
          Endif
        Endif
      Else
        If Val(Artrm.text) <> 0 Then
          Balloon.Warning((" Remise impossible en saisie de document rétrocession !"), Artrm)
          Artrm.Text = "0,00"
          'ArtNet.Text = Artpu.Text
        Else
          ArtNet.Text = Artpu.Text
        Endif
      Endif
    Else
      b = 0
    Endif
  End With
  T = 1
  
End

Public Sub Artnet_GF()
  
  With utils
    If Not IsNull(artnet.Text) Then
      Artnet.Text = .CPoint(Artnet.Text)
      Artrm.Text = .CPoint(Artrm.Text)
      If Val(Artrm.Text) = Null Then
        If chkfocus <> 1 Then
          If start.son Then
            Music.Play
          Endif
          Try message.Warning("Veuillez verifier votre saisie SVP !")
          b = 1
        Endif
      Else
        Artrm.Text = Format$(Val(Artrm.Text), "0.00")
        Artnet.Text = Format$(Val(Artnet.Text), Ar$)
        ChangeP = .CPoint(Artnet.Text)
        b = 0
      Endif
    Endif
  End With
  
End

Public Sub Artnet_LF()
  
  Dim Msg As String
  
  With utils
    b = 0
    Artnet.Text = .CPoint(Artnet.Text)
    If Val(Artnet.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Val(Artnet.Text) = 0 And Val(Artrm.text) <> 100 Then
        Artrm.text = "0,00"
        If Val(Artqte.Text) <> 0 Then Artpu.Text = "0,00"
        Artbrut.Text = "0,00"
        Artnet.Text = "0,00"
        Arttc.Text = "0,00"
      Else
        If Val(Artnet.Text) < Val(.cpoint(Paht)) * Val(Utils.cpoint(Artqte.Text)) And Val(Artrm.text) <> 100 And Val(Artqte.text) > 0 Then
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Votre prix de vente est inférieur au Prix d'achat !")
          b = 1
          Artnet.SetFocus
          Artnet.Select
        Else
          Artnet.Text = Format$(Val(Artnet.Text), Ar$)
          If Utils.CPoint(Artnet.Text) <> ChangeP Then
            chkfocus = 1
            'Artrm.Text = "0,00"
            If start.son Then
              Music.Play
            Endif
            If Bdevis.Value = False Then
              If apromo = True Then T = 1
            Endif
            If T = 1 Then
              ' Msg = " Le produit est arrondi au : " & arr & " " & devises & "\n le prix net HT à été recalculé. Voulez-vous \n 1- Modifier la remise \n 2- Modifier le prix Brut et le prix unitaire "
              If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
                Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Ar$)
              Else
                Artbrut.Text = Format$(Val(Artnet.Text), Ar$)
              Endif
              Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Ar$)
            Else
              Msg = " Le produit est arrondi au : " & arr & " " & devises & "\n Vous venez de modifier le prix net HT. Voulez-vous \n 1- Modifier le prix Brut et le prix unitaire \n 2- Modifier la remise "
              If start.son Then
                Music.Play
              Endif
              If message.Question(Msg, " 1 ", " 2 ") = "2" Then
                Artrm.Text = Format(Val(.CPoint(Artbrut.Text)) - Val(.CPoint(Artnet.Text)), "0.00")
                Try Artrm.Text = Format$((Val(.CPoint(Artrm.Text)) * 100) / Val(.CPoint(Artbrut.Text)), "0.00")
                Calcttc()
              Else
                'Balloon.Warning((" Le produit est arrondi au : " & arr & " " & devises & "\n le prix net HT à été recalculé."), Artnet)
                If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
                  Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Ar$)
                Else
                  Artbrut.Text = Format$(Val(Artnet.Text), Ar$)
                Endif
                Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Ar$)
              Endif
            Endif
            b = 0
            Calcttc()
            tx = (1 + Ttva / 100)
            If retro.value = False Then Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, ar$)
            If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
              Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Ar$)
            Else
              Artbrut.Text = Format$(Val(Artnet.Text), Ar$)
            Endif
            Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Ar$)
            'Calc_Marge()
          Endif
          b = 0
        Endif
        If Val(Artrm.text) > 100 Then
          b = 1
          If start.son Then
            Music.Play
          Endif
          Try message.Warning("Saisie impossible ! Vous avez une remise supérieure à 100 %", "OK")
        Endif
        'If Prxdec Then
        'Artpu.text = Round(Val(Artpu.Text))
        'Artnet.text = Round(Val(Artnet.text))
        'Artbrut.Text = Round(Val(Artbrut.Text))
        'Arttc.Text = Round(Val(Arttc.text))
        'Endif
      Endif
    Endif
  End With
  
End

Public Sub Arttc_LF()
  
  ChangeP = Utils.CPoint(Artnet.Text)
  Arttc.Text = Utils.Cpoint(Arttc.Text)
  If Val(Arttc.Text) = Null Then
    If chkfocus <> 1 Then
      If start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Endif
  Else
    tx = (1 + Ttva / 100)
    If retro.value = False Then Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, ar$)
    If b <> 1 Then
      Artnet_LF()
      Calc_Marge()
    Endif
  Endif
  
End

Public Sub Art_GotFocus()
  
  With Utils
    '  .SetEditColor(Me, Last)
    Try Utils.ObsGotf(Last)
  End With
  Cdfam.Background = &HD4D0C8&
  Nlg.Background = &HD4D0C8&
  If Qte.Text Then
    If Val(Qte.Text) <= 0 Then
      Qte.Background = &D47C0A&
    Else
      Qte.Background = &HD4D0C8&
    Endif
  Endif
  If Val(Utils.cpoint(Marge.Text)) < 0 Then
    Marge.Background = &HEF3E1A&
  Else
    Marge.Background = &HD4D0C8&
  Endif
  Select Case Last.Tag
    Case 1
      'If sTTC.Value Then
      'Textlabel30.text = "Prix TTC"
      'Else
      'Textlabel30.text = "Prix HT" 
      'Endif
    Case 2
      If Not IsNull($photo) Or If Not IsNull($crst) Then Artdsg.Background = &h00CAE8CA&
      
    Case 3
      ChgArt()
    Case 4
      If Materiel And Artqte.ReadOnly = True Then
        Balloon.Warning(("Vous ne pouvez pas modifier la quantité pour un matériel"), Artqte)
        Button11.SetFocus
      Endif
      If Not IsNull($UV) And If Val($UV) > 0 Then
        ArtQte.ToolTip = "Unité d'emballage à la vente : " & $UV
      Else
        'ArtQte.ToolTip = ""
      Endif
    Case 5
      ChgArt()
      Stop Event
    Case 6
      ChgArt()
      Stop Event
    Case 7
      ChgArt()
      Stop Event
    Case 8
      ChgArt()
      Stop Event
  End Select
  
End

Public Sub ChgArt()
  
  With Utils
    Changepu = .CPoint(Artpu.Text)
    Changeb = .CPoint(ArtBrut.Text)
    Changer = .CPoint(ArtRm.Text)
    Changep = .CPoint(ArtNet.Text)
    Changet = .CPoint(arttc.Text)
  End With
  
End

Public Sub ToggleButton3_Click()
  
  chkfocus = "1"
  SelectionArt()
  
End

Public Sub ArtFour_KeyPress()
  
  If Key.code = Key.F4 Then FFournisseur.ShowModal()
  If Key.code = Key.Enter Then 
    FourMan()
  Endif
  
End

'********************************************
'* Saisie d'un fournisseur manuellement     *
'********************************************
Public Sub fourman()
  
  Dim Rfours As Result
  
  Tab = "Fiches_Four" 
  Rfours = Utils.db.Exec("SELECT * FROM " & tab & " WHERE fo_code = &1", ArtFour.Text)
  If Rfours.Available Then
    Artpu.SetFocus
  Else
    If Start.son Then Music.Play
    Message.Warning("Ce fournisseur n'existe pas !")
  Endif
  
End

Public Sub ToggleButton6_MouseUp()
  
  If Mouse.Right Then
    If TextLabel41.Text = "Famille" Then 
      TextLabel41.Text = "Fournisseur"
      ArtFour.Visible = True 
      ArtFour.Text = Coldetail.current[20]
      If Not IsNull(ArtFour.Text) Then Frm12()
    Else
      TextLabel41.Text = "Famille" 
      ArtFour.Visible = False
      Frame4.Visible = False
    Endif
  Else
    If TextLabel41.Text = "Famille" Then
      SelectionFam()
    Else
      SelectionFour()
    Endif
  Endif
  
End

Public Sub SelectionFour()
  
  Dim MyForm As Trifours
  
  Variables.bsel = False
  MyForm = New Trifours("Commande")
  MyForm.Showmodal()
  If Variables.Bsel = True Then
    ArtFour.Text = Variables.Cfour
    Frame4.Visible = True
    Frm12()
  Endif  
  
End

'On mouvemente la frame du fournisseur
Public Sub Frm12()
  
  Dim hresult As Result
  
  hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFour") & " left join " & Cbase.Table("TabEch") & " on num = fo_cdech where fo_code = &1", ArtFour.Text)
  If hresult.Available Then
    NtcdClient.Text = hresult!fo_cd_cli
    Cdech.Text = hresult!fo_cdech
    Try Franco.Text = Format$(hresult!fo_franco, "0.00")
    Try MinCom.Text = Format$(hresult!fo_mincom, "0.00")
    If Not Franco.Text Then Franco.Text = "0,00"
    Try exo2.Value = hresult!fo_exo
    obs.Text = hresult!fo_obs
    Fport.Text = hresult!fo_fport
    If Not Fport.Text Then Fport.Text = "0,00"
    Label12.text = hresult!libell
    Frame4.text = hresult!fo_code & " " & hresult!fo_nom
    Frame4.visible = True
    Artqte.SetFocus
  Else
    If TextLabel41.Text = "Famille" Then 
      Artfam.SetFocus
    Else
      ArtFour.SetFocus
    Endif
  Endif
  
End

'*********************************
'* On enregistre le produit      *
'*********************************
Public Sub Button11_Keypress()
  
  'Dsg1.SetFocus
  ' Dsg2.SetFocus 'sert à gerer la perte de focus
  If Key.code = 66 Then 'B
    Artbrut.SetFocus
    Artbrut.Select
  Endif
  If Key.code = 68 Then 'D
    Dec.SetFocus
    Dec.Select
  Endif
  If Key.code = 72 Then 'H
    ArtNet.SetFocus
    ArtNet.Select
  Endif
  If Key.code = 81 Then 'Q
    Artqte.SetFocus
    Artqte.Select
  Endif
  If Key.code = 80 Then 'P
    Artpu.SetFocus
    Artpu.Select
    If sTTC.Value Then
      Textlabel30.text = "Prix TTC"
      Artpu.text = Arttc.Text
    Else
      Textlabel30.text = "Prix HT" 
    Endif
  Endif
  If Key.code = 82 Then 'R
    Artrm.SetFocus
    Artrm.Select
  Endif
  If Key.code = 84 Then 'T
    Arttc.SetFocus
    Arttc.Select
  Endif
  If Key.code = 76 Then 'L
    Artdsg.SetFocus
    Artdsg.Select
  Endif
  If Key.code = Key.F8 Then
    Achat.visible = True
    Achat.SetFocus
    Achat.Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Button11_Click()
    Stop Event
  Endif
  
End

'****************************************************************
'* On mouvemente le panel Coldetail apres validation du produit *
'****************************************************************
'Public Sub Button11_Click()

' Dsg2.SetFocus 'sert à gerer la perte de focus
'Dsg2_GF()
'Stop Event

'End

'*********************************
'* On enregistre le produit      *
'*********************************
Public Sub Button11_Click()
  
  If b = 1 Then
    Cart.SetFocus
    Cart.Select
    b = 0
  Else
    If Cart.Text <> "" Then
      If Val(Artpu.text) = 0 Then
        If start.son Then
          Music.Play
        Endif
        If Message.Question("Le prix de ce produit est égal à  zéro !\n Confirmez-vous votre saisie ? ", "Oui", "Non") = 1 Then
          MajColdetailArt()
        Endif
      Else
        MajColdetailArt()
      Endif
      If Panel7.Visible = False Then
        Cart.SetFocus
        Cart.Select
      Endif
    Else
      If typeL = "E" Or typeL = "P" Then
        MajColdetailEco()
      Endif
    Endif
  Endif
  
End

Public Sub MajColdetailArt()
  
  Dim DecMat As String = ""
  
  Frame4.Visible = False
  Nvart = "0"
  Codeart = "0"
  Artdsg.Text = Utils.Remplace(Artdsg.Text)
  Produit = Cart.text
  Mnetht = artnet.Text
  Mnettc = Arttc.Text
  DecMat = Dec.Text
  Blocnum = Nlgart.text & Cart.text & Round(Rnd(1000, 9999))
  If Not Prxdec Then
    Mrg.Text = Format$(Val(Utils.cpoint(Mrg.text)) + Val(Utils.cpoint(Marge.text)), ar$)
  Else
    Mrg.Text = Format$(Val(Utils.cpoint(Mrg.text)) + Val(Utils.cpoint(Marge.text)), ar$) 
  Endif
  Mrgart = Mrgart + Val(Utils.cpoint(Marge.text))
  If Materiel And Gmateriel Then
    If Bbon.Value = True Or If Bfac.Value = True Then
      Majnumserie = 0
      Numligbl2 = Num.Text
      Bloc = Blocnum
      Num_serie()
      Numero.SetFocus
    Else
      If Modif = "0" Then
        Enrg_Art()
        Nlgmodif = Format$(Val(Coldetail.current[0]) + 1, "0000")
        Coldetail.Add(NlgModif, NlgModif)
        Coldetail.item[1] = Produit
        Coldetail.item[2] = "Numéro de série non attribué"
        Coldetail.item[9] = "T"
        Coldetail.item[14] = Dec.text
        Coldetail.item[16] = Blocnum
      Endif
      ' Enrg_Art()
      Maj_Base()
      Bloc = ""
      init()
    Endif
  Else
    Enrg_Art()
    Bloc = ""
  Endif
  
End

Public Sub Enrg_Art()
  
  Dim lg As Integer = 1
  Dim sline As String
  
  If Coldetail.Count <> 0 And Settings["/Soc" & Start.Societe & "/Cqte"] <> "0" And Val(Utils.cpoint(Artqte.Text)) >= 0 Or If modif = "1" Then
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    Coldetail.MoveFirst
    Repeat
      Coldetail.item.Selected = True
      If modif = "1" And Coldetail.current[0] = NlgModif Or If Coldetail.current[1] = Cart.Text And modif = "0" And Val(Utils.cpoint(Artqte.Text)) >= 0 And Left$(Coldetail.current[4], 1) <> "-" Then
        If Modif <> "1" Then
          Artqte.Text = Val(Coldetail.current[4]) + Val(Utils.cpoint(Artqte.Text))
          Decimal()
          Artqte_LF()
          PdxArt.text = Format$(Val(Utils.cpoint(Pdx)) * Val(Utils.cpoint(Artqte.Text)), "0.000")
        Else
          Artqte.Text = Val(Utils.cpoint(Artqte.Text))
          Decimal()
          PdxArt.text = Format$(Val(Utils.cpoint(Pdx)) * Val(Utils.cpoint(Artqte.Text)), "0.000")
        Endif
        Coldetail.current[4] = Artqte.Text
        If Len(Artnet.text) - InStr(Artnet.text, ",") = 2 Then Coldetail.current[7] = Artnet.text & "  "
        Qteecot = Val(Utils.cpoint(Artqte.Text))
        If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
        Nlgart.Text = Coldetail.current[0]
        Codeart = Nlgart.Text
        Bloc = Coldetail.current[16]
        Enrg_Ligart()
        Cart.SetFocus
        Cart.Select
        Nvart = "1"
        Stop Event
        Break
      Endif
    Until Coldetail.MoveNext()
  Endif
  If Nvart = "0" And modif <> "1" Or If Settings["/Soc" & Start.Societe & "/Cqte"] = "0" And modif <> "1" Then
    If T = 0 Then Artqte_LF()
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    If N = 1 Then Coldetail.Add(Nlgart.text, Nlgart.text)
    Coldetail.Item.Selected = True
    Coldetail.item[0] = Nlgart.text
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    Coldetail.item[1] = Cart.text
    Coldetail.item[2] = Artdsg.text
    If Len(Artpu.text) - InStr(Artpu.text, ",") = 2 Then Coldetail.item[3] = Artpu.text & "  "
    Coldetail.item[4] = Artqte.text
    Qteecot = Val(Utils.cpoint(Artqte.Text))
    If Len(Artbrut.text) - InStr(Artbrut.text, ",") = 2 Then Coldetail.item[5] = Artbrut.text & "  "
    If bNet = True Then
      Coldetail.item[6] = "Net"
    Else
      Coldetail.item[6] = Artrm.text
    Endif
    If Len(Artnet.text) - InStr(Artnet.text, ",") = 2 Then Coldetail.item[7] = Artnet.text & "  "
    Coldetail.item[9] = typeL
    If Len(Arttc.text) - InStr(Arttc.text, ",") = 2 Then Coldetail.item[8] = Arttc.text & "  "
    Coldetail.item[12] = Arttx.text
    Coldetail.item[13] = ArtFam.text
    Coldetail.item[20] = ArtFour.text
    Coldetail.item[14] = Dec.text
    Bloc = Nlgart.text & Cart.text & Round(Rnd(1000, 9999))
    Coldetail.item[16] = Bloc
    Coldetail.item[17] = PdxArt.text
    'Bloc = Nlgart.text & Cart.text & Round(Rnd(1000, 9999))
    If Pdc = True Then Codeart = cart.Text ' on recupere le code article
    Enrg_Ligart()
    Cart.SetFocus
    Cart.Select
    If artdsg2 And Modif <> "1" Then
      Coldetail.MoveLast()
      Try Coldetail.item.Selected = True
      If Not Error Then
        Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
        Coldetail.Add(Nlgart.text, Nlgart.text)
        Coldetail.item[2] = Artdsg2
        Coldetail.item[9] = typeL
        Coldetail.item[14] = Dec.text
        Coldetail.item[16] = Bloc
        Enrg_Ligart2()
      Endif
    Endif
    If Impcar = True And Modif <> "1" Then
      Coldetail.MoveLast()
      Try Coldetail.item.Selected = True
      If Not Error Then
        Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
        For Each sline In Split(Intit, "\n")
          Coldetail.Add(Nlgart.text & Lg, Nlgart.text & Lg)
          Coldetail.item[0] = Nlgart.text
          Coldetail.item[2] = sline
          Coldetail.item[9] = "R"
          Coldetail.item[16] = Bloc
          Inc lg
        Next
        Enrg_Ligcar()
      Endif
    Endif
    If Bdevis.Value = False Then
      If apromo = True Then
        Coldetail.MoveLast()
        Try Coldetail.item.Selected = True
        If Not Error Then
          Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
          Coldetail.Add(Nlgart.text, Nlgart.text)
          Coldetail.item[2] = "*** Article " & Cart.text & " en promotion ***"
          Coldetail.item[9] = "T"
          Coldetail.item[14] = Dec.text
          Coldetail.item[16] = Bloc
          Enrg_Promo()
        Endif
      Endif
    Endif
  Endif
  If ecotaxe Then Ecot()
  If ecotaxe2 And Pays = "France" Then Ecot2()
  If Taxepv Then Txpp()
  If Nvart = "0" And modif <> "1" Or If Settings["/Soc" & Start.Societe & "/Cqte"] = "0" And modif <> "1" And Pdc = True Then Recup_Pdc()
  Numligbl2 = Num.Text
  init()
  Majnumserie = 1
  Intit = ""
  If Not Settings["/Soc" & Start.Societe & "/Afour"] Then
    TextLabel41.Text = "Famille" 
    ArtFour.Visible = False
    Frame4.Visible = False
  Endif
  Artdsg.Background = Color.TextBackground
  
End

Public Sub init()
  
  Cleanart()
  BArt_Click()
  N = 1
  Nvart = "1"
  Artqte.Text = "1,00"
  Dec.Text = "2"
  modif = "0"
  Artqte.ReadOnly = False
  If sFacht.value = False Then
    sTTC.Value = False
    Textlabel30.text = "Prix HT"
  Else
    sTTC.Value = True
    Textlabel30.text = "Prix HT"
  Endif
  
End

'******************Gestion des produits composés**********************************

Public Sub Recup_Pdc()
  
  Dim prArt As Result
  Dim rArtprdc As Result
  Dim s As String
  Dim spl As New String[]
  Dim compteur As Integer
  Dim Cpdc As String ' code du produit
  Dim Lpdc As String ' libellé du produit
  Dim Qpdc As String ' quantité du produit
  Dim lg As Integer = 0
  
  prArt = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabPrdComp") & " where codep = &1", Codeart)
  If prArt.Available Then
    Repeat
      spl.Add(prArt!codec & ";" & prArt!libelle & ";" & prArt!qte)
    Until prart.MoveNext()
    Coldetail.MoveLast()
    Try Coldetail.item.Selected = True
    If Not Error Then
      For compteur = 0 To prArt.count - 1
        For Each s In Split(spl[compteur], ";")
          Inc lg
          Select Case lg
            Case 1
              Cpdc = s
            Case 2
              Lpdc = s
            Case 3
              Qpdc = s
          End Select
        Next
        Coldetail.Add(Nlgart.text, Nlgart.text)
        Coldetail.item[0] = Nlgart.text
        Coldetail.item[1] = Cpdc
        Coldetail.item[2] = Lpdc
        Coldetail.item[4] = Qpdc
        Coldetail.item[9] = "O"
        Coldetail.item[14] = Dec.text
        Coldetail.item[16] = Bloc
        Enrg_Pdc(Cpdc, Lpdc, qpdc)
        lg = 0
        Nlgart.Text = Format$(Val(Nlgart.text) + 1, "0000")
        Rartprdc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", cpdc)
        qteecot = Val(Utils.cpoint(Qpdc))
        Ecotaxe = Rartprdc!art_ect
        If Rartprdc!art_eco Then
          Try Valeur_Ecotaxe = Rartprdc!art_eco
        Endif
        Ecotaxe2 = Rartprdc!art_ect2
        If Rartprdc!art_eco2 Then
          Try Valeur_Ecotaxe2 = Rartprdc!art_eco2
        Endif
        Taxepv = Rartprdc!art_cpp
        If Rartprdc!art_copp Then
          Try Valeur_Copp = Rartprdc!art_copp
        Endif
        If ecotaxe Then Ecot()
        If Taxepv Then Txpp()
      Next
    Endif
    Coldetail.Clear
    Recup_ligbl()
  Endif
  
End

'******************Gestion des numéros de série**********************************

'****************************
'*      Gestion du focus.   *
'****************************
Public Sub Rcpt_GotFocus()
  
  Try Utils.ObsGotf(Last)
  
End

Public Sub Rcpt_LostFocus()
  
  Utils.ObsLstf(Last)
  
End

'*******************************************
'*      On saisit les numéros de série     *
'*******************************************
Public Sub Num_serie()
  
  Panel7.Visible = True
  Label7.Text = "Saisie du numéro de série"
  numero.SetFocus
  
End

'**********************************************************
'*      Gestion des touches sur le panel Numserie         *
'**********************************************************
Public Sub Rcpt_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    
    Select Case Last.tag
        
      Case 15
        Button9.SetFocus
        Stop Event
        
    End Select
  Endif
  
End

'****************************************************
'*     On appelle la liste des numéros de série     *
'****************************************************

Public Sub ToggleButton9_Click()
  
  If Numslist.visible Then
    Numslist.clear
    Numslist.visible = False
  Else
    Numslist.visible = True
    Numslist.Columns.count = 3
    Numslist.Columns[0].Width = 120
    Numslist.Columns[1].Width = 100
    Numslist.Columns[1].Width = 180
    Numslist.Columns[0].Text = "Code"
    Numslist.Columns[1].Text = "Numero"
    Numslist.Columns[2].Text = "Intitulé"
    rMat = Utils.db.Exec("SELECT * FROM " & Tmat & " where mat_vendu = &1 and mat_code = &2 order by mat_code", 0, Produit)
    If rMat.Available Then
      Do
        Numslist.Add(rMat!mat_serie & rMat!mat_code, rMat!mat_serie)
        Numslist.item[0] = rMat!mat_code
        Numslist.item[1] = rMat!mat_serie
        Numslist.item[2] = rMat!mat_design
      Loop Until rMat.MoveNext()
      Numslist.MoveFirst
      Numslist.SetFocus
      Numslist.item.Selected = True
    Endif
  Endif
  
End

'**************************************************
'* Selection d'un numéro de série a la souris     *
'**************************************************
Public Sub NumsList_Click()
  
  Numero.text = NumsList.current[1]
  NumsList.clear
  NumsList.visible = False
  Numero.SetFocus
  Numero.Select
  
End

'***************************************************
'* Selection d'un numero de série manuellement     *
'***************************************************
Public Sub NumsList_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    NumsList_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    NumsList.visible = False
    NumsList.clear
    Numero.SetFocus
    Stop Event
  Endif
  
End

'*******************************************
'*        On enregistre le materiel        *
'*******************************************
Public Sub Button22_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Then Button22_Click()
  
End

'**************************************************
'*    On verifie si le numero de série existe     *
'**************************************************
Public Sub Button22_Click()
  
  If Not IsNull(numero.text) Then
    rmat = Utils.db.Exec("SELECT * FROM " & Tmat & " where mat_code = &1 and mat_serie = &2", Produit, numero.text)
    If Not rmat.Available Then
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Attention ! Ce numéro de série n'existe pas.")
      Numero.SetFocus
      Numero.clear
    Else
      Enrg_Numserie()
      Numero.Clear
      Panel7.Visible = False
    Endif
  Endif
  
End

'*************************************************************
'* On met à jour le materiel dans la table des materiels     *
'*************************************************************
Public Sub Enrgnum()
  
  Dim garantie As Boolean
  
  rmat = Utils.db.Exec("SELECT * FROM " & Tmat & " where mat_code = &1 and mat_serie = &2", Produit, Numero.Text)
  If rmat.Available Then
    garantie = rmat!mat_chkgarantie
    If garantie Then
      Utils.db.Exec("UPdate  " & Tmat & "  SET mat_qte = &1, mat_vendu = &2, mat_bl = &5, mat_pvht = &6, mat_pvttc = &7, mat_cli = &8, mat_dtevte = &9, mat_dateg1  = &9, mat_chkgarantie = &{10} WHERE mat_code = &3 and mat_serie = &4", 0, 1, Produit, Numero.text, numligbl2, Val(Mnetht), Val(MNettc), code.Text, Utils.Cdate_Dbase(datej.Text), garantie)
    Else
      Utils.db.Exec("UPdate  " & Tmat & "  SET mat_qte = &1, mat_vendu = &2, mat_bl = &5, mat_pvht = &6, mat_pvttc = &7, mat_cli = &8 WHERE mat_code = &3 and mat_serie = &4", 0, 1, Produit, Numero.text, numligbl2, Val(Mnetht), Val(MNettc), code.Text)
    Endif
  Endif
  
End

'* On enregistre la ligne du numéro de série.
Public Sub Enrg_Numserie()
  
  Dim maj_serie As Boolean = True
  
  Tab = "Fiches_Ligbl"
  Blocnum = Bloc
  With Utils
    If Modif = "0" Then
      Enrg_Art()
      Coldetail.MoveLast()
      Coldetail.item.Selected = True
      Nlgmodif = Format$(Val(Coldetail.item[0]) + 1, "0000")
      Coldetail.Add(NlgModif, NlgModif)
      Coldetail.item[1] = Numero.Text
      Coldetail.item[2] = "Numéro de série " & Numero.Text
      Coldetail.item[9] = "T"
      Coldetail.item[14] = Dec.text
      Coldetail.item[16] = Bloc
    Else
      Coldetail.MoveFirst()
      Repeat
        If Coldetail.item[16] = Blocnum And Coldetail.item[9] = "T" And Left$(Coldetail.item[2], 17) = "Numéro de série" Then
          Coldetail.item[1] = Numero.Text
          Coldetail.item[2] = "Numéro de série " & Numero.Text
          maj_serie = False
        Else
          If maj_serie = True Then
            If Coldetail.item[16] = Blocnum And Coldetail.item[9] = "T" And Left$(Coldetail.item[2], 17) = "Numéro de série" Then
              Coldetail.MoveLast()
              Try Coldetail.item.Selected = True
              Nlgmodif = Format$(Val(Coldetail.item[0]) + 1, "0000")
              Coldetail.Add(NlgModif, NlgModif)
              Coldetail.item[1] = Numero.Text
              Coldetail.item[2] = "Numéro de série " & Numero.Text
              Coldetail.item[9] = "T"
              Coldetail.item[14] = Dec.text
              Coldetail.item[16] = Bloc
            Endif
          Endif
        Endif
      Until Coldetail.MoveNext()
      Enrg_Art()
      Maj_Base()
      'Enrg_Art()
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, NlgModif)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , libel_ligbl = &3, typel_ligbl = &4, code_ligbl = &5 WHERE num_ligbl = &1 and numlig_ligbl = &2", numligbl2, NlgModif, "Numéro de série " & Numero.Text, "T", Blocnum, Numero.Text)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, libel_ligbl, typel_ligbl, block_ligbl, code_ligbl) VALUES (&1, &2, &3, &4, &5, &6)", numligbl2, NlgModif, "Numéro de série " & Numero.Text, "T", Blocnum, Numero.text)
    Endif
    Enrgnum()
    'Enrg_Art()
    Majnumserie = 0
    Ren_ligbl()
    Maj_Base()
    Init()
  End With
  
End

'*******************************************
'*   On ferme la saisie du materiel        *
'*******************************************
Public Sub Button23_Click()
  
  If start.son Then
    Music.Play
  Endif
  If Message.Question("Attention ! Vous n'avez pas saisi le numéro de série. Voulez-vous quand même fermer ?", "Oui", "Non") = 1 Then
    numero.Clear
    Panel7.Visible = False
    Majnumserie = 0
  Endif
  
End

'*****************************************Fin de la gestion des numéros de série************************************

'**********************************************************
'*                 Gestion onglet Saisie Famille         *
'**********************************************************
Public Sub SelectionFam()
  
  Tab = "Fiches_Fam"
  ColFam.Clear
  If Colmo.Visible Then
    Colmo.Clear
    Colmo.Visible = False
    HBox8.Visible = False
  Endif
  If Colcom.Visible Then
    Colcom.Clear
    Colcom.Visible = False
  Endif
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Else
    ColFam.Visible = True
    With ColFam
      .Columns.count = 3
      .Columns[0].Width = 70
      .Columns[1].Width = 160
      .Columns[2].Width = 60
      .Columns[0].Text = "Code"
      .Columns[1].Text = "Intitulé"
      .Columns[2].Text = "Code Tva"
    End With
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by code_fam")
    If rResult.Available Then
      Repeat
        With utils
          ColFam.Add(rResult!code_fam, rResult!code_fam)
          ColFam.item[0] = rResult!code_fam
          ColFam.item[1] = rResult!libell_fam
          ColFam.item[2] = rResult!cdtva_fam
        End With
      Until rResult.MoveNext()
    Else
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Il n'existe aucune famille\n veuillez d'abord créer vos familles SVP ! ")
      ColFam.Clear
      ColFam.visible = False
    Endif
    If ColFam.Count Then
      ColFam.MoveFirst
      ColFam.SetFocus
      ColFam.item.Selected = True
    Endif
  Endif
  
End

'****************************************
'* On Selectionne la famille saisie     *
'****************************************
Public Sub fam_man()
  
  Dim Rarts As Result
  
  Tab = "Fiches_Fam"
  With utils
    Rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where code_fam = &1", Artfam.Text)
    If Rarts.Available Then
      Artfam.Text = Rarts!code_fam
      Arttx.text = Rarts!cdtva_fam
      Try Calcttc()
    Else
      If start.son Then
        Music.Play
      Endif
      Try message.Warning(" La famille " & Artfam.Text & " n'existe pas ! ")
      Artfam.SetFocus
      Artfam.clear
    Endif
  End With
  
End

'********************************************
'*  Saisie d'une famille a la souris        *
'********************************************
Public Sub Colfam_Click()
  
  Tab = "Fiches_Fam"
  Artfam.Text = ColFam.current[0]
  fam_Man()
  ColFam.Clear
  ColFam.visible = False
  
End

'*******************************************
'* Saisie d'une famille manuellement       *
'*******************************************
Public Sub Colfam_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Artfam.Text = ColFam.current[0]
    Colfam_Click()
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    ColFam.visible = False
    ColFam.clear
    Artfam.Select
    Artfam.SetFocus
    Stop Event
  Endif
  
End

'*******************************************
'*       Gestion de l'eco taxe  DEE        *
'*******************************************
Public Sub Ecot()
  
  Dim Ect As String
  
  With Utils
    Artqte.Text = qteecot
    Decimal()
    Ect = "0"
    If Val(Artrm.Text) <> 100 Then
      Artrm.Text = "0,00"
      If Modif = "1" Then
        Ect = "1"
        Coldetail.MoveFirst()
        Repeat
          Coldetail.item.Selected = True
          If Coldetail.current[16] = Bloc And Coldetail.current[9] = "E" Then
            Coldetail.current[4] = Artqte.Text
            Coldetail.current[5] = Format$(Val(Coldetail.current[3]) * Val(Coldetail.current[4]), Ar$)
            If Len(Coldetail.current[5]) - InStr(Coldetail.current[5], ",") = 2 Then Coldetail.current[5] = Coldetail.current[5] & "  "
            Coldetail.current[7] = Coldetail.current[5]
            Ect = "1"
            N = 1
            Nlgart.Text = Format$(Coldetail.current[0], "0000")
            Artdsg.Text = "Eco-participation DEE"
            Artpu.text = Coldetail.current[3]
            Artbrut.Text = Coldetail.current[5]
            Artnet.Text = Coldetail.current[7]
            Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
            If Prxdec Then
              Artpu.Text = Format$(Val(.CPoint(Artpu.Text)), "0")
              Artbrut.Text = Format$(Val(.CPoint(Artbrut.Text)), "0")
              Artnet.Text = Format$(Val(.CPoint(Artnet.Text)), "0")
              Arttc.Text = Format$(Val(.CPoint(Arttc.Text)), "0")
            Endif
            typeL = "E"
            Enrg_Ligart()
            Cart.SetFocus
            Cart.Select
            Cleanart()
            BArt_Click()
            N = 1
            Break
          Endif
        Until Coldetail.MoveNext()
      Endif
      If Ect <> "1" Then
        Coldetail.MoveLast()
        Coldetail.item.Selected = True
        Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
        Artdsg.Text = "Eco-participation DEE"
        Artpu.text = Format$(Valeur_Ecotaxe, Ar$)
        Artbrut.Text = Artpu.Text
        Artnet.Text = Format$(Valeur_Ecotaxe * Val(.CPoint(Artqte.Text)), Ar$)
        Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
        If Prxdec Then
          Artpu.Text = Format$(Val(.CPoint(Artpu.Text)), "0")
          Artbrut.Text = Format$(Val(.CPoint(Artbrut.Text)), "0")
          Artnet.Text = Format$(Val(.CPoint(Artnet.Text)), "0")
          Arttc.Text = Format$(Val(.CPoint(Arttc.Text)), "0")
        Endif
        typeL = "E"
        N = 1
        MajColdetailEco()
        Ect = "0"
      Endif
    Endif
  End With
  
End

'*******************************************
'*       Gestion de l'eco taxe  DEA        *
'*******************************************
Public Sub Ecot2()
  
  Dim Ect As String
  
  With Utils
    Artqte.Text = qteecot
    Decimal()
    Ect = "0"
    If Val(Artrm.Text) <> 100 Then
      Artrm.Text = "0,00"
      If Modif = "1" Then
        Ect = "1"
        Coldetail.MoveFirst()
        Repeat
          Coldetail.item.Selected = True
          If Coldetail.current[16] = Bloc And Coldetail.current[9] = "E" Then
            Coldetail.current[4] = Artqte.Text
            Coldetail.current[5] = Format$(Val(Coldetail.current[3]) * Val(Coldetail.current[4]), Ar$)
            If Len(Coldetail.current[5]) - InStr(Coldetail.current[5], ",") = 2 Then Coldetail.current[5] = Coldetail.current[5] & "  "
            Coldetail.current[7] = Coldetail.current[5]
            Ect = "1"
            N = 1
            Nlgart.Text = Format$(Coldetail.current[0], "0000")
            Artdsg.Text = "Eco-participation DEA"
            Artpu.text = Coldetail.current[3]
            Artbrut.Text = Coldetail.current[5]
            Artnet.Text = Coldetail.current[7]
            Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
            If Prxdec Then
              Artpu.Text = Format$(Val(.CPoint(Artpu.Text)), "0")
              Artbrut.Text = Format$(Val(.CPoint(Artbrut.Text)), "0")
              Artnet.Text = Format$(Val(.CPoint(Artnet.Text)), "0")
              Arttc.Text = Format$(Val(.CPoint(Arttc.Text)), "0")
            Endif
            typeL = "D"
            Enrg_Ligart()
            Cart.SetFocus
            Cart.Select
            Cleanart()
            BArt_Click()
            N = 1
            Break
          Endif
        Until Coldetail.MoveNext()
      Endif
      If Ect <> "1" Then
        Coldetail.MoveLast()
        Coldetail.item.Selected = True
        Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
        Artdsg.Text = "Eco-participation DEA"
        Artpu.text = Format$(Valeur_Ecotaxe2, "0.000")
        Artbrut.Text = Artpu.Text
        Artnet.Text = Format$(Val(Utils.CPoint(Artpu.Text)) * Val(Utils.CPoint(Artqte.Text)), ar$)
        Arttc.Text = Format$(Val(Utils.CPoint(Artnet.Text)) + (Val(Utils.CPoint(Artnet.Text)) * Ttva / 100), ar$)
        If Prxdec Then
          Artpu.Text = Format$(Val(.CPoint(Artpu.Text)), "0")
          Artbrut.Text = Format$(Val(.CPoint(Artbrut.Text)), "0")
          Artnet.Text = Format$(Val(.CPoint(Artnet.Text)), "0")
          Arttc.Text = Format$(Val(.CPoint(Arttc.Text)), "0")
        Endif
        typeL = "D"
        N = 1
        MajColdetailEco()
        Ect = "0"
      Endif
    Endif
  End With
  
End

'*******************************************
'*       Gestion de la taxe copie privée   *
'*******************************************
Public Sub Txpp()
  
  Dim tcpp As String
  
  With Utils
    Artqte.Text = qteecot
    Decimal()
    tcpp = "0"
    If Val(Artrm.Text) <> 100 Then
      Artrm.Text = "0,00"
      If Modif = "1" Then
        Tcpp = "1"
        Coldetail.MoveFirst()
        Repeat
          Coldetail.item.Selected = True
          If Coldetail.current[16] = Bloc And Coldetail.current[9] = "P" Then
            Coldetail.current[4] = Artqte.Text
            Coldetail.current[5] = Format$(Val(Coldetail.current[3]) * Val(Coldetail.current[4]), Ar$)
            If Len(Coldetail.current[5]) - InStr(Coldetail.current[5], ",") = 2 Then Coldetail.current[5] = Coldetail.current[5] & "  "
            Coldetail.current[7] = Coldetail.current[5]
            Tcpp = "1"
            N = 1
            Nlgart.Text = Format$(Coldetail.current[0], "0000")
            Artdsg.Text = "Taxe copie privée"
            Artpu.text = Coldetail.current[3]
            Artbrut.Text = Coldetail.current[5]
            Artnet.Text = Coldetail.current[7]
            Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
            typeL = "P"
            Enrg_Ligart()
            Cart.SetFocus
            Cart.Select
            Cleanart()
            BArt_Click()
            Break
          Endif
        Until Coldetail.MoveNext()
      Endif
      If Tcpp <> "1" Then
        Coldetail.MoveLast()
        Coldetail.item.Selected = True
        Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
        Artdsg.Text = "Taxe copie privée"
        Artpu.text = Format$(Valeur_Copp, Ar$)
        Artbrut.Text = Artpu.Text
        Artnet.Text = Format$(Valeur_Copp * Val(.CPoint(Artqte.Text)), Ar$)
        Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
        typeL = "P"
        N = 1
        MajColdetailEco()
        Tcpp = "0"
      Endif
    Endif
  End With
  
End

Public Sub MajColdetailEco()
  
  Coldetail.Add(Nlgart.text, Nlgart.text)
  Coldetail.item[0] = Nlgart.text
  Coldetail.item[2] = Artdsg.text
  Coldetail.item[3] = Artpu.text
  Coldetail.item[4] = Artqte.text
  Coldetail.item[5] = Artbrut.text
  Coldetail.item[7] = Artnet.text
  Coldetail.item[9] = typeL
  Coldetail.item[8] = Arttc.text
  Coldetail.item[12] = Arttx.text
  Coldetail.item[14] = Dec.text
  Coldetail.item[16] = Bloc
  Enrg_Ligart()
  Cart.SetFocus
  Cart.Select
  Cleanart()
  BArt_Click()
  N = 1
  Cart.Background = Color.TextBackground
  Artqte.Background = Color.TextBackground
  Artbrut.Background = Color.TextBackground
  Artrm.Background = Color.TextBackground
  Artpu.Background = Color.TextBackground
  Arttc.Background = Color.TextBackground
  
End

Public Sub Cleanart()
  
  Cart.Text = ""
  Artdsg.Text = ""
  Artfam.Text = ""
  ArtFour.Text = ""
  Artpu.Text = ar$
  'Dec.Text = "2"
  'Artqte.Text = "1.00"
  Decimal()
  Artbrut.Text = ar$
  Artrm.Text = ar$
  Artnet.Text = ar$
  Arttc.Text = ar$
  Colvente = 0
  PVHT2 = 0
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  If Not Error Then
    Nlgart.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Else
    Nlgart.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Marge.Text = ar$
  Pdxart.Clear
  Apromo = False
  RemType = 0
  If Not Settings["/Soc" & Start.Societe & "/Afour"] Then
    TextLabel41.Text = "Famille" 
    ArtFour.Visible = False
    Frame4.Visible = False
  Endif 
  
End

'*********************************
'* Calcul du nombre de decimal   *
'*********************************
Public Sub Decimal()
  
  With Utils
    Artqte.Text = .CPoint(Artqte.Text)
    If IsNull(Val(Artqte.text)) Then Artqte.Text = "1"
    If DEC.text = "0" Then
      Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0")
    Else
      If DEC.text = "2" Then
        Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0.00")
      Else
        If dec.Text = "3" Then
          Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0.000")
        Endif
      Endif
    Endif
  End With
  
End

'*********************************
'* Gestion du bouton "Dec"       *
'*********************************
Public Sub Dec_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Dec_Click()
    Stop Event
  Endif
  
End

Public Sub Dec_Click()
  
  decimal()
  Artqte.SetFocus
  Artqte.Select
  
End

'*********************************
'* Calcul du Ht du produit       *
'*********************************
Public Sub CalcHt()
  
  With Utils
    tx = 1 + (Ttva / 100)
    Try Artrm.Text = .CPoint(Artrm.Text)
    If Val(Artrm.Text) = Null Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Artrm.Text = Format$(Val(Artrm.Text), "0.00")
    Endif
    Arttc.Text = .CPoint(Arttc.Text)
    If Val(Arttc.Text) = Null Or Val(Arttc.Text) = 0 Then
      If chkfocus <> 1 Then
        If start.son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Apromo = False Then arrondi()
    Endif
    Artnet.Text = Format$(Val(.CPoint(Arttc.Text)) / Tx, Ar$)
    If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
      Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Ar$)
    Else
      Artbrut.Text = Format(Val(Artnet.Text), Ar$)
    Endif
    Artpu.Text = Format$(Val(.CPoint(Artbrut.Text)) / (Val(.CPoint(Artqte.Text))), Ar$)
    Artpu.Text = Format$(Val(Artpu.Text), Ar$)
  End With
  
End

'*********************************
'* Calcul du TTC du produit      *
'*********************************
Public Sub CalcTTC()
  
  Recup_Tva()
  Arttc.Text = Val(Utils.CPoint(Artnet.Text)) + (Val(Utils.CPoint(Artnet.Text)) * Ttva / 100)
  If Apromo = False Then arrondi()
  tx = 1 + (Ttva / 100)
  Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, Ar$)
  If Val(Artrm.text) = 0 Then Artnet.Text = Artbrut.Text
  If retro.value = True Then
    Artbrut.Text = Artnet.Text
    Artpu.Text = Format$(Val(Utils.CPoint(Artbrut.Text)) / (Val(Utils.CPoint(Artqte.Text))), Ar$)
    Artpu.Text = Format$(Val(Artpu.Text), Ar$)
  Endif
  
End

'************************
'* Recup de la Tva      *
'************************
Public Sub Recup_Tva()
  
  If Not exo.value Then
    Try Ttva = CPrix.CTva(Arttx.Text)
    If Error Then
      message.Error("Veuillez controler votre TVA SVP !")
      Cleanart()
      Cart.SetFocus
    Endif
  Else
    Arttx.Text = ""
  Endif
  
End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Sub arrondi()
  
  Try Arttc.Text = Utils.CPoint(Arttc.Text)
  If Not ArTTc.Text Then ArTTc.Text = "ar$"
  'IF arr = "0,01" THEN ArTTC.Text = Format$(ArTTC.Text, Ar$)
  Arttc.Text = Format$(Val(Arttc.Text), ar$)
  If retro.value = False Then
    If arr = "0,05" Then
      If Right$(ArTTc.Text) Like "[34567]*" Then
        ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 1)) & "5"
      Else
        ArTTC.Text = Round(Val(ArTTC.Text), -1)
        ArTTC.Text = Format$(ArTTC.Text, ar$)
      Endif
    Endif
    
    If arr = "0,10" Then
      ArTTC.Text = Round(Val(ArTTC.Text), -1)
      ArTTC.Text = Format$(ArTTC.Text, ar$)
    Endif
    
    If arr = "0,50" Then
      If Abs(Val(ArTTc.Text)) <= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 25)) Then
        ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 2)) & "00"
      Else
        If Abs(Val(ArTTc.Text)) <= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 75)) Then
          ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 2)) & "50"
        Endif
        If Abs(Val(ArTTc.Text)) >= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 76)) Then
          ArTTC.Text = Round(Val(ArTTC.Text))
          ArTTC.Text = Format$(ArTTC.Text, ar$)
        Endif
      Endif
    Endif
    
    If arr = "1,00" Then
      ArTTC.Text = Round(Val(ArTTC.Text))
      ArTTC.Text = Format$(ArTTC.Text, ar$)
    Endif
  Endif
  
End

Public Sub Tbremq_Create()
  
  Dim tb As Integer
  Dim $r As String
  
  Tbrem.Width = 360
  Tbrem.Height = 170
  Tbrem.x = 270
  Tbrem.y = 186
  Tbrem.Border = True
  Tbrem.header = 3
  Tbrem.Columns.Count = 3
  Tbrem.Rows.Count = 6
  Tbrem.Columns.Width = 86
  Tbrem.Rows.Height = 24
  Tbrem.Columns[0].text = "Val mini"
  Tbrem.Columns[1].text = "Val maxi"
  Tbrem.Columns[2].text = "Remise"
  For tb = 0 To 5
    $R = "Remise " & tb
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
    Tbrem.Rows[tb].text = $R
  Next
  Tbrem.visible = False
  
End

Public Sub Tbrem_Click()
  
  Dim iRow As Integer
  
  irow = tbrem.row
  Tbrem.MoveTo(irow, 2)
  Try Artrm.Text = Format(Val(Utils.cpoint(Tbrem.current.Text)), "0.00")
  Tbrem.Clear
  Tbrem.Visible = False
  Artrm.SetFocus
  Artrm.Select
  
End

'**********************************************************
'*           Gestion onglet Saisie Commentaires           *
'**********************************************************
Public Sub SelectionCom()
  
  Dim sline As String
  
  With Colcom
    Colcom.Clear
    If Colmo.Visible Then
      Colmo.Clear
      Colmo.Visible = False
      HBox8.Visible = False
    Endif
    If ColFam.Visible Then
      ColFam.Clear
      ColFam.Visible = False
    Endif
    If Colcom.Visible Then
      Colcom.Clear
      Colcom.Visible = False
    Else
      ColCom.Visible = True
      .Columns.count = 2
      .Columns[0].Width = 70
      .Columns[1].Alignment = Align.TopLeft
      .Columns[1].Width = 350
      
      .Columns[0].Text = "Code"
      .Columns[1].Text = "Intitulé"
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCom") & " order by numcom")
      If rResult.Available Then
        Repeat
          Try .Add(rResult!numcom, rResult!numcom)
          If Not Error Then
            If Not Error Then
              For Each sline In Split(rResult!intitule, "\n")
                Colcom.Item[1] = sline
                Break
              Next
            Endif
          Endif
        Until rResult.MoveNext()
      Else
        If start.son Then
          Music.Play
        Endif
        Try Message.Warning("Il n'existe aucun commentaire\n veuillez d'abord créer vos Textes SVP ! ")
        Colcom.Clear
        Colcom.visible = False
        
      Endif
      If Colcom.Count Then
        Colcom.MoveFirst
        Colcom.SetFocus
        Colcom.item.Selected = True
      Endif
    Endif
  End With
  
End

'**********************************************
'* Selection d'un commentaire a la souris     *
'**********************************************
Public Sub Colcom_Click()
  
  Tab = "Fiches_Commentaires"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numcom = &1", Colcom.current[0])
  Comcode.Text = Colcom.current[0]
  intitule.Text = rResult!intitule
  Colcom.Visible = False
  intitule.setfocus
  intitule.select
  
End

'***********************************************
'* Saisie d'un commentaire manuellement        *
'***********************************************
Public Sub Colcom_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcom_click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Colcom.visible = False
    Colcom.clear
    Comcode.Select
    Comcode.SetFocus
    Stop Event
  Endif
  
End

'*********************************
'* Gestion du panel "Com"        *
'*********************************
Public Sub com_KeyPress()
  
  Dim hform2 As Form
  
  If key.Code = key.F4 Then Comment.ShowModal()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        com_man()
        If b <> 1 Then
          intitule.SetFocus
          intitule.Select
        Endif
        b = 0
        Stop Event
        
      Case 2
        Button12.SetFocus
    End Select
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If key.Code = key.F2 Then
    Select Case Last.tag
        
      Case 1
        SelectionCom()
    End Select
    Stop Event
  Endif
  
  If Key.code = Key.F3 Then
    Button15_Click()
    Bl_Edit()
    Stop Event
  Endif
  
  If key.Code = key.F6 Then
    Button15_Click()
    Bl_Edit()
    Edit.Visible = False
    Button14_Click()
    Stop Event
  Endif
  
  If key.code = key.F12 Then
    hForm2 = New Suivi(code.text, Cv.Text, Nom.Text, Pnm.Text, Num.Text, datej.Text, "", "", Bdevis.value, Bfac.value, Impfac)
    hForm2.Showmodal()
    Stop Event
  Endif
  
End

'***************************
'*      Gestion du focus.  *
'***************************
Public Sub com_GotFocus()
  
  Try Utils.ObsGotf(Last)
  Nlg.Background = &HD4D0C8&
  
End

Public Sub Com_LostFocus()
  
  Try Utils.ObsLstf(Last)
  
End

Public Sub ToggleButton4_Click()
  
  Selectioncom()
  
End

Public Sub Button12_keypress()
  
  Button12_Click()
  
End

Public Sub Button12_Click()
  
  Dim sline As String
  Dim Lg As Integer = 1
  
  intitule.Text = Utils.ReplaceLb(intitule.Text)
  If IsNull(Comcode.Text) Then Comcode.text = " "
  If Comcode.Text = "XX" Then XX = Intitule.Text
  If N = 1 Then
    For Each sline In Split(Intitule.Text, "\n")
      Coldetail.Add(Nlgcom.text & Lg, Nlgcom.text & Lg)
      Coldetail.item[0] = Nlgcom.text
      Coldetail.item[1] = Comcode.Text
      Coldetail.item[2] = sline
      Coldetail.item[9] = typeL
      Coldetail.item[16] = Nlgcom.text & Comcode.Text
      Inc Lg
    Next
  Else
    Coldetail.MoveFirst()
    Repeat
      Coldetail.item.Selected = True
      If Coldetail.item[0] = NlgModif Then
        For Each sline In Split(Intitule.Text, "\n")
          Coldetail.item[0] = Nlgcom.text
          Coldetail.item[1] = Comcode.Text
          Coldetail.item[2] = sline
          Coldetail.item[9] = typeL
          Coldetail.item[16] = Nlgcom.text & Comcode.Text
        Next
      Endif
      Break
    Until Coldetail.MoveNext()
  Endif
  Enrg_Ligcom()
  Comcode.Text = ""
  Nlgcom.Text = ""
  intitule.Text = ""
  Colcom.clear
  Coldetail.MoveLast()
  Coldetail.item.Selected = True
  Nlgcom.Text = Format$(Val(Coldetail.current[0]) + 1, "0000")
  Comcode.SetFocus
  Comcode.Select
  com_Click()
  N = 1
  'modif = "0"
  
End

Public Sub Button24_Click()
  
  Dim Tabresult As Result
  Dim Tabcom As String
  Dim Erg As Integer = 0
  
  Tabcom = "Fiches_Commentaires"
  If IsNull(Comcode.Text) Then
    If start.son Then
      Music.Play
    Endif
    Balloon.Warning(("Veuillez saisir un code commentaire SVP"), Comcode)
    Erg = 1
    Comcode.SetFocus
    Comcode.Select
  Endif
  Tabresult = Utils.db.Exec("SELECT * FROM " & Tabcom & " where numcom = &1", Comcode.Text)
  If TabResult.Available Then
    If start.son Then
      Music.Play
    Endif
    Balloon.Warning(("Ce code est déjà attribué à un commentaire !"), Button24)
    Erg = 1
  Endif
  If Erg = 0 Then
    Utils.db.Exec("INSERT INTO " & tabcom & "(numcom, intitule) VALUES (&1, &2)", Comcode.Text, Intitule.Text)
    Balloon.Info(("Ce commentaire a été ajouté à la table des commentaires !"), Button24)
  Endif
  Erg = 1
  
End

'**********************************************************
'*                     Commentaire manuel                 *
'**********************************************************
Public Sub com_man()
  
  Tab = "Fiches_Commentaires"
  If Comcode.Text <> "" Then
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numcom = &1", Comcode.Text)
    If rResult.Available Then
      Comcode.Text = rResult!numcom
      intitule.text = rResult!intitule
    Else
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Le commentaire " & Comcode.text & " n'existe pas !", "OK")
      Comcode.SetFocus
      Comcode.clear
      b = 1
    Endif
  Endif
  
End

'**********************************************************
'*                 Rappel des lignes validées             *
'**********************************************************
Public Sub Coldetail_Activate()
  
  Dim hresult As Result
  Dim MatR As Result
  Dim TabMat As String
  Dim Lg As Integer = 0 'sert à gerer le saut de ligne des lignes de commentaire
  Dim l As String = ""
  Dim nlgc As String = ""
  
  Tab = "Fiches_Ligbl"
  Tab3 = "Fiches_Mo"
  TabMat = "Fiches_Materiels"
  chkfocus = 1
  Frame4.visible = False
  With utils
    'If key.Code <> "4100" And If key.code <> "4101" Then
    'Finally
    If Not Coldetail.Available Then
      Coldetail.clear
    Else
      Nlgapp = Coldetail.current[0]
      typeL = Coldetail.current[9]
      Bloc = Coldetail.current[16]
      Blocnum = bloc
      Nlgc = Coldetail.current[0]
      NlgModif = Coldetail.current[0]
      Nlgn = Nlgcom.text
      Txhr.ReadOnly = False
      Tmont.ReadOnly = False
      Tmont.Background = Color.TextBackground
      Txhr.Background = Color.TextBackground
      l = Left$(Coldetail.Key, 4)
      
      '* On rappelle les lignes de main d'oeuvre
      If typel = "M" Then
        If Impfac <> "1" Then
          Motm.Value = True
          Panel2.visible = True
          Panel3.Visible = False
          Panel4.visible = False
          Nlg.text = Coldetail.current[0]
          Cmo.text = Coldetail.current[1]
          libelle.text = Coldetail.current[2]
          Txhr.text = Coldetail.current[3]
          Tmont.text = Coldetail.current[4]
          Brutht.text = Coldetail.current[5]
          rem.text = Coldetail.current[6]
          Netht.text = Coldetail.current[7]
          Tm.text = Coldetail.current[10]
          Nettc.Text = Coldetail.current[8]
          Tmo.Text = Coldetail.current[12]
          Cdfam.Text = Coldetail.current[13]
          rem.Text = Format$(Val(.CPoint(rem.Text)), "0.00")
          Nlgn = Nlg.text
          Arttc.Text = Val(Utils.CPoint(Artnet.Text)) + (Val(Utils.CPoint(Artnet.Text)) * Ttva / 100)
          Brutht.Text = Format(Val(.CPoint(Tmont.Text)) * Val(.CPoint(Txhr.Text)), "0.00")
          hresult = Utils.db.Exec("select * from " & Tab3 & " where mo_code = &1", Cmo.text)
          If hresult.Available Then
            Arr = hresult!mo_cdarr
          Endif
          Calc_Net()
          Calc_Tc()
          libelle.Select
          libelle.SetFocus
          If Not tvar.Value Then
            Tmo.readonly = True
          Else
            Tmo.readonly = False
          Endif
          Calc_MargeMo()
        Else
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Modification impossible, la facture a été imprimée ?")
        Endif
      Endif
      
      '* On rappelle les lignes de produits
      If typel = "A" Then
        If Impfac <> "1" Then
          sTTC.value = False
          Panel2.visible = False
          Panel3.Visible = True
          Panel4.visible = False
          BArt.Value = True
          Nlgart.text = Coldetail.current[0]
          Cart.text = Coldetail.current[1]
          Artdsg.text = Coldetail.current[2]
          Artpu.text = Coldetail.current[3]
          Dec.Text = Coldetail.current[14]
          Artqte.text = Coldetail.current[4]
          Artbrut.text = Coldetail.current[5]
          If Coldetail.current[6] = "Net" Then
            Artrm.Text = "0,00"
            bNet = True
          Else
            Artrm.text = Coldetail.current[6]
            bNet = False
          Endif
          Artnet.text = Coldetail.current[7]
          Arttc.Text = Coldetail.current[8]
          Arttx.Text = Coldetail.current[12]
          Artfam.Text = Coldetail.current[13]
          ArtFour.Text = Coldetail.current[20]
          PdxArt.Text = Coldetail.current[17]
          Nlgn = Nlgart.text
          Artdsg.Select
          Artdsg.SetFocus
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & "  left join " & Cbase.Table("TabFour") & " on art_code = fo_cdech where art_code = &1", Cart.Text)
          If hresult.Available Then
            If Len(ArtFam.Text) > 5 Then
              $Fam = hResult!art_fam
              $Four = Artfam.Text
            Endif
            If Len(ArtFam.Text) < 6 Then
              $Four = hResult!art_four
              $Fam = Artfam.Text
            Endif
            If IsNull(ArtFour.text) Or If ArtFour.text = hresult!art_four Then
              TextLabel41.Text = "Famille" 
              ArtFour.Visible = False
              Frame4.Visible = False
            Else
              TextLabel41.Text = "Fournisseur"
              ArtFour.Visible = True 
              Frm12()
            Endif
            Nbdec = .Find_Nbdec(hresult!art_nbd)
            If Prxdec Then 
              ar$ = "0"
            Else
              ar$ = Nbdec
            Endif
            Arr = hresult!art_cdarr
            Paht = hresult!art_paht
            Pmp = hresult!art_pmp
            Pdx = hresult!art_poids
            If hresult!art_stocke Then Quantite()
            If IsNull(Pdx) Then Pdx = "0,000"
            If IsNull(Pdxart.Text) Then Pdxart.Text = Format$((Val(Utils.cpoint(Artqte.Text)) * Val(Utils.cpoint(Pdx))), "0.000")
            Try Ecotaxe = hresult!art_ect
            Taxepv = hresult!art_cpp
            Try Valeur_Copp = hresult!art_copp
            $photo = hresult!art_photo
            $crst = hresult!art_crst
            Materiel = hresult!art_mat
            If Materiel Then
              Repeat
                Coldetail.item.Selected = True
                Artqte.ReadOnly = True
                If Coldetail.current[9] = "T" And Left$(Coldetail.current[2], 17) = "Numéro de série" Then
                  MatR = Utils.db.Exec("SELECT * FROM " & tabMat & " WHERE mat_serie = &1", Coldetail.current[1])
                  If MatR.Available Then Utils.db.Exec("Update " & tabMat & " set mat_vendu = &1, mat_cli = &3 where mat_serie = &2", 0, Coldetail.current[1], "")
                  'Coldetail.current.Delete
                  'Ren_ligbl()
                  Maj_Base()
                  Break
                Endif
              Until Coldetail.MoveNext()
            Endif
            If TextLabel41.Text = "Fournisseur" Then 
              Frm12()
            Endif
          Endif
          Calc_Marge()
          If Not tvar.Value Then
            Arttx.ReadOnly = True
          Else
            Arttx.ReadOnly = False
          Endif
          If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
          chkfocus = 0
          If sTTC.Value Then
            Textlabel30.text = "Prix TTC"
            Recup_Tva()
            Artpu.Text = Val(Utils.CPoint(Artpu.Text)) + (Val(Utils.CPoint(Artpu.Text)) * Ttva / 100)
            Artpu.text = Format$(Val(Utils.cpoint(Artpu.text)), ar$)
          Else
            Textlabel30.text = "Prix HT" 
          Endif
        Else
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning("Modification impossible, la facture a été imprimée ?")
        Endif
      Endif
      '* On rappelle les lignes de commentaires
      If typel = "C" Then
        Nlgcom.Text = Format$(Coldetail.count + 1, "0000")
        Panel2.visible = False
        Panel3.Visible = False
        Panel4.Visible = True
        Nlgcom.Text = Nlgc
        Com.Value = True
        Nlgart.text = Coldetail.current[0]
        Comcode.Text = Coldetail.current[1]
        Nlgcom.Text = Coldetail.current[0]
        Intitule.Clear
        Coldetail.MoveFirst()
        Repeat
          Try Coldetail.item.Selected = True
          If Coldetail.current[16] = Bloc Then
            If lg = 1 Then intitule.Insert("\n")
            intitule.Insert(Coldetail.current[2])
            lg = 1
          Endif
        Until Coldetail.MoveNext()
        Coldetail.MoveFirst()
        Coldetail.item.Selected = True
        While Left$(Coldetail.Key, 4) <> (Format$(Val(l), "0000"))
          Coldetail.MoveNext()
          Try Coldetail.item.Selected = True
          If (Format$(Val(Left$(Coldetail.key, 4)), "0000")) = (Format$(Val(l), "0000")) Then Break
        Wend
        Comcode.Text = Coldetail.current[1]
        Nlgcom.Text = Coldetail.current[0]
      Endif
    Endif
    N = 0
    t = 0
    Modif = "1"
    'IF typel <> "C" THEN NlgModif = Coldetail.current[0]
    'Endif
  End With
  
End

Public Sub Coldetail_Click()
  
  chkfocus = 2
  
End

'**********************************************************
'*    Rappel, Suppression et déplacement de ligne         *
'**********************************************************
Public Sub Coldetail_Keypress()
  
  Dim l As String = ""
  Dim l3 As String = ""
  Dim l4 As String = "" ' valeur de la derniere ligne
  Dim l6 As String = "" ' valeur de la première ligne
  Dim nbl As Integer = 0
  Dim nbla As Integer = 1
  Dim np As Integer = 0
  Dim Blocp As String = ""
  Dim Type_Ligne As String = ""
  Dim Type_LigneR As String = ""
  Dim materiel As Result
  Dim Tabmat As String
  Dim Prod As Boolean = False
  Dim skey As String
  
  Tabmat = "Fiches_Materiels"
  If Coldetail.count > 0 Then
    'Coldetail.Item.Selected = True
    l = Left$(Coldetail.Key, 4)
    Type_Ligne = Coldetail.current[9] 'type de la ligne selectionnée
    Coldetail.MoveLast()
    Coldetail.item.Selected = True
    l4 = Coldetail.current[0] ' dernier numéro de ligne
    Coldetail.MoveFirst()
    Coldetail.item.Selected = True
    l6 = Coldetail.current[0] ' premier numéro de ligne
    If key.code = 42 Then
      Lbarre = 1
      Cart.SetFocus
    Endif
    Coldetail.MoveFirst()
    While Left$(Coldetail.Key, 4) <> (Format$(Val(l), "0000"))
      Coldetail.item.Selected = True
      Coldetail.MoveNext()
    Wend
    If Key.code = Key.Delete And Coldetail.Count <> 0 Then
      If Coldetail.current[9] = "M" Or Coldetail.current[9] = "A" Or Coldetail.current[9] = "C" Or Coldetail.current[9] = "O" Or Coldetail.current[9] = "R" Or If Coldetail.current[9] = "T" Or Coldetail.current[9] = "P" Or Coldetail.current[9] = "O" Or Coldetail.current[9] = "R" Or If Coldetail.current[9] = "T" Or Coldetail.current[9] = "E" Then
        If Impfac <> 1 Or If Coldetail.current[9] = "C" Then
          If start.son Then
            Music.Play
          Endif
          If Message.Question("Etes-vous sur de vouloir supprimer cette ligne ?", "Oui", "Non") = 1 Then
            l = Left$(Coldetail.Key, 4)
            Bloc = Coldetail.current[16]
            If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "O" Or If Coldetail.current[9] = "R" Then
              'Coldetail.MoveFirst()
              'For numl = 1 To Coldetail.count
              'Coldetail.item.Selected = True
              'Try l2 = Coldetail.current[16]
              'If Not Error Then
              'If Bloc = Coldetail.current[16] Then
              If Coldetail.current[9] = "T" And Left$(Coldetail.current[2], 17) = "Numéro de série" Then
                Materiel = Utils.db.Exec("SELECT * FROM " & tabmat & " WHERE mat_serie = &1", Coldetail.current[1])
                If Materiel.Available Then Utils.db.Exec("Update " & tabmat & " set mat_vendu = &1, mat_cli = &3 where mat_serie = &2", 0, Coldetail.current[1], "")
              Endif
              If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "O" Or If Coldetail.current[9] = "R" Then
                Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigbl") & " where block_ligbl = &1 and num_ligbl = &2", bloc, num2.Text)
              Else
                Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigbl") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail.current[0], Num2.Text)
              Endif
              'Else
              'Coldetail.MoveNext()
              'Endif
              'Coldetail.MoveNext()
              'Endif
              'Next
            Else
              Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigbl") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail.current[0], Num2.Text)
            Endif
            Modif = "0"
            Cleanart()
            Coldetail.Clear
            N = 1
            Recup_Ligbl()
            Ren_Ligbl()
            Maj_Base()
            Coldetail.Clear
            Recup_Ligbl()
            If Coldetail.count > 1 Then
              While Left$(Coldetail.Key, 4) <> (Format$(Val(l) - np, "0000"))
                Coldetail.MoveNext()
                Try Coldetail.item.Selected = True
                Coldetail.current.EnsureVisible
                If Error Then Break
              Wend
            Endif
          Endif
        Else
          If start.son Then
            Music.Play
          Endif
          If Coldetail.current[9] = "A"
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning(" La facture a été imprimée ! Suppression d'une ligne d'article impossible.")
          Else
            If Coldetail.current[9] = "M"
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning(" La facture a été imprimée ! Suppression d'une ligne de MO impossible.")
            Endif
          Endif
        Endif
        If Panel3.Visible = True Then
          Cart.SetFocus
        Else
          If Panel2.Visible = True Then
            Cmo.SetFocus
          Else
            If Panel4.Visible = True Then
              Comcode.SetFocus
            Endif
          Endif
        Endif
      Endif
    Endif
    If Key.code = Key.enter Or Key.code = Key.return Then
      If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Then
        Coldetail_Activate()
      Endif
    Endif
    
    ' On appuie sur la touche - pour faire remonter
    If key.code = 45 Then
      skey = Coldetail.Key
      l = Left$(Coldetail.Key, 4)
      l5 = l
      Bloc = Coldetail.current[16]
      blocp = l
      Prod = Rprodcomposes(Prod)
      If Prod = False Then
        Coldetail.MoveTo(skey)
        Try Coldetail.item.Selected = True
        If Val(l) > 1 Then
          ' On recupere le numero du bloc précédent ainsi que le type de ligne
          Do While Coldetail.current[16] = Bloc
            Coldetail.MovePrevious()
            Try Coldetail.item.Selected = True
            If Not Error Then
              If Coldetail.current[16] <> Bloc Then
                l3 = Coldetail.current[16]
                blocp = Coldetail.current[0]
                TypeL = Coldetail.current[9]
              Endif
            Else
              Break
            Endif
          Loop
          ' On compte le nombre de lignes du bloc précédent
          Repeat
            Try Coldetail.item.Selected = True
            If Not Error Then
              If Coldetail.current[16] = l3 Then
                np = np + 1
                If Coldetail.current[9] = "R" Then np = 1
              Else
                Break
              Endif
            Else
              Break
            Endif
          Until Coldetail.MovePrevious()
          If np = 0 Then np = 1
          If TypeL = "C" Then np = 1
          ' On renumerote les lignes du bloc séléctionné
          If Val(l) > Val(blocp) Then
            Coldetail.Movefirst()
            If Val(l) <= Val(L4) Then
              Repeat
                Try Coldetail.item.Selected = True
                If Error Then
                  Break
                Else
                  If Coldetail.current[16] = Bloc Then
                    Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) - np, "0000")
                    nbl = nbl + 1
                    If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "T" Then nbla = nbla + 1
                    If Coldetail.current[9] = "R" Then nbl = nbla
                  Endif
                Endif
              Until Coldetail.MoveNext()
            Endif
            If Type_ligne = "C" Then nbl = 1
            ' On renumerote les lignes du bloc précédent
            Coldetail.Movefirst()
            If Val(l) > Val(l6) Then
              Repeat
                Try Coldetail.item.Selected = True
                If Error Then
                  Break
                Else
                  If Coldetail.current[16] = l3 Then
                    Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) + nbl, "0000")
                  Endif
                Endif
              Until Coldetail.MoveNext()
            Endif
            Maj_Base()
            Coldetail.Clear
            Recup_Ligbl()
            nbl = 0
            Coldetail.MoveFirst()
            Coldetail.item.Selected = True
            While Left$(Coldetail.Key, 4) <> (Format$(Val(l) - np, "0000"))
              Try Coldetail.item.Selected = True
              Coldetail.MoveNext()
            Wend
            Coldetail.current.EnsureVisible
            np = 0
            nbl = 0
          Endif
        Endif
      Else
        If start.son Then
          Music.Play
        Endif
        Message.Warning("Déplacement de ligne impossible avec des produits composés !")
      Endif
    Endif
    
    ' On appuie sur la touche + pour faire descendre
    If Key.Code = 43 Then
      skey = Coldetail.Key
      l = Left$(Coldetail.Key, 4)
      l5 = l
      Bloc = Coldetail.current[16]
      Prod = Rprodcomposes(Prod)
      If Prod = False Then
        Coldetail.MoveTo(skey)
        Try Coldetail.item.Selected = True
        ' On recupere le numero du bloc suivant ainsi que le type de ligne
        Do While Coldetail.current[16] = Bloc
          Coldetail.Movenext()
          Try Coldetail.item.Selected = True
          If Not Error Then
            If Coldetail.current[16] = Bloc Then l5 = Left$(Coldetail.Key, 4)
            If Coldetail.current[16] <> Bloc Then
              l3 = Coldetail.current[16]
              TypeL = Coldetail.current[9]
            Endif
          Else
            Break
          Endif
        Loop
        ' On compte le nombre de lignes du bloc suivant
        Repeat
          Try Coldetail.item.Selected = True
          If Not Error Then
            If Coldetail.current[16] <> Bloc Then
              If Coldetail.current[16] = l3 Then
                If Coldetail.current[9] <> "R" Then np = np + 1
                If Coldetail.current[9] = "R" Then Type_LigneR = "R"
              Endif
            Endif
          Else
            Break
          Endif
        Until Coldetail.MoveNext()
        If TypeL = "C" Then np = 1
        If Type_LigneR = "R" Then np = np + 1
        If np = 0 Then np = 1
        ' On renumerote les lignes du bloc séléctionné
        If Val(l5) < Val(l4) Then
          Coldetail.Movefirst()
          Repeat
            If Val(l) <= Val(L4) Then
              Try Coldetail.item.Selected = True
              If Error Then
                Break
              Else
                If Coldetail.current[16] = Bloc Then
                  Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) + np, "0000")
                  nbl = nbl + 1
                  If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "T" Then nbla = nbla + 1
                  Type_ligne = Coldetail.current[9]
                Endif
              Endif
            Endif
          Until Coldetail.MoveNext()
          If Type_ligne = "C" Then nbl = 1
          If Type_ligne = "R" Then nbl = nbla
          ' On renumerote les lignes du bloc suivant
          Coldetail.Movefirst()
          Repeat
            Try Coldetail.item.Selected = True
            If Error Then
              Break
            Else
              If Coldetail.current[16] = l3 Then Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) - nbl, "0000")
            Endif
          Until Coldetail.MoveNext()
          Maj_Base()
          Coldetail.Clear
          Recup_Ligbl()
          Coldetail.MoveFirst()
          Coldetail.item.Selected = True
          While Left$(Coldetail.Key, 4) <> Format$(Val(l) + np, "0000")
            Try Coldetail.item.Selected = True
            Coldetail.MoveNext()
          Wend
          Coldetail.current.EnsureVisible
          np = 0
          nbl = 0
        Endif
      Else
        If start.son Then
          Music.Play
        Endif
        Message.Warning("Déplacement de ligne impossible avec des produits composés !")
      Endif
    Endif
    Colbl.refresh
    If Bart.Value = True Then typeL = "A"
    If B2art.Value = True Then typeL = "A"
    If Motm.Value = True Then typeL = "M"
    If Com.Value = True Then typeL = "C"
    'On sélectionne les lignes a dupliquer
    If Key.code = 32 Then 
      If IsNull(Coldetail.current[10]) Then
        Coldetail.current[10] = "*"
      Else
        If Left$(Coldetail.current[10]) = "*" Then
          If Len(Coldetail.current[10]) > 1 Then
            Coldetail.current[10] = Right$(Coldetail.current[10])
          Else
            Coldetail.current[10] = ""
          Endif
        Else
          Coldetail.current[10] = "*" & Coldetail.current[10]
        Endif
      Endif
    Endif
  Endif
  'On lance la duplication
  If key.Control Then
    If Key.code = 68 Then Dupli3()
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'**************************************************
'*       Duplication document en cours            *
'**************************************************
Public Sub Dupli3()
  
  Dim numbon As String
  Dim $dup, $dupP As Boolean = False
  Dim Colitem0, Colitem1, Colitem9, Colitem16 As String
  Dim bloc, lg, l3, l4, l5, lt, nmbl As String
  Dim nligne, nblignes, iskey As Integer = 0
  
  Tab = "Fiches_Parametres"
  Coldetail.MoveLast
  Coldetail.Item.selected = True
  nblignes = Val(Coldetail.current[0])
  Coldetail.MoveFirst()
  Nmbl = num.Text
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Left$(Coldetail.current[10], 1) = "*" Then
        $dup = True
        $dupP = True
        Break
      Endif
    Endif
  Until Coldetail.MoveNext()
  If $dup Then
    If Message.warning("Vous allez faire une duplication partielle !", "Oui", "Non") = "2" Then Return
  Else
    If Message.warning("Vous allez faire une duplication totale !", "Oui", "Non") = "2" Then Return
  Endif
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE")
  Nv = 1
  Nvc = 0
  ' on met a jour les parametres
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    numbon = rResult!dnbon
    numbon = Val(numbon) + 1
    numbon = Format$(numbon, "000000")
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnbon = &1", numbon)
    Utils.db.Exec("UNLOCK TABLES")
  Endif
  ' On créé le nouveau bon
  Tab = "Fiches_Bl"
  Utils.db.Exec("INSERT INTO " & Tab & "(numbl,datebl,cdclibl, nmclibl, rmobl, rartbl, type, pnmclibl, adr1bl, adr2bl, cpbl, villebl, exobl, cvclibl, tvar, imp, acpt, mreg, totalht, retro, marge_art, remmobl, remartbl, marge_mo, totalttc, htbl, cdep, livraison) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15}, &{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27}, &{28})", numbon, Utils.Cdate_Dbase(Format$(Now, "dd.mm.yyyy")), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, tvar.Value, 0, 0, 0, 0, retro.value, 0, 0, 0, 0, 0, sTTC.value, Dep.text, Livraison.value)
  ' On enregistre les lignes 
  Tab = "Fiches_Ligbl"
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  Try l5 = Coldetail.current[0]
  If Not Error Then
    If $dup = True Then
      nligne = 1
      If Bcomde.value Then Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &1)", numbon, Format$(Nligne, "0000"), "", "Reliquat de la commande " & num.text, "C", Format$(Nligne, "0000"))
    Endif
    Coldetail.MoveFirst()
    Inc Nblignes
    If Bcomde.value Then Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", num.Text, Format$(Nblignes, "0000"), "", " ", "C", Format$(Nblignes, "0000"))
    Inc Nblignes
    If Bcomde.value Then Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", num.Text, Format$(Nblignes, "0000"), "", "Pièces en reliquat sur la commande " & numbon, "C", Format$(Nblignes, "0000"))
    Repeat
      Coldetail.item.Selected = True
      If $dupP And Left$(Coldetail.current[10]) = "*" Then 
        $dup = True
      Else
        If $dupP And IsNull(Coldetail.current[10]) Then 
          $dup = False
        Endif
      Endif
      If Not $dupP Then $dup = True
      If $dup Then
        Bloc = Coldetail.current[16]
        l3 = Bloc
        Colitem0 = Coldetail.current[0]
        Colitem1 = Coldetail.current[1]
        Colitem9 = Coldetail.current[9]
        Colitem16 = Coldetail.current[16]
        Intit = Coldetail.current[2]
        If InStr(Intit, "~ ") <> 0 Then Try Intit = Mid$(Intit, InStr(Intit, "~ ") + 2, Len(Intit))
        If Coldetail.current[9] <> "C" And If Coldetail.current[9] <> "R" Then
          If Len(Coldetail.current[10]) > 1 Then 
            lt = Right$(Coldetail.current[10]) 
          Else
            If Left$(Coldetail.current[10]) = "*" Then
              lt = ""
            Else
              lt = Coldetail.current[10]
            Endif
          Endif
          Inc Nligne
          Inc Nblignes
          If Bcomde.value Then Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", num.Text, Format$(Nblignes, "0000"), "", Coldetail.current[1] & " * " & Intit, "C", Format$(Nblignes, "0000"))
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl,  libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, mrgart_ligbl, mrgmo_ligbl, pdstotal_ligbl, tm_ligbl, four_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20})", numbon, Format$(Nligne, "0000"), Coldetail.current[1], Coldetail.current[2], Coldetail.current[13], Coldetail.current[3], Coldetail.current[4], Coldetail.current[5], Coldetail.current[6], Coldetail.current[7], Coldetail.current[12], Coldetail.current[8], Coldetail.current[9], Coldetail.current[14], Format$(Nligne, "0000"), Coldetail.current[18], Coldetail.current[19], Coldetail.current[17], lt, Coldetail.current[20])
        Else
          If Coldetail.current[9] = "C" Then intit = ""
          Repeat
            Coldetail.item.Selected = True
            If bloc <> Coldetail.current[16] Then Break
            If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "R" Then
              If lg = 1 Then intit = Intit & ("\n")
              intit = Intit & (Coldetail.current[2])
              lg = 1
              Bloc = Coldetail.current[16]
              l4 = Left$(Coldetail.current[0], 4)
            Else
              Break
            Endif
          Until Coldetail.Movenext()
          Inc Nligne
          Inc Nblignes
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", numbon, Format$(Nligne, "0000"), ColItem1, Intit, ColItem9, Format$(Nligne, "0000"))
          Intit = ""
          lg = 0
          If Val(l4) <> Val(l5) Then Coldetail.MovePrevious()
        Endif
      Endif
    Until Coldetail.Movenext()
    If Bcomde.value Then
      If Message.Question("Récupération terminée !\nVoulez-vous effacer les lignes séléctionnées ?", "Non", "Oui") = 2 Then
        Coldetail.MoveFirst()
        Repeat
          Coldetail.Item.Selected = True
          If Left$(Coldetail.item[10]) = "*" Then 
            If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "R" Then
              Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigbl") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail.item[0], num.text)
            Endif
          Endif
        Until Coldetail.MoveNext()
        Coldetail.Clear
        N = 1
      Endif
      Recup_Ligbl()
      Ren_ligbl()
      Maj_Base()
    Endif
    Button15_Click()
    $desc = False
    deb1()
    Titre()
    Colbl.MoveTo(0, 0)
    Nv = 0
    Panel5.Visible = False
    'On enregistre le nouveau document
    Colbl.MoveTo(0, 0)
    Colbl_Click()
    button4_click()
    If Bbon.Value Or If Bfac.value Then
      Maj_Quantite()
    Endif
    'On se repositionne sur le document d'origine.
    Repeat
      Colbl.MoveTo(iskey, 0)
      Inc iskey
    Until colbl[colbl.row, 2].Text = nmbl
    Colbl_Click()
    Datej.setfocus
    
  Endif
  
End

Public Sub Rprodcomposes(Prod As Boolean) As Boolean
  
  Prod = False
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Coldetail.current[9] = "O" Then
        Prod = True
        Break
      Endif
    Endif
  Until Coldetail.MoveNext()
  Return prod
  
End

'**********************************************************
'*                 Enregistrement lignes Bl               *
'**********************************************************

'* Pour la MO.
Public Sub Enrg_LigMo()
  
  Tab = "Fiches_Ligbl"
  With Utils
    If Cmo.Text <> "" Then
      rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlg.text)
      If rResult.Available Then
        Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , code_ligbl = &3, libel_ligbl = &4, fam_ligbl = &5, pu_ligbl = &6, qte_ligbl = &7, brut_ligbl = &8, rem_ligbl = &9, netht_ligbl = &{10}, tx_ligbl = &{11}, nettc_ligbl = &{12}, typel_ligbl = &{13}, tm_ligbl = &{14}, mrgmo_ligbl = &{15} WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlg.Text, Cmo.Text, libelle.Text, CdFam.Text, Txhr.Text, Tmont.Text, Brutht.Text, Rem.Text, Netht.Text, Tmo.Text, Nettc.Text, typeL, Tm.Text, .PointBase(MargeMo.text))
      Else
        Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, tm_ligbl, block_ligbl, mrgmo_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", num.Text, Nlg.Text, Cmo.Text, libelle.Text, CdFam.Text, Txhr.Text, Tmont.Text, Brutht.Text, Rem.Text, Netht.Text, Tmo.Text, Nettc.Text, typeL, Tm.Text, Bloc, .PointBase(MargeMo.text))
      Endif
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  If modif = "0" Then
    Try Coldetail.MoveLast()
    Try Coldetail.item.Selected = True
    Try Coldetail.current.EnsureVisible()
  Endif
  
End

'* Pour les caractéristiques de la Mo.
Public Sub Enrg_Ligcar2()
  
  Tab = "Fiches_Ligbl"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlg.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , com_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlg.Text, Intit, "R", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlg.Text, Intit, "R", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les articles.
Public Sub Enrg_LigArt()
  
  Dim rm As String
  
  Tab = "Fiches_Ligbl"
  'IF typeL = "A" THEN Bloc = Nlgart.Text
  With Utils
    If bNet = True Then
      rm = "Net"
      bNet = False
    Else
      rm = Artrm.Text
    Endif
    If Cart.Text <> "" Or typeL = "E" Or typeL = "P" Or typeL = "D" Then
      rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
      If rResult.Available Then
        Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , code_ligbl = &3, libel_ligbl = &4, fam_ligbl = &5, pu_ligbl = &6, qte_ligbl = &7, brut_ligbl = &8, rem_ligbl = &9, netht_ligbl = &{10}, tx_ligbl = &{11}, nettc_ligbl = &{12}, typel_ligbl = &{13}, dec_ligbl = &{14}, pdstotal_ligbl = &{15}, mrgart_ligbl = &{16}, four_ligbl = &{17} WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Cart.Text, Artdsg.Text, ArtFam.Text, Artpu.Text, Artqte.Text, Artbrut.Text, rm, Artnet.Text, Arttx.Text, Arttc.Text, typeL, Dec.Text, Val(Pdxart.text), .PointBase(Marge.Text), ArtFour.Text)
      Else
        Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, pdstotal_ligbl, mrgart_ligbl, four_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", num.Text, Nlgart.Text, Cart.Text, Artdsg.Text, ArtFam.Text, Artpu.Text, Artqte.Text, Artbrut.Text, rm, Artnet.Text, Arttx.Text, Arttc.Text, typeL, Dec.Text, Bloc, Val(Pdxart.text), .PointBase(Marge.Text), ArtFour.Text)
      Endif
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour la mention promo.
Public Sub Enrg_Promo()
  
  Tab = "Fiches_Ligbl"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , libel_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, "*** Article " & Cart.text & " en promotion ***", "T", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, "*** Article " & Cart.text & " en promotion ***", "T", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour la deuxieme ligne de designation des articles.
Public Sub Enrg_LigArt2()
  
  Tab = "Fiches_Ligbl"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , libel_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Artdsg2, "T", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, Artdsg2, "T", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les caractéristiques du produit.
Public Sub Enrg_Ligcar()
  
  Tab = "Fiches_Ligbl"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , com_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Intit, "R", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, Intit, "R", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les commentaires
Public Sub Enrg_Ligcom()
  
  Tab = "Fiches_Ligbl"
  If Com.value Then typel = "C"
  If Bart.value Then typel = "A"
  If B2art.value Then typel = "A"
  If Motm.value Then typel = "M"
  rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgcom.text)
  If rResult.Available Then
    Utils.db.Exec("UPDATE  " & tab & "  SET num_ligbl = &1, numlig_ligbl = &2, code_ligbl =&3, com_ligbl = &4, typel_ligbl = &5 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgcom.Text, Comcode.Text, intitule.Text, typeL)
  Else
    Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", num.Text, Nlgcom.Text, Comcode.Text, intitule.Text, typeL, Nlgcom.text & Comcode.Text)
  Endif
  Coldetail.Clear
  Recup_ligbl()
  If modif = "0" Then
    Try Coldetail.MoveLast()
    Try Coldetail.item.Selected = True
    Try Coldetail.current.EnsureVisible()
  Endif
  
End

'* Pour les composants des produits composés.
Public Sub Enrg_Pdc(Cpdc As String, Lpdc As String, qpdc As String)
  
  Tab = "Fiches_Ligbl"
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , com_ligbl = &3, typel_ligbl = &4, code_ligbl = &5, libel_ligbl = &6, qte_ligbl = &7 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Intit, "O", Bloc, Cpdc, Lpdc, Qpdc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, com_ligbl, typel_ligbl, block_ligbl, code_ligbl, libel_ligbl, qte_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8)", num.Text, Nlgart.Text, Intit, "O", Bloc, Cpdc, Lpdc, Qpdc)
    Endif
  End With
  
End

'**********************************************************
'*    Renumerotation lignes Bl apres suppression          *
'**********************************************************
Public Sub Ren_ligbl()
  
  Dim Bloc2 As String
  Dim T As Integer = 1 ' variable pour init ligne
  
  If Coldetail.Count <> 0 Then
    Coldetail.MoveFirst
    Nlg.Text = "0001"
    Repeat
      Coldetail.item.Selected = True
      If Coldetail.current[9] = "C" Or If TypeL = "R" Then
        Coldetail.current[0] = Nlg.Text
        If Coldetail.current[16] = bloc Then
        Else
          Bloc2 = Nlg.Text
          Bloc = Coldetail.current[16]
          If T <> 1 Then Nlg.Text = Format$(Val(Nlg.Text) + 1, "0000")
          Coldetail.current[0] = Format$(Val(Nlg.Text), "0000")
          T = 0
        Endif
      Else
        If T <> 1 Then
          Nlg.Text = Format$(Val(Nlg.Text) + 1, "0000")
          Coldetail.current[0] = Format$(Val(Nlg.Text), "0000")
        Else
          Coldetail.current[0] = Format$(Val(Nlg.Text), "0000")
        Endif
        T = 0
      Endif
    Until Coldetail.MoveNext()
    If BArt.Value Or If B2art.value Then
      Nlgart.Text = Nlg.Text
      TypeL = "A"
    Endif
    If Motm.value Then
      Nlg.Text = Nlg.Text
      TypeL = "M"
    Endif
    If Com.value Then
      Nlgcom.Text = Nlg.Text
      TypeL = "C"
    Endif
  Else
    Nlg.Text = "0001"
    NlgArt.Text = "0001"
    NlgCom.Text = "0001"
  Endif
  
End

'**********************************************************
'*                       Maj Base                         *
'**********************************************************
Public Sub Maj_Base()
  
  Dim Intit As String = ""
  Dim lg As Integer = 0
  Dim l3 As String
  Dim l4 As String ' on recupere le numero de la derniere ligne du commentaire
  Dim Colitem0 As String
  Dim Colitem1 As String
  Dim Colitem9 As String
  Dim Colitem16 As String
  
  Tab = "Fiches_Ligbl"
  Utils.db.Exec("DELETE FROM " & tab & " where num_ligbl = &1", num.Text)
  Coldetail.MoveLast()
  Try Coldetail.item.Selected = True
  Try l5 = Coldetail.current[0]
  If Not Error Then
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
    Endif
    Repeat
      Coldetail.item.Selected = True
      Bloc = Coldetail.current[16]
      l3 = Bloc
      Colitem0 = Coldetail.current[0]
      Colitem1 = Coldetail.current[1]
      Colitem9 = Coldetail.current[9]
      Colitem16 = Coldetail.current[16]
      If Coldetail.current[9] <> "C" And If Coldetail.current[9] <> "R" Then
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl,  libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, mrgart_ligbl, mrgmo_ligbl, pdstotal_ligbl, four_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19})", num.Text, Coldetail.current[0], Coldetail.current[1], Coldetail.current[2], Coldetail.current[13], Coldetail.current[3], Coldetail.current[4], Coldetail.current[5], Coldetail.current[6], Coldetail.current[7], Coldetail.current[12], Coldetail.current[8], Coldetail.current[9], Coldetail.current[14], Coldetail.current[16], Coldetail.current[18], Coldetail.current[19], Coldetail.current[17], Coldetail.current[20])
      Else
        Repeat
          Coldetail.item.Selected = True
          If bloc <> Coldetail.current[16] Then Break
          If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "R" Then
            If lg = 1 Then intit = Intit & ("\n")
            intit = Intit & (Coldetail.current[2])
            lg = 1
            Bloc = Coldetail.current[16]
            l4 = Left$(Coldetail.current[0], 4)
          Else
            Break
          Endif
        Until Coldetail.Movenext()
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", num.Text, ColItem0, ColItem1, Intit, ColItem9, ColItem16)
        Intit = ""
        lg = 0
        If Val(l4) <> Val(l5) Then Coldetail.MovePrevious()
      Endif
    Until Coldetail.Movenext()
  Endif
  
End

'*****************************************
'*    Actualisation du libellé (casier)  *
'*****************************************
Public Sub Maj_libelle()
  
  If Coldetail.Count <> 0 And Settings["/Soc" & Start.Societe & "/Casier"] <> 0 And Impfac = "0" Then
    Coldetail.MoveFirst
    Repeat
      Coldetail.item.Selected = True
      If Coldetail.current[9] = "A" Then
        rResult = Utils.db.Exec("select * from " & Cbase.Table("TabArt") & " where art_code = &1", Coldetail.item[1])
        If rResult.Available Then
          If InStr(Coldetail.item[2], "~ ") <> 0 Then Try Coldetail.item[2] = Mid$(Coldetail.item[2], InStr(Coldetail.item[2], "~ ") + 2, Len(Coldetail.item[2]))
          If tp = "B" Or If tp = "F" Then
            If Not IsNull(rResult!art_casier) And If rResult!art_stocke And If (Val(Utils.cpoint(rResult!art_qte)) + Val(Utils.cpoint(Coldetail.current[4]))) > 0 Then 
              Coldetail.item[2] = rResult!art_casier & "~ " & Coldetail.item[2]
            Else
              If rResult!art_stocke And If (Val(Utils.cpoint(rResult!art_qte)) + Val(Utils.cpoint(Coldetail.current[4]))) <= 0 Then Coldetail.item[2] = "Rupt~ " & Coldetail.item[2]
            Endif
          Endif
          If Tp = "P" Or If tp = "C" Or If tp = "D" Then
            If Not IsNull(rResult!art_casier) And If rResult!art_stocke And If Val(Utils.cpoint(rResult!art_qte)) > 0 Then 
              Coldetail.item[2] = rResult!art_casier & "~ " & Coldetail.item[2]
            Else
              If rResult!art_stocke And If Val(Utils.cpoint(rResult!art_qte)) <= 0 Then Coldetail.item[2] = "Rupt~ " & Coldetail.item[2]
            Endif
          Endif
          If Not rResult!art_stocke Then Coldetail.item[2] = "Dep~ " & Coldetail.item[2]
          Try Utils.db.Exec("UPDATE  " & Cbase.Table("TabLigbl") & "  SET  libel_ligbl = &3 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Coldetail.item[0], Coldetail.item[2])
        Endif
      Endif
    Until Coldetail.Movenext()
  Endif
  
End

'*****************************************
'* Maj de la quantite en stock en moins  *
'*****************************************
Public Sub Maj_Quantite()
  
  Dim Qstock As Float
  Dim Qline As Float
  
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabArt") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE, " & Cbase.Table("TabLigbl") & " WRITE ")
  With utils
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.item.Selected = True
        'If Coldetail.Current[9] = "C" And Left$(Coldetail.Current[2], 19) = "Pièces en reliquat" Then Break
        If Coldetail.current[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Cbase.Table("TabArt") & " where art_code = &1", Coldetail.current[1])
          If rResult.Available Then
            Stk = rResult!art_stocke
            If Stk Then
              Qline = Val(Coldetail.current[4])
              Try Qstock = rResult!art_qte
              If Error Then Qstock = 0
              Qstock = Qstock - Qline
              Utils.db.Exec("UPDATE  " & Cbase.Table("TabArt") & "  SET art_qte = &2 WHERE art_code = &1", Coldetail.current[1], Qstock)
              If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.current[1], Cpromo)
              If Apromo = True Then ArtPromo.Maj_qteplus(Coldetail.current[1], Cpromo, Qline)
            Endif
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'**********************************************************
'*        Maj de la quantite en stock en plus            *
'**********************************************************
Public Sub Maj_Quantite2()
  
  Dim Qstock As Float
  Dim Qline As Float
  
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabArt") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE, " & Cbase.Table("TabLigbl") & " WRITE")
  With utils
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.item.Selected = True
        'If Coldetail.Current[9] = "C" And Left$(Coldetail.Current[2], 19) = "Pièces en reliquat" Then Break
        If Coldetail.current[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Cbase.Table("TabArt") & " where art_code = &1", Coldetail.current[1])
          If rResult.Available Then
            Stk = rResult!art_stocke
            If Stk Then
              Qline = Val(.cpoint(Coldetail.current[4]))
              Try Qstock = rResult!art_qte
              If Error Then Qstock = 0
              Qstock = Qstock + Qline
              Utils.db.Exec("UPDATE  " & Cbase.Table("TabArt") & "  SET art_qte = &2 WHERE art_code = &1", Coldetail.current[1], Qstock)
              If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.current[1], Cpromo)
              If Apromo = True Then ArtPromo.Maj_qtemoins(Coldetail.current[1], Cpromo, Qline)
            Endif
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'*****************************************
'* Maj de la quantite en stock en moins  *
'*****************************************
Public Sub Maj_QteDep()
  
  Dim Qstock As Float
  Dim Qline As Float
  
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabStkDepots") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
  With utils
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.item.Selected = True
        If Coldetail.Current[9] = "C" And Left$(Coldetail.Current[2], 19) = "Pièces en reliquat" Then Break
        If Coldetail.current[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Cbase.Table("TabStkDepots") & " where codea = &1 and coded = &2", Coldetail.current[1], Left$(Dep.Text, 2))
          If rResult.Available Then
            Qline = Val(Coldetail.current[4])
            Try Qstock = rResult!qte
            If Error Then Qstock = 0
            If qline < 0 Then
              Qstock = Qstock + Qline
            Else
              Qstock = Qstock - Qline
            Endif
            Utils.db.Exec("UPDATE  " & Cbase.Table("TabStkDepots") & "  SET qte = &3 WHERE codea = &1 and coded = &2", Coldetail.current[1], Left$(Dep.Text, 2), Qstock)
            If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.current[1], Cpromo)
            If Apromo = True Then ArtPromo.Maj_qteplus(Coldetail.current[1], Cpromo, Qline)
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'**********************************************************
'*        Maj de la quantite en stock en plus            *
'**********************************************************
Public Sub Maj_QteDep2()
  
  Dim Qstock As Float
  Dim Qline As Float
  
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabStkDepots") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
  With utils
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.item.Selected = True
        If Coldetail.Current[9] = "C" And Left$(Coldetail.Current[2], 19) = "Pièces en reliquat" Then Break
        If Coldetail.current[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Cbase.Table("TabStkDepots") & " where codea = &1 and coded = &2", Coldetail.current[1], Left$(Dep.Text, 2))
          If rResult.Available Then
            Qline = Val(.cpoint(Coldetail.current[4]))
            Try Qstock = rResult!qte
            If Error Then Qstock = 0
            If qline < 0 Then
              Qstock = Qstock - Qline
            Else
              Qstock = Qstock + Qline
            Endif
            Utils.db.Exec("UPDATE  " & Cbase.Table("TabStkDepots") & "  SET qte = &3 WHERE codea = &1 and coded = &2", Coldetail.current[1], Left$(Dep.Text, 2), Qstock)
            If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.current[1], Cpromo)
            If Apromo = True Then ArtPromo.Maj_qtemoins(Coldetail.current[1], Cpromo, Qline)
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'**********************************************************
'*                    Suppression Bon                     *
'**********************************************************
Public Sub Bl_Suppr()
  
  Dim Blrslt As Result
  Dim Tactive As String
  
  Tactive = "Fiches_Docactif"
  Tab2 = "Fiches_Ligbl"
  Tab = "Fiches_Bl"
  If Not IsNull(num.text)
    If start.son Then
      Music.Play
    Endif
    Blrslt = Utils.db.Exec("SELECT * FROM " & tab & " where numbl = &1", num.Text)
    If Blrslt.Count > 0 Then
      If Blrslt!imp = "1" Then
        If start.son Then
          Music.Play
        Endif
        Try Message.Warning("Suppression impossible, la facture a été imprimée !")
      Else
        If start.son Then
          Music.Play
        Endif
        If Message.Question("Etes-vous sur de vouloir supprimer ce bon ?", "Oui", "Non") = 1 Then
          Try Utils.db.Exec("DELETE FROM " & Tactive & " where numerobl = &1 and nom = &2", $numbl, User.name)
          Utils.db.Exec("DELETE FROM " & tab & " where numbl = &1", num.Text)
          Utils.db.Exec("DELETE FROM " & tab2 & " where num_ligbl = &1", num.Text)
          If Tp = "B" Or Tp = "F" Then
            If Panel8.visible = False Then
              'On met à jour le stock du produit
              Maj_Quantite2()
            Else
              'On met à jour le stock du depot
              Maj_QteDep2()
            Endif
          Endif
          CleanChamps()
          Coldetail.Clear
          Form_Open()
        Endif
      Endif
      code.Background = Color.TextBackground
      Button8.Visible = False
      Button6.Visible = True
    Endif
  Endif
  
End

'**********************************************************
'*   Activation de l'écran d'édition des documents        *
'**********************************************************
Public Sub Bl_Edit()
  
  Dim Blent As Result
  Dim rParam As Result
  Dim jnal As String
  Dim Vic As String
  Dim Vichq As String
  Dim Viautre As String
  Dim modreg As String
  
  Tab = "Fiches_Bl"
  Blent = Utils.db.Exec("SELECT cli_reg, cli_expl, cli_cdech FROM " & Cbase.Table("TabCli") & " where cli_code = &1", code.Text)
  modreg = Blent!cli_reg
  Nbexpl.text = Blent!cli_expl
  ech = Blent!cli_cdech
  If IsNull(Nbexpl.text) Then Nbexpl.text = "2"
  Blent = Utils.db.Exec("SELECT * FROM " & tab & " where numbl = &1", num.Text)
  If Rgmt.value Then
    Regmt.text = Blent!reg
    If IsNull(Regmt.Text) Then Regmt.Text = Modreg
  Else
    Regmt.text = ""
  Endif
  Imp = Blent!imp
  Dfac = Utils.Cdate_Aff(Blent!dtefac)
  Nmfac = Blent!numfac
  rParam = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
  If rParam.Available Then
    Jnal = rParam!jrnal2
    Vic = rParam!viremc
    Vichq = rParam!viremchq
    Viautre = rParam!virema
  Endif
  If Jnal = "" Or If Vic = "" Or If Vichq = "" Or If Viautre = "" Then
    If start.son Then
      Music.Play
    Endif
    Message.Error("Vous devez completer, dans les parametres, les données relatives au journal de caisse \net aux comptes de virements internes avant d'imprimer vos documents !")
  Else
    Edit.Visible = True
    If Imp <> "1" And BFac.value Then
      Rglt.text = Replace$(Tottc.Text, "-", "")
      If Settings["/Soc" & Start.Societe & "/Rglt"] Then
        Rgmt.Value = True
        HBox6.Visible = True
      Else
        HBox6.Visible = False
        Label1.visible = True
      Endif
      Rglt.ReadOnly = False
      Regmt.Enabled = True
      Rgmt.Enabled = True
    Else
      Rglt.Text = Blent!mtreg
      HBox6.Visible = True
      Rglt.ReadOnly = True
      Regmt.Enabled = False
      Rgmt.Enabled = False
    Endif
    Try Recap.Value = Settings["/Soc" & Start.Societe & "/Recap"]
    Try Impttc.Value = Settings["/Soc" & Start.Societe & "/Impttc"]
    Try Entete.Value = Settings["/Soc" & Start.Societe & "/Entete"]
    Try Reserve.Value = Settings["/Soc" & Start.Societe & "/Conditions"]
    Try Pied.Value = Settings["/Soc" & Start.Societe & "/Pied"]
    Try Imp2L.Value = Settings["/Soc" & Start.Societe & "/Imp2L"]
    Try Coln.value = Settings["/Soc" & Start.Societe & "/Col"]
    Try ChxImp.value = Settings["/Soc" & Start.Societe & "/ChxImp"]
    Try BlA5.Value = Settings["/Soc" & Start.Societe & "/BlA5"]
    Try Impstock.Value = Settings["/Soc" & Start.Societe & "/Impstocke"]
    Try ImpPDF.Value = Settings["/Soc" & Start.Societe & "/ImpPDF"]
    If Settings["/Soc" & Start.Societe & "/TxtF"] Then
      RegDef.Visible = True
      RegDef.value = True
    Else
      RegDef.Visible = False
      RegDef.value = False
      Regmt.text = Modreg
    Endif
    If Modreg = "Traite" Then
      If Imp <> "1" And BFac.value Then
        Regmt.text = Modreg
        Rglt.Text = Replace$(Tottc.Text, "-", "")
        Rgmt.value = True
        Label6.Visible = True
        Rglt.Visible = True
      Endif
    Endif
    If Impauto Or If Franchise Then
      Impttc.Enabled = False
      Impttc.value = False
    Endif
    If Not Error Then
      If Imp = "1" Then
        dtef.Text = Utils.Cdate_Aff(Blent!dtefac)
        dtef.ReadOnly = True
        Dtech.ReadOnly = True
        Regmt.text = Blent!reg
      Else
        dtef.Text = Format$(Now, "dd.mm.yyyy")
        dtef.ReadOnly = False
        Dtech.ReadOnly = False
      Endif
      If Imp = "1" Then
        Dtech.text = Utils.Cdate_Aff(Blent!ech)
      Else
        Dtech.text = dateEcheance(Ech)
      Endif
      If Dtech.text = ".." Then Dtech.text = Dtef.Text
      Aff_AdrC()
      If Colal.Count > 0 Then
        AffBledit2.Value = True
        Colal_Click()
        Edt_gotfocus()
      Endif
    Else
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Veuillez completer vos références SVP !", "OK")
    Endif
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub AffBledit2_Click()
  
  If AffBledit2.value = True Then
    If Edit2.Visible = False Then
      Edit2.Visible = True
      Nombl.SetFocus
      Blch.Value = False
    Endif
  Else
    Edit2.visible = False
    Blch.Value = True
  Endif
  
End

Public Sub Edt_KeyPress()
  
  With utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag
        Case 1
          Adr1bl.SetFocus
          Adr1bl.Select
          Stop Event
          
        Case 2
          Adr1bl.Text = .Remplace(Adr1bl.Text)
          Adr2bl.SetFocus
          Adr2bl.Select
          Stop Event
          
        Case 3
          Adr2bl.Text = .Remplace(Adr2bl.Text)
          cpbl.SetFocus
          cpbl.Select
          Stop Event
          
        Case 4
          villebl.SetFocus
          villebl.Select
          Stop Event
          
        Case 5
          villebl.Text = .Remplace(villebl.Text)
          dtef.SetFocus
          dtef.Select
          Stop Event
          
        Case 6
          dtef.Text = Quittedate2(dtef.Text, Imp)
          Dtech.text = dateEcheance(Ech)
          If B = "1" Then
            dtef.SetFocus
            Dtef.Select
          Else
            dtef.Background = Color.TextBackground
            Dtech.SetFocus
            Dtech.Select
          Endif
          Stop Event
          
        Case 7
          QuitteDateEch()
          If B = "1" Then
            Dtech.SetFocus
            Dtech.Select
          Else
            Dtech.Background = Color.TextBackground
            Button14.SetFocus
          Endif
          Stop Event
          
        Case 8
          Try Rglt.Text = Utils.CPoint(Rglt.Text)
          If Not Rglt.Text Then Rglt.Text = "0,00"
          Rglt.Text = Format$(Val(Rglt.Text), "0.00")
          Stop Event
          
        Case 9
          Try Rglt2.Text = Utils.CPoint(Rglt2.Text)
          If Not Rglt2.Text Then Rglt2.Text = "0,00"
          Rglt2.Text = Format$(Val(Rglt2.Text), "0.00")
          Stop Event
      End Select
    Endif
  End With
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
End

Public Sub Edt_gotfocus()
  
  Select Case Last.tag
    Case 6
      Try Utils.ObsGotf(dtef)
      Try Utils.ObsLstf(Dtech)
    Case 7
      Try Utils.ObsLstf(Dtef)
      Try Utils.ObsGotf(dtech)
  End Select
  
End

Public Sub Edt_LostFocus()
  
  Utils.ObsLstf(Last)
  Select Case Last.tag
    Case 8
      Try Rglt.Text = Utils.CPoint(Rglt.Text)
      If Not Rglt.Text Then Rglt.Text = "0,00"
      Rglt.Text = Format$(Val(Rglt.Text), "0.00")
      Stop Event
      
    Case 9
      Try Rglt2.Text = Utils.CPoint(Rglt2.Text)
      If Not Rglt2.Text Then Rglt2.Text = "0,00"
      Rglt2.Text = Format$(Val(Rglt2.Text), "0.00")
      Stop Event
  End Select
  
End

'**********************************************************
'*             On controle la date d'échéance             *
'**********************************************************

Public Sub QuitteDateEch()
  
  Dtech.text = Utils.CDate_calc(dtech.Text)
  Dtech.Text = Utils.Cdate_aff(Dtech.Text)
  If Dtech.Text = "00.00.0:00" Then
    Dtech.Text = Format$(Now, "dd.mm.yyyy")
    Dtech.SetFocus
    b = 1
  Else
    b = 0
  Endif
  
End

'**********************************************************
'*  On controle si la date du bon est dans les bornes     *
'**********************************************************
Public Sub QuitteDate()
  
  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dte = rResult!dtepc
  dte3 = Right$(dte, 4) & Left$(dte, 2)
  dte2 = rResult!dteclec
  ye2 = Right$(dte2, 4)
  If Not Settings["/Soc" & Start.Societe & "/Gestion"] Then Inc Ye2
  With utils
    Datej.text = .CDate_calc(datej.Text)
    Datej.Text = .Cdate_aff(Datej.Text)
    If IsNull(datej.Text) Or If datej.Text = ".." Then B = 1
    If Datej.Text = "00.00.0:00" Then
      Datej.Text = Format$(Now, "dd.mm.yyyy")
      Datej.SetFocus
    Else
      If datej.Text <> ".." Then
        If Right$(Datej.text, 4) & Mid$(Datej.text, 4, 2) <= dte3 Then
          If start.son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! La date saisie est inférieure au début de la période en cours.", "Ok") = 1 Then
            Datej.SetFocus
            B = 1
          Endif
        Endif
      Endif
    Endif
  End With
Catch
  
End

Public Function QuitteDate2(dteco As String, impt As String) As String
  
  Dim dte4 As String
  
  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dte = rResult!dtepp
  dte2 = Right$(dte, 4) & Left$(dte, 2)
  dte3 = rResult!dtepec
  If rResult!dtepec = "" Then
    Dte3 = Format$(Now, "mm.yyyy")
  Else
    dte3 = Right$(dte3, 4) & Left$(dte3, 2)
  Endif
  If rResult!dtepp = "" Then
    Dte2 = Format$(Now, "mm.yyyy")
  Else
    Dte2 = rResult!dtepp
    dte2 = Right$(dte, 4) & Left$(dte, 2)
  Endif
  With utils
    dteco = .CDate_calc(dteco)
    dteco = .Cdate_aff(dteco)
    dte4 = rResult!dteclec
    If dteco = "00.00.0:00" Then
      dteco = Format$(Now, "dd.mm.yyyy")
      Editfac = "0"
    Else
      If Bfac.value = True Then
        If Right$(dteco, 4) & Mid$(dteco, 4, 2) < dte2 Then
          If start.son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! Impression de facture impossible. \n La date saisie est inférieure à la période précédente. \n Veuillez faire vos clotures SVP !", "Ok") = 1 Then
            Editfac = "0"
            Dtef.SetFocus
            Dtef.Select
            B = "1"
          Endif
        Else
          If Right$(dteco, 4) & Mid$(dteco, 4, 2) > Left$(dte3, 4) & Format$(Val(Right$(dte3, 2)) + 1, "00") Then
            If start.son Then
              Music.Play
            Endif
            If Message.Warning("Attention ! Impression de facture impossible. \n La date saisie est supérieure à la période autorisée. \n Veuillez faire votre cloture mensuelle en facturation SVP", "Ok") = 1 Then
              Editfac = "0"
              Dtef.SetFocus
              Dtef.Select
              B = "1"
            Endif
          Else
            Editfac = "1"
            B = "0"
          Endif
        Endif
      Else
        b = "0"
      Endif
    Endif
  End With
  Return dteco
  
End

'**********************************************************
'*                Edition des documents                   *
'**********************************************************
Public Sub Button16_Click()
  
  Settings["/Soc" & Start.Societe & "/Recap"] = Recap.Value
  Settings["/Soc" & Start.Societe & "/Impttc"] = Impttc.Value
  Settings["/Soc" & Start.Societe & "/Entete"] = Entete.Value
  Settings["/Soc" & Start.Societe & "/Conditions"] = Reserve.Value
  Settings["/Soc" & Start.Societe & "/Pied"] = Pied.Value
  Settings["/Soc" & Start.Societe & "/Imp2L"] = Imp2L.Value
  Settings["/Soc" & Start.Societe & "/Col"] = Coln.Value
  Settings["/Soc" & Start.Societe & "/ChxImp"] = ChxImp.Value
  Settings["/Soc" & Start.Societe & "/BlA5"] = BlA5.Value
  Settings["/Soc" & Start.Societe & "/Impstocke"] = Impstock.Value
  Settings["/Soc" & Start.Societe & "/ImpPDF"] = ImpPDF.Value
  Settings.Save
  Settings.Reload
  Edit.Visible = False
  Edit2.Visible = False
  Visudoc = False
  AffBledit2.value = False
  
End

Public Sub Button21_Click()
  
  Visudoc = True
  QuitteDateEch()
  If b = 0 Then
    If Coldetail.count > 0 Then
      Impression("")
      Edit.Visible = False
    Else
      If start.son Then
        Music.Play
      Endif
      Message.Info("Visualisation impossible, vous n'avez saisi aucune ligne de détail !")
    Endif
  Endif
  b = 0
  
End

Public Sub Button14_Click()
  
  If visudoc = False Then Button14.Enabled = False
  Visudoc = False
  QuitteDateEch()
  If Val(Tottc.text) <> 0 And BFac.value Then
    If Rgmt.Value = True And IsNull(Rglt2.Text) And Not IsNull(Regmt.text) Then
      If IsNull(rglt.text) Then rglt.text = "0,00"
      If Val(Rglt.text) < Val(Tottc.text) Then
        Panel10.Visible = True
        Rglt2.Text = Format$(Val(Tottc.text) - Val(Rglt.text), "0.00")
      Else
        If b = 0 Then
          If Coldetail.count > 0 Then
            Impression("")
            Edit.Visible = False
          Else
            If start.son Then
              Music.Play
            Endif
            Message.Info("Impression impossible, vous n'avez saisi aucune ligne de détail !")
          Endif
        Endif
        b = 0
      Endif
    Else
      If b = 0 Then
        If Coldetail.count > 0 Then
          Impression("")
          Edit.Visible = False
        Else
          If start.son Then
            Music.Play
          Endif
          Message.Info("Impression impossible, vous n'avez saisi aucune ligne de détail !")
        Endif
      Endif
      b = 0
    Endif
  Else
    If Rgmt.Value = True And IsNull(regmt.Text) And Bfac.value And Imp <> "1" Then
      If start.son Then
        Music.Play
      Endif
      Try Message.Warning("Vous n'avez pas saisi le mode de règlement!")
      If visudoc = False Then Button14.Enabled = True
      Regmt.SetFocus
    Else
      If b = 0 Then
        If Coldetail.count > 0 Then
          Impression("")
          Edit.Visible = False
        Else
          If start.son Then
            Music.Play
          Endif
          Message.Info("Impression impossible, vous n'avez saisi aucune ligne de détail !")
        Endif
      Endif
      b = 0
    Endif
  Endif
  
End

Public Sub Button28_Click()
  
  Impression("")
  Edit.Visible = False
  
End

Public Function dateEcheance(Ech As String) As String
  
  Dim rech As Result
  Dim dureech As String
  Dim Jours As String
  Dim finmois As Boolean
  Dim Datef As String
  
  Tab4 = "Fiches_Echeances"
  If ech Then
    rech = Utils.db.Exec("SELECT * FROM " & tab4 & " where num = &1", Ech)
    If rech.available Then
      dureech = rech!duree
      Jours = rech!jours
      finmois = rech!finmois
      Ech = "1"
    Else
      Ech = "0"
    Endif
  Else
    Ech = "0"
  Endif
  If Ech = "1" Then
    Datef = dtef.Text
    dateech = Utils.Calcech(dureech, Jours, Finmois, Datef)
  Else
    dateech = dtef.Text
  Endif
  Return dateech
  
End

Public Sub BasFacture()
  
End

Public Sub Rembasfac_LostFocus()
  
  With Utils
    Rembasfac.Text = .CPoint(Rembasfac.Text)
    If Val(Rembasfac.Text) = Null Then
      If start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Rembasfac.SetFocus
      Rembasfac.Select
    Else
      If Val(Rembasfac.text) <> 0 Then
        tx = (1 + Ttva / 100)
        If sTTC.value = True Then Artpu.Text = Format$(Val(Utils.CPoint(Artpu.Text)) / Tx, "0.00")
        Textlabel30.text = "Prix HT"
        Artpu.Text = Format$(Val(Artpu.Text), Ar$)
        Artqte_LF()
        b = 0
      Else
        Rembasfac.text = "0,00"
      Endif
    Endif
    T = 0
  End With
  
End

Public Sub Impression(Org As String)
  
  Dim Tab1 As String
  Dim Tab5 As String
  Dim Tab6 As String
  Dim Tab7 As String
  Dim Tab8 As String
  Dim BlRslt As Result
  Dim Adr11 As String
  Dim Adr22 As String
  Dim Adr211 As String
  Dim Adr222 As String
  Dim Ville As String
  Dim Ville2 As String
  Dim Rs As String
  Dim Libre As String
  Dim Cde As String
  Dim Mail As String
  Dim Site As String
  Dim Rcs As String
  Dim Siret As String
  Dim Cap As String
  Dim Ape As String
  Dim Iban As String
  Dim Tel As String
  Dim portable As String
  Dim Fax As String
  Dim Ty, Ty2 As String
  Dim Stry As String[]
  Dim Code As String
  Dim intitule As String
  Dim Txtva As String
  Dim Pu As String
  Dim Qte As String
  Dim Puttc As String
  Dim brutht As String
  Dim bruttc As String
  Dim rem As String
  Dim Totht As String
  Dim Totttc As String
  Dim Cptlig As Integer = 0
  Dim Txtbf As String
  Dim P As Integer 'Flag pour lignes si pied de facture
  Dim Npage As Float ' Flag pour calcul nombre de page
  Dim Pge As Integer ' numero de page
  Dim Page As String
  Dim Teco, Teco2 As Float
  Dim Toteco, Toteco2, $solde2 As String
  Dim Tmo As String
  Dim Tart As String
  Dim Trem As String
  Dim ye As Integer
  Dim mo As String
  Dim da As String
  Dim ArtRslt As Result
  Dim Logo As Image
  Dim Imagewidth As Integer
  Dim Imageheight As Integer
  Dim Tvarslt As Result
  Dim Tvaintra As String
  Dim sline As String
  Dim Impdetail As Boolean = False
  Dim Tab9 As String
  Dim iskey As Integer = 0
  Dim Txt_ttc As String
  Dim Cfac, ImpRef As Boolean = False
  Dim Dateech2 As String
  Dim Datef2 As String
  Dim Nomclient As String
  
  variables.typel = ""
  
  Try ImpRef = Settings["/Soc" & Start.Societe & "/AffArt"]
  If Error Then ImpRef = False
  Editfac = "1"
  b = "0"
  Pge = 1
  Totht = "0,00"
  Totttc = "0.00"
  Teco = 0
  Teco2 = 0
  Imagewidth = 1000
  Imageheight = 500
  Tab1 = "Fiches_Bl"
  Tab2 = "Fiches_Societes"
  Tab3 = "Fiches_LibelFac"
  Tab4 = "Fiches_Echeances"
  Tab5 = "Fiches_Cli"
  Tab6 = "Fiches_Art"
  Tab7 = "Fiches_Mo"
  Tab8 = "Fiches_Tvaav"
  Tab9 = "Fiches_Parametres"
  Ventilation()
  If Settings["/Soc" & Start.Societe & "/glogo"] Then Try Logo = Image.Load(Settings["/Soc" & Start.Societe & "/Logo"])
  Shell "cd " & User.Home & ""
  Filename = User.home & "/Facture.pdf"
  If BlA5.value And Not Bfac.value Then
    pdf2 = New Cdocuments2("landscape", "mm", "A4")
    pdf2.Open()
    pdf2.AliasNbPages()
  Else
    pdf = New Cdocuments("Portrait", "mm", "A4")
    pdf.Open()
    pdf.AliasNbPages()
  Endif
  If b <> "1" Then
    Utils.db.Exec("LOCK TABLES " & "Fiches_Parametres" & " WRITE, " & "Fiches_AdrlivC" & " WRITE, " & "Fiches_Bl" & " WRITE, " & "Fiches_Ligbl" & " WRITE, " & "Fiches_Societes" & " WRITE," & "Fiches_LibelFac" & " WRITE, " & "Fiches_Echeances" & " WRITE, " & "Fiches_Cli" & " WRITE, " & "Fiches_Art" & " WRITE, " & "Fiches_Mo" & " WRITE," & Cbase.Table("TabTleg") & " WRITE, " & Cbase.Table("TabFam") & " WRITE, " & Cbase.Table("TabComptes") & " WRITE, " & Cbase.Table("TabMvt") & " WRITE, " & Cbase.Table("TabTvav") & " WRITE, " & Cbase.Table("TabHisFac") & " WRITE, " & "Totalisation" & " WRITE, " & "Fiches_Suivis" & " WRITE, " & "Docs_Clients" & " WRITE")
    With Utils
      ye = Right$(dtef.Text, 4)
      mo = Mid$(dtef.Text, 4, 2)
      da = Left$(dtef.Text, 2)
      Dtef.Text = Quittedate2(Dtef.Text, Imp) 'test si la date pour l'impression de la facture est bonne
      If b <> "1" Then
        If Editfac = "1" Then
          rResult = Utils.db.Exec("SELECT * FROM " & tab5 & " where cli_code = &1", Code3.Text)
          If Not rResult.Available Then Return
          Ech = rResult!cli_cdech
          Cfac = rResult!cli_copie
          If IsNull(Dtech.text) Then
            dateech = dateEcheance(Ech)
          Else
            dateech = Dtech.Text
          Endif
          Pays = rResult!cli_pays
          If Pays = "France" Then Pays = ""
          If Not IsNull(rResult!cli_id_tva) Then
            TvaCli = "TVA intracommunautaire " & rResult!cli_id_tva
          Else
            Tvacli = ""
          Endif
          Tmo = "0"
          Tart = "0"
          Trem = "0"
          Txtleg = ""
          Txtleg2 = ""
          If Not Regmt.Text Then
            If Settings["/Soc" & Start.Societe & "/TxtF"] Then
              If RegDef.value = True Then
                Txtleg = Settings["/Soc" & Start.Societe & "/LTxtF"]
              Else
                Txtleg = "Règlement au " & dateech
              Endif
            Else
              Txtleg = "Règlement au " & dateech
            Endif
          Else
            Txtleg = "Règlement par " & Regmt.Text & " au " & dateech
          Endif
          If Tp = "D" Then Txtleg = Settings["/Soc" & Start.Societe & "/Devis"]
          rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTleg") & "")
          If rResult.Available Then Txtleg2 = rResult!intitule
          Coldetail.MoveFirst
          Repeat
            Coldetail.item.Selected = True
            If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "R" Then
              intitule = Coldetail.current[2]
              For Each sline In Split(Intitule, "\n")
                Inc Cptlig
              Next
            Else
              Inc Cptlig
            Endif
          Until Coldetail.MoveNext()
          If Impttc.Value Then
            Txt_ttc = " TTC"
          Else
            Txt_ttc = " HT"
          Endif
          If Settings["/Soc" & Start.Societe & "/AutoEnt"] Or If Settings["/Soc" & Start.Societe & "/Franchise"] Then Txt_ttc = ""
          P = 31
          If Recap.Value = False And Pied.Value = False Then p = 34
          Npage = Cptlig / p
          If Npage = 0 Then Npage = 1
          If Cptlig < p Then Npage = 1
          If Cptlig > p Then
            Npage = Cptlig / 31
            Npage = Val(Format$(Npage, "##"))
            If Val(Right$(Str(Npage), 2)) > 56 Then Npage = Round(Npage) + 1
          Endif
          If Cptlig > p And Cptlig <= 56 Then Npage = 2
          Npage = Round(Npage)
          Page = "Page " & Pge
          rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & "")
          If rResult.Available Then Txtbf = rResult!txtfac
          Me.Mouse = Mouse.Wait
          Parametres()
          If Visudoc = False And Bfac.value And Imp = "0" Then Maj_Parametres()
          If Jnl Then
            rResult = Utils.db.Exec("SELECT * FROM " & "Fiches_Societes" & " where cd_sc = &1", Start.Societe)
            Rs = rResult!type_sc & " " & rResult!int_sc
            Libre = rResult!libre
            Adr11 = rResult!adr1_sc
            Adr22 = rResult!adr2_sc
            Ville = rResult!cp_sc & "  " & rResult!burdis_sc
            If rResult!villerc_sc Then Rcs = "RCS : " & rResult!rcs_sc & " " & rResult!villerc_sc
            If rResult!siret_sc Then Siret = Settings["/Soc" & Start.Societe & "/Siret"] & " : " & rResult!siret_sc
            If rResult!tvaintra_sc Then Tvaintra = "TVA intra : " & rResult!tvaintra_sc
            If rResult!cap_sc Then Cap = "Capital : " & rResult!cap_sc
            If rResult!ape_sc Then Ape = "NAF : " & rResult!ape_sc
            If rResult!tel_sc Then Tel = "Tél : " & rResult!tel_sc
            If rResult!port_sc Then Portable = "Portable : " & rResult!port_sc
            If rResult!fax_sc Then Fax = "Fax : " & rResult!fax_sc
            If rResult!email_sc Then Mail = "Courriel : " & rResult!email_sc
            If rResult!site Then Site = "Site : " & rResult!site
            If rResult!banq Then Iban = "Iban : " & rResult!banq & " Bic : " & rResult!bic
            If Tp = "C" Then ty = "Commande n° "
            If Tp = "B" Then ty = "Bon n° "
            If Tp = "D" Then ty = "Devis n° "
            If Tp = "P" Then ty = "Proforma n° "
            If Tp = "A" Then ty = "Abonnement n° "
            If Bfac.value And Val(Tottc.Text) >= 0 Then
              ty = "Facture n° "
            Endif
            If Bfac.value And Val(Tottc.Text) < 0 Then
              ty = "Avoir n° "
              Txtleg = ""
            Endif
            If Bfac.value And imp = "0" And Visudoc = True Then
              ty = "Bon n° "
            Endif
            If dtef.Text = "" Then
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning(" veuillez saisir une date d'édition Svp !", "Ok")
            Else
              If Bfac.value And Imp = "0" Then
                Jour = ty & Format$(Now, "yyyy") & nfac & " du " & dtef.Text
                Nmfac = Format$(Now, "yyyy") & nfac
              Else
                If Bfac.value And Imp = "1" Then
                  Jour = ty & Nmfac & " du " & Dfac
                Else
                  If Tp = "D" Then
                    Jour = ty & " " & num.Text & " " & " du " & datej.Text
                  Else
                    Jour = ty & " " & num.Text & " " & " du " & dtef.Text
                  Endif
                Endif
              Endif
              If Bfac.value And imp = "0" And Visudoc = True Then Jour = ty & Format$(Now, "yyyy") & num.Text & " du " & dtef.Text
              If Edit2.Visible = True And Not IsNull(Nombl.Text) Then
                Rs2 = Nombl.text
                Adr211 = Adr1Bl.Text
                Adr222 = Adr2Bl.Text
                Ville2 = CpBl.Text & " " & Villebl.Text
              Else
                Rs2 = Cv.Text & " " & Nom.Text & " " & Pnm.Text
                Adr211 = Adr1.Text
                Adr222 = Adr2.Text
                Ville2 = Cp.Text & " " & Burd.Text
              Endif
              Cde = "Code client " & Code3.text
              If Org = "Mail" Then
                EnvoiMail = "Mail"
              Else
                EnvoiMail = ""
              Endif
              If Entete.Value Or If Org = "Mail" Then
                If BlA5.value And Not Bfac.value Then
                  pdf2.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value)
                  pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, False)
                Else
                  pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value, Libre)
                  pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, False)
                Endif
              Else
                If BlA5.value And Not Bfac.value Then
                  pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                Else
                  pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                Endif
              Endif
              If BlA5.value And Not Bfac.value Then
                pdf2.Level1F(Jour, Cde, Page, TvaCli)
              Else
                pdf.Level1F(Jour, Cde, Page, TvaCli)
              Endif
              If Not IsNull(Dep.Text) Then pdf.Level1DP("Dépôt " & Dep.Text)
              If Livraison.value Then pdf.Level1LV()
              If Blch.value = True Then
                If BlA5.value And Not Bfac.value Then
                  PosY = 74
                  pdf2.Level2F(Coulfond, Impttc.Value, PosY)
                Else
                  PosY = 104
                  pdf.Level2F(Coulfond, Impttc.Value, PosY)
                Endif
              Else
                If BlA5.value And Not Bfac.value Then
                  PosY = 74
                  pdf2.Level2Fa(Coulfond, PosY)
                Else
                  PosY = 104
                  pdf.Level2Fa(Coulfond, PosY)
                Endif
              Endif
              Nbl = 0
              If BlA5.value And Not Bfac.value Then
                PosY = 78
              Else
                PosY = 110
              Endif
              If Coldetail.Count <> 0 Then
                If Settings["/Soc" & Start.Societe & "/Impbl"] And Bfac.Value Then
                  If BlA5.Value And Not Bfac.value Then
                    pdf2.Level4aF("BL numéro " & Num.text, PosY)
                    PosY = PosY + 4
                  Else
                    pdf.Level4aF("BL numéro " & Num.text, PosY)
                    PosY = PosY + 4
                  Endif
                Endif
                Coldetail.MoveFirst
                Repeat
                  Coldetail.item.Selected = True
                  Code = Coldetail.current[1]
                  intitule = Coldetail.current[2]
                  Txtva = Coldetail.current[12]
                  Pu = Coldetail.current[3]
                  If Len(pu) - InStr(pu, ",") = 2 Then pu = pu & " "
                  If Prxdec Then Try Pu = Round(Val(pu))
                  Qte = Coldetail.current[4]
                  Brutht = Coldetail.current[5]
                  If Len(Brutht) - InStr(Brutht, ",") = 2 Then Brutht = Brutht & " "
                  If Prxdec Then Try Brutht = Round(Val(Brutht))
                  Rem = Coldetail.current[6]
                  Totalht = Coldetail.current[7]
                  If Prxdec Then Try Totalht = Round(Val(Totalht))
                  typeL = Coldetail.current[9]
                  Totttc = Coldetail.current[8]
                  If Prxdec Then Try Totttc = Round(Val(Totttc))
                  If Remmo = "" Then Remmo = "0"
                  If Remart = "" Then Remart = "0"
                  If Rem = "" Then Rem = "0"
                  If rem <> "0" And Impttc.Value = False Then Trem = Trem + Val(brutht) - Val(totalht)
                  If totalht = "" Then totalht = "0,00"
                  If Brutht = "" Then Brutht = "0,00"
                  If Remmo = "" Then Remmo = "0,00"
                  If typeL = "M" Then Remmo = Val(.CPoint(Remmo)) + Val(.CPoint(Brutht)) - Val(.CPoint(Totalht))
                  If typeL = "A" Then Remart = Val(.CPoint(Remart)) + Val(Brutht) - Val(Totalht)
                  If typeL = "E" Or typeL = "P" Or typeL = "D" Then
                    Qte = ""
                    Pu = ""
                    Brutht = ""
                  Endif
                  If Val(.cpoint(Rem)) = 0 Then Rem = ""
                  If typeL <> "C" And typeL <> "T" And typeL <> "E" And TypeL <> "P" And TypeL <> "R" And TypeL <> "O" And typeL <> "D" Then
                    If Impttc.Value = True Then
                      If typeL = "A" Then
                        ArtRslt = Utils.db.Exec("SELECT * FROM " & tab6 & " where art_code = &1", Code)
                        Try Ardi = ArtRslt!art_cdarr
                        If Error Then ardi = "0"
                        Nbdec = ArtRslt!art_nbd
                        Nbdec = .Find_Nbdec(Nbdec)
                        If Tp = "B" And ArtRslt!art_stocke And Impstock.value Then 
                          Variables.typel = "B"
                          Variables.Qte = ArtRslt!art_qte
                        Else
                          Variables.typel = ""
                        Endif
                        If Prxdec Then 
                          ar$ = "0"
                        Else
                          ar$ = Nbdec
                        Endif
                        Impdetail = ArtRslt!art_impdetail
                        'Txtva = ArtRslt!art_tva
                        Tvarslt = Utils.db.Exec("select * from " & Tab8 & " where code_tva = &1", Txtva)
                        If Tvarslt.Available Then
                          Ttva = Tvarslt!taux_tva
                        Endif
                        If Ttva = 0 Or If exo.Value = True Then
                          Puttc = pu
                        Else
                          Puttc = Format$(Val(pu) + (Val(pu) * Ttva / 100))
                        Endif
                        Puttc = Format$(Val(Puttc), "0.00")
                        Puttc = Ard(Puttc)
                        If Prxdec Then Puttc = Round(Val(puttc))
                        If Len(puttc) - InStr(puttc, ",") = 2 Then puttc = puttc & "  "
                        If Ttva = 0 Or If exo.Value = True Then
                          Bruttc = brutht
                        Else
                          Bruttc = Format$(Val(Brutht) + (Val(Brutht) * Ttva / 100))
                        Endif
                        Bruttc = Format$(Val(Bruttc), "0.00")
                        Bruttc = Ard(Bruttc)
                        If Prxdec Then
                          Bruttc = Round(Val(Bruttc))
                        Else
                          If Len(Bruttc) - InStr(Bruttc, ",") = 2 Then Bruttc = Bruttc & "  "
                        Endif
                        If Ttva = 0 Or If exo.Value = True Then
                          Totttc = Totalht
                        Else
                          Totttc = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                        Endif
                        Totttc = Format$(Val(Totttc), "0.00")
                        Totttc = Ard(Totttc)
                        If Prxdec Then Totttc = Round(Val(Totttc))
                        If rem <> "0" Then
                          Trem = Val(Trem) + Val(bruttc) - Val(totttc)
                          If Prxdec Then Trem = Round(Val(Trem))
                        Endif
                        Tart = Format$(Val(Tart) + Val(Totttc), "0.00")
                      Else
                        If typeL = "M" Then
                          Nbdec = 2
                          Nbdec = .Find_Nbdec(Nbdec)
                          ArtRslt = Utils.db.Exec("SELECT * FROM " & tab7 & " where mo_code = &1", Code)
                          Try Ardi = ArtRslt!mo_cdarr
                          If Error Then
                            Me.mouse = Mouse.Default
                            If start.son Then
                              Music.Play
                            Endif
                            Message.Error("Il y a un souci avec le code " & code & " Impression impossible !")
                            Return
                          Endif
                          'Txtva = ArtRslt!mo_tva
                          Tvarslt = Utils.db.Exec("select * from " & Tab8 & " where code_tva = &1", Txtva)
                          If Tvarslt.Available Then
                            Ttva = Tvarslt!taux_tva
                          Endif
                          If Ttva = 0 Or If exo.Value = True Then
                            Puttc = pu
                          Else
                            Puttc = Format$(Val(pu) + (Val(pu) * Ttva / 100))
                          Endif
                          Puttc = Format$(Val(Puttc), Ar$)
                          Puttc = Ard(Puttc)
                          Puttc = Format$(Val(.cpoint(Puttc)), Ar$)
                          If Prxdec Then
                            Puttc = Round(Val(puttc))
                          Else
                            If Len(puttc) - InStr(puttc, ",") = 2 Then puttc = puttc & "  "
                          Endif
                          If Ttva = 0 Or If exo.Value = True Then
                            Bruttc = brutht
                          Else
                            Bruttc = Format$(Val(Brutht) + (Val(Brutht) * Ttva / 100))
                          Endif
                          Bruttc = Format$(Val(Bruttc), Ar$)
                          Bruttc = Ard(Bruttc)
                          Bruttc = Format$(Val(.cpoint(Bruttc)), Ar$)
                          If Prxdec Then Bruttc = Round(Val(Bruttc))
                          If Len(Bruttc) - InStr(Bruttc, ",") = 2 Then Bruttc = Bruttc & "  "
                          If Ttva = 0 Or If exo.Value = True Then
                            Totttc = Totalht
                          Else
                            Totttc = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                          Endif
                          Totttc = .cpoint(Ard(Totttc))
                          Totttc = Format$(Val(Totttc), Ar$)
                          If Prxdec Then Totttc = Round(Val(Totttc))
                          If Val(rem) <> "0" Or If Not IsNull(rem) Then Trem = Val(Trem) + Val(bruttc) - Val(totttc)
                          Tmo = Format$(Val(Tmo) + Val(Totttc), Ar$)
                        Endif
                      Endif
                      Trem = Format$(Val(.cpoint(Trem)), "0.00")
                      If Prxdec Then Trem = Round(Val(Trem))
                      totht = Format$(Val(totht) + Val(totttc), "0.00")
                      If Prxdec Then
                        Bruttc = Format$(Val(Bruttc), "0")
                        Puttc = Format$(Val(Puttc), "0")
                        Totttc = Format$(Val(Totttc), "0")
                        Puttc = Format$(Val(Puttc), "0")
                        Totttc = Format$(Val(Totttc), "0")
                      Endif
                      If Blch.Value = True Then
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Level3F(code, intitule, Puttc, qte, Bruttc, Rem, Totttc, Txtva, PosY)
                        Else
                          pdf.Level3F(code, intitule, Puttc, qte, Bruttc, Rem, Totttc, Txtva, PosY)
                        Endif
                      Else
                        Puttc = ""
                        Bruttc = ""
                        Rem = ""
                        Totttc = ""
                        Txtva = ""
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Level3F(code, intitule, Puttc, qte, Bruttc, Rem, Totttc, Txtva, PosY)
                        Else
                          pdf.Level3F(code, intitule, Puttc, qte, Bruttc, Rem, Totttc, Txtva, PosY)
                        Endif
                      Endif
                      PosY += 4
                    Else
                      If typeL = "A" Then
                        Tart = Format$(Val(Tart) + Val(totalht), "0.00")
                        ArtRslt = Utils.db.Exec("SELECT * FROM " & tab6 & " where art_code = &1", Code)
                        Try Impdetail = ArtRslt!art_impdetail
                        If Error Then Impdetail = False
                        If Tp = "B" And ArtRslt!art_stocke And Impstock.value Then 
                          Variables.typel = "B"
                          Variables.Qte = ArtRslt!art_qte
                        Else
                          Variables.typel = ""
                        Endif
                      Endif
                      If Prxdec Then
                        Tart = Round(Val(tart))
                        Tart = Format$(Val(Tart), "0")
                      Endif
                      If typeL = "M" Then Tmo = Format$(Val(Tmo) + Val(totalht), "0.00")
                      If Prxdec Then
                        Tmo = Round(Val(tmo))
                        Tmo = Format$(Val(Tmo), "0")
                      Endif
                      totht = Format$(Val(totht) + Val(totalht), "0.00")
                      If Prxdec Then
                        Totht = Round(Val(totht))
                        Totht = Format$(Val(Totht), "0")
                        Totalht = Format$(Val(totalht), "0")
                        Brutht = Format$(Val(Brutht), "0")
                        pu = Format$(Val(pu), "0")
                      Endif
                      If impref And Tp = "D" Then code = ""
                      If Blch.Value = True Then
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Level3F(code, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                        Else
                          pdf.Level3F(code, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                        Endif
                      Else
                        Pu = ""
                        Brutht = ""
                        Rem = ""
                        Totalht = ""
                        Txtva = ""
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Level3F(code, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                        Else
                          pdf.Level3F(code, intitule, Pu, qte, Brutht, Rem, Totalht, Txtva, PosY)
                        Endif
                      Endif
                      PosY += 4
                    Endif
                    Me.Mouse = mouse.Default
                    Maj_Totalisation()
                    If Cptvente = False Then
                      Cptvente = True
                      Me.mouse = Mouse.Default
                      Return
                    Endif
                  Endif
                  If typeL = "T" And Imp2L.Value = False Then
                    If BlA5.Value And Not Bfac.value Then
                      pdf2.Level4aF(intitule, PosY)
                      PosY += 4
                    Else
                      pdf.Level4aF(intitule, PosY)
                      PosY += 4
                    Endif
                  Endif
                  If typeL = "C" Or If Coldetail.current[9] = "R" Then
                    If BlA5.Value And Not Bfac.value Then
                      pdf2.Level4aF(intitule, PosY)
                      PosY = PosY + 4
                    Else
                      pdf.Level4aF(intitule, PosY)
                      PosY = PosY + 4
                    Endif
                  Endif
                  If typeL = "O" Then
                    If impdetail = True Then
                      If BlA5.Value And Not Bfac.value Then
                        pdf.Level8F(code, intitule, qte, PosY)
                        PosY = PosY + 4
                        Nbl = Nbl + 1
                      Else
                        pdf.Level8F(code, intitule, qte, PosY)
                        PosY = PosY + 4
                        Nbl = Nbl + 1
                      Endif
                    Endif
                  Endif
                  If typeL = "E" Then
                    Totalht = Coldetail.current[7]
                    If Blch.Value = True Then
                      If Impttc.Value = True Then
                        If Ttva = 0 Or If exo.Value = True Then
                          Totalht = Coldetail.current[7]
                        Else
                          Totalht = Coldetail.current[8]
                        Endif
                        intitule = "Dont " & Totalht & " " & devises & " TTC d' Eco-participation DEE"
                      Else
                        intitule = "Dont " & Totalht & " " & devises & " HT d' Eco-participation DEE"
                      Endif
                      If Settings["/Soc" & Start.Societe & "/AutoEnt"] Or If Settings["/Soc" & Start.Societe & "/Franchise"] Then intitule = "Dont " & Totalht & " " & devises & "  d' Eco-participation DEE"
                    Endif
                    Teco = Teco + Val(Totalht)
                    Coldetail.MoveNext()
                    Try Coldetail.item.Selected = True
                    If Not Error Then
                      If Coldetail.current[9] = "P" Then
                        Totalht = Coldetail.current[7]
                        If Impttc.Value = True Then
                          If Ttva = 0 Or If exo.Value = True Then
                            Totalht = Coldetail.current[7]
                          Else
                            Totalht = Coldetail.current[8]
                          Endif
                          If Settings["/Soc" & Start.Societe & "/AutoEnt"] Or If Settings["/Soc" & Start.Societe & "/Franchise"] Then
                            Intitule = Intitule & " et " & Totalht & " " & devises & " de taxe copie privée."
                          Else
                            Intitule = Intitule & " et " & Totalht & " " & devises & " TTC de taxe copie privée."
                          Endif
                        Else
                          If Settings["/Soc" & Start.Societe & "/AutoEnt"] Or If Settings["/Soc" & Start.Societe & "/Franchise"] Then
                            Intitule = Intitule & " et " & Totalht & " " & devises & " de taxe copie privée."
                          Else
                            Intitule = Intitule & " et " & Totalht & " " & devises & " HT de taxe copie privée."
                          Endif
                        Endif
                      Else
                        Coldetail.MovePrevious()
                        Coldetail.item.Selected = True
                      Endif
                    Endif
                    If Blch.Value = True Then
                      If BlA5.Value And Not Bfac.value Then
                        pdf2.Level4aF(intitule, PosY)
                        PosY = PosY + 4
                      Else
                        pdf.Level4aF(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                    Endif
                  Endif
                  
                  If typeL = "D" Then
                    Totalht = Coldetail.current[7]
                    If Blch.Value = True Then
                      If Impttc.Value = True Then
                        If Ttva = 0 Or If exo.Value = True Then
                          Totalht = Coldetail.current[7]
                        Else
                          Totalht = Coldetail.current[8]
                        Endif
                        intitule = "Dont " & Totalht & " " & devises & " TTC d' Eco-participation DEA"
                      Else
                        intitule = "Dont " & Totalht & " " & devises & " HT d' Eco-participation DEA"
                      Endif
                      If Settings["/Soc" & Start.Societe & "/AutoEnt"] Or If Settings["/Soc" & Start.Societe & "/Franchise"] Then intitule = "Dont " & Totalht & " " & devises & "  d' Eco-participation DEA"
                    Endif
                    Teco2 = Teco2 + Val(Totalht)
                    If Blch.Value = True Then
                      If BlA5.Value And Not Bfac.value Then
                        pdf2.Level4aF(intitule, PosY)
                        PosY = PosY + 4
                      Else
                        pdf.Level4aF(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                    Endif
                  Endif
                  If typeL = "P" Then
                    Totalht = Coldetail.current[7]
                    If Impttc.Value = True Then
                      If Ttva = 0 Or If exo.Value = True Then
                        Totalht = Coldetail.current[7]
                      Else
                        Totalht = Coldetail.current[8]
                      Endif
                      intitule = "Dont " & Totalht & " " & devises & " TTC de taxe copie privée."
                    Else
                      intitule = "Dont " & Totalht & " " & devises & " HT de taxe copie privée."
                    Endif
                    If Blch.Value = True Then
                      If BlA5.Value And Not Bfac.value Then
                        pdf2.Level4F(intitule, PosY)
                        PosY = PosY + 4
                      Else
                        pdf.Level4F(intitule, PosY)
                        PosY = PosY + 4
                      Endif
                    Endif
                  Endif
                  If typel <> "O" Then Nbl = Nbl + 1
                  If Npage > 1 Then
                    If Nbl >= 40 And Val(acpt.Text) = 0 And Not BlA5.value Or If Nbl >= 40 And Val(acpt.Text) > 0 And Not BlA5.value Or If Nbl >= 28 And Val(acpt.Text) = 0 And BlA5.value Or If Nbl >= 28 And Val(acpt.Text) > 0 And BlA5.value Then
                      Inc Pge
                      Page = "Page " & Pge
                      If Prxdec Then
                        Totht = Round(Val(Totht))
                        Totht = Format$(Val(Totht), "0")
                      Endif
                      If Blch.Value = True Then
                        If BlA5.Value And Not Bfac.value Then
                          
                        Else
                          pdf.Level12F(Totht, PosY, Devises)
                        Endif
                      Endif
                      If Entete.Value Or If Org = "Mail" Then
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value)
                          pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                        Else
                          pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value, Libre)
                          pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, False)
                        Endif
                      Else
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                        Else
                          pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                        Endif
                      Endif
                      If BlA5.Value And Not Bfac.value Then
                        pdf2.Level1F(Jour, Cde, Page, TvaCli)
                      Else
                        pdf.Level1F(Jour, Cde, Page, TvaCli)
                      Endif
                      If Not IsNull(Dep.Text) Then
                        If BlA5.Value And Not Bfac.value Then
                          pdf2.Level1DP("Dépôt " & Dep.Text)
                          PosY = 74
                        Else
                          pdf.Level1DP("Dépôt " & Dep.Text)
                          PosY = 104
                        Endif
                      Endif
                      
                      If Blch.value = True Then
                        If BlA5.value And Not Bfac.value Then
                          PosY = 74
                          pdf2.Level2F(Coulfond, Impttc.Value, PosY)
                        Else
                          PosY = 104
                          pdf.Level2F(Coulfond, Impttc.Value, PosY)
                        Endif
                      Else
                        If BlA5.value And Not Bfac.value Then
                          PosY = 74
                          pdf2.Level2Fa(Coulfond, PosY)
                        Else
                          PosY = 104
                          pdf.Level2Fa(Coulfond, PosY)
                        Endif
                      Endif
                      Nbl = 0
                      If BlA5.value And Not Bfac.value Then
                        PosY = 78
                      Else
                        PosY = 110
                      Endif
                    Endif
                  Endif
                Until Coldetail.MoveNext()
              Endif
            Endif
            If Settings["/Soc" & Start.Societe & "/Totstring"] Then
              $solde2 = "Total document : " & Numtostring.Convertir(Val(.cpoint(Tottc.text)), devises)
              PosY = PosY + 2
              pdf.Level4RB($solde2, PosY)
              PosY = PosY + 4
            Endif
            If Nbl > P Then
              Inc Pge
              Page = "Page " & Pge
              If Blch.Value = True Then
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level12F(Totht, PosY, Devises)
                Else
                  pdf.Level12F(Totht, PosY, Devises)
                Endif
              Endif
              If Entete.Value Or If Org = "Mail" Then
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value)
                  pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                Else
                  pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.value, Libre)
                  pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, False)
                Endif
              Else
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                Else
                  pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.value, True)
                Endif
              Endif
              If BlA5.Value And Not Bfac.value Then
                pdf2.Level1F(Jour, Cde, Page, TvaCli) 
              Else
                pdf.Level1F(Jour, Cde, Page, TvaCli)
              Endif
              If Not IsNull(Dep.Text) Then
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level1DP("Dépôt " & Dep.Text)
                  PosY = 104
                Else
                  pdf.Level1DP("Dépôt " & Dep.Text)
                  PosY = 104
                Endif
              Endif
              If Blch.value = True Then
                If BlA5.value And Not Bfac.value Then
                  PosY = 74
                  pdf2.Level2F(Coulfond, Impttc.Value, PosY)
                Else
                  PosY = 104
                  pdf.Level2F(Coulfond, Impttc.Value, PosY)
                Endif
              Else
                If BlA5.value And Not Bfac.value Then
                  PosY = 74
                  pdf2.Level2Fa(Coulfond, PosY)
                Else
                  PosY = 104
                  pdf.Level2Fa(Coulfond, PosY)
                Endif
              Endif
              Nbl = 0
            Endif
          Endif
          If BlA5.value And Not Bfac.value Then
            If Not Recap.Value Or Not Pied.Value Then
              posy = 140
            Else
              posy = 120
            Endif
          Else
            If Not Recap.Value Or Not Pied.Value Then
              posy = 249
            Else
              posy = 241
            Endif
          Endif
          If Blch.Value = True Then
            If Teco <> 0 Or If Teco2 <> 0 Then
              If Prxdec Then
                Toteco = Round(Val(.cpoint(Teco)))
                Toteco = Format$(Val(Toteco), "0")
                Toteco2 = Round(Val(.cpoint(Teco2)))
                Toteco2 = Format$(Val(Toteco2), "0")
              Else
                Toteco = Format$(Teco, "0.00")
                Toteco2 = Format$(Teco2, "0.000")
              Endif
              If Teco <> 0 Then
                Toteco = "  Total Eco-participation DEE : " & Toteco & " " & devises & Txt_ttc
              Else
                Toteco = ""
              Endif
              If Teco2 <> 0 Then Toteco = Toteco & "            Total Eco-participation DEA : " & Toteco2 & " " & devises & Txt_ttc
              If Not Settings["/Soc" & Start.Societe & "/Libdevis"] Then 
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level5F(TotEco, PosY)
                Else
                  pdf.Level5F(TotEco, PosY)
                Endif
                Nbl = Nbl + 1
              Endif
            Endif
          Endif
          If Blch.Value = True Then
            If Impttc.Value Then
              If Val(Trem) <> 0 Then
                Trem = "Total remise : " & Trem & Txt_ttc
              Else
                Trem = ""
              Endif
              If Val(Tart) <> 0 Then
                Tart = "Total article : " & Tart & Txt_ttc
              Else
                Tart = ""
              Endif
              If Val(Tmo) <> 0 Then
                If Prxdec Then
                  Tmo = Round(Val(Tmo))
                  Tmo = Format$(Val(Tmo), "0")
                Endif
                Tmo = "Total MO : " & Tmo & Txt_ttc
              Else
                Tmo = ""
              Endif
            Else
              If Val(Totrem.text) <> 0 Then
                If Prxdec Then
                  Try Trem = Round(Val(Totrem.text))
                  Try Trem = Format$(Val(Trem), "0")
                  Trem = "Total remise : " & Trem & Txt_ttc
                Else
                  Trem = "Total remise : " & Totrem.Text & Txt_ttc
                Endif
              Else
                Trem = ""
              Endif
              If Val(Tart) <> 0 Then
                If Prxdec Then
                  Tart = Round(Val(tart))
                  Tart = Format$(Val(Tart), "0")
                Endif
                Tart = "Total article : " & Tart & Txt_ttc
              Else
                Tart = ""
              Endif
              If Val(Tmo) <> 0 Then
                If Prxdec Then
                  Tmo = Round(Val(Tmo))
                  Tmo = Format$(Val(Tmo), "0")
                Endif
                Tmo = "Total MO : " & Tmo & Txt_ttc
              Else
                Tmo = ""
              Endif
            Endif
            If BlA5.value And Not Bfac.value Then
              posy = 144
            Else
              posy = 241
            Endif
            If tp <> "D" Then
              If Pied.Value And Recap.Value Then
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Else
                  pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Endif
              Endif
              If Recap.Value And Not Pied.Value Then
                Txtbf = ""
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Else
                  pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Endif
              Endif
              If Not Recap.Value And Pied.Value Then
                Tmo = ""
                Tart = ""
                Trem = ""
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Else
                  pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
                  PosY = PosY + 4
                Endif
              Endif
            Else
              If Settings["/Soc" & Start.Societe & "/Libdevis"] Then 
                If BlA5.Value And Not Bfac.value Then
                  pdf2.Level16F()
                Else
                  pdf.Level16F() 
                Endif
              Endif
            Endif
          Endif
          If BlA5.value And Not Bfac.value Then
            posy = 160
          Else
            posy = 255
          Endif
          If Blch.Value = True Then
            If BlA5.Value And Not Bfac.value Then
              pdf2.Level7F(Coulfond, PosY, ImpAuto, Franchise, Exo.value)
              PosY = PosY + 5
            Else
              pdf.Level7F(Coulfond, PosY, ImpAuto, Franchise, Exo.value)
              PosY = PosY + 5
            Endif
          Endif
          Calc_tva(Org)
          If Org = "Mail" And Not IsNull(Settings["/Soc" & Start.Societe & "/FactcheminV"]) Then
            If Exist(Settings["/Soc" & Start.Societe & "/FactcheminV"]) Then
              pdf.EnteteV()
              Posy = 4
              For Each intitule In Split(File.Load(Settings["/Soc" & Start.Societe & "/FactcheminV"]), "\n")
                pdf.Level4V(intitule, Posy)
                Posy = Posy + 3
              Next
            Else
              Message.Error("le fichier des conditions de ventes défini dans les préférences n'existe pas !")
            Endif
          Endif
          If BlA5.Value And Not Bfac.value Then
            pdf2.Output(Filename, False)
          Else
            pdf.Output(Filename, False)
          Endif
          If Left(Org, 1) <> "M" Then
            If Visudoc = True Then
              Visualiseur.Prog_Editeur(Filename)
            Else
              If BlA5.value And Not Bfac.value Then
                Impressfac.Prog_Editeur(Filename, 1, ChxImp.value)
              Else
                Impressfac.Prog_Editeur(Filename, Val(Nbexpl.text), ChxImp.value)
              Endif
            Endif
          Endif
          If Tp = "C" Then ty = "Commande"
          If Tp = "B" Then ty = "Bon"
          If Tp = "D" Then ty = "Devis"
          If Tp = "P" Then ty = "Proforma"
          If Bfac.value And Val(Tottc.Text) > 0 Then
            ty = "Facture"
          Endif
          If Bfac.value And Val(Tottc.Text) < 0 Then
            ty = "Avoir"
            Txtleg = ""
          Endif
          If Bfac.value And imp = "0" And Visudoc = True Then
            ty = "Bon"
          Endif
          Copie.Dupli("Facture.pdf", "/Impressions", ty, dtef.Text)
          sPiece = Copie.spiece
          If Cfac And Not Visudoc Then
            Nomclient = Replace$(Nom.Text, " ", "")
            Nomclient = Replace$(Nomclient, "/", "")
            Nomclient = Replace$(Nomclient, "'", "")
            If Bfac.value And Not Visudoc Then
              ty = Left$(ty, 1) & Nmfac & Nomclient
            Else
              ty = Left$(ty, 1) & num.Text & Nomclient
              If Imp = "1" Then ty = Left$(ty, 1) & Nmfac & Nomclient
            Endif
            Stry = Split(ty, " ")
            ty = ""
            For Each ty2 In Stry
              ty = ty & ty2
            Next
            Try Copie.Dupli2("Facture.pdf", User.home & "/Impressions", ty, dtef.Text, Code3.text, "Facs")
            If Error Then
              If start.son Then
                Music.Play
              Endif
              message.Warning("La copie du fichier pdf ne peut pas être effectuée !\nVeuillez vérifier le chemin dans les préférences SVP.")
            Endif
            sPiece = Copie.spiece
          Endif
          If Org = "Mail" Then
            Nomclient = Replace$(Nom.Text, " ", "")
            Nomclient = Replace$(Nomclient, "/", "")
            Nomclient = Replace$(Nomclient, "'", "")
            If Bfac.value Then
              ty = Left$(ty, 1) & Nmfac
            Else
              ty = Left$(ty, 1) & num.Text
            Endif
            Stry = Split(ty, " ")
            ty = ""
            For Each ty2 In Stry
              ty = ty & ty2
            Next
            If cfac Then Try Copie.Dupli2("Facture.pdf", "/Impressions", ty, dtef.Text, Code3.text, "Facs")
            If Error Then Print Error.text
            sPiece = Copie.spiece
          Endif
          If Visudoc = False And Bfac.value And Imp = "0" Then
            Edit.Visible = False
            Edit2.Visible = False
            'Maj_Parametres()
            BlRslt = Utils.db.Exec("SELECT * FROM " & tab1 & " where numbl = &1", num.Text)
            Nfac = Right$(Dtef.text, 4) & Nfac
            Utils.db.Exec("UPDATE  " & Tab1 & "  SET  imp = &2, numfac = &3, reg = &4, ech = &5 , dtefac = &6, mtreg = &7, type = &8 WHERE numbl = &1", num.Text, "1", Nfac, regmt.Text, .Cdate_Dbase(Dtech.text), .Cdate_Dbase(Dtef.Text), Rglt.Text, "F")
            Verif_solde()
            Maj_Compta()
            Maj_Suivis()
            Utils.db.Exec("UNLOCK TABLES")
            If cfac Then Copie.Dupli2CPT(numrd, copie.spiece, Code3.text, ty)
            If Upper$(Regmt.Text) = "TRAITE" Or If Upper$(Regmt.Text) = "LCR" Then Maj_Traite()
            Form_Open()
          Else
            If Visudoc = False Then Utils.db.Exec("UPDATE  " & Tab1 & "  SET  ech = &2 WHERE numbl = &1", num.Text, .Cdate_Dbase(dateech))
          Endif
        Else
          If start.son Then
            Music.Play
          Endif
          Try Message.Warning(" Impression impossible ! Veuillez saisir un code journal dans les parametres Svp !", "Ok")
        Endif
      Endif
    End With
    Utils.db.Exec("UNLOCK TABLES")
    Me.Mouse = Mouse.Default
    Visudoc = False
    If Not IsNull(num.text) Then
      Repeat
        Try Colbl.MoveTo(iskey, 0)
        Inc iskey
      Until colbl[colbl.row, 2].Text = num.text
    Endif
    datef2 = dtef.text
    dateech2 = dateech
    Colbl_Click()
    Dtech.Text = dateech2
    dtef.text = datef2
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default
  
End

Public Sub Maj_Traite()
  
  Dim Traite As String
  Dim Accept As Boolean = False
  
  If Regmt.Text = "Traite" Then
    Accept = True
  Else
    Accept = False
  Endif
  Traite = "Fiches_Traites"
  Utils.db.Exec("insert into  " & Traite & "  (code, nom, numfac, montant, datech, date, acceptee, ecartee) value (&1, &2, &3, &4, &5, &6, &7, &8)", Code3.Text, Nom.text, Nfac, rglt.Text, Utils.Cdate_Dbase(dateech), Utils.Cdate_Dbase(dtef.Text), Accept, 0)
  
End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Function ard(Puttc As String) As String
  
  If Not PuTTc Then PuTTc = "0,00"
  If ardi = "0,05" Then
    If Right$(Puttc) Like "[34567]*" Then
      Puttc = Left$(Puttc, (Len(Puttc) - 1)) & "5"
    Else
      Puttc = Round(Val(Puttc), -1)
      If typeL = "A" Then Puttc = Format$(Puttc, Ar$)
    Endif
  Endif
  
  If ardi = "0,10" Then
    Puttc = Round(Val(Puttc), -1)
    If typeL = "A" Then Puttc = Format$(Puttc, Ar$)
  Endif
  
  If ardi = "0,50" Then
    If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 25)) Then
      Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "00"
    Else
      If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 75)) Then
        Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "50"
      Endif
      If Abs(Val(Puttc)) >= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 76)) Then
        Puttc = Round(Val(Puttc))
        If typeL = "A" Then Puttc = Format$(Puttc, Ar$)
      Endif
    Endif
  Endif
  
  If ardi = "1,00" Then
    Puttc = Round(Val(Puttc))
    If typeL = "A" Then Puttc = Format$(Puttc, Ar$)
  Endif
  Return Puttc
  
End

'**********************************************************
'*                   Recup parametres                     *
'**********************************************************
Public Sub Parametres()
  
  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    Nfac = rResult!dnfac
    Jnl = rResult!jrnal
  Endif
  Nfac = Format$(Val(Nfac) + 1, "000000")
  
End

'**********************************************************
'*                   Maj parametres                     *
'**********************************************************
Public Sub Maj_Parametres()
  
  Tab = "Fiches_Parametres"
  With Utils
    Nfac = Val(Nfac)
    Nfac = Format$(Nfac, "000000")
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnfac = &1", Nfac)
  End With
  
End

'**********************************************************
'*      Creation table temporaire pour totalisation       *
'**********************************************************
Public Sub Ventilation()
  
  Utils.db.Exec("DROP TABLE IF EXISTS  Totalisation")
  Utils.db.Exec("CREATE TABLE " & Cbase.Table("Totalisation") &
    "(compte Char(8) NOT NULL," &
    "intitule Char(25)," &
    "totalht Char(15)," &
    "totaltva Char(15)," &
    "codetva Char(1) NOT NULL," &
    "PRIMARY KEY (compte,codetva))" & "ENGINE = MYISAM")
  Utils.db.Exec("INSERT INTO " & Cbase.Table("Totalisation") & "(compte, intitule, totalht, codetva) VALUES (&1, &2, &3, &4)", Code.Text, Nom.Text, Tottc.Text, ".")
  
End
'**********************************************************
'*                   Maj Totalisation                     *
'**********************************************************

Public Sub Maj_Totalisation()
  
  Dim Mtva As String
  Dim Totht As String
  Dim Tottva As String
  Dim Remise As String
  Dim hresult As Result
  
  Tab = "Fiches_Fam"
  Tab5 = "Totalisation"
  Tab4 = "Fiches_Tvaav"
  TotTva = "O.OO"
  With utils
    'Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE, " & Cbase.Table("TabComptes") & " WRITE")
    ' On recupere le compte vente et le code TVa de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " Where code_fam = &1", Coldetail.current[13])
    If rResult.Available Then
      If tvar.value = True Then
        Cpt = rResult!compt2_fam
      Else
        Cpt = rResult!compt_fam
      Endif
      If IsNull(Cpt) Then
        If start.son Then
          Music.Play
        Endif
        Message.Error("Impression impossible ! La famille " & Coldetail.current[13] & " ne possède pas de compte vente")
        Cptvente = False
      Endif
      Ctva = Coldetail.current[12]
      CptRem = rResult!cptrem_fam
      If IsNull(CptRem) Then
        If start.son Then
          Music.Play
        Endif
        Message.Error("Impression impossible ! La famille " & Coldetail.current[13] & " ne possède pas de compte de remise")
        Cptvente = False
      Endif
    Endif
    ' On recupere les données du compte vente de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpt)
    If rResult.Available Then
      Intit = rResult!intitule_cc
    Endif
    'On recupere le compte de TVA et son taux de TVA
    rResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " Where code_tva = &1", Ctva)
    If rResult.Available Then
      Cpttva = rResult!cc_tva
      Ttva = rResult!taux_tva
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpttva)
    If rResult.Available Then
      IntitTva = rResult!intitule_cc
    Endif
    'On calcule le montant de la TVA
    Mtva = Format$(Val(.CPoint(Coldetail.current[8])) - (Val(.CPoint(Coldetail.current[7]))), "0.000")
    If IsNull(Mtva) Then Mtva = "0.000"
    'Si ce n'est pas un compte TVA regarde si le compte existe deja dans la table temporaire
    If Left$(Cpt, 4) <> "4457" Then
      hresult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 AND Codetva = &2", Cpt, 0)
    Else
      'Sinon on recupere le compte TVA correspondant au taux
      hresult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and Codetva = &2", Cpt, Ctva)
    Endif
    'Si le compte existe dans la table temporaire
    If hresult.Available Then
      'Si ce n'est pas un client on calcule le HT et le montant de la TVA
      Totht = Format$(Val(Utils.CPoint(hresult!totalht)) + Val(Utils.CPoint(Coldetail.current[7])), "0.000")
      TotTva = Format$(Val(.CPoint(hresult!totaltva)) + Val(.CPoint(Mtva)), "0.000")
      If Prxdec Then
        Totht = Round(Val(Totht))
        TotTva = Round(Val(TotTva))
      Endif
      'Si ce n'est pas un compte TVA on met a jour sans le code TVA
      If Left$(Cpt, 4) <> "4457" Then
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva = &4 Where compte = &1 and codetva = &5", Cpt, Intit, Totht, TotTva, 0)
      Else
        'Si c'est un compte TVA on met a jour avec le code TVA
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva =&4 Where compte = &1 and codetva = &5", Cpt, Intit, Totht, TotTva, Ctva)
      Endif
      'ENDIF
    Else
      'Si le compte n'existe pas dans la table temporaire
      Totht = Format$(Val(.CPoint(Coldetail.current[7])), "0.000")
      If Prxdec Then Totht = Round(Val(Totht))
      'Si ce n'est pas un compte TVA on crée avec un code TVA a zéro
      If Left$(Cpt, 4) <> "4457" Then
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", Cpt, Intit, Totht, Mtva, 0)
      Else
        'Sinon on crée avec le code TVA
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", Cpt, Intit, Totht, Mtva, Ctva)
      Endif
    Endif
    If Not IsNull(Cpttva) And If exo.Value = False Then
      hresult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and codetva = &2", Cpttva, Ctva)
      If hresult.Available Then
        TotTva = Format$(Val(.CPoint(hresult!totaltva)) + Val(.CPoint(Mtva)), "0.000")
        Totht = Format$(Val(.CPoint(hresult!totalht)) + Val(.CPoint(Coldetail.current[7])), "0.000")
        If Prxdec Then 
          TotTva = Round(Val(TotTva))
          Totht = Round(Val(Totht))
        Endif
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule =&2, totaltva =&3, codetva = &4, totalht = &5 Where compte = &1 and codeTva = &4", Cpttva, Intittva, Tottva, Ctva, Totht)
      Else
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totaltva, codetva, totalht) VALUES (&1, &2, &3, &4, &5)", Cpttva, Intittva, Mtva, Ctva, totht)
      Endif
    Endif
    Totht = 0
    Remise = 0
    'Utils.db.Exec("UNLOCK TABLES")
  End With
  
End

Public Sub Verif_solde()
  
  Dim hResult As Result
  Dim sCompte As String
  Dim sTotalD As String = "0"
  Dim sTotalC As String = "0"
  Dim sdif As Float
  
  With utils
    hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " order by compte")
    If hResult.Available Then
      Repeat
        If Left$(hResult!compte, 3) = "411" Or If Left$(hResult!compte, 3) = "453" Then
          sTotalD = hResult!totalht
        Else
          If Left$(hResult!compte, 3) = "445" Then
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totaltva))
          Else
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totalht))
          Endif
          sCompte = hResult!compte
        Endif
      Until hResult.MoveNext()
      hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " Where compte = &1", sCompte)
      If Val(.cpoint(sTotalD)) < Val(.cpoint(sTotalC)) Then
        sDif = Val(.cpoint(sTotalC)) - Val(.cpoint(sTotalD))
        sDif = Val(.cpoint(hResult!totalht)) - sDif
        Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
      Else
        If Val(.cpoint(sTotalD)) > Val(.cpoint(sTotalC)) Then
          sDif = Val(.cpoint(sTotalD)) - Val(.cpoint(sTotalC))
          sDif = Val(.cpoint(hResult!totalht)) + sDif
          Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
        Endif
      Endif
    Endif
  End With
  
End

'**********************************************************
'*                   Maj comptabilité                     *
'**********************************************************
Public Sub Maj_Compta()
  
  Dim Cpt, $intitule As String
  Dim coll As String
  Dim collectif As String
  Dim Libel As String
  Dim Mtc As Float
  Dim Mtd As Float
  Dim Sld As Float
  Dim Valid As Integer
  Dim Prov As Integer
  Dim Tresor As Integer
  Dim Pointee As Integer
  Dim Lettree As Integer
  Dim Cloturee As Integer
  Dim Relance As Integer
  Dim hResult As Result
  Dim Param, jr As Result
  Dim jnal As String
  Dim Vic As String
  Dim Vichq As String
  Dim Viautre As String
  Dim Cptreglt As String
  
  Tab = "Fiches_Mvt"
  Tab2 = "Totalisation"
  Tab4 = "Fiches_Parametres"
  Tab5 = "Fiches_Journaux"
  Tab6 = "Fiches_Cli"
  Valid = 1
  Prov = 0
  Tresor = 0
  Pointee = 0
  lettree = 0
  If IsNull(rglt.text) Then Rglt.Text = "0"
  If IsNull(rglt2.text) Then Rglt2.Text = "0"
  If Val(rglt.Text) + Val(rglt2.Text) = Abs(Val(Tottc.text)) And Rgmt.Value = True Then
    If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Chèque" Then Lettree = 1
    If Not IsNull(Regmt2.text) Then 
      If Regmt2.text = "Espèces" Or If Regmt2.text = "Carte" Or If Regmt2.text = "Chèque" Then
        Lettree = 1
      Else
        Lettree = 0
      Endif
    Endif
  Else
    Lettree = 0
  Endif
  Cloturee = 1
  Relance = 0
  With Utils
    Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab2 & " WRITE, " & Cbase.Table("TabComptes") & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE , " & Tab6 & " WRITE")
    jr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
    If Regmt.text = "Espèces" Then
      Jnal = jr!jrnal2
    Else
      Jnal = jr!jrnal3
    Endif
    Vic = jr!viremc
    Vichq = jr!viremchq
    Viautre = jr!virema
    numecr = "numecriture"
    numr = Ecritures(numecr)
    numr = numr + 1
    numrd = numr
    numecr = "numecriture2"
    numr2 = Ecritures(numecr)
    numr2 = numr2 + 1
    rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & "")
    If rResult.Available Then
      Repeat
        collectif = ""
        Cpt = rResult!compte
        Intit = rResult!intitule
        If Left$(Cpt, 3) = "411" Or If Left$(Cpt, 3) = "453" Then
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpt)
          coll = hresult!coll_cc
          collectif = "1"
          '$intitule = hresult!intitule_cc
          $intitule = Nom.text
          If Val(Tottc.Text) >= 0 Then
            Libel = "Facture " & Intit
          Else
            Libel = "Avoir " & Intit
          Endif
          If rResult!totalht <> "" And Val(.cpoint(rResult!totalht)) > 0 Then
            Mtd = Val(.cpoint(rResult!totalht))
            Mtc = 0
          Else
            Mtc = Abs(Val(.cpoint(rResult!totalht)))
            Mtd = 0
          Endif
          Utils.db.Exec("INSERT INTO " & Tab & "(jour, numero, compte, collectif, intitule, dte, dateech, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef, dteval) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20})", Jnl, numr, coll, collectif, Intit, .Cdate_Dbase(dtef.Text), .Cdate_Dbase(dtech.Text), Nfac, Libel, Mtd, Mtc, Valid, Prov, Tresor, Pointee, lettree, Cloturee, Relance, numr2, Format$(Now, "yyyymmdd"))
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
          collectif = ""
        Endif
        If Left$(Cpt, 3) <> "411" And Left$(Cpt, 3) <> "445" And Left$(Cpt, 3) <> "453" And Not IsNull(cpt) Then
          If Left$(rResult!compte, 3) <> "709" Then
            If Val(.cpoint(rResult!totalht)) > 0 Then
              Mtc = Val(.cpoint(rResult!totalht))
              Mtd = 0
            Else
              Mtd = Val(.cpoint(rResult!totalht))
              Mtc = 0
            Endif
          Endif
        Endif
        If Left$(Cpt, 3) = "445" Then
          If rResult!totaltva <> "" And Val(.cpoint(rResult!totaltva)) > 0 Then
            Mtc = Val(.cpoint(rResult!totaltva))
            Mtd = 0
          Else
            Mtd = Abs(Val(.cpoint(rResult!totaltva)))
            Mtc = 0
          Endif
        Endif
        'If Mtd = 0 And Mtc = 0 Then
        'Else
        Mtd = Abs(mtd)
        Mtc = Abs(Mtc)
        If Prxdec Then
          Mtd = Round(Mtd)
          Mtc = Round(Mtc)
        Endif
        Utils.db.Exec("INSERT INTO " & Tab & "(jour, numero, compte, intitule, dte, dateech, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", Jnl, numr, Cpt, Intit, .Cdate_Dbase(dtef.Text), .Cdate_Dbase(dtech.Text), Nfac, Libel, Mtd, Mtc, Valid, Prov, Tresor, Pointee, lettree, Cloturee, Relance, numr2)
        hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpt)
        If hresult!solde = "" Then
          Sld = Mtd - Mtc
        Else
          Sld = hresult!solde + Mtd - Mtc
        Endif
        Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Cpt, Sld)
        Mtd = 0
        Mtc = 0
        'Endif
      Until rResult.MoveNext()
      ' On gère la première écriture de trésorerie
      If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Chèque" Or If Regmt.text = "Paypal" Then
        If Not IsNull(Rglt.Text) And Rgmt.value = True Then
          Param = Utils.db.Exec("SELECT * FROM " & Tab5 & " where code_jo = &1", jnal)
          Numr = numr + 1
          cloturee = 1
          If Val(Tottc.Text) > 0 Then
            Mtc = Val(rglt.Text)
            Mtd = 0
          Else
            Mtd = Val(rglt.Text)
            Mtc = 0
          Endif
          If Regmt.text = "Espèces" Then
            Cptreglt = Param!cde_banque
          Else
            If Regmt.text = "Carte" Then
              Cptreglt = Vic
            Else
              If Regmt.text = "Chèque" Then
                Cptreglt = Vichq
              Else
                If Regmt.text = "Paypal" Then
                  Cptreglt = Viautre
                Endif 
              Endif
            Endif
          Endif
          Libel = "Rglt " & Regmt.Text & " " & $intitule
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Code3.Text, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
          If Val(Tottc.Text) > 0 Then
            Mtd = Mtc
            Mtc = 0
          Else
            Mtc = Mtd
            Mtd = 0 
          Endif
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Cptreglt, Regmt.text & " " & rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, 0, cloturee, .Cdate_Dbase(Dtef.Text))
          
          '*******************************On recalcule les soldes des comptes************************************
          If Val(Tottc.Text) > 0 Then
            Mtc = Val(rglt.Text)
            Mtd = 0
          Else
            Mtd = Val(rglt.Text)
            Mtc = 0
          Endif
          'Pour le compte client
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Code3.Text)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Code3.Text, Sld)
          Mtd = 0
          'Pour le collectif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
          Mtd = 0
          Mtc = 0
          'Pour le compte de trésorerie
          Mtd = Val(rglt.Text)
          If Val(Tottc.Text) > 0 Then
            Mtd = Val(rglt.Text)
            Mtc = 0
          Else
            Mtc = Val(rglt.Text)
            Mtd = 0
          Endif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cptreglt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Cptreglt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Endif
      Utils.db.Exec("UPDATE " & Tab4 & " set numecriture = &1, numecriture2 = &2", numr, numr2)
      
      ' On gère la seconde écriture de trésorerie
      If Regmt2.text = "Espèces" Then
        Jnal = jr!jrnal2
      Else
        Jnal = jr!jrnal3
      Endif
      If Regmt2.text = "Espèces" Or If Regmt2.text = "Carte" Or If Regmt2.text = "Chèque" Or If Regmt2.text = "Paypal" Then
        If Val(Rglt2.Text) > 0 And Rgmt.value = True Then
          Param = Utils.db.Exec("SELECT * FROM " & Tab5 & " where code_jo = &1", jnal)
          Numr = numr + 1
          cloturee = 1
          If Val(Tottc.Text) > 0 Then
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Else
            Mtd = Abs(Val(rglt2.Text))
            Mtc = 0
          Endif
          If Regmt2.text = "Espèces" Then
            Cptreglt = Param!cde_banque
          Else
            If Regmt2.text = "Carte" Then
              Cptreglt = Vic
            Else
              If Regmt2.text = "Chèque" Then
                Cptreglt = Vichq
              Else
                If Regmt2.text = "Paypal" Then
                  Cptreglt = Viautre
                Endif 
              Endif
            Endif
          Endif
          Libel = "Règlement " & $intitule & " par " & Regmt2.Text
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Code3.Text, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
          If Val(Tottc.Text) > 0 Then
            Mtd = Mtc
            Mtc = 0
          Else
            Mtc = Mtd
            Mtd = 0 
          Endif
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Cptreglt, Regmt2.text & " " & rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, 0, cloturee, .Cdate_Dbase(Dtef.Text))
          
          '*******************************On recalcule les soldes des comptes************************************
          
          If Val(Tottc.Text) > 0 Then
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Else
            Mtd = Abs(Val(rglt2.Text))
            Mtc = 0
          Endif
          'Pour le compte client
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Code3.Text)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Code3.Text, Sld)
          Mtd = 0
          'Pour le collectif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)
          Mtd = 0
          Mtc = 0
          'Pour le compte de trésorerie
          If Val(Tottc.Text) > 0 Then
            Mtd = Val(rglt2.Text)
            Mtc = 0
          Else
            Mtc = Val(rglt2.Text)
            Mtd = 0
          Endif
          hresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cptreglt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", Cptreglt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Endif
      Utils.db.Exec("UPDATE " & Tab4 & " set numecriture = &1, numecriture2 = &2", numr, numr2)
    Endif
    'Utils.db.Exec("UNLOCK TABLES")
  End With
  
End

'**********************************************************
'*       Calcul de la Tva pour le bas de facture          *
'**********************************************************
Public Sub Calc_tva(Org As String)
  
  Dim Cpt As String
  Dim Mtva As String
  Dim Mtva2 As String
  Dim Mht As String
  Dim Mttc As String
  Dim Ttx As String
  Dim CResult As Result
  Dim Cptrst As Result
  Dim TotEuros As String
  Dim $ht As String
  Dim $tva As String
  
  Tab = "Fiches_Tvaav"
  Tab2 = "Totalisation"
  With Utils
    Cptrst = Utils.db.Exec("SELECT * FROM " & Tab & "")
    If Cptrst.Available Then
      Repeat
        Ttx = Format$(Cptrst!taux_tva, ",0.00")
        Ctx = Cptrst!code_tva
        Cresult = Utils.db.Exec("SELECT * FROM " & Tab2 & " Where codetva = &1", Ctx)
        If Cresult.Available Then
          Repeat
            Cpt = CResult!compte
            If Left$(Cpt, 3) = "445" Then
              Mtva2 = Format$(Val(CResult!totaltva), ",0.00")
              If IsNull(Mtva2) Then Mtva2 = "0,00"
              Mht = Format$(Val(CResult!totalht), ",0.00")
              If IsNull(Mht) Then Mht = "0,00"
              If Prxdec Then
                Mtva2 = Round(Val(Mtva2))
                Mtva2 = Format$(Val(Mtva2), ",0")
                Mht = Round(Val(Mht))
                Mht = Format$(Val(Mht), ",0")
              Endif
              If Val(Mtva2) <> 0 Then
                Mtva = Mtva2 & " " & " " & devises
                If ImpAuto = False And If Franchise = False And If Not exo.value Then
                  If Blch.Value = True Then
                    If BlA5.Value And Not Bfac.value Then
                      pdf2.Level9F(Ctx, Mht, Ttx, Mtva, Mttc, PosY)
                      PosY = PosY + 5
                    Else
                      pdf.Level9F(Ctx, Mht, Ttx, Mtva, Mttc, PosY)
                      PosY = PosY + 5
                    Endif
                  Endif
                Endif
              Endif
            Endif
          Until Cresult.MoveNext()
        Else
          Mtva = "0,00"
        Endif
      Until Cptrst.MoveNext()
    Endif
    If BlA5.Value Then
      PosY = 179
    Else 
      PosY = 274
    Endif
    If Reserve.Value = False And Org <> "Mail" Then Txtleg2 = ""
    If Prxdec Then
      Toteuros = Round(Val(Tottc1.text))
      Toteuros = Format$(Val(Toteuros), ",0") & " " & devises
    Else
      Toteuros = Format$(Val(Tottc1.Text), ",0.00") & " " & devises
    Endif
    If Blch.Value = True Then
      If Prxdec Then
        $ht = Round(Val(Totht1.text))
        $ht = Format$(Val($ht), ",0")
        $tva = Round(Val(Tottva.text))
        $tva = Format$(Val($tva), ",0")
        If BlA5.Value And Not Bfac.value Then
          pdf2.Level10F($ht, $tva, Toteuros, Txtleg, PosY - 6, ImpAuto, Exo.value, Franchise)
        Else
          pdf.Level10F($ht, $tva, Toteuros, Txtleg, PosY - 6, ImpAuto, Exo.value, Franchise)
        Endif
      Else
        If BlA5.Value And Not Bfac.value Then
          pdf2.Level10F(Format$(Val(Totht1.Text), ",0.00"), Tottva.Text, Toteuros, Txtleg, PosY - 6, ImpAuto, Exo.value, Franchise)
        Else
          pdf.Level10F(Format$(Val(Totht1.Text), ",0.00"), Tottva.Text, Toteuros, Txtleg, PosY - 6, ImpAuto, Exo.value, Franchise)
        Endif
      Endif
      PosY = PosY + 8
      If BlA5.Value And Not Bfac.value Then
        pdf2.Level11F(Txtleg2, PosY)
      Else
        pdf.Level11F(Txtleg2, PosY)
      Endif
      If Bfac.value Then
        If Settings["/Soc" & Start.Societe & "/Coupon"] Then
          If Bfac.value And imp = "0" And Visudoc = True Then
          Else
            If BlA5.Value And Not Bfac.value Then
              pdf2.Level15F(Code3.Text, Nmfac, Toteuros, PosY, Devises)
            Else
              pdf.Level15F(Code3.Text, Nmfac, Toteuros, PosY, Devises)
            Endif
          Endif
        Endif
      Endif
    Endif
  End With
  
End

' Archivage des factures pour faire un avoir.

'**********************************************************
'*                   Archivage d'une facture              *
'**********************************************************
Public Sub Colbl_Activate()
  
  Dim Blarch As Result
  Dim Fbl As String
  'Utils.db.Exec("UNLOCK TABLES")
  Fbl = "Fiches_Bl"
  If Bfac.Value = True Then
    Try Blarch = Utils.db.Exec("select * from " & Fbl & " where numbl = &1", colbl[colbl.row, 2].Text)
    If Not Error Then
      If Blarch.Available Then
        Numfac = Blarch!numfac
        Impfac = Blarch!imp
        Dtefac = utils.Cdate_Aff(Blarch!dtefac)
        Ech = utils.Cdate_Aff(Blarch!ech)
      Endif
      If Impfac = "1" And colbl[colbl.row, 7].Text Then
        If start.son Then
          Music.Play
        Endif
        If Message.Question(" Attention ! Vous allez archiver cette facture pour faire un avoir. Etes-vous d'accord ?", "Non", "Oui") = 2 Then
          Tot_Remises()
          Ent_Archives()
          Lig_Archives()
          Bl_Sup()
          Button2_Click()
          Numerofac = Numfac
          Avr = True
          Coldetail3.Columns.count = 9
          Coldetail3.Columns[0].Width = 50
          Coldetail3.Columns[2].Alignment = Align.TopLeft
          Coldetail3.Columns[1].Width = 110
          Coldetail3.Columns[2].Width = 240
          Coldetail3.Columns[3].Width = 92
          Coldetail3.Columns[4].Width = 60
          Coldetail3.Columns[5].Width = 92
          Coldetail3.Columns[6].Width = 55
          Coldetail3.Columns[7].Width = 92
          Coldetail3.Columns[8].Width = 30
          Coldetail3.Columns[0].Text = "N° Lig"
          Coldetail3.Columns[1].Text = "Code"
          Coldetail3.Columns[2].Text = "Désignation"
          Coldetail3.Columns[3].Alignment = 2
          Coldetail3.Columns[3].Text = "Px Unitaire"
          Coldetail3.Columns[4].Alignment = 2
          Coldetail3.Columns[4].Text = "Qté/Tps"
          Coldetail3.Columns[5].Alignment = 2
          Coldetail3.Columns[5].Text = "Px brut"
          Coldetail3.Columns[6].Alignment = 2
          Coldetail3.Columns[6].Text = "Remise"
          Coldetail3.Columns[7].Alignment = 2
          Coldetail3.Columns[7].Text = "Px net"
          Coldetail3.Columns[8].Alignment = 4
          Coldetail3.Columns[8].Text = " TL "
          EntFac()
          Message.Info("La facture N° " & Numerofac & " a été archivée.\nVeuillez sélectionner vos lignes d'avoir SVP...")
        Endif
      Endif
    Endif
  Endif
  
End

Public Sub Maj_Suivis()
  
  Dim rSuivi As Result
  
  With utils
    Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabSuivis") & " WRITE")
    rSuivi = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabSuivis") & " WHERE numdev = &1 and code = &2", Num.Text, Code.Text)
    If rSuivi.Available Then Utils.db.Exec("UPdate  " & Cbase.Table("TabSuivis") & "  SET  numfac= &1, datefac = &2 WHERE numdev = &3 and code = &4", Nfac, .Cdate_Dbase(dtef.Text), num.Text, code.Text)
  End With
  
End

'**********************************************
'*            calcul des remises              *
'**********************************************
Public Sub Tot_Remises()
  
  Dim Blarch As Result
  Dim Fbl As String
  
  Fbl = "Fiches_Ligbl"
  Remmo = "0"
  Remart = "0"
  With Utils
    Try Blarch = Utils.db.Exec("select * from " & Fbl & " where num_ligbl = &1", $numbl)
    If Not Error Then
      If Blarch.Available Then
        Repeat
          Typel = Blarch!typel_ligbl
          If typeL = "M" Then Remmo = Val(.CPoint(Remmo)) + Val(.CPoint(Blarch!brut_ligbl)) - Val(.CPoint(Blarch!netht_ligbl))
          If typeL = "A" Then Remart = Val(.CPoint(Remart)) + Val(.CPoint(Blarch!brut_ligbl)) - Val(.CPoint(Blarch!netht_ligbl))
        Until Blarch.MoveNext()
      Endif
    Endif
  End With
  
End

'**********************************************************
'*                   Maj Entetes Archives                 *
'**********************************************************
Public Sub Ent_Archives()
  
  Tab = "Fiches_HistoFac"
  With Utils
    Utils.db.Exec("INSERT INTO " & Tab & "(numfac,datefac,cdclifac, nmclifac, rmofac, rartfac, pnmclifac, adr1fac, adr2fac, cpfac, villefac, Exofac, cvclifac, remmofac, remartfac, totfac, reg, ech, numerobl, acpt, mreg, marge_art, marge_mo, totfacttc, cdep) VALUES (&1,&2,&3,&4,&5,&6,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16},&{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26})", Numfac, .Cdate_Dbase(Dtefac), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, .PointBase(Remmo), .PointBase(Remart), .PointBase(Totht.Text), regmt.Text, .Cdate_Dbase(ech), num.Text, acpt.Text, mrgt.Text, .PointBase(mrgart), .PointBase(Mrgmo), .PointBase(Tottc1.Text), Dep.Text)
  End With
  
End

'**********************************************************
'*                   Maj Lignes  Archives                 *
'**********************************************************
Public Sub Lig_Archives()
  
  Dim Intit As String
  Dim lg, Nbligne As Integer = 0
  Dim l3 As String
  Dim Colitem0 As String
  Dim Colitem1 As String
  Dim Colitem9 As String
  Dim Colitem16 As String
  Dim Dlg As String
  Dim rmat As Result
  Dim Tmat As String = "Fiches_Materiels"
  Dim TauxTva As String
  
  Tab = "Fiches_HistoLigfac"
  Try Gmateriel = Settings["/Soc" & Start.Societe & "/Materiel"]
  If Error Then Gmateriel = False
  Nbligne = 1
  With Utils
    Coldetail.MoveLast()
    Coldetail.item.Selected = True
    Dlg = Format$(Val(Coldetail.current[0]) + 1, "0000")
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      If Settings["/Soc" & Start.Societe & "/Impbl"] Then
        intit = "Bon n° " & num.Text & " du " & Dtefac
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac, com_ligfac, typel_ligfac, bloc)VALUES (&1, &2, &3, &4, &5, &6)", numfac, Format$(Nbligne, "0000"), "", Intit, "C", Format$(Nbligne, "0000"))
        Inc nbligne
        intit = ""
      Endif
      Repeat
        Coldetail.item.Selected = True
        Bloc = Coldetail.current[16]
        l3 = Bloc
        Colitem0 = Coldetail.current[0]
        Colitem1 = Coldetail.current[1]
        Colitem9 = Coldetail.current[9]
        Colitem16 = Coldetail.current[16]
        If Coldetail.current[9] <> "C" And If Coldetail.current[9] <> "R" Then
          'TauxTva = Format$(Val(Coldetail.current[8]) - Val(Coldetail.current[7]), "0.00")
          Try rMat = Utils.db.Exec("select * from " & Cbase.Table("TabTvav") & " where code_tva = &1", Coldetail.current[12])
          If rMat.available Then TauxTva = rMat!taux_tva
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac,  libel_ligfac, fam_ligfac, pu_ligfac, qte_ligfac, brut_ligfac, rem_ligfac, netht_ligfac, tx_ligfac, nettc_ligfac, typel_ligfac, tm_ligfac, bloc, mtx_ligfac) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Numfac, Format$(Nbligne, "0000"), Coldetail.current[1], Coldetail.current[2], Coldetail.current[13], Coldetail.current[3], Coldetail.current[4], Coldetail.current[5], Coldetail.current[6], Coldetail.current[7], Coldetail.current[12], Coldetail.current[8], Coldetail.current[9], Coldetail.current[10], Format$(Nbligne, "0000"), TauxTva)
        Else
          Repeat
            Coldetail.item.Selected = True
            If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "R" Then
              If Coldetail.current[16] <> l3 Then Break
              If lg = 1 Then intit = Intit & ("\n")
              intit = Intit & (Coldetail.current[2])
              lg = 1
              Bloc = Coldetail.current[16]
              If bloc <> l3 Then Break
            Else
              Break
            Endif
          Until Coldetail.Movenext()
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac, com_ligfac, typel_ligfac, bloc)VALUES (&1, &2, &3, &4, &5, &6)", numfac, Format$(Nbligne, "0000"), ColItem1, Intit, ColItem9, Format$(Nbligne, "0000"))
          Intit = ""
          lg = 0
          If Colitem0 <> Dlg Then Coldetail.MovePrevious()
        Endif
        If Gmateriel Then
          Try rmat = Utils.db.Exec("select * from " & Tmat & " where mat_bl = &1 and mat_code = &2", num.text, Coldetail.current[1])
          If Not Error Then
            If rmat.Available Then
              Utils.db.Exec("UPdate  " & Tmat & "  SET mat_bl = &3 where mat_bl = &1 and mat_code = &2", num.text, Coldetail.current[1], numfac)
            Endif
          Endif
        Endif
        Inc Nbligne
      Until Coldetail.Movenext()
    Endif
  End With
  
End

'**********************************************************
'*          Suppression du Bon à la demande               *
'**********************************************************
Public Sub Bl_Sup()
  
  Tab2 = "Fiches_Ligbl"
  Tab = "Fiches_Bl"
  Utils.db.Exec("DELETE FROM " & tab & " where numbl = &1", num.Text)
  Utils.db.Exec("DELETE FROM " & tab2 & " where num_ligbl = &1", num.Text)
  CleanChamps()
  Coldetail.Clear
  Bbon.Value = True
  Form_Open()
  
End

'*****************************************************
'*  Récuperation du dernier numéro d'écriture        *
'*****************************************************
Public Function Ecritures(numecr As String) As String
  
  Dim Params As Result
  Dim Tab As String
  Dim nro As String
  
  Tab = "Fiches_Parametres"
  Params = Utils.db.Exec("SELECT " & numecr & " FROM " & Tab & " ")
  If Params.Available Then
    If IsNull(Params["" & numecr & ""]) Then
      nro = 0
    Else
      nro = Params["" & numecr & ""]
    Endif
  Endif
  Return nro
  
End

'************************************************
'*  Mise a jour du dernier numéro d'écriture    *
'************************************************
Public Sub Majnum()
  
  Dim Tab As String
  
  Tab = "Fiches_Parametres"
  'Utils.db.Exec("LOCK TABLES " & Tab & " WRITE")
  Utils.db.Exec("UPDATE " & Tab & " set numecriture = &1, numecriture2 = &2", numr, numr2)
  'Utils.db.Exec("UNLOCK TABLES")
  
End

'************************************************************************
'* Gestion des avoirs a partir d'une facture existante par le bouton    *
'************************************************************************
Public Sub ToggleButton5_Click()
  
  If Not IsNull(num.Text) And Tottc.Text = "0,00" Or If Not IsNull(num.Text) And Tottc.Text = "0" Then
    Panel9.visible = True
  Else
    Balloon.Warning(("Veuillez cliquer sur le bouton nouveau avant de saisir un avoir SVP "), Button2)
  Endif
  
End

Public Sub ToggleButton5_Click2()
  
  Dim MyForm As TriFac
  Dim MyForm2 As TriFac2
  
  Tri = "numfac"
  Nvc = 0
  Nv = 1
  Select Case Message.Question("Que voulez-vous faire ?\n1- Créer un devis par duplication.\n2- Faire un avoir.", "1- Devis", "2- Avoir", "3- Quitter")
    Case 1
      Avr = False
      Bdevis.Value = True
      'Selpart.value = True
      
    Case 2
      Avr = True
      Bbon.Value = True
      'Seltot.value = True
    Case 3
      Return
  End Select
  'ColFac.Clear
  Coldetail.clear
  If Not IsNull(num.Text) And Tottc.Text = "0,00" Or If Not IsNull(num.Text) And Tottc.Text = "0" Then
    Coldetail3.Columns.count = 9
    Coldetail3.Columns[0].Width = 50
    Coldetail3.Columns[2].Alignment = Align.TopLeft
    Coldetail3.Columns[1].Width = 110
    Coldetail3.Columns[2].Width = 240
    Coldetail3.Columns[3].Width = 92
    Coldetail3.Columns[4].Width = 60
    Coldetail3.Columns[5].Width = 92
    Coldetail3.Columns[6].Width = 55
    Coldetail3.Columns[7].Width = 92
    Coldetail3.Columns[8].Width = 30
    Coldetail3.Columns[0].Text = "N° Lig"
    Coldetail3.Columns[1].Text = "Code"
    Coldetail3.Columns[2].Text = "Désignation"
    Coldetail3.Columns[3].Alignment = 2
    Coldetail3.Columns[3].Text = "Px Unitaire"
    Coldetail3.Columns[4].Alignment = 2
    Coldetail3.Columns[4].Text = "Qté/Tps"
    Coldetail3.Columns[5].Alignment = 2
    Coldetail3.Columns[5].Text = "Px brut"
    Coldetail3.Columns[6].Alignment = 2
    Coldetail3.Columns[6].Text = "Remise"
    Coldetail3.Columns[7].Alignment = 2
    Coldetail3.Columns[7].Text = "Px net"
    Coldetail3.Columns[8].Alignment = 4
    Coldetail3.Columns[8].Text = " TL "
    If Avr = True Then
      If Not IsNull(code.Text) Then
        MyForm = New TriFac(code.text)
      Else
        MyForm = New TriFac("")
      Endif
      MyForm.Showmodal()
    Else
      If Not IsNull(code.Text) Then
        MyForm2 = New TriFac2(code.text)
      Else
        MyForm2 = New TriFac2("")
      Endif
      MyForm2.Showmodal()
    Endif
    If Bsel = True Then
      EntFac()
    Endif
  Else
    Balloon.Warning(("Veuillez cliquer sur le bouton nouveau avant de saisir un avoir SVP "), Button2)
  Endif
  
End

Public Sub Button17_Click()
  
  Panel6.Visible = False
  Settings["/Soc" & Start.Societe & "/SelDev"] = Seltot.value
  
End

Public Sub EntFac()
  
  Tab = "Fiches_Parametres"
  num2.Text = num.Text
  num3.Text = num.Text
  With utils
    If Avr = True Or If Len(NumeroFac) = 10 Then
      rResult = Utils.db.Exec("select * from " & Cbase.Table("TabHisFac") & " Left join " & Cbase.Table("TabCli") & " on cli_code = cdclifac where numfac = &1", numeroFac)
      If rResult.Available Then
        Code.text = rResult["cdclifac"]
        Code3.Text = Code.Text
        Code4.Text = Code.Text
        Cv.Text = rResult["cvclifac"]
        Nom.text = rResult["nmclifac"]
        Nm.Text = Nom.Text
        Nm3.Text = Nom.Text
        Pnm.text = rResult["pnmclifac"]
        Adr1.text = rResult["adr1fac"]
        Adr2.text = rResult["adr2fac"]
        Cp.text = rResult["cpfac"]
        Burd.text = rResult["villefac"]
        Try Livraison.value = rResult!cli_livraison
        Try Txmo.Text = Format$(Val(rResult["rmofac"]), "0.00")
        If Error Then Txmo.Text = "0,00"
        Try Txpieces.Text = Format$(Val(rResult["rartfac"]), "0.00")
        If Error Then Txpieces.Text = "0,00"
      Endif
    Else
      rResult = Utils.db.Exec("select * from " & Cbase.Table("TabBl") & "  Left join " & Cbase.Table("TabCli") & " on cli_code = cdclibl where numbl = &1", NumeroFac)
      If rResult.Available Then
        Code.text = rResult["cdclibl"]
        Code3.Text = Code.Text
        Code4.Text = Code.Text
        Cv.Text = rResult["cvclibl"]
        Nom.text = rResult["nmclibl"]
        Nm.Text = Nom.Text
        Nm3.Text = Nom.Text
        Pnm.text = rResult["pnmclibl"]
        Adr1.text = rResult["adr1bl"]
        Adr2.text = rResult["adr2bl"]
        Cp.text = rResult["cpbl"]
        Burd.text = rResult["villebl"]
        Try Livraison.value = rResult!cli_livraison
        Try Txmo.Text = Format$(Val(rResult["rmobl"]), "0.00")
        If Error Then Txmo.Text = "0,00"
        Try Txpieces.Text = Format$(Val(rResult["rartbl"]), "0.00")
        If Error Then Txpieces.Text = "0,00"
        tp2 = rResult!type
      Endif
    Endif
  End With
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Coldetail3.Clear
  button4_click()
  Recup_ligfac()
  
End
'*******************************************************
'*  On Affiche les lignes de la facture sélectionnée   *
'*******************************************************

Public Sub Recup_ligfac()
  
  Dim hresult As Result
  Dim sline As String
  Dim ilg As Integer = 1
  
  Totalmo = "0,00"
  Totalart = "0,00"
  Totalrem = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Coldetail3.visible = True
  With utils
    If Avr = True Or If Len(NumeroFac) = 10 Then
      hresult = Utils.db.Exec("select * from " & Cbase.Table("TabHisLigFac") & " where num_ligfac = &1", numeroFac)
      If hresult.Available Then
        Repeat
          If hresult["typel_ligfac"] <> "C" And If hresult["typel_ligfac"] <> "R" And If hresult["typel_ligfac"] <> "O" Then
            Coldetail3.Add(hresult["numlig_ligfac"], hresult["numlig_ligfac"])
            Coldetail3.item[0] = hresult["numlig_ligfac"]
            Coldetail3.item[1] = hresult["code_ligfac"]
          Endif
          If hresult["typel_ligfac"] = "M" Then
            Totalmo = Format$(Val(Totalmo) + Val(.CPoint(hresult["netht_ligfac"])), "0.00")
          Endif
          If hresult["typel_ligfac"] = "A" Then
            Totalart = Format$(Val(Totalart) + Val(.CPoint(hresult["netht_ligfac"])), "0.00")
          Endif
          If hresult["typel_ligfac"] = "C" Or hresult["typel_ligfac"] = "R" Then
            For Each sline In Split(hresult["com_ligfac"], "\n")
              Coldetail3.Add(hresult["numlig_ligfac"] & ilg, hresult["numlig_ligfac"] & ilg)
              Coldetail3.item[0] = hresult["numlig_ligfac"]
              Coldetail3.item[1] = hresult["code_ligfac"]
              Coldetail3.item[2] = sline
              Coldetail3.item[8] = hresult["typel_ligfac"]
              Coldetail3.item[17] = hresult["bloc"]
              Inc ilg
            Next
          Else
            If hresult["typel_ligfac"] = "O" Then
              Coldetail3.Add(hresult["numlig_ligfac"] & ilg, hresult["numlig_ligfac"] & ilg)
              Coldetail3.item[0] = hresult["numlig_ligfac"]
              Coldetail3.item[1] = hresult["code_ligfac"]
              Coldetail3.item[2] = hresult["com_ligfac"]
              Coldetail3.item[8] = hresult["typel_ligfac"]
              Coldetail3.item[17] = hresult["bloc"]
            Else
              Coldetail3.item[2] = hresult["libel_ligfac"]
              Maj_libelle()
              Coldetail3.item[3] = hresult["pu_ligfac"]
              Coldetail3.item[4] = hresult["qte_ligfac"]
              Coldetail3.item[5] = hresult["brut_ligfac"]
              Coldetail3.item[6] = hresult["rem_ligfac"]
              Coldetail3.item[7] = hresult["netht_ligfac"]
              Coldetail3.item[8] = hresult["typel_ligfac"]
              Coldetail3.item[10] = hresult["tm_ligfac"]
              Coldetail3.item[11] = hresult["nettc_ligfac"]
              Coldetail3.item[12] = hresult["tx_ligfac"]
              Coldetail3.item[13] = hresult["fam_ligfac"]
              Coldetail3.item[16] = hresult["numlig_ligfac"]
              Coldetail3.item[17] = hresult["bloc"]
              With Utils
                If hresult["typel_ligfac"] <> "E" And If hresult["typel_ligfac"] <> "T" And If hresult["typel_ligfac"] <> "O" And If hresult["typel_ligfac"] <> "C" And If hresult["typel_ligfac"] <> "D" Then
                  Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(hresult["brut_ligfac"])) - Val(.CPoint(hresult["netht_ligfac"]))), "0.00")
                  Totalht = Format$(Val(.CPoint(Totalht)) + Val(.CPoint(hresult["netht_ligfac"])), "0.00")
                  Totalttc = Format$(Val(.CPoint(Totalttc)) + Val(.CPoint(hresult["nettc_ligfac"])), "0.00")
                Endif
              End With
            Endif
          Endif
        Until hresult.MoveNext()
      Endif
    Else
      hresult = Utils.db.Exec("select * from " & Cbase.Table("TabLigbl") & " where num_ligbl = &1", numeroFac)
      If hresult.Available Then
        Repeat
          'Try Coldetail3.Item.Selected = True
          If hresult["typel_ligbl"] <> "C" And If hresult["typel_ligbl"] <> "O" And If hresult["typel_ligbl"] <> "R" Then
            Coldetail3.Add(hresult["numlig_ligbl"], hresult["numlig_ligbl"])
            Coldetail3.item[0] = hresult["numlig_ligbl"]
            Coldetail3.item[1] = hresult["code_ligbl"]
          Endif
          If hresult["typel_ligbl"] = "M" Then
            Totalmo = Format$(Val(Totalmo) + Val(.CPoint(hresult["netht_ligbl"])), "0.00")
          Endif
          If hresult["typel_ligbl"] = "A" Then
            Totalart = Format$(Val(Totalart) + Val(.CPoint(hresult["netht_ligbl"])), "0.00")
          Endif
          If hresult["typel_ligbl"] = "C" Then
            For Each sline In Split(hresult!com_ligbl, "\n")
              Coldetail3.Add(hresult!numlig_ligbl & ilg, hresult!numlig_ligbl & ilg)
              Coldetail3.item[0] = hresult["numlig_ligbl"]
              Coldetail3.item[1] = hresult["code_ligbl"]
              Coldetail3.item[2] = sline
              Coldetail3.item[8] = hresult["typel_ligbl"]
              Coldetail3.item[17] = hresult["block_ligbl"]
              Inc ilg
            Next
          Else
            If hresult["typel_ligbl"] = "O" Then
              Coldetail3.Add(hresult!numlig_ligbl & ilg, hresult!numlig_ligbl & ilg)
              Coldetail3.item[0] = hresult["numlig_ligbl"]
              Coldetail3.item[1] = hresult["code_ligbl"]
              Coldetail3.item[2] = hresult["libel_ligbl"]
              Coldetail3.item[4] = hresult["qte_ligbl"]
              Coldetail3.item[8] = hresult["typel_ligbl"]
              Coldetail3.item[17] = hresult["block_ligbl"]
            Else
              Coldetail3.item[2] = hresult["libel_ligbl"]
              Maj_libelle()
              Coldetail3.item[3] = hresult["pu_ligbl"]
              Coldetail3.item[4] = hresult["qte_ligbl"]
              Coldetail3.item[5] = hresult["brut_ligbl"]
              Coldetail3.item[6] = hresult["rem_ligbl"]
              Coldetail3.item[7] = hresult["netht_ligbl"]
              Coldetail3.item[8] = hresult["typel_ligbl"]
              Coldetail3.item[10] = hresult["tm_ligbl"]
              Coldetail3.item[11] = hresult["nettc_ligbl"]
              Coldetail3.item[12] = hresult["tx_ligbl"]
              Coldetail3.item[13] = hresult["fam_ligbl"]
              Coldetail3.item[16] = hresult["numlig_ligbl"]
              Coldetail3.item[17] = hresult["block_ligbl"]
              Coldetail3.item[18] = hresult["mrgart_ligbl"]
              Coldetail3.item[19] = hresult["mrgmo_ligbl"]
              Coldetail3.item[20] = hresult!four_ligbl
              With Utils
                If hresult["typel_ligbl"] <> "E" And hresult["typel_ligbl"] <> "T" And hresult["typel_ligbl"] <> "O" And hresult["typel_ligbl"] <> "C" And hresult["typel_ligbl"] <> "R" And hresult["typel_ligbl"] <> "D" Then
                  Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(hresult["brut_ligbl"])) - Val(.CPoint(hresult["netht_ligbl"]))), "0.00")
                  Totalht = Format$(Val(.CPoint(Totalht)) + Val(.CPoint(hresult["netht_ligbl"])), "0.00")
                  Totalttc = Format$(Val(.CPoint(Totalttc)) + Val(.CPoint(hresult["nettc_ligbl"])), "0.00")
                Endif
              End With
            Endif
          Endif
        Until hresult.MoveNext()
      Endif
    Endif
    Totmo3.Text = Totalmo
    Totart3.Text = Totalart
    Totrem3.Text = Totalrem
    Totht3.Text = Totalht
    Tottc3.Text = Totalttc
    Tottva3.Text = Format$(Val(.CPoint(Tottc3.Text)) - Val(.CPoint(Totht3.Text)), "0.00")
  End With
  Panel6.Visible = True
  If Avr = False Then
    Bdevis.Value = True
  Else
    If Settings["/Soc" & Start.Societe & "/Factdef"] Then
      BFac.value = True
    Else
      If Settings["/Soc" & Start.Societe & "/Bldef"] Then
        Bbon.value = True
      Else
        If Settings["/Soc" & Start.Societe & "/Devisdef"] Then
          Bdevis.value = True
        Endif
      Endif
    Endif
  Endif  
  
End

'******************************************
'* On récupère les lignes sélectionnées   *
'******************************************
Public Sub Button20_Click()
  
  Dim TpLigne As String
  Dim $dup As Boolean = False
  
  Nlgn = "0001"
  Coldetail.Clear
  Totalart = "0,00"
  Totalmo = "0,00"
  Totalrem = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  With Utils
    If Coldetail3.Visible Then
      Coldetail3.MoveFirst()
      Repeat
        If Coldetail3.item.Selected Then 
          $dup = True
          Break
        Endif
      Until Coldetail3.MoveNext()
      If Selpart.Value And $dup = False Then
        Message.Warning("Vous souhaitez faire une duplication partielle\nmais vous n'avez pas sélectionné de ligne...")
        Return
      Else
        Coldetail3.MoveFirst()
        If tp2 = "C" Then
          Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &1)", num.text, "0001", "", "Reliquat de la commande " & numerofac, "C", TpLigne)
          Nlgn = Format$(Val(Nlgn) + 1, "0000")
        Endif
        Repeat
          Bloc = Coldetail3.item[0]
          TpLigne = Coldetail3.item[8]
          If Seltot.Value Or If Selpart.Value And Coldetail3.item.Selected Then
            If Coldetail3.item[8] <> "C" And If Coldetail3.item[8] <> "R" Then
              Importlig()
              Majligbl()
            Else
              Importlig()
              Repeat
                If Coldetail3.item[0] <> Bloc Then
                  Coldetail3.MovePrevious
                  Break
                Else
                  Commentaire = Commentaire & Coldetail3.item[2] & "\n"
                Endif
              Until Coldetail3.MoveNext()
              If Len(commentaire) > 1 Then Commentaire = Left$(Commentaire, Len(Commentaire) - 1)
              Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", Num.Text, Coldetail.item[0], Coldetail.item[1], Commentaire, TpLigne, Coldetail.item[0])
              If Error Then
                Coldetail3.MovePrevious
                Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", Num.Text, Coldetail.item[0], Coldetail.item[1], Commentaire, TpLigne, Coldetail.item[0])
              Endif
              Commentaire = ""
            Endif
          Endif
        Until Coldetail3.MoveNext()
        If tp2 = "C" Then
          If Message.Question("Récupération terminée !\nVoulez-vous effacer les lignes séléctionnées ?", "Non", "Oui") = 2 Then
            Coldetail3.MoveFirst()
            Repeat
              If Coldetail3.item.Selected And Coldetail3.item[1] <> "XX" Then 
                Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigbl") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail3.item[0], numeroFac)
              Endif
            Until Coldetail3.MoveNext()
          Endif
          Bcomde.Value = True
        Endif
        Totmo.Text = Totalmo
        Totart.Text = Totalart
        Totrem.Text = Totalrem
        Totht.Text = Totalht
        Tottc.Text = Totalttc
        Tottva.Text = Format$(Val(.CPoint(Tottc.Text)) - Val(.CPoint(Totht.Text)), "0.00")
        Totht1.Text = Totht.text
        Tottc1.Text = Tottc.Text
        Totva1.Text = Tottva.Text
        Panel6.Visible = False
        Panel5.Visible = True
        Avr = True    
        Settings["/Soc" & Start.Societe & "/SelDev"] = Seltot.value
        Colbl_Click()
        If Bbon.Value Or If Bfac.value Then
          If Panel8.visible = False Then
            Maj_Quantite()
          Else
            Maj_QteDep()
          Endif
        Endif
        Button4_Click()
      Endif
    Endif
  End With
  
End

'*****************************************************************
'*     Calcul bas de facture et mise a jour table lignes de bl   *
'*****************************************************************
Public Sub Majligbl()
  
  With Utils
    If Coldetail3.item[8] = "M" Then
      Totalmo = Format$(Val(Totalmo) + Val(.CPoint(Coldetail.item[7])), "0.00")
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, tm_ligbl, block_ligbl, mrgmo_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", num.Text, Coldetail.item[0], Coldetail.item[1], Coldetail.item[2], Coldetail.item[13], Coldetail.item[3], Coldetail.item[4], Coldetail.item[5], Coldetail.item[6], Coldetail.item[7], Coldetail.item[12], Coldetail.item[8], Coldetail3.item[8], Tm.Text, Coldetail.item[16], Coldetail.item[19])
    Endif
    If Coldetail3.item[8] = "A" Or If Coldetail3.item[8] = "E" Or If Coldetail3.item[8] = "P" Or If Coldetail3.item[8] = "D" Then
      Totalart = Format$(Val(Totalart) + Val(.CPoint(Coldetail.item[7])), "0.00")
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, mrgart_ligbl, four_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", num.Text, Coldetail.item[0], Coldetail.item[1], Coldetail.item[2], Coldetail.item[13], Coldetail.item[3], Coldetail.item[4], Coldetail.item[5], Coldetail.item[6], Coldetail.item[7], Coldetail.item[12], Coldetail.item[8], Coldetail3.item[8], Dec.Text, Coldetail.item[16], Coldetail.item[18], Coldetail.current[20])
    Endif
    If Coldetail3.item[8] = "O" Then
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, libel_ligbl, qte_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6, &7)", num.Text, Coldetail.item[0], Coldetail.item[1], Coldetail.item[2], Coldetail.item[4], Coldetail3.item[8], Coldetail.item[16])
    Endif
    If Coldetail3.item[8] = "T" Then
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabLigbl") & "(num_ligbl, numlig_ligbl, code_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", num.Text, Coldetail.item[0], Coldetail.item[1], Coldetail.item[2], Coldetail3.item[8], Coldetail.item[16])
    Endif
    If Coldetail.item[9] <> "C" And Coldetail.item[9] <> "T" And Coldetail.item[9] <> "O" And Coldetail.item[9] <> "R" Then
      Try Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(Coldetail.item[5])) - Val(.CPoint(Coldetail.item[7]))), "0.00")
      Try Totalht = Format$(Val(Totalht) + Val(.CPoint(Coldetail.item[7])), "0.00")
      Try Totalttc = Format$(Val(Totalttc) + Val(.CPoint(Coldetail.item[8])), "0.00")
    Endif
  End With
  
End

'**********************************************************
'*     Importation des lignes de factures dans l'avoir    *
'**********************************************************
Public Sub Importlig()
  
  With utils
    Nlgn = Format$(Val(Nlgn) + 1, "0000")
    Coldetail.Add(Nlgn, Nlgn)
    Coldetail.item[0] = Nlgn
    Coldetail.item[1] = Coldetail3.item[1]
    Coldetail.item[2] = Coldetail3.item[2]
    Coldetail.item[3] = Coldetail3.item[3]
    If Avr = True Then
      If Coldetail3.item[4] <> "" And Left$(Coldetail3.item[4]) <> "-" Then
        Coldetail.item[4] = "-" & Coldetail3.item[4]
      Else
        If Coldetail3.item[4] <> "" Then
          Coldetail.item[4] = - Val(Coldetail3.item[4])
          'Coldetail.item[4] = Format$(Coldetail.item[4], "0.00")
        Endif
      Endif
      If Coldetail3.item[5] <> "" And Left$(Coldetail3.item[5]) <> "-" Then
        Coldetail.item[5] = "-" & Format$(Val(Coldetail3.item[5]), "0.00")
      Else
        If Coldetail3.item[5] <> "" Then
          Coldetail.item[5] = - Val(Coldetail3.item[5])
          Coldetail.item[5] = Format$(Coldetail.item[5], "0.00")
        Endif
      Endif
      Coldetail.item[6] = Coldetail3.item[6]
      If Coldetail3.item[7] <> "" And Left$(Coldetail3.item[7]) <> "-" Then
        Coldetail.item[7] = "-" & Format$(Val(Coldetail3.item[7]), "0.00")
      Else
        If Coldetail3.item[7] <> "" Then
          Coldetail.item[7] = - Val(Coldetail3.item[7])
          Coldetail.item[7] = Format$(Coldetail.item[7], "0.00")
        Endif
      Endif
      Coldetail.item[9] = Coldetail3.item[8]
      Coldetail.item[10] = Coldetail3.item[10]
      If Coldetail3.item[11] <> "" And Left$(Coldetail3.item[11]) <> "-" Then
        Coldetail.item[8] = "-" & Format$(Val(Coldetail3.item[11]), "0.00")
      Else
        If Coldetail3.item[11] <> "" Then
          Coldetail.item[8] = - Val(Coldetail3.item[11])
          Coldetail.item[8] = Format$(Coldetail.item[8], "0.00")
        Endif
      Endif
    Else
      If Coldetail3.item[4] <> "" Then
        Coldetail.item[4] = Coldetail3.item[4]
      Endif
      If Coldetail3.item[5] <> "" Then
        Coldetail.item[5] = Format$(Val(.cpoint(Coldetail3.item[5])), "0.00")
      Endif
      Coldetail.item[6] = Coldetail3.item[6]
      If Coldetail3.item[7] <> "" Then
        Coldetail.item[7] = Format$(Val(.cpoint(Coldetail3.item[7])), "0.00")
      Endif
      Coldetail.item[9] = Coldetail3.item[8]
      Coldetail.item[10] = Coldetail3.item[10]
      If Coldetail3.item[11] <> "" Then
        Coldetail.item[8] = Format$(Val(.cpoint(Coldetail3.item[11])), "0.00")
      Endif
    Endif
    Coldetail.item[12] = Coldetail3.item[12]
    Coldetail.item[13] = Coldetail3.item[13]
    Coldetail.item[20] = Coldetail3.item[20]
    'IF Coldetail3.item[8] <> "O" THEN
    '  Coldetail.item[16] = Coldetail3.item[0]
    'ELSE
    Coldetail.item[16] = Nlgn
    Coldetail.item[18] = Coldetail3.item[18]
    Coldetail.item[19] = Coldetail3.item[19]
    'ENDIF
  End With
  Coldetail.MoveLast()
  Coldetail.item.Selected = True
  
End

'******************************************* Gestion du portable ************************************************
'**********************************************************
'             Création d'un bon avec le portable          *
'**********************************************************
Public Sub GenFacPort()
  
  Dim x As Integer
  Dim Lig As String
  Dim iPos As Integer
  Dim hfil As File
  Dim Cpt As Integer = 0
  Dim Cpt2 As Integer = 0
  Dim Hnew As File
  Dim filename As String
  Dim Code As String
  Dim Codeb As String
  Dim cle As String
  Dim Qte As String
  
  filename = User.Home & "/ImpT.txt"
  If Exist(filename) Then Try Kill filename
  Hnew = Open filename For Write Create
  Print #Hnew, "Les références suivantes n'ont pas pu être importées pour les raisons suivantes ."
  Try HFil = Open User.Home & "/Portable/inventaire.txt" For Read Write
  If Not Error Then
    Me.Mouse = Mouse.Wait
    With utils
      While Not Eof(hFil)
        Line Input #hFil, Lig
        If Not IsNull(Lig) Then
          For x = 1 To 2
            iPos = InStr(Lig, ";")
            If iPos = 0 Then
              cle = Lig
            Else
              cle = Left$(Lig, iPos - 1)
              Lig = Mid$(Lig, iPos + 1)
            Endif
            Select Case x
              Case 1
                Codeb = Trim(cle)
                If Not IsNull(cle) Then
                  Code = Utils.Find_cbarre(Codeb)
                Else
                  Print #Hnew, "Une saisie a été rejetée car elle ne possède pas de code barre."
                  Inc cpt2
                Endif
              Case 2
                If cle <> 0 Then
                  Qte = Format$(Val(Utils.cpoint(cle)), "#.###")
                Else
                  Qte = "0"
                Endif
            End Select
          Next
          If Not IsNull(Code) Then
            Cart.Text = Code
            Art_Man(Cart.Text)
            'Art_Rpl()
            Artqte.Text = Val(Qte)
            Artqte_LF()
            Button11_Click()
            Inc cpt
          Endif
        Else
          Print #Hnew, "L'article " & code & " " & Codeb & " n'existe pas dans la table."
          Inc cpt2
        Endif
      Wend
    End With
    Close #hfil
    Me.Mouse = Mouse.Default
    If start.son Then
      Music.Play
    Endif
    Message.Info("Importation terminée. " & Cpt & " référence(s) ont été importée(s). ", "Ok")
    Panel4.Visible = False
    Me.Raise
    Close #Hnew
    If Cpt2 <> 0 Then Editeur.Prog_Editeur(Filename)
  Else
    If start.son Then
      Music.Play
    Endif
    Message.Info("Problème d'import ! Vérifiez la présence du fichier inventaire.txt sous le repertoire " & "~/Portable !")
  Endif
Catch
  Me.Mouse = Mouse.Default
  If start.son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  
End
'************************************************ Fin de la gestion du portable ***************************************

'**********************************
'      Gestion des acomptes       *
'**********************************
Public Sub Button18_Click()
  
  ChkFocus = 2
  Acompte.visible = True
  Macompte.SetFocus
  Macompte.Select
  
End

'***************************************
'* On controle la saisie de l'acompte  *
'***************************************
Public Sub Verif_acompte()
  
  With Utils
    Try Macompte.Text = .CPoint(Macompte.Text)
    If Val(Macompte.Text) = Null And Macompte.Text Then
      If start.son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      Macompte.Background = &HAAFF7F&
      Macompte.SetFocus
      Macompte.Select
      b = 1
    Else
      If Macompte.Text Then Macompte.Text = Format$(Val(Macompte.Text), "0.00")
      acpt.Text = Macompte.Text
      b = 0
    Endif
  End With
  
End

'**********************************
'       On ferme l'acompte        *
'**********************************
Public Sub Button19_Click()
  
  Verif_acompte()
  If b = 0 Then Acompte.visible = False
  
End

Public Sub OBS_KeyPress()
  'IF Key.Code = Key.F5 THEN Calc.run()
  
End

'PUBLIC FUNCTION IsValidKey() AS Boolean

'  IF Key.Code = Key.F1 THEN Button5_Click()
'  RETURN key.code = key.Return OR key.code = key.Enter OR key.code = key.Tab OR key.code = key.BackTab OR $bForceKey

'END

Public Sub SetObservers(hClass As Object, hCont As Container)
  
  Dim hCtrl As Object
  Dim hOBS As Observer
  
  For Each hCtrl In hCont.Children
    If hCtrl Is TextBox Then
      hOBS = New Observer(hCtrl) As "OBS"
    Endif
    If hCtrl Is Container Then SetObservers(hClass, hCtrl)
  Next
  
End

'******************************************* Gestion des clients *************************************************
'**********************************************************
'*      Le bouton sert a rechercher les clients           *
'**********************************************************
Public Sub ToggleButton1_click()
  
  If Impfac = "0" Then
    SelectionClient()
  Else
    Balloon.Warning(("La facture a été imprimée ! Modification de client impossible."), Code)
  Endif
  
End

'******************************************
'*      Selection du  code client         *
'******************************************
Public Sub Cli_man()
  
  Dim Clitab As Result
  Dim Tabcli As String
  Dim Comptab As Result
  Dim Tabcompt As String
  Dim Inactif As Boolean
  
  Tabcli = "Fiches_Cli"
  Tabcompt = "Fiches_Comptes"
  Tribl = "numbl"
  tribl2 = "numbl"
  Try Clitab = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " C " & ", " & Cbase.Table("TabTarcli") & " T " & " where C.cli_code = &1 and T.ccli = C.cli_code", Code.text)
  If Not Error Then
    If Clitab.Available Then
      Tcli = True
      'Tcoeff = Clitab!coef
    Else
      Tcli = False
      Clitab = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", Code.text)
    Endif
    Inactif = Clitab!cli_actif
    If Inactif Then
      Message.Warning("Compte inactif. Saisie impossible ! ")
      Code.clear
      Return
    Endif
    Pays = Clitab!cli_pays
    Code.Text = Clitab!cli_code
    Code3.Text = Code.Text
    Nom.Text = Clitab!cli_nom
    Pnm.Text = Clitab!cli_pnm
    num2.Text = num.Text
    Nm.Text = Nom.Text
    Adr1.Text = Clitab!cli_adr1
    Adr2.Text = Clitab!cli_adr2
    Cp.Text = Clitab!cli_cd_ptl
    Burd.Text = Clitab!cli_ville
    Telbur.Text = Clitab!cli_tel_bur
    Teldom.Text = Clitab!cli_tel_dom
    Telport.Text = Clitab!cli_pble
    Divers.Text = Clitab!cli_obs
    Txmo.Text = Clitab!cli_rmo
    If IsNull(Txmo.Text) Then txmo.Text = "0,00"
    Txpieces.Text = Clitab!cli_rart
    If IsNull(Txpieces.Text) Then txpieces.Text = "0,00"
    Typec = Clitab!cli_typec
    Cdivers = Clitab!cli_div
    TvaCli = Clitab!cli_id_tva
    Encours = Clitab!cli_plaf_ecrs
    Try Dtab = Clitab!cli_datab
    Try Aban = Clitab!cli_aban
    Try Livraison.value = Clitab!cli_livraison
    If Error Then Livraison.value = False
    If Not IsNull(Clitab!cli_cdech) Then
      Ech = Clitab!cli_cdech
      dtef.Text = Format$(Now, "dd.mm.yyyy")
      Dtech.text = dateEcheance(Ech)
    Endif
    Try Exo.Value = Clitab!cli_exo
    If Impauto Or If Franchise Then
      Exo.Value = True
      Exo.Enabled = False
    Endif
    Cv.Text = Clitab!cli_rs_soc
    Comptab = Utils.db.Exec("SELECT * FROM " & Tabcompt & " where compte_cc = &1", Code.text)
    If Comptab.Available Then
      If Comptab!solde <> "" Then
        solde.text = Format$(Comptab!solde, "0.00")
        If Val(solde.Text) > 0 Then
          code.Background = &HF51B03&
          Solde.Background = &HF51B03&
        Else
          Code.Background = Color.TextBackground
          Solde.Background = Color.TextBackground
        Endif
      Else
        solde.Text = "0,00"
      Endif
      Soldecompte = Val(Utils.cpoint(solde.text))
    Endif
    If IsNull(Encours) Then encours = "0"
    Verif_Encours()
  Endif
  If b = 0 Then
    Recup_Mail()
    'Courriel.add(Clitab!cli_email, 0)
    Button4_Click()
    Recup_type()
    If Settings["/Soc" & Start.Societe & "/Affaire"] Then ChiffreA()
    Try colbl[colbl.row, 4].Text = Code.Text
    Try colbl[colbl.row, 5].Text = Nom.Text
    Try colbl[colbl.row, 6].Text = Pnm.Text
    If Cdivers Then
      Cv.SetFocus
    Else
      Button13.SetFocus
    Endif
  Endif
  
End

'Solde des bl en cours pour le client séléctionné
Public Sub Recup_EncoursBl()
  
  Dim rBl As Result
  
  rBl = Utils.db.Exec("select * from " & Cbase.Table("TabBl") & " where cdclibl like = &1 and typel_ligbl = &2", Code.Text, "B")
  If rBl.Available Then
    'Repeat
  Endif
  
End

'**********************************************************
'*              Récupération des courriels                *
'**********************************************************
Public Sub Recup_Mail()
  
  Dim mResult As Result
  Dim skey As Integer = 0
  
  Courriel.Clear
  mResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailCli") & " where code = &1 order by mail", Code.text)
  If mResult.Available Then
    Repeat
      'Inc skey
      Courriel.Add(mResult!mail)
    Until mResult.MoveNext()
  Endif
  Try mResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContact") & " where code = &1", Code.Text)
  If Not Error Then
    If mResult.Available Then
      Do
        Inc skey
        courriel.Add(mResult!mail, skey)
      Loop Until mResult.MoveNext()
    Endif
  Endif
  
End
'**********************************************************
'*       Récupération du tarif client ou type client      *
'**********************************************************

Public Sub Recup_type()
  
  Dim Tarif As Boolean = False
  
  rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " C " & ", " & Cbase.Table("TabTcli") & " T " & " where C.cli_code = &1 and T.type = C.cli_typec", Code.text)
  If rResult.Available Then
    Try Tcoeff = rResult!coef
    If Not Error Then
      Tcli = True
      Tarif = True
    Endif
  Else
    Tcli = False
  Endif
  rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " C " & ", " & Cbase.Table("TabTarcli") & " T " & " where C.cli_code = &1 and T.ccli = C.cli_code", Code.text)
  If rResult.Available Then
    Try Tcoeff = rResult!coef
    If Not Error Then Tcli = True
  Else
    If Tarif = False Then Tcli = False
  Endif
  
End

Public Sub ChiffreA()
  
  Dim Tab As String
  Dim Tab2 As String
  Dim TotA As Float = 0
  Dim dteN0, dteN1 As String = Format$(Now, "dd.mm.yyyy")
  Dim caResult As Result
  
  dteN0 = Left$(dteN0, 6) & Str(Val(Right$(dteN0, 4)) - 4)
  Tab = "Fiches_HistoFac" 
  Tab2 = "Fiches_HistoFacM"  
  With Utils
    If Gmateriel Then
      caResult = Utils.db.Exec("SELECT * FROM " & Tab & " where datefac >= &1 and datefac <= &2 and cdclifac = &3 union SELECT * FROM " & Tab2 & " where datefac >= &1 and datefac <= &2 and cdclifac = &3 ", Utils.Cdate_Dbase(dteN0), .Cdate_Dbase(dteN1), code.Text)
    Else
      caResult = Utils.db.Exec("SELECT * FROM " & Tab & " where datefac >= &1 and datefac <= &2 and cdclifac = &3", Utils.Cdate_Dbase(dteN0), .Cdate_Dbase(dteN1), code.Text)
    Endif
    If caResult.Available Then
      Repeat
        Try TotA = TotA + caResult!totfacttc
      Until caResult.MoveNext()
      Balloon("CA sur 12 mois : " & Format$(Val(utils.cpoint(totA)), "0.00"), Cv)
    Endif
  End With
  
End

'**********************************************************
'*                 Gestion onglet Saisie Client         *
'**********************************************************
Public Sub SelectionClient()
  
  Dim MyForm As Triclients
  
  bsel = False
  ChkFocus = 2
  MyForm = New Triclients("Facture")
  MyForm.Showmodal()
  If Bsel = True Then
    Code.text = Codeclient
    Courriel.Clear
    Cli_Man()
  Else
    Code.SetFocus
  Endif
  
End

'***********************************************
'*   Génération du columnview des écritures    *
'***********************************************
Public Sub ToggleButton7_MouseDown()
  
  Dim TabEcr As String
  Dim ecrlet As Result
  Dim TotBl As Float = 0
  
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  Me.Center
  If Me.mouse = Mouse.Left Then
    TabEcr = "Fiches_Mvt"
    Coldetail2.Columns.count = 7
    Coldetail2.Columns[0].Width = 100
    Coldetail2.Columns[1].Width = 260
    Coldetail2.Columns[2].Width = 100
    Coldetail2.Columns[3].Width = 100
    Coldetail2.Columns[4].Width = 95
    Coldetail2.Columns[5].Width = 95
    Coldetail2.Columns[0].Text = "Date"
    Coldetail2.Columns[1].Text = "Nom"
    Coldetail2.Columns[2].Text = "Document"
    Coldetail2.Columns[3].Text = "Lot"
    Coldetail2.Columns[4].Alignment = 2
    Coldetail2.Columns[4].Text = "Débit"
    Coldetail2.Columns[5].Alignment = 2
    Coldetail2.Columns[5].Text = "Crédit"
    If Coldetail2.Visible = True Then
      Coldetail2.Clear
      Coldetail2.Visible = False
    Else
      Coldetail2.Clear
      Coldetail2.Visible = True
    Endif
    ecrlet = Utils.db.Exec("SELECT * FROM " & TabEcr & " WHERE compte = &1 and lettree = &2  and validee = &3 order by dte", code.text, 0, 1)
    If ecrlet.Available Then
      Repeat
        Coldetail2.Add(ecrlet!numdoc & ecrlet!lind, ecrlet!numdoc)
        Coldetail2.item[0] = Utils.Cdate_Aff(ecrlet!dte)
        Coldetail2.item[1] = ecrlet!intitule
        Coldetail2.item[2] = ecrlet!numdoc
        Coldetail2.item[3] = ecrlet!numlot
        Coldetail2.item[4] = Format$(ecrlet!montantd, "0.00")
        Coldetail2.item[5] = Format$(ecrlet!montantc, "0.00")
      Until ecrlet.MoveNext()
    Endif
  Else
    TabEcr = "Fiches_Bl"
    ecrlet = Utils.db.Exec("SELECT * FROM " & TabEcr & " WHERE cdclibl = &1 and type = &2 order by numbl", code.text, "B")
    If ecrlet.Available Then
      Repeat
        TotBl = TotBl + ecrlet!totalttc
      Until ecrlet.MoveNext()
      Message.Info("Total BL en cours = " & Format$(Totbl, "0.00"))
    Else
      Message.Info("Aucun BL en cours pour ce client !")
    Endif
  Endif   
  
End

Public Sub Rgmt_Click()
  
  If Rgmt.Value = True Then
    HBox6.Visible = True
  Else
    HBox6.Visible = False
  Endif
  
End

Public Sub Regmt_Change()
  
  If Regmt.text = "Virement" Or If Regmt.text = "Traite" Or If Regmt.text = "Lcr" Then
  Else
    Rglt.ReadOnly = False
    Rglt.Text = Replace$(Tottc.Text, "-", "")
  Endif
  If Regmt.Text Then RegDef.value = False
  
End

'**********************************************
'*     Affichage de la documentation Html     *
'**********************************************
Public Sub Button7_Click()
  
  Exec ["xdg-open", Application.Path &/ "Ecrans/Factures.html"]
  
End

'****************************************Gestion des adresses de livraison*********************************
Public Sub ToggleButton10_Click()
  
  If Colal.Visible = True Then
    Colal.Visible = False
    Colal.Clear
  Else
    Colal.Visible = True
    Colal.Columns.count = 5
    Colal.Columns[0].Width = 0
    Colal.Columns[1].Width = 80
    Colal.Columns[2].Width = 150
    Colal.Columns[3].Width = 150
    Colal.Columns[4].Width = 200
    Colal.Columns[1].Text = "Rs"
    Colal.Columns[2].Text = "Nom"
    Colal.Columns[3].Text = "Prénom"
    Colal.Columns[4].Text = "Ville"
  Endif
  Aff_AdrC()
  
End

Public Sub Aff_AdrC()
  
  Dim AdrResult As Result
  
  AdrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAdrC") & " where code = &1 order by nom", Code.text)
  If AdrResult.Available Then
    Repeat
      Try Colal.Add(AdrResult!num & AdrResult!code, AdrResult!num)
      Colal.item[0] = AdrResult!num
      Colal.item[1] = AdrResult!rs_soc
      Colal.item[2] = AdrResult!nom
      Colal.item[3] = AdrResult!pnm
      Colal.item[4] = AdrResult!ville
    Until AdrResult.MoveNext()
    Colal.MoveFirst
    Colal.SetFocus
    Colal.item.Selected = True
  Endif
  
End

Public Sub Colal_Click()
  
  Dim rcli As Result
  
  CleanChampsAdr()
  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabAdrC") & " where num = &1", Colal.item[0])
  If rCli.Available Then
    Nombl.Text = rcli!rs_soc & " " & rcli!nom & " " & rcli!pnm
    Adr1Bl.Text = rcli!adr1
    Adr2Bl.Text = rcli!adr2
    Cpbl.Text = rcli!cd_ptl
    VilleBl.text = rcli!ville
    Colal.Clear
    Colal.Visible = False
    Nombl.SetFocus
    Nombl.Select
  Endif
  
End

Public Sub CleanChampsAdr()
  
  Nombl.Clear
  Adr1Bl.Clear
  Adr2Bl.Clear
  Cpbl.Clear
  VilleBl.Clear
  
End

'*********************************** On gère l'envoi du document par mail *******************************************

Public Sub Button31_Click()
  
  Dim sText As String
  Dim sText2 As String
  Dim sCourriel As String
  Dim Ty As String
  
  With Utils
    If Tp = "C" Then sText = "Commande"
    If Tp = "B" Then sText = "Bon"
    If Tp = "D" Then sText = "Devis"
    If Tp = "P" Then sText = "Proforma"
    If Tp = "F" Then sText = "Facture"
    If Bfac.value And Visudoc = False Then
      Ty = Nmfac
    Else
      Ty = num.Text
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTmail") & "")
    If rResult.Available Then
      sText2 = Replace$(rResult!intitule, "*", sText)
      If Not IsNull(sVendeur.Text) Then
        sText2 = Replace$(sText2, "§", sVendeur.Text)
      Else
        sText2 = Replace$(sText2, "§", "")
      Endif
      If Not IsNull(XX) Then sText2 = Stext2 & "\n\n" & XX
    Else
      Stext2 = "Bonjour,\n\nVeuillez trouver ci-joint votre " & sText & " No " & ty & " du " & Dtef.Text & "\n\n" & XX & ".\n\nCordialement."
    Endif
    
    Visudoc = True
    If Bfac.value And imp = "0" Then
      If start.son Then
        Music.Play
      Endif
      Message.Info("L'envoi d'un document de type Facture ne peut se faire\nque si l'impression a été effectuée !\nVeuillez imprimer votre facture avant de l'envoyer en pièce jointe.")
    Else
      sText = "Votre " & sText & " No " & ty & " du " & Dtef.Text
      If Not IsNull(Courriel.text) Then
        scourriel = Courriel.Text
        Impression("Mail")
        Me.mouse = Mouse.Wait
        Wait 1
        If ImpPDF.Value Then
          If IsNull(Settings["/Soc" & Start.Societe & "/Pdfchemin"]) Then
            EnvMail.Envoi2(scourriel, stext, sText2, spiece)
          Else
            EnvMail.Envoi3(scourriel, stext, sText2, spiece)
          Endif
        Else
          EnvMail.Envoi2(scourriel, stext, sText2, spiece)
        Endif
        Wait 1
        Me.mouse = Mouse.Default
        Courriel.Text = sCourriel
      Else
        If start.son Then
          Music.Play
        Endif
        Message.Error("L'adresse mail du client n'a pas été renseignée! Envoi impossible.")
      Endif
    Endif
    
  End With
  
End

'******************************* Gestion du gridview Colbl ***************************************

Public Sub Colbl_Data(Row As Integer, Column As Integer)
  
  Dim Frmt As New String[]
  
  With Utils
    ChkFocus = 2
    Factbl[0] = "imp"
    Factbl[1] = "type"
    Factbl[2] = "numbl"
    Factbl[3] = "datebl"
    Factbl[4] = "cdclibl"
    Factbl[5] = "nmclibl"
    Factbl[6] = "pnmclibl"
    Factbl[7] = "numfac"
    .rs3.MoveTo(Row)
    Try Colbl.data.Text = Str(.rs3[Factbl[Column]])
    If column = 1 Then
      typedoc = ""
      Select Case Str(.rs3[Factbl[1]])
        Case "F"
          If Str(.rs3[Factbl[0]]) = "1" Then
            Frmt = Utils.FColr(Facture)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Else
            Frmt = Utils.FColr(Bon)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Endif
        Case "A"
          If Str(.rs3[Factbl[0]]) = "1" Then
            Frmt = Utils.FColr(Facture)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Else
            Frmt = Utils.FColr(Bon)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Endif
        Case "B"
          Frmt = Utils.FColr(Bon)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
        Case "C"
          Frmt = Utils.FColr(Commande)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
        Case "D"
          Frmt = Utils.FColr(Devis)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
          Typedoc = "D"
        Case "P"
          Frmt = Utils.FColr(Proform)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
      End Select
    Endif
    If Error Then
      If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then
        CoulB = Val("&HFAFAFA&")
      Else
        CoulB = Val("&HF9F9BD&")
      Endif
      CoulF = Val("&H000000&")
      Fnt = "serif 10"
    Endif
    Colbl.Data.Background = CoulB
    Colbl.Data.Foreground = CoulF
    Colbl.Data.Font = Font[Fnt]
    If Column = 3 Then
      Colbl.data.Text = Replace$(Colbl.data.Text, "/", ".")
      Colbl.data.Text = Left$(Colbl.data.Text, 6) & Mid$(Colbl.data.Text, 7, 4)
      dt = Scan(Colbl.data.Text, "*.*.*")
      Try date1doc = Date(dt[2], dt[1], dt[0])
      If Not Error Then
        If Format$(date2doc, "yyyymmdd") > Format$(date1doc, "yyyymmdd") And typedoc = "D" Then 
          Frmt = Utils.FColr(Devis2)
          Try CoulB = Val(Frmt[0])
          Colbl.Data.Background = CoulB
        Endif
      Endif
    Endif
  End With
  
End

Public Sub Deb1()
  
  colbl.Clear
  If TriBl <> "datebl" And If Tribl <> "com_ligbl" Then
    Utils.Base3(Colbl, "select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac from " & Cbase.Table("TabBl") & "  where " & TriBl & " like  \"%" & sel & "%\" order by " & tribl2 & " desc ")
  Else
    'If Tribl <> "com_ligbl" And Tribl <> "libel_ligbl" Then
    Utils.Base3(Colbl, "select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac from " & Cbase.Table("TabBl") & "  where " & TriBl & " like  \"%" & sel2 & "%\" order by " & tribl2 & " desc ")
    'Else
    'If Tribl = "com_ligbl" And If IsNull(sel) Then
    'Tribl2 = "numbl"
    'Utils.Base3(Colbl, "select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac from " & Cbase.Table("TabBl") & "  where nmclibl like  \"%" & sel & "%\" order by " & tribl2 & " desc ")
    ' Else
    'If Tribl = "libel_ligbl" And If IsNull(sel) Then
    'Tribl2 = "numbl"
    'Utils.Base3(Colbl, "select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac from " & Cbase.Table("TabBl") & "  where nmclibl like  \"%" & sel & "%\" order by " & tribl2 & " desc ")
    'Endif
    'Endif
    'Endif
  Endif
  Colbl.Refresh
  
End

Public Sub Colbl_com()
  
  Dim rLib As Result
  Dim rLib2 As Result
  Dim BlTab As String = "Blcom"
  
  Me.mouse = mouse.Wait
  Utils.db.Exec("CREATE TEMPORARY TABLE " & BlTab &
    "(numbl Char(6) NOT NULL," &
    "type Char(1) ," &
    "cdclibl Char(8) ," &
    "nmclibl CHAR(50) ," &
    "pnmclibl CHAR(35) ," &
    "datebl date ," &
    "imp Integer(1), " &
    "numfac Char(10), " &
    "PRIMARY KEY (numbl))" & "ENGINE = MYISAM")
  rLib = Utils.db.Exec("select distinct num_ligbl, com_ligbl from " & Cbase.Table("TabLigbl") & " where com_ligbl like \"%" & sel & "%\" and typel_ligbl = &1 order by num_ligbl", "C")
  If rLib.Available Then
    Repeat
      rLib2 = Utils.db.Exec("select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac  from " & Cbase.Table("TabBl") & "  where numbl = &1", rLib!num_ligbl)
      If rLib2.Available Then
        Repeat
          For Each Commentaire In Split(Rlib!com_ligbl, "\n")
            If Not IsNull(commentaire) And If Not IsNull(Split(Commentaire, " ")) Then
              Break
            Endif
          Next
          Try Utils.db.Exec("insert into " & BlTab & " (imp, numbl, type, datebl, cdclibl, nmclibl, pnmclibl, numfac  ) values (&1,&2,&3,&4,&5, &6,&7,&8)", rLib2!imp, rLib2!numbl, rLib2!type, rLib2!datebl, rLib2!cdclibl, commentaire, rLib2!nmclibl, rLib2!numfac)
        Until rLib2.MoveNext()
      Endif
    Until rLib.MoveNext()
  Endif
  Utils.Base3(Colbl, "select * from " & BlTab & " order by numbl")
  Colbl.Refresh
  Utils.db.Exec("drop TABLE " & BlTab & "")
  Me.mouse = mouse.Default
  
End

Public Sub Colbl_art()
  
  Dim rLib As Result
  Dim rLib2 As Result
  Dim BlTab As String = "Blcom"
  
  Me.mouse = mouse.Wait
  Utils.db.Exec("CREATE TEMPORARY TABLE " & BlTab &
    "(numbl Char(6) NOT NULL," &
    "type Char(1) ," &
    "cdclibl Char(8) ," &
    "nmclibl CHAR(50) ," &
    "pnmclibl CHAR(35) ," &
    "datebl date ," &
    "imp Integer(1), " &
    "numfac Char(10), " &
    "PRIMARY KEY (numbl))" & "ENGINE = MYISAM")
  rLib = Utils.db.Exec("select distinct num_ligbl, com_ligbl from " & Cbase.Table("TabLigbl") & " where code_ligbl like \"%" & sel & "%\" and typel_ligbl = &1 order by num_ligbl", "A")
  If rLib.Available Then
    Repeat
      rLib2 = Utils.db.Exec("select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac  from " & Cbase.Table("TabBl") & "  where numbl = &1", rLib!num_ligbl)
      If rLib2.Available Then
        Repeat
          Try Utils.db.Exec("insert into " & BlTab & " (imp, numbl, type, datebl, cdclibl, pnmclibl, numfac  ) values (&1,&2,&3,&4,&5, &6,&7)", rLib2!imp, rLib2!numbl, rLib2!type, rLib2!datebl, rLib2!cdclibl, rLib2!nmclibl, rLib2!numfac)
        Until rLib2.MoveNext()
      Endif
    Until rLib.MoveNext()
  Endif
  Utils.Base3(Colbl, "select * from " & BlTab & " order by numbl")
  Colbl.Refresh
  Utils.db.Exec("drop TABLE " & BlTab & "")
  Me.mouse = mouse.Default
  
End

Public Sub Colbl_libel()
  
  Dim rLib As Result
  Dim rLib2 As Result
  Dim BlTab As String = "Blcom"
  
  Me.mouse = mouse.Wait
  Utils.db.Exec("CREATE TEMPORARY TABLE " & BlTab &
    "(numbl Char(6) NOT NULL," &
    "type Char(1) ," &
    "cdclibl Char(8) ," &
    "nmclibl CHAR(50) ," &
    "pnmclibl CHAR(35) ," &
    "datebl date ," &
    "imp Integer(1), " &
    "numfac Char(10), " &
    "PRIMARY KEY (numbl))" & "ENGINE = MYISAM")
  rLib = Utils.db.Exec("select distinct num_ligbl, com_ligbl from " & Cbase.Table("TabLigbl") & " where libel_ligbl like \"%" & sel & "%\" and typel_ligbl = &1 order by num_ligbl", "A")
  If rLib.Available Then
    Repeat
      rLib2 = Utils.db.Exec("select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac  from " & Cbase.Table("TabBl") & "  where numbl = &1", rLib!num_ligbl)
      If rLib2.Available Then
        Repeat
          Try Utils.db.Exec("insert into " & BlTab & " (imp, numbl, type, datebl, cdclibl, pnmclibl, numfac  ) values (&1,&2,&3,&4,&5, &6,&7)", rLib2!imp, rLib2!numbl, rLib2!type, rLib2!datebl, rLib2!cdclibl, rLib2!nmclibl, rLib2!numfac)
        Until rLib2.MoveNext()
      Endif
    Until rLib.MoveNext()
  Endif
  Utils.Base3(Colbl, "select * from " & BlTab & " order by numbl")
  Colbl.Refresh
  Utils.db.Exec("drop TABLE " & BlTab & "")
  Me.mouse = mouse.Default
  
End

Public Sub Deb2()
  
  Tab = "Fiches_Bl"
  Colbl.Clear
  Utils.Base3(Colbl, "select imp, type, numbl, datebl, cdclibl, nmclibl, pnmclibl, numfac from " & Cbase.Table("TabBl") & "  where " & TriBl & " like  \"%" & sel & "%\" order by " & tribl2 & " asc")
  Colbl.Refresh
  
End

Public Sub ChkInput2()
  
  If Key.code = Key.Return Or Key.code = Key.Enter Then
    If Tribl = "com_ligbl" Then
      If Not IsNull(sel) Then Colbl_com()
    Endif
    If Tribl = "code_ligbl" Then
      If Not IsNull(sel) Then Colbl_art()
    Endif
    If Tribl = "libel_ligbl" Then
      If Not IsNull(sel) Then Colbl_libel()
    Endif
  Else
    If IsNull(sel) Then sel2 = ""
    If InStr("\"&", Key.Text) = 0 Then
      sel = utils.Obstch(sel)
      If tribl = "nmclibl" Then
        Deb2()
      Else
        If TriBl = "datebl" And Len(sel) = 0 Then
          sel2 = ""
          Deb1()
        Else
          If TriBl = "datebl" And Len(sel) = 4 Then
            sel2 = "%-" & Right$(sel, 2) & "-" & Left$(sel, 2)
            Deb1()
          Else
            If TriBl = "datebl" And Len(sel) = 8 Then
              sel2 = Right$(sel, 2) & "-" & Mid$(sel, 3, 2) & "-" & Left$(sel, 2)
              Deb1()
            Else
              If TriBl <> "datebl" And If Tribl <> "com_ligbl" And Tribl <> "code_ligbl" And Tribl <> "libel_ligbl" Then Deb1
            Endif
          Endif
        Endif
      Endif
    Else
      Stop Event
    Endif
  Endif
  
End

Public Sub Dbclkcli()
  
  If Not Dbl Then
    Deb2()
    Dbl = "1"
  Else
    Deb1()
    Dbl = ""
  Endif
  
End

Public Sub Titre()
  
  TYB.Text = "T"
  NUMB.Text = "N° Bl"
  DAB.Text = "Date"
  COB.Text = "Code"
  If ComboCom = False Then NOB.Text = "Nom client"
  PRB.Text = "Prénom client"
  NUMF.Text = "N° facture"
  
End

Public Sub TYB_Click()
  
  sel = ""
  Dbl = ""
  ComboCom = False
  Titre()
  TYB.Text = ""
  TriBl = "type"
  tribl2 = "type, numbl"
  Deb1()
  
End

Public Sub TYB_Dblclick()
  
  sel = ""
  Dbclkcli()
  
End

Public Sub TYB_GotFocus()
  
  Try Utils.ObsGotf(tyb)
  TYB_Click()
  TYB.SetFocus
  
End

Public Sub TYB_LostFocus()
  
  Try Utils.ObsLstf(TYB)
  
End

Public Sub TYB_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  Chkinput2()
  
End

Public Sub NUMB_Click()
  
  sel = ""
  Dbl = ""
  ComboCom = False
  Titre()
  NUMB.Text = ""
  TriBl = "numbl"
  tribl2 = "numbl"
  Deb1()
  
End

Public Sub NUMB_Dblclick()
  
  sel = ""
  Dbclkcli()
  
End

Public Sub NUMB_GotFocus()
  
  Try Utils.ObsGotf(numb)
  NUMB_Click()
  NUMB.SetFocus
  
End

Public Sub NUMB_LostFocus()
  
  Try Utils.ObsLstf(NUMB)
  
End

Public Sub NUMB_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  Chkinput2()
  
End

Public Sub DAB_Click()
  
  sel = ""
  Dbl = ""
  ComboCom = False
  Titre()
  DAB.Text = ""
  TriBl = "datebl"
  tribl2 = "datebl asc, numbl"
  Deb1()
  
End

Public Sub DAB_Dblclick()
  
  sel = ""
  tribl2 = "datebl desc, numbl"
  Deb1()
  
End

Public Sub DAB_GotFocus()
  
  Try Utils.ObsGotf(dab)
  DAB_Click()
  DAB.SetFocus
  
End

Public Sub DAB_LostFocus()
  
  Try Utils.ObsLstf(DAB)
  
End

Public Sub DAB_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  Chkinput2()
  
End

Public Sub COB_Click()
  
  sel = ""
  Dbl = "1"
  ComboCom = True
  Titre()
  COB.Text = ""
  TriBl = "cdclibl"
  tribl2 = "cdclibl asc, numbl"
  Deb2()
  
End

Public Sub COB_Dblclick()
  
  sel = ""
  tribl2 = "cdclibl desc, numbl"
  Deb1()
  
End

Public Sub COB_GotFocus()
  
  Try Utils.ObsGotf(Cob)
  COB_Click()
  COB.SetFocus
  
End

Public Sub COB_LostFocus()
  
  Try Utils.ObsLstf(COB)
  
End

Public Sub COB_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  Chkinput2()
  
End

Public Sub NOB_Click()
  
  ComboCom = True
  sel = ""
  Dbl = ""
  Titre()
  TriBl = "nmclibl"
  tribl2 = "nmclibl, numbl"
  Deb2()
  If NOB.Text = "Commentaire" Then
    TriBl = "com_ligbl"
    tribl2 = "com_ligbl, numbl"
    Combocom = False
    If Not IsNull(sel) Then Colbl_com()
  Endif
  If NOB.Text = "Code produit" Then
    TriBl = "code_ligbl"
    tribl2 = "code_ligbl, numbl"
    Combocom = False
    If Not IsNull(sel) Then Colbl_com()
  Endif
  If NOB.Text = "Libellé produit" Then
    TriBl = "libel_ligbl"
    tribl2 = "libel_ligbl, numbl"
    Combocom = False
    If Not IsNull(sel) Then Colbl_com()
  Endif
  NOB.Text = ""
  NOB.Select
  
End

Public Sub NOB_MouseUp()
  
  NOB.Text = ""
  NOB.Select
  sel = ""
  Dbl = ""
  TriBl = "nmclibl"
  tribl2 = "nmclibl, numbl"
  Deb2()
  
End

Public Sub NOB_Dblclick()
  
  sel = ""
  If TriBl <> "com_ligbl" Then Dbclkcli()
  
End

Public Sub NOB_GotFocus()
  
  Try Utils.ObsGotf(NOB)
  'NOB_Click()
  'NOB.SetFocus
  
End

Public Sub NOB_LostFocus()
  
  Try Utils.ObsLstf(NOB)
  
End

Public Sub NOB_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  ComboCom = True
  Chkinput2()
  
End

Public Sub NUMF_Click()
  
  sel = ""
  Dbl = ""
  ComboCom = False
  Titre()
  NUMF.Text = ""
  TriBl = "numfac"
  TriBl2 = "numfac"
  Deb1()
  
End

Public Sub NUMF_Dblclick()
  
  sel = ""
  Dbclkcli()
  
End

Public Sub NUMF_GotFocus()
  
  Try Utils.ObsGotf(Numf)
  NUMF_Click()
  NUMF.SetFocus
  
End

Public Sub NUMF_LostFocus()
  
  Try Utils.ObsLstf(NUMF)
  
End

Public Sub NUMF_KeyPress()
  
  If key.code = Key.F2 Then
    RdimColbl()
    Stop Event
  Endif
  Chkinput2()
  
End

'************************************************************************
'* Gestion des avoirs a partir d'une facture existante par le bouton    *
'************************************************************************
Public Sub Creation(Avr2 As Boolean)
  
  Dim MyForm As TriFac
  Dim MyForm2 As TriFac2
  
  Tri = "numfac"
  Nvc = 0
  Nv = 1
  Panel9.visible = False
  Coldetail.clear
  If Not IsNull(num.Text) And Tottc.Text = "0,00" Or If Not IsNull(num.Text) And Tottc.Text = "0" Then
    Coldetail3.Columns.count = 9
    Coldetail3.Columns[0].Width = 50
    Coldetail3.Columns[2].Alignment = Align.TopLeft
    Coldetail3.Columns[1].Width = 110
    Coldetail3.Columns[2].Width = 240
    Coldetail3.Columns[3].Width = 92
    Coldetail3.Columns[4].Width = 60
    Coldetail3.Columns[5].Width = 92
    Coldetail3.Columns[6].Width = 55
    Coldetail3.Columns[7].Width = 92
    Coldetail3.Columns[8].Width = 30
    Coldetail3.Columns[0].Text = "N° Lig"
    Coldetail3.Columns[1].Text = "Code"
    Coldetail3.Columns[2].Text = "Désignation"
    Coldetail3.Columns[3].Alignment = 2
    Coldetail3.Columns[3].Text = "Px Unitaire"
    Coldetail3.Columns[4].Alignment = 2
    Coldetail3.Columns[4].Text = "Qté/Tps"
    Coldetail3.Columns[5].Alignment = 2
    Coldetail3.Columns[5].Text = "Px brut"
    Coldetail3.Columns[6].Alignment = 2
    Coldetail3.Columns[6].Text = "Remise"
    Coldetail3.Columns[7].Alignment = 2
    Coldetail3.Columns[7].Text = "Px net"
    Coldetail3.Columns[8].Alignment = 4
    Coldetail3.Columns[8].Text = " TL "
    If Avr2 = True Then
      If Not IsNull(code.Text) Then
        MyForm = New TriFac(code.text)
      Else
        MyForm = New TriFac("")
      Endif
      MyForm.Showmodal()
    Else
      If Not IsNull(code.Text) Then
        MyForm2 = New TriFac2(code.text)
      Else
        MyForm2 = New TriFac2("")
      Endif
      MyForm2.Showmodal()
    Endif
    If Bsel = True Then
      EntFac()
    Endif
  Else
    Balloon.Warning(("Veuillez cliquer sur le bouton nouveau avant de saisir un avoir SVP "), Button2)
  Endif
  
End

Public Sub Button25_Click()
  
  Avr = False
  Bdevis.Value = True
  If Settings["/Soc" & Start.Societe & "/SelDev"] Then
    Seltot.value = True
  Else
    Selpart.Value = True
  Endif
  Creation(avr)
  
End

Public Sub Button26_Click()
  
  Avr = True
  Bbon.Value = True
  If Settings["/Soc" & Start.Societe & "/SelDev"] Then
    Seltot.value = True
  Else
    Selpart.Value = True
  Endif
  Creation(avr)
  
End

Public Sub Button29_Click()
  
  Panel9.Visible = False
  Return
  
End

Public Sub Button27_Click()
  
  Panel9.Visible = False
  If Not IsNull(code.text) Then
    If start.son Then
      Music.Play
    Endif
    If message.Question("Attention ! Le fichier 'inventaire.txt' du portable doit être vidé dans le repertoire " & "~/Portable !") = 1 Then
      GenFacPort()
    Endif
  Else
    Balloon.Warning(("Veuillez selectionner un client avant de faire l'import SVP "), Code)
    Code.setfocus
  Endif
  
End

Public Sub Button30_Click()
  
  Dim hForm As Gsm
  
  hForm = New Gsm(telPort.Text)
  hForm.Showmodal()
  
End
