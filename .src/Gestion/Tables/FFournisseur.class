' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Ffournisseur.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/11/2004
'# Gestion de la table des fournisseurs
'################################################
'

N As Integer
Tri As String
Tab As String
Sel As String
fourtable[8] As String
type As String
Enr As Integer
son As Integer = Start.Son
sKey As String
Dbl As String
CoulZnaf As Integer ' Variable pour la couleur du background
CoulFc As Integer ' Variable pour la couleur du focus
b As Integer = 0 'gestion de sortie du franco
sCentrale As String
i2 As Integer
txtPosX As Integer
txtPosY As Integer
Filename As String
Nblargeur As String
Nbhauteur As String
Largeur As Integer
Hauteur As Integer
Mrghaut As Integer
Mrgauche As Integer
Esplargeur As Integer
Esphauteur As Integer
sSociete As String
sAdr1 As String
sAdr2 As String
sCP As String
Nbetq As Integer = 1
Nb As Boolean = False
sFetiq As String
Private Fichier As String
Private hCfour As Boolean = False
Private pdf As Cetiquettes
Private Tableau As String[]
Public Bsel As Boolean = False
Public Codepostal As String
Public Bureaudistributeur As String

Public Sub _New()

  Dim Frmt As String[]
  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Identite"

  Music.Load(Start.Musique)
  Me.Center
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znaff"])
  CoulZnaf = Val(Frmt[0])
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Focus"])
  Coulfc = Val(Frmt[0])
  Utils.Observers(Me)
  If Start.LocalSettings["/Soc" & Start.Societe & "/Sms"] = 0 Then Button19.visible = False
  n = 1
  C1.Text = "Code"
  C2.Text = "CV"
  N1.Text = "Nom"
  P1.Text = "Prénom"
  A1.Text = "Adresse 1"
  A2.Text = "Adresse 2"
  cp1.Text = "CP"
  V1.Text = "Ville"
  codebanque.SetFocus()
  codebanque.Select
  Cv.Text = ""
  Cv.Setfocus
  Cv.Select
  nom_pays()
  Try rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If Not Error Then
    If rResult.Available Then
      '   CV.Add("  ", "00")
      Do
        Try CV.Add(rResult!libelle)
      Loop Until rResult.MoveNext()
    Endif
  Endif
  Try rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCentrales") & " ")
  If Not Error Then
    If rResult.Available Then
      Do
        Try Centrale.Add(rResult!code & " - " & rResult!libelle)
      Loop Until rResult.MoveNext()
      Centrale.Add(" ", "00")
    Endif
  Endif
  Colal2.Columns.count = 4
  Colal2.Columns[0].Width = 0
  Colal2.Columns[1].Width = 150
  Colal2.Columns[2].Width = 150
  Colal2.Columns[3].Width = 150
  Colal2.Columns[1].Text = "Nom"
  Colal2.Columns[2].Text = "Prénom"
  Colal2.Columns[3].Text = "Fonction"

End

Public Sub Cfour_Data(Row As Integer, Column As Integer)

  With Utils

    fourtable[0] = "fo_code"
    fourtable[1] = "fo_rs_soc"
    fourtable[2] = "fo_nom"
    fourtable[3] = "fo_pnm"
    fourtable[4] = "fo_adr1"
    fourtable[5] = "fo_adr2"
    fourtable[6] = "fo_cd_ptl"
    fourtable[7] = "fo_ville"
    Try .rs1.MoveTo(Row)
    If (row Mod 2) = 0 Then
      If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then
        Cfour.Data.Background = CoulZnaf
      Else
        Cfour.Data.Background = Color.TextBackground
      Endif
    Else
      If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then
        Cfour.Data.Background = &HFAFAFA&
      Else
        Cfour.Data.Background = &HEBD0C2&
      Endif
    Endif
    Try Cfour.data.Text = Str(.rs1[fourtable[Column]])
    If Not Error Then
      If Column = 8 Then Cfour.Data.Alignment = 1
    Endif
  End With

End

Public Sub Form_Open()

  Tab = "Fiches_Four"
  Tri = "fo_code"
  Tris()
  sel = ""
  Deb2()
  Nm.SetFocus

End

Public Sub nom_pays()

  Dim hfil As File
  Dim Lig As String

  HFil = Open "Pays.txt" For Read
  Pays.Clear
  While Not Eof(hFil)
    Line Input #hFil, Lig
    Pays.Add(Lig)
  Wend

End

Public Sub Tabfour3_click()

  Utils.Observers(Me)

End

Public Sub Tris()

  With Cfour

    .Columns.count = 8
    .Columns[0].Width = C1.Width
    .Columns[1].Width = C2.Width
    .Columns[2].Width = N1.Width
    .Columns[3].Width = P1.Width
    .Columns[4].Width = A1.Width
    .Columns[5].Width = A2.Width
    .Columns[6].Width = cp1.Width
    .Columns[7].Width = V1.Width
  End With

End

Public Sub Deb2()

  Utils.Base(Cfour, "select * from " & Tab & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & "")
  Cfour.Refresh

End

Public Sub Deb3()

  Utils.Base(Cfour, "select * from " & Tab & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & " desc")
  Cfour.Refresh

End

Public Sub Maj_Zones()

  Dim rcli As Result
  Dim $Mail As String

  button2.text = "Creer"
  button4.text = "Enregistrer"
  If Cfour.Rows.Count Then
    Cd.Text = Cfour[Cfour.row, 0].Text
    rCli = Utils.db.Exec("select * from " & Cbase.Table("TabFour") & " Left join Fiches_Comptes on compte_cc = fo_code where fo_code = &1", Cd.Text)
    Try Lettrable.value = rcli!lettrable
    CV.Text = rcli!fo_rs_soc
    Nm.Text = rcli!fo_nom
    Pnm.Text = rcli!fo_pnm
    Adresse1.Text = rcli!fo_adr1
    Adresse2.Text = rcli!fo_adr2
    cp.Text = rcli!fo_cd_ptl
    Burdist.text = rcli!fo_ville
    $Mail = rcli!fo_email
    TelStd.text = rcli!fo_tel_std
    Telbur.text = rcli!fo_tel_bur
    poste.text = rcli!fo_tel_post
    portable.text = rcli!fo_pble
    Fax1.text = rcli!fo_fx1
    Fax2.text = rcli!fo_fx2
    codebanque.Text = rcli!fo_cd_bq
    codeguichet.Text = rcli!fo_cd_gch
    Dom.Text = rcli!fo_dom
    Cle.Text = rcli!fo_cle_rib
    numcompte.Text = rcli!fo_num_cpt
    Idtva.Text = rcli!fo_id_tva
    NtcdClient.Text = rcli!fo_cd_cli
    Divers.text = rcli!fo_obs
    collectif.Text = rcli!fo_collectif
    site.text = rcli!fo_site
    Cdech.Text = rcli!fo_cdech
    If Not Cdech.Text Then Cdech.Text = "00"
    Pays.Text = rcli!fo_pays
    Try Franco.Text = Format$(rcli!fo_franco, "0.00")
    Try MinCom.Text = Format$(rcli!fo_mincom, "0.00")
    Try Fport.Text = Format$(rcli!fo_fport, "0.00")
    If Not Franco.Text Then Franco.Text = "0,00"
    Try CheckBox1.Value = rcli!fo_centrale
    sCentrale = rcli!fo_ccentrale
    Aff_Centrale(sCentrale)
    Try Copie.Value = rcli!fo_copie
    Try Iban.Text = rcli!fo_iban
    Try Bic.Text = rcli!fo_bic
    Try exo.Value = rcli!fo_exo
    cb.Text = rcli!fo_cb
    Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailFour") & " where code = &1 order by mail", Cd.text)
    If Rcli.Available Then
      Repeat
        Email.Add(Rcli!mail)
      Until Rcli.MoveNext()
    Endif
    Email.Text = $Mail
  Endif

End

Public Sub CleanVtl()

  Compt.Text = ""
  intitule.Text = ""

End

Public Sub Refresh()

  vents.clear
  form_Open()

End

Public Sub CleanChamps()
  'Mise à blanc des champs

  Cv.Text = ""
  Cd.Clear
  Nm.Clear
  Pnm.Clear
  Adresse1.Clear
  Adresse2.Clear
  cp.Clear
  Burdist.Clear
  Email.Clear
  Telbur.Clear
  Telstd.Clear
  Poste.Clear
  Portable.Clear
  Fax1.Clear
  Fax2.Clear
  codebanque.Clear
  codeguichet.Clear
  Cle.Clear
  numcompte.Clear
  Dom.Clear
  Divers.Clear
  collectif.Text = ""
  Compt.Clear
  site.Clear
  Cdech.Clear
  Idtva.Clear
  NtcdClient.clear
  Pays.Text = ""
  Franco.Text = "0,00"
  MinCom.Text = "0,00"
  Fport.Text = "0,00"
  CheckBox1.value = False
  Centrale.Text = ""
  Dssr.Clear
  Copie.value = False
  Iban.Clear
  Bic.Clear
  Exo.value = False
  cb.Clear
  Lettrable.value = True

End

Public Sub Email_KeyPress()

  Dim rmail As Result
  Dim $Mail As String = Email.Text

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Maj_Email()
    Email.Text = $Mail
    fax2.SetFocus
    fax2.Select
    Stop Event
  Endif

  If key.code = key.Delete Then
    If Not IsNull(Email.text) Then
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMailFour") & " WHERE code = &1 and mail = &2", cd.Text, Email.Text)
      Rmail = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailFour") & " where code = &1 order by mail", Cd.text)
      If Rmail.Available Then
        Email.clear
        Repeat
          Email.Add(Rmail!mail)
        Until Rmail.MoveNext()
        Utils.db.Exec("Update " & Cbase.Table("TabFour") & "  set fo_email = &2 where fo_code = &1", Cd.Text, Email.Text)
      Endif
    Endif
  Endif

End

Public Sub Email_LostFocus()

  Maj_Email()

End

Public Sub Maj_Email()

  Dim rmail As Result

  If Not IsNull(Email.Text) Then
    Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMailFour") & " (code, mail) VALUES (&1, &2)", Cd.text, Email.text)
    Utils.db.Exec("update " & Cbase.Table("TabFour") & " set fo_email = &2 where fo_code = &1", Cd.Text, Email.Text)
    Rmail = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailFour") & " where code = &1 order by mail", Cd.text)
    If Rmail.Available Then
      Email.clear
      Repeat
        Email.Add(Rmail!mail)
      Until Rmail.MoveNext()
    Endif
  Endif

End

'Gestion SMS

Public Sub Button19_Click()

  Dim hForm As Gsm
  Dim Telp As String

  If Tabfour.Index = 0 Then
    Telp = Portable.Text
    Telp = Replace$(Telp, ".", "")
    Telp = Replace$(Telp, " ", "")
    hForm = New Gsm(Telp)
    hForm.Showmodal()
  Else
    If Tabfour.Index = 4 Then
      Telp = Portable2.Text
      Telp = Replace$(Telp, ".", "")
      Telp = Replace$(Telp, " ", "")
      hForm = New Gsm(Telp)
      hForm.Showmodal()
    Endif
  Endif

End

Public Sub Aff_Centrale(sCentrale As String)

  Dim cResult As Result

  Try cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCentrales") & " where code = &1", sCentrale)
  If Not Error Then
    If cResult.Available Then Centrale.Text = cResult!code & " - " & cResult!libelle
  Else
    If son Then
      Music.Play
    Endif
    message.Error(Error.Text & " " & Error.where)
  Endif

End

Public Sub Cmpt_LostFocus()

  Select Case Last.tag

    Case 8
      If Not IsNull(Email.Text) Then Utils.chkEmail(Email.Text)

    Case 9
      If Not IsNull(collectif.Text) Then collman()
      If Enr = 0 Then
        collectif.SetFocus
        collectif.Select
        collectif.Clear
        Stop Event
      Endif
  End Select

End

Public Sub Cmpt_KeyPress()

  With Utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag

        Case 1
          Nm.SetFocus
          Nm.Select
          Stop Event

        Case 2
          If Cd.Text Then
            Nm.Text = .Remplace(Nm.Text)
            Pnm.SetFocus
            Pnm.Select
          Else
            Message.Warning("Veuillez cliquer sur le bouton 'Créer' avant de remplir les zones SVP !", "Ok")
          Endif
          Stop Event

        Case 3
          Pnm.Text = .Remplace(Pnm.Text)
          Adresse1.SetFocus
          Adresse1.Select
          Stop Event

        Case 4
          Adresse1.Text = .Remplace(Adresse1.Text)
          Adresse2.SetFocus
          Adresse2.Select
          Stop Event

        Case 5
          Adresse2.Text = .Remplace(Adresse2.Text)
          cp.SetFocus
          cp.Select
          Stop Event

        Case 6
          Cpman()
          Stop Event

        Case 7
          Burdist.Text = .Remplace(Burdist.Text)
          Email.SetFocus
          Email.Select
          Stop Event

        Case 8
          If Not IsNull(Email.Text) Then Utils.chkEmail(Email.Text)
          collectif.SetFocus
          collectif.Select
          Stop Event

        Case 9
          collman()
          If Enr = 0 Then
            collectif.SetFocus
            collectif.Select
            Stop Event
          Else
            Fax1.SetFocus
            Fax1.Select
          Endif
          Stop Event

        Case 10
          If Not IsNull(Email.Text) Then
            Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMailFour") & " (code, mail) VALUES (&1, &2)", Cd.text, Email.text)
            Utils.db.Exec("update " & Cbase.Table("TabFour") & " set fo_email = &2 where fo_code = &1", Cd.Text, Email.Text)
          Endif
          fax2.SetFocus
          fax2.Select
          Stop Event

        Case 11
          Telstd.SetFocus
          Telstd.Select
          Stop Event

        Case 12
          Telbur.SetFocus
          Telbur.Select
          Stop Event

        Case 13
          Poste.SetFocus
          Poste.Select
          Stop Event

        Case 14
          Portable.SetFocus
          Portable.Select
          Stop Event

        Case 15
          Cv.SetFocus
          Cv.Select
          Stop Event

      End Select
    Else
      Select Case Last.tag
        Case 9
          Chkcp()
      End Select
    Endif

    If key.code = key.F1 Then
      Button7_Click()
      Stop Event
    Endif

    If Key.code = Key.F2 Then
      Select Case Last.tag
        Case 1
          If Key.code = key.Esc Or Key.code = key.f2 Then
            RdimCfour()
            Stop Event
          Endif
        Case 2
          If Key.code = key.Esc Or Key.code = key.f2 Then
            RdimCfour()
            Stop Event
          Endif
        Case 6
          ToggleButton3_Click()
        Case 9
          ToggleButton2_Click()
          Stop Event
      End Select
    Endif
  End With

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Cnt_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Cmpt2_KeyPress()

  Dim testerTVA As Boolean

  If Key.code = Key.F9 Then
    Select Case Last.tag
      Case 15
        Codebarre()
        Stop Event
    End Select
  Endif

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag

      Case 1
        codeguichet.SetFocus
        codeguichet.Select
        Stop Event

      Case 2
        numcompte.SetFocus
        numcompte.Select
        Stop Event

      Case 3
        Cle.SetFocus
        Cle.Select
        Stop Event

      Case 4
        dom.SetFocus
        dom.Select
        Stop Event

      Case 5
        Idtva.SetFocus
        Idtva.Select
        Stop Event

      Case 6
        '##### Test du Numéro IntraCommunautaire
        If Idtva.Text <> "" Then
          If Mid(Idtva.Text, 1, 2) = "FR" Then
            testerTVA = CTestTVA.isintracomvalide(Idtva.Text)
            If testerTVA Then
              'Message.Info("Numero de TVA correct")
            Else
              Message.Warning("Numéro de TVA incorrect pour la France")
              Stop Event
            End If
          End If
        End If
        '######### FIN #################
        site.SetFocus
        site.Select
        Stop Event

      Case 7
        Ntcdclient.SetFocus
        Ntcdclient.Select
        Stop Event

      Case 8
        Cdech.SetFocus
        Cdech.Select
        Stop Event

      Case 9
        Franco.SetFocus
        Franco.Select
        Stop Event

      Case 10
        FrancoLF()
        If b = 1 Then
          Franco.SetFocus
          Franco.Select
          b = 0
        Else
          MinCom.SetFocus
          MinCom.Select
        Endif
        Stop Event

      Case 11
        MinComLF()
        If b = 1 Then
          MinCom.SetFocus
          MinCom.Select
          b = 0
        Else
          Fport.SetFocus
          Fport.Select
        Endif
        Stop Event

      Case 12
        FportLF()
        If b = 1 Then
          Fport.SetFocus
          Fport.Select
          b = 0
        Else
          Iban.SetFocus
          Iban.Select
        Endif
        Stop Event

      Case 13
        Bic.SetFocus
        Bic.Select
        Stop Event

      Case 14
        Cb.SetFocus
        Cb.Select
        Stop Event

      Case 15
        codebanque.SetFocus
        codebanque.Select
        Stop Event

    End Select
  Else
    Select Case Last.tag
      Case 10
        Chkfranco()
    End Select
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 9
        ToggleButton5_Click()
        Stop Event
    End Select
  Endif

End

'***********************************************
'*      Controle coherence du code a barre     *
'***********************************************
Public Sub CtrlBarre()

  Dim Cle As Integer

  If Len(Cb.Text) <> 8 And Len(Cb.Text) <> 13 Then
    Try Message.Warning("Le code barre n'est pas à la norme EAN13 ! \n Il doit avoir une longueur de 8 ou 13 caracteres.", "OK")
    b = 1
  Else
    If Len(Cb.text) = 13 Then
      'Cle = Utils.Calcode(Cb.Text)
      Cle = Utils.Calcode(Left$(Cb.Text, 12))
      If Cle <> Right$(Cb.Text, 1) Then
        If son Then
          Music.Play
        Endif
        Try Message.Warning("Le code barre n'est pas à la norme EAN13 ! Sa cle doit etre : " & Cle, "OK")
        b = 1
      Endif
    Endif
  Endif

End

'*************************************
'*      Création du code a barre     *
'*************************************
Public Sub Codebarre()

  If Cb.Text <> "" Then
    If start.son Then
      Music.Play
    Endif
    If Message.Question(" Attention ! Il existe déjà un code. Voulez-vous le remplacer ?", " Oui ", " Non ") = 1 Then
      Calc_barre()
    Endif
  Endif
  If Cb.Text = "" Then
    Calc_barre()
  Endif

End

'********************************************
'*  Controle si presence d'un code barre    *
'********************************************
Public Sub CtrlCbarre()

  Dim Rcbarre As Result

  Rcbarre = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCarte") & " where cb = &1 ", Cb.Text)
  If Rcbarre.Available And Cb.Text <> "" Then
    If Rcbarre!code <> Cb.text Then
      If son Then
        Music.Play
      Endif
      Balloon.Warning(("Le code barre est déjà attribué au fournisseur " & Rcbarre!code & "  !"), Cb)
      b = 1
      Cb.SetFocus
      Cb.Select
    Endif
  Endif

End

'************************************
'*       Generation code barre      *
'************************************
Public Sub Calc_barre()

  Dim Rb As String
  Dim Cle As Integer

  Rb = ""
  Rb = "299999" & Cd.Text
  Cle = Utils.Calcode(Rb)
  Cb.Text = Rb & Cle

End Sub

Public Sub Cnt_KeyPress()

  With utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag

        Case 1
          Nm3.SetFocus
          Nm3.Select
          Stop Event

        Case 2
          Nm3.Text = .Remplace(Nm3.Text)
          Pnm3.SetFocus
          Pnm3.Select
          Stop Event

        Case 3
          Pnm3.Text = .Remplace(Pnm3.Text)
          Tel2.SetFocus
          Tel2.Select
          Stop Event

        Case 4
          Portable2.SetFocus
          Portable2.Select
          Stop Event

        Case 5
          Mail2.SetFocus
          Mail2.Select
          Stop Event

        Case 6
          Fonction.SetFocus
          Fonction.Select
          Stop Event
      End Select
    Endif
  End With
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

'*********************************************
'*      On gère le franco du fournisseur     *
'*********************************************
Public Sub FrancoLF()

  With Utils
    If Not Franco.Text Then Franco.Text = "0"
    Franco.Text = .cpoint(Franco.Text)
    If Val(Franco.Text) = Null Then
      If son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      Franco.Text = Format$(Val(Franco.Text), "0.00")
      b = 0
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  b = 1

End

'************************************************
'*  On gère les frais de port du fournisseur    *
'************************************************
Public Sub FportLF()

  With Utils
    If Not Fport.Text Then Fport.Text = "0"
    Fport.Text = .cpoint(Fport.Text)
    If Val(Fport.Text) = Null Then
      If son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      Fport.Text = Format$(Val(Fport.Text), "0.00")
      b = 0
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  b = 1

End

'***************************************
'*   On gère le minimum de commande    *
'***************************************
Public Sub MinCoMLF()

  With Utils
    If Not MinCom.Text Then MinCom.Text = "0"
    MinCom.Text = .cpoint(MinCom.Text)
    If Val(MinCom.Text) = Null Then
      If son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      MinCom.Text = Format$(Val(MinCom.Text), "0.00")
      b = 0
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  b = 1

End

Public Sub Cmpt2_LostFocus()

  Select Case Last.tag

    Case 15
      If Left$(Cb.Text, 1) = "*" Then Cb.Text = Mid$(Cb.Text, 2, Len(Cb.Text) - 1)
      Utils.Find_cbarre(Cb.Text)
      If Not IsNull(Cb.Text) Then
        CtrlBarre()
        CtrlCbarre()
        If b = 1 Then
          Cb.SetFocus
          Cb.Select
          b = 0
        Endif
      Endif
  End Select

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt2_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Btn_Click()

  Select Case Last.tag
    Case 1
      Button7_Click()

    Case 2
      Button1_Click()

    Case 3
      Button2_Click()

    Case 4
      Button3_Click()

    Case 5
      Button4_Click()

    Case 6
      Me.Close

    Case 7
      Button14_Click()

    Case 8
      Button15_Click()

    Case 9
      Panel2.visible = False

  End Select

End

Public Sub Cmpt3_KeyPress()

  Select Case Last.tag
    Case 1
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Compt_LostFocus()
        Stop Event
      Endif

      If key.code = key.F1 Then
        Button7_Click()
        Stop Event
      Endif

  End Select
  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        ToggleButton1_Click()
        Stop Event
    End Select
  Endif

End

Public Sub Vnt_Click()

  Select Case Last.tag
    Case 1
      Enrgvent()
      Compt_GotFocus()
      Compt.SetFocus
      Compt.Select
  End Select

End

Public Sub Vnt_KeyPress()

  Select Case Last.tag
    Case 1
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Enrgvent()
        Compt_GotFocus()
        Compt.SetFocus
        Compt.Select
        Stop Event
      Endif
  End Select

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

Public Sub C1_GotFocus()

  Try Utils.ObsGotf(C1)
  C1_Click()

End

Public Sub C1_LostFocus()

  Try Utils.ObsLstf(C1)

End

Public Sub N1_GotFocus()

  Try Utils.ObsGotf(N1)
  N1_Click()

End

Public Sub N1_LostFocus()

  Try Utils.ObsLstf(N1)

End

Public Sub A1_GotFocus()

  Try Utils.ObsGotf(a1)
  A1_Click()

End

Public Sub A1_LostFocus()

  Try Utils.ObsLstf(A1)

End

Public Sub cp1_GotFocus()

  Try Utils.ObsGotf(cp1)
  cp1_Click()

End

Public Sub cp1_LostFocus()

  Try Utils.ObsLstf(Cp1)

End

Public Sub V1_GotFocus()

  Try Utils.ObsGotf(v1)
  V1_Click()

End

Public Sub V1_LostFocus()

  Try Utils.ObsLstf(V1)

End

Public Sub Compt_GotFocus()

  Try Utils.ObsGotf(Compt)

End

Public Sub Compt_LostFocus()

  Ventilman()
  Try Utils.ObsLstf(Compt)

End

Public Sub collman()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Comptes"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where compte_cc = &1", collectif.Text)
  If rResult.Available Then
    If Not rResult!coll Or If rResult!coll And Left$(collectif.Text, 2) <> "40" Then
      If son Then
        Music.Play
      Endif
      Message.Warning("Attention ! Ce compte n'est pas un collectif fournisseur", "OK")
      Collectif.SetFocus
      Enr = 0
      Return
    Else
      Enr = 1
    Endif
  Else
    If son Then
      Music.Play
    Endif
    Message.Error("Attention ! Ce collectif n'existe pas.")
    Enr = 0
  Endif
Catch

End

Public Sub Ventilman()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Comptes"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where compte_cc = &1", Compt.Text)
  If Not rResult.Available Then
    Enr = 0
    If son Then
      Music.Play
    Endif
    Message.Error("Attention ! Ce compte n'existe pas.")
  Else
    If rResult!type_cc = "F" Or rResult!type_cc = "C" Or rResult!coll Then
      Message.Warning("Vous ne pouvez pas sasir ce type de compte dans les ventilations !")
      Compt.clear
      Compt.SetFocus
      Enr = 0
    Else
      Enr = 1
      Compt.text = rResult!compte_cc
      intitule.text = rResult!intitule_cc
      Button6.SetFocus
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub Cfour_Click()

  ' Mise à jour des champs de saisie

  CleanChamps()
  CleanChampsCt()
  Vents.clear
  Maj_Zones()
  Ventilations()
  cp1.Text = "CP"
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  V1.Text = "Ville"
  n = 0
  Aff_Ct()
  Maj_Dssr()
  Cv.SetFocus
  Cv.Select
  If hCfour Then
    cfour.Height = Me.Window.Height / 3.20
    hcfour = False
  Endif

End

Public Sub Cfour_KeyPress()

  If Key.code = key.Esc Or Key.code = key.f2 Then
    RdimCfour()
    Stop Event
  Endif

End

Public Sub RdimCfour()

  If Not hCfour Then
    cfour.Height = Me.Window.Height / 1.04
    hCfour = True
    Deb2()
  Else
    cfour.Height = Me.Window.Height / 3.20
    hCfour = False
  Endif

End

Public Sub Ventilations()

  Dim Tab As String
  Dim rResult As Result

  Tab = "Fiches_Four_Vtl"
  Vents.Columns.count = 2
  Vents.Columns[0].Width = 65
  Vents.Columns[1].Width = 280
  Vents.Columns[0].Text = "code"
  Vents.Columns[1].Text = "Intitulé"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE  code = &1 ORDER BY code_vtl", Cd.Text)
  If rResult.Available Then
    Repeat
      Vents.add(rResult!code_vtl, rResult!code_vtl)
      Vents.Item[0] = rResult!code_vtl
      Vents.Item[1] = rResult!intitule_vtl
    Until rResult.MoveNext()
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub Maj_vtl()

  Compt.Text = Vents.current[0]
  intitule.Text = Vents.current[1]

End

Public Sub colfo_Click()

  Vents.clear
  Maj_Zones()
  Ventilations()
  Aff_Ct()
  Cv.SetFocus
  Cv.Select

End

Public Sub colfo_Activate()

  button3_Click()

End

Public Sub Button4_Click()

  Dim rResult As Result
  Dim Col As Boolean
  Dim Tabc As String
  Dim Tabf As String
  Dim Tabp As String
  Dim CountRow As Integer

  With Utils
    Tabp = "Fiches_Parametres"
    Tabc = "Fiches_Comptes"
    Tabf = "Fiches_Four"
    type = "F"
    Nm.Text = .Remplace(Nm.Text)
    Pnm.Text = .Remplace(Pnm.Text)
    Adresse1.Text = .Remplace(Adresse1.Text)
    Adresse2.Text = .Remplace(Adresse2.Text)
    Burdist.Text = .Remplace(Burdist.Text)
    If Not Nm.Text Or Not collectif.Text Or Not cd.Text Then
      If son Then
        Music.Play
      Endif
      Message("Vous devez d'abord remplir les zones obligatoires (nom, collectif...)\n ou cliquez sur le bouton 'Créer' si vous n'avez pas de code fournisseur", "OK")
    Else
      collman()
      If enr = "1" Then
        If button4.text = "Valider" Or button4.text = "V&alider" Then
          Utils.db.Exec("INSERT INTO " & tabf & " (fo_code,fo_col,fo_rs_soc,fo_nom,fo_pnm,fo_adr1,fo_adr2,fo_cd_ptl,fo_ville,fo_email,fo_tel_std,fo_tel_bur,fo_tel_post,fo_pble,fo_fx1,fo_fx2,fo_obs,fo_cd_bq,fo_cd_gch,fo_num_cpt,fo_cle_rib,fo_dom,fo_id_tva,fo_cd_cli,fo_collectif, fo_site, fo_cdech, fo_pays, fo_franco, fo_centrale, fo_ccentrale, fo_copie, fo_mincom, fo_iban, fo_bic, fo_exo, fo_fport, fo_cb) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16},&{17},&{18},&{19},&{20},&{21},&{22},&{23},&{24},&{25}, &{26}, &{27}, &{28}, &{29}, &{30}, &{31}, &{32}, &{33}, &{34}, &{35}, &{36}, &{37}, &{38})", Cd.text, type, CV.text, Nm.text, Pnm.text, Adresse1.text, Adresse2.text, cp.text, Burdist.text, Email.text, Telstd.text, TelBur.text, Poste.text, Portable.text, Fax1.text, Fax2.text, Divers.text, codebanque.text, codeguichet.text, numcompte.text, Cle.text, dom.text, Idtva.text, Ntcdclient.text, collectif.text, site.text, Cdech.text, Pays.Text, Val(.cpoint(Franco.text)), .convBool(CheckBox1.value), Centrale.Text, Copie.value, Val(.cpoint(MinCom.text)), Iban.text, Bic.text, Exo.value, Val(.cpoint(Fport.text)), cb.Text)
          Utils.db.Exec("insert into " & tabc & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11})", Cd.Text, Nm.Text, type, 0, collectif.Text, 0, 0, 0, 0, 0, CBool(Lettrable.value))
          Enrgcp.Ecp(Cp.Text, Burdist.Text)
          If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("Four", "C", Cd.Text, "")
          Button16_Click()
          CleanChampsCt()
          Colal2.Clear
          skey = cd.Text
          Refresh()
          Cleanchamps()
          For CountRow = 0 To (Cfour.Rows.Count - 1)
            If Cfour[CountRow, 0].Text = skey Then
              Cfour.Rows[CountRow].Selected = True
              Break
            Endif
          Next
        Else
          rResult = Utils.db.Exec("Select * From " & Tabc & " where compte_cc = &1", cd.Text)
          If rResult.Available Then
            Utils.db.Exec("UPdate " & tabc & " SET compte_cc = &1, intitule_cc = &2, type_cc = &3, coll_cc = &4, coll = &5,cent_cc = &6, comptr_cc = &7, gen_tv = &8, gen_ta = &9, lettrable = &{10} WHERE compte_cc = &1", Cd.Text, Nm.Text, type, collectif.Text, Col, 0, 0, 0, 0, CBool(Lettrable.value))
          Else
            Utils.db.Exec("insert into " & tabc & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11})", Cd.Text, Nm.Text, type, 0, collectif.Text, 0, 0, 0, 0, 0, CBool(Lettrable.value))
          Endif
          Utils.db.Exec("UPdate " & tabf & "  SET  fo_code = &1, fo_collectif = &2, fo_col = &3, fo_rs_soc = &4 , fo_nom = &5 , fo_pnm = &6 , fo_adr1 = &7 , fo_adr2 = &8 , fo_cd_ptl = &9 , fo_ville = &{10}, fo_email = &{11}, fo_tel_std = &{12}, fo_tel_bur = &{13}, fo_tel_post = &{14}, fo_pble = &{15}, fo_fx1 = &{16}, fo_fx2 = &{17}, fo_obs = &{18}, fo_cd_bq = &{19}, fo_cd_gch = &{20}, fo_cle_rib = &{21}, fo_num_cpt = &{22}, fo_dom = &{23}, fo_id_tva = &{24}, fo_cd_cli = &{25}, fo_site = &{26}, fo_cdech = &{27}, fo_pays = &{28}, fo_franco = &{29}, fo_centrale = &{30}, fo_ccentrale = &{31}, fo_copie = &{32}, fo_mincom = &{33}, fo_iban = &{34}, fo_bic = &{35}, fo_exo = &{36}, fo_fport = &{37}, fo_cb = &{38} WHERE fo_code = &1", Cd.text, collectif.text, type, CV.text, Nm.text, Pnm.text, Adresse1.text, Adresse2.text, cp.text, Burdist.text, Email.text, Telstd.text, Telbur.text, Poste.text, Portable.text, Fax1.text, Fax2.text, Divers.text, codebanque.text, codeguichet.text, Cle.text, numcompte.text, dom.text, Idtva.text, NtcdClient.text, site.text, Cdech.text, Pays.Text, Val(.cpoint(Franco.text)), .convBool(CheckBox1.value), Centrale.Text, Copie.value, Val(.cpoint(MinCom.text)), Iban.text, Bic.text, Exo.value, Val(.cpoint(Fport.text)), cb.text)
          If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("Four", "M", Cd.Text, "")
          Enrgcp.Ecp(Cp.Text, Burdist.Text)
          Button16_Click()
          CleanChampsCt()
          Colal2.Clear
          sKey = Cfour.row
          Cleanchamps()
          Refresh()
          Cfour.MoveTo(skey, 0)
        Endif
        button4.text = "Enregistrer"
      Endif
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

'***************************************************************
'* Gestion du columnview Colcompt2 lors d'une saisie manuelle       *
'********************************************************************
Public Sub Colcompt2_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcompt2.MoveCurrent
    Colcompt2_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcompt2.visible = False
    Colcompt2.clear
    collectif.Select
    collectif.SetFocus
    Stop Event
  Endif

End

Public Sub ToggleButton2_Click()

  Dim rResult As Result
  Dim Tabc As String
  Dim Tabf As String

  Tabc = "Fiches_Comptes"
  Tabf = "Fiches_Four"

  If Colcompt2.visible Then
    Colcompt2.clear
    Colcompt2.visible = False
  Else
    Colcompt2.visible = True
    Colcompt2.Columns.count = 2
    Colcompt2.Columns[0].Width = 65
    Colcompt2.Columns[1].Width = 280
    Colcompt2.Columns[0].Text = "code"
    Colcompt2.Columns[1].Text = "Intitulé"
    rResult = Utils.db.Exec("SELECT * FROM " & Tabc & " where coll = &1 and left(compte_cc,2) = &2 order by cast(compte_cc AS char)", 1, 40)
    If rResult.Available Then
      Repeat
        Colcompt2.Add(rResult!compte_cc, rResult!compte_cc)
        Colcompt2.Item[0] = rResult!compte_cc
        Colcompt2.Item[1] = rResult!intitule_cc
      Until rResult.MoveNext()
    Endif
    Colcompt2.MoveFirst
    Colcompt2.SetFocus
    Colcompt2.Item.Selected = True
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub Colcompt2_Click()

  collectif.text = Colcompt2.Item[0]
  Colcompt2.visible = False
  Colcompt2.clear
  Fax1.Select
  Fax1.SetFocus

End

Public Sub Button3_Click()

  Dim rResult As Result
  Dim Tabv As String
  Dim Tabf As String
  Dim Tabc As String
  Dim tabmvt As String
  Dim Tabcom As String
  Dim Suppr As Integer
  Dim tabrecpt As String
  Dim tabmo As String

  Tabv = "Fiches_Four_Vtl"
  Tabf = "Fiches_Four"
  Tabc = "Fiches_Comptes"
  Tabmvt = "Fiches_Mvt"
  Tabcom = "Fiches_Entcom"
  Tabrecpt = "Fiches_Entrecpt"
  Tabmo = "Fiches_Mo"
  If Not IsNull(cd.text) Then
    Suppr = 1
    If Message.Question("Etes vous sur de vouloir effacer cet enregistrement", "Oui", "Non") = 1 Then
      Me.Mouse = Mouse.Wait
      rResult = Utils.db.Exec("SELECT * FROM " & Tabmvt & " WHERE  compte = &1", Cd.Text)
      If rResult.Available Then
        Message.Warning(" Suppression impossible ! compte Mouvementé")
        Suppr = 0
      Else
        'If Start.LocalSettings["/Soc" & Start.Societe & "/Compta"] <> "1" Then
          rResult = Utils.db.Exec("SELECT * FROM " & Tabmo & " WHERE  mo_four = &1", Cd.Text)
          If rResult.Available Then
            Message.Warning(" Suppression impossible ! compte utilisé dans la table des MO")
            Suppr = 0
          Else
            rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " WHERE  art_four = &1", Cd.Text)
            If rResult.Available Then
              Message.Warning(" Suppression impossible ! compte utilisé dans la table des articles")
              Suppr = 0
            Else
              rResult = Utils.db.Exec("SELECT * FROM " & Tabcom & " WHERE  four = &1", Cd.Text)
              If rResult.Available Then
                Message.Warning(" Suppression impossible ! compte utilisé dans les commandes fournisseurs")
                Suppr = 0
              Else
                rResult = Utils.db.Exec("SELECT * FROM " & Tabrecpt & " WHERE  four = &1", Cd.Text)
                If rResult.Available Then
                  Message.Warning(" Suppression impossible ! compte utilisé dans en réception de marchandises")
                  Suppr = 0
                Endif
              Endif
            Endif
          Endif
        'Endif
      Endif
      If Suppr = 1 Then
        Utils.db.Exec("DELETE FROM " & tabf & " WHERE fo_code = &1", Cd.Text)
        Utils.db.Exec("DELETE from " & tabc & " where compte_cc = &1", Cd.Text)
        Utils.db.Exec("DELETE FROM " & Cbase.Table("TabFdocs") & " WHERE code = &1", Cd.Text)
        rResult = Utils.db.Exec("SELECT * FROM " & Tabv & " WHERE code = &1", Cd.Text)
        If rResult.available Then
          Utils.db.Exec("DELETE from " & Tabv & " where code =&1", Cd.Text)
        Endif
        'Si serveur de prix
        If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("Four", "S", Cd.Text, "")
        sKey = Cfour.row
        Refresh()
        cleanchamps()
        Cfour.MoveTo(skey, 0)
      Endif
      Me.Mouse = Mouse.Pointing
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub Button2_Click()

  Dim tab As String
  Dim tab2 As String
  Dim tabfo As String
  Dim Colcpt As String
  Dim rResult As Result

  Tab = "Fiches_Parametres"
  Tabfo = "Fiches_Four"
  Tab2 = "Fiches_Comptes"
  Button4.Text = "Valider"
  cleanChamps()
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tabfo & " READ")
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If IsNull(rResult!dnf) Or If rResult!dnf < 401000 Then
    Message.Error("Il y a un problème pour la création des comptes fournisseurs \n Veuillez contrôler les paramètres SVP !")
  Else
    Cd.Text = rResult!dnf
    'TODO la gestion de l'increment devrait etre plus générique
    If Val(Cd.Text) = 401999 Then
      Cd.Text = 4011000
    Else
      If Val(Cd.Text) = 4019999 Then
        Cd.Text = 40110000
      Else
        Cd.Text = Val(Cd.Text) + 1
        rResult = Utils.db.Exec("SELECT fo_code FROM " & Tabfo & " where fo_code = &1", Cd.Text)
        If rResult.Available Then
          Message.Warning("Attribution Impossible, le compte " & Cd.Text & " existe déjà, retour à la fin de la liste")
          rResult = Utils.db.Exec("SELECT fo_code FROM " & Tabfo & " order by fo_code desc limit 1", Cd.Text)
          'Il y a forcement un résultat
          Cd.Text = rResult!fo_code + 1
        Endif
      Endif
    Endif
    Utils.db.Exec("Update " & Tab & " set dnf = &1", "401" & Right$(cd.Text, Len(cd.Text) - 3))
    Utils.db.Exec("UNLOCK TABLES")
    Try Copie.Value = Start.LocalSettings["/Soc" & Start.Societe & "/Pdf2"]
    rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " where coll = &1 order by cast(compte_cc AS char)", 1)
    If rResult.Available Then
      Repeat
        Colcpt = rResult!compte_cc
        If Left$(Colcpt, 2) = Left$(Cd.Text, 2) Then collectif.Text = Colcpt
      Until rResult.MoveNext()
    Endif
    Cv.SetFocus
    Cv.Select
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub ToggleButton1_Click()

  Dim MyForm As TriComptes

  Tri = "cast(compte_cc AS char)"
  Type = "G"
  MyForm = New TriComptes(Tri, Type, "", "")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    Compt.text = Comptabilite.sCmpt
    intitule.Text = Comptabilite.sDesg
    Button6.SetFocus
  Endif

End

Public Sub ToggleButton5_Click()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Echeances"
  If Colech.visible Then
    Colech.clear
    Colech.visible = False
  Else
    Colech.visible = True
    Colech.Columns.count = 2
    Colech.Columns[0].Width = 65
    Colech.Columns[1].Width = 280
    Colech.Columns[0].Text = "code"
    Colech.Columns[1].Text = "Intitulé"
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by num")
    If rResult.Available Then
      Repeat
        Colech.Add(rResult!num, rResult!num)
        Colech.Item[0] = rResult!num
        Colech.Item[1] = rResult!libell
      Until rResult.MoveNext()
      Colech.MoveFirst
      Colech.SetFocus
      Colech.Item.Selected = True
    Endif
  Endif

End

Public Sub Colech_Click()

  Cdech.text = Colech.Item[0]
  Colech.visible = False
  Colech.clear

End

'*****************************************************************
'* Gestion du columnview Colech lors d'une saisie manuelle       *
'*****************************************************************
Public Sub Colech_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colech.MoveCurrent
    Colech_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colech.visible = False
    Colech.clear
    Cdech.Select
    Cdech.SetFocus
    Stop Event
  Endif

End

Public Sub Button6_Keypress()

  If Key.code = Key.enter Or Key.code = Key.return Then Button6_click()

End

Public Sub Button6_Click()

  Enrgvent()

End

Public Sub Enrgvent()

  Dim rResult As Result
  Dim Tabv As String

  Tabv = "Fiches_Four_Vtl"
  If Not Nm.TEXT Or Not collectif.TEXT Then
    Message("VOUS DEVEZ D'ABORD REMPLIR LES CHAMPS OBLIGATOIRES(Nom, collectif ...)", "OK")
  Else
    If compt.Text = "" Then
      If son Then
        Music.Play
      Endif
      message.warning("ATTENTION ! Veuillez saisir un compte SVP !", "OK !")
    Else
      Compt_Lostfocus()
      If Enr = 1 Then
        rResult = Utils.db.Exec("SELECT * FROM " & tabv & " WHERE code = &1 AND code_vtl = &2 ", Cd.Text, Compt.Text)
        If rResult.Available Then
          Utils.db.Exec("UPdate " & tabv & " SET code = &1, code_vtl = &2, intitule_vtl = &3 WHERE code = &1 AND code_vtl = &2 ", Cd.Text, Compt.Text, intitule.Text)
        Else
          Utils.db.Exec("INSERT INTO " & tabv & " (code,code_vtl, intitule_vtl) Values (&1,&2,&3)", Cd.Text, Compt.Text, intitule.Text)
        Endif
      Endif
    Endif
  Endif
  Vents.clear
  Ventilations()
  CleanVtl()
  Compt_GotFocus()
  Compt.SetFocus
  Compt.Select

End

Public Sub Vents_Keypress()

  If key.code = key.Delete Then
    Vents_Activate()
  Endif
  Stop Event

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

Public Sub Vents_Activate()

  Dim Tabv As String

  Tabv = "Fiches_Four_Vtl"
  If son Then
    Music.Play
  Endif
  If Message.Question("Etes vous sur de vouloir effacer cet enregistrement", "Oui", "Non") = 1 Then
    Utils.db.Exec("DELETE  FROM " & tabv & " WHERE code = &1 and code_vtl = &2", Cd.Text, Vents.Current[0])
    Refresh()
    Ventilations()
  Endif
  Compt_GotFocus()
  Compt.SetFocus
  Compt.Select

End

Public Sub Button1_Click()

  Dim AdrMail As String = ""

  If TabFour.Index = 0 Then AdrMail = Email.Text
  If TabFour.Index = 4 Then AdrMail = Mail2.Text
  'Exec ["xdg-email", AdrMail]
  EnvMail.Envoi2(AdrMail, "", "", "")

End

Public Sub Dbclk()

  If Not Dbl Then
    Deb3()
    Dbl = "1"
  Else
    Deb2()
    Dbl = ""
  Endif

End

Public Sub C1_Click()

  sel = ""
  CleanChamps()
  ref()
  C1.Text = ""
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_code"
  Deb2()

End

Public Sub C1_Dblclick()

  sel = ""
  CleanChamps()
  ref()
  C1.Text = ""
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_code"
  Dbclk()

End

Public Sub N1_Click()

  sel = ""
  CleanChamps()
  ref()
  C1.Text = "Code"
  N1.Text = ""
  A1.Text = "Adresse 1"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_nom"
  Deb2()

End

Public Sub N1_Dblclick()

  sel = ""
  CleanChamps()
  ref()
  C1.Text = "Code"
  N1.Text = ""
  A1.Text = "Adresse 1"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_nom"
  Dbclk()

End

Public Sub A1_Click()

  sel = ""
  ref()
  A1.Text = ""
  C1.Text = "Code"
  N1.Text = "Nom"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_adr1"
  Deb2()

End

Public Sub A1_Dblclick()

  sel = ""
  ref()
  A1.Text = ""
  C1.Text = "Code"
  N1.Text = "Nom"
  cp1.Text = "CP"
  V1.Text = "Ville"
  Tri = "fo_adr1"
  Dbclk()

End

Public Sub Cp1_Click()

  sel = ""
  ref()
  cp1.Text = ""
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  V1.Text = "Ville"
  Tri = "fo_cd_ptl"
  Deb2()

End

Public Sub Cp1_Dblclick()

  sel = ""
  ref()
  cp1.Text = ""
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  V1.Text = "Ville"
  Tri = "fo_cd_ptl"
  Dbclk()

End

Public Sub V1_Click()

  sel = ""
  ref()
  cp1.Text = "CP"
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  V1.Text = ""
  Tri = "fo_ville"
  Deb2()

End

Public Sub V1_Dblclick()

  sel = ""
  ref()
  cp1.Text = "CP"
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  V1.Text = ""
  Tri = "fo_ville"
  Dbclk()

End

Public Sub Ref()

  Tab = "Fiches_Four"
  Tri = "fo_code"
  CleanChamps()
  Tris()
  'Deb2()

End

Public Sub C1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif

End

Public Sub N1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif

End

Public Sub A1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif

End

Public Sub Cp1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif

End

Public Sub V1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif

End

'****************************** Gestion des étiquettes ***************************************
Public Sub Button14_Click()

  If Not IsNull(Cd.Text) Then Panel2.Visible = True
  init_ComboBox()

End

Public Sub init_ComboBox()

  Dim retiq As Result
  Dim Tab As String = "Fiches_Etiquettes"

  Codetiq.clear
  Try rEtiq = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If Not Error Then
    If rEtiq.Available Then
      Do
        Codetiq.Add(rEtiq!code & "- " & rEtiq!libelle)
      Loop Until rEtiq.MoveNext()
    Endif
    Codetiq.Text = ""
  Endif

End

Public Sub Button15_Click()

  Dim Etiqr As Result
  Dim Tab As String
  Dim i As Integer = 1
  Dim nom1 As String

  Nbetq = 1
  sFetiq = Left$(Format.text, 1)
  Txtposx = 0
  txtposy = 0
  Etiqr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabSoc") & " where cd_sc = &1", Start.Societe)
  sSociete = Etiqr!type_sc & " " & Etiqr!int_sc
  sadr1 = Etiqr!adr1_sc
  sadr2 = Etiqr!adr2_sc
  sCP = Etiqr!cp_sc & "  " & Etiqr!burdis_sc
  Tab = "Fiches_Etiquettes"
  If Codetiq.Text <> "" Then
    Try Etiqr = Utils.db.Exec("SELECT * FROM " & tab & " WHERE code = &1", Left$(Codetiq.Text, 1))
    If Not Error Then
      If Etiqr.Available Then
        Nblargeur = Etiqr!nblargeur
        Nbhauteur = Etiqr!nbhauteur
        Largeur = Etiqr!largeur / 10
        Hauteur = Etiqr!hauteur / 10
        Mrghaut = Etiqr!mrghaut / 10
        Mrgauche = Etiqr!mrgauche / 10
        Esplargeur = Etiqr!esplargeur / 10
        Esphauteur = Etiqr!esphauteur / 10
        txtPosX = 2 + Mrgauche
        txtPosY = 3 + Mrghaut
        Shell "cd " & User.Home & ""
        Filename = User.Home & "/tmp/EtiqFour.pdf"
        Try Kill Filename
        pdf = New CEtiquettes("Portrait", "mm", "A4")
        pdf.Open()
        pdf.NewPage()
        'Nbetq = Val(Nombretiq.Text)
        Me.Mouse = Mouse.Wait
        If Val(Posetiq.Text) > 1 Then
          nom1 = ""
          For i = 1 To Val(Posetiq.text) - 1
            Inc Nbetq
            If Nbetq = 2 Then i2 = 1
            nb = True
            If sFetiq = "1" Then
              pos_Etiq()
            Else
              pos_EtiqC()
            Endif
          Next
        Endif
        If sFetiq = "1" Then
          Imprime()
        Else
          ImprimeC()
        Endif
        fin_impression()
        Me.Mouse = Mouse.Pointing
      Endif
    Else
      If son Then
        Music.Play
      Endif
      message(" Ce format d'étiquettes n'existe pas !!!", "OK")
    Endif
  Endif

End

Public Sub Imprime()

  Dim i As Integer

  For i = 1 To Val(Nombretiq.Text)
    If nb = False Then
      pos_Etiq()
    Else
      nb = False
    Endif
    pdf.Nom(Cv.text & " " & Nm.Text & " " & Pnm.Text, txtPosX, txtPosY)
    If IsNull(Cb.Text) Then
      pdf.Nom(Adresse1.Text, txtPosX, txtPosY + 5)
      pdf.Nom(Adresse2.Text, txtPosX, txtPosY + 10)
      pdf.Cp(Cp.Text & " " & Burdist.Text, txtPosX, txtPosY + 15)
    Endif
    If Not IsNull(Cb.text) And If Len(Cb.text) = 13 Then pdf.Barcode(Cb.text, txtPosX, txtPosY + 5)
    Inc nbetq
  Next

End

Public Sub ImprimeC()

  Dim i As Integer

  For i = 1 To Val(Nombretiq.Text)
    If nb = False Then
      pos_EtiqC()
      nb = False
    Endif
    pdf.Adrexp("Expediteur", txtposx, txtPosY)
    txtPosY = txtPosY + 14
    pdf.NomC(sSociete, txtPosX, txtPosY)
    pdf.NomC(sAdr1, txtPosX, txtPosY + 8)
    pdf.NomC(sAdr2, txtPosX, txtPosY + 16)
    pdf.CpC(sCP, txtPosX, txtPosY + 24)
    txtPosY = txtPosY + 65
    pdf.Adrexp("Destinataire", txtposx, txtPosY)
    txtPosY = txtPosY + 14
    pdf.NomC(Cv.text & " " & Nm.Text & " " & Pnm.Text, txtPosX, txtPosY)
    pdf.NomC(Adresse1.Text, txtPosX, txtPosY + 8)
    pdf.NomC(Adresse2.Text, txtPosX, txtPosY + 16)
    pdf.CpC(Cp.Text & " " & Burdist.Text, txtPosX, txtPosY + 24)
    Inc nbetq
    nb = False
  Next

End

Public Sub fin_impression()

  pdf.Output(Filename, False)
  Visualiseur.Prog(Filename)
  Panel2.Visible = False

End

Public Sub pos_Etiq()

  If Nbetq = 1 Then
    txtPosX = 2 + Mrgauche
  Else
    If sFetiq = "1" Then
      txtPosX = 2 + Mrgauche + (Largeur * (Nbetq - 1)) + Esplargeur
    Else
      txtPosy = 120
    Endif
  Endif
  If Nbetq > Val(Nblargeur) Then
    Nbetq = 1
    txtPosX = 2 + Mrgauche
    If sFetiq = "1" Then
      txtPosY = txtPosY + Hauteur + Esphauteur
    Else
      txtPosY = txtPosY + 120
    Endif
    Inc i2
    If i2 > Val(Nbhauteur) Then
      pdf.NewPage()
      i2 = 0
      Nbetq = 1
      txtPosX = 2 + Mrgauche
      txtPosY = 2.1 + Mrghaut
    Endif
  Endif

End

Public Sub pos_EtiqC()

  If (Nbetq Mod 2) = 1 Then
    txtPosX = 2 + Mrgauche
    txtPosY = 6
    If Nbetq = 3 Then
      txtPosy += 146
    Endif
    Inc i2
  Else
    If sFetiq = "1" Then
      txtPosX = 2 + Mrgauche + (Largeur * (Nbetq - 1)) + Esplargeur
    Else
      If (Nbetq Mod 2) = 0 Then
        txtPosX = txtPosx + 100
        If Nbetq = 2 Then txtPosY = 6
        If Nbetq > 2 Then txtPosY = 146
      Else
        txtposx = 2 + Mrgauche
        txtPosy += 146
      Endif
    Endif
  Endif
  If i2 > Val(Nbhauteur) Then
    pdf.NewPage()
    i2 = 0
    Nbetq = 1
    txtPosX = 2 + Mrgauche
    txtPosY = 2.1 + Mrghaut
  Endif

End

'******************************GESTION DU CODE POSTAL*********************************
Public Sub Cpman()

  Dim Rcompte As Result

  Rcompte = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp = &1", Cp.Text)
  If Rcompte.count = 1 Then
    Burdist.text = Rcompte!burdist
    Burdist.SetFocus
    Burdist.Select
  Else
    If Rcompte.count > 1 Then
      aff_cp()
    Else
      Burdist.Clear
      Burdist.SetFocus
      Burdist.Select
    Endif
  Endif

End

Public Sub aff_cp()

  Dim CpResult As Result

  Colcp.visible = True
  Button5.Visible = True
  Colcp.Columns.count = 2
  Colcp.Columns[0].Width = 60
  Colcp.Columns[1].Width = 280
  Colcp.Columns[0].Text = "CP"
  Colcp.Columns[1].Text = "Bureau distributeur"
  If cp.text Then
    CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
  Else
    CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " order by cp, burdist")
  Endif
  If CpResult.Available Then
    Repeat
      Colcp.Add(CpResult!cp & CpResult!burdist, CpResult!cp & CpResult!burdist)
      Colcp.Item[0] = CpResult!cp
      Colcp.Item[1] = CpResult!burdist
    Until CpResult.MoveNext()
    Colcp.MoveFirst()
    Colcp.item.Selected = True
    Colcp.setfocus
  Endif

End

Public Sub Colcp_Click()

  Cp.Text = Colcp.Item[0]
  Burdist.Text = Colcp.Item[1]
  Colcp.clear
  Colcp.visible = False
  Burdist.SetFocus
  Burdist.Select

End
'****************************************************************
'* Gestion du columnview Colcp lors d'une saisie manuelle       *
'****************************************************************

Public Sub Colcp_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcp.MoveCurrent
    Colcp_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcp.visible = False
    Colcp.clear
    Cp.Select
    Cp.SetFocus
    Stop Event
  Endif

End

Public Sub ChkCp()

  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif

End

'****************************** GESTION DU CODE POSTAL BL *********************************
Public Sub ChkFranco()

  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif

End

Public Sub ToggleButton3_Click()

  Dim MyForm2 As Tricp

  MyForm2 = New Tricp("Fournisseur", "")
  MyForm2.Showmodal()
  If Bsel = True Then
    Cp.text = Codepostal
    Burdist.Text = Bureaudistributeur
  Else
    Cp.SetFocus
  Endif

End

'********************************FIN DE GESTION DU CODE POSTAL**************************

Public Sub Button8_Click()

  Exec ["xdg-open", site.Text]

End

Public Sub Button11_Click()

  Dim adr1 As String
  Dim adr2 As String
  Dim burd As String
  Dim pys As String

  If Not IsNull(Cd.text) Then
    adr1 = Replace$(Adresse1.text, " ", "+")
    adr2 = Replace$(Adresse2.text, " ", "+")
    burd = Replace$(burdist.text, " ", "+")
    pys = Replace$(pays.text, " ", "+")
    Exec ["xdg-open", "http://maps.google.fr/maps/place/" & adr1 & "+" & Adr2 & "+" & cp.text & "+" & burd & "+" & pys]
  Endif

End

Public Sub button12_Click()

  Dim hfil As File

  If Not IsNull(Cd.text) Then
    HFil = Open User.Home & "/Contacts.vcf" For Write Create
    Print #hfil, "BEGIN:VCARD" & "\n" & "VERSION:3.0" & "\n" "FN:" & Pnm.Text & " " & Nm.Text & "\n" & "N:" & Pnm.Text & "," & Nm.text & "\n" & "EMAIL;TYPE=HOME:" & Email.Text & "\n" & "TEL:" & TelStd.Text & " Standard" & "\n" & "TEL;TYPE=CELL:" & Portable.Text & "\n" & "TEL;TYPE=WORK:" & Telbur.Text & "\n" & "TEL:" & Poste.Text & " Poste" & "\n" & "ADR;TYPE=HOME:;" & Adresse1.text & "\\n" & Adresse2.text & "\\n" & Cp.Text & " " & Burdist.Text & ";;;;" & "\n" & "TITLE:" & CV.Text & "\n" & "NOTE:" & Divers.text & "\n" & "item1.URL:" & site.Text & "\n" & "item1.X-ABLabel:_$!<HomePage>!$_" & "\n" & "END:VCARD"
    '  PRINT #HFil, "Civilité" & "," & "Nom" & "," & "Prénom" & "," & "Adresse 1" & "," & "Adresse 2" & "," & "Code postal & ville" & "," & "Pays" & "," & "Téléphone bureau" & "," & "Portable" & "," & "Fax" & "," & "Adresse e-mail" & "," & "Code Laurux"
    '  PRINT #HFil, Cv.Text & "," & Nm.Text & "," & Pnm.Text & "," & adresse1.text & "," & Adresse2.text & "," & Cp.text & " " & Burdist.Text & "," & Pays.Text & "," & Telbur.Text & "," & Portable.Text & "," & Fax1.Text & "," & Email.Text & "," & Cd.Text
    message.Info("Fichier contact généré !")
  Endif

End

Public Sub Button17_Click()

  Dim adr As String = "http://www.infogreffe.fr/infogreffe/newRechercheEntreprise.xml?denomination= " & Nm.Text & " &commune= " & burdist.Text & " &departement= " & Left$(cp.text, 2)

  If Not IsNull(Cd.text) Then
    Exec ["xdg-open", "http://www.infogreffe.fr/infogreffe "]
    Wait 1
    Exec ["xdg-open", adr] Wait
  Endif

End

'********************************************** Gestion des contacts***************************************
Public Sub Button16_Click()

  Dim CrtResult As Result

  If Not IsNull(nm3.Text) Then
    CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContactF") & " where code = &1 and num = &2", Cd.Text, Numero2.text)
    If CrtResult.Available Then
      Utils.db.Exec("Update " & Cbase.Table("TabContactF") & " set code = &2, nom = &3, pnm = &4, fonction = &5 , tel = &6, mail = &7, portable = &8 where code = &2 and num = &1", Numero2.Text, Cd.Text, Nm3.text, Pnm3.text, Fonction.Text, Tel2.Text, Mail2.Text, Portable2.Text)
      If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("ContactF", "M", Cd.Text, Numero2.text)
    Else
      CrtResult = Utils.db.Exec("SELECT num FROM " & Cbase.Table("TabContactF") & " order by num desc")
      Try Numero2.Text = CrtResult!num + 1
      If Error Then Numero2.Text = "1"
      Utils.db.Exec("Insert INTO " & Cbase.Table("TabContactF") & " (code, nom, pnm, fonction, tel, mail, portable, num) VALUE (&1, &2, &3, &4, &5, &6, &7, &8)", Cd.text, Nm3.text, Pnm3.text, fonction.Text, Tel2.Text, Mail2.text, Portable2.Text, numero2.Text)
      If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("ContactF", "C", Cd.Text, Numero2.text)
    Endif
  Endif
  CleanChampsCt()
  Aff_Ct()

End

Public Sub Aff_Ct()

  Dim CrtResult As Result

  CleanChampsCt()
  Colal2.Clear
  CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContactF") & " where code = &1 order by num ", Cd.text)
  If CrtResult.Available Then
    Repeat
      Try Colal2.Add(CrtResult!num & CrtResult!code, CrtResult!num)
      Colal2.Item[0] = CrtResult!num
      Colal2.Item[1] = CrtResult!nom
      Colal2.Item[2] = CrtResult!pnm
      Colal2.Item[3] = CrtResult!fonction
    Until CrtResult.MoveNext()
    Colal2.MoveFirst
    Colal2.SetFocus
    Colal2.Item.Selected = True
  Endif

End

Public Sub Colal2_Click()

  Dim rcli As Result

  CleanChampsCt()
  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabContactF") & " where code = &1 and num = &2", Cd.Text, Colal2.current[0])
  If rCli.Available Then
    Numero2.Text = rcli!num
    Nm3.Text = rcli!nom
    Pnm3.Text = rcli!pnm
    Fonction.Text = rcli!fonction
    Tel2.text = rcli!tel
    Mail2.Text = rcli!mail
    Portable2.Text = rcli!portable
  Endif

End

Public Sub Colal2_KeyPress()

  If Key.code = Key.Delete And Colal2.Count <> 0 Then
    If Message.Question("Etes-vous sur de vouloir supprimer ce contact ?", "Oui", "Non") = 1 Then
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabContactF") & " where code = &1 and num = &2", Cd.Text, Colal2.Current[0])
      If Variables.Sprix And Variables.Sexport And Variables.SMajFour Then Serveur.Pass("ContactF", "S", Cd.Text, Colal2.Current[0])
    Endif
    Colal2.Clear
    CleanChampsCt()
    Aff_Ct()
  Endif

End

Public Sub CleanChampsCt()

  Numero2.Clear
  Nm3.Clear
  Pnm3.Clear
  Fonction.Clear
  Tel2.Clear
  Mail2.Clear
  Portable2.Clear

End

'********************************** Gestion des documents liès ***************************************************

Public Sub Button18_MouseDown()

  Dim hFormc As GedC

  If Not IsNull(Cd.Text) Then
    hFormc = New Gedc("Fournisseur", "F", Cd.Text, "")
    hFormc.Showmodal()
    Maj_Dssr()
  Else
    Message.Info("Veuillez saisir un client SVP !")
  Endif

End

Public Sub Dssr_Data(Row As Integer, Column As Integer)

  Try Dssr.Data.Text = tableau[Row, Column]

End

Public Sub Dssr_Activate()

  Dim Attente As Boolean = False

  Try Desktop.Open(Dssr[Dssr.row, 1].Text, Attente)
  If Error Then Message.Info("Ce fichier n'existe pas ! Peut-être devriez-vous le supprimer de cette liste. ")

End

Public Sub Dssr_KeyPress()

  If Key.code = Key.del Or Key.code = Key.delete Then
    If Message.Question("Vous allez supprimer le lien sélectionné.", "Oui", "Non") = 1 Then
      Try Utils.db.Exec("DELETE FROM " & Cbase.Table("TabFdocs") & " WHERE code = &1 and doc = &2", Dssr[Dssr.row, 0].Text, Dssr[Dssr.row, 1].Text)
      If Error Then
        Message.Error("Impossible de supprimer ce document ...")
      Else
        If Message.Question("Le lien a été supprimé !\nVoulez-vous supprimer le fichier ?", "Oui", "Non") = 1 Then Try Kill Dssr[Dssr.row, 1].Text
        Serveur.Docs("Four", "S", Dssr[Dssr.row, 0].Text, Dssr[Dssr.row, 1].Text, "")
      Endif
      Maj_Dssr()
    Endif
  Endif
  If Key.code = Key.F2 Then
    If Dssr.Width = TabFour.w - 5 Then
      Dssr.Width = Tous.x - 7
    Else
      Dssr.Width = TabFour.w - 5
      Dssr.Columns[2].Width = TabFour.w - (Dssr.Columns[0].Width + Dssr.Columns[3].Width)
    Endif
  Endif
  If Key.code = Key.F3 Then
    Message.Info(Dssr[Dssr.row, 1].Text)
  Endif

End

Public Sub Dssr_MouseDown()

  If Me.mouse = Mouse.right Then
    Tbxrem2.Clear
    If Mouse.Right Then
      If Not Tbxrem2.Visible Then
        Try Dssr.Current.EnsureVisible
        If Not Error Then
          ShowTextBox()
          Tbxrem2.SetFocus
        Endif
      Else
        Tbxrem2.Visible = False
      Endif
    Else
      If Tbxrem2.Visible Then Tbxrem2.Visible = False
    Endif
  Endif

End

' Affichage du Textbox Tbxrem
Public Function ShowTextBox()

  With Dssr.Current
    Tbxrem2.Text = .Text
    Tbxrem2.Width = Dssr.Columns[3].Width
    Tbxrem2.Move(Dssr.X + Dssr[Dssr.row, 3].x, Dssr.Y + Dssr.Rows.Height + Dssr.current.Y, Dssr.Columns[3].Width, .H)
    Tbxrem2.Text = Dssr[Dssr.row, 3].Text
    Tbxrem2.Visible = True
  End With

End

'Masquage du Textbox Tbxrem
Public Function HideTextBox()

  With Utils
    Try Dssr[Dssr.row, 3].Text = Tbxrem2.Text
    Utils.db.Exec("Update " & Cbase.Table("TabFdocs") & " set doc2 = &3 where code = &1 AND doc = &2 ", Dssr[Dssr.row, 0].Text, Dssr[Dssr.row, 1].Text, Dssr[Dssr.row, 3].Text)
    Tbxrem2.Visible = False

  End With

End

Public Sub Tbxrem2_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    HideTextBox()
  Endif

End

Public Sub Tbxrem2_MouseDown()

  If Tbxrem2.Visible Then Tbxrem2.Visible = False

End

Public Sub Maj_Dssr()

  Dim rDoc As Result
  Dim Tag As String[]
  Dim n As Integer = 0

  Dssr.Rows.Count = 0
  Dssr.Refresh()
  Dssr.Columns.Count = 4
  Dssr.Columns[0].Width = 100
  Dssr.Columns[1].Width = 0
  Dssr.Columns[2].Width = 330
  Dssr.Columns[3].Width = 330
  Dssr.Columns[0].Text = "Code"
  Dssr.Columns[2].Text = "Nom du fichier"
  Dssr.Columns[3].Text = "Etiquettes"
  If Tous.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1 order by doc", Cd.Text)
  If Facs.value Or Facs2.value Or Facs3.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1  order by doc", Cd.Text, "Facs")
  If Docs.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1 and org = &2 order by doc", Cd.Text, "Docs")
  If rDoc.Available Then
    n = 0
    tableau = New String[rDoc.Count, 4]
    Repeat
      Dssr.Rows.count = n + 1
      Tag = Split(rDoc!doc, "/")
      If Tous.Value Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs.value And Left$(Tag[Tag.count - 1]) = "F" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs2.value And Left$(Tag[Tag.count - 1]) = "B" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs3.Value And Left$(Tag[Tag.count - 1]) = "C" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Docs.Value Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
    Until rDoc.MoveNext()
  Endif
Catch

End

Public Sub Maj_Dssr2()

  Dim rDoc As Result
  Dim Tag As String[]
  Dim n As Integer = 0

  Dssr.Rows.Count = 0
  Dssr.Columns.Count = 4
  Dssr.Columns[0].Width = 100
  Dssr.Columns[1].Width = 0
  Dssr.Columns[2].Width = 330
  Dssr.Columns[3].Width = 330
  Dssr.Columns[0].Text = "Code"
  Dssr.Columns[2].Text = "Nom du fichier"
  Dssr.Columns[3].Text = "Etiquettes"
  If Tous.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1 order by doc", Cd.Text)
  If Facs2.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1 and org = &2 order by doc", Cd.Text, "Facs")
  If Docs.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFdocs") & " where code = &1 and org = &2 order by doc", Cd.Text, "Docs")
  If rDoc.Available Then
    tableau = New String[rDoc.Count, 4]
    Dssr.Rows.count = rDoc.Count
    Repeat
      Tableau[n, 0] = rDoc!code
      Tableau[n, 1] = rDoc!doc
      Tag = Split(rDoc!doc, "/")
      Tableau[n, 2] = Tag[Tag.count - 1]
      Tableau[n, 3] = rDoc!doc2
      Inc n
    Until rDoc.MoveNext()
  Endif
  Dssr.setfocus
Catch

End

Private Function FileFilter(Optional All As Boolean = False) As String[]

  Dim filter As New String[]

  filter.Add("*.*")
  Return filter

End

Public Sub Button7_Click()

  Doc.Open("Tablesclients&fournisseurs")

End

Public Sub BtnAccesWebTVA_Click()

  'Dim ec2 As String = "http://ec.europa.eu/vies/?locale=fr"
  Dim ec2 As String = "http://www.tva-intracommunautaire.com/Resultat.php?P1=" & Idtva.text

  If Not IsNull(Idtva.text) Then
    Exec ["xdg-open", ec2] Wait
  Endif

End

Public Sub HBox1_MouseDown()

End

Public Sub Button9_Click()

  Dim hForm As Gged

  If Not IsNull(Cd.Text) Then
    hForm = New Gged("Fournisseur", "F", Cd.Text, "")
    hForm.Showmodal()
  Else
    Message.Info("Veuillez saisir un produit avant de scaner SVP !")
  Endif
  Maj_Dssr()

End

Public Sub Docs_Click()

  Maj_Dssr()

End

Public Sub Tous_Click()

  Maj_Dssr()

End

Public Sub Facs_Click()

  Maj_Dssr()

End

Public Sub Facs2_Click()

  Maj_Dssr()

End

Public Sub Facs3_Click()

  Maj_Dssr()

End

Public Sub Etiquette_KeyPress()

  If Key.code = Key.Esc Or If Key.code = Key.Escape Then Panel1.Visible = False

End

Public Sub Button10_Click()

  Dim rDoc As Result
  Dim $NmFic As String = Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminF"] & "/Docs" & "/" & cd.Text & "/"
  Dim Fic As String
  Dim NmFic As String[]
  Dim ific As Integer

  Dialog.Filter = FileFilter(True)
  Dialog.Path = User.home
  Dialog.Title = "Choix d'un fichier"
  If Dialog.OpenFile() Then Return
  Fic = Dialog.Path
  NmFic = Split(Fic, "/")
  For ific = 0 To NmFic.Count - 1
    Fichier = NmFic[ific]
  Next
  If Not Exist($NmFic) Then Mkdir $NmFic
  Shell "cp " & Fic & " " & $NmFic Wait
  Fichier = $NmFic & Fichier
  rDoc = Utils.db.Exec("SELECT * from " & Cbase.Table("TabFdocs") & " where code = &1 AND doc = &2 ", Cd.Text, Fichier)
  If rDoc.Available Then
    Utils.db.Exec("Update " & Cbase.Table("TabFdocs") & " set doc = &2, doc2 = &3, org = &4 where code = &1 AND doc = &2 ", Cd.Text, Fichier, cd.text & "," & Etiquette.text, "Docs")
  Else
    Try Utils.db.Exec("insert into " & Cbase.Table("TabFdocs") & " (code,doc, doc2, org) values ( &1, &2, &3, &4)", Cd.Text, Fichier, cd.text & "," & Etiquette.text, "Docs")
  Endif
  Maj_Dssr()
  Panel1.visible = False
Catch
  Message.Warning(ERROR.Text)

End
