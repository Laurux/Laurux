' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Fclient.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/11/2004
'# Gestion de la table des clients
'################################################
'

n As Integer
Tri As String
tab As String
sel As String
Clitable[8] As String
Enr As Integer ' Flag utilisé pour le focus si la donnée a recuperer existe ou non
son As Integer = Start.Son
sKey As String
Dbl As String
Type As String
CoulZnaf As Integer ' Variable pour la couleur du background des columnviews
CoulFc As Integer ' Variable pour la couleur du focus
sStatut As String
i2 As Integer
txtPosX As Integer
txtPosY As Integer
Filename As String = "EtiqCarte.ps"
Nblargeur As String
Nbhauteur As String
Largeur As Integer
Hauteur As Integer
Mrghaut As Integer
Mrgauche As Integer
Esplargeur As Integer
Esphauteur As Integer
Nbetq As Integer = 1
bl As Integer = 0 'pour gerer les adresses de livraison.
Nb As Boolean = False
sSociete As String
sAdr1 As String
sAdr2 As String
sCP As String
sFetiq As String
Private Org As Boolean = False 'pour savoir si on fait une recherche sur le code postal
Private Fichier As String
Private hColCli As Boolean = False
Private pdf As Cetiquettes
Private ComboCom As Boolean = False
Private Tableau As String[]
Public Bsel As Boolean = False
Public Codepostal As String
Public Bureaudistributeur As String

Private $soption As String
Private $grdv As Gridvi

Public Sub _New()

  Dim Frmt As New String[]
  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Identite"
  Music.Load(Start.Musique)
  Me.center
  Balloon.delay = 1000
  If Start.LocalSettings["/Soc" & Start.Societe & "/Materiel"] = 0 Then Tabstrip1[4].Visible = False
  If Start.LocalSettings["/Soc" & Start.Societe & "/Faca"] = 0 Then Tabstrip1[8].Visible = False
  If Start.LocalSettings["/Soc" & Start.Societe & "/Sms"] = 0 Then Button19.visible = False
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znaff"])
  CoulZnaf = Val(Frmt[0])
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Focus"])
  Coulfc = Val(Frmt[0])
  Utils.Observers(Me)
  n = 1
  C1.Text = "Code"
  C2.Text = "CV"
  N1.Text = "Nom"
  P1.Text = "Prénom"
  A1.Text = "Adresse 1"
  A2.Text = "Adresse 2"
  cp1.Text = "CP"
  V1.Text = "Ville"
  codebanque.SetFocus
  nom_pays()
  Try rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If Not Error Then
    If rResult.Available Then
      Do
        Try CV.Add(rResult!libelle)
        Try CV2.Add(rResult!libelle)
      Loop Until rResult.MoveNext()
    Endif
  Endif
  Try rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStatut") & " ")
  If Not Error Then
    If rResult.Available Then
      Do
        Try Statut.Add(rResult!code & " - " & rResult!libelle)
        Try Statut2.Add(rResult!code & " - " & rResult!libelle)
      Loop Until rResult.MoveNext()
      Statut.Add(" ", "00")
      Statut2.Add(" ", "00")
    Endif
  Endif
  Try rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCommerciaux") & " order by code")
  If Not Error Then
    If rResult.Available Then
      Do
        Try Comm.Add(rResult!code & " - " & rResult!nom)
      Loop Until rResult.MoveNext()
      Comm.Add(" ", "00")
    Endif
  Endif
  Colmat.Columns.count = 3
  Colmat.Columns[0].Width = 150
  Colmat.Columns[1].Width = 150
  Colmat.Columns[2].Width = 300
  Colmat.Columns[0].Text = "Code"
  Colmat.Columns[1].Text = "N° série"
  Colmat.Columns[2].Text = "Intitulé"

  Colal.Columns.count = 7
  Colal.Columns[0].Width = 0
  Colal.Columns[1].Width = 80
  Colal.Columns[2].Width = 150
  Colal.Columns[3].Width = 150
  Colal.Columns[4].Width = 200
  Colal.Columns[5].Width = 60
  Colal.Columns[6].Width = 150
  'Colal.Columns[0].Text = "N°"
  Colal.Columns[1].Text = "Rs"
  Colal.Columns[2].Text = "Nom"
  Colal.Columns[3].Text = "Prénom"
  Colal.Columns[4].Text = "Adresse 1"
  Colal.Columns[5].Text = "CP"
  Colal.Columns[6].Text = "Ville"

  Colal2.Columns.count = 4
  Colal2.Columns[0].Width = 0
  Colal2.Columns[1].Width = 200
  Colal2.Columns[2].Width = 200
  Colal2.Columns[3].Width = 150
  Colal2.Columns[1].Text = "Nom"
  Colal2.Columns[2].Text = "Prénom"
  Colal2.Columns[3].Text = "Fonction"
  Try Pays.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Pays"]
  If Start.LocalSettings["/Soc" & Start.Societe & "/Sage"] Then
    TextLabel10.Visible = True
    Sage.Visible = True
  Endif

  $grdv = New Gridvi(Tabstrip1, "C")
  $grdv.razcol
  $grdv.dec = "0.000"
  $soption = utils.Option()
  If $soption = "T" Or $soption = "B" Then Checkcons.Visible = True
  If $soption = "T" Or $soption = "P" Then
    Paneltr1.Visible = True
    Paneltr2.Visible = True
  Endif
  
End

Public Sub Form_Open()

  Tri = "cli_code"
  Tris()
  sel = ""
  Deb2()
  nm.setfocus

End

Public Sub Tabstrip1_Click()

  Dim abo As Result

  Utils.Observers(Me)
  Cd.setfocus
  If Tabstrip1.Index = 1 Then
    Codebanque.setfocus
    Codebanque.select
  Endif
  If Tabstrip1.Index = 2 Then
    Compt.setfocus
    Compt.Select
  Endif
  If Tabstrip1.Index = 3 Then
    Divers.setfocus
  Endif
  If Tabstrip1.Index = 5 Then
    Cv2.setfocus
    Cv2.Select
  Endif
  If Tabstrip1.Index = 6 Then
    Fonction.setfocus
    Fonction.Select
  Endif
  If Tabstrip1.Index = 8 Then
    Abo = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabBl") & " where cdclibl = &1 and type = &2 and not isnull(numfac)", cd.Text, "A")
    If Abo.Available Then TextLabel9.Text = "Dernière facture n° " & Abo!numfac & " du " & Format$(Abo!dtefac, "dd.mm.yyyy")
  Endif

End

Public Sub nom_pays()

  Dim hfil As File
  Dim Lig As String

  HFil = Open "Pays.txt" For Read
  Pays.Clear
  While Not Eof(hFil)
    Line Input #hFil, Lig
    Pays.Add(Lig)
  Wend

End

Public Sub Colcli_Data(Row As Integer, Column As Integer)

  With Utils
    Clitable[0] = "cli_code"
    Clitable[1] = "cli_rs_soc"
    Clitable[2] = "cli_nom"
    Clitable[3] = "cli_pnm"
    Clitable[4] = "cli_adr1"
    Clitable[5] = "cli_adr2"
    Clitable[6] = "cli_cd_ptl"
    Clitable[7] = "cli_ville"

    Try .rs1.MoveTo(Row)
    If (row Mod 2) = 0 Then
      If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then
        Colcli.Data.Background = CoulZnaf
      Else
        Colcli.Data.Background = Color.TextBackground
      Endif
    Else
      If Start.LocalSettings["/Soc" & Start.Societe & "/Coul_fen"] Then
        Colcli.Data.Background = &HFAFAFA&
      Else
        Colcli.Data.Background = &HEBD0C2&
      Endif
    Endif
    Try Colcli.data.Text = Str(.rs1[Clitable[Column]])
    If Not Error Then
      If Column = 8 Then Colcli.Data.Alignment = 1
    Endif
  End With

End

Public Sub Tris()

  With colcli
    .Columns.count = 8
    .Columns[0].Width = C1.Width
    .Columns[1].Width = C2.Width
    .Columns[2].Width = N1.Width
    .Columns[3].Width = P1.Width
    .Columns[4].Width = A1.Width
    .Columns[5].Width = A2.Width
    .Columns[6].Width = Cp1.Width
    .Columns[7].Width = V1.Width
  End With

End

Public Sub Deb2()

  If Tri <> "nom" Then
    If Not hColcli Then
      If Org = False Then
        If Statut2.text = "" Then Statut2.Text = " "
        If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "   order by " & Tri & "")
        If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & "")
      Else
        If Statut2.text = "" Then Statut2.Text = " "
        If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"" & sel & "%\"  and " & "cli_actif" & " = " & Inactif2.value & "  order by " & Tri & "")
        If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & "")
      Endif
    Endif
    If hColcli Then
      If Org = False Then
        If Statut2.text = "" Then Statut2.Text = " "
        If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "   order by " & Tri & "")
        If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & "")
      Else
        If Statut2.text = "" Then Statut2.Text = " "
        If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"" & sel & "%\"  and " & "cli_actif" & " = " & Inactif2.value & "  order by " & Tri & "")
        If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & "")
      Endif
    Endif
    Colcli.Refresh
  Else
    Colcli_contact()
  Endif

End

Public Sub Colcli_contact()

  Dim rLib As Result
  Dim rLib2 As Result
  Dim BlTab As String = "Contact"

  Utils.db.Exec("drop Table IF exists " & "BlTab" & "")
  Utils.db.Exec("CREATE TEMPORARY TABLE " & BlTab &
    "(num INT(11) auto_increment  NOT NULL," &
    "cli_code INT(11) ," &
    "cli_rs_soc Char(10) ," &
    "cli_nom VARCHAR(35) ," &
    "cli_pnm VARCHAR(35) ," &
    "cli_adr1 VARCHAR(35) ," &
    "cli_adr2 VARCHAR(35) ," &
    "cli_cd_ptl CHAR(5) ," &
    "cli_ville VARCHAR(35) ," &
    "PRIMARY KEY (num))" & "ENGINE = MYISAM")
  rLib = Utils.db.Exec("select * from " & Cbase.Table("TabContact") & " where nom like \"%" & sel & "%\"")
  If rLib.Available Then
    Repeat
      rLib2 = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", rLib!code)
      Utils.db.Exec("insert into " & BlTab & " (cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville) values (&1,&2,&3,&4,&5,&6,&7,&8)", rLib2!cli_code, rLib2!cli_rs_soc, rLib2!cli_nom, rLib2!cli_pnm, rLib2!cli_adr1, rLib2!cli_adr2, rLib2!cli_cd_ptl, rLib2!cli_ville)
    Until rLib.MoveNext()
  Endif
  Utils.Base(Colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville  from " & BlTab & " order by cli_code desc ")
  Colcli.Refresh
  Utils.db.Exec("drop TABLE " & BlTab & "")

End

Public Sub Deb3()

  If Tri <> "nom" Then
    If Statut2.text = "" Then Statut2.Text = " "
    If Not hColcli Then
      If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\"  and " & "cli_actif" & " = " & Inactif2.value & "  order by " & Tri & " desc")
      If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & " desc")
    Endif
    If hColcli Then
      If Statut2.text = " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\"  and " & "cli_actif" & " = " & Inactif2.value & "  order by " & Tri & " desc")
      If Statut2.text <> " " Then Utils.Base(colcli, "select cli_code, cli_rs_soc, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville from " & Cbase.Table("TabCli") & " where " & Tri & " like  \"%" & sel & "%\" and " & "cli_actif" & " = " & Inactif2.value & "  and " & "cli_statut" & " like \"%" & Left$(Statut2.Text, 1) & "%\" order by " & Tri & " desc")
    Endif
  Endif
  Colcli.Refresh

End

Public Sub Maj_Zones()

  Dim rcli As Result
  Dim $Mail As String

  Randomize
  button2.text = "&Creer"
  button4.text = "Enre&gistrer"
  If colcli.rows.Count Then
    Cd.Text = colcli[colcli.row, 0].Text
    rCli = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " Left join Fiches_Comptes on compte_cc = cli_code where cli_code = &1", Cd.Text)
    Try Lettrable.value = rCli!lettrable
    CV.Text = rcli!cli_rs_soc
    Nm.Text = rcli!cli_nom
    Pnm.Text = rcli!cli_pnm
    Adresse1.Text = rcli!cli_adr1
    Adresse2.Text = rcli!cli_adr2
    cp.Text = rcli!cli_cd_ptl
    Burdist.text = rcli!cli_ville
    Textto1.Text = rcli!cli_tour
    If $soption = "P" Or $soption = "T" Then
      Texttr1.Text = rcli!cli_tipp
    Endif
    If $soption = "B" Or $soption = "T" Then
      Try Checkcons.Value = rcli!cli_cons
    Endif
    $Mail = rcli!cli_email
    Telbur.text = rcli!cli_tel_bur
    Teldom.text = rcli!cli_tel_dom
    poste.text = rcli!cli_tel_poste
    portable.text = rcli!cli_pble
    Fax1.text = rcli!cli_fx1
    Fax2.text = rcli!cli_fx2
    Encours.Text = rcli!cli_plaf_ecrs
    codebanque.Text = rcli!cli_cd_bq
    codeguichet.Text = rcli!cli_cd_gch
    Dom.Text = rcli!cli_dmln
    Cle.Text = rcli!cli_cle_rib
    numcompte.Text = rcli!cli_num_cpt
    Cent.Text = rcli!cli_cd_ent
    Cacc.Text = rcli!cli_cd_acc
    Tire.Text = rcli!cli_ref_tir
    Textfrais.Text = Format(rcli!cli_gestion, "0.00")
    Select Case rcli!cli_regr
      Case "S"
        Combreg.Text = "Sans"
      Case "D"
        Combreg.Text = "Décade"
      Case "M"
        Combreg.Text = "Mensuel"
      Case "Q"
        Combreg.Text = "Quinzaine"
    End Select
    Idtva.Text = rcli!cli_id_tva
    Try relcompte.Value = rcli!cli_rlvc
    Try relfacture.Value = rcli!cli_rlvf
    Divers.text = rcli!cli_obs
    collectif.Text = rcli!cli_collectif
    Remmo.Text = rcli!cli_rmo
    Remart.Text = rcli!cli_rart
    Try Exo.Value = rcli!cli_exo
    Cdech.Text = rcli!cli_cdech
    If Not Cdech.Text Then Cdech.Text = "00"
    Typec.Text = rcli!cli_typec
    Mreg.Text = rcli!cli_reg
    Recup_Typec(Typec.Text)
    Try Copie.Value = rcli!cli_copie
    Try Nbexpl.Text = rcli!cli_expl
    If IsNull(Nbexpl.text) Then Nbexpl.text = "2"
    If Error Then Nbexpl.Text = 2
    Pays.Text = rcli!cli_pays
    If IsNull(Pays.Text) Then Try Pays.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Pays"]
    sStatut = rcli!cli_statut
    Aff_Statut(sStatut)
    Try Inactif.Value = rcli!cli_actif
    Try Div.Value = rcli!cli_div
    Try Iban.Text = rcli!cli_iban
    Try Bic.Text = rcli!cli_bic
    Try Rum.Text = rcli!cli_rum
    Try ComboBox1.Text = rcli!cli_datab
    Try ComboBox2.Text = rcli!cli_aban
    Try TextBox2.Text = hexdblKey.crypt("en", Right$(cd.text, Len(cd.text) - 3), cd.Text)
    Try Sage.Text = rcli!cli_sage
    Try Livraison.Value = rcli!cli_livraison
    Try AutoEnt.Value = rcli!cli_autoent
    Try Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCommerciaux") & " where code = &1", rcli!cli_comm)
    If Not Error Then
      If Rcli.Available Then Try Comm.Text = Rcli!code & " - " & Rcli!nom
    Endif
    Rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailCli") & " where code = &1 order by mail", Cd.text)
    If Rcli.Available Then
      Repeat
        Email.Add(Rcli!mail)
      Until Rcli.MoveNext()
    Endif
    Email.Text = $Mail
  Endif

End

Public Sub Aff_Mat()

  Dim MatResult As Result

  Colmat.clear
  MatResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMat") & " where mat_cli =&1 order by mat_code", Cd.Text)
  If MatResult.Available Then
    Repeat
      Colmat.Add(MatResult!mat_serie, MatResult!mat_serie)
      Colmat.Item[0] = MatResult!mat_code
      Colmat.Item[1] = MatResult!mat_serie
      Colmat.Item[2] = MatResult!mat_design
    Until MatResult.MoveNext()
  Endif

End

Public Sub ChiffreA()

  Dim Tab As String
  Dim Tab2 As String
  Dim TotA As Float = 0
  Dim dteN0, dteN1 As String = Format$(Now, "dd.mm.yyyy")
  Dim caResult As Result

  dteN0 = Left$(dteN0, 6) & Str(Val(Right$(dteN0, 4)) - 4)
  Tab = "Fiches_HistoFac"
  Tab2 = "Fiches_HistoFacM"
  With Utils
    caResult = Utils.db.Exec("SELECT * FROM " & Tab & " where datefac >= &1 and datefac <= &2 and cdclifac = &3 union SELECT * FROM " & Tab2 & " where datefac >= &1 and datefac <= &2 and cdclifac = &3 ", Utils.Cdate_Dbase(dteN0), .Cdate_Dbase(dteN1), cd.Text)
    If caResult.Available Then
      Repeat
        Try TotA = TotA + caResult!totfacttc
      Until caResult.MoveNext()
      Balloon("CA sur 12 mois : " & Format$(Val(utils.cpoint(totA)), "0.00"), Cv)
    Endif
  End With

End

Public Sub Button10_Click()

  Dim adr1 As String
  Dim adr2 As String
  Dim burd As String
  Dim pys As String

  If Not IsNull(Cd.text) Then
    adr1 = Replace$(Adresse1.text, " ", "+")
    adr2 = Replace$(Adresse2.text, " ", "+ ")
    If IsNull(adr2) Then Replace$(adr1, "+ ", "")
    If IsNull(adr2) Then adr2 = ""
    burd = Replace$(burdist.text, " ", "+")
    pys = Replace$(pays.text, " ", "+")
    Exec ["xdg-open", "http://maps.google.fr/maps/place/" & adr1 & "+" & Adr2 & "+" & cp.text & "+" & burd & "+" & pys]
  Endif

End

Public Sub button11_Click()

  Dim hfil As File
  Dim iPos As Integer

  iPos = InStr(Statut.text, "-")
  If Not IsNull(Cd.text) Then
    HFil = Open User.Home & "/Contacts.vcf" For Write Create
    Print #hfil, "BEGIN:VCARD" & "\n" & "VERSION:3.0" & "\n" "FN:" & Pnm.Text & " " & Nm.Text & "\n" & "N:" & Pnm.Text & "," & Nm.text & "\n" & "EMAIL;TYPE=HOME:" & Email.Text & "\n" & "TEL;TYPE=HOME:" & Teldom.Text & "\n" & "TEL;TYPE=CELL:" & Portable.Text & "\n" & "TEL;TYPE=WORK:" & Telbur.Text & "\n" & "TEL:" & Poste.Text & " Poste" & "\n" & "ADR;TYPE=HOME:;" & Adresse1.text & "\\n" & Adresse2.text & "\\n" & Cp.Text & " " & Burdist.Text & ";;;;" & "\n" & "TITLE:" & CV.Text & "\n" & "NOTE:" & Divers.text & "\n" & "END:VCARD"
    Music.Play
    message.Info("Fichier contact généré !")
  Endif

End

Public Sub Button17_Click()

  Dim adr As String = "http://www.infogreffe.fr/infogreffe/newRechercheEntreprise.xml?denomination= " & Nm.Text & " &commune= " & burdist.Text & " &departement= " & Left$(cp.text, 2)

  If Not IsNull(Cd.text) Then
    Exec ["xdg-open", "http://www.infogreffe.fr/infogreffe"]
    Wait 1
    Exec ["xdg-open", adr] Wait
  Endif

End

Public Sub Maj_vtl()

  Compt.Text = Vents.current[0]
  intitule.Text = Vents.current[1]

End

Public Sub CleanVtl()

  Compt.Text = ""
  intitule.Text = ""

End

Public Sub Refresh()

  vents.clear
  form_Open()

End

Public Sub CleanChamps()

  Cv.Text = ""
  Cd.Clear
  Nm.Clear
  Pnm.Clear
  Adresse1.Clear
  Adresse2.Clear
  cp.Clear
  Burdist.Clear
  Textto1.Clear
  Texttr1.Clear
  Checkcons.Value = True
  Email.Clear
  Teldom.Clear
  Telbur.Clear
  Poste.Clear
  Portable.Clear
  Fax1.Clear
  Fax2.Clear
  Encours.Clear
  codebanque.Clear
  codeguichet.Clear
  Cle.Clear
  numcompte.Clear
  Dom.Clear
  Cent.Clear
  Cacc.Clear
  Tire.Clear
  Idtva.Clear
  Relcompte.Value = False
  Relfacture.Value = False
  Divers.Clear
  collectif.Text = ""
  Remmo.Text = "0,00"
  Remart.Text = "0,00"
  Exo.Value = False
  Cdech.Text = "00"
  Textfrais.Clear
  Combreg.Text = "Sans"
  Checkcons.Value = True
  Typec.Text = ""
  Nbexpl.Text = "2"
  Pays.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Pays"]
  Statut.Text = ""
  Numero.Clear
  CV2.Text = ""
  Nm2.Clear
  Pnm2.Clear
  Adresse4.Clear
  Adresse3.Clear
  'cp2.Clear
  Burdist2.Clear
  Colal.Clear
  Mreg.text = ""
  Dssr.Clear
  Copie.value = False
  Inactif.Value = False
  Div.value = False
  'Tarif.value = False
  Iban.Clear
  Bic.Clear
  Rum.clear
  ComboBox1.Text = ""
  ComboBox2.Text = ""
  Textbox2.Clear
  Sage.Clear
  Livraison.value = False
  Comm.Text = ""
  Lettrable.value = True
  AutoEnt.value = False

End

Public Sub Email_KeyPress()

  Dim rmail As Result

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Maj_Email()
    fax2.SetFocus
    fax2.Select
    Stop Event
  Endif

  If key.code = key.Delete Then
    If Not IsNull(Email.text) Then
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMailCli") & " WHERE code = &1 and mail = &2", cd.Text, Email.Text)
      Rmail = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailCli") & " where code = &1 order by mail", Cd.text)
      If Rmail.Available Then
        Email.clear
        Repeat
          Email.Add(Rmail!mail)
        Until Rmail.MoveNext()
      Endif
      Utils.db.Exec("update " & Cbase.Table("TabCli") & " set cli_email = &2 where cli_code = &1", Cd.Text, Email.Text)
    Endif
  Endif

End

Public Sub Email_LostFocus()

  Maj_Email()

End

Public Sub Maj_Email()

  Dim rmail As Result
  Dim $Mail As String = Email.Text

  If Not IsNull(Email.Text) Then
    Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMailCli") & " (code, mail) VALUES (&1, &2)", Cd.text, Email.text)
    Rmail = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailCli") & " where code = &1 order by mail", Cd.text)
    If Rmail.Available Then
      Email.clear
      Repeat
        Email.Add(Rmail!mail)
      Until Rmail.MoveNext()
    Endif
    Email.Text = $Mail
  Endif

End

Public Sub Colcli_KeyPress()

  If Key.code = key.Esc Or Key.code = key.f2 Then RdimColcli()

End

Public Sub RdimColcli()

  If Not hColcli Then
    Colcli.Height = Me.Window.Height / 1.07
    hColcli = True
    Deb2()
  Else
    Colcli.Height = Me.Window.Height / 3.22
    hColcli = False
    Deb2()
  Endif

End

Public Sub colcli_Click()

  Vents.clear
  CleanChamps()
  CleanChampsCt()
  Maj_Zones()
  Ventilations()
  cp1.Text = "CP"
  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  'V1.Text = "Ville"
  n = 0
  If Start.LocalSettings["/Soc" & Start.Societe & "/Materiel"] <> 0 Then Aff_Mat()
  Aff_AdrC()
  Aff_Ct()
  Maj_Dssr()
  If hColcli Then
    Colcli.Height = Me.Window.Height / 3.22
    hColcli = False
  Endif

  $grdv.code = cd.Text
  $grdv.razcol
  Cv.SetFocus
  Cv.Select

End

Public Sub Aff_Statut(sStatut As String)

  Dim rResult As Result

  Try rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabStatut") & " where code = &1", sStatut)
  If Not Error Then
    If rResult.Available Then Statut.Text = rResult!code & " - " & rResult!libelle
  Else
    If son Then
      Music.Play
    Endif
    message.Error(Error.Text & " " & Error.where)
  Endif

End

Public Sub Cmpt_GotFocus()

  Try Utils.ObsGotf(Last)

End

Public Sub Cmpt_LostFocus()

  Dim res As Result
  
  Try Utils.ObsLstf(Last)
  Select Case Last.tag
    Case 8
      If Not IsNull(Email.Text) Then Utils.chkEmail(Email.Text)

    Case 16
      If Not IsNull(collectif.Text) Then collman()
      If Enr = 0 Then
        collectif.SetFocus
        collectif.Select
        collectif.Clear
        Stop Event
      Endif
    Case 17
      If Paneltr1.Visible Then
        If Texttr1.Text Then
          res = utils.db.Exec("SELECT * FROM Fiches_region WHERE code=&1", Texttr1.Text)
          If Not res.Available Then
            Balloon.Delay = 5000
            Balloon.Warning("<FONT Color=#212121>" & "Code inconnu", Texttr1)
            Texttr1.Clear
            Texttr1.SetFocus
          Endif
        Endif
      Endif
    Case 18
       If Textto1.Text Then
        res = utils.db.Exec("SELECT * FROM Fiches_tourne WHERE code=&1", Textto1.Text)
          If Not res.Available Then
            Balloon.Delay = 5000
            Balloon.Warning("<FONT Color=#212121>" & "Tournée inconnu", Textto1)
            Textto1.Clear
            Textto1.SetFocus
          Endif
        Endif
  End Select

End

Public Sub Cmpt_KeyPress()

  With utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag

        Case 1
          Nm.SetFocus
          Nm.Select
          Stop Event

        Case 2
          If Cd.Text Then
            Nm.Text = .Remplace(Nm.Text)
            Pnm.SetFocus
            Pnm.Select
          Else
            Message.Warning("Veuillez cliquer sur le bouton 'Créer' avant de remplir les zones SVP !", "Ok")
          Endif
          Stop Event

        Case 3
          Pnm.Text = .Remplace(Pnm.Text)
          Adresse1.SetFocus
          Adresse1.Select
          Stop Event

        Case 4
          Adresse1.Text = .Remplace(Adresse1.Text)
          Adresse2.SetFocus
          Adresse2.Select
          Stop Event

        Case 5
          Adresse2.Text = .Remplace(Adresse2.Text)
          cp.SetFocus
          cp.Select
          Stop Event

        Case 6
          bl = 0
          Cpman3()
          Stop Event

        Case 7
          Burdist.Text = .Remplace(Burdist.Text)
          If Paneltr1.Visible Then
            Texttr1.SetFocus
            Texttr1.Select
          Else
            Textto1.SetFocus
            Textto1.Select
          Endif
          Stop Event
          
        Case 17
          Textto1.SetFocus
          Textto1.Select
          Stop Event
          
        Case 18
          Email.SetFocus
          Email.Select
          Stop Event

        Case 8
          If Not IsNull(Email.Text) Then Utils.chkEmail(Email.Text)
          Idtva.SetFocus
          Idtva.Select
          Stop Event

        Case 9
          Teldom.SetFocus
          Teldom.Select
          Stop Event

        Case 10
          Telbur.SetFocus
          Telbur.Select
          Stop Event

        Case 11
          Poste.SetFocus
          Poste.Select
          Stop Event

        Case 12
          Portable.SetFocus
          Portable.Select
          Stop Event

        Case 13
          Fax1.SetFocus
          Fax1.Select
          Stop Event

        Case 14
          fax2.SetFocus
          fax2.Select
          Stop Event

        Case 15
          collectif.SetFocus
          collectif.Select
          Stop Event

        Case 16
          collman()
          If Enr = 0 Then
            collectif.SetFocus
            collectif.Select
            Stop Event
          Else
            nm.SetFocus
            nm.Select
          Endif
      End Select
    Endif

    If key.code = key.F1 Then
      Button7_Click()
      Stop Event
    Endif

    If Key.code = Key.F2 Then
      Select Case Last.tag
        Case 2
          RdimColcli()
          Stop Event
        Case 6
          ToggleButton5_Click()
          Stop Event
        Case 10
          ToggleButton3_Click()
          Stop Event

        Case 16
          ToggleButton2_Click()
          Stop Event
      End Select
    Endif

    If Key.code = Key.F6 Then
      Select Case Last.tag
        Case 1
          ChiffreA()
        Case 2
          ChiffreA()
        Case 3
          ChiffreA()
      End Select
    Endif
  End With

End

Public Sub Cnt_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Cnt_KeyPress()

  With utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag

        Case 1
          Nm3.SetFocus
          Nm3.Select
          Stop Event

        Case 2
          Nm3.Text = .Remplace(Nm3.Text)
          Pnm3.SetFocus
          Pnm3.Select
          Stop Event

        Case 3
          Pnm3.Text = .Remplace(Pnm3.Text)
          Tel2.SetFocus
          Tel2.Select
          Stop Event

        Case 4
          Portable2.SetFocus
          Portable2.Select
          Stop Event

        Case 5
          Mail2.SetFocus
          Mail2.Select
          Stop Event

        Case 6
          Fonction.SetFocus
          Fonction.Select
          Stop Event
      End Select
    Endif
  End With

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cbl_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Cbl_KeyPress()

  With utils
    If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
      Select Case Last.tag

        Case 1
          Nm2.SetFocus
          Nm2.Select
          Stop Event

        Case 2
          Nm2.Text = .Remplace(Nm2.Text)
          Pnm2.SetFocus
          Pnm2.Select
          Stop Event

        Case 3
          Pnm2.Text = .Remplace(Pnm2.Text)
          Adresse4.SetFocus
          Adresse4.Select
          Stop Event

        Case 4
          Adresse4.Text = .Remplace(Adresse4.Text)
          Adresse3.SetFocus
          Adresse3.Select
          Stop Event

        Case 5
          Adresse3.Text = .Remplace(Adresse3.Text)
          cp2.SetFocus
          cp2.Select
          Stop Event

        Case 6
          bl = 1
          Cpman2()
          Stop Event

        Case 7
          Burdist2.Text = .Remplace(Burdist2.Text)
          Stop Event

      End Select
    Endif
  End With

End

Public Sub Cmpt2_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag

      Case 1
        codeguichet.SetFocus
        codeguichet.Select
        Stop Event

      Case 2
        numcompte.SetFocus
        numcompte.Select
        Stop Event

      Case 3
        Cle.SetFocus
        Cle.Select
        Stop Event

      Case 4
        dom.SetFocus
        dom.Select
        Stop Event

      Case 5
        cent.SetFocus
        cent.Select
        Stop Event

      Case 6
        Cacc.SetFocus
        Cacc.Select
        Stop Event

      Case 7
        Tire.SetFocus
        Tire.Select
        Stop Event

      Case 8
        Iban.SetFocus
        Iban.Select
        Stop Event

      Case 9
        Bic.SetFocus
        Bic.Select
        Stop Event

      Case 10
        Encours.SetFocus
        Encours.Select
        Stop Event

      Case 11
        Cdech.SetFocus
        Cdech.Select
        Stop Event

      Case 12
        echman()
        If Enr = 0 Then
          Cdech.SetFocus
          Cdech.Select
          Stop Event
        Else
          Textfrais.SetFocus
          Textfrais.Select
          Stop Event
        Endif

      Case 16
        Remmo.SetFocus
        Remmo.Select
        Stop Event

      Case 13
        Remart.SetFocus
        Remart.Select
        Stop Event

      Case 14
        codebanque.SetFocus
        codebanque.Select
        Stop Event

    End Select
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If key.code = key.F9 Then
    Select Case Last.tag
      Case 15
        GenRum()
        Stop Event
    End Select

  Endif

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt2_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Cmpt3_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag

      Case 1
        Ventilman()
        Stop Event

      Case 2
        Button6_Click()
        Compt.SetFocus
        Stop Event

    End Select
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        ToggleButton1_Click()
        Stop Event
    End Select
  Endif

End

Public Sub Vnt_Click()

  Select Case Last.tag
    Case 1
      Button6_Click()
      Compt.SetFocus
      Compt.Select
  End Select

End

Public Sub Vnt_KeyPress()

  Select Case Last.tag
    Case 1
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Button6_Click()
        Compt.SetFocus
        Compt.Select
        Stop Event
      Endif
  End Select

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt3_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub C1_GotFocus()

  Try Utils.ObsGotf(C1)
  C1_Click()

End

Public Sub C1_LostFocus()

  Try Utils.ObsLstf(C1)

End

Public Sub N1_GotFocus()

  Try Utils.ObsGotf(n1)
  N1_Click()

End

Public Sub N1_LostFocus()

  Try Utils.ObsLstf(N1)

End

Public Sub A1_GotFocus()

  Try Utils.ObsGotf(a1)
  A1_Click()

End

Public Sub A1_LostFocus()

  Try Utils.ObsLstf(A1)

End

Public Sub cp1_GotFocus()

  Try Utils.ObsGotf(Cp1)
  cp1_Click()

End

Public Sub cp1_LostFocus()

  Try Utils.ObsLstf(Cp1)

End

Public Sub V1_GotFocus()

  Try Utils.ObsGotf(v1)
  V1_Clk()

End

Public Sub V1_LostFocus()

  Try Utils.ObsLstf(V1)

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      Button7_Click()

    Case 2
      Button1_Click()

    Case 3
      Button2_Click()

    Case 4
      Button3_Click()

    Case 5
      Button4_Click()

    Case 6
      Me.Close

    Case 7
      Button12_Click()

    Case 8
      Button13_Click()

    Case 9
      Panel2.visible = False

    Case 10
      Button19_Click()

  End Select

End

Public Sub Remmo_LF()

  With Utils
    Remmo.Text = .cpoint(Remmo.Text)
    If Val(Remmo.Text) = Null Then
      Remmo.Text = "0.00"
    Else
      Remmo.Text = Format$(Val(.cpoint(Remmo.Text)), "00.00")
    Endif
  End With
  Remmo.Background = Color.TextBackground

End

Public Sub Remart_LF()

  With Utils
    Remart.Text = .cpoint(Remart.Text)
    If Val(Remart.Text) = Null Then
      Remart.Text = "0.00"
    Else
      Remart.Text = Format$(Val(.cpoint(Remart.Text)), "00.00")
    Endif
  End With
  Remart.Background = Color.TextBackground

End

Public Sub Button4_Click()

  Dim rResult As Result
  Dim Col As Boolean
  Dim type As String
  Dim Tab As String
  Dim Tabc As String
  Dim Tabp As String
  Dim CountRow As Integer

  Tab = "Fiches_Cli"
  Tabc = "Fiches_Comptes"
  Tabp = "Fiches_Parametres"
  type = "C"
  Col = False
  With Utils
    Nm.Text = .Remplace(Nm.Text)
    Pnm.Text = .Remplace(Pnm.Text)
    Adresse1.Text = .Remplace(Adresse1.Text)
    Adresse2.Text = .Remplace(Adresse2.Text)
    Burdist.Text = .Remplace(Burdist.Text)
    If Not Nm.Text Or Not collectif.Text Or Not cd.Text Then
      If son Then
        Music.Play
      Endif
      Message("Vous devez d'abord remplir les zones obligatoires (nom, collectif...)\n ou cliquez sur le bouton 'Créer' si vous n'avez pas de code client", "OK")
    Else
      collman()
      If enr = "1" Then
        If button4.text = "Va&lider" Then
          Utils.db.Exec("INSERT INTO " & Tab & " (cli_code,cli_rs_soc,cli_nom,cli_pnm,cli_adr1,cli_adr2,cli_cd_ptl,cli_ville,cli_email,cli_tel_dom,cli_tel_bur,cli_tel_poste,cli_pble,cli_fx1,cli_fx2,cli_plaf_ecrs,cli_cd_bq,cli_cd_gch,cli_dmln,cli_cle_rib,cli_num_cpt,cli_cd_ent,cli_cd_acc,cli_ref_tir,cli_id_tva,cli_rlvc,cli_rlvf,cli_obs,cli_collectif, cli_typec) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27}, &{28}, &{29}, &{30})", Cd.text, CV.text, Nm.text, Pnm.text, Adresse1.text, Adresse2.text, cp.text, Burdist.text, Email.text, Teldom.text, Telbur.text, Poste.text, Portable.text, Fax1.text, Fax2.text, Encours.text, codebanque.text, codeguichet.text, Cle.text, numcompte.text, dom.text, Cent.text, Cacc.text, Tire.text, Idtva.text, Relcompte.Value, Relfacture.Value, Divers.text, collectif.text, Left$(Typec.Text, 2))
          Utils.db.Exec("Update " & Tab & " set cli_rmo = &1, cli_rart = &2, cli_exo = &3, cli_cdech = &5, cli_typec = &6, cli_expl = &7, cli_pays = &8, cli_statut = &9, cli_reg = &{10}, cli_copie = &{11}, cli_actif = &{12}, cli_div = &{13}, cli_iban = &{14}, cli_bic = &{15}, cli_rum = &{16}, cli_datab = &{17}, cli_aban = &{18}, cli_sage = &{19}, cli_livraison = &{20}, cli_comm = &{21}, cli_autoent = &{22}, cli_regr = &{23} where cli_code = &4", Remmo.Text, Remart.Text, Exo.Value, Cd.Text, Cdech.Text, Left$(Typec.Text, 2), Nbexpl.text, pays.Text, Left$(Statut.text, 2), Mreg.Text, Copie.value, Inactif.Value, div.value, Iban.text, Bic.text, Rum.Text, ComboBox1.Text, ComboBox2.Text, Sage.text, Livraison.value, Left$(Comm.Text, 2), AutoEnt.Value, Left(Combreg.Text, 1))
          If $soption = "B" Or $soption = "T" Then addbois
          If $soption = "P" Or $soption = "T" Then addpp
          Utils.db.Exec("insert into " & tabc & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, soldep, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12})", Cd.Text, Nm.Text, type, 0, collectif.Text, 0, 0, 0, 0, 0, 0, lettrable.value)
          If Variables.Sprix And Variables.Sexport And Variables.SMajCli Then Serveur.Pass("Cli", "C", Cd.Text, "")
          Enrgcp.Ecp(Cp.Text, Burdist.Text)
          Button15_Click()
          CleanChampsAdr()
          Button16_Click()
          CleanChampsCt()
          Colal2.Clear
          skey = cd.Text
          Refresh()
          Inactif2.Value = False
          Statut2.Text = " "
          Cleanchamps()
          For CountRow = 0 To (Colcli.Rows.Count - 1)
            If Colcli[CountRow, 0].Text = skey Then
              Colcli.Rows[CountRow].Selected = True
              Break
            Endif
          Next
        Else
          rResult = Utils.db.Exec("Select * From " & Tabc & " where compte_cc = &1", cd.Text)
          If rResult.Available Then
            Utils.db.Exec("UPdate " & Tabc & " SET compte_cc = &1, intitule_cc = &2, type_cc = &3, coll_cc = &4, coll = &5, cent_cc = &6, comptr_cc = &7, gen_tv = &8, gen_ta = &9, lettrable = &{10} WHERE compte_cc = &1", Cd.Text, Nm.Text, type, collectif.Text, Col, 0, 0, 0, 0, lettrable.value)
          Else
            Utils.db.Exec("insert into " & tabc & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, soldep, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12})", Cd.Text, Nm.Text, type, 0, collectif.Text, 0, 0, 0, 0, 0, 0, lettrable.value)
          Endif
          Utils.db.Exec("UPdate  " & Tab & "  SET  cli_code = &1, cli_rs_soc= &2, cli_nom = &3, cli_pnm = &4, cli_adr1 = &5, cli_adr2 = &6, cli_cd_ptl = &7, cli_ville = &8, cli_email = &9, cli_tel_dom = &{10}, cli_tel_bur = &{11}, cli_tel_poste = &{12}, cli_pble = &{13}, cli_fx1 = &{14}, cli_fx2 = &{15}, cli_plaf_ecrs = &{16}, cli_cd_bq = &{17}, cli_cd_gch = &{18}, cli_cle_rib = &{19}, cli_num_cpt = &{20}, cli_dmln = &{21} , cli_cd_ent = &{22}, cli_cd_acc = &{23},cli_ref_tir = &{24}, cli_id_tva = &{25}, cli_rlvc = &{26}, cli_rlvf = &{27}, cli_obs = &{28}, cli_collectif = &{29} WHERE cli_code = &1", Cd.text, CV.text, Nm.text, Pnm.text, Adresse1.text, Adresse2.text, cp.text, Burdist.text, Email.text, Teldom.text, Telbur.text, Poste.text, Portable.text, Fax1.text, Fax2.text, Encours.text, codebanque.text, codeguichet.text, Cle.text, numcompte.text, dom.text, Cent.text, Cacc.text, Tire.text, Idtva.text, Relcompte.Value, Relfacture.Value, Divers.text, collectif.text)
          Utils.db.Exec("Update " & Tab & " set cli_rmo = &1, cli_rart = &2, cli_exo = &3, cli_cdech = &5, cli_typec = &6, cli_expl = &7, cli_pays = &8, cli_statut = &9, cli_reg = &{10}, cli_copie = &{11}, cli_actif = &{12}, cli_div = &{13}, cli_iban = &{14}, cli_bic = &{15}, cli_rum = &{16}, cli_datab = &{17}, cli_aban = &{18}, cli_sage = &{19}, cli_livraison = &{20}, cli_comm = &{21}, cli_autoent = &{22}, cli_regr = &{23} where cli_code = &4", Remmo.Text, Remart.Text, Exo.Value, Cd.Text, Cdech.Text, Left$(Typec.Text, 2), Nbexpl.text, pays.Text, Left$(Statut.text, 2), Mreg.Text, Copie.value, Inactif.Value, Div.value, Iban.text, Bic.text, Rum.Text, ComboBox1.Text, ComboBox2.Text, Sage.Text, Livraison.value, Left$(Comm.Text, 2), AutoEnt.Value, Left(Combreg.Text, 1))
          If $soption = "B" Or $soption = "T" Then addbois
          If $soption = "P" Or $soption = "T" Then addpp
          If Variables.Sprix And Variables.Sexport And Variables.SMajCli Then Serveur.Pass("Cli", "M", Cd.Text, "")
          Enrgcp.Ecp(Cp.Text, Burdist.Text)
          Button15_Click()
          CleanChampsAdr()
          Button16_Click()
          CleanChampsCt()
          Colal2.Clear
          sKey = Colcli.row
          Inactif2.Value = False
          Statut2.Text = " "
          Cleanchamps()
          Refresh()
          Colcli.MoveTo(skey, 0)
        Endif
        button4.text = "Enregistrer"
      Endif
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  'Message.Error("La création de ce compte client est impossible car ce numéro existe déjà !")

End

Private Sub addbois()
  
  Utils.db.Exec("UPdate  Fiches_Cli  SET cli_cons=&1 WHERE cli_code=&2", Checkcons.Value, cd.Text) 
  
End

Private Sub addpp()
  
  Utils.db.Exec("UPdate  Fiches_Cli  SET cli_tipp=&1 WHERE cli_code=&2", Texttr1.Text, cd.Text) 
  
End

Public Sub Button3_Click()

  Dim rResult As Result
  Dim Tab As String
  Dim tabv As String
  Dim tabc As String
  Dim tabbl As String
  Dim tabmvt As String
  Dim tabcors As String
  Dim Suppr As Integer

  Tab = "Fiches_Cli"
  Tabv = "Fiches_Cli_Vtl"
  Tabc = "Fiches_Comptes"
  Tabmvt = "Fiches_Mvt"
  Tabbl = "Fiches_Bl"
  Tabcors = "Corsage"
  If Not IsNull(cd.Text) Then
    Suppr = 1
    If son Then
      Music.Play
    Endif
    If Message.Question("Etes vous sur de vouloir effacer cet enregistrement", "Oui", "Non") = 1 Then
      Me.Mouse = Mouse.Wait
      rResult = Utils.db.Exec("SELECT * FROM " & Tabmvt & " WHERE  compte = &1", Cd.Text)
      If rResult.Available Then
        If son Then
          Music.Play
        Endif
        Message.Warning(" Suppression impossible ! compte Mouvementé")
        Suppr = 0
      Else
        rResult = Utils.db.Exec("SELECT * FROM " & Tabbl & " WHERE  cdclibl = &1", Cd.Text)
        If rResult.Available Then
          If son Then
            Music.Play
          Endif
          Message.Warning(" Suppression impossible ! compte utilisé en saisie de Bl")
          Suppr = 0
        Endif
      Endif
      If Suppr = 1 Then
        Utils.db.Exec("DELETE FROM " & Tab & " WHERE cli_code = &1", Cd.Text)
        Utils.db.Exec("DELETE from " & Tabc & " where compte_cc = &1", Cd.text)
        rResult = Utils.db.Exec("SELECT * FROM " & Tabv & " WHERE code = &1", Cd.Text)
        If rResult.available Then
          Utils.db.Exec("DELETE from " & Tabv & " where code = &1", Cd.Text)
        Endif
        Utils.db.Exec("DELETE FROM " & Cbase.Table("TabCdocs") & " WHERE code = &1", Cd.Text)
        Utils.db.Exec("DELETE FROM " & TabCors & " WHERE ncode = &1", Cd.Text)
        'Si serveur de prix les suppressions se feront à la main coté c lient
        sKey = Colcli.row
        Refresh()
        Inactif2.Value = False
        Statut2.Text = " "
        Cleanchamps()
        Colcli.MoveTo(skey, 0)
      Endif
      Me.Mouse = Mouse.Pointing
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Pointing

End

Public Sub Button2_Click()

  Dim tab As String
  Dim tabcl As String
  Dim Tab2 As String
  Dim rResult As Result
 

  Tab = "Fiches_Parametres"
  Tab2 = "Fiches_Comptes"
  Tabcl = "Fiches_Cli"
  Button4.Text = "Va&lider"
  cleanChamps()
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE , " & Tabcl & " READ")
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If IsNull(rResult!dnc) Or If rResult!dnc < 411000 Then
    Message.Error("Il y a un problème pour la création des comptes clients \n Veuillez contrôler les paramètres SVP !")
  Else
    Cd.Text = rResult!dnc
    If IsNull(rResult!frais) Then
      Message.Info("Veuillez renseigner le montant et les comptes frais de gestion dans les paramètres")
      Textfrais.Text = "0,00"
    Else
      Textfrais.Text = Format(rResult!frais, "0.00")
    Endif
    'TODO la gestion de l'increment devrait etre plus générique
    If Val(Cd.Text) = 411999 Then
      Cd.Text = 4111000
    Else
      If Val(Cd.Text) = 4119999 Then
        Cd.Text = 41110000
      Else
        Cd.Text = Val(Cd.Text) + 1
        rResult = Utils.db.Exec("SELECT cli_code FROM " & Tabcl & " where cli_code = &1", Cd.Text)
        If rResult.Available Then
          Message.Warning("Attribution Impossible, le compte " & Cd.Text & " existe déjà, retour à la fin de la liste")
          rResult = Utils.db.Exec("SELECT cli_code FROM " & Tabcl & " order by cli_code desc limit 1")
          'Il y a forcement un résultat
          Cd.Text = rResult!cli_code + 1
        Endif
      Endif
    Endif
    GenRum()
    Utils.db.Exec("Update " & Tab & " set dnc = &1", "411" & Right$(cd.Text, Len(cd.Text) - 3))
    Utils.db.Exec("UNLOCK TABLES")
    rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " where coll = '1' and left(compte_cc,2) = &1 order by cast(compte_cc AS char)", "41")
    If rResult.Available Then collectif.Text = rResult!compte_cc
    Try Nbexpl.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Expfact"]
    Try Pays.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Pays"]
    Try Cdech.Text = Left$(Start.LocalSettings["/Soc" & Start.Societe & "/Ech"], 2)
    Typec.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Typec"]
    Try Copie.Value = Start.LocalSettings["/Soc" & Start.Societe & "/Pdf"]
    Cv.SetFocus
    Cv.Select
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default

End

Public Sub GenRum()

  Randomize
  If Not IsNull(cd.text) Then Rum.Text = hexdblKey.Crypt("en", Int(Rnd(10, 99)) & Cd.Text & Int(Rnd(10, 99)), "LauruX")

End

Public Sub Ventilations()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Cli_Vtl"
  Vents.Columns.count = 2
  Vents.Columns[0].Width = 65
  Vents.Columns[1].Width = 280
  Vents.Columns[0].Text = "code"
  Vents.Columns[1].Text = "Intitulé"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE  code = '" & Cd.Text & "' ORDER BY code_vtl")
  If rResult.Available Then
    Repeat
      Vents.add(rResult!code_vtl, rResult!code_vtl)
      Vents.Item[0] = rResult!code_vtl
      Vents.Item[1] = rResult!intitule_vtl
    Until rResult.MoveNext()
  Endif

End

Public Sub ToggleButton1_Click()

  Dim MyForm As TriComptes

  Tri = "cast(compte_cc AS char)"
  Type = "G"
  Comptabilite.bsel = False
  MyForm = New TriComptes(Tri, Type, "", "")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    Compt.text = Comptabilite.sCmpt
    intitule.Text = Comptabilite.sDesg
    Button6.SetFocus
  Endif

End

Public Sub ToggleButton2_Click()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Comptes"
  If Colcompt2.visible Then
    Colcompt2.clear
    Colcompt2.visible = False
  Else
    Colcompt2.visible = True
    Colcompt2.Raise
    Colcompt2.Columns.count = 2
    Colcompt2.Columns[0].Width = 65
    Colcompt2.Columns[1].Width = 280
    Colcompt2.Columns[0].Text = "code"
    Colcompt2.Columns[1].Text = "Intitulé"
    'If Coop.value = False Then
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where coll =&1 and left(compte_cc,2) = &2 order by cast(compte_cc AS char)", 1, 41)
    'Else
    'If Len(Prefixe.Text) = 3 Then
    'rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where coll =&1 and left(compte_cc,3) = &2 order by cast(compte_cc AS char)", 1, Prefixe.Text)
    'Else
    'rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where coll =&1 and left(compte_cc,4) = &2 order by cast(compte_cc AS char)", 1, Prefixe.Text)
    'Endif
    If rResult.Available Then
      Repeat
        Colcompt2.Add(rResult!compte_cc, rResult!compte_cc)
        Colcompt2.Item[0] = rResult!compte_cc
        Colcompt2.Item[1] = rResult!intitule_cc
      Until rResult.MoveNext()
      Colcompt2.MoveFirst
      Colcompt2.SetFocus
      Colcompt2.Item.Selected = True
    Endif
  Endif

End

Public Sub Colcompt2_Click()

  collectif.text = Colcompt2.Item[0]
  Colcompt2.visible = False
  Colcompt2.clear

End

'********************************************************************
'* Gestion du columnview Colcompt2 lors d'une saisie manuelle       *
'********************************************************************
Public Sub Colcompt2_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcompt2.MoveCurrent
    Colcompt2_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcompt2.visible = False
    Colcompt2.clear
    collectif.Select
    collectif.SetFocus
    Stop Event
  Endif

End

Public Sub Button6_Click()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Cli_Vtl"
  If Not Nm.TEXT Or Not collectif.TEXT Then
    If son Then
      Music.Play
    Endif
    Message("VOUS DEVEZ D'ABORD REMPLIR LES CHAMPS OBLIGATOIRES(Nom, collectif ...)", "OK")
  Else
    If compt.Text = "" Then
      If son Then
        Music.Play
      Endif
      message.warning("ATTENTION ! Veuillez saisir un compte SVP !", "OK !")
    Else
      Ventilman()
      If Enr = 1 Then
        rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE code_vtl = &1 and code = &2", Compt.Text, Cd.Text)
        If rResult.Available Then
          Utils.db.Exec("UPdate " & tab & " SET code = &1, code_vtl = &2, intitule_vtl = &3 WHERE code_vtl = &2 and code = &1", Cd.Text, Compt.Text, intitule.Text)
        Else
          Utils.db.Exec("INSERT INTO " & tab & " (code,code_vtl, intitule_vtl) Values (&1,&2,&3)", Cd.Text, Compt.Text, intitule.Text)
        Endif
      Endif
    Endif
  Endif
  Vents.clear
  Ventilations()
  CleanVtl()
  Compt.SetFocus
  Compt.Select

End

'********************************************** On gère les types clients ******************************************

Public Sub ToggleButton4_Click()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Typec"
  Coltype.Raise
  If Coltype.visible Then
    Coltype.clear
    Coltype.visible = False
  Else
    Coltype.visible = True
    Coltype.Raise
    Coltype.Columns.count = 2
    Coltype.Columns[0].Width = 65
    Coltype.Columns[1].Width = 280
    Coltype.Columns[0].Text = "code"
    Coltype.Columns[1].Text = "Intitulé"
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by code")
    If rResult.Available Then
      Repeat
        Coltype.Add(rResult!code, rResult!code)
        Coltype.Item[0] = rResult!code
        Coltype.Item[1] = rResult!libelle
      Until rResult.MoveNext()
      Coltype.MoveFirst
      Coltype.SetFocus
      Coltype.Item.Selected = True
    Endif
  Endif

End

Public Sub Typec_KeyPress()

  If key.Code = key.F2 Then
    ToggleButton4_Click
    Stop Event
    Typec.SetFocus
    Typec.Select
  Endif

End

Public Sub Coltype_Click()

  Recup_Typec(Coltype.Current[0])
  Coltype.Clear
  Coltype.Visible = False

End

Public Sub Recup_Typec(Type As String)

  Dim Rtypec As Result
  Dim Tab As String

  Tab = "Fiches_Typec"
  Rtypec = Utils.db.Exec("SELECT * FROM " & Tab & " where code = &1", type)
  If Rtypec.Available Then Typec.Text = Rtypec!code & " - " & Rtypec!libelle

End

'*************************************** On gère les échéances *******************************************
Public Sub ToggleButton3_Click()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Echeances"
  If Colech.visible Then
    Colech.clear
    Colech.visible = False
  Else
    Colech.visible = True
    Colech.Raise
    Colech.Columns.count = 2
    Colech.Columns[0].Width = 65
    Colech.Columns[1].Width = 166
    Colech.Columns[0].Text = "code"
    Colech.Columns[1].Text = "Intitulé"
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by num")
    If rResult.Available Then
      Repeat
        Colech.Add(rResult!num, rResult!num)
        Colech.Item[0] = rResult!num
        Colech.Item[1] = rResult!libell
      Until rResult.MoveNext()
      Colech.MoveFirst
      Colech.SetFocus
      Colech.Item.Selected = True
    Endif
  Endif

End

Public Sub Colech_Click()

  Cdech.text = Colech.Item[0]
  Colech.visible = False
  Colech.clear
  Iban.SetFocus
  Iban.Select

End

'*****************************************************************
'* Gestion du columnview Colech lors d'une sélection manuelle    *
'*****************************************************************
Public Sub Colech_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colech.MoveCurrent
    Colech_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colech.visible = False
    Colech.clear
    Cdech.Select
    Cdech.SetFocus
    Stop Event
  Endif

End

'***************************************
'* Saisie manuelle d'une echeance      *
'***************************************
Public Sub echman()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Echeances"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where num = &1", Cdech.text)
  If Not rResult.Available Then
    Enr = 0
    If son Then
      Music.Play
    Endif
    Message.Error("Attention ! Ce code échéance n'existe pas.")
  Else
    Enr = 1
    Cdech.text = rResult!num
  Endif

End

Public Sub Cmpt3_Click()

  Button6_Click()

End

Public Sub Vents_Keypress()

  If key.code = key.Delete Then
    Vents_Activate()
  Endif
  Stop Event

End

Public Sub Vents_Activate()

  Dim Tabv As String

  Tabv = "Fiches_Cli_Vtl"
  If son Then
    Music.Play
  Endif
  If Message.Question("Etes vous sur de vouloir effacer cet enregistrement", "Oui", "Non") = 1 Then
    Utils.db.Exec("DELETE  FROM " & Tabv & " WHERE code = &1 and  code_vtl =&2", Cd.Text, Vents.Current[0])
    Refresh()
    Ventilations()
  Endif
  Compt.SetFocus
  Compt.Select

End

Public Sub Dbclk()

  If Not Dbl Then
    Deb3()
    Dbl = "1"
  Else
    Deb2()
    Dbl = ""
  Endif

End

Public Sub Titre()

  C1.Text = "Code"
  N1.Text = "Nom"
  A1.Text = "Adresse 1"
  cp1.Text = "CP"
  If ComboCom = False Then V1.Text = "Ville"

End

Public Sub C1_Click()

  sel = ""
  ComboCom = False
  Titre()
  C1.Text = ""
  Tri = "cli_code"
  Dbl = ""
  Deb2()

End

Public Sub C1_Dblclick()

  Dbclk()

End

Public Sub N1_Click()

  sel = ""
  ComboCom = False
  Titre()
  N1.Text = ""
  Tri = "cli_nom"
  Dbl = ""
  Deb2()

End

Public Sub N1_Dblclick()

  Dbclk()

End

Public Sub A1_Click()

  sel = ""
  ComboCom = False
  Titre()
  A1.Text = ""
  Tri = "cli_adr1"
  Dbl = ""
  Deb2()

End

Public Sub A1_Dblclick()

  Dbclk()

End

Public Sub Cp1_Click()

  sel = ""
  ComboCom = False
  Titre()
  cp1.Text = ""
  Tri = "cli_cd_ptl"
  Dbl = ""
  Deb2()

End

Public Sub Cp1_Dblclick()

  Dbclk()

End

Public Sub V1_Clk()

  sel = ""
  ComboCom = True
  Titre()
  If V1.Text = "Ville" Then
    Tri = "cli_ville"
  Else
    Tri = "nom"
  Endif
  V1.Text = ""
  Dbl = ""
  Deb2()

End

Public Sub V1_Dblclick()

  Dbclk()

End

Public Sub Ref()

  Tab = "Fiches_Cli"
  Tri = "cli_code"
  CleanChamps()
  Tris()
  'Deb2()

End

Public Sub C1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif
  If Key.code = key.f2 Or key.code = key.Esc Then RdimColCli()

End

Public Sub N1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif
  If Key.code = key.f2 Or key.code = key.Esc Then RdimColCli()

End

Public Sub A1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif
  If Key.code = key.f2 Or key.code = key.Esc Then RdimColCli()

End

Public Sub Cp1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Org = True
    Deb2()
    Org = False
  Endif
  If Key.code = key.f2 Or key.code = key.Esc Then RdimColCli()

End

Public Sub V1_KeyPress()

  If Key.code = Key.Return Or Key.code = Key.Enter Then
  Else
    If key.code = key.backspace Then
      sel = Left$(sel, (Len(sel) - 1))
    Else
      sel = sel & key.Text
    Endif
    Deb2()
  Endif
  If Key.code = key.f2 Or key.code = key.Esc Then RdimColCli()

End

Public Sub collman()

  Dim rResult As Result
  Dim Tab As String

  Enr = 1
  Tab = "Fiches_Comptes"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where compte_cc = &1", collectif.Text)
  If rResult.Available Then
    If Not rResult!coll Then Enr = 0
    If Enr = 1 And Left$(collectif.Text, 2) <> "41" And Left$(collectif.Text, 3) <> "453" Then
      Enr = 0
    Else
      Enr = 1
    Endif
    If Enr = 0 Then
      If son Then
        Music.Play
      Endif
      Message.Warning("Attention ! Ce compte n'est pas un collectif client", "OK")
    Endif
  Else
    If son Then
      Music.Play
    Endif
    Message.Error("Attention ! Ce collectif n'existe pas.")
    Enr = 0
  Endif
Catch

End

Public Sub Ventilman()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Comptes"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where compte_cc = &1", Compt.Text)
  If Not rResult.Available Then
    Enr = 0
    If son Then
      Music.Play
    Endif
    Message.Error("Attention ! Ce compte n'existe pas.")
  Else
    If rResult!type_cc = "F" Or rResult!type_cc = "C" Or rResult!coll Then
      Message.Warning("Vous ne pouvez pas sasir ce type de compte dans les ventilations !")
      Compt.clear
      Compt.SetFocus
      Compt.Select
      Enr = 0
    Else
      Enr = 1
      Compt.text = rResult!compte_cc
      intitule.text = rResult!intitule_cc
      Button6.SetFocus
    Endif
  Endif

End

Public Sub Button1_Click()

  Dim hForm As Commail

  hForm = New Commail("F")
  Variables.stexte = ""
  If Message.Question("Voulez-vous sélectionner un texte prédéfini ?", "Oui", "Non") = 1 Then
    hForm.Showmodal()
    Envoi()
  Else
    Envoi()
  Endif

End

Public Sub Envoi()

  Dim AdrMail As String = ""
  Dim Txtentete As String = Start.LocalSettings["/Soc" & Start.Societe & "/Tmail2"]
  Dim Txtcorps As String = Start.LocalSettings["/Soc" & Start.Societe & "/Tmail"]

  If Not IsNull(Variables.stexte) Then Txtcorps = Variables.stexte
  If IsNull(Txtentete) Then Txtentete = " "
  If IsNull(Txtcorps) Then Txtcorps = " "
  If Tabstrip1.Index = 0 Then AdrMail = Email.Text
  If Tabstrip1.Index = 6 Then AdrMail = Mail2.Text
  EnvMail.Envoi2(AdrMail, Txtentete, Txtcorps, "")

End

Public Sub Button19_Click()

  Dim hForm As Gsm
  Dim Telp As String

  If Tabstrip1.Index = 0 Then
    Telp = Portable.Text
    Telp = Replace$(Telp, ".", "")
    Telp = Replace$(Telp, " ", "")
    hForm = New Gsm(Telp)
    hForm.Showmodal()
  Else
    If Tabstrip1.Index = 4 Then
      Telp = Portable2.Text
      Telp = Replace$(Telp, ".", "")
      Telp = Replace$(Telp, " ", "")
      hForm = New Gsm(Telp)
      hForm.Showmodal()
    Endif
  Endif

End

'****************************** Gestion des étiquettes ***************************************
Public Sub Button12_Click()

  If Not IsNull(Cd.Text) Then Panel2.Visible = True
  init_ComboBox()

End

Public Sub init_ComboBox()

  Dim retiq As Result
  Dim Tab As String = "Fiches_Etiquettes"

  Codetiq.clear
  Try rEtiq = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If Not Error Then
    If rEtiq.Available Then
      Do
        Codetiq.Add(rEtiq!code & "- " & rEtiq!libelle)
      Loop Until rEtiq.MoveNext()
    Endif
    Codetiq.Text = ""
  Endif

End

Public Sub Button13_Click()

  Dim Etiqr As Result
  Dim Tab As String
  Dim i As Integer = 1
  Dim nom1 As String '

  Tab = "Fiches_Etiquettes"
  Nbetq = 1
  sFetiq = Left$(Format.text, 1)
  Txtposx = 0
  txtposy = 0
  Etiqr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabSoc") & " where cd_sc = &1", Start.Societe)
  sSociete = Etiqr!type_sc & " " & Etiqr!int_sc
  sadr1 = Etiqr!adr1_sc
  sadr2 = Etiqr!adr2_sc
  sCP = Etiqr!cp_sc & "  " & Etiqr!burdis_sc
  Try Etiqr = Utils.db.Exec("SELECT * FROM " & tab & " WHERE code = &1", Left$(Codetiq.Text, 1))
  If Not Error Then
    If Etiqr.Available Then
      Nblargeur = Etiqr!nblargeur
      Nbhauteur = Etiqr!nbhauteur
      Largeur = Etiqr!largeur / 10
      Hauteur = Etiqr!hauteur / 10
      Mrghaut = Etiqr!mrghaut / 10
      Mrgauche = Etiqr!mrgauche / 10
      Esplargeur = Etiqr!esplargeur / 10
      Esphauteur = Etiqr!esphauteur / 10
      txtPosX = 2 + Mrgauche
      txtPosY = 3 + Mrghaut
      Shell "cd " & User.Home & ""
      Filename = User.Home & "/tmp/EtiqCli.pdf"
      Try Kill Filename
      pdf = New CEtiquettes("Portrait", "mm", "A4")
      pdf.Open()
      pdf.NewPage()
      Me.Mouse = Mouse.Wait
      If Val(Posetiq.Text) > 1 Then
        nom1 = ""
        For i = 1 To Val(Posetiq.text) - 1
          Inc Nbetq
          If Nbetq = 2 Then i2 = 1
          nb = True
          If sFetiq = "1" Then
            pos_Etiq()
          Else
            pos_EtiqC()
          Endif
        Next
      Endif
      If sFetiq = "1" Then
        Imprime()
      Else
        ImprimeC()
      Endif
      fin_impression()
      Me.Mouse = Mouse.Pointing
      i2 = 0
      txtposx = 0
      txtposy = 0
    Endif
  Else
    If son Then
      Music.Play
    Endif
    message(" Veuillez d'abord créer les formats d'étiquettes SVP !!!", "OK")
  Endif

End

Public Sub Imprime()

  Dim i As Integer

  For i = 1 To Val(Nombretiq.Text)
    If nb = False Then
      pos_Etiq()
    Else
      nb = False
    Endif
    pdf.Nom(Cv.text & " " & Nm.Text & " " & Pnm.Text, txtPosX, txtPosY)
    pdf.Nom(Adresse1.Text, txtPosX, txtPosY + 5)
    pdf.Nom(Adresse2.Text, txtPosX, txtPosY + 10)
    pdf.Cp(Cp.Text & " " & Burdist.Text, txtPosX, txtPosY + 15)
    Inc nbetq
  Next

End

Public Sub ImprimeC()

  Dim i As Integer

  For i = 1 To Val(Nombretiq.Text)
    If nb = False Then
      pos_EtiqC()
      nb = False
    Endif
    pdf.Adrexp("Expediteur", txtposx, txtPosY)
    txtPosY = txtPosY + 14
    pdf.NomC(sSociete, txtPosX, txtPosY)
    pdf.NomC(sAdr1, txtPosX, txtPosY + 8)
    pdf.NomC(sAdr2, txtPosX, txtPosY + 16)
    pdf.CpC(sCP, txtPosX, txtPosY + 24)
    txtPosY = txtPosY + 65
    pdf.Adrexp("Destinataire", txtposx, txtPosY)
    txtPosY = txtPosY + 14
    pdf.NomC(Cv.text & " " & Nm.Text & " " & Pnm.Text, txtPosX, txtPosY)
    pdf.NomC(Adresse1.Text, txtPosX, txtPosY + 8)
    pdf.NomC(Adresse2.Text, txtPosX, txtPosY + 16)
    pdf.CpC(Cp.Text & " " & Burdist.Text, txtPosX, txtPosY + 24)
    Inc nbetq
    nb = False
  Next

End

Public Sub fin_impression()

  pdf.Output(Filename, False)
  Impression.Prog_Editeur(Filename)
  Panel2.Visible = False

End

Public Sub pos_Etiq()

  If Nbetq = 1 Then
    txtPosX = 2 + Mrgauche
  Else
    If sFetiq = "1" Then
      txtPosX = 2 + Mrgauche + (Largeur * (Nbetq - 1)) + Esplargeur
    Else
      txtPosy = 120
    Endif
  Endif
  If Nbetq > Val(Nblargeur) Then
    Nbetq = 1
    txtPosX = 2 + Mrgauche
    If sFetiq = "1" Then
      txtPosY = txtPosY + Hauteur + Esphauteur
    Else
      txtPosY = txtPosY + 120
    Endif
    Inc i2
    If i2 > Val(Nbhauteur) Then
      pdf.NewPage()
      i2 = 0
      Nbetq = 1
      txtPosX = 2 + Mrgauche
      txtPosY = 2.1 + Mrghaut
    Endif
  Endif

End

Public Sub pos_EtiqC()

  If (Nbetq Mod 2) = 1 Then
    txtPosX = 2 + Mrgauche
    txtPosY = 6
    If Nbetq = 3 Then
      txtPosy += 146
    Endif
    Inc i2
  Else
    If sFetiq = "1" Then
      txtPosX = 2 + Mrgauche + (Largeur * (Nbetq - 1)) + Esplargeur
    Else
      If (Nbetq Mod 2) = 0 Then
        txtPosX = txtPosx + 100
        If Nbetq = 2 Then txtPosY = 6
        If Nbetq > 2 Then txtPosY = 146
      Else
        txtposx = 2 + Mrgauche
        txtPosy += 140
      Endif
    Endif
  Endif
  If i2 > Val(Nbhauteur) Then
    pdf.NewPage()
    i2 = 0
    Nbetq = 1
    txtPosX = 2 + Mrgauche
    txtPosY = 2.1 + Mrghaut
  Endif

End

'******************************GESTION DU CODE POSTAL*********************************
Public Sub Cpman()

  Dim MyForm2 As Tricp

  bl = 0
  MyForm2 = New Tricp("Client", Cp.Text)
  MyForm2.Showmodal()
  If Bsel = True Then
    Cp.text = Codepostal
    Burdist.Text = Bureaudistributeur
  Else
    Cp.SetFocus
  Endif

End

Public Sub aff_cp()

  Dim CpResult As Result

  If Bl = 1 Then
    Colcp.X = 200
    Colcp.Y = 320
  Else
    Colcp.X = 208
    Colcp.Y = 138
  Endif
  Colcp.visible = True
  Colcp.Raise
  Button5.Visible = True
  Colcp.Columns.count = 2
  Colcp.Columns[0].Width = 60
  Colcp.Columns[1].Width = 280
  Colcp.Columns[0].Text = "CP"
  Colcp.Columns[1].Text = "Bureau distributeur"
  If cp.text Or If cp2.text Then
    If bl = 0 Then
      CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
    Else
      CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp2.Text & "%' order by cp, burdist")
    Endif
  Else
    CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " order by cp, burdist")
  Endif
  If CpResult.Available Then
    Repeat
      Colcp.Add(CpResult!cp & CpResult!burdist, CpResult!cp & CpResult!burdist)
      Colcp.Item[0] = CpResult!cp
      Colcp.Item[1] = CpResult!burdist
    Until CpResult.MoveNext()
    Colcp.MoveFirst()
    Colcp.item.Selected = True
    Colcp.setfocus
  Endif

End

Public Sub Colcp_Click()

  If bl = 0 Then
    Cp.Text = Colcp.Item[0]
    Burdist.Text = Colcp.Item[1]
    Colcp.clear
    Colcp.visible = False
    Burdist.SetFocus
    Burdist.Select
  Else
    Cp2.Text = Colcp.Item[0]
    Burdist2.Text = Colcp.Item[1]
    Colcp.clear
    Colcp.visible = False
    Burdist2.SetFocus
    Burdist2.Select
  Endif
  bl = 0

End

'****************************************************************
'* Gestion du columnview Colcp lors d'une saisie manuelle       *
'****************************************************************

Public Sub Colcp_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcp.MoveCurrent
    Colcp_Click()
    Stop Event
  Endif

  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcp.visible = False
    Colcp.clear
    If bl = 0 Then
      Cp.Select
      Cp.SetFocus
    Else
      Cp2.Select
      Cp2.SetFocus
    Endif
    Stop Event
  Endif

End

Public Sub ChkCp()

  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif

End

'****************************** GESTION DU CODE POSTAL BL *********************************
Public Sub Cpman2()

  Dim Rcompte As Result

  Rcompte = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp = &1", Cp2.Text)
  If Rcompte.count = 1 Then
    Burdist2.text = Rcompte!burdist
    Burdist2.SetFocus
    Burdist2.Select
  Else
    If Rcompte.count > 1 Then
      aff_cp()
    Else
      Burdist2.Clear
      Burdist2.SetFocus
      Burdist2.Select
    Endif
  Endif

End

Public Sub Cpman3()

  Dim Rcompte As Result

  Rcompte = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp = &1", Cp.Text)
  If Rcompte.count = 1 Then
    Burdist.text = Rcompte!burdist
    Burdist.SetFocus
    Burdist.Select
  Else
    If Rcompte.count > 1 Then
      aff_cp()
    Else
      Burdist.Clear
      Burdist.SetFocus
      Burdist.Select
    Endif
  Endif

End

Public Sub ToggleButton5_Click()

  Dim MyForm2 As Tricp

  bl = 0
  MyForm2 = New Tricp("Client", "")
  MyForm2.Showmodal()
  If Bsel = True Then
    Cp.text = Codepostal
    Burdist.Text = Bureaudistributeur
  Else
    Cp.SetFocus
  Endif

End

Public Sub ToggleButton6_Click()

  Dim MyForm2 As Tricp

  bl = 1
  MyForm2 = New Tricp("Client", "")
  MyForm2.Showmodal()
  If Bsel = True Then
    Cp2.text = Codepostal
    Burdist2.Text = Bureaudistributeur
  Else
    Cp.SetFocus
  Endif

End

'********************************FIN DE GESTION DU CODE POSTAL**************************

'********************************************** Gestion des adresses de livraison***************************************
Public Sub Button15_Click()

  Dim AdrResult As Result

  If Not IsNull(nm2.Text) Then
    AdrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAdrC") & " where code = &1 and num = &2", Cd.Text, Numero.text)
    If adrResult.Available Then
      Utils.db.Exec("Update " & Cbase.Table("TabAdrC") & " set rs_soc = &2, nom = &3, pnm = &4, adr1 = &5 , adr2 = &6, cd_ptl = &7, ville = &8 where code = &9 and num = &1", Numero.Text, CV2.text, Nm2.text, Pnm2.text, Adresse4.text, Adresse3.text, cp2.text, Burdist2.text, cd.text)
    Else
      AdrResult = Utils.db.Exec("SELECT num FROM " & Cbase.Table("TabAdrC") & " order by num desc")
      Try Numero.Text = AdrResult!num + 1
      If Error Then Numero.Text = "1"
      Utils.db.Exec("Insert INTO " & Cbase.Table("TabAdrC") & " (code, rs_soc, nom, pnm, adr1, adr2, cd_ptl, ville, num) VALUE (&1, &2, &3, &4, &5, &6, &7, &8, &9)", Cd.text, CV2.text, Nm2.text, Pnm2.text, Adresse4.text, Adresse3.text, cp2.text, Burdist2.text, Numero.Text)
    Endif
    If $soption = "P" Or $soption = "T" Then
      Utils.db.Exec("Update " & Cbase.Table("TabAdrC") & " set tipp= &1 WHERE code=&2 AND num=&3", Texttr2.Text, Numero.Text, cd.text)
    Endif
  Endif
  CleanChampsAdr()
  Aff_AdrC()

End

Public Sub Aff_AdrC()

  Dim AdrResult As Result
  Dim iNumero As Integer = 0

  AdrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAdrC") & " where code = &1 order by num ", Cd.text)
  If AdrResult.Available Then
    Repeat
      Try Colal.Add(AdrResult!num & AdrResult!code, AdrResult!num)
      Colal.Item[0] = AdrResult!num
      Colal.Item[1] = AdrResult!rs_soc
      Colal.Item[2] = AdrResult!nom
      Colal.Item[3] = AdrResult!pnm
      Colal.Item[4] = AdrResult!adr1
      Colal.Item[5] = AdrResult!cd_ptl
      Colal.Item[6] = AdrResult!ville
      iNumero = AdrResult!num
    Until AdrResult.MoveNext()
    Numero.Text = inumero + 1
    If Error Then Numero.Text = "1"
    Colal.Columns[0].Width = 0
    Colal.MoveFirst
    Colal.SetFocus
    Colal.Item.Selected = True
  Endif

End

Public Sub Colal_Click()

  Dim rcli As Result

  CleanChampsAdr()
  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabAdrC") & " where code = &1 and num = &2", Cd.Text, Colal.Item[0])
  If rCli.Available Then
    Numero.Text = rcli!num
    CV2.Text = rcli!rs_soc
    Nm2.Text = rcli!nom
    Pnm2.Text = rcli!pnm
    Adresse4.Text = rcli!adr1
    Adresse3.Text = rcli!adr2
    cp2.Text = rcli!cd_ptl
    Burdist2.text = rcli!ville
    Textto2.Text = rcli!tourne
    If $soption = "P" Or $soption = "T" Then
      Texttr2.Text = rcli!tipp
    Endif
  Endif

End

Public Sub Colal_KeyPress()

  If Key.code = Key.Delete And Colal.Count <> 0 Then
    If Message.Question("Etes-vous sur de vouloir supprimer cette adresse de livraison ?", "Oui", "Non") = 1 Then
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabAdrC") & " where code = &1 and num = &2", Cd.Text, Colal.Item[0])
    Endif
    Colal.Clear
    CleanChampsAdr()
    Aff_AdrC()
  Endif

End

Public Sub CleanChampsAdr()

  CV2.Text = ""
  Numero.Clear
  Nm2.Clear
  Pnm2.Clear
  Adresse3.Clear
  Adresse4.Clear
  Cp2.Clear
  Burdist2.Clear
  Textto2.Clear
  If $soption = "P" Or $soption = "T" Then
    Texttr2.Clear
  Endif
End

'********************************************** Gestion des contacts***************************************
Public Sub Button16_Click()

  Dim CrtResult As Result

  If Not IsNull(nm3.Text) Then
    CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContact") & " where code = &1 and num = &2", Cd.Text, Numero2.text)
    If CrtResult.Available Then
      Utils.db.Exec("Update " & Cbase.Table("TabContact") & " set code = &2, nom = &3, pnm = &4, fonction = &5 , tel = &6, mail = &7, portable = &8 where code = &2 and num = &1", Numero2.Text, Cd.Text, Nm3.text, Pnm3.text, Fonction.Text, Tel2.Text, Mail2.Text, Portable2.Text)
      If Variables.Sprix And Variables.Sexport And Variables.SMajCli Then Serveur.Pass("ContactC", "M", Cd.Text, Numero2.text)
    Else
      CrtResult = Utils.db.Exec("SELECT num FROM " & Cbase.Table("TabContact") & " order by num desc")
      Try Numero2.Text = CrtResult!num + 1
      If Error Then Numero2.Text = "1"
      Utils.db.Exec("Insert INTO " & Cbase.Table("TabContact") & " (code, nom, pnm, fonction, tel, mail, portable, num) VALUE (&1, &2, &3, &4, &5, &6, &7, &8)", Cd.text, Nm3.text, Pnm3.text, fonction.Text, Tel2.Text, Mail2.text, Portable2.text, Numero2.text)
      If Variables.Sprix And Variables.Sexport And Variables.SMajCli Then Serveur.Pass("ContactC", "C", Cd.Text, Numero2.text)
    Endif
  Endif
  CleanChampsCt()
  Aff_Ct()

End

Public Sub Aff_Ct()

  Dim CrtResult As Result
  Dim iNumero As Integer = 0

  Colal2.Clear
  CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContact") & " where code = &1 order by num ", Cd.text)
  If CrtResult.Available Then
    Repeat
      Try Colal2.Add(CrtResult!num & CrtResult!code, CrtResult!num)
      Colal2.Item[0] = CrtResult!num
      Colal2.Item[1] = CrtResult!nom
      Colal2.Item[2] = CrtResult!pnm
      Colal2.Item[3] = CrtResult!fonction
      iNumero = CrtResult!num
    Until CrtResult.MoveNext()
    Numero.Text = iNumero + 1
    Colal2.MoveFirst
    Colal2.SetFocus
    Colal2.Item.Selected = True
  Endif

End

Public Sub Colal2_Click()

  Dim rcli As Result

  CleanChampsCt()
  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabContact") & " where code = &1 and num = &2", Cd.Text, Colal2.current[0])
  If rCli.Available Then
    Numero2.Text = rcli!num
    Nm3.Text = rcli!nom
    Pnm3.Text = rcli!pnm
    Fonction.Text = rcli!fonction
    Tel2.text = rcli!tel
    Mail2.Text = rcli!mail
    Portable2.Text = rcli!portable
  Endif

End

Public Sub Colal2_KeyPress()

  If Key.code = Key.Delete And Colal2.Count <> 0 Then
    If Message.Question("Etes-vous sur de vouloir supprimer ce contact ?", "Oui", "Non") = 1 Then
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabContact") & " where code = &1 and num = &2", Cd.Text, Colal2.Current[0])
      If Variables.Sprix And Variables.Sexport And Variables.SMajCli Then Serveur.Pass("ContactC", "S", Cd.Text, Colal2.Current[0])
    Endif
    Colal2.Clear
    CleanChampsCt()
    Aff_Ct()
  Endif

End

Public Sub CleanChampsCt()

  Numero2.Clear
  Nm3.Clear
  Pnm3.Clear
  Fonction.Clear
  Tel2.Clear
  Mail2.Clear
  Portable2.Clear

End

'********************************** Gestion des documents liès ***************************************************

Public Sub Button18_MouseDown()

  Dim hFormc As GedC

  If Not IsNull(Cd.Text) Then
    hFormc = New Gedc("Client", "C", Cd.Text, "")
    hFormc.Showmodal()
    Maj_Dssr()
  Else
    Message.Info("Veuillez saisir un client SVP !")
  Endif

End

Public Sub Dssr_Data(Row As Integer, Column As Integer)

  Try Dssr.Data.Text = tableau[Row, Column]

End

Public Sub Dssr_Activate()

  Dim Attente As Boolean = False

  Try Desktop.Open(Dssr[Dssr.row, 1].Text, Attente)
  If Error Then Message.Info("Ce fichier n'existe pas ! Peut-être devriez-vous le supprimer de cette liste. ")

End

Public Sub Dssr_KeyPress()

  If Key.code = Key.del Or Key.code = Key.delete Then
    If Message.Question("Vous allez supprimer le lien sélectionné.", "Oui", "Non") = 1 Then
      Try Utils.db.Exec("DELETE FROM " & Cbase.Table("TabCdocs") & " WHERE code = &1 and doc = &2", Dssr[Dssr.row, 0].Text, Dssr[Dssr.row, 1].Text)
      If Error Then
        Message.Error("Impossible de supprimer ce document ...")
      Else
        If Message.Question("Le lien a été supprimé !\nVoulez-vous supprimer le fichier ?", "Oui", "Non") = 1 Then Try Kill Dssr[Dssr.row, 1].Text
      Endif
      Maj_Dssr()
    Endif
  Endif
  If Key.code = Key.F2 Then
    If Dssr.Width = TabStrip1.w - 5 Then
      Dssr.Width = Tous.x - 7
    Else
      Dssr.Width = Tabstrip1.w - 5
      Dssr.Columns[2].Width = Tabstrip1.w - (Dssr.Columns[0].Width + Dssr.Columns[3].Width)
    Endif
  Endif
  If Key.code = Key.F3 Then
    Message.Info(Dssr[Dssr.row, 1].Text)
  Endif

End

Public Sub Dssr_MouseDown()

  If Me.mouse = Mouse.right Then
    Tbxrem2.Clear
    If Mouse.Right Then
      If Not Tbxrem2.Visible Then
        Try Dssr.Current.EnsureVisible
        If Not Error Then
          ShowTextBox()
          Tbxrem2.SetFocus
        Endif
      Else
        Tbxrem2.Visible = False
      Endif
    Else
      If Tbxrem2.Visible Then Tbxrem2.Visible = False
    Endif
  Endif

End

' Affichage du Textbox Tbxrem
Public Function ShowTextBox()

  With Dssr.Current
    Tbxrem2.Text = .Text
    Tbxrem2.Width = Dssr.Columns.Width
    Tbxrem2.Move(Dssr.X + Dssr[Dssr.row, 3].x, Dssr.Y + Dssr.Rows.Height + Dssr.current.Y, Dssr.Columns[3].Width, .H)
    Tbxrem2.Text = Dssr[Dssr.row, 3].Text
    Tbxrem2.Visible = True
  End With

End

'Masquage du Textbox Tbxrem
Public Function HideTextBox()

  With Utils
    Try Dssr[Dssr.row, 3].Text = Tbxrem2.Text
    Utils.db.Exec("Update " & Cbase.Table("TabCdocs") & " set doc2 = &3 where code = &1 AND doc = &2 ", Dssr[Dssr.row, 0].Text, Dssr[Dssr.row, 2].Text, Dssr[Dssr.row, 3].Text)
    Tbxrem2.Visible = False

  End With

End

Public Sub Tbxrem2_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    HideTextBox()
  Endif

End

Public Sub Tbxrem2_MouseDown()

  If Tbxrem2.Visible Then Tbxrem2.Visible = False

End

Public Sub Maj_Dssr()

  Dim rDoc As Result
  Dim Tag As String[]
  Dim n As Integer = 0

  Dssr.Rows.Count = 0
  Dssr.Refresh()
  Dssr.Columns.Count = 4
  Dssr.Columns[0].Width = 100
  Dssr.Columns[1].Width = 0
  Dssr.Columns[2].Width = 330
  Dssr.Columns[3].Width = 330
  Dssr.Columns[0].Text = "Code"
  Dssr.Columns[2].Text = "Nom du fichier"
  Dssr.Columns[3].Text = "Etiquettes"
  If Tous.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCdocs") & " where code = &1 order by doc", Cd.Text)
  If Facs.value Or Facs2.value Or Facs3.value Or Facs4.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCdocs") & " where code = &1 and org = &2 order by doc", Cd.Text, "Facs")
  If Docs.value Then rDoc = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCdocs") & " where code = &1 and org = &2 order by doc", Cd.Text, "Docs")
  If rDoc.Available Then
    n = 0
    tableau = New String[rDoc.Count, 4]
    Repeat
      Dssr.Rows.count = n + 1
      Tag = Split(rDoc!doc, "/")
      If Tous.Value Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs.value And Left$(Tag[Tag.count - 1]) = "F" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs2.Value And Left$(Tag[Tag.count - 1]) = "B" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs3.Value And Left$(Tag[Tag.count - 1]) = "C" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
      If Facs4.Value And Left$(Tag[Tag.count - 1]) = "D" Then
        Tableau[n, 0] = rDoc!code
        Tableau[n, 1] = rDoc!doc
        Tableau[n, 2] = Tag[Tag.count - 1]
        Tableau[n, 3] = rDoc!doc2
        Inc n
      Endif
    Until rDoc.MoveNext()
  Endif
Catch
  Print Error.Text

End

Private Function FileFilter(Optional All As Boolean = False) As String[]

  Dim filter As New String[]

  filter.Add("*.*")
  Return filter

End

Public Sub Button7_Click()

  Doc.Open("Tablesclients&fournisseurs")

End

Public Sub Inactif2_Click()

  Tri = "cli_code"
  Tris()
  sel = ""
  Deb2()

End

Public Sub Statut2_Click()

  Tri = "cli_code"
  Tris()
  sel = ""
  Deb2()

End

Public Sub Button9_Click()

  Dim hForm As Gged

  If Not IsNull(Cd.Text) Then
    hForm = New Gged("Client", "C", Cd.Text, "")
    hForm.Showmodal()
    Maj_Dssr()
  Else
    Message.Info("Veuillez saisir un produit avant de scaner SVP !")
  Endif

End

Public Sub Docs_Click()

  Maj_Dssr()

End

Public Sub Tous_Click()

  Maj_Dssr()

End

Public Sub Facs_Click()

  Maj_Dssr()

End

Public Sub Facs2_Click()

  Maj_Dssr()

End

Public Sub Facs3_Click()

  Maj_Dssr()

End

Public Sub Facs4_Click()

  Maj_Dssr()

End

Public Sub Etiquette_KeyPress()

  If Key.code = Key.Esc Or If Key.code = Key.Escape Then Panel1.Visible = False

End

Public Sub Button8_Click()

  Dim rDoc As Result
  Dim $NmFic As String = Start.LocalSettings["/Soc" & Start.Societe & "/Factchemin"] & "/Docs" & "/" & cd.Text & "/"
  Dim Fic As String
  Dim NmFic As String[]
  Dim ific As Integer

  Dialog.Filter = FileFilter(True)
  Dialog.Path = User.home
  Dialog.Title = "Choix d'un fichier"
  If Dialog.OpenFile() Then Return
  Fic = Dialog.Path
  NmFic = Split(Fic, "/")
  For ific = 0 To NmFic.Count - 1
    Fichier = NmFic[ific]
  Next
  If Not Exist($NmFic) Then Mkdir $NmFic
  Shell "cp " & Fic & " " & $NmFic Wait
  Fichier = $NmFic & Fichier
  rDoc = Utils.db.Exec("SELECT * from " & Cbase.Table("TabCdocs") & " where code = &1 AND doc = &2 ", Cd.Text, Fichier)
  If rDoc.Available Then
    Utils.db.Exec("Update " & Cbase.Table("TabCdocs") & " set doc = &2, doc2 = &3, org = &4 where code = &1 AND doc = &2 ", Cd.Text, Fichier, cd.text & "," & Etiquette.text, "Docs")
  Else
    Try Utils.db.Exec("insert into " & Cbase.Table("TabCdocs") & " (code,doc, doc2, org) values ( &1, &2, &3, &4)", Cd.Text, Fichier, cd.text & "," & Etiquette.text, "Docs")
  Endif
  Maj_Dssr()
  Panel1.visible = False
Catch
  Message.Warning(ERROR.Text)

End

Public Sub Button20_Click()

  Dim $hform As Form
  Dim hcol As ColumnView
  Dim rResult As Result
  Dim Tab As String

  $hForm = New Form As "Form"
  $hform.Width = 800
  $hform.Height = 400
  $hForm.Border = Border.Etched
  $hform.Title = "Liste des documents en cours"
  hcol = New ColumnView($hForm)
  hcol.Width = $hform.Width
  hcol.Height = $hform.Height
  hcol.Font = Font["Serif, -1"]
  hcol.Y = 0
  hcol.x = 0
  hcol.Columns.count = 5
  hcol.Columns[0].Width = 65
  hcol.Columns[1].Width = 80
  hcol.Columns[2].Width = 340
  hcol.Columns[3].Width = 160
  hcol.Columns[4].Width = 160
  hcol.Columns[0].Text = "Type"
  hcol.Columns[1].Text = "Num doc"
  hcol.Columns[2].Text = "Intitulé"
  hcol.Columns[3].Text = "Montant HT"
  hcol.Columns[4].Text = "Montant TTC"
  rResult = Utils.db.Exec("SELECT * FROM Fiches_Bl WHERE  cdclibl = &1 and imp = &2 ORDER BY numbl", Cd.Text, 0)
  If rResult.Available Then
    Repeat
      hcol.add(rResult!numbl, rResult!numbl)
      hcol.Item[0] = rResult!type
      hcol.Item[1] = rResult!numbl
      hcol.Item[2] = rResult!nmclibl
      hcol.Item[3] = rResult!totalht
      hcol.Item[4] = rResult!totalttc
    Until rResult.MoveNext()
  Endif
  $hform.show

End

Public Sub Button21_Click()

  Dim hForm2 As Extrait
  Dim Org As String = "S"

  hForm2 = New Extrait(Cd.text, "", "C", Org)
  hForm2.Showmodal()

End

Public Sub Button22_Click()

  Variables.OrgTarCli = "Cli"
  Variables.$Codeclient = Cd.Text
  TarCli.Show()

End

Public Sub Button23_Click()

  Dim Tcli As String = Left$(Typec.Text, 2)

  Variables.OrgTarTypeCli = "Cli"
  Variables.$TarTypeCli = Tcli
  TarTypeCli.Show()

End

'***********Gestion des codes régions pour la TIPP si option produits pétroliers dans tabstrip 0 ****************

Public Sub Buttr1_Click()

  Dim tipp As Rechtipp
  
  tipp = New Rechtipp("N") As "Buttr1"
  tipp.ShowModal
End

Public Sub Buttr1_trouve(cltip As String)

  Texttr1.Text = cltip

End

'*********************Gestion des tournées dans tabstrip 0******************************************************
Public Sub Butto1_Click()

  Dim tour As Rechtour
  
  tour = New Rechtour As "Butto1"
  tour.ShowModal

End

Public Sub butto1_trouve(cltou As String)

  Textto1.Text = cltou

End

'****************************************Gestion du tabstrip 1************************
Public Sub Cmpt2_LostFocus()

  If Last = Textfrais Then
    If Not IsNull(Textfrais.Text) Then
      Textfrais.Text = Replace(Textfrais.Text, ".", ",")
      If IsNumber(Textfrais.Text) Then
        Textfrais.Alignment = Align.Right
        Textfrais.Text = Format(Replace(Textfrais.Text, ",", "."), "0.00")
      Else
        Textfrais.Clear
     Endif
    Endif
  Endif
End
'**************************************Gestion tabstrip 5 *********************************
'*****************************code région  pour la TIPP si option produits pétroliers *******************

Public Sub Buttr2_Click()

    Dim tipp As Rechtipp
  
  tipp = New Rechtipp("N") As "Buttr2"
  tipp.ShowModal
End

Public Sub Buttr2_trouve(cltip As String)

  Texttr2.Text = cltip

End

'*********************Gestion des tournées *******************************
Public Sub Butto2_Click()

  Dim tour As Rechtour
  
  tour = New Rechtour As "Butto2"
  tour.ShowModal

End

Public Sub butto2_trouve(cltou As String)

  Textto2.Text = cltou

End


Public Sub Button24_Click()

  Dim $lcom As Listecom

  Try $lcom.Close
  $lcom = New Listecom(Cd.Text, "")
  $lcom.Y = Screen.AvailableHeight - 100
  $lcom.Show

End
