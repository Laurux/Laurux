' Gambas class file

'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publié par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Commande.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 10/10/2005
'# Commande fournisseur
'################################################
'

'DB As New Connection
B As Integer ' flag pour gestion du champ
Nlg As Integer ' Flag pour gestion des modifs
Tab As String
Tab2 As String
Decm As String ' nombre de décimales pour les quantités
Stocke As Boolean ' Si article est stocké?
montante As String ' Flag de controle si modif du prix
montantr As String
Txtva As String
Pmp As String
Dpa As String
Txconv As Float ' Taux de conversion
Dfour As String
Filename As String
sel As String
Dne As String 'texte recherché par F2 ou clic sur bouton
nbd As String
nbdec As String ' nombre de décimales pour les prix
Nlgn As String ' numero de ligne
Nl As String ' numero de ligne rappelée
Ectx As Boolean ' Si gestion de l'eco-taxe
Cpp As Boolean ' Si gestion de la copie privee
Cop As String ' montant copie privée
Ect As String ' montant eco-taxe
Modif As String ' Flag pour savoir si la ligne est en modification
NlgModif As String ' Flag pour réuperer le numéro de ligne modifiée
Nouveau As Boolean = True 'Flag pour savoir si on est en création ou en modification
Margem As String
Margep As String
Public hForm As FCalc
ref_four As String
ref_centrale As String
pdx As String
Mcom As String
Barcode As String
Pays As String
Tri As String = "art_code"
CoulTc As Integer ' Variable pour la couleur originale du montant de commande
Bpa As Boolean = False
bCentrale As Boolean = False
sCentrale As String 'Reference centrale du produit
sCentraleF As String 'code centrale du fournisseur
Email As String
Piece As String
Private ComCli As Float
Private Posy As Integer
Private Org As String = ""
Private Cpt As Integer = 0
Private Cpt2 As Integer = 0
Private idate As Integer = Val(Format$(Now, "mm"))
Private icpt As String
Private hfil As File
Private Hnew As File
Private pdf As Cdocuments
Private Pttc As String = "0" 'total ttc du document
Private Ppattc As String = "0" 'total ttc du produit
Private son As Integer = Start.Son
Private $soption As String
Private $textpal As TextBox
Private $textcol As TextBox
Private $checcons As CheckBox
Private $inbot As Integer
Private $incol As Integer
Private $o As Integer

Public Sub _New()

  CoulTc = Tcom.Background
  Music.Load(Start.Musique)
  Me.center
  If Start.LocalSettings["/Soc" & Start.Societe & "/Poids"] Then
    TextLabel29.Visible = True
    Pcom.Visible = True
    TextLabel30.Visible = True
    Pdprod.Visible = True
  Endif

  Utils.Observers(Me)
  $o = 0
  $soption = utils.Option()
  If $soption = "B" Or $soption = "T" Then 
    modifecran
    $o = 2
  Endif
  b = 0
  Nlg = 1
  Dne = ""
  Totalrcpt.Text = "0,00"
  Tfrais.Text = "0,00"
  Pcom.text = "0,000"
  Balloon.delay = 1000
  LstFour.Columns.count = 2
  LstFour.Columns[0].Width = 80
  LstFour.Columns[1].Width = 180
  Colrcp.Columns.count = 16
  Colrcp.Columns[8].Alignment = 2
  Colrcp.Columns[0].Text = "Nlgn"
  Colrcp.Columns[1].Text = "Code"
  Colrcp.Columns[2].Text = "Désignation"
  Colrcp.Columns[3].Text = "PB ht"
  Colrcp.Columns[3].Alignment = 2
  Colrcp.Columns[4].Text = "Remise"
  Colrcp.Columns[4].Alignment = 2
  Colrcp.Columns[5].Text = "PA ht"
  Colrcp.Columns[5].Alignment = 2
  If $soption = "B" Or $soption = "T" Then
    Colrcp.Columns[6].Text = "Pal."
    Colrcp.Columns[6].Alignment = 2
    Colrcp.Columns[7].Text = "Colis"
    Colrcp.Columns[7].Alignment = 2
  Endif
  Colrcp.Columns[6 + $o].Text = "Qté"
  Colrcp.Columns[6 + $o].Alignment = 2
  Colrcp.Columns[7 + $o].Text = "Total ht"
  Colrcp.Columns[7 + $o].Alignment = 2
  Colrcp.Columns[8 + $o].Text = "Code barre"
  lcolrcp()
  Nlgn = "0000"
  If Start.LocalSettings["/Soc" & Start.Societe & "/Coef"] Then
    Coef.Visible = True
    TMQ.Visible = False
    TextLabel18.Text = "Coef"
  Else
    Coef.Visible = False
    TMQ.Visible = True
    TextLabel18.Text = "Tmq"
  Endif
  TextLabel12.Text = Start.LocalSettings["/Soc" & Start.Societe & "/Taxe"]
  Four.SetFocus

End

Public Sub form_close()

  If Colrcp.Count Then
    Enrgcom()
    If b = 1 Then
      four.SetFocus
      four.Select
      Stop Event
    Endif
  Else
    If Ncom.Text <> Null Then DocActif.Free_Lock("CommandeF", ncom.Text)
  Endif

End

Public Sub lcolrcp()

  Dim WidthCol As String
  Dim s As String
  Dim spl As New String[10]

  Try WidthCol = Start.LocalSettings["/Soc" & Start.Societe & "/Col/LcolC"]
  If Not IsNull(WidthCol) Then
    WidthCol = Trim(WidthCol)
    If Right(WidthCol, 1) = ";" Then WidthCol = Left(WidthCol, Len(WidthCol) - 1)
    For Each s In Split(LCase(WidthCol), ";")
      spl = Scan(s, "*:*")
      Select Case Trim(spl[0])
        Case "col0"
          Try Colrcp.Columns[0].Width = spl[1]
        Case "col1"
          Try Colrcp.Columns[1].Width = Val(spl[1])
        Case "col2"
          Try Colrcp.Columns[2].Width = spl[1]
        Case "col3"
          Try Colrcp.Columns[3].Width = spl[1]
        Case "col4"
          Try Colrcp.Columns[4].Width = spl[1]
        Case "col5"
          Try Colrcp.Columns[5].Width = spl[1]
        Case "col6"
          Try Colrcp.Columns[6 + $o].Width = spl[1]
        Case "col7"
          Try Colrcp.Columns[7 + $o].Width = spl[1]
        Case "col8"
          Try Colrcp.Columns[8 + $o].Width = spl[1]
      End Select
    Next
  Else
    Colrcp.Columns[0].Width = 40
    Colrcp.Columns[1].Width = 140
    Colrcp.Columns[2].Width = 200
    Colrcp.Columns[3].Width = 100
    Colrcp.Columns[4].Width = 76
    Colrcp.Columns[5].Width = 100
    If $soption = "B" Or $soption = "T" Then
      Colrcp.Columns[6].Width = 40
      Colrcp.Columns[7].Width = 50
    Endif
    Colrcp.Columns[6 + $o].Width = 60
    Colrcp.Columns[7 + $o].Width = 100
    Colrcp.Columns[8 + $o].Width = 30
  Endif

End

'**********************************************************
'*        On remet a blanc les zones de saisies           *
'**********************************************************
Public Sub CleanChamps()

  Cart.Clear
  Dart.Clear
  Refourn.Clear
  Artstock.Clear
  Txcnv.clear
  qtecom.Clear
  If $soption = "B" Or $soption = "T" Then
    $textcol.Clear
    $textpal.Clear
  Endif
  pbht.Clear
  Tva.Clear
  Tr.Clear
  Rem1.text = "0,00"
  Rem2.text = "0,00"
  Rem3.text = "0,00"
  Panel6.visible = False
  paht.Clear
  Frais.Clear
  Prvt.Clear
  Artcom.Clear
  Totht.Clear
  Tva.Clear
  Coef.Clear
  Tmq.Clear
  Artstockmax.clear
  arr.Text = "0,01"
  Pvht.Clear
  Pvttc.Clear
  Pauv.Clear
  Tx1.Clear
  Tx1.Visible = False
  Tx2.Clear
  Tx2.visible = False
  Choix1.visible = False
  Choix1.Clear
  Pdprod.Clear
  Colhisto.Clear
  Artcom.Background = &H00FFFFFF&
  Artstock.Background = &H00FFFFFF&
  Comcli = 0

End

'******************************************************************
'*        On remet a blanc toute les zones de la commande         *
'******************************************************************
Public Sub RazBl()

  CleanChamps()
  Ncom.Clear
  datej.Clear
  Colrcp.Clear
  Minimum.Text = ""
  Franco.Text = ""
  Totalrcpt.Text = ""
  Tfrais.Text = ""
  Tcom.Text = ""
  Pcom.Text = ""
  Nmfour.Clear
  Nlgn = 0

End

Public Sub Cart_LF()

  If Cart.Text = "" Then
    If Start.son Then
      Music.Play
    Endif
    Message.Warning("Veuillez saisir un article SVP")
    Cart.SetFocus
    Cart.Select
    b = 1
  Else
    If datej.Text = "" Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning(" Veuillez saisir une date SVP ! ")
      Cart.Text = ""
      datej.Text = Format$(Now, "dd.mm.yyyy")
      datej.SetFocus
      datej.select
      b = 1
    Else
      If four.Text = "" Then
        If Start.son Then
          Music.Play
        Endif
        Message.Warning(" Veuillez saisir un code fournisseur SVP ! ")
        Cart.Text = ""
        four.SetFocus
        four.select
        b = 1
      Else
        If Ncom.Text = "" Then
          If Start.son Then
            Music.Play
          Endif
          Message.Warning(" Veuillez saisir un numéro de commande SVP ! ")
          Cart.Text = ""
          Ncom.SetFocus
          Ncom.select
          b = 1
        Else
          b = 0
          If Left$(Cart.Text) = "*" Then
            Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
            Cart.Text = Utils.Find_cbarre(Cart.Text)
          Endif
          art_Man()
        Endif
      Endif
    Endif
  Endif

End

'**********************************************************
'*      Gestion des touches sur le panel Entete           *
'**********************************************************
Public Sub Rcpt_KeyPress()

  If key.Code = key.F4 Then
    Select Case Last.tag
      Case 1
        FFournisseur.ShowModal()
      Case 4
        Articles.ShowModal()
    End Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
      Case 1
        If Left$(four.text, 1) <> "*" Then
          fourman()
        Else
          If Len(Four.Text) = 14 And Mid$(Four.Text, 2, 6) = "299999" Then
            Four.Text = Mid$(Four.Text, 8, 6)
          Else
            If Len(Four.text) <= 7 Then
              Four.Text = Mid$(Four.Text, 2, Len(Four.Text) - 1)
            Else
              Four.Text = Utils.Find_cbarre(Mid$(Four.Text, 2, Len(Four.Text) - 1))
            Endif
          Endif
          fourman()
        Endif
        If b = 1 Then
          four.SetFocus
          four.select
          Stop Event
        Else
          b = 0
          datej.Text = Format$(Now, "dd.mm.yyyy")
          If IsNull(Ncom.Text) Then
            Ncom.SetFocus
            Ncom.Select
          Else
            Cart.SetFocus
            Cart.Select
          Endif
        Endif
        Stop Event

      Case 2
        If four.Text = "" Then
          If Start.son Then
            Music.Play
          Endif
          Message.Warning(" Veuillez saisir un code fournisseur SVP ! ")
          four.SetFocus
          four.select
        Else
          If Ncom.Text = "" Then
            If Start.son Then
              Music.Play
            Endif
            Message.Warning(" Veuillez saisir un numéro de commande SVP ! ")
            Ncom.SetFocus
            Ncom.select
          Else
            Verifbl()
            If B = 1 Then
              b = 0
              Ncom.SetFocus
              Ncom.select
            Else
              datej.Text = Format$(Now, "dd.mm.yyyy")
              datej.SetFocus
              datej.Select
            Endif
          Endif
        Endif
        Stop Event

      Case 3
        Quittedate()
        If Left$(datej.Text, 5) = "00.00" Then
          datej.Text = Format$(Now, "dd.mm.yyyy")
          datej.SetFocus
          datej.Select
        Else
          Cart.SetFocus
          Cart.Select
        Endif
        Stop Event

      Case 4
        Cart_LF()
        If b = 0 Then
          If $soption = "B" Or $soption = "T" Then
            If $inbot = 0 And $incol = 0 Then
              qtecom.SetFocus
              qtecom.Select
            Endif
            If $inbot <> 0 Then
              $textcol.SetFocus
              $textcol.Select
            Endif
            If $incol <> 0 Then
              $textpal.SetFocus
              $textpal.Select
            Endif
          Else
            qtecom.SetFocus
            qtecom.Select
          Endif
        Endif
        Stop Event

      Case 5
        If Dart.Text = "" Then
          If Start.son Then
            Music.Play
          Endif
          Message.Warning("Veuillez saisir une désignation SVP")
          Dart.SetFocus
          Dart.Select
          b = 1
        Else
          qtecom.SetFocus
          qtecom.Select
          b = 0
        Endif
        Stop Event

      Case 6
        qtecom_LF()
        If Val(paht.Text) = 0 Or ($soption = "P" Or $soption = "T") Then
          If b <> 1 Then
            'pbhtlf()
            pbht.SetFocus
            pbht.Select
            b = 0
          Else
            qtecom.SetFocus
            qtecom.Select
            B = 0
          Endif
        Else
          If stocke Then
            If Not IsNull(Mcom) And If Val(Mcom) > 0 Then
              If Val(qtecom.text) < Val(Mcom) Then
                Balloon.Warning(("Le minimum de commande pour ce produit est de  " & Mcom), Pdprod)
                qtecom.SetFocus
                qtecom.Select
              Else
                Panel6.visible = False
                Button1.SetFocus
              Endif
            Else
              Panel6.visible = False
              Button1.SetFocus
            Endif
          Else
            Button1.SetFocus
          Endif
        Endif
        Stop Event

      Case 7
        pbhtLF()
        If b <> 1 Then
          If pbht.Text = montante Then
            Button1.SetFocus
          Else
            TrC()
            'pahtLF()
            Tr.SetFocus
            Tr.Select
            b = 0
          Endif
        Else
          pbht.SetFocus
          pbht.Select
          b = 0
        Endif
        Stop Event

      Case 8
        TrC()
        If b <> 1 Then
          pahtGF()
          pahtLF()
          Coeff()
          If Val(Utils.cpoint(paht.Text)) > 0 Then
            Panel6.Visible = True
            Rem1.SetFocus
            Rem1.Select
          Else
            paht.SetFocus
            paht.Select
          Endif
        Else
          Tr.SetFocus
          Tr.Select
          B = 0
        Endif
        Stop Event

      Case 9
        pahtLF()
        If b <> 1 Then
          Coeff()
          Button1.SetFocus
        Else
          paht.SetFocus
          paht.Select
          B = 0
        Endif
        Stop Event

      Case 10
        FraisLF()
        If b <> 1 Then
          Coef.SetFocus
          Coef.Select
        Else
          Frais.SetFocus
          Frais.Select
        Endif
        b = 0
        Stop Event

      Case 11
        If Start.LocalSettings["/Soc" & Start.Societe & "/Coef"] Then
          Coeff()
          If b <> 1 Then
            Calc_Marge()
            Pvht.SetFocus
            Pvht.Select
          Else
            Coef.SetFocus
            Coef.Select
          Endif
        Else
          Pourcent()
          If b = 1 Then
            Tmq.SetFocus
            Tmq.Select
          Else
            Calc_coeff()
            Pvht.Text = Format$(Val(prvt.Text) * Val(Coef.Text), nbdec)
            Tva_calcul()
            Arrondi()
            Calc_Marge()
            Pvht.SetFocus
            Pvht.Select
          Endif
        Endif
        b = 0
        Stop Event

      Case 12
        PvhtLF()
        If b <> 1 Then
          Arrondi()
          Pvttc.SetFocus
          Pvttc.Select
          b = 0
          Calc_Marge()
        Else
          Pvht.SetFocus
          Pvht.Select
        Endif
        Stop Event

      Case 13
        Arrondi()
        Stop Event

      Case 14
        PvttcLF()
        If b <> 1 Then
          Button1.SetFocus
          b = 0
          Calc_Marge()
        Else
          Pvttc.SetFocus
          Pvttc.Select
          b = 0
        Endif
        Stop Event
        
      Case 15
        If $incol <> 0 Then
          If IsNumber($textpal.Text) Then
            $textcol.Text = Format(Val($textpal.Text) * $incol, "0")
            $incol = 0
          Else
            $textpal.Clear
          Endif
        Endif
        $textcol.SetFocus
        $textcol.Select
        Stop Event
        
      Case 16
        If $inbot <> 0 Then
          If IsNumber($textcol.Text) Then
            qtecom.Text = Format(Val($textcol.Text) * $inbot, "0")
            $inbot = 0
          Else
            $textcol.Clear
          Endif
        Endif
        qtecom.SetFocus
        qtecom.Select
        Stop Event
        
    End Select
  Else
    Select Case Last.Tag
      Case 23
        ChkInput()
    End Select
  Endif

  If key.code = key.F1 Then
    Button4_Click()
    Stop Event
  Endif

  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        ToggleButton1_Click
      Case 4
        If Cart.Text = "" Then
          ToggleButton2_Click
        Else
          If datej.Text = "" Then
            If Start.son Then
              Music.Play
            Endif
            Message.Warning(" Veuillez saisir une date SVP ! ")
            Cart.Text = ""
            datej.Text = Format$(Now, "dd.mm.yyyy")
            datej.SetFocus
            datej.select
          Else
            If four.Text = "" Then
              If Start.son Then
                Music.Play
              Endif
              Message.Warning(" Veuillez saisir un code fournisseur SVP ! ")
              Cart.Text = ""
              four.SetFocus
              four.select
            Else
              If Ncom.Text = "" Then
                If Start.son Then
                  Music.Play
                Endif
                Message.Warning(" Veuillez saisir un numéro de commande SVP ! ")
                Cart.Text = ""
                Ncom.SetFocus
                Ncom.select
              Else
                If Left$(Cart.Text) = "*" Then
                  Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
                  Cart.Text = Utils.Find_cbarre(Cart.Text)
                Endif
                sel = Dart.Text
                ToggleButton2_Click
              Endif
            Endif
          Endif
        Endif
    End Select
  Endif

  If Key.code = Key.F3 Then
    Select Case Last.tag

      Case 5
        SelectionArt()
        Stop Event
    End Select
  Endif

  If Key.code = Key.F5 Then
    hForm = New FCalc
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then Last.Text = Format$(Val(FCalc.Resultat), "0.000")
  Endif

End

Public Sub ChkInput()

  If InStr("-;'&_\"*", Key.Text) <> 0 Then
    Stop Event
  Endif

End

Public Sub Rcpt_click()

  Select Case Last.tag

    Case 13
      arrondi()
      PvTTcLF()
      Stop Event
  End Select

End

Public Sub Rcpt_Lostfocus()

  Select Case Last.tag
    Case 2
      Datej.Text = Format$(Now, "dd.mm.yyyy")
      Stop Event
  End Select

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Rcpt_GotFocus()

  Dim b As Integer

  With Utils
    '  .SetEditColor(ME, LAST)
    Select Case Last.tag
      Case 4
        b = 0

        'CASE 6
        'IF NOT IsNull(Mcom) AND IF Mcom <> "0" THEN Balloon.Warning(("Ce produit est a commander par " & Mcom), Pdprod)
        'STOP EVENT

      Case 7
        pbhtGF()
        Stop Event

      Case 9
        pahtGF()
        Stop Event

      Case 12
        If b = 0 Then
          Calc_Marge()
          Balloon.Warning(("Marge en montant = " & margem & "\n" & "Marge en % = " & margep), Pvht)
          Pvht.SetFocus
          Pvht.select
        Else
          b = 0
        Endif
        Stop Event

    End Select
  End With

End

'*****************************************************
'*      Gestion des touches sur les boutons          *
'*****************************************************
Public Sub Btn_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Then

    Select Case Last.tag

      Case 1
        If Cart.Text <> "" Then
          qtecom_LF()
          'pbhtLF()
          Maj_colrcp()
          CleanChamps()
          Cart.SetFocus
          Cart.Select
          modif = "0"
        Else
          CleanChamps()
        Endif
        If b = 1 Then
          Cart.SetFocus
          Cart.Select
        Else
          b = 0
        Endif
        Stop Event

    End Select
  Endif

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      If Cart.Text <> "" Then
        qtecom_LF()
        'pbhtLF()
        Maj_colrcp()
        CleanChamps()
        Cart.SetFocus
        Cart.Select
        modif = "0"
      Else
        CleanChamps()
      Endif
      If b = 1 Then
        Cart.SetFocus
        Cart.Select
      Else
        b = 0
      Endif
      Stop Event

    Case 2
      Panel7.Visible = False
      Impcom("M")
      Enrgcom()
      If b = 1 Then
        four.SetFocus
        four.Select
      Else
        Ncom.SetFocus
        ncom.Select
        B = 0
      Endif
      Stop Event

    Case 3
      If Colrcp.count = 0 Then b = 0
      If b <> 1 Then
        If Exist(filename) Then Try Kill filename
        Start.LocalSettings["/Soc" & Start.Societe & "/Col/LcolC"] = "col0:" & Colrcp.Columns[0].Width & ";" & "col1:" & Colrcp.Columns[1].Width & ";" & "col2:" & Colrcp.Columns[2].Width & ";" & "col3:" & Colrcp.Columns[3].Width & ";" & "col4:" & Colrcp.Columns[4].Width & ";" & "col5:" & Colrcp.Columns[5].Width & ";" & "col6:" & Colrcp.Columns[6].Width & ";" & "col7:" & Colrcp.Columns[7].Width & ";" & "col8:" & Colrcp.Columns[8].Width
        Start.LocalSettings.Save
        Me.Close
      Endif
      Stop Event

    Case 5
      Panel7.Visible = False
      If Message.question("Attention, êtes-vous sur de vouloir supprimer cette commande !", "Oui", "Non") = 1 Then
        Delcom()
        four.SetFocus
        four.Select
      Endif
      Stop Event

    Case 6
      If Panel7.Visible = False Then
        Org = ""
        Panel7.Visible = True
        Label2.Text = " Impression de commande"
        Button14.text = "Imprimer"
        Combobox1.Clear
        Combobox1.visible = False
      Else
        Panel7.Visible = False
        ComboBox1.Clear
      Endif
      Stop Event

    Case 7
      Panel7.Visible = False
      Genc()
      If b = 1 Then
        Cart.SetFocus
        Cart.Select
      Else
        b = 0
      Endif
      Stop Event

    Case 8
      If Colcom.Visible = True Then Colcom.Visible = False
      Button8_Click()

    Case 10
      Panel7.Visible = False
      If Not CheckBox1.value Then
        If Org = "" Then
          Impcom("")
          four.SetFocus
          four.Select
        Else
          Mail()
        Endif
      Else
        GenFic()
      Endif
      Stop Event
  End Select

End

'**********************************************************
'*       Gestion du click sur bouton "Nouveau"            *
'**********************************************************
Public Sub Button8_Click()

  Dim rBon As Result
  Dim Tab1 As String

  If Colrcp.Count Then
    Enrgcom()
  Endif
  RazBl()
  Tab = "Fiches_Parametres"
  Tab1 = "Fiches_Entcom"
  rBon = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rBon.Available Then
    ncom.Text = rBon!dncom
  Endif
  If ncom.Text = "" Then ncom.Text = "000000"
  ncom.Text = Val(ncom.Text) + 1
  ncom.Text = Format$(ncom.Text, "00000")
  Datej.Text = Format$(Now, "dd.mm.yyyy")
  rBon = Utils.db.Exec("SELECT * FROM " & Tab1 & " where numcom = &1", ncom.text)
  If rBon.Available Then
    Message.Warning("Création impossible ce numéro de commande est déjà attribué")
    ncom.text = ""
  Else
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dncom = &1", ncom.Text)
    DocActif.Get_Lock("CommandeF", ncom.Text)
    If IsNull(Four.text) Then
      Four.SetFocus
      Four.Select
    Else
      Cart.SetFocus
      Cart.Select
    Endif
  Endif

End

'************************************************
'*    On appelle la liste des taxes a saisir    *
'************************************************
Public Sub ToggleButton4_Click()

  If Tx1.Visible = True Then
    Tx1LF()
    Tx1.Visible = False
  Else
    If Tx2.visible = True Then
      Tx2LF()
      Tx2.visible = False
    Else
      If Choix1.Visible = True Then
        Choix1.Clear
        Choix1.Visible = False
      Else
        If Ectx = True Then Choix1.Add("Eco-taxe")
        If Cpp = True Then Choix1.Add("Copie privée")
        Choix1.Visible = True
        Choix1.Raise
      Endif
    Endif
  Endif

End

'********************************
'*    On sélectionne la taxe    *
'********************************
Public Sub Choix1_Click()

  If Choix1.Text = "Eco-taxe" Then
    Tx1.Visible = True
    Tx1.Text = Ect
    Tx1.SetFocus
    Tx1.Select
  Else
    If Choix1.Text = "Copie privée" Then
      Tx2.visible = True
      Tx2.Text = Cop
      Tx2.SetFocus
      Tx2.Select
    Endif
  Endif
  Choix1.visible = False
  Choix1.Clear

End

'********************************
'*    Controle  de l'eco-taxe   *
'********************************
Public Sub Tx1LF()

  With Utils
    If Not IsNull(Cart.Text) Then
      If IsNull(Tx1.Text) Then Tx1.Text = "0,00"
      If Val(.cpoint(Tx1.Text)) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie de l'eco-taxe SVP !")
        Tx1.SetFocus
        Tx1.Select
      Else
        Tx1.Text = Format$(Val(.cpoint(Tx1.Text)), "0.00")
        If Ect <> Tx1.Text Then
          If message.Question(" Vous venez de modifier l'eco-taxe. Voulez-vous ? \n 1- Modifier la fiche produit ", " Oui ", " Non ") = "1" Then
            Ect = Val(Tx1.text)
            Cop = Val(Cop)
            Maj_Tabart()
          Endif
        Endif
      Endif
    Endif
  End With

End

'*************************************
'*    Controle  de la copie privée   *
'*************************************
Public Sub Tx2LF()

  With Utils
    If Not IsNull(Cart.Text) Then
      If IsNull(Tx2.Text) Then Tx2.Text = "0,00"
      If Val(.cpoint(Tx2.Text)) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie de la copie privée SVP !")
        Tx2.SetFocus
        Tx2.Select
      Else
        Tx2.Text = Format$(Val(.cpoint(Tx2.Text)), "0.00")
        If Cop <> Tx2.Text Then
          If message.Question(" Vous venez de modifier la copie privée. Voulez-vous ? \n 1- Modifier la fiche produit ", " Oui ", " Non ") = "1" Then
            Cop = Val(Tx2.text)
            Ect = Val(Ect)
            Maj_Tabart()
          Endif
        Endif
      Endif
    Endif
  End With

End

'*************************************
'*  On met a jour la base si modif   *
'*************************************
Public Sub Maj_Tabart()

  Dim Rprod As Result

  Tab = "Fiches_Art"
  Rprod = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Cart.Text)
  If Rprod.Available Then
    Utils.db.Exec("UPdate  " & Tab & "  SET  art_eco = &2, art_copp = &3 where art_code = &1", Cart.Text, Ect, Cop)
  Endif

End

'************************************************
'* On appelle la liste des fournisseurs         *
'************************************************
Public Sub ToggleButton1_Click()

  If Choix.Visible = True Then
    Choix.Visible = False
    Choix.clear
  Else
    Choix.clear
    Choix.Add("1- Choisir un fournisseur", 0)
    Choix.Add("2- Liste des fournisseurs a commander", 1)
    Choix.Visible = True
    Choix.Raise
  Endif
  If LstFour.visible = True Then LstFour.visible = False

End

Public Sub Choix_Click()

  If Choix.index = "0" Then
    'si choix d'un fournisseur
    ChoixFour()
  Else
    If Choix.Index = "1" Then
      'si liste des fournisseurs utilisés
      Me.Mouse = Mouse.Wait
      ListFour()
    Endif
  Endif
  Choix.Visible = False
  Choix.clear

End

Public Sub ChoixFour()

  Dim MyForm As Trifours

  Variables.bsel = False
  MyForm = New Trifours("Commande")
  MyForm.Showmodal()
  If Variables.Bsel = True Then
    Four.Text = Variables.Cfour
  Else
    Four.SetFocus
  Endif
  Fourman()
  Ncom.SetFocus
  Ncom.Select

End

'********************************************
'* Saisie d'un fournisseur manuellement     *
'********************************************
Public Sub fourman()

  Dim Rfours As Result
  Dim MinCom, Francop As Integer

  With Utils
    sCentraleF = ""
    Tab = "Fiches_Four"
    Rfours = Utils.db.Exec("SELECT * FROM " & tab & " WHERE fo_code = &1", four.Text)
    fournom.Text = Rfours!fo_nom
    Email = Rfours!fo_email
    If Rfours!fo_centrale Then scentraleF = Four.Text
    Try Franco.text = Format$(Rfours!fo_franco, "0.00")
    Try Minimum.text = Format$(Rfours!fo_mincom, "0.00")
    If Not Franco.text Then Franco.Text = "0,00"
    Try MinCom = Round(Val(.cpoint(Rfours!fo_mincom)))
    If Error Then MinCom = "0"
    Try FrancoP = Round(Val(.cpoint(Rfours!fo_franco)))
    If Error Then FrancoP = "0"
    If Mincom > 0 And Francop = 0 Then
      Syntheses.Message("Le minimum de commande pour ce fournisseur est de " & Format$(Rfours!fo_mincom, " 00 ") & " Euros.")
    Else
      If MinCom = 0 And Francop > 0 Then
        Syntheses.Message("Le franco de port pour ce fournisseur est de " & Format$(Rfours!fo_franco, " 00 ") & " Euros.")
      Else
        If mincom > 0 And Francop > 0 Then
          Syntheses.Message("Le minimum de commande pour ce fournisseur est de " & Format$(Rfours!fo_mincom, " 00 ") & " Euros. Le franco est de " & Format$(Rfours!fo_franco, " 00 ") & " Euros.")
        Endif
      Endif
    Endif
    b = 0
    ncom.SetFocus
  End With
Catch
  B = 1
  If Start.son Then
    Music.Play
  Endif
  Message.Warning("Ce fournisseur n'existe pas !")

End

'************************************************
'* On verifie si la commande a deja ete saisie  *
'************************************************
Public Sub Verifbl()

  Dim Rentcom As Result

  Tab = "Fiches_Entcom"
  Rentcom = Utils.db.Exec("SELECT * FROM " & Tab & " where four = &1 and numcom = &2", four.Text, Ncom.Text)
  If Rentcom.Available Then
    B = 1
    If Start.son Then
      Music.Play
    Endif
    Message.Warning("Ce Bon de commande a deja ete saisit chez ce fournisseur")
  Else
    B = 0
  Endif

End

'********************************************************
'*  On controle si la date de la reception est bonne    *
'********************************************************
Public Sub Quittedate()

  With utils
    datej.text = .Cdate_calc(datej.Text)
    datej.Text = .Cdate_aff(datej.Text)
  End With

End

'************************************************
'*  On veut génerer une commande automatique    *
'************************************************
Public Sub Genc()

  If four.Text = "" Then
    If Start.son Then
      Music.Play
    Endif
    Message.Warning(" Veuillez saisir un code fournisseur SVP ! ")
    b = 1
    Cart.Text = ""
    four.SetFocus
    four.select
  Else
    If Ncom.Text = "" Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning(" Veuillez saisir un numéro de commande SVP ! ")
      b = 1
      Cart.Text = ""
      Ncom.SetFocus
      Ncom.select
    Else
      If datej.Text = "" Then
        If Start.son Then
          Music.Play
        Endif
        Message.Warning(" Veuillez saisir une date SVP ! ")
        b = 1
        Cart.Text = ""
        datej.Text = Format$(Now, "dd.mm.yyyy")
        datej.SetFocus
        datej.select
      Endif
    Endif
  Endif
  If Colrcp.count <> 0 Then
    If message.Question("Il y a des lignes en cours de saisie. Que voulez-vous faire ? \n1- Retourner en saisie \n2- Supprimer les lignes et génerer la commande. ", " 1 ", "2 ") = "1" Then
      b = 1
      Cart.SetFocus
      Cart.Select
    Else
      Colrcp.Clear
      b = 0
    Endif
  Endif
  If B <> 1 Then 
    Panel4.Visible = True
    Panel4.Raise
  Endif

End

Public Sub button11_Click()

  Panel4.Visible = False
  Gencom()

End

'Public Sub button12_Click()

'Panel4.Visible = False
'Gencomcli()

'End

Public Sub button15_Click()

  Panel4.Visible = False
  GencomRlq()

End

Public Sub button12_Click()

  Panel4.Visible = False
  LstFac()

End

Public Sub button16_Click()

  Panel4.Visible = False
  If message.Question("Attention ! Le fichier 'inventaire.txt' du portable doit être vidé dans le repertoire " & "~/Portable !") = 1 Then
    GencomPort()
  Endif

End

Public Sub button17_Click()

  Panel4.Visible = False

End

'***********************************************************
'*  On génere une commande automatique a partir du stock   *
'***********************************************************
Public Sub Gencom()

  Dim rarts As Result
  Dim Tab2 As String
  Dim Qtecom As Float
  Dim Decm As String
  Dim nbdec As String
  Dim Fourn As String
  Dim Stocke As Boolean = False

  Tab2 = "Rupture"
  b = 0
  Nlg = 1
  Totalrcpt.Text = "0,00"
  Tfrais.text = "0,00"
  frais.Text = "0,00"
  Pcom.text = "0,000"
  Crupt.Rupture("", "", Four.Text, Four.Text, "", "", "Commande")
  rarts = Utils.db.Exec("SELECT * FROM " & Tab2 & " left join " & Cbase.Table("TabArt") & " on art_code = codea order by codea")
  If rarts.Available Then
    fourn = rarts!four
    Repeat
      qtecom = 0
      stocke = rarts!art_stocke
      nbd = rarts!art_nbd
      nbdec = Utils.Find_nbdec(nbd)
      Nlgn = Format$(Colrcp.count + 1, "0000")
      If Not IsNull(rarts!qtecom) Then
        Qtecom = rarts!qtecom
      Else
        Qtecom = 0
      Endif
      If stocke And If Not IsNull(rarts!art_mincom) Then
        If qtecom < 0 Then qtecom = 0
        If qtecom > 0 Then
          If Val(Utils.cpoint(rarts!art_mincom)) > 0 And If qtecom < Val(Utils.cpoint(rarts!art_mincom)) Then Qtecom = Val(Utils.cpoint(rarts!art_mincom))
        Endif
      Endif
      If qtecom > 0 Then
        Try Colrcp.Add(rarts!art_code & Nlgn, rarts!art_code & Nlgn)
        If Nlg = 1 Then
          Colrcp.Item[0] = Nlgn
        Else
          Colrcp.Item[0] = "*" & Nl
        Endif
        If Refart.value = True Then
          Colrcp.Item[1] = rarts!art_code
          Colrcp.Item[15] = rarts!art_code
        Else
          If Reffour.Value = True Then
            If Not IsNull(rarts!art_cfour) Then
              Colrcp.Item[1] = rarts!art_cfour
            Else
              Colrcp.Item[1] = rarts!art_code
            Endif
            Colrcp.Item[15] = rarts!art_code
          Else
            If Refcentrale.Value = True Then
              If Not IsNull(rarts!art_refcentrale) Then
                Colrcp.Item[1] = rarts!art_refcentrale
              Else
                Colrcp.Item[1] = rarts!art_refcentrale
              Endif
              Colrcp.Item[15] = rarts!art_code
            Endif
          Endif
        Endif
        If Left$(rarts!art_code, 1) = "." Then
          Colrcp.Item[2] = rarts!intitulea
        Else
          Colrcp.Item[2] = rarts!art_design
        Endif
        If Len(Colrcp.Item[2]) - InStr(Colrcp.Item[2], ",") = 2 Then Colrcp.Item[2] &= " "
        Colrcp.Item[3] = Format$(rarts!art_pbht, Nbdec)
        If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
        Colrcp.Item[4] = Format$(rarts!art_tr, "0.00")
        Colrcp.Item[5] = Format$(rarts!art_pauaht, Nbdec)
        If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
        Colrcp.Item[6] = Utils.Cdec(Decm, Qtecom)
        Colrcp.Item[6] = Utils.cpoint(Colrcp.Item[6])
        Colrcp.Item[7] = Format$(Qtecom * rarts!art_pauaht, Nbdec)
        If Len(Colrcp.Item[7]) - InStr(Colrcp.Item[7], ",") = 2 Then Colrcp.Item[7] &= " "
        'Colrcp.Item[16] = Format$(Val(Colrcp.Item[7]) + (Val(Colrcp.Item[7]) * Val(Utils.cpoint(Txtva)) / 100), nbdec)
        Colrcp.Item[9] = Format$(rarts!art_prvt, Nbdec)
        Colrcp.Item[10] = Format$(rarts!art_frais, Nbdec)
        Colrcp.Item[8] = rarts!art_cbarre
        Txtva = CPrix.CTva(rarts!art_tva)
        Cart.text = rarts!art_code
        GestCoul(Cart.text)
        Colrcp.MoveFirst
        Totalrcpt.Text = "0,00"
        Tfrais.text = "0,00"
        Pcom.text = "0,000"
      Endif
    Until rarts.MoveNext()
    If Colrcp.count > 0 Then
      bas_doc()
    Else
      Message.Warning("Aucune ligne de commande n'est a génerer !")
    Endif
  Else
    message(" Aucun article pour cette demande", "OK")
  Endif
  Me.Mouse = Mouse.Pointing

End

' On recherche le nombre de produits dans les commandes clients.
Public Sub Artcom_MouseDown()

  Artcomm("")

End

Public Sub Artcomm(Org As String)

  Dim rblResult As Result
  Dim qtecli As Float = 0

  If Org <> "Reaff" Then
    rblResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigbl") & " left join " & Cbase.Table("TabBl") & "  on numbl = num_ligbl where code_ligbl = &1 and typel_ligbl = &2", Cart.Text, "A")
  Else
    rblResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigbl") & " left join " & Cbase.Table("TabBl") & "  on numbl = num_ligbl where code_ligbl = &1 and typel_ligbl = &2", Colrcp.Current[1], "A")
  Endif
  If rblResult.Available Then
    Repeat
      If Val(Utils.cpoint(rblResult!qte_ligbl)) > 0 And rblResult!type = "C" Then
        Qtecli = Qtecli + Val(Utils.cpoint(rblResult!qte_ligbl))
      Endif
    Until rblResult.MoveNext()
    If Not Org Then
      If Qtecli > 0 Then
        Message.Info("Il y a " & Qtecli & " produit(s) dans les commandes clients.")
      Else
        Message.Info("Il n'y a aucun produit dans les commandes clients.")
      Endif
    Endif
  Endif
  ComCli = Qtecli

End

'************************************************************
'*  On génere une commande a partir d'une facture client    *
'************************************************************
Public Sub Gencomcli()

  LstFac()

End

'********************************************
'* On appelle la liste des BL ou factures   *
'********************************************
Public Sub LstFac()

  Dim Rfacli As Result

  If Facts.visible Then
    Facts.clear
    Facts.visible = False
  Else
    Facts.visible = True
    Facts.Raise
    Facts.Columns.count = 7
    Facts.Columns[0].Width = 65
    Facts.Columns[0].Text = "Type"
    Facts.Columns[1].Width = 100
    Facts.Columns[1].Text = "Num BL"
    Facts.Columns[2].Width = 100
    Facts.Columns[2].Text = "Date"
    Facts.Columns[3].Width = 100
    Facts.Columns[3].Text = "Client"
    Facts.Columns[4].Width = 220
    Facts.Columns[4].Text = "Nom"
    Facts.Columns[5].Width = 180
    Facts.Columns[5].Text = "Prénom"
    Facts.Columns[6].Width = 180
    Facts.Columns[6].Text = "Num Facture"
    Rfacli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabBl") & " where type = &1 and totalht <> &3 or type = &2 and totalht <> &3 or type = &4 and totalht <> &3", "B", "F", 0, "D")
    If Rfacli.Available Then
      Do
        Facts.Add(Rfacli!numbl, Rfacli!numbl)
        Facts.Item[0] = Rfacli!type
        Facts.Item[1] = Rfacli!numbl
        Facts.Item[2] = Rfacli!datebl
        Facts.Item[3] = Rfacli!cdclibl
        Facts.Item[4] = Rfacli!nmclibl
        Facts.Item[5] = Rfacli!pnmclibl
        Facts.Item[6] = Rfacli!numfac
      Loop Until Rfacli.MoveNext()
      Facts.MoveFirst
      Facts.Item.Selected = True
    Endif
    Facts.SetFocus
  Endif

End

Public Sub Facts_KeyPress()

  If key.code = key.Esc Or If key.code = key.F2 Then
    Facts.clear
    Facts.visible = False
  Endif
  If key.code = key.Enter Or key.code = key.Return Then
    Gen_Comfac(Facts.Current[1])
  Endif

End

Public Sub Facts_Click()

  Gen_Comfac(Facts.Current[1])

End

Public Sub Gen_Comfac(Ligbl As String)

  Dim rfact As Result
  Dim rarts As Result
  Dim Qtecom As Float

  With Utils
    Nlg = 1
    rfact = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigbl") & " where num_ligbl = &1 and typel_ligbl = &2 order by num_ligbl", Ligbl, "A")
    If rfact.Available Then
      Repeat
        rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1 ", rfact!code_ligbl)
        If rarts.Available Then
          If rarts!art_suspendu <> "1" Then
            Nlgn = Format$(Colrcp.count + 1, "0000")
            If IsNull(Totalrcpt.Text) Then Totalrcpt.Text = "0,00"
            If IsNull(Tfrais.Text) Then Tfrais.Text = "0,00"
            If IsNull(Pcom.Text) Then Pcom.text = "0,000"
            Try Colrcp.Add(rarts!art_code, rarts!art_code)
            If Nlg = 1 Then
              Colrcp.Item[0] = Nlgn
            Else
              Colrcp.Item[0] = "*" & Nl
            Endif
            Nlg = 1
            nbd = rarts!art_nbd
            nbdec = Utils.Find_nbdec(nbd)
            Decm = rarts!art_dec
            If Refart.value = True Then
              Colrcp.Item[1] = rarts!art_code
            Else
              If Not IsNull(rarts!art_cfour) Then
                Colrcp.Item[1] = rarts!art_cfour
              Else
                Colrcp.Item[1] = rarts!art_code
              Endif
            Endif
            Colrcp.Item[2] = rarts!art_design
            If Len(Colrcp.Item[2]) - InStr(Colrcp.Item[2], ",") = 2 Then Colrcp.Item[2] &= " "
            Colrcp.Item[3] = Format$(rarts!art_pbht, Nbdec)
            If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
            Colrcp.Item[4] = Format$(rarts!art_tr, "0.00")
            Colrcp.Item[5] = Format$(rarts!art_pauaht, Nbdec)
            If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
            Qtecom = Val(.cpoint(rfact!qte_ligbl))
            If Qtecom <= 0 Then qtecom = 1
            If Not IsNull(rarts!art_mincom) Then
              If Val(.cpoint(rarts!art_mincom)) <> 0 And qtecom < Val(.cpoint(rarts!art_mincom)) Then Qtecom = Val(rarts!art_mincom)
            Endif
            Colrcp.Item[6] = .Cdec(Decm, Qtecom)
            Colrcp.Item[6] = .cpoint(Colrcp.Item[6])
            Colrcp.Item[7] = Format$(Qtecom * rarts!art_pauaht, Nbdec)
            Colrcp.Item[9] = Format$(rarts!art_prvt, Nbdec)
            Colrcp.Item[10] = Format$(rarts!art_frais, Nbdec)
            Colrcp.Item[8] = rarts!art_cbarre
            If Len(Colrcp.Item[7]) - InStr(Colrcp.Item[7], ",") = 2 Then Colrcp.Item[7] = Colrcp.Item[7] & " "
            Cart.text = rarts!art_code
            GestCoul(Cart.Text)
          Endif
        Endif
      Until rfact.MoveNext()
      Colrcp.MoveFirst
      Totalrcpt.Text = "0,00"
      Tfrais.text = "0,00"
      Pcom.text = "0,000"
      Do
        Try Colrcp.Item.Selected = True
        If Not Error Then
          Totalrcpt.Text = Format$(Val(Totalrcpt.Text) + (Val(.cpoint(Colrcp.Item[6])) * Val(.cpoint(Colrcp.Item[5]))), "0.00")
          Tfrais.Text = Format$(Val(.cpoint(Tfrais.Text)) + (Val(.cpoint(Colrcp.Item[10])) * Val(.cpoint(Colrcp.Item[6]))), "0.00")
        Endif
      Loop Until Colrcp.MoveNext()
    Else
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Aucune ligne de commande n'est a génerer")
    Endif
  End With
  Facts.clear
  Facts.visible = False

End

Public Sub GencomRlq()

  Dim rfact As Result
  Dim ArtResult As Result
  Dim LigResult As Result

  With Utils
    rfact = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabEntcom") & " where four = &1 and reliquat = &2 order by ddate", four.Text, 1)
    If rfact.Available Then
      Repeat
        Tab = "Fiches_Ligcom"
        LigResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigcom") & " WHERE numcom = &1 and four = &2 order by nligne", rfact!numcom, four.Text)
        If LigResult.Available Then
          Do
            Nlgn = Format$(Val(Nlgn) + 1, "0000")
            Try Colrcp.Add(LigResult!code, LigResult!code)
            If Error Then Colrcp.Add(LigResult!nligne, LigResult!nligne)
            Colrcp.Item[0] = Nlgn
            Colrcp.Item[1] = LigResult!code
            ArtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " WHERE art_code = &1", LigResult!code)
            If Not ArtResult.Available Then ArtResult = Utils.db.Exec("SELECT * FROM " & tab2 & " WHERE art_cfour = &1", LigResult!code)
            If Not ArtResult.Available Then ArtResult = Utils.db.Exec("SELECT * FROM " & tab2 & " WHERE art_refcentrale = &1", LigResult!code)
            nbdec = .Find_nbdec(ArtResult!art_nbd)
            Colrcp.Item[2] = LigResult!design
            Colrcp.Item[3] = Format$(Val(.cpoint(LigResult!pbht)), nbdec)
            If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
            Colrcp.Item[4] = LigResult!rm
            Colrcp.Item[5] = Format$(Val(.cpoint(LigResult!paht)), nbdec)
            If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
            Colrcp.Item[6] = LigResult!qte
            Try Colrcp.Item[14] = Format$(Val(LigResult!qte) * ArtResult!art_poids2, "0.000")
            Colrcp.Item[15] = LigResult!coda
            Colrcp.Item[7] = Format$(Val(.cpoint(LigResult!paht)) * Val(.cpoint(LigResult!qte)), nbdec)
            If Len(Colrcp.Item[7]) - InStr(Colrcp.Item[7], ",") = 2 Then Colrcp.Item[7] = Colrcp.Item[7] & " "
            If Len(LigResult!prvt) - InStr(LigResult!prvt, ",") = 2 Then
              Colrcp.Item[9] = LigResult!prvt & " "
            Else
              Colrcp.Item[9] = LigResult!prvt
            Endif
            Colrcp.Item[10] = LigResult!frais
            If IsNull(Colrcp.Item[9]) Then Colrcp.Item[9] = "0"
            If IsNull(Colrcp.Item[10]) Then Colrcp.Item[10] = "0"
            Colrcp.Item[8] = ArtResult!art_cbarre
            Cart.text = LigResult!code
            GestCoul(Cart.Text)
          Loop Until LigResult.MoveNext()
          bas_doc()
        Endif
        Utils.db.Exec("delete from " & Cbase.Table("TabEntcom") & " WHERE numcom = &1", rfact!numcom)
        Utils.db.Exec("delete from " & Cbase.Table("TabLigcom") & " WHERE numcom = &1", rfact!numcom)
      Until rfact.MoveNext()
    Else
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Aucune ligne de commande n'est a génerer")
    Endif
  End With

End

'************************************** On génère une commande à partir du portable ********************************
Public Sub GencomPort()

  Dim x As Integer
  Dim Lig As String
  Dim iPos As Integer
  Dim filename As String
  Dim Code As String
  Dim Codeb As String
  Dim cle As String
  Dim Qte As String

  With utils
    filename = User.Home & "/tmp/ImpT.txt"
    Hnew = Open filename For Write Create
    Portable.Import("Commande")
    Try HFil = Open User.Home & "/Portable/inventaire.txt" For Read Write
    If Not Error Then
      Print #Hnew, "Les réfèrences suivantes n'ont pas pu être importées pour les raisons suivantes ."
      Me.Mouse = Mouse.Wait
      While Not Eof(hFil)
        Line Input #hFil, Lig
        If Not IsNull(Lig) Then
          For x = 1 To 2
            iPos = InStr(Lig, ";")
            If iPos = 0 Then
              cle = Lig
            Else
              cle = Left$(Lig, iPos - 1)
              Lig = Mid$(Lig, iPos + 1)
            Endif
            Select Case x
              Case 1
                If Not IsNull(cle) Then
                  Codeb = Trim(cle)
                  Code = Utils.Find_cbarre(Codeb)
                Else
                  Print #Hnew, "Une saisie a été rejetée car elle ne possède pas de code barre."
                  Inc cpt2
                Endif
                If IsNull(Code) Then
                  Print #Hnew, "Une saisie a été rejetée car le code barre " & Codeb & " n'existe pas."
                  Inc cpt2
                Endif
              Case 2
                If cle <> 0 Then
                  Qte = Format$(Val(Utils.cpoint(cle)), "#.###")
                Else
                  Qte = "0"
                Endif
            End Select
          Next
          If Not IsNull(Code) Then Import(code, codeb, qte, Hnew)
        Endif
      Wend
      Do
        Try Colrcp.Item.Selected = True
        If Not Error Then
          Totalrcpt.Text = Format$(Val(Totalrcpt.Text) + (Val(.cpoint(Colrcp.Item[6])) * Val(.cpoint(Colrcp.Item[5]))), "0.00")
          Tfrais.Text = Format$(Val(.cpoint(Tfrais.Text)) + (Val(.cpoint(Colrcp.Item[10])) * Val(.cpoint(Colrcp.Item[6]))), "0.00")
        Endif
      Loop Until Colrcp.MoveNext()
      Me.Mouse = Mouse.Default
      If Start.son Then
        Music.Play
      Endif
      Music.Play
      Message.Info("Importation terminée. " & Cpt & " réfèrences ont été importées. ", "Ok")
      Panel7.Visible = False
      ComboBox1.Clear
      Me.Raise
      Try Close #Hnew
      Try Close #HFil
      If Cpt2 <> 0 Then Editeur.Prog_Editeur(Filename)
    Else
      Message.Info("Problème d'import ! Vérifiez la présence du fichier inventaire.txt sous le repertoire " & "~/Portable !")
    Endif
  End With
Catch
  Me.Mouse = Mouse.Default
  Music.Play
  message.Error(Error.Text & " " & Error.where)

End

Public Sub Import(Code As String, codeb As String, qte As String, Hnew As File)

  Dim rArts As Result

  With utils
    Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_code = &1", Code)
    If Rarts.Available Then
      If rarts!art_suspendu <> "1" Then
        Nlgn = Format$(Colrcp.count + 1, "0000")
        If IsNull(Totalrcpt.Text) Then Totalrcpt.Text = "0,00"
        If IsNull(Tfrais.Text) Then Tfrais.Text = "0,00"
        If IsNull(Pcom.Text) Then Pcom.text = "0,000"
        Try Colrcp.Add(rarts!art_code, rarts!art_code)
        If Not Error Then
          Colrcp.Item[0] = Nlgn
          nbd = rarts!art_nbd
          nbdec = Utils.Find_nbdec(nbd)
          Decm = rarts!art_dec
          If Refart.value = True Then
            Colrcp.Item[1] = rarts!art_code
          Else
            If Not IsNull(rarts!art_cfour) Then
              Colrcp.Item[1] = rarts!art_cfour
            Else
              Colrcp.Item[1] = rarts!art_code
            Endif
          Endif
          Colrcp.Item[2] = rarts!art_design
          If Len(Colrcp.Item[2]) - InStr(Colrcp.Item[2], ",") = 2 Then Colrcp.Item[2] = Colrcp.Item[2] & " "
          Colrcp.Item[3] = Format$(rarts!art_pbht, Nbdec)
          If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
          Colrcp.Item[4] = Format$(rarts!art_tr, "0.00")
          Colrcp.Item[5] = Format$(rarts!art_pauaht, Nbdec)
          If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
          If Not IsNull(rarts!art_mincom) Then
            If Val(.cpoint(rarts!art_mincom)) <> 0 And Val(.cpoint(qte)) < Val(.cpoint(rarts!art_mincom)) Then Qte = rarts!art_mincom
          Endif
          Colrcp.Item[6] = .Cdec(Decm, Qte)
          Colrcp.Item[6] = .cpoint(Colrcp.Item[6])
          Colrcp.Item[7] = Format$(Val(.cpoint(Qte)) * rarts!art_pauaht, Nbdec)
          Colrcp.Item[9] = Format$(rarts!art_prvt, Nbdec)
          Colrcp.Item[10] = Format$(rarts!art_frais, Nbdec)
          Colrcp.Item[8] = rarts!art_cbarre
          If Len(Colrcp.Item[7]) - InStr(Colrcp.Item[7], ",") = 2 Then Colrcp.Item[7] &= " "
          Inc cpt
        Else
          Colrcp.MoveFirst
          Do
            Try Colrcp.Item.Selected = True
            If Not Error
              If Colrcp.Item[1] = code Then
                qte = Format$(Val(Colrcp.Item[6]) + Val(qte), "0.000")
                qte = .Cdec(Decm, qte)
                Colrcp.Item[6] = qte
              Endif
            Endif
          Loop Until Colrcp.MoveNext()
        Endif
        Colrcp.MoveFirst
        Totalrcpt.Text = "0,00"
        Tfrais.text = "0,00"
        Pcom.text = "0,000"
      Else
        Print #Hnew, "L'article " & code & " " & Codeb & " est suspendu ! Commande impossible."
        Inc Cpt2
      Endif
    Else
      Print #Hnew, "L'article " & code & " " & Codeb & " n'existe pas dans la table."
      Inc cpt2
    Endif
    Return
  End With
Catch
  Me.Mouse = Mouse.Default
  Music.Play
  message.Error(Error.Text & " " & Error.where)

End

'***************************************************
'* Saisie d'un code article manuellement en direct *
'***************************************************
Public Sub art_man()

  Dim rarts As Result
  Dim Rfours As Result
  Dim fourn As String
  Dim Tab3 As String
  Dim Frmt As New String[]
  Dim Nstockes As String = start.Nstockes
  Dim Bstockes As String = start.stockes
  Dim CoulB As Integer

  Artcom.Text = "0"
  Tab = "Fiches_Art"
  Tab2 = "Fiches_Tvaav"
  Tab3 = "Fiches_Four"

  With utils
    If four.Text And Ncom.Text Then
      If Tartfourn2.Value = True Then
        rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1 and art_four = &2", Cart.Text, four.Text)
      Else
        rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Cart.Text)
      Endif
      If Not rarts.Available Then
        'If Tartfourn2.Value = True Then
        rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_cfour = &1 and art_four = &2", Cart.Text, four.Text)
        'Else
        'rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_cfour = &1  and art_four <> &2", rarts!art_cfour, four.Text)
      Endif
      If Not rarts.Available Then
        If Tartfourn2.Value = True Then
          rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_cbarre = &1 and art_four = &2", Cart.Text, four.Text)
        Else
          rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_cbarre = &1", Cart.Text)
        Endif
      Endif
      If Not rarts.Available Then
        If Tartfourn2.Value = True Then
          rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_refcentrale = &1 and art_four = &2", Cart.Text, four.Text)
        Else
          rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_refcentrale = &1", Cart.Text)
        Endif
      Else
        If rarts!art_four <> four.Text And Tartfourn2.value Then
          Message.Warning("La saisie de cette référence pour le fournisseur " & rarts!art_four & " n'est pas possible!")
          b = 1
          Return
        Endif
      Endif
      If rarts.Available Then
        If rarts!art_suspendu = False Or If IsNull(rarts!art_suspendu) Then
          Cart.Text = rarts!art_code
          Dart.text = rarts!art_design
          If $soption = "B" Or $soption = "T" Then
            $incol = Rarts!art_nbcol
            $inbot = Rarts!art_nbbou
            If Not IsNull(Rarts!art_consb) Or Not IsNull(Rarts!art_consc) Or Not IsNull(Rarts!art_consp) Then $checcons.Value = True Else $checcons.Value = False
          Endif
          Refourn.Text = rarts!art_cfour
          If bCentrale = True Then Refourn.Text = rarts!art_refcentrale
          Fourn = Rarts!art_four
          scentrale = rarts!art_refcentrale
          nbd = rarts!art_nbd
          Stocke = rarts!art_stocke
          nbdec = Utils.Find_nbdec(nbd)
          pbht.Text = Format$(rarts!art_pbht, nbdec)
          Tr.Text = Format$(rarts!art_tr, "0.00")
          Try Rem1.Text = Format$(Rarts!art_remcas1, "0.00")
          Try Rem2.Text = Format$(Rarts!art_remcas2, "0.00")
          Try Rem3.Text = Format$(Rarts!art_remcas3, "0.00")
          If Not Error Then
            If Val(Utils.cpoint(Rem1.text)) > 0 Then
              Panel6.Visible = True
            Else
              Panel6.visible = False
            Endif
          Else
            Panel6.visible = False
          Endif
          montantr = Tr.Text
          paht.Text = Format$(rarts!art_pauaht, nbdec)
          Pauv.Text = Format$(rarts!art_paht, nbdec)
          Txconv = rarts!art_txconv
          Txcnv.Text = Txconv
          Frais.Text = Format$(rarts!art_frais, nbdec)
          Prvt.Text = Format$(rarts!art_prvt, nbdec)
          Coef.Text = Format$(rarts!art_coef, "0.0000")
          Pvht.Text = Format$(rarts!art_pvht, nbdec)
          Tva.Text = rarts!art_tva
          Txtva = CPrix.CTva(Tva.Text)
          PvTTc.Text = Format$(rarts!art_pvttc, nbdec)
          Pattc.Text = Format$(Val(paht.Text) + (Val(paht.Text) * Val(.cpoint(Txtva)) / 100), nbdec)
          Ppattc = Pattc.Text
          Ectx = Rarts!art_ect
          Try Ect = Format$(rarts!art_eco, nbdec)
          If Error Then Ect = "0,00"
          Cpp = Rarts!art_cpp
          Try Cop = Format$(rarts!art_copp, nbdec)
          If Error Then Cop = "0,00"
          Arr.Text = rarts!art_cdarr
          Decm = rarts!art_dec
          Artstock.text = .cpoint(rarts!art_qte)
          Artstockmax.Text = .cpoint(rarts!art_stkmax)
          Mcom = rarts!art_mincom
          If Not IsNull(Mcom) And If Val(Mcom) > 0 Then Balloon.Warning(("Ce produit est a commander par " & Mcom), Pdprod)
          Dfour = rarts!art_dfour
          If rarts!art_pmp Then
            Pmp = rarts!art_pmp
          Endif
          If Not Artstock.Text Then
            Artstock.Text = "0"
          Else
            Artstock.Text = .Cdec(Decm, Artstock.Text)
          Endif
          If Not stocke Then
            Frmt = Utils.FColr(NStockes)
            Try CoulB = Val(Frmt[0])
            If Not Error Then Artstock.Background = CoulB
          Else
            Frmt = Utils.FColr(BStockes)
            Try CoulB = Val(Frmt[0])
            If Not Error Then Artstock.Background = CoulB
            'Artstock.Background = &H00FFFFFF&
          Endif
          Artcom.Text = .Commande(Cart.text, Decm, 1, "Four")
          If modif <> "1" Then
            If Pdprod.visible Then Try Pdprod.Text = Format$(rarts!art_poids2, "0.000")
            Try Qtecom.text = (rarts!art_stkmax / txconv) - (rarts!art_qte / txconv) - Val(Artcom.text)
            If Error Then qtecom.Text = "1"
            If Qtecom.text <= "0" Or If IsNull(Qtecom.text) Then qtecom.Text = "1"
            If Not IsNull(rarts!art_mincom) Then
              Qtecom.Text = .cpoint(Qtecom.text)
              If Val(.cpoint(rarts!art_mincom)) <> 0 And Val(qtecom.text) < Val(.cpoint(rarts!art_mincom)) Then Qtecom.text = rarts!art_mincom
              If .cpoint(Artcom.Text) >= .cpoint(Qtecom.text) Then
                Qtecom.text = "0"
                Message.Warning("Ce produit est déjà en commande\net il n'est pas nécessaire de le commander.")
              Endif
            Endif
            If rarts!art_stkmin <> 0 Then
              If Not IsNull(rarts!art_stkmax) Then
                If Val(Artstock.text) >= Val(.cpoint(rarts!art_stkmin)) Then
                  Message.Warning("Le stock réel est supérieur ou égal au stock mini\n Ce n'est pas utile de commander ce produit.")
                Endif
              Endif
            Endif
            qtecom.Text = .Cdec(Decm, qtecom.Text)
            If Val(.cpoint(qtecom.Text)) <> 0 Then
              Pattc.Text = Format$(Val(.cpoint(qtecom.Text)) * Val(Pattc.Text), nbdec)
              Ppattc = Pattc.Text
            Endif
          Endif
          Totht.Text = paht.Text
          Calc_Percent()
          PvttcLF()
          Calc_Marge()
          Rfours = Utils.db.Exec("SELECT * FROM " & tab3 & " WHERE fo_code = &1", fourn)
          Nmfour.Text = Rfours!fo_nom
          b = 0
          Calc_Histo()
          Artcomm("Artman")
          If ComCli > 0 Then
            ArtCom.Background = &h00B4F1B4&
          Else
            Artcom.Background = &H00FFFFFF&
          Endif
        Else
          If Start.son Then
            Music.Play
          Endif
          Message.Warning(" Saisie impossible ! Cet article est suspendu. ")
          b = 1
        Endif
      Else
        If Start.son Then
          Music.Play
        Endif
        message.Warning(" Cette réfèrence n'existe pas ou elle n'est pas chez ce fournisseur!! ")
        b = 1
      Endif
    Endif
  End With

End

Public Sub Calc_Histo()

  Dim Ligrcpt As Result
  Dim Dtejour, daterecpt As String
  Dim Total As String = "0"
  Dim icol As Integer

  Colhisto.Columns.Count = 12
  Colhisto.Rows.Count = 2
  Dtejour = Format$(Now, "yyyymm")
  icpt = Dtejour
  Dtejour = (Val(Left$(Dtejour, 4)) - 1) & Right$(Dtejour, 2) & "01"
  Colhisto.Clear
  Colhisto.Columns.count = 12
  Colhisto.Rows.Height = 27
  Colhisto.Columns[0].Width = 75
  Colhisto.Columns[0].Alignment = 3
  Colhisto.Columns[1].Width = 75
  Colhisto.Columns[1].Alignment = 3
  Colhisto.Columns[2].Width = 75
  Colhisto.Columns[2].Alignment = 3
  Colhisto.Columns[3].Alignment = 3
  Colhisto.Columns[3].Width = 75
  Colhisto.Columns[4].Alignment = 3
  Colhisto.Columns[4].Width = 75
  Colhisto.Columns[5].Alignment = 3
  Colhisto.Columns[5].Width = 75
  Colhisto.Columns[6].Alignment = 3
  Colhisto.Columns[6].Width = 75
  Colhisto.Columns[7].Alignment = 3
  Colhisto.Columns[7].Width = 75
  Colhisto.Columns[8].Width = 75
  Colhisto.Columns[8].Alignment = 3
  Colhisto.Columns[9].Width = 75
  Colhisto.Columns[9].Alignment = 3
  Colhisto.Columns[10].Width = 75
  Colhisto.Columns[10].Alignment = 3
  Colhisto.Columns[11].Alignment = 3
  Colhisto.Columns[11].Width = 75
  Ligrcpt = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigrecpt") & " where code = &1  and daterecpt >= &3 and daterecpt <= &4 or code = &2  and daterecpt >= &3 and daterecpt <= &4 order by daterecpt desc", Cart.Text, Reffour.Text, dtejour, Format$(Now, "yyyymmdd"))
  If Ligrcpt.Available Then
    Daterecpt = Right$(Utils.Cdate_Aff(Ligrcpt!daterecpt), 7)
    If icpt > Val(Right$(Daterecpt, 4)) & Left(Daterecpt, 2) Then
      Repeat
        Inc icol
        aff_histo(icol, Right$(Icpt, 2) & "." & Left$(icpt, 4), "0")
        If Right(icpt, 2) = "00" Then
          icpt = Str(Val(Left(icpt, 4)) - 1) & "12"
          Inc icol
          aff_histo(icol, Right$(Icpt, 2) & "." & Left$(icpt, 4), "0")
        Endif
        ' Icpt = Val(Icpt) - 1
      Until icpt >= Right$(Daterecpt, 4) & Left$(Daterecpt, 2)
      'icpt = idate
    Endif
    Repeat
      If Right$(Utils.Cdate_Aff(Ligrcpt!daterecpt), 7) <> Daterecpt Then
        Inc icol
        aff_histo(icol, Daterecpt, Total)
        Total = "0"
      Endif
      Total = Val(Utils.cpoint(Total)) + Val(Utils.CDec(Decm, Ligrcpt!qte))
      Daterecpt = Right$(Utils.Cdate_Aff(Ligrcpt!daterecpt), 7)
      idate = Right(Daterecpt, 4) & Left$(Daterecpt, 2)
      While Val(Icpt) > idate
        Icpt = (Val(Icpt) - 1)
        If Right(icpt, 2) = "00" Then
          icpt = Str(Val(Left(icpt, 4)) - 1) & "12"
        Endif
        If Val(Icpt) = idate Then Break
        Inc icol
        aff_histo(icol, Right$(Icpt, 2) & "." & Left$(icpt, 4), "0")
      Wend
      icpt = idate
    Until Ligrcpt.MoveNext()
    Inc icol
    aff_histo(icol, Daterecpt, Total)
    If icol < 12 Then
      While icol <= 12
        Inc icol
        Icpt = Val(Icpt) - 1
        If Right(icpt, 2) = "00" Then
          icpt = Str(Val(Left(icpt, 4)) - 1) & "12"
        Endif
        aff_histo(icol, Right$(Icpt, 2) & "." & Left$(icpt, 4), "0")
      Wend
    Endif
  Endif

End

Public Sub aff_histo(icol As Integer, dterecpt As String, qterecpt As String)

  icol = icol - 1
  Try Colhisto[0, icol].Text = dterecpt
  Try Colhisto[1, icol].text = qterecpt

End

'**********************************************************
'*           Affichage des quantites en stock             *
'**********************************************************
Public Sub Quantite()

  Dim rarts As Result

  Tab = "Fiches_Art"
  With utils
    rarts = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Cart.text)
    If rarts.Available Then
      Stocke = rarts!art_stocke
      Artstock.Text = Format$(rarts!art_qte, "0.000")
    Endif
    If Stocke Then
      Artstock.Text = .Cdec(Decm, Artstock.Text)
      If Val(Artstock.Text) < 1 Then
        Artstock.Background = &D47C0A&
      Else
        Artstock.Background = &HD4D0C8&
      Endif
    Endif
  End With

End

'**********************************************************
'*        Controle de la saisie des quantites             *
'**********************************************************
Public Sub qtecom_LF()

  With utils
    Pdx = "0"
    If qtecom.Text Then
      qtecom.Text = .cpoint(qtecom.Text)
      If Val(qtecom.Text) = Null Then
        If Start.son Then
          Music.Play
        Endif
        Message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Else
        qtecom.Text = .Cdec(Decm, qtecom.Text)
        b = 0
        If Paht.Text Then
          Totht.Text = Format$(Val(.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
          Pattc.Text = Format$(Val(.cpoint(qtecom.Text)) * Val(Ppattc), nbdec)
        Endif
        If Pdprod.text Then Pdx = Format$((Val(.cpoint(qtecom.Text)) * Val(.cpoint(Pdprod.Text))), "0.000")
      Endif
    Else
      b = 1
    Endif
  End With

End

Public Sub pbhtGF()

  With utils
    Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
  End With
  b = 0

End

Public Sub pbhtLF()

  With Utils
    If IsNull(Pbht.Text) Then Pbht.Text = "0,00"
    pbht.Text = .cpoint(pbht.Text)
    If Val(pbht.Text) = Null Then
      If Start.son Then
        Music.Play
      Endif
      message.Warning("Veuillez verifier votre saisie du prix de base SVP !")
      b = 1
    Else
      pbht.Text = Format$(Val(.cpoint(pbht.Text)), nbdec)
      b = 0
      TrC()
      Pauv.Text = Format$(Val(paht.Text) / Txconv, nbdec)
      pahtGF()
      pahtLF()
    Endif
  End With
  montante = 0

End

Public Sub TrC()

  With Utils
    If IsNull(Tr.Text) Then Tr.Text = "0,00"
    Tr.Text = .cpoint(Tr.Text)
    If Val(Tr.Text) = Null Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
      paht.Text = pbht.Text
    Else
      Tr.Text = Format$(Val(.cpoint(Tr.Text)), "0.00")
      paht.Text = Format$(Val(.cpoint(pbht.Text)) - (Val(.cpoint(pbht.Text)) * Val(Tr.Text) / 100), nbdec)
      If Val(.cpoint(Rem1.text)) > 0 Then
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem1.text), nbdec)
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem2.text), nbdec)
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem3.text), nbdec)
      Endif
      b = 0
      Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
      If paht.Text Then Try Totht.Text = Format$(Val(.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
      pahtLF()
    Endif
  End With

End

Public Sub pahtGF()

  With utils
    paht.Text = .cpoint(paht.Text)
    If Val(paht.Text) <> Null Then
      Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
    Endif
  End With

End

Public Sub pahtLF()

  With Utils
    If Bpa = False Then
      If IsNull(Paht.Text) Then Paht.Text = "0,00"
      If Val(.cpoint(paht.Text)) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie du prix d' achat SVP !")
        b = 1
      Else
        paht.Text = Format$(Val(.cpoint(paht.Text)), nbdec)
        'pbht.Text = paht.text
        Pauv.Text = Format$(Val(paht.Text) / Txconv, nbdec)
        FraisLF()
        If Val(.cpoint(paht.Text)) <> "0" Then
          If montante <> paht.Text Then
            If message.Question(" Vous venez de modifier le prix net ht. Voulez-vous \n 1- Modifier la remise \n 2- Modifier le prix de base ", " 1 ", " 2 ") = "1" Then
              Tr.Text = Format(Val(pbht.Text) - Val(paht.Text), "0.00")
              Tr.Text = Format$((Val(Tr.Text) * 100) / Val(pbht.Text), "0.00")
            Else
              pbht.Text = Format$(Val(paht.Text) / (1 - (Val(Tr.Text) / 100)), nbdec)
            Endif
          Endif
          If Paht.Text Then Totht.Text = Format$(Val(.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
        Endif
        b = 0
      Endif
      montante = 0
    Endif
  End With

End

Public Sub FraisLF()

  With Utils
    If IsNull(Frais.Text) Then Frais.Text = "0,00"
    If Val(.cpoint(Frais.Text)) = Null Then
      If Start.son Then
        Music.Play
      Endif
      message.Warning("Veuillez verifier votre saisie des frais SVP !")
      b = 1
    Else
      Frais.Text = Format$(Val(.cpoint(Frais.Text)), nbdec)
      Prvt.Text = Format$(Val(pauv.Text) + Val(Frais.Text), nbdec)
      Pvht.Text = Format$(Val(prvt.Text) * (Val(Coef.Text)), nbdec)
      Tva_Calcul()
      arrondi()
      Calc_Marge()
      PvTTcLF()
      b = 0
    Endif
    'montante = 0
  End With

End

'***************************************
'*   On gère les remises en cascades   *
'***************************************
Public Sub Rcpt_dblclick()

  Select Last.tag

    Case 8
      If Panel6.visible = True Then
        Panel6.Visible = False
        Tr.SetFocus
        Tr.select
      Else
        Panel6.visible = True
        Rem1.SetFocus
        Rem1.select
      Endif
  End Select

End

Public Sub Rem_KeyPress()

  Select Last.tag
    Case 1
      ChkPrx()
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Tr.Text = Format$(Val(Tr.Text), "0.00")
        PaHt.Text = Format$(Val(pbht.Text) - (Val(pbht.Text) * Val(Tr.Text) / 100), nbdec)
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem1.text), nbdec)
        Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
        If Paht.Text Then Totht.Text = Format$(Val(Utils.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
        PahtLF()
        Rem2.SetFocus
        Rem2.Select
      Endif

    Case 2
      ChkPrx()
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem2.text), nbdec)
        Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
        'Pauv.Text = Format$(Val(paht.Text) / Txconv, nbdec)
        If Paht.Text Then Totht.Text = Format$(Val(Utils.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
        PahtLF()
        Rem3.SetFocus
        Rem3.Select
      Endif

    Case 3
      ChkPrx()
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        PaHt.Text = Format$(CPrix.Cascade(paht.text, Rem3.text), nbdec)
        Try montante = Format$(Val(Utils.cpoint(paht.Text)), nbdec)
        'Pauv.Text = Format$(Val(paht.Text) / Txconv, nbdec)
        If Paht.Text Then Totht.Text = Format$(Val(Utils.cpoint(qtecom.Text)) * Val(Paht.Text), nbdec)
        PahtLF()
        Panel6.Visible = False
        Button1.SetFocus
      Endif

  End Select

End

Public Sub ChkPrx()

  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif

End

'***************************************
'*   On gère le coefficient de vente   *
'***************************************
Public Sub Coeff()

  With Utils
    If Not IsNull(Coef.Text) Then
      Coef.Text = .cpoint(Coef.Text)
      If Val(Coef.Text) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie du coefficient SVP !")
        b = 1
      Else
        b = 0
        'Coef.text = Format$(Val(.cpoint(Coef.text)), "0.000")
        Pvht.Text = Format$(Val(Prvt.Text) * Val(Coef.Text), nbdec)
        Tva_Calcul()
        PvTTcLF()
        'Calc_Marge()
      End If
    Endif
  End With

End

'***************************************
'*   On gère le pourcentage de vente   *
'***************************************
Public Sub Pourcent()

  With Utils
    Tmq.Text = .cpoint(Tmq.Text)
    If Val(Tmq.Text) = Null Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Veuillez verifier votre saisie SVP !", "OK")
      Tmq.Text = "0.000"
      b = 1
    Else
      Tmq.text = Format$(Val(Tmq.text), "0.000")
      b = 0
    Endif
  End With
Catch
  b = 1
  If Start.son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)

End

'***************************************************
'*        On calcule le coefficient de marge       *
'***************************************************
Public Sub Calc_coeff()

  Try Coef.Text = Format$(1 / (1 - (Val(Tmq.Text)) / 100), "0.0000")

End

'********************************************
'*       On calcule le taux de marque       *
'********************************************
Public Sub Calc_Percent()

  Try Tmq.Text = Format$((Val(Pvht.Text) - Val(prvt.Text)) / Val(Pvht.Text) * 100, "0.000")

End

'***********************************
'*       On calcule la marge       *
'***********************************
Public Sub Calc_Marge()

  If Not IsNull(Prvt.Text) Then
    If Val(Prvt.Text) > 0 Then
      Margem = Format$(Val(Pvht.Text) - Val(Prvt.Text), nbdec)
      Margep = Format$((Val(Margem) * 100) / Val(Prvt.Text), nbdec)
    Endif
  Endif

End

Public Sub PvhtLF()

  With Utils
    If Not IsNull(Pvht.Text) Then
      Pvht.Text = .cpoint(Pvht.Text)
      If Val(Pvht.Text) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie du prix de vente ht SVP !")
        b = 1
      Else
        Pvht.Text = Format$(Val(Pvht.Text), nbdec)
        If Val(Pvht.Text) < Val(Pauv.Text) Then
          If Start.son Then
            Music.Play
          Endif
          message.warning("ATTENTION ! Le Prix de vente est inférieur au prix d'achat", "OK !")
          b = 1
        Else
          Calc_Percent()
          Calc_Coeff()
          'Pvht.Background = Color.TextBackground
          Tva_Calcul()
          PvTTcLF()
        Endif
      Endif
    Endif
  End With

End

Public Sub PvTTcLF()

  Dim tx As Float

  With Utils
    If Not IsNull(PvTTc.Text) Then
      PvTTc.Text = .cpoint(PvTTc.Text)
      If Val(Pvttc.Text) = Null Then
        If Start.son Then
          Music.Play
        Endif
        message.Warning("Veuillez verifier votre saisie du prix de vente TTC SVP !")
        b = 1
      Else
        PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
        arrondi()
        tx = (1 + (Val(.cpoint(Txtva)) / 100))
        Pvht.Text = Format$(Val(PvTTc.Text) / tx, nbdec)
        Calc_Percent()
        Calc_Coeff()
        PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
        If Val(Pvht.Text) < Val(Pauv.Text) Then
          If Start.son Then
            Music.Play
          Endif
          message.warning("ATTENTION ! Le Prix de vente est inférieur au prix d'achat", "OK !")
          PvTTC.SetFocus
          PvTTC.Select
        Endif
      Endif
    Endif
  End With
Catch
  If Start.son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)

End

Public Sub Tva_Calcul()

  With Utils
    If Not IsNull(PvTTc.Text) Or Not IsNull(Pvht.Text) Then
      PvTTc.Text = Format$(Val(Pvht.Text) + (Val(Pvht.Text) * Val(.cpoint(Txtva)) / 100), nbdec)
    End If
  End With
Catch
  If Start.son Then
    Music.Play
  Endif
  message.Error(Error.Text & " " & Error.where)

End

Public Sub Tva_LostFocus()

  Txtva = CPrix.CTva(Tva.Text)
  If IsNull(Txtva) Then
    Try message.Warning("Ce code Tva n'existe pas !")
    Tva.SetFocus
    Tva.Select
  Else
    FraisLF()
  Endif

End

Public Sub Tva_KeyPress()

  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Tr.SetFocus
    Tr.Select
  Endif

End

Public Sub arrondi()

  If Not IsNull(PvTTC.text) Then
    If arr.Text = "0,05" Then
      If Right$(pvTTc.Text) Like "[34567]*" Then
        PvTTC.Text = Left$(PvTTC.Text, (Len(PvTTC.Text) - 1)) & "5"
        PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
      Else
        PvTTC.Text = Round(Val(PvTTC.Text), -1)
        PvTTC.Text = Format$(PvTTC.Text, nbdec)
      Endif
    Endif

    If arr.Text = "0,10" Then
      PvTTC.Text = Round(Val(PvTTC.Text), -1)
      PvTTC.Text = Format$(PvTTC.Text, nbdec)
    Endif

    If arr.Text = "0,50" Then
      If Val(pvTTc.Text) <= Val(Left$(pvTTc.Text, (Len(pvTTc.Text) - 2)) & 25) Then
        PvTTC.Text = Left$(PvTTC.Text, (Len(PvTTC.Text) - 2)) & "00"
        PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
      Else
        If Val(pvTTc.Text) <= Val(Left$(pvTTc.Text, (Len(pvTTc.Text) - 2)) & 75) Then
          PvTTC.Text = Left$(PvTTC.Text, (Len(PvTTC.Text) - 2)) & "50"
          PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
        Endif
        If Val(pvTTc.Text) >= Val(Left$(pvTTc.Text, (Len(pvTTc.Text) - 2)) & 76) Then
          PvTTC.Text = Round(Val(PvTTC.Text))
          PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
        Endif
      Endif
    Endif

    If arr.Text = "1,00" Then
      PvTTC.Text = Round(Val(PvTTC.Text))
      PvTTC.Text = Format$(Val(PvTTC.Text), nbdec)
    Endif
  Endif

End

Public Sub ToggleButton2_Click()

  If Not Ncom.Text
    If Start.son Then
      Music.Play
    Endif
    Message.Warning(" Veuillez saisir un numéro de commande SVP ! ")
    Ncom.SetFocus
    Ncom.select
  Else
    If Not datej.Text Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning(" Veuillez saisir une date SVP ! ")
      datej.Text = Format$(Now, "dd.mm.yyyy")
      datej.SetFocus
      datej.select
    Else
      SelectionArt()
    Endif
  Endif

End

'******************************************************
'*   On mouvemente le panel Colrcp apres validation   *
'******************************************************
Public Sub Maj_colrcp()

  Dim rResult As Result
  Dim qte As String
  Dim Patot As String
  Dim Pauvht As Float 'Prix d'achat en uv

  Tab = "Fiches_Art"
  With utils
    Dpa = paht.Text
    If IsNull(Totalrcpt.Text) Then Totalrcpt.Text = "0,00"
    If IsNull(Tfrais.Text) Then Tfrais.Text = "0,00"
    If IsNull(Pcom.Text) Then Pcom.text = "0,000"
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Cart.Text)
    If rResult.Available Then
      nbd = rResult!art_nbd
      Txconv = rResult!art_txconv
      Pauvht = rResult!art_paht
      Ref_four = rResult!art_cfour
      Ref_centrale = rResult!art_refcentrale
      nbdec = Utils.Find_nbdec(nbd)
      If Format$(Val(paht.Text), Nbdec) <> Format$(rResult!art_pauaht, Nbdec) Or If Format$(Val(Coef.Text), "0.000") <> Format$(rResult!art_coef, "0.000") Or If Format$(Val(pvht.Text), Nbdec) <> Format$(rResult!art_pvht, Nbdec) Or If Format$(Val(Frais.Text), Nbdec) <> Format$(rResult!art_frais, Nbdec) Then
        If Start.son Then
          Music.Play
        Endif
        If Message.question("Le prix du produit a été modifié ! \n Voulez-vous mettre à jour la fiche article ?", "Oui", "Non") = 1 Then
          Pauvht = Val(paht.Text) / Txconv
          Utils.db.Exec("UPdate  " & Tab & "  SET  art_code = &1, art_pbht = &2 , art_tr = &3 , art_pauaht = &4 , art_coef = &5, art_pvht = &6, art_pvttc = &7  , art_paht = &8, art_cdarr = &9, art_frais = &{10}, art_prvt = &{11}, art_ddatefbt = &{12} where art_code = &1", Cart.Text, Val(pbht.Text), Val(Tr.Text), Val(paht.Text), Val(Coef.Text), Val(Pvht.Text), Val(Pvttc.Text), Val(Pauv.Text), arr.text, Val(frais.Text), Val(prvt.Text), Utils.Cdate_Dbase(datej.text))
        Endif
      Endif
    Endif
    If Colrcp.count > 0 Then
      Colrcp.MoveFirst
      Repeat
        Colrcp.Item.Selected = True
        If Colrcp.Item[1] = Refourn.Text Then
          nlg = 1
          Break
        Endif
      Until Colrcp.MoveNext()
    Endif
    If modif = "1" Then
      Colrcp.MoveFirst
      Repeat
        Colrcp.Item.Selected = True
        If Colrcp.Item[0] = NlgModif Then
          Break
        Endif
      Until Colrcp.MoveNext()
    Else
      Nlgn = Format$(Colrcp.count + 1, "0000")
      If Nlg = 1 Then
        Colrcp.Add(Cart.text, Cart.text)
        Colrcp.Item[0] = Nlgn
      Else
        If Nlg = 0 Then
          Colrcp.Add(Nl, Nl & "-")
          Colrcp.Item[0] = Nl
        Endif
      Endif
    Endif
    Nlg = 1
    If Refart.value = True Then
      Colrcp.Item[1] = Cart.text
    Else
      If Reffour.Value = True Then
        If Not IsNull(Ref_four) Then
          Colrcp.Item[1] = Ref_four
        Else
          Colrcp.Item[1] = Cart.text
        Endif
      Else
        If Refcentrale.value = True Then
          If Not IsNull(Ref_centrale) Then
            Colrcp.Item[1] = Ref_centrale
          Else
            Colrcp.Item[1] = Cart.text
          Endif
        Endif
      Endif
    Endif
    Colrcp.Item[2] = Dart.text
    If Len(paht.Text) - InStr(paht.Text, ",") = 2 Then paht.Text = paht.Text & " "
    Colrcp.Item[3] = Pbht.text
    If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
    Colrcp.Item[4] = Tr.text
    If Len(prvt.Text) - InStr(prvt.Text, ",") = 2 Then prvt.Text = prvt.Text & " "
    Colrcp.Item[5] = Paht.text
    If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
    If $soption = "B" Or $soption = "T" Then
      Colrcp.Item[6] = $textpal.Text
      Colrcp.Item[7] = $textcol.Text
    Endif
    Colrcp.Item[6 + $o] = qtecom.text
    If Len(Totht.Text) - InStr(Totht.Text, ",") = 2 Then Totht.Text = Totht.Text & " "
    Colrcp.Item[7 + $o] = Totht.text
    Colrcp.Item[9 + $o] = Prvt.text
    Colrcp.Item[10 + $o] = Frais.text
    Colrcp.Item[11 + $o] = Coef.text
    Colrcp.Item[12 + $o] = Pvht.text
    Colrcp.Item[13 + $o] = Pvttc.text
    Colrcp.Item[14 + $o] = Pdx
    Colrcp.Item[15 + $o] = Cart.text
    Colrcp.Item[17 + $o] = Pattc.text
    Colrcp.Item[8 + $o] = rResult!art_cbarre
    Colrcp.Item.Selected = True
    'ob = Colrcp.Children[0]
    'ob[ob.Row, 0].Background = ArtCom.Background
    Colrcp.MoveFirst
    b = 0
    Coulfond()
    bas_doc()
    Colrcp.MoveFirst
    Do
      Colrcp.Item.Selected = True
      If Colrcp.Item[1] = Cart.text Or If Colrcp.Item[1] = Refourn.Text Then
        Break
      Endif
    Loop Until Colrcp.MoveNext()
  Catch
    Colrcp.MoveFirst
    Do
      Try Colrcp.Item.Selected = True
      If Not Error
        If Colrcp.Item[1] = Cart.text Or If Colrcp.Item[1] = Refourn.Text Or If Colrcp.Item[1] = scentrale Then
          If Start.son Then
            Music.Play
          Endif
          Select Case Message.Question("Cet article a déjà été saisit ! Voulez-vous ? \n 1- Cumuler \n 2- Remplacer \n 3- Créer une nouvelle ligne", "1", "2", "3")
            Case 1
              qte = Format$(Val(Colrcp.Item[6 + $o]) + Val(qtecom.text), "0.000")
              qte = .Cdec(Decm, qte)
              Colrcp.Item[6 + $o] = qte
              Colrcp.Item[7 + $o] = Format$(Val(paht.text) * Val(.cpoint(Colrcp.Item[6 + $o])), nbdec)
              If $soption = "B" Or $soption = "T" Then
                Colrcp.Item[6] = Str(utils.totobs([Colrcp.Item[6], $textpal.Text]))
                Colrcp.Item[7] = Str(utils.totobs([Colrcp.Item[7], $textcol.Text]))
              Endif
              Break
            Case 2
              Artstock.text = Val(.cpoint(Artstock.text)) - Val(.cpoint(Colrcp.Item[6 + $o]))
              Colrcp.Item[6 + $o] = qtecom.text
              If $soption = "B" Or $soption = "T" Then
                Colrcp.Item[6] = $textpal.Text
                Colrcp.Item[7] = $textcol.Text
              Endif
              Break
            Case 3
              Colrcp.Add(Nlgn & "-", Nlgn & "-")
              Colrcp.Item[0] = Nlgn
              If Refart.value = True Then
                Colrcp.Item[1] = Cart.text
              Else
                If Not IsNull(Ref_four) Then
                  Colrcp.Item[1] = Ref_four
                Else
                  Colrcp.Item[1] = Cart.text
                Endif
              Endif
              Colrcp.Item[2] = Dart.text
              Colrcp.Item[3] = pbht.text
              If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then Colrcp.Item[3] &= " "
              Colrcp.Item[4] = Tr.text
              If Len(Paht.text) - InStr(Paht.text, ",") = 2 Then Colrcp.Item[5] = Paht.text & "  "
              Colrcp.Item[5] = Paht.text
              If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then Colrcp.Item[5] &= " "
              Colrcp.Item[6 + $o] = qtecom.text
              Patot = Format$(Val(Paht.text) * Val(qtecom.text), nbdec)
              If Len(Patot) - InStr(Patot, ",") = 2 Then Colrcp.Item[7] = Patot & "  "
              Colrcp.Item[7 + $o] = Patot
              Colrcp.Item[9 + $o] = Prvt.text
              Colrcp.Item[10 + $o] = Frais.text
              Colrcp.Item[11 + $o] = Coef.text
              Colrcp.Item[12 + $o] = Pvht.text
              Colrcp.Item[13 + $o] = Pvttc.text
              Colrcp.Item[14 + $o] = Pdx
              Colrcp.Item[15 + $o] = Cart.text
              Pattc.Text = Format$(Val(Patot) + (Val(Patot) * Val(.cpoint(Txtva)) / 100), nbdec)
              Colrcp.Item[17 + $o] = Pattc.text
              Colrcp.Item[8 + $o] = rResult!art_cbarre
              If $soption = "B" Or $soption = "T" Then
                Colrcp.Item[6] = $textpal.Text
                Colrcp.Item[7] = $textcol.Text
              Endif
              Break
          End Select
        Endif
      Endif
    Loop Until Colrcp.MoveNext()
  End With
  'Try ob[ob.Row, 0].Background = ArtCom.Background
  Coulfond()
  bas_doc()

End

'*******************************************
'*       On calcule le bas de document     *
'*******************************************
Public Sub bas_doc()

  Dim Tresult As Result
  Dim Tb_conv As String

  Tb_conv = "Fiches_Art"
  Totalrcpt.Text = "0,00"
  Tfrais.Text = "0,00"
  Tcom.text = "0,00"
  Pcom.text = "0,000"
  pttc = "0"
  If Colrcp.count > 0 Then
    With utils
      Colrcp.MoveFirst
      Do
        Colrcp.Item.Selected = True
        Totalrcpt.Text = Format$(Val(.cpoint(Totalrcpt.Text)) + Val(.cpoint(Colrcp.Item[6 + $o])) * Val(.cpoint(Colrcp.Item[5])), "0.00")
        TResult = Utils.db.Exec("SELECT * FROM " & Tb_conv & " where art_code = &1", Colrcp.Item[1])
        If Not TResult.Available Then TResult = Utils.db.Exec("SELECT * FROM " & Tb_conv & " where art_cfour = &1", Colrcp.Item[1])
        If Not TResult.Available Then TResult = Utils.db.Exec("SELECT * FROM " & Tb_conv & " where art_refcentrale = &1", Colrcp.Item[1])
        Txconv = TResult!art_txconv
        Tfrais.Text = Format$(Val(Tfrais.Text) + (Val(.cpoint(Colrcp.Item[10 + $o])) * Val(.cpoint(Colrcp.Item[6 + $o])) * Txconv), "0.00")
        Tcom.Text = Format$(Val(Totalrcpt.Text) + Val(Tfrais.Text), "0.00")
        If Not IsNull(Colrcp.Item[14 + $o]) Then Pcom.text = Format$(Val(.cpoint(Pcom.text)) + Val(.cpoint(Colrcp.Item[14 + $o])), "0.000")
        Try Pttc = Format$(Val(.cpoint(Pttc)) + Val(.cpoint(Colrcp.Item[17 + $o])), "0.00")
      Loop Until Colrcp.MoveNext()
      modif = "0"
      If Not Franco.Text Then Franco.Text = "0,00"
      If Val(Utils.cpoint(Franco.Text)) > 0 Then
        If Val(Utils.cpoint(Tcom.text)) < Val(Utils.cpoint(Franco.Text)) Then
          Tcom.background = &FF684A&
        Else
          Tcom.background = CoulTc
        Endif
      Endif
    End With
  Endif

End

'******************************************************
'*       On rappelle un article pour modification     *
'******************************************************
Public Sub Colrcp_Activate()

  With Utils
    If Colrcp.count > 0 Then
      Colhisto.Clear
      Nl = Colrcp.Current[0]
      NlgModif = Colrcp.Current[0]
      Nlg = 0
      Cart.text = Colrcp.Current[1]
      Modif = "1"
      art_man()
      If b = "0" Then
        Dart.text = Colrcp.Current[2]
        Pbht.text = Colrcp.Current[3]
        Tr.text = Colrcp.Current[4]
        Paht.text = Colrcp.Current[5]
        If $soption = "B" Or $soption = "T" Then
          $textpal.Text = Colrcp.Current[6]
          $textcol.Text = Colrcp.Current[7]
        Endif
        qtecom.text = Colrcp.Current[6 + $o]
        Totht.text = Colrcp.Current[7 + $o]
        Prvt.text = Format$(Val(.cpoint(Colrcp.Current[9 + $o])), "0.00")
        Frais.text = Colrcp.Current[10 + $o]
        If Not IsNull(Colrcp.Current[11 + $o]) Then Coef.text = Colrcp.Current[11]
        If Not IsNull(Colrcp.Current[12 + $o]) Then Pvht.text = Colrcp.Item[12]
        If Not IsNull(Colrcp.Current[13 + $o]) Then Pvttc.text = Colrcp.Item[13]
        If Start.LocalSettings["/Soc" & Start.Societe & "/Tmq"] Then
          Calc_Percent()
        Endif
        qtecom.SetFocus
        qtecom.Select
        Modif = "1"
        Colrcp.MoveFirst
        Do
          Colrcp.Item.Selected = True
          If Colrcp.Item[1] = Cart.text Or If Colrcp.Item[1] = Refourn.Text Then
            Colrcp.Item.Selected = True
            Break
          Endif
        Loop Until Colrcp.MoveNext()
      Else
        Cart.clear
        B = 0
        Modif = "0"
      Endif
    Endif
  End With

End

Public Sub colrcp_MouseDown()

  Dim cle As String = Colrcp.key

  Try Colrcp.MoveTo(cle)
  Try Colrcp.item.Selected = True

End

'**********************************************************
'*     Rappel et Suppression  de ligne manuellement       *
'**********************************************************
Public Sub Colrcp_Keypress()

  With Utils
    If Key.code = Key.Delete And Colrcp.Count <> 0 Then
      If Start.son Then
        Music.Play
      Endif
      If Message.Question("Etes-vous sur de vouloir supprimer cette ligne ?", "Oui", "Non") = 1 Then
        Tab = "Fiches_Ligcom"
        Utils.db.Exec("delete from " & Tab & " WHERE code = &1 and numcom = &2 and four = &3 ", Colrcp.current[1], Ncom.Text, four.Text)
        CleanChamps()
        Colrcp.Current.Delete
        If Colrcp.Count > 0 Then
          Colrcp.MoveFirst
          Nlgn = Format$(0, "0000")
          Do
            Colrcp.Item.Selected = True
            Nlgn = Format$(Val(Nlgn) + 1, "0000")
            Colrcp.Item[0] = Nlgn
          Loop Until Colrcp.MoveNext()
        Endif
        Coulfond()
        bas_doc()
      Else
        Totalrcpt.Text = "0,00"
        Tfrais.text = "0,00"
        Tcom.text = "0,00"
        Pcom.text = "0,000"
        $textcol.Text = "0,00"
        $textpal.Text = "0,00"
      Endif
      CArt.SetFocus
      Cart.Select
      Nlg = 1
    Endif
  End With
  If Key.code = Key.Return Or If Key.code = Key.Enter Then Colrcp_Activate()

End

'*****************************************
'* Maj de la quantite en stock en moins  *
'*****************************************
Public Sub Maj_Quantite()

  Dim rResult As Result
  Dim Qline As Float
  Dim Qtec As Float

  Tab = "Fiches_Art"
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE")
  With utils
    If Colrcp.Count <> 0 Then
      Colrcp.MoveFirst
      Repeat
        Colrcp.Item.Selected = True
        rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Colrcp.Item[1])
        If rResult.Available Then
          Try Qtec = rResult!art_com
          If Error Then Qtec = 0
          If rResult!art_stocke = True Then
            Qline = Val(Colrcp.Item[6 + $o])
            Qtec = Qtec - Qline
            Utils.db.Exec("UPDATE  " & tab & "  SET art_com = &2 WHERE art_code = &1", Colrcp.Item[1], Qtec)
          Endif
        Endif
      Until Colrcp.Movenext()
    Endif
    Qtec = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")

End

'*****************************************
'* Maj de la quantite en stock en plus  *
'*****************************************
Public Sub Maj_Quantite2()

  Dim rResult As Result
  Dim Qline As Float
  Dim Qtec As Float

  Tab = "Fiches_Art"
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE")
  With utils
    If Colrcp.Count <> 0 Then
      Colrcp.MoveFirst
      Repeat
        Colrcp.Item.Selected = True
        rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Colrcp.Item[1])
        If rResult.Available Then
          Try Qtec = rResult!art_com
          If Error Then Qtec = 0
          If rResult!art_stocke = True Then
            Qline = Val(Colrcp.Item[6 + $o])
            Qtec = Qtec + Qline
            Utils.db.Exec("UPDATE  " & tab & "  SET art_com = &2 WHERE art_code = &1", Colrcp.Item[1], Qtec)
          Endif
        Endif
      Until Colrcp.Movenext()
    Endif
    Qtec = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")

End

'************************************************
'*    On enregistre la commande dans la table   *
'************************************************
Public Sub Enrgcom()

  Dim Tab As String

  With Utils
    Refart.value = True
    Tab = "Fiches_Entcom"
    If four.Text Then
      If Colrcp.Count <> 0 Then
        Utils.db.Exec("INSERT INTO " & Tab & "(four,numcom,ddate,montant, montantttc) VALUES (&1, &2, &3, &4, &5)", four.text, Ncom.text, .Cdate_Dbase(datej.text), Val(Totalrcpt.text), pttc)
        Colrcp.MoveFirst
        Tab = "Fiches_Ligcom"
        Repeat
          Colrcp.Item.Selected = True
          Cart.text = Colrcp.Current[1]
          If $soption = "B" Or $soption = "T" Then
            Utils.db.Exec("INSERT INTO " & Tab & "(code,design,numcom,four,pbht,rm,paht,qte,frais,prvt, datecom, nligne, coda, pattc, palet, coli) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Colrcp.Item[1], Colrcp.Item[2], Ncom.Text, four.Text, Colrcp.Item[3], Colrcp.Item[4], Colrcp.Item[5], Colrcp.Item[6 + $o], Colrcp.Item[10 + $o], Colrcp.Item[9 + $o], .Cdate_Dbase(datej.Text), Colrcp.Item[0], Colrcp.Item[15 + $o], Colrcp.Item[17 + $o], Colrcp.Item[6], Colrcp.Item[7])
          Else
            Utils.db.Exec("INSERT INTO " & Tab & "(code,design,numcom,four,pbht,rm,paht,qte,frais,prvt, datecom, nligne, coda, pattc) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14})", Colrcp.Item[1], Colrcp.Item[2], Ncom.Text, four.Text, Colrcp.Item[3], Colrcp.Item[4], Colrcp.Item[5], Colrcp.Item[6 + $o], Colrcp.Item[10 + $o], Colrcp.Item[9 + $o], .Cdate_Dbase(datej.Text), Colrcp.Item[0], Colrcp.Item[15 + $o], Colrcp.Item[17 + $o])
        Endif 
        Until Colrcp.Movenext()
      Endif
      'Maj_Quantite2()
      DocActif.Free_Lock("CommandeF", ncom.Text)
      RazBl()
      four.Clear
      fournom.Clear
      Colrcp.Clear
      Refart.Value = True
      b = 0
      Tcom.background = CoulTc
      Franco.Text = "0,00"
      Minimum.Text = "0,00"
      Nouveau = True
      Colhisto.Clear
    Else
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Veuillez saisir un code fournisseur SVP !")
      b = 1
      Stop Event
    Endif
  End With
Catch
  If Start.son Then
    Music.Play
  Endif
  message.Warning("Enregistrement impossible, Il y a une anomalie dans la commande !")

End

'************************************************
'* On appelle la liste des commandes            *
'************************************************
Public Sub ToggleButton3_Click()

  Dim Tab As String
  Dim Tab1 As String
  Dim Rentcom As Result
  Dim NmF As Result

  Tab = "Fiches_Entcom"
  Tab1 = "Fiches_Four"
  With Utils
    If Colrcp.Count Then
      Enrgcom()
      Colrcp.Clear()
      'RazBl()
    Endif
    If Colcom.visible Then
      Colcom.clear
      Colcom.visible = False
    Else
      Colcom.visible = True
      Colcom.Raise
      Colcom.Columns.count = 5
      Colcom.Columns[0].Width = 74
      Colcom.Columns[1].Width = 280
      Colcom.Columns[2].Width = 75
      Colcom.Columns[3].Width = 96
      Colcom.Columns[0].Text = "Code"
      Colcom.Columns[1].Text = "                        Nom"
      Colcom.Columns[2].Text = "  N° Commande"
      Colcom.Columns[3].Text = "        Date"
      Colcom.Columns[4].Alignment = 2
      Colcom.Columns[4].Text = "Montant      "
      If Not Dne Then
        Rentcom = Utils.db.Exec("SELECT * FROM " & Tab & " ")
      Else
        Rentcom = Utils.db.Exec("SELECT * FROM " & Tab & " where left(numcom,'" & Len(Ncom.Text) & "') = '" & Ncom.Text & "'")
      Endif
      If Rentcom.Available Then
        Do
          Colcom.Add(Rentcom!numcom & Rentcom!four, Rentcom!numcom & Rentcom!four)
          Colcom.Item[0] = Rentcom!four
          NmF = Utils.db.Exec("SELECT * FROM " & Tab1 & " where fo_code = &1", Rentcom!four)
          Try Colcom.Item[1] = Nmf!fo_nom
          If Error Then message.Error("le fournisseur " & Rentcom!four & " n'existe pas ! Veuillez modifier le code fournisseur de cette commande SVP")
          Colcom.Item[2] = Rentcom!numcom
          Colcom.Item[3] = .Cdate_Aff(Rentcom!ddate)
          Colcom.Item[4] = Format$(Rentcom!montant, "0.00")
        Loop Until Rentcom.MoveNext()
        Colcom.MoveFirst
        Colcom.SetFocus
        Try Colcom.Item.Selected = True
      Endif
    Endif
  End With

End

'**************************************************
'*     Selection d'une commande a la souris       *
'**************************************************
Public Sub Colcom_Click()

  Dim LigResult As Result
  Dim fourResult As Result
  Dim ArtResult As Result

  Colrcp.Clear
  If Colrcp.count = 0 Then
    Tab = "Fiches_Four"
    Tab2 = "Fiches_Art"
    Totalrcpt.Text = "0,00"
    Tfrais.text = "0,00"
    Pcom.text = "0,000"
    four.text = Colcom.Current[0]
    Ncom.Text = Colcom.Current[2]
    DocActif.Get_Lock("CommandeF", ncom.Text)
    datej.Text = Left$(Colcom.Current[3], 2) & "." & Mid$(Colcom.Current[3], 4, 2) & "." & Right$(Colcom.Current[3], 4)
    fourResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE fo_code = &1", four.Text)
    Try fournom.Text = fourResult!fo_nom
    Try Franco.Text = Format$(fourResult!fo_franco, "0.00")
    Try Email = fourResult!fo_email
    bCentrale = fourResult!fo_centrale
    If bCentrale = True Then
      Refcentrale.value = True
      TextLabel27.text = "Ref centrale"
      Tartfourn2.Visible = False
    Endif
    scentraleF = fourResult!fo_ccentrale
    With Utils
      Tab = "Fiches_Ligcom"
      LigResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE numcom = &1 and four = &2 order by nligne", Ncom.Text, four.Text)
      If LigResult.Available Then
        Do
          Nlgn = Format$(Val(Nlgn) + 1, "0000")
          Try Colrcp.Add(LigResult!code, LigResult!code)
          If Error Then Colrcp.Add(LigResult!nligne, LigResult!nligne)
          Colrcp.Item[0] = Nlgn
          Colrcp.Item[1] = LigResult!code
          ArtResult = Utils.db.Exec("SELECT * FROM " & tab2 & " WHERE art_code = &1", LigResult!code)
          If Not ArtResult.Available Then ArtResult = Utils.db.Exec("SELECT * FROM " & tab2 & " WHERE art_cfour = &1", LigResult!code)
          If Not ArtResult.Available Then ArtResult = Utils.db.Exec("SELECT * FROM " & tab2 & " WHERE art_refcentrale = &1", LigResult!code)
          Txtva = CPrix.CTva(ArtResult!art_tva)
          nbdec = .Find_nbdec(ArtResult!art_nbd)
          Colrcp.Item[2] = LigResult!design
          Colrcp.Item[3] = Format$(Val(.cpoint(LigResult!pbht)), Nbdec)
          If Len(Colrcp.Item[3]) - InStr(Colrcp.Item[3], ",") = 2 Then
            Colrcp.Item[3] = Colrcp.Item[3] & " "
          Endif
          Colrcp.Item[4] = LigResult!rm
          Colrcp.Item[5] = Format$(Val(.cpoint(LigResult!paht)), Nbdec)
          If Len(Colrcp.Item[5]) - InStr(Colrcp.Item[5], ",") = 2 Then
            Colrcp.Item[5] = Colrcp.Item[5] & " "
          Endif
          If $soption = "B" Or $soption = "T" Then
            Colrcp.Item[6] = LigResult!palet
            Colrcp.Item[7] = LigResult!coli
          Endif
          Colrcp.Item[6 + $o] = LigResult!qte
          Try Colrcp.Item[14 + $o] = Format$(Val(LigResult!qte) * ArtResult!art_poids2, "0.000")
          Colrcp.Item[15 + $o] = LigResult!coda
          Colrcp.Item[7 + $o] = Format$(Val(.cpoint(LigResult!paht)) * Val(.cpoint(LigResult!qte)), nbdec)
          If Len(Colrcp.Item[7 + $o]) - InStr(Colrcp.Item[7 + $o], ",") = 2 Then Colrcp.Item[7 + $o] = Colrcp.Item[7 + $o] & " "
          Totalrcpt.Text = Format$(Val(.cpoint(Totalrcpt.Text)) + (Val(.cpoint(Colrcp.Item[7 + $o]))), "0.00")
          If Len(LigResult!prvt) - InStr(LigResult!prvt, ",") = 2 Then
            Colrcp.Item[9 + $o] = LigResult!prvt & " "
          Else
            Colrcp.Item[9 + $o] = LigResult!prvt
          Endif
          Colrcp.Item[10 + $o] = LigResult!frais
          If IsNull(Colrcp.Item[9 + $o]) Then Colrcp.Item[9 + $o] = "0"
          If IsNull(Colrcp.Item[10 + $o]) Then Colrcp.Item[10 + $o] = "0"
          Colrcp.Item[17 + $o] = Format$(Val(Colrcp.Item[7 + $o]) + (Val(Colrcp.Item[7 + $o]) * Val(.cpoint(Txtva)) / 100), nbdec)
          Colrcp.Item[8 + $o] = ArtResult!art_cbarre
          Cart.text = LigResult!code
          GestCoul(Cart.Text)
          'Try pttc = Val(.cpoint(pttc)) + Val(.cpoint(Colrcp.Item[17]))
          Utils.db.Exec("delete from " & Tab & " WHERE numcom = &1 and four = &2 and code = &3", Ncom.Text, four.Text, LigResult!code)
        Loop Until LigResult.MoveNext()
        bas_doc()
      Endif
      Tab = "Fiches_Entcom"
      Utils.db.Exec("delete from " & Tab & " WHERE numcom = &1 and four = &2", Ncom.Text, four.Text)
    End With
    Colcom.clear
    Colcom.visible = False
    Cart.SetFocus
    Cart.Select
    Nouveau = False
    Maj_Quantite()
    Reaff_bl()
    lcolrcp()
  Else
    If Start.son Then
      Music.Play
    Endif
    Message.Warning("Veuillez valider votre commande en cours SVP !", "Ok")
    Colcom.clear
    Colcom.visible = False
  Endif
Catch
  If Start.son Then
    Music.Play
  Endif
  message.Error("Une (ou plusieurs) ligne de la commande n'a pas pu être récupérée !\nVeuillez contrôler votre commande SVP")
  Colcom.Visible = False

End

'***************************************************
'* Selection d'une commande manuellement sur colcom*
'***************************************************
Public Sub Colcom_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcom_Click()
  Endif
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcom.visible = False
    Colcom.clear
    four.SetFocus
    Stop Event
  Endif

End

'************************************************
'* Saisie d'une commande manuellement en direct *
'************************************************
Public Sub ColcomMan()

  Dim LigResult As Result

  Tab = "Fiches_Entcom"
  LigResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE numbl = &1", Ncom.Text)
  four.Text = LigResult!four
Catch
  If Start.son Then
    Music.Play
  Endif
  Message.Warning("Cette commande n'existe pas !")

End

'**************************************
'*     Suppression  de commande       *
'**************************************
Public Sub Delcom()

  Dim dcom As String = ncom.Text

  With Utils
    If Colrcp.Count <> 0 Then
      If Start.son Then
        Music.Play
      Endif
      Tab = "Fiches_Ligcom"
      Utils.db.Exec("delete from " & Tab & " WHERE numcom = &1 and four = &2 and datecom = &3", Ncom.Text, four.Text, .Cdate_Dbase(datej.Text))
      Tab = "Fiches_Entcom"
      Utils.db.Exec("delete from " & Tab & " WHERE numcom = &1 and four = &2", Ncom.Text, four.Text)
      RazBl()
      four.Clear
      fournom.Clear
      Colrcp.Clear
    Endif
  End With
  
  If dcom <> Null Then DocActif.Free_Lock("CommandeF", dcom)
  Ncom.Text = ""

End

'******************************
'*        On imprime          *
'******************************
Public Sub Impcom(Org As String)

  Dim fourResult As Result
  Dim Rsoc As Result
  Dim RefResult As Result
  Dim Tab As String
  Dim Tab1 As String
  Dim Tab2 As String
  Dim Tab3 As String
  Dim adr11 As String
  Dim adr22 As String
  Dim adr1, Libre As String
  Dim adr2 As String
  Dim ville As String
  Dim cp As String
  Dim Rs As String
  Dim Rs2 As String
  Dim Mail As String
  Dim Rcs As String
  Dim Siret As String
  Dim Tvaintra As String
  Dim Cap As String
  Dim Ape As String
  Dim Iban As String
  Dim Tel As String
  Dim portable As String
  Dim Fax As String
  Dim site As String
  Dim p As Integer
  Dim code As String
  Dim intitule As String
  Dim intitule2 As String
  Dim dater As String
  Dim qte As String
  Dim pbht As String
  Dim rm As String
  Dim paht As String
  Dim totht As String
  Dim Totcom As String
  Dim codef As String
  Dim telf As String
  Dim nbl As String
  Dim dte As String
  Dim Logo As Image
  Dim LstFour, codecli As String
  Dim Cfac As Boolean = False

  PosY = 105
  dte = Format$(Now, "dd.mm.yyyy")
  Tab = "Fiches_Ligcom"
  Tab1 = "Fiches_Art"
  Tab2 = "Fiches_Four"
  totcom = "0,00"
  With Utils
    p = 0
    If Colrcp.Count <> 0 Then
      Shell "cd " & User.Home & ""
      Filename = User.Home & "/tmp/Commande.pdf"
      pdf = New Cdocuments("Portrait", "mm", "A4")
      pdf.Open()
      pdf.AliasNbPages()
      If Start.LocalSettings["/Soc" & Start.Societe & "/glogo"] Then Try Logo = Start.LocalSettings["/Soc" & Start.Societe & "/Logo"]
      p = p + 2
      Me.Mouse = Mouse.Wait
      nbl = Ncom.Text
      codef = four.text
      dater = datej.Text
      Tab3 = "Fiches_Societes"
      Rsoc = Utils.db.Exec("SELECT * FROM " & tab3 & " where cd_sc = &1", Start.Societe)
      Rs = Rsoc!type_sc & " " & Rsoc!int_sc
      adr11 = Rsoc!adr1_sc
      adr22 = Rsoc!adr2_sc
      Libre = Rsoc!libre
      ville = Rsoc!cp_sc & "  " & Rsoc!burdis_sc
      If Rsoc!villerc_sc Then Rcs = "Rcs : " & Rsoc!rcs_sc & " " & Rsoc!villerc_sc
      If Rsoc!siret_sc Then Siret = "Siret : " & Rsoc!siret_sc
      If Rsoc!tvaintra_sc Then Tvaintra = "Tva intra : " & Rsoc!tvaintra_sc
      If Rsoc!cap_sc Then Cap = "Capital : " & Rsoc!cap_sc
      If Rsoc!ape_sc Then Ape = "APE : " & Rsoc!ape_sc
      If Rsoc!tel_sc Then Tel = "Tel : " & Rsoc!tel_sc
      If Rsoc!port_sc Then portable = "Portable : " & Rsoc!port_sc
      If Rsoc!fax_sc Then Fax = "Fax : " & Rsoc!fax_sc
      If Rsoc!email_sc Then Mail = "Courriel : " & Rsoc!email_sc
      If Rsoc!site Then site = "site : " & Rsoc!site
      If Rsoc!banq Then Iban = "Iban : " & Rsoc!banq & " Bic : " & Rsoc!bic
      fourResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE fo_code = &1 ", codef)
      If fourResult.Available Then
        Rs2 = fourResult!fo_rs_soc & " " & fourResult!fo_nom & " " & fourResult!fo_pnm
        adr1 = fourResult!fo_adr1
        adr2 = fourResult!fo_adr2
        cp = fourResult!fo_cd_ptl & " " & fourResult!fo_ville
        telf = fourResult!fo_tel_std
        Pays = fourResult!fo_pays
        Cfac = fourResult!fo_copie
        codecli = fourResult!fo_cd_cli
        If Pays = "France" Then Pays = ""
      Endif
      LstFour = "Commande n° " & nbl & " du " & dater
      Codef = "Code : " & Codef & "  Tel : " & telf
      pdf.Entete(Rs, adr11, adr22, ville, Cap, Rcs, Siret, Ape, Tvaintra, tel, portable, fax, mail, site, False, Pays, Iban, False, Libre)
      pdf.Entete2(rs2, adr1, adr2, cp, pays, "", False)
      pdf.Level1(LstFour, codef)
      pdf.Level1bis(Codecli)
      pdf.Level2(radioButton1.Value)
      Colrcp.MoveFirst
      Repeat
        Colrcp.Item.Selected = True
        RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_code = &1 ", Colrcp.Item[1])
        If RefResult.Available Then
          code = Colrcp.Item[1]
          intitule2 = RefResult!art_design2
        Else
          RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_cfour = &1 ", Colrcp.Item[1])
          If RefResult.Available Then
            code = RefResult!art_cfour
            intitule2 = RefResult!art_design2
          Else
            RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_refcentrale = &1 ", Colrcp.Item[1])
            If RefResult.Available Then
              code = RefResult!art_refcentrale
              intitule2 = RefResult!art_design2
            Endif
          Endif
        Endif
        Barcode = RefResult!art_cbarre
        intitule = Left$(Colrcp.Item[2], 48)
        qte = Colrcp.Item[6 + $o]
        pbht = Colrcp.Item[3]
        If Len(pbht) - InStr(pbht, ",") = 2 Then pbht = pbht & " "
        rm = Colrcp.Item[4]
        paht = Colrcp.Item[5]
        If Len(paht) - InStr(paht, ",") = 2 Then paht = paht & " "
        totht = Format$(Val(qte) * Val(paht), " 0.00")
        Totcom = Format$(Val(Totcom) + Val(Totht), " 0.00")
        Inc p
        If RadioButton1.value = True Then
          pdf.level3(code, intitule, qte, pbht, rm, paht, totht, Barre.value, Barcode, PosY)
        Else
          pdf.level3(code, intitule, qte, "", "", "", "", Barre.value, Barcode, PosY)
        Endif
        PosY = PosY + 5
        If Desg2.Value = True Then
          If intitule2 Then
            pdf.level3bis(intitule2, PosY)
            posy = posy + 5
          Endif
        Endif
        If PosY > 280 Then
          pdf.Entete(Rs, adr11, adr22, ville, Cap, Rcs, Siret, Ape, Tvaintra, tel, portable, fax, mail, site, "", Pays, Iban, False, Libre)
          pdf.Entete2(rs2, adr1, adr2, cp, pays, "", False)
          pdf.Level1(LstFour, codef)
          pdf.Level2(radioButton1.Value)
          PosY = 105
        Endif
      Until Colrcp.Movenext()
      If RadioButton1.Value = True Then pdf.level4(totcom, PosY + 5)
      pdf.Output(Filename, False)
      Wait 0.5
      If Org <> "M" Then Visualiseur.Prog(Filename)
      Copie.Dupli(Filename, "/Impressions", "Commande", datej.Text)
      Piece = Filename
      If Cfac Then Copie.Dupli5("Commande.pdf", datej.Text, Four.Text, "C" & Ncom.text & Fournom.Text, Fournom.text & "," & Ncom.Text, "Commande")
      Me.Mouse = Mouse.Default
    Endif
  End With

End

Public Sub Tartfourn2_Click()

  If Tartfourn2.Value = True Then
    Textlabel3.Text = "Ref article"
  Endif

End

Public Sub Reaff_bl()

  Dim Reaff As Result

  Tab = "Fiches_Art"
  If Colrcp.count Then
    Colrcp.MoveFirst
    Do
      Colrcp.Item.Selected = True
      If Refart.value = True Then
        reaff = Utils.db.Exec("SELECT * FROM " & Tab & " where art_cfour = &1 and art_four = &2", Colrcp.Item[1], Four.Text)
        If Not IsNull(Colrcp.Item[15 + $o]) Then Try Colrcp.Item[1] = Colrcp.Item[15 + $o]
        If Error Then
          reaff = Utils.db.Exec("SELECT * FROM " & Tab & " where art_refcentrale = &1 and art_four = &2", Colrcp.Item[1], Four.text)
          Try Colrcp.Item[1] = reaff!art_code
        Endif
      Else
        If Reffour.value = True Then
          reaff = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1 and art_four = &2", Colrcp.Item[1], Four.Text)
          If Reaff.Available Then
            If Not IsNull(reaff!art_cfour) Then
              Colrcp.Item[1] = reaff!art_cfour
            Else
              Colrcp.Item[1] = reaff!art_code
            Endif
          Endif
        Else
          If Refcentrale.value = True Then
            reaff = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Colrcp.Item[1])
            If Reaff.Available Then
              If Not IsNull(reaff!art_refcentrale) Then
                Colrcp.Item[1] = reaff!art_refcentrale
              Else
                Colrcp.Item[1] = reaff!art_code
              Endif
            Endif
          Endif
        Endif
      Endif
    Loop Until Colrcp.MoveNext()
  Endif

End

Public Sub ListFour()

  Dim rarts As Result
  Dim Tabl, Tab2 As String
  Dim Nbpage As Integer

  Nbpage = 1
  Tabl = "Fiches_Ligcom"
  Tab2 = "Rupture"
  Crupt.Rupture(True, True, "40100001", "40199999", "0000000000000", "ZZZZZZZZZZZZZ", "EdRup")
  Utils.db.Exec("delete from " & Tab2 & " WHERE qtecom <= &1", 0)
  Rarts = Utils.db.Exec("SELECT * FROM " & Tab2 & " left join " & Cbase.Table("TabFour") & "  on fo_code = four where qtecom is not null order by four")
  If Rarts.Available Then
    Do
      Try LstFour.Add(Rarts!four, rarts!four)
      If Not Error Then
        Lstfour.Item[0] = rarts!four
        Lstfour.Item[1] = rarts!fo_nom
      Endif
    Loop Until Rarts.MoveNext()
    Lstfour.visible = True
    Lstfour.Raise
    Me.Mouse = Mouse.Default
  Else
    Me.Mouse = Mouse.Default
    If son Then
      Music.Play
    Endif
    message(" Aucun article pour cette demande", "OK")
  Endif

End

Public Sub LstFour_Click()

  four.Text = Lstfour.Item[0]
  LstFour.Clear
  LstFour.Visible = False
  Fourman()

End

Public Sub LstFour_KeyPress()

  If Key.code = Key.Esc Or If Key.code = Key.F2 Then
    LstFour.Clear
    LstFour.Visible = False
  Endif

End

Public Sub Refart_Click()

  Reaff_bl()

End

Public Sub Reffour_Click()

  Reaff_bl()

End

Public Sub Refcentrale_Click()

  Reaff_bl()

End

'****************************************Gestion des articles**************************************************
Public Sub SelectionArt()

  Dim sel As String = ""
  Dim MyForm As TriArticles
  Dim sFour As String = ""
  Dim $centrale As String = ""

  Tab = "Fiches_Art"
  sel = ""
  Tri = "art_code"
  If Tartfourn2.Value = True Then sFour = Four.Text
  If Not IsNull(sCentraleF) And If Tartfourn2.Value = True Then
    sFour = sCentraleF
    $centrale = "Centrale"
  Endif
  MyForm = New TriArticles("", "", Tri, "Commande", sFour, $centrale)
  MyForm.Showmodal()
  If Variables.Bselection = True Then
    Cart.text = Variables.ArtCode
    Art_Man()
    Qtecom.SetFocus
    Qtecom.Select
    If $inbot <> 0 Then
      qtecom.Unselect
      $textcol.SetFocus
      $textcol.Select
    Endif
    If $incol <> 0 Then
      $textcol.Unselect 
      $textpal.SetFocus
      $textpal.Select
    Endif
    
  Endif

End

'***********************************
'*   on génère un fichier texte    *
'***********************************
Public Sub GenFic()

  Dim code, filetxt As String
  Dim tab1 As String = "Fiches_Art"
  Dim hFile As File
  Dim RefResult As Result

  If Colrcp.Count <> 0 Then
    Shell "cd " & User.Home & ""
    filetxt = User.home & "/commande.csv"
    If Exist(filetxt) Then Kill filetxt
    hFile = Open filetxt For Write Create
    Colrcp.MoveFirst
    Repeat
      Colrcp.Item.Selected = True
      RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_code = &1 ", Colrcp.Item[1])
      If RefResult.Available Then
        code = Colrcp.Item[1]
      Else
        RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_cfour = &1 ", Colrcp.Item[1])
        If RefResult.Available Then
          code = RefResult!art_cfour
        Else
          RefResult = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE art_refcentrale = &1 ", Colrcp.Item[1])
          If RefResult.Available Then
            code = RefResult!art_refcentrale
          Endif
        Endif
      Endif
      Print #hFile, code & ";" & Colrcp.Item[6 + $o]
    Until Colrcp.Movenext()
    Message.Info("Traitement terminé!\n Le fichier commande .txt a été généré sous votre repertoire.")
  Else
    Message.Info("Ce traitement doit se faire après la saisie de la commande!")
  Endif

End

'***********************************
'*       On gère le mail           *
'***********************************
Public Sub Button13_Click()

  Dim CrtResult As Result

  If Panel7.Visible = False Then
    Org = "M"
    Panel7.Visible = True
    ComboBox1.Visible = True
    ComboBox1.Clear
    Label2.Text = " Envoi de commande"
    Button14.text = "Envoyer"
    CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMailFour") & " where code = &1 order by mail", Four.text)
    If CrtResult.Available Then
      Repeat
        ComboBox1.Add(CrtResult!mail)
      Until CrtResult.MoveNext()
    Endif
    CrtResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContactF") & " where code = &1 order by num", Four.text)
    If CrtResult.Available Then
      Do
        ComboBox1.Add(CrtResult!nom & " " & CrtResult!pnm & " | " & CrtResult!mail)
      Loop Until CrtResult.MoveNext()
    Endif
    'If Not IsNull(Email) Then Combobox1.Text = Fournom.Text & " | " & Email
    ComboBox1.SetFocus
  Else
    Panel7.Visible = False
    ComboBox1.Visible = False
    ComboBox1.Clear
  Endif

End

Public Sub ComboBox1_KeyPress()

  If Key.code = Key.Esc Or Key.code = Key.Escape Then
    Panel7.Visible = False
    ComboBox1.Clear
  Endif

End

Public Sub Mail()

  Dim sText As String
  Dim sText2 As String
  Dim tMail As String[]

  Tmail = Split(Combobox1.Text, "|")
  Try Email = Replace$(Tmail[1], " ", "")
  If Error Then Email = Combobox1.Text
  Impcom("M")
  If IsNull(Piece) Then
    Message.Info("Vous devez imprimer votre bon de commande avant de l'envoyer")
    Return
  Endif
  If Colrcp.count > 0 Then
    If Not IsNull(Email) Then
      sText = "Notre commande du " & Format$(Now, "dd.mm.yyyy")
      stext2 = "Bonjour,\nMerci de bien vouloir prendre en compte notre commande ci_jointe\nCordialement."
      'Exec ["xdg-email", "--attach", Piece, "--subject", sText, "--body", sText2, Email]
      EnvMail.Envoi2(Email, stext, sText2, Piece)
    Else
      Message.Warning("Ce fournisseur n'a pas de d'adresse mail ! Envoi impossible")
    Endif
  Endif

End

Public Sub Coulfond()

  Dim ob As Object

  If Colrcp.count > 0 Then
    Colrcp.MoveFirst
    Repeat
      Colrcp.Item.Selected = True
      ob = Colrcp.Children[0]
      Artcomm("Reaff")
      If ComCli > 0 Then
        ob[ob.Row, 0].Background = &00B4F1B4
      Else
        ob[ob.Row, 0].Background = &00FFFFFF
      Endif
    Until Colrcp.MoveNext()
  Endif

End

Public Sub GestCoul(Carticle As String)

  Dim ob As Object
 
  Artcomm("Artman")
  Colrcp.Item.Selected = True
  ob = Colrcp.Children[0]
  If ComCli > 0 Then
    ob[ob.Row, 0].Background = &00B4F1B4
  Else
    ob[ob.Row, 0].Background = &00FFFFFF
  Endif
  Cart.Clear

End

Public Sub modifecran()

  Dim lab As Label
  Dim coef As Float
  
  coef = Panel2.Width / 920
  TextLabel19.Move(8 * coef, 160 * coef)
  TextLabel23.Move(136 * coef, 160 * coef)
  TextLabel24.Move(200 * coef, 160 * coef)
  TextLabel18.Move(328 * coef, 160 * coef)
  TextLabel20.Move(392 * coef, 160 * coef)
  TextLabel22.Move(512 * coef, 160 * coef)
  TextLabel21.Move(633 * coef, 160 * coef)
  TextLabel10.Move(704 * coef, 160 * coef)
  Tx2.Move(736 * coef, 160 * coef)
  Nmfour.Move(8 * coef, 136 * coef)
  pbht.Move(360 * coef, 136 * coef)
  Tva.Move(488 * coef, 136 * coef)
  tr.Move(536 * coef, 136 * coef)
  Panel6.Move(632 * coef, 136 * coef)
  paht.Move(632 * coef, 136 * coef)
  Button1.Move(769 * coef, 134 * coef)
  TextLabel13.Move(8 * coef, 120 * coef)
  TextLabel7.Move(352 * coef, 120 * coef)
  TextLabel12.Move(488 * coef, 120 * coef)
  TextLabel8.Move(536 * coef, 120 * coef)
  TextLabel9.Move(640 * coef, 120 * coef)
  Dart.Move(8 * coef, 80 * coef)
  TextLabel14.Move(8 * coef, 56 * coef)
  qtecom.Move(800 * coef, 96 * coef)
  TextLabel6.Move(712 * coef, 96 * coef, 80 * coef, 24 * coef)
  TextLabel6.Text = "Qté"
  lab = New Label(panel2)
  lab.Move(360 * coef, 96 * coef, 60 * coef, 24 * coef)
  lab.Text = "Palettes"
  lab.Alignment = Align.Center
  $textpal = New TextBox(Panel2) As "Rcpt"
  $textpal.Tag = 15
  $textpal.Move(448 * coef, 96 * coef, 80 * coef, 24 * coef)
  $textpal.Alignment = Align.Right
  lab = New Label(panel2)
  lab.Move(536 * coef, 96 * coef, 50 * coef, 24 * coef)
  lab.text = "Colis"
  lab.Alignment = Align.Center
  $textcol = New TextBox(panel2) As "Rcpt"
  $textcol.Move(624 * coef, 96 * coef, 80 * coef, 24 * coef)
  $textcol.Alignment = Align.Right
  $textcol.Tag = 16
  $checcons = New CheckBox(panel2)
  $checcons.Move(708 * coef, 66 * coef, 84 * coef, 24 * coef)
  $checcons.Text = "Consigne"
  $checcons.Background = &HD4D0C8&
  $checcons.Enabled = False
  
End
'********************
'* On lance la doc  *
'********************
Public Sub Button4_Click()

  Doc.Open("Commandes")

End
