' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à  " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# Nom du fichier           : Saisecrit.class
'# Auteur                   : Jacky Tripoteau
'# Date de création         : 01/11/2004
'# Saisie des écritures d'achat, de ventes et d'OD
'################################################
'
Private hForm As FCalc
Private Type As String
Private type_jour As String
Private Cnt As String
Private n As Integer
Private soldec As Float
Private compte_tva As String
Private montantdb As Float
Private montantcd As Float
Private montantht As Float
Private Totalcd As Float
Private Totaldb As Float
Private Modif As String
Private Vld As Boolean
Private Prov As Boolean
Private numCpt As String
Private Gntva As Boolean
Private num As Integer
Private tva As Float
Private ecriture As String
Private supp As Integer
Private B As Integer
Private txt As String
Private dte3 As String
Private nvlle As Integer
Private son As Integer = Start.Son
Private Dne As String
Private Itm As String
Private Cle As String
Private Prg As String
Private Ncpt As String
Private Numr As String = ""
Private LF As Integer = 0 ' sert a gerer la perte du focus. Si LF = 0 on gere sinon on ne gere pas.
Private Tri As String
Private sel As String
Private Nv As Integer = 0
Private Numcvtl As String
Private TypeAbt As String
Private ecrA As String = "0"
Private numlig As Integer = 1
Private sLind As String
Private hder As TextBox
Private Sjour As String 'on mémorise le numéro du journal
Private Ext As Boolean = False
Private Ech As String
Private avoir As Boolean = False
Private $libelle As String
Private $cpt As String

'************************************************
'*         On initialise notre écran            *
'************************************************
Public Sub _new(num2 As String)
  
  Dim WidthCol As String
  Dim s As String
  Dim spl As New String[7]
  
  Try WidthCol = Settings["/Soc" & Start.Societe & "/Col/LcolS"]
  If Not IsNull(num2) Then Ext = True
  numr = num2
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  Music.Load(Start.Musique)
  Me.Center
  nvlle = 1
  n = 1
  soldec = 0
  Montant.Text = "0"
  Prg = "2"
  Ecrit1.Columns.count = 7
  If Not IsNull(WidthCol) Then
    WidthCol = Trim(WidthCol)
    If Right(WidthCol, 1) = ";" Then WidthCol = Left(WidthCol, Len(WidthCol) - 1)
    For Each s In Split(LCase(WidthCol), ";")
      spl = Scan(s, "*:*")
      Select Case Trim(spl[0])
        Case "col0"
          Try Ecrit1.Columns[0].Width = 0
        Case "col1"
          Try Ecrit1.Columns[1].Width = Val(spl[1])
        Case "col2"
          Try Ecrit1.Columns[2].Width = spl[1]
        Case "col3"
          Try Ecrit1.Columns[3].Width = spl[1]
        Case "col4"
          Try Ecrit1.Columns[4].Width = spl[1]
        Case "col5"
          Try Ecrit1.Columns[5].Width = spl[1]
        Case "col6"
          Try Ecrit1.Columns[6].Width = spl[1]
          If Ecrit1.Columns[6].Width > 80 Then Ecrit1.Columns[6].Width = 80
      End Select
    Next
  Else
    Ecrit1.Columns[0].Width = 0
    Ecrit1.Columns[1].Width = 80
    Ecrit1.Columns[2].Width = 260
    Ecrit1.Columns[3].Width = 100
    Ecrit1.Columns[4].Width = 100
    Ecrit1.Columns[5].Width = 110
    Ecrit1.Columns[6].Width = 110
  Endif
  Ecrit1.Columns[0].Text = ""
  Ecrit1.Columns[1].Text = "Compte"
  Ecrit1.Columns[2].Text = "Libellé"
  Ecrit1.Columns[3].Text = "N° document"
  Ecrit1.Columns[4].Text = "N° Lot"
  Ecrit1.Columns[5].Text = "Debit"
  Ecrit1.Columns[5].Alignment = 2
  Ecrit1.Columns[6].Text = "Credit"
  Ecrit1.Columns[6].Alignment = 2
  soldeecrit.Text = "0,00"
  cnt = 1
  Journal_Gotfocus()
  Journal.Select
  Journal.SetFocus
  If Not IsNull(numr) Then
    Nv = 1
    Ecrit_Click()
  Endif
  
End

'************************************************
'*        On remet les champs à  blanc          *
'************************************************
Public Sub Cleanchamps()
  
  numcompte.Clear
  Intitulcompte.Clear
  soldecompte.Clear
  Montant.Clear
  Codetva.Clear
  Tauxtva.Clear
  Montanttva.Clear
  montantdb = 0
  montantcd = 0
  If Val(soldeecrit.text) <> Null Then Ventilations.Visible = True
  
End

Public Function dateEcheance(Ech2 As String) As String
  
  Dim rech As Result
  Dim dureech As String
  Dim Jours As String
  Dim finmois As Boolean
  Dim Datef, Tab4 As String
  
  Tab4 = "Fiches_Echeances"
  If ech2 Then
    rech = Utils.db.Exec("SELECT * FROM " & tab4 & " where num = &1", Ech2)
    If rech.available Then
      dureech = rech!duree
      Jours = rech!jours
      finmois = rech!finmois
      Ech = "1"
    Else
      Ech = "0"
    Endif
  Else
    Ech = "0"
  Endif
  If Ech = "1" Then
    Datef = datej.Text
    dateech.text = Utils.Calcech(dureech, Jours, Finmois, Datef)
  Else
    dateech.text = datej.Text
  Endif
  
End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt_enter()
  
  Select Case Last.tag
    Case 1
      LF = 1
  End Select        
  
End

Public Sub Cmpt_leave()
  
  Select Case Last.tag
    Case 1
      LF = 0
  End Select
  
End

Public Sub Cmpt_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  Select Case Last.tag
    Case 1
      Sjour = Journal.Text
  End Select
  
End

'**********************************************************************************
'*  On met à  jour la base lors d'une validation ou d'un rappel d'une ligne        *
'**********************************************************************************
Public Sub Movt()
  
  Dim Mvts As Result
  
  With utils
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee,Pointee, numcol, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", Journal.Text, numecrit.Text, numcpt, Intitulcompte.Text, .Cdate_Dbase(Datej.Text), numdoc.Text, numlot.Text, Libelecrit.Text, montantdb, montantcd, 0, 1, 0, 0, 0, 0, ecrit1.Item[0], .Cdate_Dbase(Dateech.Text))
    ' On efface le columnview Ecrit1 et on récupère l'ensemble des lignes de l'écriture
    Ecrit1.Clear
    Mvts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numero = &1 and collectif is null order by cast(numcol as unsigned)", numecrit.Text)
    If Mvts.Available Then
      Repeat
        Ecrit1.Add(Mvts!lind, Mvts!lind)
        Ecrit1.Item[0] = Mvts!numcol
        '  Utils.db.Exec("UPDATE  " & Cbase.Table("TabMvt") & "  SET numcol = &1 where lind = &2", nl, rResult!lind)
        Ecrit1.Item[1] = Mvts!compte
        Ecrit1.Item[2] = Mvts!libelle
        If Left(Mvts!compte, 2) = "40" Then numcpt = Mvts!compte
        If Left(Mvts!compte, 2) = "41" Then numcpt = Mvts!compte
        Ecrit1.Item[3] = Mvts!numdoc
        Ecrit1.Item[4] = Mvts!numlot
        Ecrit1.Item[5] = Format$(Mvts!montantd, "0.00")
        Ecrit1.Item[6] = Format$(Mvts!montantc, "0.00")
        Ecrit1.Item[7] = Format$(CDate(Mvts!dte), "dd.mm.yyyy")
        Ecrit1.Item[8] = Mvts!intitule
        Ecrit1.Item[9] = Mvts!jour
        Ecrit1.Item[10] = Mvts!lind
        'INC nl
      Until Mvts.MoveNext()
      Datej.Text = Ecrit1.Item[7]
      Journal.Text = Ecrit1.Item[9]
      numdoc.Text = Ecrit1.Item[3]
      numlot.Text = Ecrit1.Item[4]
      If modif = 1 Then
        Libelecrit.Text = $libelle
      Else
        Libelecrit.Text = Ecrit1.Item[2]
      Endif
    Endif
  End With
  
End

'************************************************
'*  Recherche d'un compte par le bouton   *
'************************************************
Public Sub compte()
  
  Dim MyForm As TriComptes
  
  Comptabilite.Bsel = False 
  Tri = "cast(compte_cc AS char)"
  MyForm = New TriComptes(Tri, Type, "", "D4", "")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    Numcompte.text = Comptabilite.sCmpt
    If Not IsNull(Numcompte.Text) Then
      LF = 0
      numcpt = numcompte.Text
      Ncpt = Numcompte.text
      If Bclient.Value Or If Bfournisseur.Value Then
        compteman()
      Else
        compteGman()
      Endif
      Libelecrit.SetFocus
      Libelecrit.Select
    Else
      Intitulcompte.Clear
      Soldecompte.Clear
    Endif
  Else
    Numcompte.SetFocus
  Endif
  
End

'******************************************************************
'*  Recherche d'un compte tiers lors d'une saisie manuelle        *
'******************************************************************
Public Sub compteman()
  
  Dim Cmpts As Result
  
  B = 0
  If LF = 0 Then
    'type_jour = ""
    If journal.Text = "" Then
      If son Then
        Music.Play
      Endif
      Message.Error("Veuillez saisir votre Code journal SVP !")
      B = 2
      LF = 1
    Else
      If Bclient.Value = True Then
        type = "C"
        debit.Value = True
        credit.Value = False
      Else
        If Bfournisseur.Value = True Then
          type = "F"
          debit.Value = False
          credit.Value = True
        Endif
      Endif
      If IsNull(Numecrit.Text) Then
        If son Then
          Music.Play
        Endif
        Message.Error("Veuillez valider la date de l'écriture SVP !")
        B = 3
        LF = 1
      Endif
      If type = "C" And Left$(numcompte.Text, 2) <> "41" And soldec = 0 And numdoc.Text = "" And type_jour = "VE" Then
        If son Then
          Music.Play
        Endif
        Message.Error("Veuillez saisir un compte client \n dans un journal de type vente SVP !")
        B = 1
      Endif
      If type = "F" And Left$(numcompte.Text, 2) <> "40" And soldec = 0 And numdoc.Text = "" And type_jour = "AC" Then
        If son Then
          Music.Play
        Endif
        Message.Error("Veuillez saisir un compte fournisseur \n dans un journal de type achat SVP !")
        B = 1
      Endif
      If numdoc.Text <> "" And soldec = 0 Then
        If son Then
          Music.Play
        Endif
        Message.Error("Le solde de cette écriture est à  zéro ! \n Veuillez verifier avant de poursuivre SVP !")
        b = 1
      Else
        Sens_Ecr()
        If Left$(numcompte.Text, 2) = "40" Then 
          Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " left join " & Cbase.Table("TabFour") & " on fo_code = &2 WHERE compte_cc like '" & numcompte.Text & "%' and coll <> &1  order by compte_cc", 1, numcompte.Text)
        Else
          Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " left join " & Cbase.Table("TabCli") & " on cli_code = &2 WHERE compte_cc like '" & numcompte.Text & "%' and coll <> &1  order by compte_cc", 1, numcompte.Text) 
        Endif
        If Cmpts.Available Then
          If Cmpts!cprincipal = True Then
            Message.Warning("Saisie impossible sur ce compte !\nIl s'agit d'un compte principal")
            Return
          Endif
          If Cmpts!type_cc = type Then
            numcompte.Text = Cmpts!compte_cc
            Intitulcompte.Text = Cmpts!intitule_cc
            If Left$(numcompte.Text, 2) = "41" Then 
              Intitulcompte.Text = Cmpts!cli_nom & " " & Cmpts!cli_pnm
              Ech = Cmpts!cli_cdech
              dateEcheance(Ech)
            Else
              If Left$(numcompte.Text, 2) = "40" Then
                Intitulcompte.Text = Cmpts!fo_nom & " " & Cmpts!fo_pnm
                Ech = Cmpts!fo_cdech
                dateEcheance(Ech)
              Endif
            Endif
            If Left$(numcompte.Text, 2) = "40" Or Left$(numcompte.Text, 2) = "41" Then
              numcvtl = numcompte.text
              Libelecrit.Text = Intitulcompte.Text & " "
            Endif
            If Cmpts!solde <> "" Then
              soldecompte.Text = Format$(Cmpts!solde, "0.00")
            Endif
          Else
            b = 1
            If son Then
              Music.Play
            Endif
            message.Warning("Ce compte n'est pas du même type que la sélection !\n Verifiez votre saisie SVP !")
            Numcompte.Clear
            Numcompte.SetFocus
          Endif
        Else
          If son Then
            Music.Play
          Endif
          message.Warning("Ce compte n'existe pas ou est un collectif !\nVerifiez votre saisie SVP !")
          b = 1
        Endif
      Endif
    Endif
  Endif
Catch
  B = 1
  
End

'******************************************************************
'*  Recherche d'un compte général lors d'une saisie manuelle      *
'******************************************************************
Public Sub compteGman()
  
  Dim Cmpts As Result
  
  Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & "  WHERE compte_cc like '" & numcompte.Text & "%' and coll <> &1 order by compte_cc", 1)
  If Cmpts.Available Then
    If Cmpts!cprincipal = True Then
      Message.Warning("Saisie impossible sur ce compte !\nIl s'agit d'un compte principal")
      Return
    Endif
    If Cmpts!type_cc = "G" Or Cmpts!type_cc = "B" Then
      numcompte.Text = Cmpts!compte_cc
      Intitulcompte.Text = Cmpts!intitule_cc
      If Cmpts!solde <> "" Then
        soldecompte.Text = Format$(Cmpts!solde, "0.00")
      Endif
      Leccompteg()
      Montant_GotFocus()
      b = 0
    Else
      b = 1
      If son Then
        Music.Play
      Endif
      Try message.Warning("Ce compte n'est pas du même type que la sélection !\n Verifiez votre saisie SVP !")
      Numcompte.Clear
      Numcompte.SetFocus
    Endif
  Else
    If son Then
      Music.Play
    Endif
    If Not IsNull(Numcompte.Text) Then
      Try Message.Warning("Il n'existe aucun compte général commencant par " & Numcompte.Text & "\n veuillez verifier votre saisie SVP ! ", "OK")
    Endif
    b = 1
  Endif
  
End

'******************************************************************
'*  Recherche de la tva lors d'une sélection d'une ventilation    *
'******************************************************************
Public Sub Leccompteg()
  
  Dim Cmpts As Result
  
  Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & "  WHERE compte_cc = &1", numcompte.text)
  If Cmpts.Available Then
    If Left$(numcompte.Text, 1) = "7" Then
      Gntva = Cmpts!gen_tv
    Else
      Gntva = Cmpts!gen_ta
    Endif
    
    If Left$(numcompte.Text, 1) = "7" And Gntva = True Or If Type_jour = "VE" And Left$(numcompte.Text, 1) = "4" And Gntva = True Then
      codetva.Text = Cmpts!code_tvente
      Tauxtva.Text = Cmpts!taux_tvente
    Else
      If Left$(numcompte.Text, 1) = "6" And Gntva = True Or If Type_Jour = "AC" And Left$(numcompte.Text, 1) = "4" And Gntva = True Then
        Codetva.Text = Cmpts!code_tachat
        Tauxtva.Text = Cmpts!taux_tachat
      Endif
    Endif
  Endif
  numcompte.Setfocus
  
End

'*************************************************************
'*  Recherche d'un journal lors d'une saisie manuelle        *
'*************************************************************
Public Sub Journauxman()
  
  Dim journ As String
  Dim intitule As String
  Dim Journs As Result
  
  journ = Journal.text
  Journs = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabJour") & "  WHERE code_jo = &1", Journ)
  If Journs.Available Then
    If Journs!type_jo = "TR" Then
      b = 1
      If son Then
        Music.Play
      Endif
      message.Warning("Ce journal est un un journal de trésorerie !\n Veuillez saisir un autre code SVP !")
      Journal.Text = ""
      Datej.Text = ""
      Journal.SetFocus
    Else
      libelle.Text = Journs!libelle_jo
      type_jour = Journs!type_jo
      intitule = libelle.text
      Titre.Text = "Saisie des écritures du journal des " & intitule & " N° " & Journal.Text
      b = 0
    Endif
  Else
    b = 1
    If son Then
      Music.Play
    Endif
    message.Warning("Ce journal n'existe pas !\n Veuillez saisir un autre code SVP !")
    journal.Text = ""
    Datej.Text = ""
    Journal.SetFocus
  Endif
  If type_jour <> "AC" Then
    Type = "C"
    Bclient.Value = True
  Else
    Type = "F"
    Bfournisseur.Value = True
  Endif
  
End

'************************************************
'*  Recherche d'un journal avec le bouton       *
'************************************************

Public Sub Journaux()
  
  Dim Journs As Result
  
  cnt = "0"
  Jour.Visible = True
  Jour.clear
  Jour.Columns.count = 3
  Jour.Columns[0].Width = 60
  Jour.Columns[1].Width = 180
  Jour.Columns[2].Width = 50
  Jour.Columns[2].Alignment = 4
  Jour.Columns[0].Text = "Code"
  Jour.Columns[1].Text = "Libellé"
  Jour.Columns[2].Text = "Type"
  If Not Dne Then
    Journs = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabJour") & "  WHERE type_jo <> 'TR' order by code_jo")
  Else
    Journs = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabJour") & "  WHERE left(code_jo,'" & Len(Journal.Text) & "') = '" & Journal.Text & "'")
  Endif
  If Journs.Available Then
    Repeat
      Jour.Add(Journs!code_jo, Journs!code_jo)
      Jour.Item[0] = Journs!code_jo
      Jour.Item[1] = Journs!libelle_jo
      Jour.Item[2] = Journs!type_jo
    Until Journs.MoveNext()
    Jour.MoveFirst
    Jour.SetFocus
    Jour.Item.Selected = True
  Else
    If son Then
      Music.Play
    Endif
    message.Info("Aucun journal de type Vente ou Achat n'existe !")
    Jour.Visible = False
  Endif
  
End

'*****************************************************
'*  Récuperation du dernier numéro d'écriture        *
'*****************************************************
Public Sub Ecritures(numecr As String)
  
  Dim Params As Result
  
  Params = Utils.db.Exec("SELECT " & numecr & " FROM " & Cbase.Table("TabParam") & " ")
  If Params.Available Then
    num = Params["" & numecr & ""]
  Endif
  
End

'************************************************
'*  Mise a jour du dernier numéro d'écriture    *
'************************************************
Public Sub Majnum(numecr2 As String)
  
  Utils.db.Exec("UPDATE " & Cbase.Table("TabParam") & " set " & numecr2 & " = &1", numecrit.Text)
  
End

Public Sub ecritnv()
  
  Dim MyForm As TriEcritures
  
  Sel = ""
  Nv = 0
  Tri = "dte"
  Comptabilite.Bsel = False
  MyForm = New TriEcritures("0", Sel, "0")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    ecrit2()
  Endif
  
End

Public Sub ecritv()
  
  Dim MyForm As TriEcritures
  
  Sel = ""
  Nv = 1
  Tri = "dte"
  Comptabilite.Bsel = False
  MyForm = New TriEcritures("1", Sel, "0")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    ecrit3()
  Endif
  
End

'*********************************************************
'*     On récupère toutes les écritures provisoires      *
'*********************************************************
Public Sub Ecr1()
  
  Dim Mvts As Result
  
  Try Utils.db.Exec("LOCK TABLES " & Cbase.Table("Ecrs") & " WRITE")
  Try Utils.db.Exec("DROP TABLE if exists " & Cbase.Table("Ecrs") & "")
  Utils.db.EXEC("CREATE TABLE " & Cbase.Table("Ecrs") &
    " (jour Char(2) NOT NULL," &
    "intitule char(30) ," &
    "libelle char(30) ," &
    "dte date ," &
    "numero Integer(6) ," &
    "numdoc Char(10)," &
    "compte char(8) ," &
    "montantd Decimal(12,2)," &
    "montantc Decimal(12,2)," &
    "PRIMARY KEY (numero))" & "ENGINE = MYISAM")
  Mvts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE provisoire = &1 and tresorerie = &2 and cloturee = &3  and collectif is null order by dte, numero, compte", 1, 0, 0)
  If Mvts.Available Then
    Repeat
      Try Utils.db.Exec("INSERT INTO " & Cbase.Table("Ecrs") & "(jour,intitule,dte,numero,numdoc, compte, montantd, montantc, libelle) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9)", Mvts!jour, Mvts!libelle, Mvts!dte, Mvts!numero, Mvts!numdoc, Mvts!compte, Mvts!montantd, Mvts!montantc, Mvts!libelle)
    Until Mvts.MoveNext()
  Endif
  ecritnv()
  Utils.db.Exec("UNLOCK TABLES")
  
End

'*****************************************************
'*     On récupère toutes les écritures validées      *
'*****************************************************
Public Sub Ecr2()
  
  Dim Mvts As Result
  Dim tab As String
  Dim tab2 As String
  
  Tab = "Fiches_Mvt" 
  Tab2 = "Ecrs" 
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("Ecrs") & " WRITE")
  Utils.db.Exec("DROP TABLE if exists " & Tab2 & "")
  Utils.db.EXEC("CREATE TABLE " & Tab2 & 
    " (jour Char(2) NOT NULL," &
    "intitule char(30) ," &
    "libelle char(30) ," &
    "dte date ," &
    "numero Integer(6) ," &
    "numdoc Char(10)," &
    "compte char(8) ," &
    "montantd Decimal(12,2)," &
    "montantc Decimal(12,2)," &
    "PRIMARY KEY (numero))" & "ENGINE = MYISAM")
  Mvts = Utils.db.Exec("SELECT * FROM " & Tab & "  WHERE validee = &1 and tresorerie = &2 and cloturee = &3  and collectif is null order by dte, numero, compte", 1, 0, 0)
  If Mvts.Available Then
    Repeat
      Try Utils.db.Exec("INSERT INTO " & Tab2 & "(jour,intitule,dte,numero,numdoc, compte, montantd, montantc, libelle) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9)", Mvts!jour, Mvts!libelle, Mvts!dte, Mvts!numero, Mvts!numdoc, Mvts!compte, Mvts!montantd, Mvts!montantc, Mvts!libelle)
    Until Mvts.MoveNext()
  Endif
  ecritv()
  Utils.db.Exec("UNLOCK TABLES")
  
End

'*******************************************
'*  On affiche toutes les ventilations     *
'*******************************************
Public Sub ventil()
  
  Dim Vtls As Result
  
  Vtl.Clear
  Vtl.Columns.count = 2
  Vtl.Columns[0].Width = 80
  Vtl.Columns[1].Width = 180
  Vtl.Columns[0].Text = "Code"
  Vtl.Columns[1].Text = "Libellé"
  If Left(numcpt, 2) = "41" Then
    Vtls = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCliVtl") & "  WHERE Code = &1", numcvtl)
  Else
    Vtls = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFourVtl") & "  WHERE Code = &1", numcvtl)
  Endif
  If Vtls.Available Then
    Repeat
      Vtl.Add(Vtls!code_vtl, Vtls!code_vtl)
      Vtl.Item[0] = Vtls!code_vtl
      Vtl.Item[1] = Vtls!intitule_vtl
    Until Vtls.MoveNext()
  Endif
  numcompte_GotFocus()
  
End

'*************************************************
'*  On affiche le HT si une seule ventilation    *
'*************************************************
Public Sub ventilAuto()
  
  Dim Vtls As Result
  
  Vtl.Clear
  If Left(numcpt, 2) = "41" Then
    Vtls = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCliVtl") & "  WHERE Code = &1", numcpt)
  Else
    Vtls = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFourVtl") & "  WHERE Code = &1", numcpt)
  Endif
  If Vtls.Count = 1 Then
    numcompte.Text = Vtls!code_vtl
    Intitulcompte.Text = Vtls!intitule_vtl
    Montant.Text = "0,00"
    compteGman()
    Modif = "0"
    Montant_Gotfocus()
    Montant_LostFocus()
    Montant.SetFocus
    Montant.Select
  Endif
  numcompte_GotFocus()
  
End

'***********************************
'*  On affiche tous les libéllés   *
'***********************************
Public Sub Lib()
  
  Dim Libells As Result
  
  Libview.Clear
  Libview.Columns.count = 2
  Libview.Columns[0].Width = 80
  Libview.Columns[1].Width = 180
  Libview.Columns[0].Text = "Code"
  Libview.Columns[1].Text = "Libellé"
  Libells = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLibel") & " ")
  If Libells.Available Then
    Repeat
      Libview.Add(Libells!num, Libells!num)
      Libview.Item[0] = Libells!num
      Libview.Item[1] = Libells!intitule
    Until Libells.MoveNext()
    Libview.MoveFirst
    Libview.SetFocus
    Libview.Item.Selected = True
  Endif
  
End

'*************************
'*  On calcule la tva    *
'*************************
Public Sub Calctva()
  
  Dim Rtva As Result
  
  With utils
    If montant.Text = "" Then
      If son Then
        Music.Play
      Endif
      Message.Warning(" Attention ! Veuillez saisir un montant avant de valider votre ligne SVP !")
      numcompte_GotFocus()
    Endif
    If soldec <> 0 Then
      If Left$(numcompte.Text, 1) = "6" And gntva = True Or If Left$(numcompte.Text, 1) = "2" And gntva = True Then
        Rtva = Utils.db.Exec("select * from " & Cbase.Table("TabTvac") & " where code_tva = &1", codetva.text)
        If Rtva.Available Then
          compte_tva = Rtva!cc_tva
          If montant.Text <> 0 Then
            tva = (Val(.cpoint(montant.Text)) * Val(.Cpoint(Tauxtva.text))) / 100
            Montanttva.Text = Format$(tva, "0.00")
          Endif
          
        Endif
      Else
        If Left$(numcompte.Text, 1) = "7" And gntva = True Then
          Rtva = Utils.db.Exec("select * from " & Cbase.Table("TabTvav") & " where code_tva = &1", codetva.text)
          If Rtva.Available Then
            compte_tva = Rtva!cc_tva
            If montantht <> 0 Then
              tva = (Montantht * Val(.Cpoint(Tauxtva.text))) / 100
            Else
              tva = (Val(Montant.Text) * Val(.Cpoint(Tauxtva.text))) / 100
            Endif
            Montanttva.Text = Format$(tva, "0.00")
          Endif
        Else
          If Left$(numcompte.Text, 1) = "4" And gntva = True And type_jour = "AC" Then
            Rtva = Utils.db.Exec("select * from " & Cbase.Table("TabTvac") & " where code_tva = &1", codetva.text)
            If Rtva.Available Then
              compte_tva = Rtva!cc_tva
              If montantht <> 0 Then
                tva = (Montantht * Val(.Cpoint(Tauxtva.text))) / 100
              Else
                tva = (Val(Montant.Text) * Val(.Cpoint(Tauxtva.text))) / 100
              Endif
              Montanttva.Text = Format$(tva, "0.00")
            Endif
          Else
            If Left$(numcompte.Text, 1) = "4" And gntva = True And type_jour = "VE" Then
              Rtva = Utils.db.Exec("select * from " & Cbase.Table("TabTvav") & " where code_tva = &1", codetva.text)
              If Rtva.Available Then
                compte_tva = Rtva!cc_tva
                If montantht <> 0 Then
                  tva = (Montantht * Val(.Cpoint(Tauxtva.text))) / 100
                Else
                  tva = (Val(Montant.Text) * Val(.Cpoint(Tauxtva.text))) / 100
                Endif
                Montanttva.Text = Format$(tva, "0.00")
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  End With
  
End

'*****************************************************
'*  On affiche la tva lors d'une validation de ligne *
'*****************************************************
Public Sub aff_tva()
  
  Dim Cmpts As Result
  Dim sResult As Result
  Dim CTva As String
  Dim tvadb As Float
  Dim tvacd As Float
  Dim numcol As Integer
  
  tvadb = 0
  tvacd = 0
  With utils
    If Montanttva.Text <> "" Then
      Cmpts = Utils.db.Exec("select * from " & Cbase.Table("TabComptes") & " where compte_cc = &1", compte_tva)
      If Cmpts.Available Then
        ecrit1.Movefirst
        Repeat
          Ecrit1.Item.Selected = True
          Ctva = ecrit1.Item[1]
          If Ctva = compte_tva Then
            numcol = Ecrit1.Item[0]
            Tvadb = Val(ecrit1.Item[5])
            Tvacd = Val(ecrit1.Item[6])
            sResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE lind = &1", Ecrit1.current[10])
            If sResult.Available Then
              Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " where lind = &1", Ecrit1.current[10])
            Endif
            ecrit1.current.delete
            Modif = "1"
            Break
          Else
            numcol = Ecrit1.Count + 1
            modif = 0
          Endif
        Until Ecrit1.MoveNext()
        Try Ecrit1.add(Cmpts!compte_cc & numcol, Cmpts!compte_cc)
        If Error Then Try Ecrit1.add(Cmpts!compte_cc & 100 + numcol, Cmpts!compte_cc)
        If Error Then Try Ecrit1.add(Cmpts!compte_cc & 200 + numcol, Cmpts!compte_cc)
        Ecrit1.Item[0] = numcol
        Ecrit1.Item[1] = Cmpts!compte_cc
        Ecrit1.Item[8] = Cmpts!intitule_cc
        Ecrit1.Item[3] = numdoc.Text
        Ecrit1.Item[4] = numlot.Text
        Ecrit1.Item[2] = Libelecrit.Text
        Ecrit1.Item[9] = Journal.Text
      Endif
      If Modif = "1" Then
        If debit.Value = True Then
          Ecrit1.Item[5] = Format$(Val(Montanttva.text) + tvadb, "0.00")
          Ecrit1.Item[6] = Format$(0.00, "0.00")
        Else
          Ecrit1.Item[6] = Format$(Val(Montanttva.text) + tvacd, "0.00")
          Ecrit1.Item[5] = Format$(0.00, "0.00")
        Endif
      Else
        If debit.Value = True Then
          Ecrit1.Item[5] = Format$(Val(Montanttva.text), "0.00")
          Ecrit1.Item[6] = Format$(0.00, "0.00")
        Else
          Ecrit1.Item[6] = Format$(Val(Montanttva.text), "0.00")
          Ecrit1.Item[5] = Format$(0.00, "0.00")
        Endif
      Endif
      If Val(.CPoint(soldeecrit.Text)) = 0 Then soldeecrit.Text = "0,00"
      numcompte.Text = Cmpts!compte_cc
      Intitulcompte.Text = Cmpts!intitule_cc
      numcpt = numcompte.Text
      montantdb = Val(Ecrit1.Item[5])
      montantcd = Val(Ecrit1.Item[6])
      Prov = 1
      Vld = 0
      Movt()
    Endif
  End With
  
End

Public Sub Debit_Click()
  
  Try hder.setfocus
  
End

Public Sub Credit_Click()
  
  Try hder.setfocus
  
End

Public Sub Compdate()
  
  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Datej_GotFocus()
    Datej.setfocus
  Endif
  
End

'*************************************************
'*  On controle la cohérence de la date saisie   *
'*************************************************
Public Sub QuitteDate()
  
  Dim Params As Result
  Dim dte, dte2 As String
  Dim dte4 As String
  Dim numecr As String
  Dim ye2 As Integer
  
  With utils
    If Ecrit1.Count = 0 Then
      Params = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
      dte = Params!dtepc
      dte3 = Right$(dte, 4) & Left$(dte, 2)
      dte2 = Params!dteclec
      ye2 = Right$(dte2, 4)
      Inc Ye2
      Datej.text = .CDate_calc(Datej.Text)
      Datej.Text = .Cdate_aff(Datej.Text)
      dte4 = Params!dteclec
      If Datej.Text = "00.00.0:00" Then
        Datej.Text = Format$(Now, "dd.mm.yyyy")
        Datej_gotfocus()
        Datej.SetFocus
        b = 1
      Else
        If Right$(Datej.text, 4) & Mid$(Datej.text, 4, 2) <= dte3 Then
          If son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! La date saisie est inférieure au début de la période en cours.", "Ok") = 1 Then
            B = 1
          Endif
        Else
          If Right$(datej.text, 4) & Mid$(datej.text, 4, 2) & Left$(datej.text, 2) > (Ye2 + 1) & Left$(dte2, 2) & Mid$(dte2, 4, 2) Then
            If son Then
              Music.Play
            Endif
            If Message.Warning("Attention ! La date saisie est supérieure à  la date de fin d'exercice en cours.", "Ok") = 1 Then
              B = 1
            Endif
          Else
            B = 0
            If nvlle = 1 Then
              numecr = "numecriture"
              Ecritures(numecr)
              num = num + 1
              numecrit.Text = num
              Majnum(numecr)
              nvlle = 0
            Endif
            numcompte.SetFocus
            n = 0
          Endif
        Endif
      Endif
    Else
      If son Then
        Music.Play
      Endif
      Message.Warning("Attention ! Vous avez une écriture en cours !")
    Endif
  End With
Catch
  
End

Public Sub QuitteDate2()
  
  With utils
    Dateech.text = .CDate_calc(Dateech.Text)
    Dateech.Text = .Cdate_aff(Dateech.Text)
    If Dateech.Text = "00.00.0:00" Then
      Dateech.Text = Format$(Now, "dd.mm.yyyy")
      Dateech.SetFocus
      b = 1
    Else
      B = 0
      numcompte.SetFocus
      n = 0 
    Endif
  End With
Catch
  
End

'**************************
'*  On gére les touches   *
'**************************
Public Sub Cmpt_LostFocus()
  
  Try hder = Last
  Select Case Last.tag
      
    Case 2
      If LF = 0 Then
        Datej_LostFocus()
        If B = 1 Then
          Datej_GotFocus()
          Datej.SetFocus
          datej.Select
          Stop Event
        Else
          b = 0
          numcompte_GotFocus()
          numcompte.SetFocus
          numcompte.Select
        Endif
      Endif
      Stop Event
      
    Case 3
      If LF = 0 Then
        If Not IsNull(numcompte.text) Then
          Type_compte()
          'If soldec = 0 And type_jour <> "OD" Then
          'compteman()
          'Else
          'compteGman()
          'Endif
          If Bclient.Value Or If Bfournisseur.Value Then
            compteman()
          Else
            compteGman()
          Endif
          If B = 1 Then
            numcompte.SetFocus
            numcompte_GotFocus()
            numcompte.Select
            B = 0
          Else
            If b = 0 Then
              Ncpt = Numcompte.text
              Libelecrit_GotFocus()
              Libelecrit.SetFocus
              Libelecrit.Select
            Else
              If b = 2 Then
                Journal.SetFocus
              Else
                If b = 3 Then
                  Datej.SetFocus
                Endif
              Endif
            Endif
          Endif
        Endif
        Stop Event
      Endif
      
    Case 4
      $libelle = Libelecrit.Text
      Stop Event
  End Select
  
End

Public Sub Cmpt_KeyPress()
  
  Dim hForm2 As Extrait
  Dim Org As String = "S"
  
  Select Case Last.tag
      
    Case 1
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Journal_LostFocus()
        If journal.Text <> "" Then
          journauxman()
          If b = 1 Then
            Journal_GotFocus()
            Journal.SetFocus
            Journal.Select
            Stop Event
          Else
            b = 0
            Datej_GotFocus()
            Datej.SetFocus
            Datej.Select
          Endif
        Endif
        Stop Event
      Endif
      
    Case 2
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Datej_LostFocus()
        If B = 1 Then
          Datej_GotFocus()
          Datej.SetFocus
          datej.Select
          Stop Event
        Else
          b = 0
          numcompte_GotFocus()
          numcompte.SetFocus
          numcompte.Select
        Endif
        Stop Event
      Endif
      
    Case 3
      If key.code = key.F8 Then
        If Not IsNull(numcompte.Text) And If Not IsNull(Intitulcompte.Text) Then
          hForm2 = New Extrait(Numcompte.text, Intitulcompte.Text, type, Org)
          hForm2.Showmodal()
        Endif
      Endif
      If Key.code = Key.F4 Then 
        If Bgestion.value Or If Bbilan.value Then FComptes.ShowModal()
        If Bclient.value Then FClient.ShowModal()
        If Bfournisseur.Value Then FFournisseur.ShowModal()
      Endif
      If Key.code = 60 Then
        Numcompte.text = Ncpt
        Type_compte()
        If LF = 0 Then Libelecrit.setfocus
        Stop Event
      Endif
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Type_compte()
        If LF = 0 Then Libelecrit.setfocus
      Endif
      
    Case 4
      
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Libelecrit.Text = Utils.Remplace(Libelecrit.Text)
        Libelecrit_LostFocus()
        numdoc_GotFocus()
        numdoc.SetFocus
        numdoc.Select
        Stop Event
      Endif
      
    Case 5
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        numdoc_LostFocus()
        numlot_GotFocus()
        numlot.SetFocus
        numlot.Select
        Stop Event
      Endif
      
    Case 6
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        numlot_LostFocus()
        Montant_GotFocus()
        Montant.SetFocus
        Montant.Select
        Stop Event
      Endif
      
    Case 7
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Montant_LostFocus()
        'IF montant.Text = "" OR Montant.Text = "0.00" OR Montant.Text = "0,00" THEN
        If Val(Montant.Text) = 0 Then
          If son Then
            Music.Play
          Endif
          Try Message.Warning(" Attention ! Veuillez saisir un montant SVP !")
          Montant_GotFocus()
          Montant.SetFocus
          Montant.Select
        Else
          Button4.SetFocus
        Endif
        If B = 1 Then
          Montant.SetFocus
          Montant.Select
          B = 0
        Endif
        Stop Event
      Endif
      
    Case 8
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Dateech_LostFocus()
        If B = 1 Then
          Dateech_GotFocus()
          Dateech.SetFocus
          dateech.Select
          Stop Event
        Else
          b = 0
          numcompte_GotFocus()
          numcompte.SetFocus
          numcompte.Select
        Endif
        Stop Event
      Endif
      
      If Key.code = 60 Then
        Boutonmontant_Click()
        Stop Event
        Montant.Text = Replace$(Montant.Text, "*", "")
      Endif
      If Key.code = 68 Then
        Montant.Text = Replace$(Montant.Text, "d", "")
        Montant.Text = Replace$(Montant.Text, "D", "")
        Debit.value = True
        Stop Event
        Montant.SetFocus
        
      Endif
      If Key.code = 67 Then
        Montant.Text = Replace$(Montant.Text, "c", "")
        Montant.Text = Replace$(Montant.Text, "C", "")
        Credit.value = True
        Stop Event
        Montant.SetFocus
      Endif
  End Select
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
  If key.code = key.F2 Then
    Select Case Last.tag
      Case 1
        Dne = Journal.Text
        Journaux()
        Stop Event
        
      Case 3
        LF = 1
        ToggleButton8_Click()
        Stop Event
        
      Case 4
        LiButton_Click()
        
      Case 7
        Libutton_Click()
        Stop Event
    End Select
    
  Endif
  
  If Key.code = Key.F5 Then
    hForm = New FCalc
    
    Select Case Last.tag
        
      Case 7
        hForm.Showmodal()
        If Not IsNull(FCalc.Resultat) Then
          Montant.text = Format$(Val(FCalc.Resultat), "0.00")
        Endif
        Stop Event
        
    End Select
  Endif
  
  If key.code = key.F6 Then
    Select Case Last.tag
      Case 7
        Boutonmontant_Click()
        Stop Event
    End Select
  Endif
  
  If Key.code = Key.F7 Then
    
    Select Case Last.tag
        
      Case 3
        Aff_Mask()
        Stop Event
        
    End Select
  Endif
  
  If key.code = key.Esc Then
    Select Case Last.tag
      Case 3
        Colabt.Visible = False
        Numcompte.SetFocus
    End Select
  Endif
  
End

Public Sub Type_compte()
  
  If Not IsNull(Numcompte.Text) Then
    If Left$(Numcompte.text, 1) = "6" Or If Left$(Numcompte.text, 1) = "7" Then
      Bgestion.Value = True
    Else
      Bbilan.Value = True
    Endif
    If Left$(Numcompte.text, 3) = "401" Then Bfournisseur.Value = True
    If Left$(Numcompte.text, 3) = "411" Then Bclient.Value = True
    LF = 0
  Else
    Message.Warning("Vous devez saisir un compte !")
    LF = 1
    Numcompte.SetFocus
  Endif
  
End

'****************************
'*  On gère les boutons     *
'****************************
Public Sub Btn_KeyPress()
  
  Select Case Last.tag
      
    Case 4
      If Key.code = Key.enter Or Key.code = Key.return Then
        Button4_Click()
      Endif
      
    Case 7
      If Key.code = Key.enter Or Key.code = Key.return Then
        Button2_Click()
        Stop Event
      Endif
  End Select
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
End

Public Sub Btn_Enter()
  
  Select Case Last.tag
    Case 7
      LF = 1
    Case 8
      LF = 1
  End Select
  
End

Public Sub Btn_Leave()
  
  Select Case Last.tag
    Case 7
      LF = 0
    Case 8
      LF = 1
  End Select
  
End

'****************************
'*  On gère les boutons     *
'****************************
Public Sub Btn_Click()
  
  Select Case Last.tag
      
    Case 1
      'ToggleButton2_Click()
      
    Case 2
      Ventilations_Click()
      
    Case 3
      Necrit_Click()
      
    Case 4
      Button4_Click()
      
    Case 5
      Button3_Click()
      
    Case 6
      DelMvt()
      
    Case 7
      
      Button2_Click()
      
    Case 8
      
      Button1_Click()
      
  End Select
  
End

'****************************
'*    On gère le focus      *
'****************************
Public Sub Journal_GotFocus()
  
  cnt = "1"
  Journal.Background = &HAAFF7F&
  
End

Public Sub Journal_LostFocus()
  
  Journal.Background = Color.TextBackground
  If Ecrit1.Count = 0 Then
    If Journal.Text = "" Then
      If son Then
        Music.Play
      Endif
      Message.Warning(" Attention ! Veuillez saisir votre journal SVP !")
      Journal_GotFocus()
    Endif
  Else
    If Sjour <> Journal.Text And Not IsNull(Sjour) Then
      If son Then
        Music.Play
      Endif
      Message.Warning("Attention ! Vous venez de modifier le numéro du journal !")
      numcompte_Gotfocus()
      numcompte.Select
    Endif
  Endif
  
End

Public Sub Datej_GotFocus()
  
  Datej.Background = &HAAFF7F&
  If nvlle = 1 Then
    Datej.Text = Format$(Now, "dd.mm.yyyy")
  Endif
  If cnt = "1" Then
    Journal.SetFocus
    Datej.Background = Color.TextBackground
  Endif
Catch
  
End

Public Sub Dateech_GotFocus()
  
  Dateech.Background = &HAAFF7F&
  
End

Public Sub numcompte_GotFocus()
  
  numcompte.Background = &HAAFF7F&
  
End

Public Sub Datej_LostFocus()
  
  QuitteDate()
  Datej.Background = Color.TextBackground
  Dateech.Text = Datej.text
  
End

Public Sub Dateech_LostFocus()
  
  QuitteDate2()
  dateech.Background = Color.TextBackground
  
End

Public Sub numcompte_LostFocus()
  
  If LF = 0 Then
    numcompte.Background = Color.TextBackground
    If numcompte.Text <> "" Then
      If soldec = 0 Then
        compteman()
      Else
        compteGman()
      Endif
    Else
      If son Then
        Music.Play
      Endif
      Message.Warning(" Attention ! Veuillez saisir votre compte SVP !")
      b = 1
    Endif
  Endif
Catch
  
End

Public Sub Montant_GotFocus()
  
  With Utils
    Montant.Background = &HAAFF7F&
    Montantht = 0
    If modif = "0" Then
      If Val(Montant.text) = Null Then Montant.text = "0,00"
      soldec = Abs(soldec)
      Montant.Text = Format$(soldec, "0.00")
      Montantht = Val(.cpoint(montant.Text))
      If soldec <> 0 Then
        Try Montant.Text = (soldec * 100 / (100 + Val(.Cpoint(Tauxtva.Text))))
        If Not Error Then
          Montantht = Val(.cpoint(montant.Text))
          tva = soldec - Val(.cpoint(Montant.text))
          Montanttva.Text = Format$(tva, "0.00")
          Montant.Text = Format$(Montant.Text, "0.00")
        Endif
      Endif
    Endif
  End With
Catch
  Montant.Text = "0,00"
  
End

Public Sub Montant_LostFocus()
  
  Dim montante As Float
  
  With utils
    montant.Text = .Cpoint(montant.Text)
    If Val(Montant.text) = Null Then
      If son Then
        Music.Play
      Endif
      message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      montante = Val(.Cpoint(Montant.Text))
      montantht = montante
      Montant.Text = Format$(Montante, "0.00")
    Endif
    If montant.Text = "" Then
      If son Then
        Music.Play
      Endif
      Message.Warning(" Attention ! Veuillez saisir un montant avant de valider votre ligne SVP !")
      numcompte_GotFocus()
    Endif
    If Modif = "0" Then Calctva()
    Montant.Background = Color.TextBackground
    numdoc.SetFocus
  End With
  
End

Public Sub numdoc_GotFocus()
  
  numdoc.Background = &HAAFF7F&
  
End

Public Sub numdoc_LostFocus()
  
  Dim Eresult As Result
  
  If Modif <> "1" Then
    EResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numdoc = &1 and compte = &2 and jour = &3 and numero <> &4 and collectif is null", numdoc.Text, numcompte.Text, Journal.Text, numecrit.Text)
    If EResult.Available Then
      If son Then
        Music.Play
      Endif
      If Message.Question("L'écriture numero " & EResult!numero & " utilise déjà ce numéro de lot ! \n Voulez-vous continuer ?", "Oui", "Non") = 1 Then
      Endif
    Endif
  Endif
  numdoc.Background = Color.TextBackground
  numlot.Text = numdoc.Text
  
End

Public Sub numlot_GotFocus()
  
  numlot.Background = &HAAFF7F&
  
End

Public Sub numlot_LostFocus()
  
  numlot.Background = Color.TextBackground
  If Not Libelecrit.Text Then Libelecrit.Text = Intitulcompte.Text & " "
  
End

Public Sub Libelecrit_GotFocus()
  
  Libelecrit.Background = &HAAFF7F&
  
End

Public Sub Libelecrit_LostFocus()
  
  Libelecrit.Background = Color.TextBackground
  
End

'*******************************************************
'*      Gestion du choix sur le journal avec souris    *
'*******************************************************
Public Sub Choix1_Click()
  
  Wait 0.2
  If Choix1.index = "0" Then
    'si journal
    Journaux()
  Else
    If Choix1.Index = "1" Then
      'si ecriture non validée
      Ecr1()
    Else
      'si écriture validée
      ecritv()
    Endif
  Endif
  Choix1.visible = False
  
End

'*******************************************************
'*      Gestion du choix sur le journal a la main      *
'*******************************************************
Public Sub Choix1_Keypress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Choix1_Click()
    Stop Event
  End If
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
End

'********************************************************************
'*      Gestion du columnview Jour lors d'une saisie manuelle       *
'********************************************************************
Public Sub Jour_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    'Jour.MoveCurrent
    'Jour.Item.Selected = True
    Jour_MouseDown()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Jour.visible = False
    Jour.clear
    Journal_Gotfocus()
    Journal.Select
    Journal.SetFocus
    Stop Event
  Endif
  
End

'*********************************************
'*   On selectionne un journal en cliquant   *
'*********************************************

Public Sub Jour_MouseDown()
  
  Dim intitule As String
  
  Journal.Text = Jour.Current[0]
  intitule = Jour.Current[1]
  type_jour = Jour.current[2]
  Jour.Visible = False
  Jour.clear
  Titre.Text = "Saisie des écritures du journal des " & intitule & " N° " & Journal.Text
  libelle.Text = intitule
  Journal_LostFocus()
  Datej_GotFocus()
  Jour.Visible = False
  If type_jour <> "AC" Then
    Type = "C"
    Bclient.Value = True
  Else
    Type = "F"
    Bfournisseur.Value = True
  Endif
  Datej.SetFocus
  Datej.select
  
End

'******************************************
'*   On recupère le solde de l'écriture   *
'******************************************
Public Sub Boutonmontant_Click()
  
  Montant.Text = Format$(Abs(Val(soldeecrit.Text)), "0.00")
  Button4.SetFocus
  
End

'*************************************
'*   On enregistre la ligne saisie   *
'*************************************
Public Sub Button4_Click()
  
  Dim Code As String
  Dim Cmpts As Result
  Dim Nblg As Integer
  Dim Anl As Boolean = False
  Dim Mtd, Intitulecompte As String
  Dim hForm3 As Analytique
  
  Prov = 1
  Vld = 0
  montantdb = 0
  montantcd = 0
  Totaldb = 0
  Totalcd = 0
  With Utils
    LF = 1
    Montant_LostFocus()
    If b <> 1 Then
      Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & "  WHERE compte_cc = &1 and coll <> &2", numcompte.Text, 1)
      If Not Cmpts.Available Then
        b = 1
        Message.Error("Ce compte n'existe pas !")
        Numcompte.SetFocus
        Numcompte.Select
      Else
        b = 0
      Endif
    Endif
    If b <> 1 Then
      If numcompte.Text = "" Then
        If son Then
          Music.Play
        Endif
        Message.Warning(" Attention ! Veuillez saisir un N° de compte avant de valider votre ligne SVP !")
        numcompte_GotFocus()
        numcompte.SetFocus
        numcompte.Select
      Else
        If montant.Text = "" Then
          If son Then
            Music.Play
          Endif
          Message.Warning(" Attention ! Veuillez saisir un montant avant de valider votre ligne SVP !")
          Montant_GotFocus()
          Montant.SetFocus
          Montant.Select
        Else
          If numdoc.Text = "" Then
            If son Then
              Music.Play
            Endif
            message.Info(" Veuillez renseigner le numero de document avant d'enregistrer SVP !")
            numdoc.SetFocus
            numdoc.select
          Else
            If numecrit.Text = "" Then
              If son Then
                Music.Play
              Endif
              Message.Info(" Veuillez valider la Date de l'écriture afin d'affecter un numero SVP !")
              Datej.SetFocus
            Else
              If Libelecrit.Text = "" Then
                If son Then
                  Music.Play
                Endif
                Message.Info(" Veuillez saisir un libellé SVP !")
                Libelecrit.SetFocus
                Libelecrit.Select
              Else
                montant_LostFocus()
                Nblg = Ecrit1.count + 1
                Cle = Ecrit1.Count + Numlig
                Try Ecrit1.Add(numcompte.text & cle, numcompte.text)
                If Error Then Try Ecrit1.Add(numcompte.text & Cle + 100, numcompte.text)
                If Error Then Try Ecrit1.Add(numcompte.text & Cle + 200, numcompte.text)
                If modif = "1" Then
                  Ecrit1.Item[0] = itm
                Else
                  Ecrit1.Item[0] = Nblg
                Endif
                Ecrit1.Item[1] = numcompte.text
                Ecrit1.Item[2] = Libelecrit.Text
                $libelle = Libelecrit.Text
                Ecrit1.Item[3] = numdoc.text
                Ecrit1.Item[4] = numlot.text
                numcpt = numcompte.Text
                If debit.Value = True Then
                  Ecrit1.Item[5] = Format$(Val(.cpoint(Montant.text)), "0.00")
                  Ecrit1.Item[6] = Format$(0.00, "0.00")
                  montantdb = Val(ecrit1.Item[5])
                Else
                  Ecrit1.Item[6] = Format$(Val(.cpoint(Montant.text)), "0.00")
                  Ecrit1.Item[5] = Format$(0.00, "0.00")
                  montantcd = Val(ecrit1.Item[6])
                Endif
                Ecrit1.Item[7] = datej.Text
                Ecrit1.Item[8] = Intitulcompte.Text
                Ecrit1.Item[9] = journal.Text
                Inc numlig
                Movt()
              Endif
              If Settings["/Soc" & Start.Societe & "/Analytique"] Then 
                Cmpts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAna") & " where compte = &1", Numcompte.Text)
                If Cmpts.Available Then 
                  Anl = True
                  Code = Numcompte.Text
                  Intitulecompte = Intitulcompte.Text
                  Mtd = Format$(Val(.cpoint(Montant.text)), "0.00")
                Endif
              Endif
              If gntva = True And type_jour <> "OD" And montanttva.Text <> "" And soldec <> 0 Then
                Calctva()
                If modif <> "1" Then
                  aff_tva()
                Endif
              Endif
              Totaldb = 0
              Totalcd = 0
              Calculsolde()
              If Left$(numcompte.Text, 3) = "401" And type_jour <> "OD" Or If Left$(numcompte.Text, 3) = "411" And type_jour <> "OD" Then
                If Left$(numcompte.Text, 3) = "401" And type_jour = "AC" And debit.Value = True Or If Left$(numcompte.Text, 3) = "411" And type_jour = "VE" And credit.Value = True Then
                  Avoir = True 
                Else
                  Avoir = False 
                Endif
                'If Left$(numcompte.Text, 3) = "411" And type_jour = "VE" And credit.Value = True Then 
                'Avoir = True 
              Else
                Avoir = False 
              Endif
              Cleanchamps()
              If Val(Soldeecrit.Text) <> 0 And type_jour <> "OD" And ecrA = "0" Then 
                Type = "G"
                Bgestion.Value = True
                VentilAuto()
              Endif
              Modif = "0"
              If Anl Then 
                hForm3 = New Analytique(Code, Mtd, Numecrit.Text, debit.value, Journal.text, Datej.Text, Intitulecompte, Numdoc.Text, $libelle)
                hForm3.Showmodal()
              Endif
              If Val(.cpoint(soldeecrit.Text)) = 0 Then
                Button2.SetFocus
              Else
                If type_jour <> "OD" Then
                  Bgestion.Value = True
                  Sens_Ecr()
                Endif
                Numcompte.SetFocus
              Endif
            Endif
          Endif
        Endif
      Endif
    Endif
  End With
  b = 0
  If ecrA = "1" Then LignAbt()
  
End

'*****************************************
'*   On enregistre l'écriture complete   *
'*****************************************

Public Sub Button2_Click()
  
  Dim intitule As String
  Dim Mntcol As Float
  
  With Utils
    If Val(.cpoint(soldeecrit.Text)) <> 0 Then
      If son Then
        Music.Play
      Endif
      message.Warning(" Attention ! Le solde est différent de zéro \n Veuillez solder votre écriture SVP \n avant de faire votre validation !")
      Return
    Else
      If Ecrit1.count <> 0 Then
        Prov = 0
        Vld = 1
        DelMvt2() ' on efface l'écriture
        Enrg_Ecr() ' on la reécrit
        ecrit1.clear
        numlot.Clear
        Codetva.Clear
        numdoc.Clear
        Tauxtva.Clear
        Montanttva.Clear
        soldeecrit.text = "0,00"
        Modif = "0"
        Mntcol = 0
        intitule = ""
        libelecrit.clear
        Gntva = False
        n = 1
        Intitulcompte.Clear
        numecrit.Text = ""
      Endif
    Endif
  End With
  nvlle = 1
  soldec = 0
  Numlig = 1
  Ventilations.Visible = False
  If type_jour = "VE" Then
    Bclient.Value = True
  Else
    If type_jour = "AC" Then
      Bfournisseur.Value = True
    Else
      Bbilan.value = True
    Endif
  Endif
  'Datej_Gotfocus()
  Datej.SetFocus
  Datej.Select
  
End

Public Sub Enrg_Ecr()
  
  Dim rResult As Result
  Dim rrResult As Result
  Dim Colresult As Result
  Dim Libel2 As String
  Dim Mnt As Float
  Dim num_coll As String
  Dim Mntcol As Float
  
  Ecrit1.MoveFirst
  Repeat
    numcpt = Ecrit1.Item[1]
    Intitulcompte.Text = Ecrit1.Item[8]
    If Left$(Numcpt, 2) = "40" Or If Left$(Numcpt, 2) = "41" Then Libel2 = Ecrit1.Item[2]
    $libelle = Ecrit1.Item[2]
    montantdb = Val(ecrit1.Item[5])
    montantcd = Val(ecrit1.Item[6])
    If IsNull(Journal.Text) Then Journal.Text = Ecrit1.Item[9]
    numdoc.Text = Ecrit1.Item[3]
    numlot.Text = ecrit1.Item[4]
    'Libelecrit.Text = $libelle
    'If IsNull($Libelle) Then $Libelle = Libelecrit.Text
    'If IsNull($Libelle) Then $Libelle = Libel2
    cle = ecrit1.Item[0]
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee,Pointee, numcol, dateech) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", Journal.Text, numecrit.Text, numcpt, Intitulcompte.Text, Utils.Cdate_Dbase(Datej.Text), numdoc.Text, numlot.Text, $libelle, montantdb, montantcd, Vld, Prov, 0, 0, 0, 0, ecrit1.Item[0], Utils.Cdate_Dbase(Dateech.Text))
    Utils.db.Exec("UPDATE " & Cbase.Table("TabMvtA") & "  SET validee = &2 where numero = &1", numecrit.Text, 1)
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", numcpt)
    If rResult.Available Then
      Mnt = rResult!solde
      Mnt = Mnt + montantdb - montantcd
      num_coll = rResult!coll_cc
      Utils.db.Exec("Update " & Cbase.Table("TabComptes") & " set solde = &1 Where compte_cc = &2", Mnt, numcpt)
      If num_coll <> "" Then
        rrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", num_coll)
        If rrResult.Available Then
          Mntcol = rrResult!solde
          Mntcol = Mntcol + montantdb - montantcd
          ColResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE compte = &1 and numero = &2", num_coll, numecrit.text)
          If Colresult.Available Then
            montantdb = montantdb + ColResult!montantd
            montantcd = montantcd + ColResult!montantc
            Utils.db.Exec("UPDATE " & Cbase.Table("TabMvt") & "  SET jour = &1,numero = &2,compte = &3,intitule = &4,dte = &5,numdoc = &6,numlot = &7,libelle = &8,montantd = &9,montantc = &{10},validee = &{11},provisoire = &{12}, dateech = &{13}  where compte = &3 AND numero = &2", Journal.Text, numecrit.Text, num_coll, Intitulcompte.Text, Utils.Cdate_Dbase(Datej.Text), numdoc.Text, numlot.Text, Libel2, montantdb, montantcd, 1, 0, Utils.Cdate_Dbase(Dateech.Text))
          Else
            Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee,collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16} )", Journal.Text, numecrit.Text, num_coll, Intitulcompte.Text, Utils.Cdate_Dbase(Datej.Text), numdoc.Text, numlot.Text, Libel2, montantdb, montantcd, 1, 0, 0, 0, 0, 1)
          Endif
        Endif
        Utils.db.Exec("Update " & Cbase.Table("TabComptes") & " set solde = &1 Where compte_cc = &2", Mntcol, num_coll)
        Mntcol = 0
      Endif
    Endif
  Until Ecrit1.Movenext()
  $libelle = ""
  
End

'***********************************************************************************************
'*   Gestion des columnviews des journaux ou du choix des écritures en cliquant sur le bouton  *
'***********************************************************************************************
Public Sub ToggleButton6_Enter()
  
  LF = 1
  
End

Public Sub ToggleButton6_Leave()
  
  LF = 0
  
End

Public Sub ToggleButton6_Click()
  
  If Choix1.Visible = True Then
    Choix1.Visible = False
  Else
    Choix1.clear
    Choix1.Add("1- Liste des journaux", 0)
    Choix1.Add("2- Liste des écritures non validées", 1)
    Choix1.Add("3- Liste des écritures validées", 2)
    Choix1.Visible = True
  Endif
  If Jour.Visible = True Then
    Jour.Visible = False
    Choix1.Visible = False
  Endif
  LF = 1
  
End

'*******************************************************
'*   Gestion des columnviews des comptes en cliquant   *
'*******************************************************
Public Sub ToggleButton8_Enter()
  
  LF = 1
  
End

Public Sub ToggleButton8_Leave()
  
  LF = 0
  
End

Public Sub ToggleButton8_Click()
  
  With utils
    If nvlle = 1 Then
      If son Then
        Music.Play
      Endif
      message.Error("Veuillez valider votre date SVP !")
      Datej.SetFocus
      Datej_Gotfocus()
    Else
      If Journal.Text = "" Then
        If son Then
          Music.Play
        Endif
        message.Warning("  Veuillez saisir votre code journal SVP !")
        LF = 1
        Journal.SetFocus
      Else
        compte()
      Endif
    Endif
  End With
Catch
  
End

'*************************************************************************
'*   Gestion des columnviews des ventilations en cliquant sur le bouton  *
'*************************************************************************
Public Sub Ventilations_Click()
  
  If Vtl.Visible = True Then
    Vtl.Visible = False
  Else
    Vtl.Visible = True
  Endif
  ventil()
  
End

'*********************************************
'*   On affiche la ventilation sélectionnée  *
'*********************************************
Public Sub Vtl_Click()
  
  numcompte.Text = Vtl.Current[0]
  Intitulcompte.Text = Vtl.Current[1]
  Vtl.Visible = False
  Montant.Text = "0,00"
  compteGman()
  Montant_Gotfocus()
  Montant.SetFocus
  Montant.Select
  
End

'****************************************************************
'*  Gestion du Libview des libellés en cliquant sur le bouton   *
'****************************************************************
Public Sub Libutton_Click()
  
  If Libview.Visible = True Then
    Libview.Visible = False
  Else
    Libview.Visible = True
    lib()
  Endif
  
End

'******************************************************
'*   Gestion des columnviews des libellés en validant *
'******************************************************
Public Sub Libview_Keypress()
  
  If Key.code = Key.enter Or Key.code = Key.return Then
    Libview_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Libview.visible = False
    Libview.clear
    Libelecrit.SetFocus
    Libelecrit.Select
    Stop Event
  Endif
  
End

'****************************************
'*   On affiche le libellé sélectionné  *
'****************************************
Public Sub Libview_Click()
  
  Libelecrit.Text = Libview.Current[1] & " "
  Libview.Clear
  Libview.Visible = False
  libelecrit.Setfocus
  libelecrit_gotfocus()
  
End

'***************************************
'*  On calcule le solde de l'écriture  *
'***************************************
Public Sub Calculsolde()
  
  Ecrit1.MoveFirst
  Totaldb = 0
  Totalcd = 0
  soldec = 0
  If Ecrit1.Count Then
    Repeat
      Ecrit1.Item.Selected = True
      montantdb = Val(ecrit1.Item[5])
      montantcd = Val(ecrit1.Item[6])
      Totaldb = Totaldb + montantdb
      Totalcd = Totalcd + montantcd
      soldec = Totalcd - Totaldb
      soldeecrit.Text = Format$(soldec, "0.00")
    Until Ecrit1.MoveNext()
  Endif
  If Val(Utils.CPoint(soldeecrit.Text)) = 0 Then soldeecrit.Text = "0,00"
  
End

'************************************
'*  Suppression d'une ligne         *
'************************************
Public Sub Ecrit1_Keypress()
  
  Dim rResult As Result
  
  If Key.code = Key.Delete And Ecrit1.Count <> 0 Then
    If son Then
      Music.Play
    Endif
    If Message.Question("Etes-vous sur de vouloir supprimer cette ligne ?", "Oui", "Non") = 1 Then
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE lind = &1", Ecrit1.current[10])
      If rResult.Available Then
        Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " where lind = &1", Ecrit1.current[10])
      Endif
      Ecrit1.Current.Delete
    Endif
  Endif
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numero = &1 and collectif is null", num)
  If rResult.Available Then
    Ecrit1.Clear
    Repeat
      Ecrit1.Add(rResult!lind, rResult!lind)
      Ecrit1.Item[0] = rResult!numcol
      Ecrit1.Item[1] = rResult!compte
      Ecrit1.Item[2] = rResult!libelle
      If Left(rResult!compte, 2) = "40" Then numcpt = rResult!compte
      If Left(rResult!compte, 2) = "41" Then numcpt = rResult!compte
      Ecrit1.Item[3] = rResult!numdoc
      Ecrit1.Item[4] = rResult!numlot
      Ecrit1.Item[5] = Format$(rResult!montantd, "0.00")
      Ecrit1.Item[6] = Format$(rResult!montantc, "0.00")
      Ecrit1.Item[7] = Format$(CDate(rResult!dte), "dd.mm.yyyy")
      Ecrit1.Item[8] = rResult!intitule
      Ecrit1.Item[9] = rResult!jour
      Ecrit1.Item[10] = rResult!lind
    Until rResult.MoveNext()
  Endif
  Calculsolde()
  Numcompte.SetFocus
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
End

'************************************************
'*  On rappelle une ligne pour modification     *
'************************************************
Public Sub Ecrit1_Activate()
  
  montantdb = 0
  montantcd = 0
  totalcd = 0
  Totaldb = 0
  'Ecrit1.MoveFirst()
  If Not ecrit1.Available Then
    clear()
  Else
    numcompte.Text = Ecrit1.Current[1]
    numcpt = numcompte.text
    Recup_Type()
    If Type = "C" Or If type = "B" Then numcvtl = numcompte.text
    Intitulcompte.Text = Ecrit1.Current[8]
    numdoc.Text = Ecrit1.Current[3]
    numlot.Text = ecrit1.Current[4]
    Journal.Text = Ecrit1.Current[9]
    Libelecrit.Text = Ecrit1.Current[2]
    If IsNull(Libelecrit.Text) Then Libelecrit.Text = $Libelle
    $Libelle = Libelecrit.Text
    sLind = Ecrit1.Current[10]
    Itm = Ecrit1.Current[0]
    If Val(ecrit1.Current[5]) <> 0 Then
      Debit.Value = True
      Montant.Text = ecrit1.Current[5]
      montantdb = Val(ecrit1.Item[5])
    Else
      Credit.Value = True
      Montant.Text = ecrit1.Current[6]
      montantcd = Val(ecrit1.Item[6])
    Endif
    Totaldb = Totaldb - montantdb
    Totalcd = Totalcd - montantcd
    soldec = Totalcd - Totaldb
    soldeecrit.Text = Format$(soldec, "0.00")
    Totaldb = 0
    Totalcd = 0
    If Val(Utils.CPoint(soldeecrit.Text)) = 0 Then soldeecrit.Text = "0,00"
  Endif
  DelEcr()
  Ecrit1.Current.Delete
  Modif = "1"
  Supp = 0
  LF = 1
  numcompte.SetFocus
  numcompte.Select
  
End

Public Sub Recup_Type()
  
  Dim rType As Result
  
  rType = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", Numcompte.text)
  If rType.Available Then
    Type = rType!type_cc
  Else
    Type = ""
  Endif
  If Type = "B" Then Bbilan.value = True
  If Type = "G" Then Bgestion.Value = True
  If Type = "C" Then BClient.Value = True
  If Type = "F" Then Bfournisseur.Value = True
  
End

Public Sub renlig()
  
  Dim rlgn As Result
  Dim nl As Integer = 1
  
  Ecrit1.MoveFirst()
  Repeat
    Try ecrit1.Item.Selected = True
    If Not Error Then
      rlgn = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE numcol = &1", Ecrit1.Item[0])
      ecrit1.Current[0] = nl
      If rlgn.Available Then Utils.db.Exec("UPDATE  " & Cbase.Table("TabMvt") & "  SET numcol = &1 where lind = &2", nl, rlgn!lind)
      Inc nl
    Endif
  Until Ecrit1.MoveNext()
  
End

Public Sub DelEcr()
  
  Dim rResult As Result
  Dim collectif As String
  
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE lind = &1", Ecrit1.Item[10])
  If rResult.Available Then
    Repeat
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " WHERE lind = &1", Ecrit1.Item[10])
      rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", numcpt)
      If rResult.Available Then
        collectif = rResult!coll_cc
      Endif
      rResult = Utils.db.Exec("SELECT *  FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 and compte = &2 and numdoc = &3 and intitule = &5", numecrit.Text, collectif, numdoc.Text, numlot.Text, Intitulcompte.Text)
      If rResult.Available Then
        Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 and compte = &2 and numdoc = &3 and intitule = &5", numecrit.Text, collectif, numdoc.Text, numlot.Text, Intitulcompte.Text)
      Endif
    Until rResult.Movenext()
  Endif
  
End

'******************************
'*  On sélectionne une ligne  *
'******************************
Public Sub Ecrit_Click()
  
  If Nv = 0 Then
    ecrit2()
  Else
    ecrit3()
  Endif
  
End

'*******************************************************************
'*  On affiche la ligne non validée qui vient d'etre sélectionnée  *
'*******************************************************************
Public Sub ecrit2()
  
  Dim rResult As Result
  
  If Ecrit1.Count Then
    Message.Warning("Attention ! Veuillez valider l' écriture en cours. ")
  Else
    CleanChamps()
    With Utils
      Try num = Comptabilite.snum
      If Not Error Then
        numecrit.Text = num
        Totaldb = 0
        Totalcd = 0
        soldec = 0
        nvlle = 0
        numcpt = ""
        $Libelle = ""
        rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numero = &1 and collectif is null  order by cast(numcol as unsigned)", num)
        If rResult.Available Then
          Repeat
            Ecrit1.Add(rResult!lind, rResult!lind)
            Ecrit1.Item[0] = rResult!numcol
            Ecrit1.Item[1] = rResult!compte
            Ecrit1.Item[2] = rResult!libelle
            If IsNull($Libelle) Then $Libelle = Ecrit1.Item[2]
            If Left(rResult!compte, 2) = "40" Then 
              numcpt = rResult!compte
              Dateech.Text = Format$(CDate(rResult!dateech), "dd.mm.yyyy")
            Endif
            If Left(rResult!compte, 2) = "41" Then 
              numcpt = rResult!compte
              Dateech.Text = Format$(CDate(rResult!dateech), "dd.mm.yyyy")
            Endif
            Ecrit1.Item[3] = rResult!numdoc
            Ecrit1.Item[4] = rResult!numlot
            Ecrit1.Item[5] = Format$(rResult!montantd, "0.00")
            Ecrit1.Item[6] = Format$(rResult!montantc, "0.00")
            Ecrit1.Item[7] = Format$(CDate(rResult!dte), "dd.mm.yyyy")
            Ecrit1.Item[8] = rResult!intitule
            Ecrit1.Item[9] = rResult!jour
            Ecrit1.Item[10] = rResult!lind
          Until rResult.MoveNext()
          Datej.Text = Ecrit1.Item[7]
          Journal.Text = Ecrit1.Item[9]
          numdoc.Text = Ecrit1.Item[3]
          numlot.Text = Ecrit1.Item[4]
          Libelecrit.Text = Ecrit1.Item[2]
        Endif
        Calculsolde()
        ecriture = "0"
        montantdb = 0
        montantcd = 0
        Nvlle = 0
        Ventilations.Visible = True
        journauxman()
        ecrit1.MoveLast()
        ecrit1.Item.EnsureVisible
      Endif
      Numcompte.SetFocus
    End With
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error("Votre écriture n'est pas terminée, veuillez la valider \n ou bien cliquer sur Nouvelle écriture SVP  !")
  
End

'***************************************************************
'*  On affiche la ligne validée qui vient d'etre sélectionnée  *
'***************************************************************
Public Sub Ecrit3()
  
  Dim rResult As Result
  Dim rrResult As Result
  Dim rrrResult As Result
  Dim num_coll As String
  Dim Mos As String
  Dim Nlot As String
  Dim Nlot2 As String
  Dim Mnt As Float
  Dim Mnt1 As Float
  Dim Mnt2 As Float
  Dim nl As Integer = 1
  
  If Ecrit1.Count Then
    If son Then
      Music.Play
    Endif
    Message.Warning("Attention ! Veuillez valider l' écriture en cours. ")
  Else
    If Not IsNull(numr) Then
      Try num = numr
    Else
      Try num = Comptabilite.snum
    Endif
    If Not Error Then
      If son Then
        Music.Play
      Endif
      If Message.Question("Attention ! Vous allez modifier l'écriture n° " & num, "Oui", "Non") = 1 Then
        CleanChamps()
        With Utils
          numecrit.Text = num
          Prov = 1
          Vld = 0
          nvlle = 0
          rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numero = &1 and collectif is null order by cast(numcol as unsigned)", num)
          If rResult.Available Then
            Repeat
              Ecrit1.Add(rResult!lind, rResult!lind)
              Ecrit1.Item[0] = rResult!numcol
              Ecrit1.Item[1] = rResult!compte
              If Left(rResult!compte, 2) = "40" Then 
                Dateech.Text = Format$(CDate(rResult!dateech), "dd.mm.yyyy")
              Endif
              If Left(rResult!compte, 2) = "41" Then 
                Dateech.Text = Format$(CDate(rResult!dateech), "dd.mm.yyyy")
              Endif
              Ecrit1.Item[2] = rResult!libelle
              Ecrit1.Item[3] = rResult!numdoc
              Ecrit1.Item[4] = rResult!numlot
              Ecrit1.Item[5] = Format$(rResult!montantd, "0.00")
              Ecrit1.Item[6] = Format$(rResult!montantc, "0.00")
              Ecrit1.Item[7] = Format$(CDate(rResult!dte), "dd.mm.yyyy")
              Ecrit1.Item[8] = rResult!intitule
              Ecrit1.Item[9] = rResult!jour
              Ecrit1.Item[10] = rResult!lind
              Mos = Left$(Ecrit1.item[7], 6)
              Datej.Text = Ecrit1.Item[7]
              Journal.Text = Ecrit1.Item[9]
              numcpt = rResult!compte
              montantdb = rResult!montantd
              montantcd = rResult!montantc
              If Left(rResult!compte, 3) = "401" Or Left(rResult!compte, 3) = "411" Then Nlot = rResult!numlot
              rrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", numcpt)
              If rrResult.Available Then
                num_coll = rrResult!coll_cc
                Mnt1 = rrResult!solde
                Mnt = Mnt1 - montantdb + montantcd
                If Left$(numcpt, 2) = "41" Then
                  Mnt2 = montantdb
                Else
                  Mnt2 = montantcd
                Endif
                Utils.db.Exec("Update " & Cbase.Table("TabComptes") & " set solde = &1 Where compte_cc = &2", Mnt, numcpt)
                mnt = 0
                If num_coll <> "" Then
                  rrrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", num_coll)
                  If rrrResult.Available Then
                    Mnt = rrrResult!solde
                    If Left$(numcpt, 2) = "41" Then
                      Mnt = Mnt - Mnt2
                    Else
                      Mnt = Mnt + Mnt2
                    Endif
                    Utils.db.Exec("Update " & Cbase.Table("TabComptes") & " set solde = &1 Where compte_cc = &2", Mnt, num_coll)
                  Endif
                Endif
              Endif
              Inc nl
            Until rResult.MoveNext()
            Datej.Text = Ecrit1.Item[7]
            Journal.Text = Ecrit1.Item[9]
            numdoc.Text = Ecrit1.Item[3]
            numlot.Text = Ecrit1.Item[4]
            Libelecrit.Text = Ecrit1.Item[2]
            Numcompte.SetFocus
            ' On delettre les ecritures portant un numero de lot identique
            If Left(Nlot, 1) = "M" Or Left(Nlot, 1) = "S" Then
              Nlot2 = Mid$(Nlot, 2, (Len(Nlot) - 1))
            Else
              Nlot2 = Nlot
            Endif
            rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & "  WHERE numlot = &1 and collectif is null", Nlot)
            If rResult.Available Then
              Repeat
                Utils.db.Exec("UPDATE " & Cbase.Table("TabMvt") & " SET lettree = &1, numlot = &3 WHERE numlot =  &2", 0, Nlot, Nlot2)
              Until rResult.MoveNext()
            Endif
            Calculsolde()
            Ventilations.Visible = True
            ecriture = "0"
            montantdb = 0
            montantcd = 0
            journauxman()
            ' On passe l'écriture en provisoire
            Utils.db.Exec("UPDATE  " & Cbase.Table("TabMvt") & "  SET  validee = &2, provisoire = &3 where numero = &1", numecrit.Text, 0, 1)
            ecrit1.MoveLast()
            ecrit1.Item.EnsureVisible
          Endif
        End With
      Else
        If Ext = True Then Me.close
      Endif
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  message.Error("Votre écriture n'est pas terminée, veuillez la valider \n ou bien cliquer sur Nouvelle écriture SVP  !")
  
End

'*********************************
'*  On ferme si on double-clique *
'*********************************
'Public Sub jour2_Activate()

'jour2.Visible = False
'journal.SetFocus
'journal.Select

'End

'**********************************
'*  On veut une nouvelle écriture *
'**********************************
Public Sub Necrit_Click()
  
  If ecrit1.count <> 0 Then
    Message.Warning("Vous avez une écriture en cours. Vous pourrez la retrouver dans les écritures non validées")
    clear()
    If type_jour = "AC" Then Bfournisseur.Value = True
    If type_jour = "VE" Then Bclient.Value = True
    nvlle = 1
    Datej_Gotfocus()
    Datej.SetFocus
    Datej.Select
  Endif
  
End

'**********************************************
'*    On supprime une écriture par le bouton  *
'**********************************************
Public Sub DelMvt()
  
  Dim rResult As Result
  
  If son Then
    Music.Play
  Endif
  If Message.Question("Etes-vous sur de vouloir supprimer cette écriture ?", "Oui", "Non") = 1 Then
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 ", numecrit.Text)
    If rResult.Available Then 
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 ", numecrit.Text)
      Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvtA") & " WHERE numero = &1 ", numecrit.Text)
    Endif
    Ecrit1.Clear
    Clear()
    Journal.Select
    Journal.SetFocus
    Journal_Gotfocus()
  Endif
  
End

'**********************************************
'*    On supprime une écriture suite a rappel *
'**********************************************
Public Sub DelMvt2()
  
  Dim rResult As Result
  
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 ", numecrit.Text)
  If rResult.Available Then
    Utils.db.Exec("DELETE FROM " & Cbase.Table("TabMvt") & " WHERE numero = &1 ", numecrit.Text)
  Endif
  Journal.Select
  Journal.SetFocus
  Journal_Gotfocus()
  
End

'************************
'*  On met tout à  blanc *
'************************
Public Sub clear()
  
  ecrit1.clear
  numcompte.Text = ""
  numlot.text = ""
  Codetva.text = ""
  numdoc.text = ""
  Tauxtva.text = ""
  Montanttva.Text = ""
  Libelecrit.Text = ""
  numecrit.Text = ""
  Modif = "0"
  Gntva = False
  Journal.SetFocus
  Ventilations.Visible = False
  ecriture = "0"
  montantdb = 0
  montantcd = 0
  soldec = 0
  soldeecrit.Text = "0,00"
  Nvlle = 1
  
End

Public Sub Masque_Click()
  
  Ecrit1_MouseDown()
  
End

Public Sub Bclient_Click()
  
  Type = "C"
  Sens_Ecr()
  Tri = "cast(compte_cc AS char)"
  Numcompte.SetFocus
  
End

Public Sub Bfournisseur_Click()
  
  Type = "F"
  Sens_Ecr()
  Tri = "cast(compte_cc AS char)"
  Numcompte.SetFocus
  
End

Public Sub Bgestion_Click()
  
  Type = "G"
  Sens_Ecr()
  Tri = "cast(compte_cc AS char)"
  Numcompte.SetFocus
  
End

Public Sub Bbilan_Click()
  
  Type = "B"
  Sens_Ecr()
  Tri = "cast(compte_cc AS char)"
  Numcompte.SetFocus
  
End

Public Sub Sens_Ecr()
  
  If type_jour = "VE" And type = "C" Then
    debit.Value = True
  Else
    If type_jour = "VE" And type <> "C" Then
      If Not avoir Then
        credit.Value = True
      Else
        debit.Value = True
      Endif
    Endif
  Endif
  If type_jour = "AC" And type = "F" Then
    debit.Value = False
  Else
    If type_jour = "AC" And type <> "F" Then
      If Not avoir Then
        debit.Value = True
      Else
        credit.Value = True
      Endif
    Endif
  Endif
  
End

Public Sub Button1_Click()
  
  If numecrit.Text <> "" And If Ecrit1.count <> 0 Then
    If son Then
      Music.Play
    Endif
    If message.Question("Il y a une saisie en cours !\n Souhaitez-vous quitter ? \n Si oui, l'écriture en cours sera dans les écritures non validées.", "Oui", "Non") = "1" Then
      Settings["/Soc" & Start.Societe & "/Col/LcolS"] = "col0:" & Ecrit1.Columns[0].Width & ";" & "col1:" & Ecrit1.Columns[1].Width & ";" & "col2:" & Ecrit1.Columns[2].Width & ";" & "col3:" & Ecrit1.Columns[3].Width & ";" & "col4:" & Ecrit1.Columns[4].Width & ";" & "col5:" & Ecrit1.Columns[5].Width & ";" & "col6:" & Ecrit1.Columns[6].Width
      Settings.Save
      Me.Close
    Endif
  Else
    Settings["/Soc" & Start.Societe & "/Col/LcolS"] = "col0:" & Ecrit1.Columns[0].Width & ";" & "col1:" & Ecrit1.Columns[1].Width & ";" & "col2:" & Ecrit1.Columns[2].Width & ";" & "col3:" & Ecrit1.Columns[3].Width & ";" & "col4:" & Ecrit1.Columns[4].Width & ";" & "col5:" & Ecrit1.Columns[5].Width & ";" & "col6:" & Ecrit1.Columns[6].Width
    Settings.Save
    Me.Close
  Endif
  
End

'***************************
'*  On affiche la doc htML *
'***************************
Public Sub Button3_Click()
  
  Exec ["xdg-open", Application.Path &/ "Ecrans/Saisiesdesachats.html"]
  
End

'*********************************************************************************
'                     On gère les masques de saisies.
Public Sub Ecrit1_MouseDown()
  
  If Mouse.Right Then Aff_Mask()
  
End

Public Sub Aff_Mask()
  
  If Colabt.visible = True Then
    Colabt.Visible = False
  Else
    Colabt.Visible = True
  Endif
  Colabt.Columns.count = 6
  Colabt.Columns[0].Width = 80
  Colabt.Columns[1].Width = 300
  Colabt.Columns[2].Width = 100
  Colabt.Columns[3].Width = 80
  Colabt.Columns[4].Width = 40
  Colabt.Columns[0].Text = "Numéro"
  Colabt.Columns[1].Text = "Intitulé"
  Colabt.Columns[2].Text = "Type écriture"
  Colabt.Columns[3].Text = "Type saisie"
  Colabt.Columns[4].Text = "Lig"
  If journal.Text = "" Then
    Colabt.Visible = False
    If son Then
      Music.Play
    Endif
    Message.Error("Veuillez saisir votre Code journal SVP !")
    LF = 1
    Journal.SetFocus
  Else
    If IsNull(Numecrit.text) Then
      Colabt.Visible = False
      If son Then
        Music.Play
      Endif
      Message.Error("Veuillez valider la date d'écriture SVP !")
      datej.SetFocus
    Else
      Colabt.Clear
      Deb3()
    Endif
  Endif
  
End

Public Sub Deb3()
  
  Dim recr As Result
  
  'If type_jour = "AC" Then typeAbt = "A"
  typeAbt = "A"
  recr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabNumabon") & " where type = &1", typeAbt)
  If recr.Available Then
    Repeat
      Colabt.Add(recr!numero, recr!numero)
      Colabt.Item[0] = recr!numero
      Colabt.Item[1] = recr!intitule
      If recr!type = "A" Then
        Colabt.Item[2] = "Achat"
      Else
        Colabt.Item[2] = "Trésorerie"
      Endif
      If recr!typem = "1" Then
        Colabt.Item[3] = "Montant"
      Else
        Colabt.Item[3] = "Pourcentage"
      Endif
    Until recr.MoveNext()
    Colabt.MoveFirst()
    Colabt.Item.Selected = True
    Colabt.SetFocus
    Modif = "1"
  Endif
  
End

Public Sub Colabt_Click()
  
  Dim recr As Result
  Dim Totabd As Float
  Dim Totabc As Float
  
  If Colabt.Count > 0 Then
    recr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigabon") & " where numero = &1", Colabt.Current[0], "0,00")
    If recr.Available Then
      Numcompte.text = recr!compte
      Numcpt = Numcompte.Text
      Intitulcompte.Text = recr!intitule
      libelecrit.Text = Colabt.Current[1]
      Repeat
        If recr!debit <> 0 Then
          Totabd += Val(Utils.cpoint(recr!debit))
        Else
          Totabc += Val(Utils.cpoint(recr!credit))
        Endif
        If Totabd > 0 Then
          Montant.Text = Format$(Totabd, "0.00")
          debit.Value = True
        Else
          Montant.Text = Format$(Totabc, "0.00")
          credit.Value = True
        Endif
      Until recr.MoveNext()
      Colabt.Visible = False
      EcrA = "1"
    Endif
    Type_compte()
    Numdoc.SetFocus
  Endif
  
End

Public Sub Colabt2_Click()
  
  Dim recr As Result
  
  If Colabt.Count > 0 Then
    If Colabt.Item[3] = "Montant" Then
      recr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigabon") & " where numero = &1", Colabt.Current[0], "0,00")
      If recr.Available Then
        Numcompte.text = recr!compte
        Intitulcompte.Text = recr!intitule
        libelecrit.Text = Colabt.Current[1]
        Montant.Text = recr!credit
        libelecrit.SetFocus
        Colabt.Visible = False
        EcrA = "1"
        Credit.Value = True
      Endif
    Else
      recr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigabon") & " where numero = &1 ", Colabt.Current[0])
      If recr.Available Then
        Numcompte.text = recr!compte
        Intitulcompte.Text = recr!intitule
        libelecrit.Text = Colabt.Current[1]
        Montant.Text = recr!credit
        libelecrit.SetFocus
        Colabt.Visible = False
        EcrA = "1"
        Credit.Value = True
      Endif
    Endif
    Type_compte()
    Numdoc.SetFocus
  Endif
  
End

Public Sub Colabt_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then Colabt_Click()
  If Key.code = Key.F7 Or If key.code = key.Esc Then
    Colabt.Visible = False
    Numcompte.SetFocus
  Endif
  
End

Public Sub LignAbt()
  
  Dim recr As Result
  
  Ecrit1.clear
  If Colabt.Item[3] = "Montant" Then
    recr = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabLigabon") & " where numero = &1", Colabt.Current[0])
    If recr.Available Then
      Repeat
        Cle = Ecrit1.Count + 1
        numcpt = recr!compte
        Intitulcompte.Text = recr!intitule
        Ecrit1.Add(recr!lig, recr!lig)
        Ecrit1.Item[0] = cle
        Ecrit1.Item[1] = numcpt
        Ecrit1.Item[2] = Libelecrit.Text
        Ecrit1.Item[3] = numdoc.text
        Ecrit1.Item[4] = numlot.text
        Ecrit1.Item[5] = Format$(Val(Utils.cpoint(recr!debit)), "0.00")
        Ecrit1.Item[6] = Format$(Val(Utils.cpoint(recr!credit)), "0.00")
        Ecrit1.Item[7] = datej.Text
        Ecrit1.Item[8] = Intitulcompte.Text
        Ecrit1.Item[9] = journal.Text
      Until recr.MoveNext()
    Endif
  Endif
  EcrA = "0"
  Calculsolde()
  Cleanchamps()
  Button2.SetFocus
  
End

Public Sub Dateech_DblClick()
  
  If DateChooser1.visible = False Then
    DateChooser1.visible = True
  Else
    DateChooser1.visible = False
  Endif
  
End

Public Sub DateChooser1_Activate()
  
  Dateech.text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  DateChooser1.visible = False
  
End

Public Sub Button5_Click()
  
  Dim hFormc As GedC
  Dim hFormg As Gged
  
  If ecrit1.count > 0 Then
    Select Case Message.Question("Que voulez-vous faire ?\n1- Joindre un fichier existant\n2- Scanner un document\n3 -Sortir", "1", "2", "3")
      Case 1
        ecrit1.MoveFirst()
        ecrit1.Item.Selected = True
        $cpt = ecrit1.Current[1]
        If Not IsNull($cpt) Then
          hFormc = New GedC(Numecrit.text, "CPT", ecrit1.Current[1], " ")
          hFormc.Showmodal()
        Endif
        
      Case 2
        ecrit1.MoveFirst()
        Repeat
          ecrit1.Item.Selected = True
          $cpt = ecrit1.Current[1]
          If Not IsNull($cpt) Then
            If Left$($cpt, 3) = "401" Or If Left$($cpt, 3) = "411" Then
              hFormg = New Gged(Numecrit.text, "CPT", $cpt, "")
              hFormg.Showmodal()
            Endif 
          Endif
        Until ecrit1.MoveNext() 
        
      Case 3
        'Panel2.Visible = False
    End Select
  Endif 
  
End

Private Function FileFilter(Optional All As Boolean = False) As String[]
  
  Dim filter As New String[]
  
  filter.Add("*.*")
  Return filter
  
End
