' Gambas class file

Private Jnal As String
Private numecr As String
Private numr As String
Private numr2 As String
Private colcpt As String
Private Client As String
Private Nclient As String
Private Collectif As String
Private $texte As String
Private itn As Integer = 0
Private icol As Integer = 0
Private bnew As Boolean = False
Private Posy As Integer = 0
Private iRow As Integer = -1
Private iColumn As Integer = 0
Private CoulFoc As Integer ' Variable pour la couleur du focus
Private CoulCol As Integer ' Variable pour la couleur du tableview
Private pdf As Cbordereaux

Public Sub Form_Open()

  Dim rBanque As Result
  Dim Frmt As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Focus"])
  CoulFoc = Val(Frmt[0])
  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znaff"])
  CoulCol = Val(Frmt[0])

  Dateb.text = Format$(Now, "dd.mm.yyyy")
  Rbanque = Utils.db.Exec("select * from Fiches_Journaux where  type_jo = &1order by code_jo", "TR")
  If Rbanque.Available Then
    Repeat
      If Left$(Rbanque!code_jo, 2) <> "53" Then Bq.Add(Rbanque!code_jo & "-" & Rbanque!libelle_jo)
    Until Rbanque.MoveNext()
  Endif
  Recup_Cheques()

End

Public Sub Recup_Cheques()

  Dim rCheque As Result
  Dim n, i As Integer = 0

  Grd1.Clear
  Grd1.Rows.Count = n
  Grd1.Refresh()
  Grd1.Columns.Count = 10
  Grd1.Columns[0].Width = 0
  Grd1.Columns[1].Width = 0
  Grd1.Columns[2].Width = 20
  Grd1.Columns[3].Width = 94
  Grd1.Columns[4].Width = 94
  Grd1.Columns[4].Alignment = 2
  Grd1.Columns[5].Width = 98
  Grd1.Columns[5].Alignment = 3
  Grd1.Columns[6].Width = 312
  Grd1.Columns[7].Width = 106
  Grd1.Columns[8].Width = 22
  Grd1.Columns[9].Width = 0
  Grd1.Columns[3].Text = "Date chèque"
  Grd1.Columns[4].Text = "Montant"
  Grd1.Columns[5].Text = "Code client"
  Grd1.Columns[6].Text = "Nom client"
  Grd1.Columns[7].Text = "N° facture"
  Grd1.Columns[8].Text = "V"
  rCheque = Utils.db.Exec("select * from Fiches_BordereauxC order by dateremise")
  If rCheque.Available Then
    Repeat
      Grd1.Rows.count = n + 1
      Grd1[n, 0].Text = rCheque!lind
      Grd1[n, 1].Text = "1"
      Grd1[n, 2].Picture = Picture["icon:/16/apply"]
      Grd1[n, 3].Text = Format$(rCheque!dateremise, "dd.mm.yyy")
      Grd1[n, 4].Text = rCheque!montant
      Grd1[n, 5].Text = rCheque!code
      Grd1[n, 6].Text = rCheque!nom
      Grd1[n, 7].Text = rCheque!nfacture
      Grd1[n, 8].Picture = Picture["icon:/16/trash"]
      Grd1[n, 9].Text = rCheque!lind
      Inc n
    Until rCheque.MoveNext()
  Endif
  For i = 0 To Grd1.Rows.Count - 1
    For n = 2 To 7
      Grd1[i, n].Font.Italic = False
      Grd1[i, n].Font.StrikeOut = False
    Next
  Next

End

Public Sub Grd1_Save(Row As Integer, Column As Integer, Value As String)

  Grd1[row, column].Text = value
  Try Grd1[Row, 8].Picture = Picture["icon:/16/save"]

End

Public Sub Grd1_MouseUp()

  Dim i, x As Integer = 0
  Dim bmr As Boolean = False

  Try TbGrd1.Text = Grd1[Grd1.row, Grd1.Column].Text
  Try bmr = Mouse.Right
  If bmr Then
    If Message.Question("Voulez-vous ajouter une ligne ?", "Oui ", "Non") = 1 Then
      bnew = True
      itn = Grd1.Rows.count
      Grd1.Rows.Insert(itn)
      Grd1[itn, 4].EnsureVisible
      icol = 2
      Grd1[itn, 2].Picture = Picture["icon:/16/apply"]
      Grd1[itn, 3].Text = Dateb.text
      Grd1[itn, 1].Text = "1"
      Grd1.MoveTo(itn, 4)
      Grd1[itn, 8].Picture = Picture["icon:/16/save"]
    Else
      icol = Grd1.Column
    Endif
  Else
    icol = Grd1.Column
    If icol = 2 And Not bnew Then
      If Grd1[Grd1.Row, 2].Picture = Picture["icon:/16/apply"] Then
        Grd1[Grd1.Row, 2].Picture = Picture["icon:/16/close"]
        Grd1[Grd1.Row, 1].Text = "0"
        For i = 2 To 7
          Grd1[Grd1.Row, i].Font.Italic = True
          Grd1[Grd1.Row, i].Font.StrikeOut = True
        Next
      Else
        Grd1[Grd1.Row, 2].Picture = Picture["icon:/16/apply"]
        Grd1[Grd1.Row, 1].Text = "1"
        For i = 2 To 7
          Grd1[Grd1.Row, i].Font.Italic = False
          Grd1[Grd1.Row, i].Font.StrikeOut = False
        Next
      Endif
    Else
      If icol = 8 And Grd1[Grd1.row, 8].Picture = Picture["icon:/16/save"]
        If IsNull(Grd1[Grd1.Row, 9].text) Then
          Utils.db.Exec("INSERT INTO Fiches_BordereauxC (code, nom, montant,dateremise,banque,nfacture ) VALUES (&1, &2, &3, &4, &5,&6)", Grd1[Grd1.Row, 5].Text, Grd1[Grd1.Row, 6].text, Grd1[Grd1.Row, 4].text, Utils.Cdate_Dbase(Grd1[Grd1.Row, 3].Text), Left$(Bq.text, 2), Grd1[Grd1.Row, 7].text)
        Else
          Utils.db.Exec("Update Fiches_BordereauxC set code = &1, nom =&2, montant = &3,dateremise =&4,banque =&5,nfacture=&6 where lind = &7", Grd1[Grd1.Row, 5].Text, Grd1[Grd1.Row, 6].text, Grd1[Grd1.Row, 4].text, Utils.Cdate_Dbase(Grd1[Grd1.Row, 3].Text), Left$(Bq.text, 2), Grd1[Grd1.Row, 7].text, Grd1[Grd1.Row, 9].text)
        Endif
        Recup_Cheques()
      Else
        If icol = 8 And Grd1[Grd1.row, 8].Picture = Picture["icon:/16/trash"]
          If Message.Question("Attention ! Vous aller définitivement supprimer ce chèque !", "Oui", "Non") = 1 Then
            Utils.db.Exec("Delete from Fiches_BordereauxC where lind = &1", Grd1[Grd1.Row, 9].text)
            Recup_Cheques()
          Endif
        Else
          iRow = Grd1.row
          icolumn = Grd1.column
          Grd1.Edit
          TbGrd1.SetFocus
          TbGrd1.Select
          If bnew Then
            For x = 0 To Grd1.Rows.Count - 1
              For i = 2 To 7
                Grd1[x, i].Background = Grd1.Background
              Next
            Next
            Grd1.Row = itn
            Grd1.Column = 4
          Else
            $texte = Grd1[Grd1.Row, Grd1.Column].text
          Endif
          bnew = False
        Endif
      Endif
    Endif
  Endif

Catch

End

Public Sub Dateb_DblClick()

  If DateChooser1.Visible = False Then
    DateChooser1.visible = True
  Else
    DateChooser1.Visible = False
  Endif

End

Public Sub DateChooser1_Activate()

  Dateb.text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  DateChooser1.Visible = False

End

Public Sub Button1_Click()

  Me.Close

End

Public Sub Button2_Click()

  If Grd1.Rows.count > 0 Then
    If IsNull(Nbordereau.text) Then
      Message.Warning("Veuillez saisir un numéro de bordereau SVP !")
      Nbordereau.SetFocus
    Else
      If IsNull(Bq.text) Then
        Message.Warning("Veuillez saisir un numéro de banque SVP !")
      Else
        Imp_Bordereaux()
      Endif
    Endif
  Endif

End

Public Sub Imp_Bordereaux()

  Dim Tab As String
  Dim Filename As String
  Dim TxtB As String
  Dim Cptcli, libel, Cptcaisse, Cptbanque As String
  Dim libelCaisse As String
  Dim nbreg As Integer = 0
  Dim Montant, Tmontant As Float = 0
  Dim Nbtot As String
  Dim lg, inlg As Integer
  Dim rBanque, rBrd As Result
  Dim Nlot As String
  Dim Chemin As String
  Dim blettree, bcheque As Boolean = False

  Parametres()
  'On recupère le code client caisse
  rBanque = Utils.db.Exec("select * from Fiches_ClientCaisse")
  If rBanque.Available Then
    CptCaisse = rBanque!code
    LibelCaisse = rBanque!nom
  Else
    Cptcaisse = ""
  Endif
  ' on recupère le nom du journal
  rBanque = Utils.db.Exec("select * from Fiches_Journaux where  code_jo = &1", Left$(Bq.text, 2))
  If Rbanque.Available Then
    Txtb = "Bordereaux de chèques du " & Format$(Now, "dd.mm.yyyy") & " ( " & Rbanque!libelle_jo & " )"
    Cptbanque = rBanque!cde_banque
  Endif
  Filename = User.Home & "/tmp/Bordereau.pdf"
  pdf = New Cbordereaux("Portrait", "mm", "A4")
  pdf.Open()
  pdf.AliasNbPages()
  Tab = "Fiches_LigTicketz"
  posy = 0
  ' Filename = User.home & "/Caisse/Bordereau_" & Btype & Format$(Now, "dd.mm.yyyy") & ".pdf"
  pdf = New Cbordereaux("Portrait", "mm", "A4")
  pdf.Open()
  pdf.AliasNbPages()
  lg = 8
  PosY = 5
  Pdf.Entete()
  Pdf.TitreB(TxtB, PosY)
  PosY = 15
  Pdf.Ligne(PosY)
  PosY += 5
  Pdf.Level6()
  PosY += 5
  For inlg = 0 To Grd1.Rows.count - 1
    If Grd1[inlg, 1].Text = "1" Then
      Pdf.Level7(Grd1[inlg, 3].text, Grd1[inlg, 4].text, Grd1[inlg, 5].text, Grd1[inlg, 6].text, PosY)
      Montant += Val(Utils.cpoint(Grd1[inlg, 4].text))
      PosY = PosY + 5
      Inc nbreg
    Endif
  Next
  Pdf.Ligne(PosY)
  Posy = Posy + 2
  Nbtot = "Nombre de chèques    " & nbreg & "            Total bordereau   "
  Posy = Posy + 5
  Pdf.Level8(nbtot, Format$(Val(Utils.cpoint(Montant)), "0.00"), PosY)
  Posy = Posy + 6
  Pdf.Ligne(PosY)
  nbreg = 0
  Montant = "0"
  pdf.Output(Filename, False)
  Visualiseur.Prog_Editeur(Filename)
  'On copie le fichier pdf
  If Not IsNull(Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"]) Then
    If Not Exist(Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"]) Then Mkdir Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"]
    If Not Exist(Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"] & "/Bordereaux") Then Mkdir Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"] & "/Bordereaux"
    Chemin = Start.LocalSettings["/Soc" & Start.Societe & "/FactcheminC"] & "/Bordereaux/" & Format$(DateChooser1.Value, "yyyy")
    If Not Exist(Chemin) Then Mkdir Chemin
    Chemin &= "/" & Format$(DateChooser1.Value, "mm")
    If Not Exist(Chemin) Then Mkdir Chemin
    Shell "cp " & Filename & " " & Chemin & "/Bordereau" & Nbordereau.text & ".pdf" Wait
  Else
    Message.Warning("Copie impossible ! le chemin des PDF de la comptabilité n'est pas indiqué.")
  Endif
  If Message.Question("Voulez-vous effacer les chèques remis à la banque ?", "Oui", "Non") = 1 Then

    ' On génère l'écriture de trésorerie pour les chèques caisse
    For inlg = 0 To Grd1.Rows.count - 1
      If Grd1[inlg, 1].Text = "1" Then
        If Grd1[inlg, 5].Text = Cptcaisse Then
          Montant += Val(Utils.cpoint(Grd1[inlg, 4].text))
          Cptcli = Grd1[inlg, 5].Text
        Endif
      Endif
    Next
    Tmontant = Montant
    If Cptcli = Cptcaisse And montant > 0 And Not IsNull(Cptcli) Then
      Libel = "Chèques caisse "
      rBrd = Utils.db.Exec(" select  sum(replace(montantd, ',', '.')) as tmtd, sum(replace(montantc, ',', '.')) as tmtc from " & Cbase.Table("TabMvt") & " where numlot = &1 and compte = &2", Nlot, CptCli)
      If Not IsNull(rBrd!tmtd) Then
        If rBrd!tmtd - rBrd!tmtc = Montant Then
          blettree = 1
        Else
          blettree = 0
        Endif
      Else
        blettree = 0
      Endif
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour, numero, compte, intitule, dte, numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, Client, Libel, Utils.Cdate_Dbase(Dateb.Text), Nbordereau.Text, Nbordereau.Text, Libel, 0, montant, 1, 0, 1, 0, 1, Utils.Cdate_Dbase(Dateb.text), numr2)

      Utils.db.Exec("Update " & Cbase.Table("TabMvt") & " set lettree = &1 Where numero = &2", blettree, numr)
      Csolde.Solde_caisse(Cptcaisse)
      Maj_Collectif(cptcli, LibelCaisse, "Chèques caisse " & Dateb.text, montant, blettree)
    Endif
    ' On génère l'écriture de trésorerie pour les chèques client compte
    Montant = 0
    For inlg = 0 To Grd1.Rows.count - 1
      If Grd1[inlg, 1].Text = "1" Then
        If Grd1[inlg, 5].Text <> Cptcaisse And Not IsNull(Grd1[inlg, 5].Text) Then
          bcheque = True
          If Not IsNull(Grd1[inlg, 7].text) Then
            Nlot = Grd1[inlg, 7].text
          Else
            Nlot = Nbordereau.Text
          Endif
          Cptcli = Grd1[inlg, 5].Text
          Montant = Val(Utils.cpoint(Grd1[inlg, 4].text))
          Tmontant += Montant
          Libel = Grd1[inlg, 6].text
          If montant > 0 Then
            rBrd = Utils.db.Exec(" select  sum(replace(montantd, ',', '.')) as tmtd, sum(replace(montantc, ',', '.')) as tmtc from " & Cbase.Table("TabMvt") & " where numlot = &1 and compte = &2", Nlot, CptCli)
            If Not IsNull(rBrd!tmtd) Then
              If rBrd!tmtd - rBrd!tmtc = Montant Then
                blettree = 1
              Else
                blettree = 0
              Endif
            Else
              blettree = 0
            Endif
            Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour, numero, compte, intitule, dte, numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, CptCli, Libel, Utils.Cdate_Dbase(Dateb.Text), Nlot, Nlot, Libel & " 'B" & Nbordereau.Text, 0, montant, 1, 0, 1, blettree, 1, Utils.Cdate_Dbase(Dateb.text), numr2)
            Csolde.Solde_caisse(Cptcli)
            Maj_Collectif(cptcli, Libel, "Chèque " & Libel & Dateb.text, montant, blettree)
          Endif
        Else
          If IsNull(Grd1[inlg, 5].Text) Then Message.Error("Le chèque d'un montant de " & Montant & " ne peux pas être traité!\ncar il ne possède pas de code client!")
        Endif
      Endif
    Next
    Libel = "Bordereau de chèque N° " & Bordereaux.Text
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, Cptbanque, libel, Utils.Cdate_Dbase(Dateb.Text), Nlot, Nlot, Libel, Tmontant, 0, 1, 0, 1, 0, 1, Utils.Cdate_Dbase(Dateb.text), numr2)
    Csolde.Solde_caisse(Cptbanque)
    Maj_Collectif(cptcli, Libel, "Chèque " & Libel & Dateb.text, montant, blettree)
    Sha1Calc.CalcSha1("Fiches_Mvt", numr)
    For inlg = 0 To Grd1.Rows.count - 1
      If Grd1[inlg, 1].Text = "1" Then Utils.db.Exec("DELETE FROM  Fiches_BordereauxC  WHERE lind = &1", Grd1[inlg, 0].Text)
    Next
    Recup_Cheques()
    Message.Info("Traitement terminé !")
  Endif

End

Public Sub Maj_Collectif(Cpt As String, intit As String, libel As String, Mnt As Float, lettree As String)

  Dim Coll As String
  Dim Mtc As Float
  Dim Mtd As Float
  Dim Sld As Float
  Dim cResult As Result
  Dim Numlt As String = Format$(DateChooser1.Value, "ddmmyyyy")

  cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", Cpt)
  coll = cResult!coll_cc
  cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " Where compte = &1 and numero = &2 and numerodef = &3", Coll, numr, numr2)
  If cResult.Available Then
    If Mnt > 0 Then
      Mtd = 0
      Mtc = Mnt + cResult!montantc
    Else
      Mtc = 0
      Mtd = Mnt + cResult!montantd
    Endif
    Utils.db.Exec("UPDATE " & Cbase.Table("TabMvt") & " set montantc = &4, lettree = &5 Where compte = &1 and numero = &2 and numerodef = &3", Coll, numr, numr2, mtc, lettree)
  Else
    Mtc = Mnt
    Utils.db.Exec("INSERT INTO " & Cbase.Table("TabMvt") & "(jour, numero, compte, collectif, intitule, dte, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef, numdoc, numlot) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19})", Jnal, numr, coll, 1, Intit, Utils.Cdate_Dbase(Dateb.Text), Libel, Mtd, Mtc, 1, 0, 1, 0, lettree, 1, 0, numr2, Numlt, numlt)
  Endif
  cResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " Where compte_cc = &1", coll)
  If cResult!solde = "" Then
    Sld = Mtd - Mtc
  Else
    Sld = cResult!solde + Mtd - Mtc
  Endif
  Utils.db.Exec("UPDATE " & Cbase.Table("TabComptes") & " set solde = &2 Where compte_cc = &1", coll, Sld)

End

'**********************************************************
'*                                     Recup parametres                                            *
'**********************************************************
Public Sub Parametres()

  Dim rcli As Result
  Dim rcol As Result

  'On recupère les numéros d'écritures
  numecr = "numecriture"
  numr = Ecritures(numecr)
  numr = numr + 1
  numecr = "numecriture2"
  numr2 = Ecritures(numecr)
  numr2 = numr2 + 1
  Utils.db.Exec("UPDATE Fiches_Parametres set numecriture = &1,numecriture2 = &2 ", numr, numr2)
  'On récupère le journal des ventes
  Jnal = Left$(Bq.Text, 2)

  'On recupère le compte caisse
  rcli = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCliCaisse") & "")
  If rcli.Available Then
    Client = rcli!code
    Nclient = rcli!nom
  Endif

  ' On récupère le collectif
  rcol = Utils.db.Exec("SELECT compte_cc FROM " & Cbase.Table("TabComptes") & " where coll = &1 order by cast(compte_cc AS char)", "1")
  If rcol.Available Then
    Repeat
      Colcpt = rcol!compte_cc
      If Left$(Colcpt, 2) = Left$(Client, 2) Then
        collectif = Colcpt
        Break
      Endif
    Until rcol.MoveNext()
  Endif

End

'*****************************************************
'*  Récuperation du dernier numéro d'écriture        *
'*****************************************************
Public Function Ecritures(numecr2 As String) As String

  Dim Params As Result
  Dim nro As String

  Params = Utils.db.Exec("SELECT " & numecr & " FROM " & Cbase.Table("TabParam") & " ")
  If Params.Available Then
    If IsNull(Params["" & numecr2 & ""]) Then
      nro = 0
    Else
      nro = Params["" & numecr2 & ""]
    Endif
  Endif
  Return nro

End

Public Sub Button3_Click()

  Recup_Cheques()
  Tbgrd1.Clear
  Tbgrd1.visible = False

End
