' Gambas class file

Public Sub Button2_Click()

  Dim rResult As Result
  Dim $cle, $cle2 As String
  Dim Filename, Ste, Dte As String
  Dim PosY As Integer
  Dim i As Integer
  Dim pdf As Ccompta
  Dim PB As ProgBar

  i = 0
  rResult = Utils.db.Exec("SELECT * FROM  Fiches_Mvt")
  Shell "cd " & User.Home & ""
  Filename = User.Home & "/tmp/Anomalies.pdf"
  pdf = New Ccompta("Portrait", "mm", "A4")
  pdf.Open()
  pdf.AliasNbPages()
  pdf.Entete("Contrôle des Ecritures (Anomalies des cles)")
  pdf.Level0P(ste)
  PosY = PosY + 160
  dte = Format$(Now, "dd.mm.yyyy")
  pdf.Level1A2()
  PosY = 32
  rResult = Utils.db.Exec("SELECT * FROM  Fiches_Mvt Order by numero asc, lind desc")
  If rResult.Available Then
    PB = New ProgBar("Recherche des anomalies", rResult.Count)
    PB.Enable_Detail()
    PB.IsStoppable(True)
    PB.Show()
    Me.Mouse = Mouse.wait
    Repeat
      If PB.Avancement("Ecriture " & rResult!numero, 10) = True Then Break
      If Not Sha1Calc.CalcSha1_Verify("Fiches_Mvt", rResult!numero, rResult!lind) Then
        pdf.Level2A2(rResult!numero, rResult!compte, rResult!intitule, Format$(rResult!dte, "dd.mm.yyyy"), rResult!control, Sha1Calc.CalcSha1("Fiches_Mvt", rResult!numero, rResult!lind, False), posy)
        PosY += 5
        Inc i
        If posy > 283 Then
          pdf.Baspage()
          pdf.Entete("Contrôle des Ecritures (Anomalies des cles)")
          pdf.Level0P(ste)
          PosY = PosY + 160
          dte = Format$(Now, "dd.mm.yyyy")
          pdf.Level1A2()
          PosY = 32
        Endif
      Endif
    Until rResult.movenext()
    PB.Close()
    Me.mouse = Mouse.Default
    If i > 0 Then
      pdf.Lines(PosY)
      pdf.BasPage()
      pdf.Output(Filename, False)
      Impression.Prog_Editeur(Filename)
      Message.Info("Traitement terminé.")
      Me.close
    Else
      Message.Info("Aucune anomalie !")
    Endif
  Endif

End

Public Sub Button1_Click()

  Me.Close()

End
