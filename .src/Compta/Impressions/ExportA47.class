' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : ExportA47.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 21 janvier 2014
'# Export des écritures dans un fichier texte au format A47
'################################################

Private dte1 As String
Private dte2 As String
Private hfile As File
Private Org As String
Private rResult As Result
Private Intitule_Soc As String
Private dte As String
Private dte4 As String
Private jour As String
Private txt As String
Private Tab0 As String
Private extension As String

Public Sub _New()
  
  If Settings["/Soc" & Start.societe & "/Coul_fen"] Then Utils.Observers(Me)
  Music.Load(Start.Musique)
  rResult = Utils.db.Exec("select * from " & Cbase.Table("TabSoc") & "")
  Intitule_Soc = rResult!type_sc & " " & rResult!int_sc
  Try Chmexport.Text = Settings["/Soc" & Start.societe & "/Chemin-export"]
  If IsNull(Chmexport.Text) Then Chmexport.Text = User.Home
  Try Adrexport.Text = Settings["/Soc" & Start.societe & "/Adr-export"]
  If Settings["/Soc" & Start.societe & "/Expmail"] Then
    Envoi.Value = True
  Else
    Envoi.value = False
  Endif
  Me.Center
  Dtes2.Text = "Veuillez saisir les dates du nouvel export."
  E0_click()
  DteN0_GotFocus()
  DteN0.SetFocus
  
End

Public Sub Ex1()
  
  Dim Tab As String
  Dim Jrs As Date
  
  Tab = "Fiches_Parametres"
  With Utils
    DteN0.Text = ""
    Dten1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    If Not Settings["/Soc" & start.societe & "/Gestion"] Then
      dte = rResult!dteclec
      DteN0.Text = .Calc_mois(dte)
      jour = Format$(Now, "dd.mm.yyyy")
      If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) < Right$(DteN0.Text, 4) & Mid$(DteN0.Text, 4, 2) & Left$(DteN0.Text, 2) Then
        Exo()
      Else
        Dten1.Text = jour
        dte1 = DteN0.Text
        dte2 = Dten1.Text
      Endif
    Else
      dte = rResult!dtepp
      If rResult!dtepp = "" Or Left$(rResult!dtepp, 2) = "00" Then Dte = Format$(Now, "mm.yyyy")
      dte = "01." & dte
      DteN0.Text = dte
      jrs = Date(Right$(dte, 4), Format$(Val(Mid$(dte, 4, 2)), "00"), 01)
      Dten1.Text = finmois(jrs) & "." & Format$(Val(Mid$(dte, 4, 2)), "00") & "." & Right$(dte, 4)
    Endif
  End With
  
End

'****************************************
'*    Calcul du dernier jour du mois    *
'****************************************
Public Function finmois(Jrs As Date) As Integer
  
  Dim Jrs1 As Integer
  
  If Month(Jrs) < 12 Then
    Jrs1 = Day(Date(Year(Jrs), Month(Jrs) + 1, 1) - 1)
  Else
    Jrs1 = Day(Date(Year(Jrs) + 1, 1, 1) - 1)
  Endif
  Return Jrs1
  
End

Public Sub Exo()
  
  Dim Tab As String
  
  Tab = "Fiches_Parametres"
  With Utils
    DteN0.Text = ""
    Dten1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    DteN0.Text = .Calc_mois(dte)
    dte = rResult!dteclec
    Dten1.Text = .Cdate_aff(dte)
    dte1 = DteN0.Text
    dte2 = Dten1.Text
  End With
  
End

Public Sub Exo1()
  
  Dim Tab As String
  
  Tab = "Fiches_Parametres"
  With Utils
    DteN0.Text = ""
    Dten1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec2
    DteN0.Text = .Calc_mois(dte)
    dte = rResult!dteclec1
    Dten1.Text = .Cdate_aff(dte)
    dte1 = DteN0.Text
    dte2 = Dten1.Text
  End With
  
End

Public Sub Exo2()
  
  Dim Tab As String
  
  Tab = "Fiches_Parametres"
  With Utils
    DteN0.Text = ""
    Dten1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec3
    DteN0.Text = .Calc_mois(dte)
    'dteN0.Text = .Cdate_affdata(dte)
    dte = rResult!dteclec2
    Dten1.Text = .Cdate_aff(dte)
    dte1 = DteN0.Text
    dte2 = Dten1.Text
  End With
  
End

Public Sub Cmpt_KeyPress()
  
  Select Case Last.tag
      
    Case 1
      If Key.code = Key.enter Or Key.code = Key.Return Or Key.code = Key.Tab Then
        DteN0_LostFocus()
        Dten1_GotFocus()
        Dten1.SetFocus
        Dten1.Select
        Stop Event
      Endif
      
    Case 2
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        Dten1_LostFocus()
        Stop Event
      Endif
      
  End Select
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
End

Public Sub Btn_Click()
  
  Select Case Last.tag
      
    Case 1
      Button3_Click()
      
    Case 2
      Button2_Click()
      
    Case 4
      Settings["/Soc" & Start.societe & "/Adr-export"] = Adrexport.Text
      Settings["/Soc" & Start.societe & "/Chemin-export"] = Chmexport.Text 
      Me.Close
  End Select
  
End

Public Sub DteN0_GotFocus()
  
  DteN0.Background = &HAAFF7F&
  DteN0.Select
  DteN0.SetFocus
  
End

Public Sub DteN0_LostFocus()
  
  With utils
    dte4 = Format$(Now, "dd.mm.yyyy")
    If Len(DteN0.Text) = 2 Or Len(DteN0.Text) = 3 Then DteN0.Text = Left$(DteN0.Text, 2) & "." & Mid$(dte4, 4, 7)
    If Len(DteN0.Text) = 5 Or Len(DteN0.Text) = 6 Then DteN0.Text = Left$(DteN0.Text, 5) & "." & Right$(dte4, 4)
    DteN0.text = .Cdate_calc(DteN0.Text)
    DteN0.Text = .Cdate_aff(DteN0.Text)
  End With
  If DteN0.Text = "00.00.0:00" Then DteN0.Text = Format$(Now, "dd.mm.yyyy")
  If Val(Right$(DteN0.text, 4) & Mid$(DteN0.text, 4, 2) & Left$(DteN0.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate()
  Else
    If Val(Right$(DteN0.text, 4) & Mid$(DteN0.text, 4, 2) & Left$(DteN0.text, 2)) > Val(Right$(dte2, 4) & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période selectionnée."
      Compdate()
    Endif
  Endif
  DteN0.Background = Color.TextBackground
Catch
  DteN0_GotFocus()
  DteN0.setfocus
  
End

Public Sub DteN1_GotFocus()
  
  DteN1.Background = &HAAFF7F&
  
End

Public Sub DteN1_LostFocus()
  
  With utils
    dte4 = Format$(Now, "dd.mm.yyyy")
    If Len(DteN1.Text) = 2 Or Len(DteN1.Text) = 3 Then DteN1.Text = Left$(DteN1.Text, 2) & "." & Mid$(dte4, 4, 7)
    If Len(DteN1.Text) = 5 Or Len(DteN1.Text) = 6 Then DteN1.Text = Left$(DteN1.Text, 5) & "." & Right$(dte4, 4)
    DteN1.text = .Cdate_calc(DteN1.Text)
    DteN1.Text = .Cdate_aff(DteN1.Text)
  End With
  If DteN1.Text = "00.00.0:00" Then DteN1.Text = Format$(Now, "dd.mm.yyyy")
  If Val(Right$(DteN1.text, 4) & Mid$(DteN1.text, 4, 2) & Left$(DteN1.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate2()
  Else
    If Val(Right$(DteN1.text, 4) & Mid$(DteN1.text, 4, 2) & Left$(DteN1.text, 2)) > Val(Right$(dte2, 4) + 1 & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période selectionnée."
      Compdate2()
    Endif
  Endif
  If Val(Right$(DteN1.text, 4) & Mid$(DteN1.text, 4, 2) & Left$(DteN1.text, 2)) < Val(Right$(DteN0.text, 4) & Mid$(DteN0.text, 4, 2) & Left$(DteN0.text, 2)) Then
    If start.son Then
      Music.Play
    Endif
    If Message.Warning("Attention ! Votre selection n'est pas possible.", "Ok") = 1 Then
      exo()
    Endif
  Endif
  DteN1.Background = Color.TextBackground
Catch
  DteN1_GotFocus()
  DteN1.setfocus
  
End

Public Sub Compdate()
  
  If start.son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E0.Value = True
    DteN0_GotFocus()
    DteN0.setfocus
  Endif
  
End

Public Sub compdate2()
  
  If start.son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E0.Value = True
    DteN1_GotFocus()
    DteN1.setfocus
  Endif
  
End

Public Sub E0_Click()
  
  Tab0 = "Fiches_Mvt"
  Ex1()
  
End

Public Sub E1_Click()
  
  Tab0 = "Fiches_Mvt"
  Exo()
  
End

Public Sub E2_Click()
  
  Tab0 = "Fiches_Mvt1"
  Exo1()
  
End

Public Sub E3_Click()
  
  Tab0 = "Fiches_Mvt2"
  Exo2()
  
End

Public Sub Svs2_Click()
  
  Dialog.Title = "Choisir un repertoire"
  Dialog.Path = User.home
  If Not Dialog.SelectDirectory() Then
    Chmexport.Text = Dialog.Path
  Else
    Chmexport.Text = User.Home
  Endif
  
End

Public Sub export()
  
  Dim Fle2, stext, stext2 As String
  Dim Email As String = Adrexport.Text
  
  Me.Mouse = Mouse.Wait
  Fle2 = Settings["/Soc" & start.societe & "/Chemin-export"] & "/ecritures" & "." & extension
  Stext = "Envoi des fichiers d export"
  stext2 = "Veuillez trouver ci-joint le fichier d'export de nos écritures "
  EnvMail.Envoi2(Email, stext, stext2, Fle2)
  Me.mouse = mouse.Default
Catch
  If start.son Then
    Music.Play
  Endif
  Me.mouse = mouse.Default
  message.Error("Le fichier n'a pas pu être envoyé. vérifiez vos préferences SVP !")
  
End

Public Sub Button2_Click()
  
  Dim i As Integer
  Dim ColResult As Result
  Dim intitule, libellejo, libelle, type As String
  Dim Intitcol As String
  Dim copt As String
  Dim pl As Integer
  Dim Tab, Tab2, Tab3, Tab4 As String
  Dim siren As String
  Dim Ccoll As String
  Dim debitcol As String
  Dim creditcol As String
  Dim TotSldHP As Float
  Dim Bcol As Boolean = False
  Dim Filetxt, datec, Doc As String
  Dim Entete As String = "JournalCode|Journallib|EcritureNum|EcritureDate|CompteNum|CompteLib|CompAuxNum|CompAuxLib|PieceRef|PieceDate|EcritureLib|Debit|credit|EcritureLet|DateLet|ValidDate|MontantDevise|Idevise|"
  
  With utils
    totsldhp = 0.00
    Tab = "centralisation"
    Tab2 = "Fiches_Journaux" 
    Tab3 = "Fiches_Parametres" 
    Tab4 = "Fiches_Comptes" 
    pl = 0
    rResult = Utils.db.Exec("SELECT siret_sc FROM " & Cbase.Table("TabSoc") & " where cd_sc = &1", start.Societe)
    Siren = Left$(Replace$(rResult!siret_sc, " ", ""), 9)
    rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & "")
    dte1 = .Cdate_Dbase(rResult!dteclec1)
    dte2 = .Cdate_Dbase(rResult!dteclec)
    dte2 = Left$(dte2, 4) & Right$(dte2, 2) & Mid$(dte2, 5, 2) 
    Utils.db.Exec("DROP TABLE IF EXISTS centralisation")
    Utils.db.Exec("CREATE TABLE " & Tab & 
      "(cd_cent Char(8) NOT NULL," &
      "intitule Char(40)," &
      "db_cent FLOAT," &
      "crd_cent FLOAT," &
      "njournal Char(2)," &
      "PRIMARY KEY (cd_cent))" & "ENGINE = MYISAM")
    filetxt = User.home & "/" & Siren & "FEC" & dte2
    If Exist(filetxt) Then Kill filetxt
    hFile = Open filetxt For Write Create
    rResult = Utils.db.Exec("SELECT * FROM " & Tab0 & " a inner join " & Cbase.Table("TabJour") & " i on i.code_jo = a.jour WHERE a.validee = &1 And a.dte >= &2 And a.dte <= &3 order by a.dte, a.numero, a.compte ", 1, .Cdate_Dbase(DteN0.Text), .Cdate_Dbase(DteN1.Text))
    If rResult.count <> 0 Then
      i = 0
      Print #hFile, Entete & gb.Cr
      While i < rResult.count
        Ccoll = ""
        Intitcol = ""
        Try Bcol = rResult!collectif
        If Error Then Bcol = False
        If Left$(rResult!compte, 3) = "401" And Not Bcol Or If Left$(rResult!compte, 3) = "411" And Not Bcol Then
          ColResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " WHERE compte_cc = &1", rResult!compte)
          Ccoll = ColResult!coll_cc
          Type = ColResult!type_cc
          ColResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " WHERE compte_cc = &1", Ccoll)
          Intitcol = ColResult!intitule_cc
        Else
          ColResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " WHERE compte_cc = &1", rResult!compte)
          Type = ColResult!type_cc
        Endif
        debitcol = Format$(rResult!montantd, "0.00")
        If Val(debitcol) = 0 Then debitcol = ""
        creditcol = Format$(rResult!montantc, "0.00")
        If Val(creditcol) = 0 Then creditcol = ""
        copt = rResult!numero
        Datec = rResult!dte
        Datec = Right$(datec, 4) & Left$(datec, 2) & Mid$(datec, 4, 2)
        intitule = .Accent(rResult!intitule)
        libellejo = .Accent(rResult!libelle_jo)
        libelle = .Accent(rResult!libelle)
        Doc = rResult!numdoc & String$(10 - Len(rResult!numdoc), " ")
        If IsNull(doc) Or If Doc = String$(10, " ") Then doc = CStr(rResult!numero & String$(10 - Len(Str(rResult!numero)), " "))
        If Not IsNull(debitcol) Or If Not IsNull(creditcol) Then
          If Type = "F" Or If type = "C" Then
            Donnees3(CStr(rResult!jour & String$(2 - Len(rResult!jour), " ")), CStr(libellejo & String$(15 - Len(libellejo), " ")), CStr(rResult!numero & String$(11 - Len(Str(rResult!numero)), " ")), CStr(datec), CStr(Ccoll & String$(8 - Len(Ccoll), " ")), CStr(intitcol & String$(40 - Len(intitcol), " ")), CStr(rResult!compte & String$(8 - Len(rResult!compte), " ")), CStr(intitule & String$(40 - Len(intitule), " ")), CStr(doc), CStr(datec), CStr(libelle & String$(30 - Len(libelle), " ")), CStr(String$(15 - Len(debitcol), " ") & debitcol), CStr(String$(15 - Len(creditcol), " ") & creditcol), CStr(""), CStr(""), CStr(datec), CStr(""), CStr(""))
          Else
            Donnees3(CStr(rResult!jour & String$(2 - Len(rResult!jour), " ")), CStr(libellejo & String$(15 - Len(libellejo), " ")), CStr(rResult!numero & String$(11 - Len(Str(rResult!numero)), " ")), CStr(datec), CStr(rResult!compte & String$(8 - Len(rResult!compte), " ")), CStr(intitule & String$(40 - Len(intitule), " ")), CStr(String$(8, " ")), CStr(String$(40, " ")), CStr(doc), CStr(datec), CStr(libelle & String$(30 - Len(libelle), " ")), CStr(String$(15 - Len(debitcol), " ") & debitcol), CStr(String$(15 - Len(creditcol), " ") & creditcol), CStr(""), CStr(""), CStr(datec), CStr(""), CStr(""))            'Donnees3(CStr(rResult!jour & String$(2 - Len(rResult!jour), " ")), CStr(libellejo & String$(15 - Len(libellejo), " ")), CStr(rResult!numero & String$(11 - Len(Str(rResult!numero)), " ")), CStr(datec), CStr(Ccoll & String$(8 - Len(Ccoll), " ")), CStr(intitcol & String$(40 - Len(intitcol), " ")), CStr(rResult!compte & String$(8 - Len(rResult!compte), " ")), CStr(intitule & String$(40 - Len(intitule), " ")), CStr(rResult!numdoc & String$(10 - Len(rResult!numdoc), " ")), CStr(datec), CStr(libelle & String$(30 - Len(libelle), " ")), CStr(String$(15 - Len(debitcol), " ") & debitcol), CStr(String$(15 - Len(creditcol), " ") & creditcol), CStr(""), CStr(""), CStr(""), CStr(""))
          Endif
        Endif
        i = i + 1
        rResult.MoveNext
      Wend
      Close #hFile
      'Me.Mouse = Mouse.Default
      If message.question("Le fichier " & Filetxt & " a été correctement copié sous votre répertoire \n Voulez-vous l'ouvrir ?", "Oui", "Non") = 1 Then
        Editeur.Prog_Editeur(Filetxt)
      Endif
    Else
      message(" Aucune ecriture pour cette demande", "OK")
    Endif
  End With
  
End

Public Sub donnees1(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5
  
End

Public Sub donnees2(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String, p9 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5 & ";" & p6 & ";" & p7 & ";" & p8 & ";" & p9
  
End

Public Sub donnees3(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String, p9 As String, p10 As String, p11 As String, p12 As String, p13 As String, p14 As String, p15 As String, p16 As String, p17 As String, p18 As String)
  
  Print #hFile, p1 & "|" & p2 & "|" & p3 & "|" & p4 & "|" & p5 & "|" & p6 & "|" & p7 & "|" & p8 & "|" & p9 & "|" & p10 & "|" & p11 & "|" & p12 & "|" & p13 & "|" & p14 & "|" & p15 & "|" & p16 & "|" & p17 & "|" & p18 & "|" & gb.Cr
  
End

Public Sub Button3_Click()
  
  Exec ["xdg-open", Application.Path &/ "Ecrans/Export.html"]
  
End

Public Sub Button4_Click()
  
  If DateChooser1.Visible = True Then 
    DateChooser1.visible = False
  Else
    DateChooser1.Visible = True
  Endif
  Org = "1"
  
End

Public Sub Button1_Click()
  
  If DateChooser1.Visible = True Then 
    DateChooser1.visible = False
  Else
    DateChooser1.Visible = True
  Endif
  Org = "2"
  
End

Public Sub DateChooser1_Activate()
  
  If Org = "1" Then
    DteN0.Text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  Else
    DteN1.Text = Format$(DateChooser1.Value, "dd.mm.yyyy")
  Endif
  DateChooser1.visible = False
  
End
