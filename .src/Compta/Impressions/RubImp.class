' Gambas class file

'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : RubImp.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : Janvier 2012
'# Edition du compte de résultat
'################################################

Private dte As String
Private dte1 As String
Private dte2 As String
Private dtes1 As String
Private dtes2 As String
Private jour As String
Private Txt As String
Private son As Integer = Start.Son
Private Filename As String
Private sens As Integer
Private PosY As Integer
Private Nbpage As Integer = 1
Private Ste As String
Private dateedition As String
Private pdf As Cresultat

Public Sub _New()

  Utils.Observers(Me)

  Music.Load(Start.Musique)
  E1_click()
  Me.Center
  dteN0.SetFocus

End

Public Sub Recup_Dtes()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")

    If E1.value = True Then
      dtes1 = rResult!dteclec2
      dtes1 = .Calc_mois(dtes1)
      dtes2 = rResult!dteclec1
      dtes2 = .Cdate_aff(dtes2)
    Endif
    If N1.value = True Then
      dtes1 = rResult!dteclec3
      dtes1 = .Calc_mois(dtes1)
      dtes2 = rResult!dteclec2
      dtes2 = .Cdate_aff(dtes2)
    Endif
    If N2.value = True Then
      dtes1 = rResult!dteclec4
      dtes1 = .Calc_mois(dtes1)
      dtes2 = rResult!dteclec3
      dtes2 = .Cdate_aff(dtes2)
    Endif
    If N3.value = True Then
      dtes1 = rResult!dteclec5
      dtes1 = .Calc_mois(dtes1)
      dtes2 = rResult!dteclec4
      dtes2 = .Cdate_aff(dtes2)
    Endif
    If N4.value Then
      dtes1 = rResult!dteclec5
      dtes1 = .Calc_mois(dtes1)
      dtes2 = rResult!dteclec5
      dtes2 = .Cdate_aff(dtes2)
      dtes1 = Left$(dtes1, 6) & Right$(dtes2, 4)
    Endif
    If N5.value Then
      dtes1 = ""
      dtes2 = ""
    Endif
  End With

End

Public Sub Ex1()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With Utils
    dteN0.Text = ""
    dteN1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec
    dte2 = rResult!dteclec1
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    jour = Format$(Now, "dd.mm.yyyy")
    If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) < Right$(dteN0.Text, 4) & Mid$(dteN0.Text, 4, 2) & Left$(dteN0.Text, 2) Then
      Exo()
    Else
      dteN1.Text = jour
      dte1 = dteN0.Text
    Endif
  End With

End

Public Sub Exo()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With Utils
    dteN0.Text = ""
    dteN1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    dte2 = dte
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec)
    dte1 = dteN0.Text
  End With

End

Public Sub Exo1()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec2
    dte2 = dte
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec1)
    dte1 = dteN0.Text
  End With

End

Public Sub Exo2()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec3
    dte2 = dte
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec2)
    dte1 = dteN0.Text
  End With

End

Public Sub Exo3()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec4
    dte2 = dte
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec3)
    dte1 = dteN0.Text
  End With

End

Public Sub Exo4()

  Dim rResult As Result
  Dim Tab As String

  Tab = "Fiches_Parametres"
  Raz()
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec5
    dte2 = dte
    dte2 = .Cdate_aff(dte2)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec4)
    dte1 = dteN0.Text
  End With

End

Public Sub Exo5()

  Dim rResult As Result
  Dim Tab As String
  Dim Mois As Integer

  Tab = "Fiches_Parametres"
  Raz()
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec5
    dte = Left$(dte, 10)
    dte2 = ""
    Mois = Val(Right$(dte, 4))
    dte = Left$(dte, 6) & (Mois - 1)
    dteN0.Text = .Calc_mois(dte)
    dteN1.Text = .Cdate_aff(rResult!dteclec5)
    dte1 = dteN0.Text
  End With

End

Public Sub Cmpt_KeyPress()

  Select Case Last.tag

    Case 1
      If Key.code = Key.enter Or Key.code = Key.Return Or Key.code = Key.Tab Then
        dteN0_LostFocus()
        dteN1.SetFocus
        dteN1.Select
        Stop Event
      Endif

    Case 2
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        dteN1_LostFocus()
        dteN0.SetFocus
        dteN0.Select
        Stop Event
      Endif
  End Select

  If key.code = key.F1 Then
    Button1_Click()
    Stop Event
  Endif

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      Button1_Click()

    Case 2
      Button2_Click()

    Case 3
      If Exist(filename) Then Try Kill filename
      Me.Close
  End Select

End
'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************

Public Sub Cmpt_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub dteN0_LostFocus()

  With utils
    dteN0.text = .Cdate_calc(dteN0.text)
    dteN0.Text = .Cdate_aff(dteN0.Text)
  End With
  If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate()
  Else
    If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) > Val(Right$(dte, 4) & Mid$(dte, 4, 2) & Left$(dte, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à  la fin de la période selectionnée."
      Compdate()
    Endif
  Endif
  dteN0.Background = Color.TextBackground
Catch
  dteN0.setfocus

End

Public Sub dteN1_LostFocus()

  With utils
    dteN1.text = .Cdate_calc(dteN1.text)
    dteN1.Text = .Cdate_aff(dteN1.Text)
  End With
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate2()
  Else
    If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) > Val(Right$(dte, 4) & Mid$(dte, 4, 2) & Left$(dte, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à  la fin de la période selectionnée."
      Compdate2()
    Endif
  Endif
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) Then
    If son Then
      Music.Play
    Endif
    If Message.Warning("Attention ! Votre selection n'est pas possible.", "Ok") = 1 Then
      exo()
    Endif
  Endif
  dteN1.Background = Color.TextBackground
Catch
  dteN1.setfocus

End

Public Sub Compdate()

  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E1.Value = True
    dteN0.setfocus
  Endif

End

Public Sub compdate2()

  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E1.Value = True
    dteN1.setfocus
  Endif

End

Public Sub E0_Click()
  'Tab0 = "Fiches_Mvt"

  Ex1()

End

Public Sub E1_Click()
  'Tab0 = "Fiches_Mvt"

  Exo()

End

Public Sub N1_Click()
  'Tab0 = "Fiches_Mvt1"

  Exo1()

End

Public Sub N2_Click()
  'Tab0 = "Fiches_Mvt2"

  Exo2()

End

Public Sub N3_Click()
  'Tab0 = "Fiches_Mvt3"

  Exo3()

End

Public Sub N4_Click()
  'Tab0 = "Fiches_Mvt4"

  Exo4()

End

Public Sub N5_Click()
  'Tab0 = "Fiches_Mvt5"

  Exo5()

End

Public Sub Raz()

End

Public Sub Button2_Click()

  Dim Tab As String
  Dim Tab1 As String
  Dim Tab2 As String
  Dim Tab3 As String
  Dim Tab4 As String
  Dim Tab5 As String
  Dim Tab6 As String
  Dim Tab7 As String
  Dim prefix As String
  Dim Rub As String
  Dim RubE As String
  Dim RubO As String
  Dim intitrub As String
  Dim intitrubE As String
  Dim intitrubT As String
  Dim intitcpt As String
  Dim compte As String
  Dim Det As String
  Dim DetE As String
  Dim cpt As String
  Dim cpt1 As String
  Dim cpt2 As String
  Dim cpt3 As String
  Dim type As String
  Dim typeE As String
  Dim typeS As String
  Dim periode As String
  Dim detail As String
  Dim exercice As String
  Dim ETot1 As Float ' Total de l'entete
  Dim ETot2 As Float ' Total de l'entete
  Dim ETot3 As Float ' Total de l'entete
  Dim ETot4 As Float ' Total de l'entete
  Dim Etot5 As Float ' variable d'écriture pour total Entete periode
  Dim Etot6 As Float ' variable d'écriture pour total Entete periode precedente
  Dim Ltot1 As Float ' Total de la ligne
  Dim Ltot2 As Float ' Total de la ligne
  Dim Ltot3 As Float ' Total de la ligne
  Dim Ltot4 As Float ' Total de la ligne
  Dim Ltot5 As Float ' variable d'écriture pour total ligne période
  Dim Ltot6 As Float ' variable d'écriture pour total ligne période precedente
  Dim STot1 As Float ' Sous-Total
  Dim STot2 As Float ' Sous-Total
  Dim Stot5 As Float ' variable d'écriture pour Sous-Total période
  Dim Stot6 As Float ' variable d'écriture pour Sous-Total période précédente
  Dim Otot1 As Float
  Dim Otot2 As Float
  Dim Otot3 As Float
  Dim Otot4 As Float
  Dim Otot5 As Float 'variable d'écriture pour Total période
  Dim Otot6 As Float 'variable d'écriture pour Total période précédente
  Dim Ttot1 As Float
  Dim Ttot5 As Float
  Dim Ttot6 As Float
  Dim Tproduit1, Tproduit2, Tcharge1, Tcharge2 As Float = 0
  Dim Imp1 As String ' variable pour l'impression des lignes période
  Dim Imp2 As String ' variable pour l'impression des lignes période précédente
  Dim rResult As Result
  Dim Tab1Rslt As Result
  Dim Tab3Rslt As Result
  Dim Tab5Rslt As Result
  Dim Tab6Rslt As Result
  Dim steresult As Result
  Dim IntResult As Result
  Dim p As Integer 'compteur de lignes
  Dim p1 As Integer
  Dim p5 As String
  Dim Dten2, Dten3 As String
  Dim Hnew As File
  Dim filename As String

  filename = User.Home & "/tmp/Resultat.csv"
  If Exist(filename) Then Try Kill filename
  Hnew = Open filename For Write Create

  Message.info("Attention, ce traitement peut être très long")
  Tab = "centralisation"
  Tab1 = "Fiches_Rubriques"
  Tab2 = "Fiches_Parametres"
  Tab3 = "Fiches_RubCompt"
  Tab4 = "Fiches_Comptes"
  If E1.Value Then
    Tab5 = "Fiches_Mvt"
    Tab6 = "Fiches_Mvt1"
    Exercice = "E1"
  Endif
  If N1.Value Then
    Tab5 = "Fiches_Mvt1"
    Tab6 = "Fiches_Mvt2"
    Exercice = "N1"
  Endif
  If N2.Value Then
    Tab5 = "Fiches_Mvt2"
    Tab6 = "Fiches_Mvt3"
    Exercice = "N2"
  Endif
  If N3.Value Then
    Tab5 = "Fiches_Mvt3"
    Tab6 = "Fiches_Mvt4"
    Exercice = "N3"
  Endif
  If N4.Value Then
    Tab5 = "Fiches_Mvt4"
    Tab6 = "Fiches_Mvt5"
    Exercice = "N4"
  Endif
  If N5.Value Then
    Tab5 = "Fiches_Mvt5"
    Exercice = "N5"
  Endif
  Tab7 = "Fiches_Societes"
  SteResult = Utils.db.Exec("SELECT * FROM " & Tab7 & " Where cd_sc = &1", Start.Societe)
  Ste = "Societe " & " " & SteResult!int_sc
  Recup_Dtes()
  Etot1 = 0
  Etot2 = 0
  Etot3 = 0
  Etot4 = 0
  Ltot3 = 0
  Ltot4 = 0
  Etot2 = 0
  Otot1 = 0
  Ttot1 = 0
  P1 = 0
  RubE = "0"
  RubO = "0"
  Me.Mouse = Mouse.Wait
  With utils
    'On supprime la table Centralisation si elle existe
    Utils.db.Exec("DROP TABLE IF EXISTS centralisation")

    'Puis on la crée
    Utils.db.Exec("CREATE TABLE " & Tab &
      "(numrub Char(5) NOT NULL," &
      "intitrub Char(70)," &
      "type Char(1)," &
      "detail Char(1)," &
      "compte Char(8)," &
      "intitcpt Char(50)," &
      "Col1 Char(25)," &
      "Col2 Char(25)," &
      "col3 Char(25)," &
      "col4 Char(25)," &
      "PRIMARY KEY (numrub, compte))" & Utils.db.Engine())

    ' On récupère le type d'impression
    If Bilan.Value Then
      Prefix = "B"
      Filename = User.Home & "/tmp/Bilan.pdf"
    Endif
    If Crlt.Value Then
      Prefix = "R"
      Filename = User.Home & "/tmp/Resultat.pdf"
    Endif
    If Sig.Value Then
      prefix = "S"
      Filename = User.Home & "/tmp/SIG.pdf"
    Endif
    If Impd.Value Then
      detail = "Impression détaillée."
    Else
      detail = ""
    Endif
    Periode = "Exercice N du " & dteN0.Text & " au " & dteN1.Text & "   " & "Exercice N -1 du " & dtes1 & " au " & dtes2 & ""
    If prefix = "B" Then
      Imp_Bilan.Lancement(Impd.value, dteN0.Text, dteN1.Text, dtes1, dtes2, exercice)
    Else
      If prefix = "S" Then
        Imp_Sig.Lancement(Impd.value, dteN0.Text, dteN1.Text, dtes1, dtes2, exercice)
      Else
        '******************************************************************
        '* On centralise les lignes et les entetes de la période demandée *
        '******************************************************************
        ' On sélectionne nos rubriques
        RubE = "0"
        Tab1Rslt = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE left(numrub,1) = &1 order by numrub", Prefix)
        If Tab1Rslt.Count Then
          Repeat
            Rub = Tab1Rslt!numrub
            intitrub = Tab1Rslt!intitule
            type = Tab1Rslt!type
            Det = Tab1Rslt!detail
            If type = "L" Then Det = "N"
            rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", Rub)
            If Not rResult.Available And intitrub Then
              Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, type, detail, Col1, Col2, col3, col4, compte) VALUES ( &1, &2, &3, &4, &5, &6, &7, &8, &9)", Rub, intitrub, type, det, 0, 0, 0, 0, "0")
            Else
              Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, type = &3, detail = &4, Col1 = &5, Col2 = &6, col3 = &7, col4 = &8 WHERE numrub = &1", Rub, intitrub, type, det, 0, 0, 0, 0)
            Endif

            If type = "L" Then
              Tab3Rslt = Utils.db.Exec("SELECT * FROM " & Tab3 & " WHERE numrub = &1 order by numrub", Rub)
              If Tab3Rslt.Count Then
                Repeat
                  cpt1 = Tab3Rslt!compte1
                  cpt2 = Tab3Rslt!compte2
                  'Tab5Rslt = Utils.db.Exec("SELECT * FROM " & Tab5 & " WHERE compte >= &1 and compte <= &2 order by compte", cpt1, cpt2)
                  Tab5Rslt = Utils.db.Exec("SELECT * FROM " & Tab5 & " WHERE compte >= &1 and compte <= &2 And dte >= &3 And dte <= &4 And validee = &5 order by compte", cpt1, cpt2, Utils.Cdate_Dbase(dten0.Text), Utils.Cdate_Dbase(dten1.Text), 1)
                  If Tab5Rslt.Count Then
                    Repeat
                      'If .Cdate_Comp(Tab5Rslt!dte) >= .Cdate_Dbase(dten0.Text) And .Cdate_Comp(Tab5Rslt!dte) <= .Cdate_Dbase(dten1.Text) Then
                      cpt = Tab5Rslt!compte
                      intitcpt = Tab5Rslt!intitule
                      Ltot2 = Tab5Rslt!montantd - Tab5Rslt!montantc
                      Ltot3 = Ltot3 + Ltot2
                      Ltot4 = Ltot4 + Ltot2
                      Ltot5 = Ltot3
                      Print #Hnew, Rub & ";" & cpt1 & ";" & cpt2 & ";" & intitrub & ";" & Tab5Rslt!dte & ";" & cpt & ";" & intitcpt & ";" & .cpoint(Tab5Rslt!montantd) & ";" & .cpoint(Tab5Rslt!montantc) & ";" & .cpoint(Ltot3) & ";\n"
                      Print #Hnew, Rub & ";" & cpt1 & ";" & cpt2 & ";" & intitrub & ";" & Tab5Rslt!dte & ";" & cpt & ";" & intitcpt & ";" & .cpoint(Tab5Rslt!montantd) & ";" & .cpoint(Tab5Rslt!montantc) & ";" & .cpoint(Ltot3)
                      If Impd.Value Then
                        cpt3 = cpt
                        det = "O"
                        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1 and compte = &2", Rub, cpt)
                        If Ltot5 <> "" Then
                          If Not rResult.Available Then
                            Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, compte, intitcpt, type, detail, col3, col4) VALUES ( &1, &2, &3, &4, &5, &6, &7, &8)", Rub, intitrub, cpt, intitcpt, type, det, Ltot2, 0)
                          Else
                            Ltot2 = Ltot2 + Val(.cpoint(rResult!col3))
                            Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, compte = &3, intitcpt = &4, type = &5, detail = &6, col3 = &7 WHERE numrub = &1 and compte = &3", Rub, intitrub, cpt, intitcpt, type, det, Ltot2)
                          Endif
                        Endif
                        Ltot2 = 0
                      Endif
                      'Endif
                    Until Tab5Rslt.MoveNext()
                    If Ltot5 <> "" Then
                      cpt = " "
                      intitcpt = ""
                      Det = "N"
                      Etot3 = Etot3 + Ltot3
                      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", Rub)
                      If Not rResult.Available Then
                        Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, compte, intitcpt, type, detail, col3, col4) VALUES ( &1, &2, &3, &4, &5, &6, &7, &8)", Rub, intitrub, cpt, intitcpt, type, det, Etot3, 0)
                      Else
                        Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, compte = &3, intitcpt = &4, type = &5, detail = &6, col3 = &7 , col4 = &8 WHERE numrub = &1 and compte = &3", Rub, intitrub, cpt, intitcpt, type, det, Etot3, 0)
                      Endif
                    Endif
                    Ltot3 = 0
                  Endif
                Until Tab3Rslt.MoveNext()
              Endif
            Endif
            Etot1 = Etot1 + Etot3
            Etot3 = 0
            Ltot4 = 0
            If type = "T" Then
              Etot1 = 0
              Stot1 = 0
              Ltot1 = 0
              Ltot3 = 0
            Endif
            If type = "E" And Det = "N" Or If type = "O" Then
              If RubE <> "0" Then
                rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", RubE)
                If Not rResult.Available Then
                  Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, type, detail, col3, col4, compte) VALUES ( &1, &2, &3, &4, &5, &6, &7)", RubE, intitrubE, type, detE, Etot1, 0, "")
                Else
                  Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, type = &3, detail = &4, col3 = &5, col4 = &6 WHERE numrub = &1", RubE, intitrubE, type, detE, Etot1, 0)
                Endif
              Endif
              Etot1 = 0
              RubE = Rub
              intitrubE = intitrub
              typeE = Tab1Rslt!type
              DetE = Tab1Rslt!detail
            Endif
          Until Tab1Rslt.MoveNext()
        Endif

        '
        '********************************************************************
        '* On centralise les lignes et les entetes de la période précédente *
        '********************************************************************
        ' On sélectionne nos rubriques
        RubE = "0"
        Etot1 = 0
        Etot2 = 0
        Etot3 = 0
        Etot4 = 0
        Ltot3 = 0
        Ltot4 = 0
        Etot2 = 0
        Otot1 = 0
        dten2 = Val(Right$(dten0.Text, 4)) - 1
        dten2 = Left$(Dten0.Text, 6) & dten2
        dten3 = Val(Right$(dten1.Text, 4)) - 1
        dten3 = Left$(Dten1.Text, 6) & dten3
        If N5.value = False Then
          Tab1Rslt = Utils.db.Exec("SELECT * FROM " & Tab1 & " WHERE left(numrub,1) = &1 order by numrub", Prefix)
          If Tab1Rslt.Count Then
            Repeat
              Rub = Tab1Rslt!numrub
              intitrub = Tab1Rslt!intitule
              type = Tab1Rslt!type
              Det = Tab1Rslt!detail
              If type = "L" Then Det = "N"
              rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", Rub)
              If Not rResult.Available And intitrub Then
                Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, type, detail, col4, compte) VALUES ( &1, &2, &3, &4, &5, &6)", Rub, intitrub, type, det, 0, "")
              Else
                Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, type = &3 WHERE numrub = &1", Rub, intitrub, type)
              Endif
              If type = "L" Then
                Tab3Rslt = Utils.db.Exec("SELECT * FROM " & Tab3 & " WHERE numrub = &1 order by numrub", Rub)
                If Tab3Rslt.Count Then
                  Repeat
                    cpt1 = Tab3Rslt!compte1
                    cpt2 = Tab3Rslt!compte2
                    'Tab6Rslt = Utils.db.Exec("SELECT * FROM " & Tab6 & " WHERE compte >= &1 and compte <= &2 order by compte", cpt1, cpt2)
                    Tab6Rslt = Utils.db.Exec("SELECT * FROM " & Tab6 & " WHERE compte >= &1 and compte <= &2 And dte >= &3 And dte <= &4 And validee = &5 order by compte", cpt1, cpt2, .Cdate_Dbase(dten2), .Cdate_Dbase(dten3), 1)
                    If Tab6Rslt.Count Then
                      Repeat
                        cpt = Tab6Rslt!compte
                        intitcpt = Tab6Rslt!intitule
                        Ltot2 = Tab6Rslt!montantd - Tab6Rslt!montantc
                        Ltot3 = Ltot3 + Ltot2
                        Ltot4 = Ltot4 + Ltot2
                        Ltot6 = Ltot3
                        If Impd.Value Then
                          Det = "0"
                          cpt3 = cpt
                          rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1 and compte = &2", Rub, cpt)
                          If Ltot6 <> "" Then
                            If Not rResult.Available Then
                              Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, compte, intitcpt, type, detail, col4) VALUES ( &1, &2, &3, &4, &5, &6, &7)", Rub, intitrub, cpt, intitcpt, type, det, Ltot2)
                            Else
                              If Not IsNull(rResult!col4) Then Ltot2 = Ltot2 + Val(.cpoint(rResult!col4))
                              Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, compte = &3, intitcpt = &4, type = &5, detail = &6, col4 = &7 WHERE numrub = &1 and compte = &3", Rub, intitrub, cpt, intitcpt, type, det, Ltot2)
                            Endif
                          Endif
                          Ltot2 = 0
                        Endif
                      Until Tab6Rslt.MoveNext()
                      If Ltot6 <> "" Then
                        cpt = " "
                        intitcpt = ""
                        Det = "N"
                        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", Rub)
                        If Not rResult.Available Then
                          Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, compte, intitcpt, type, detail, col4) VALUES ( &1, &2, &3, &4, &5, &6, &7)", Rub, intitrub, cpt, intitcpt, type, det, Ltot3)
                        Else
                          Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, compte = &3, intitcpt = &4, type = &5, detail = &6, col4 = &7 WHERE numrub = &1 and compte = &3", Rub, intitrub, cpt, intitcpt, type, det, ltot3)
                        Endif
                      Endif
                      Etot3 = Etot3 + Ltot3
                      Ltot3 = 0
                    Endif
                  Until Tab3Rslt.MoveNext()
                Endif
              Endif
              Etot1 = Etot1 + Etot3
              Etot3 = 0
              Ltot1 = 0
              If type = "T" Then
                Etot1 = 0
                Stot1 = 0
                Ltot1 = 0
                Ltot3 = 0
              Endif
              If type = "E" And Det = "N" Or If type = "O" Then
                If RubE <> "0" Then
                  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE numrub = &1", RubE)
                  If Not rResult.Available Then
                    Utils.db.Exec("INSERT INTO " & Tab & "(numrub, intitrub, type, detail, col4, compte) VALUES ( &1, &2, &3, &4, &5, &6)", RubE, intitrubE, typeE, detE, Etot1, "")
                  Else
                    Utils.db.Exec("UPdate  " & Tab & "  SET  numrub = &1, intitrub = &2, type = &3, col4 = &4 WHERE numrub = &1", RubE, intitrubE, typeE, Etot1)
                  Endif
                Endif
                Etot1 = 0
                RubE = Rub
                intitrubE = intitrub
                typeE = Tab1Rslt!type
                DetE = Tab1Rslt!detail
              Endif
            Until Tab1Rslt.MoveNext()
          Endif
        Endif

        '********************************************************
        '* On centralise les sous-totaux pour les deux périodes *
        '********************************************************
        Etot1 = 0
        Etot2 = 0
        Otot1 = 0
        Otot2 = 0
        Stot1 = 0
        Stot2 = 0
        P1 = 0
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
        If rResult.Count Then
          Repeat
            Rub = rResult!numrub
            intitrub = rResult["intitrub"]
            type = rResult!type
            det = rResult!detail & "detail"
            If type = "E" Then
              If rResult!col3 <> "" Then
                Try Etot1 = Etot1 + Val(rResult!col3)
                If Error Then Etot1 = Etot1 + rResult!col3
              Endif
              If rResult!col4 <> "" Then
                Try Etot2 = Etot2 + Val(rResult!col4)
                If Error Then Etot2 = Etot2 + rResult!col4
              Endif
              'Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Etot1, Etot2)
            Endif
            If type = "S" Then
              Stot1 = Stot1 + Etot1
              Otot1 = Otot1 + Stot1
              Stot2 = Stot2 + Etot2
              Otot2 = Otot2 + Stot2
              Etot1 = 0
              Etot2 = 0
              Stot5 = Stot1
              Stot6 = Stot2
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Stot5, Stot6)
            Endif
            If type = "O" And Left(Rub, 1) = "R" Then
              Etot1 = 0
              Etot2 = 0
              Otot5 = Stot1
              Otot6 = Stot2
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Otot5, Otot6)
            Endif
            If type = "T" Then
              Stot1 = 0
              Stot2 = 0
              Etot1 = 0
              Etot2 = 0
            Endif
          Until rResult.MoveNext()
        Endif

        '*************************************************************
        '* On calcul les soldes et les totaux pour les deux périodes *
        '*************************************************************
        Otot1 = 0
        Otot2 = 0
        Otot5 = "0"
        Ttot5 = "0"
        Otot6 = "0"
        Ttot6 = "0"
        '------------------------------------------------------------------------
        'On calcule les totaux des produits ou des charges.
        'rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " as e inner join " & Tab1 & " as a on a.numrub = e.numrub")
        If rResult.Count Then
          Repeat
            Rub = rResult!numrub
            intitrub = rResult["intitrub"]
            type = rResult!type
            det = rResult!detail
            If rResult!num = "P" Then
              Tproduit1 = Tproduit1 + Abs(Val(.cpoint(rResult!col3)))
              Tproduit2 = Tproduit2 + Abs(Val(.cpoint(rResult!col4)))
            Endif
            If rResult!num = "C" Then
              Tcharge1 = Tcharge1 + Abs(Val(.cpoint(rResult!col3)))
              Tcharge2 = Tcharge2 + Abs(Val(.cpoint(rResult!col4)))
            Endif
            If type = "S" Then
              Etot5 = rResult!col3
              Etot6 = rResult!col4
            Endif
            If type = "E" Then
              Etot5 = Etot5 + rResult!col3
              Try Etot6 = Etot6 + rResult!col4
              If Error Then Etot6 = Etot6 + Val(rResult!col4)
            Endif
            If type = "O" Then
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Etot5, Etot6)
            Endif
          Until rResult.MoveNext()
        Endif

        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where type = &1", "O")
        If rResult.Count Then
          If Left(rResult!numrub, 1) = "R" Then
            Repeat
              Rub = rResult!numrub
              intitrub = rResult["intitrub"]
              type = rResult!type
              det = rResult!detail
              If P1 = 1 Then
                Otot5 = rResult!col3
                Otot6 = rResult!col4
              Else
                Ttot5 = rResult!col3
                Ttot6 = rResult!col4
              Endif
              Inc P1
            Until rResult.MoveNext()
          Endif
        Endif
        If ttot5 < 0 Then
          typeS = "C"
          Otot3 = Otot5 + Ttot5
          Otot5 = Otot3
        Else
          If Abs(Otot5) > Abs(Ttot5) Then
            typeS = "C"
            Otot3 = Otot5 + Ttot5
            Otot5 = Otot3
          Else
            typeS = "D"
            Otot3 = Abs(Otot5) - Ttot5
            Otot5 = Otot3
          Endif
        Endif
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where type = &1", typeS)
        If rResult.Available Then
          Rub = rResult!numrub
          Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2 WHERE numrub = &1", Rub, Otot5)
        Endif
        If Abs(Otot6) > Abs(Ttot6) Then
          typeS = "C"
        Else
          typeS = "D"
        Endif
        Otot3 = Abs(Otot6) - Abs(Ttot6)
        Otot6 = Abs(Otot3)
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where type = &1", typeS)
        If rResult.Available Then
          Rub = rResult!numrub
          Utils.db.Exec("UPdate  " & Tab & "  SET col4 = &2 WHERE numrub = &1", Rub, Otot6)
        Endif
        '--------------------------------------------------
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
        If rResult.Count Then
          Repeat
            Rub = rResult!numrub
            intitrub = rResult["intitrub"]
            type = rResult!type
            det = rResult!detail
            If type = "O" Then
              Otot5 = rResult!col3
              Otot6 = rResult!col4
            Endif
            If type = "C" Then
              Stot5 = rResult!col3
              Stot6 = rResult!col4
            Endif
            If type = "D" Then
              Stot5 = rResult!col3
              Stot6 = rResult!col4
            Endif
            If type = "R" Then
              Stot5 = Otot5 + Abs(Stot5)
              Stot6 = Abs(Otot6) + Abs(Stot6)
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Tproduit1, Tproduit2)
            Endif
            If type = "G" And types = "C" Then
              Stot5 = Abs(Otot5)
              Stot6 = Abs(Otot6)
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Tcharge1, Tcharge2)
            Endif
            'If type = "R" And types = "D" Then
            'Stot5 = Otot5 + Abs(Stot5)
            'Stot6 = Abs(Otot6) + Abs(Stot6)
            'Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Stot5, Stot6)
            'Endif
            If type = "G" And types = "D" Then
              Stot5 = Abs(Otot5) + Abs(Stot5)
              Stot6 = Abs(Otot6) + Abs(Stot6)
              Utils.db.Exec("UPdate  " & Tab & "  SET col3 = &2, col4 = &3 WHERE numrub = &1", Rub, Stot5, Stot6)
            Endif
          Until rResult.MoveNext()
        Endif

        '**************************************
        '*               On imprime           *
        '**************************************
        Tab1Rslt = Utils.db.Exec("SELECT * FROM " & Tab & " Order by numrub, detail, compte")
        P5 = ""
        p1 = 0
        sens = 0
        If Tab1Rslt.Count Then
          dateedition = "du " & dteN0.Text & " au " & dteN1.Text
          Nbpage = 1
          Shell "cd " & User.Home & ""
          pdf = New Cresultat("Portrait", "mm", "A4")
          pdf.Open()
          pdf.AliasNbPages()
          Repeat
            Otot3 = 0
            Otot4 = 0
            Imp1 = 0
            Imp2 = 0
            Rub = Tab1Rslt!numrub
            intitrub = Tab1Rslt!intitrub
            compte = Tab1Rslt!compte
            If Not IsNull(compte) Then
              IntResult = Utils.db.Exec("SELECT intitule_cc FROM " & Cbase.Table("TabComptes") & " where compte_cc = &1 ", compte)
              Try Intitcpt = IntResult!intitule_cc
            Endif
            type = Tab1Rslt!type
            If type = "T" Then intitrubT = Tab1Rslt!intitrub
            Det = Tab1Rslt!detail
            If Tab1Rslt!col3 <> "" Then
              Otot3 = Val(.cpoint(Tab1Rslt!col3))
              imp1 = Format$(Otot3, "0")
              'If type = "C" Then Imp1 = Abs(Val(imp1))
              If sens = 1 And Val(Imp1) < 0 Then
                Imp1 = Abs(Val(imp1))
                Imp1 = Format$(Imp1, "0")
              Else
                If sens = 1 And type <> "G" Then
                  imp1 = "-" & Val(imp1)
                  Imp1 = Format$(Imp1, "0")
                Endif
              Endif
              If Val(imp1) = 0 Then imp1 = ""
            Endif
            If Tab1Rslt!col4 <> "" Then
              Otot4 = Val(.cpoint(Tab1Rslt!col4))
              Imp2 = Format$(Otot4, "0")
              'If type = "C" Then Imp2 = Abs(Val(imp2))
              If sens = 1 And Val(Imp2) < 0 Then Imp2 = Format$(Abs(Val(imp2)), "########")
              If Val(imp2) = 0 Then imp2 = ""
            Endif
            If type = "T" Then
              If p1 = 1 Then pdf.Baspage()
              p1 = 1
              pdf.Level0(IntitrubT, periode, detail, ste)
              posy = 32
              pdf.level3("Exercice N", "Exercice N -1", Posy)
              Posy += 12
              p = 8
              p1 = 1
            Endif
            If type = "E" Then
              p = p + 1
              If Det Then
                pdf.level1(intitrub, p5, imp1, imp2, Posy)
              Else
                pdf.level1(intitrub, p5, p5, p5, Posy)
              Endif
              posy += 6
            Endif
            If type = "L" Then
              If Det = "N" Then
                'If Impd.Value = True Then
                pdf.level7(intitrub, imp1, imp2, Posy)
                'Else
                'pdf.level7(intitrub, "", imp2, Posy)
                'Endif
              Else
                pdf.level2(intitcpt, compte, cpt, p5, imp1, imp2, Posy)
              Endif
              Posy += 6
              p = p + 1
            Endif
            If type = "S" Then
              pdf.level1(intitrub, p5, imp1, imp2, Posy)
              Posy += 6
              p = p + 2
            Endif
            If type = "O" Then
              pdf.level1(intitrub, p5, imp1, imp2, Posy)
              Posy += 6
              p = p + 2
            Endif
            If type = "C" Then
              Try imp1 = Abs(Val(imp1))
              Try imp2 = Abs(Val(imp2))
              pdf.level1(intitrub, p5, imp1, imp2, Posy)
              Posy += 6
              p = p + 1
            Endif
            If type = "D" Then
              pdf.level1(intitrub, p5, imp1, imp2, Posy)
              Posy += 6
              p = p + 1
            Endif
            If type = "R" Then
              pdf.level1(intitrub, p5, Tproduit1, Tproduit2, Posy)
              Posy += 6
              p = p + 2
              sens = 1
            Endif
            If type = "G" Then
              pdf.level1(intitrub, p5, Tcharge1, Tcharge2, Posy)
              Posy += 6
              p = p + 2
            Endif
            If p = 45 Then
              p = 8
              If p1 = 1 Then pdf.Baspage()
              pdf.Level0(IntitrubT, periode, detail, ste)
              posy = 32
              pdf.level3("Exercice N", "Exercice N -1", Posy)
              Posy += 12
              p = 8
              p1 = 1
            Endif
          Until Tab1Rslt.MoveNext()
          Posy += 6
          pdf.Baspage()
          pdf.Output(Filename, False)
          Visualiseur.Prog_Editeur(Filename)
        Else
          Message.Info("Rien a imprimer pour cette période !")
        Endif
      Endif
    Endif
    Me.Mouse = Mouse.Default
  End With

  Try Close #Hnew

End

Public Sub Bilan_Click()

  Impd.Enabled = False

End

Public Sub Sig_Click()

  Impd.Enabled = False

End

Public Sub Crlt_Click()

  Impd.Enabled = True

End

'********************
'* On lance la doc  *
'********************
Public Sub Button1_Click()

  Doc.Open("Bcrimp")

End
