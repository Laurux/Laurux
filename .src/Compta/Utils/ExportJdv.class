' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Exportjdv.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 02/08/2007
'# Export des écritures dans un fichier texte
'################################################

Private Debhp As Float
Private Credhp As Float
Private totsldhp As Float
Private TotDeb As Float
Private TotCred As Float
Private TotSld As Float
Private debit As Float
Private credit As Float
Private solde As Float
Private dte As String
Private dte1 As String
Private dte2 As String
Private dte4 As String
Private Txt As String
Private Filetxt As String
Private Filetxt2 As String
Private jour As String
Private hfile As File
Private hfile2 As File
Private rResult As Result
Private rrrResult As Result
Private CliResult As Result
Private type_jour As String
Private Tab As String
Private Tab0 As String
Private Db_ction As Float
Private Cd_ction As Float
Private Compt As String
Private son As Integer = Start.Son
Private Extension As String
Private ChangeDte As String
Private ChangeDate As String
Private Changedate2 As String
Private Intitule_Soc As String
Private bsage As Boolean = True

Public Sub _New()
  
  If Settings["/Soc" & Start.societe & "/Coul_fen"] Then Utils.Observers(Me)
  Music.Load(Start.Musique)
  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    cpt.Text = rResult!jrnal
  Endif
  rResult = Utils.db.Exec("select * from " & Cbase.Table("TabSoc") & "")
  Intitule_Soc = rResult!type_sc & " " & rResult!int_sc
  Intitule_soc = Left$(Intitule_Soc, 30)
  Try Chmexport.Text = Settings["/Soc" & Start.societe & "/Chemin-export"]
  If IsNull(Chmexport.Text) Then Chmexport.Text = User.Home
  Try Adrexport.Text = Settings["/Soc" & Start.societe & "/Adr-export"]
  If Settings["/Soc" & Start.societe & "/Expmail"] Then
    Envoi.Value = True
  Else
    Envoi.value = False
  Endif
  'ISettings["/Soc" & Start.2societe & "/Gestion"] THEN
  '  Label1.Visible = FALSE
  '  Togglebutton3.Visible = FALSE
  '  Cpt.visible = FALSE
  '  Frame3.visible = FALSE
  '  Dtes2.text = " Vous allez exporter vos écritures pour la période ci-dessous."
  'dteN0.ReadOnly = TRUE
  'dteN1.ReadOnly = TRUE
  'ENDIF
  Me.Center
  Dtes.Text = "Attention ! Lors du dernier export vous avez généré des écritures du  "
  Try Dtes.Text = Dtes.Text & Settings["/Soc" & start.societe & "/Dte_exprt"] & " au " & Settings["/Soc" & start.societe & "/Dte2_exprt"]
  Try Dtes.text = Dtes.Text & ". Dernier numero de facture : " & Settings["/Soc" & start.societe & "/Numdoc_exprt"]
  If Not Settings["/Soc" & start.societe & "/Dte_exprt"] Or If Not Settings["/Soc" & start.societe & "/Dte2_exprt"] Then
    Changedte = 0
  Else
    Changedte = 1
  Endif
  'ISettings["/Soc" & Start.2societe & "/Gestion"] THEN
  '  Dtes2.text = " Vous allez exporter vos écritures pour la période ci-dessous."
  'ELSE
  Dtes2.Text = "Veuillez saisir les dates du nouvel export."
  'ENDIF
  E0_click()
  dteN0_GotFocus()
  dteN0.SetFocus
  Changedate = dteN0.text
  Changedate2 = dteN1.text
  
End

Public Sub Ex1()
  
  Dim Jrs As Date
  
  Tab = "Fiches_Parametres"
  Raz()
  With Utils
    dteN0.Text = ""
    dteN1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    If Not Settings["/Soc" & start.societe & "/Gestion"] Then
      dte = rResult!dteclec
      dteN0.Text = .Calc_mois(dte)
      'dteN0.Text = .Cdate_affdata(dte)
      jour = Format$(Now, "dd.mm.yyyy")
      If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) < Right$(dteN0.Text, 4) & Mid$(dteN0.Text, 4, 2) & Left$(dteN0.Text, 2) Then
        Exo()
      Else
        dteN1.Text = jour
        dte1 = dteN0.Text
        dte2 = dteN1.Text
      Endif
    Else
      dte = rResult!dtepp
      If rResult!dtepp = "" Or Left$(rResult!dtepp, 2) = "00" Then Dte = Format$(Now, "mm.yyyy")
      dte = "01." & dte
      dteN0.Text = dte
      jrs = Date(Right$(dte, 4), Format$(Val(Mid$(dte, 4, 2)), "00"), 01)
      dteN1.Text = finmois(jrs) & "." & Format$(Val(Mid$(dte, 4, 2)), "00") & "." & Right$(dte, 4)
    Endif
  End With
  
End

'****************************************
'*    Calcul du dernier jour du mois    *
'****************************************
Public Function finmois(Jrs As Date) As Integer
  
  Dim Jrs1 As Integer
  
  If Month(Jrs) < 12 Then
    Jrs1 = Day(Date(Year(Jrs), Month(Jrs) + 1, 1) - 1)
  Else
    Jrs1 = Day(Date(Year(Jrs) + 1, 1, 1) - 1)
  Endif
  Return Jrs1
  
End

Public Sub Exo()
  
  Tab = "Fiches_Parametres"
  Raz()
  With Utils
    dteN0.Text = ""
    dteN1.Text = ""
    dte1 = ""
    dte2 = ""
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    dteN0.Text = .Calc_mois(dte)
    'dteN0.Text = .Cdate_affdata(dte)
    dte = rResult!dteclec
    dteN1.Text = .Cdate_aff(dte)
    dte1 = dteN0.Text
    dte2 = dteN1.Text
  End With
  
End

Public Sub ToggleButton3_Click()
  
  With Utils
    Tab = "Fiches_Journaux"
    If coljour.visible Then
      coljour.clear
      coljour.visible = False
    Else
      coljour.visible = True
      coljour.Columns.count = 2
      coljour.Columns[0].Width = 65
      coljour.Columns[1].Width = 170
      coljour.Columns[0].Text = "code"
      coljour.Columns[1].Text = "libellé"
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by code_jo ")
      If rResult.Available Then
        Repeat
          coljour.Add(rResult!code_jo, rResult!code_jo)
          coljour.Item[0] = rResult!code_jo
          coljour.Item[1] = rResult!libelle_jo
        Until rResult.MoveNext()
        coljour.MoveFirst
        coljour.SetFocus
        coljour.Item.Selected = True
      Endif
    Endif
  End With
  
End

Public Sub Cmpt_KeyPress()
  
  Select Case Last.tag
      
    Case 1
      If Key.code = Key.enter Or Key.code = Key.Return Or Key.code = Key.Tab Then
        dteN0_LostFocus()
        dteN1_GotFocus()
        dteN1.SetFocus
        dteN1.Select
        Stop Event
      Endif
      
    Case 2
      If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
        dteN1_LostFocus()
        cpt_GotFocus()
        cpt.SetFocus
        cpt.Select
        Stop Event
      Endif
      
  End Select
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
  If key.code = key.F2 Then
    Select Case Last.tag
      Case 3
        ToggleButton3_Click()
        Stop Event
    End Select
  Endif
  
End

Public Sub Btn_Click()
  
  Select Case Last.tag
      
    Case 1
      Button3_Click()
      
    Case 2
      Button2_Click()
      
    Case 4
      Settings["/Soc" & Start.societe & "/Adr-export"] = Adrexport.Text
      Settings["/Soc" & Start.societe & "/Chemin-export"] = Chmexport.Text 
      Me.Close
  End Select
  
End

Public Sub cpt_GotFocus()
  
  cpt.Background = &HAAFF7F&
  
End

Public Sub cpt_LostFocus()
  
  cpt.Background = Color.TextBackground
  
End

Public Sub dteN0_GotFocus()
  
  dteN0.Background = &HAAFF7F&
  dteN0.Select
  dteN0.SetFocus
  
End

Public Sub dteN0_LostFocus()
  
  With utils
    dte4 = Format$(Now, "dd.mm.yyyy")
    If Len(dteN0.Text) = 2 Or Len(dteN0.Text) = 3 Then dteN0.Text = Left$(dteN0.Text, 2) & "." & Mid$(dte4, 4, 7)
    If Len(dteN0.Text) = 5 Or Len(dteN0.Text) = 6 Then dteN0.Text = Left$(dteN0.Text, 5) & "." & Right$(dte4, 4)
    dteN0.text = .Cdate_calc(dteN0.Text)
    dteN0.Text = .Cdate_aff(dteN0.Text)
  End With
  If dteN0.Text = "00.00.0:00" Then dteN0.Text = Format$(Now, "dd.mm.yyyy")
  If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate()
  Else
    If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) > Val(Right$(dte2, 4) & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période selectionnée."
      Compdate()
    Endif
  Endif
  dteN0.Background = Color.TextBackground
  'IF Changedate <> dteN0.text THEN Changedate = "1"
Catch
  dteN0_GotFocus()
  dteN0.setfocus
  
End

Public Sub dteN1_GotFocus()
  
  dteN1.Background = &HAAFF7F&
  
End

Public Sub dteN1_LostFocus()
  
  With utils
    dte4 = Format$(Now, "dd.mm.yyyy")
    If Len(dteN1.Text) = 2 Or Len(dteN1.Text) = 3 Then dteN1.Text = Left$(dteN1.Text, 2) & "." & Mid$(dte4, 4, 7)
    If Len(dteN1.Text) = 5 Or Len(dteN1.Text) = 6 Then dteN1.Text = Left$(dteN1.Text, 5) & "." & Right$(dte4, 4)
    dteN1.text = .Cdate_calc(dteN1.Text)
    dteN1.Text = .Cdate_aff(dteN1.Text)
  End With
  If dteN1.Text = "00.00.0:00" Then dteN1.Text = Format$(Now, "dd.mm.yyyy")
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période selectionnée."
    Compdate2()
  Else
    If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) > Val(Right$(dte2, 4) + 1 & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période selectionnée."
      Compdate2()
    Endif
  Endif
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) Then
    If son Then
      Music.Play
    Endif
    If Message.Warning("Attention ! Votre selection n'est pas possible.", "Ok") = 1 Then
      exo()
    Endif
  Endif
  dteN1.Background = Color.TextBackground
Catch
  dteN1_GotFocus()
  dteN1.setfocus
  
End

Public Sub Compdate()
  
  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E0.Value = True
    dteN0_GotFocus()
    dteN0.setfocus
  Endif
  
End

Public Sub compdate2()
  
  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    Exo()
    E0.Value = True
    dteN1_GotFocus()
    dteN1.setfocus
  Endif
  
End

Public Sub coljour_Click()
  
  cpt.Text = coljour.Item[0]
  coljour.clear
  coljour.visible = False
  
End

'**********************************************************
'* Gestion du columnview lors d'une saisie manuelle       *
'**********************************************************
Public Sub coljour_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    coljour.MoveCurrent
    coljour_Click()
  Endif
  
  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    coljour.visible = False
    coljour.clear
    Stop Event
  Endif
  
End

Public Sub E0_Click()
  
  Tab0 = "Fiches_Mvt"
  Ex1()
  
End

Public Sub E1_Click()
  
  Tab0 = "Fiches_Mvt"
  Exo()
  
End

'PUBLIC SUB donnees1(p1 AS String, p2 AS String, p3 AS String, p4 AS String, p5 AS String)
'PRINT #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5
'END

Public Sub donnees1(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String, p9 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5 & ";" & p6 & ";" & p7 & ";" & p8 & ";" & p9
  
End

Public Sub donnees2(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5 & ";" & p6 & ";" & p7 & ";" & p8
  
End

Public Sub donnees3(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5 & ";" & p6
  
End

Public Sub donnees4(p1 As Integer, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String)
  
  Print #hFile, p1 & ";" & p2 & ";" & p3 & ";" & p4 & ";" & p5 & ";" & p6 & ";" & p7 & ";" & p8
  
End

Public Sub donnees5(p1 As String)
  
  Print #hFile, p1
  
End

Public Sub donnees6(p1 As String, p2 As String, p3 As String, p4 As String, p5 As String, p6 As String, p7 As String, p8 As String, p9 As String, p10 As String, p11 As String, p12 As String, p13 As String, p14 As String, p15 As String, p16 As String)
  
  Print #hFile, p1 & p2 & p3 & p4 & p5 & p6 & p7 & p8 & p9 & p10 & p11 & p12 & p13 & p14 & p15 & p16
  
End

Public Sub donnees7(p1 As Integer)
  
  Print #hFile, p1
  
End

Public Sub donnees8(p1 As String, p2 As String, p3 As String)
  
  Print #hFile, p1 & p2 & p3
  
End

Public Sub Raz()
  
  debhp = 0
  credhp = 0
  totsldhp = 0
  totdeb = 0
  totcred = 0
  totsld = 0
  debit = 0
  credit = 0
  Db_Ction = 0
  Cd_Ction = 0
  
End

'**************************************************
'* On exporte les données dans un fichier texte   *
'**************************************************
Public Sub Button2_Click()
  
  Dim rrResult As Result
  Dim ColResult As Result
  Dim Tab2 As String
  Dim Tab3 As String
  Dim Tab4 As String
  Dim Intit, Intitcompte As String
  Dim Intitcol As String
  Dim copt As String
  Dim dateedition As String
  Dim p1 As Integer
  Dim Bcol As Boolean = False
  Dim debitcol As String
  Dim creditcol As String
  Dim soldej As Float
  Dim Mtd As Float
  Dim Mtc As Float
  Dim montant As Float
  Dim Numdoc As String
  Dim sens As String
  Dim NbEcritures As Integer = 0
  Dim TEcritures As String
  Dim numero As String
  Dim Cdc, clicode As String
  Dim Cmontant As String
  Dim Clibelle, Cintitule, Ctypejo As String
  Dim typepiece, typecompte As String 'Utilisé pour export vers sage
  Dim modepaiement As String = " "
  Dim msg, nom, collectif, adr1, adr2, cptl, ville, tel As String
  Dim $ech, Type As String
  
  With utils
    totsldhp = 0.00
    soldej = 0
    Tab = "centralisations"
    Tab2 = "Fiches_Journaux"
    Tab3 = "Fiches_Parametres"
    Tab4 = "Fiches_Comptes"
    If Left$(Tpj.Text, 1) = "1" Or If Left$(Tpj.Text, 1) = "2" Then
      extension = "csv"
    Else
      extension = "txt"
    Endif
    Filetxt = Chmexport.Text & "/ecritures" & Cpt.Text & "." & extension
    If Left$(Tpj.Text, 1) = "6" Then Filetxt = Chmexport.Text & "/ecritures" & Cpt.Text & ".pnm"
    If Exist(filetxt) Then Kill filetxt
    Try hFile = Open filetxt For Write Create
    If Error Then
      If son Then
        Music.Play
      Endif
      Me.Mouse = Mouse.Default
      message(" Veuillez saisir le chemin du fichier Export/Import SVP !", "OK")
      Chmexport.Select
      Chmexport.SetFocus
    Else 
      If Not IsNull(Tpj.Text) Then
        If Left$(Tpj.Text, 1) = "6" Then Controle()
        If bsage = True Then
          Typepiece = "FC"
          Filetxt2 = Chmexport.Text & "/clients.txt"
          If Left$(Tpj.Text, 1) = "6" Then Filetxt2 = Chmexport.Text & "/clients.pnc"
          Numdoc = Settings["/Soc" & start.societe & "/Numdoc_exprt"]
          If Exist(filetxt2) Then Kill filetxt2
          Try hFile2 = Open filetxt2 For Write Create
          p1 = 0
          Me.Mouse = Mouse.Wait
          Utils.db.Exec("drop Table IF exists " & Tab & "")
          Utils.db.Exec("CREATE TABLE IF NOT EXISTS " & Tab & 
            "(cd_cent Char(8) NOT NULL," &
            "intitule Char(25)," &
            "db_cent Decimal(12,2)," &
            "crd_cent Decimal(12,2)," &
            "njournal Char(2)," &
            "PRIMARY KEY (cd_cent))" & "ENGINE = MYISAM")
          dateedition = "du " & dteN0.Text & " au " & dteN1.Text
          rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & "")
          dte = rResult!dtepc
          dte = .Cdate_aff(dte)
          dte = Now
          dte = Mid$(jour, 4, 2) & "-" & Left$(jour, 2) & "-" & Mid$(jour, 7, 4)
          If cpt.Text Then
            ' On récupere les clients
            CliResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCli") & " order by cli_code")
            If CliResult.Available Then
              Print #hfile2, Intitule_Soc & Chr$(13)
              Print #hfile, Intitule_Soc & Chr$(13)
              Repeat
                nom = Left$(CliResult!cli_nom, 21)
                collectif = CliResult!cli_collectif
                adr1 = Left$(CliResult!cli_adr1, 21)
                adr2 = Left$(CliResult!cli_adr2, 21)
                cptl = CliResult!cli_cd_ptl
                ville = Left$(CliResult!cli_ville, 21)
                tel = CliResult!cli_tel_bur
                If Settings["/Soc" & Start.Societe & "/Sage"] Then
                  If IsNull(CliResult!cli_sage) Then  
                    Clicode = CliResult!cli_code
                  Else
                    Clicode = CliResult!cli_sage
                  Endif
                Else
                  Clicode = CliResult!cli_code
                Endif
                If Left$(Tpj.Text, 1) <> "6" Then 
                  Print #hfile2, Clicode & ";" & CliResult!cli_rs_soc & ";" & CliResult!cli_nom & ";" & CliResult!cli_pnm & ";" & CliResult!cli_adr1 & ";" & CliResult!cli_adr2 & ";" & CliResult!cli_cd_ptl & ";" & CliResult!cli_ville & ";" & CliResult!cli_email & ";" & CliResult!cli_tel_bur & ";" & CliResult!cli_tel_dom & ";" & CliResult!cli_tel_poste & ";" & CliResult!cli_pble & ";" & CliResult!cli_fx1 & ";" & CliResult!cli_fx2 & ";" & CliResult!cli_plaf_ecrs & ";" & CliResult!cli_cd_bq & ";" & CliResult!cli_cd_gch & ";" & CliResult!cli_dmln & ";" & CliResult!cli_cle_rib & ";" & CliResult!cli_num_cpt & ";" & CliResult!cli_cd_ent & ";" & CliResult!cli_cd_acc & ";" & CliResult!cli_ref_tir & ";" & CliResult!cli_id_tva & ";" & CliResult!cli_rlvc & ";" & CliResult!cli_rlvf & ";" & CliResult!cli_obs & ";" & CliResult!cli_collectif & ";" & CliResult!cli_rmo & ";" & CliResult!cli_rart & ";"
                Else
                  Print #hfile2, "X" & Clicode & String$(13 - Len(Str(Clicode)), " ") & nom & String$(31 - Len(nom), " ") & "C" & String$(3, " ") & collectif & String$(13 - Len(Str(collectif)), " ") & adr1 & String$(21 - Len(adr1), " ") & adr2 & String$(21 - Len(adr2), " ") & Cptl & String$(6 - Len(Cptl), " ") & ville & String$(21 - Len(ville), " ") & tel & String$(15 - Len(tel), " ") & Chr$(13)
                Endif
              Until CliResult.MoveNext()
            Endif
            Close #hFile2
            ' On récupere les écritures
            rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE code_jo = &1 ", cpt.text)
            If rrResult.Available Then
              compt = rrResult!code_jo
              Intit = rrResult!libelle_jo
              type_jour = rrResult!type_jo
              If RadioButton1.value Then
                rResult = Utils.db.Exec("SELECT * FROM " & Tab0 & " WHERE jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 and export <> &6 or jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 and export is null order by dte, numero, compte", compt, 1, .Cdate_Dbase(dten0.Text), .Cdate_Dbase(dten1.Text), Cpt.text, "1")
              Else
                rResult = Utils.db.Exec("SELECT * FROM " & Tab0 & " WHERE jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 or jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 order by dte, numero, compte", compt, 1, .Cdate_Dbase(dten0.Text), .Cdate_Dbase(dten1.Text), Cpt.text, "1")
              Endif
              If rResult.count <> 0 Then
                numero = rResult!numero
                If Left$(Tpj.Text, 1) = "5" Then
                  TEcritures = "1" & Chr$(13)
                  Donnees5(CStr(TEcritures))
                Endif
                Intitcompte = Replace$(CStr(rResult!intitule), "'", " ")
                Repeat
                  Try Bcol = rResult!collectif
                  If Error Then Bcol = False
                  Inc NbEcritures
                  If rResult!numero <> numero Then
                    If Left$(Tpj.Text, 1) = "5" Then
                      TEcritures = "3" & Chr$(13)
                      Donnees5(CStr(TEcritures))
                      TEcritures = "1" & Chr$(13)
                      Donnees5(CStr(TEcritures))
                    Endif
                    numero = rResult!numero
                  Endif
                  If Bcol Then
                    ColResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " WHERE compte_cc = &1", rResult!compte)
                    Intitcol = ColResult!intitule_cc
                  Else
                    ColResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " WHERE compte_cc = &1", rResult!compte)
                    Type = ColResult!type_cc
                    If Type = "B" Then Type = "G"
                    Cintitule = .Accent(ColResult!intitule_cc)
                    If Type = "G" Then 
                      typecompte = "G"
                    Else
                      typecompte = "X"
                    Endif
                  Endif
                  If Not Bcol Then
                    debit = rResult!montantd
                    credit = rResult!montantc
                    solde = solde + debit - credit
                    montant = Abs(debit - credit)
                    soldej = soldej + solde
                    If InStr(Str(solde), "E") Then solde = 0
                    totdeb = totdeb + debit
                    totcred = totcred + credit
                    totsld = totdeb - totcred
                  Else
                    debitcol = rResult!montantd
                    creditcol = rResult!montantc
                    solde = debitcol - creditcol
                  Endif
                  If Left$(Tpj.Text, 1) = "3" Then
                    dte = .Cdate_Ciel(rResult!dte)
                  Else
                    If Left$(Tpj.Text, 1) = "5" Then
                      dte = .Cdate_Cador(rResult!dte)
                    Else
                      If Left$(Tpj.Text, 1) = "6" Then
                        dte = .Cdate_Sage(rResult!dte)
                      Else
                        dte = .Cdate_Aff(rResult!dte)
                      Endif
                    Endif
                  Endif
                  If rResult!numero <> copt Then
                    If p1 <> 0 Then
                      solde = 0
                    Endif
                  Endif
                  copt = rResult!numero
                  Numdoc = rResult!numdoc
                  Mtd = rResult!montantd
                  Mtc = rResult!montantc
                  If solde > 0 And solde < 0.03 Then
                    Mtc = Mtc + solde
                    solde = 0
                    montant = Mtc + debit
                    montant = Abs(montant)
                  Else
                    If solde < 0 And solde > -0.03 Then
                      Mtd = Mtd + solde
                      solde = 0
                      montant = credit + Mtd
                      montant = Abs(montant)
                    Endif
                  Endif
                  If Mtc <> 0 Then
                    sens = "Crédit"
                  Else
                    sens = "Débit"
                  Endif
                  If Left$(Tpj.Text, 1) = "5" Then
                    If sens = "Crédit" And Mtc >= 0 Then
                      Cdc = "1"
                      Cmontant = Format$(Mtc, "0000000000.00")
                      Cmontant = Replace$(Str(Cmontant), ",", "")
                    Endif
                    If sens = "Crédit" And Mtc < 0 Then
                      Cdc = "3"
                      Cmontant = Format$(Abs(Mtc), "0000000000.00")
                      Cmontant = Replace$(Str(Cmontant), ",", "")
                    Endif
                    If sens = "Débit" And Mtd >= 0 Then
                      Cdc = "0"
                      Cmontant = Format$(Mtd, "0000000000.00")
                      Cmontant = Replace$(Str(Cmontant), ",", "")
                    Endif
                    If sens = "Débit" And Mtd < 0 Then
                      Cdc = "2"
                      Cmontant = Format$(Abs(Mtd), "0000000000.00")
                      Cmontant = Replace$(Str(Cmontant), ",", "")
                    Endif
                  Endif
                  If Left$(Tpj.Text, 1) = "6" Then
                    If sens = "Crédit" Then Cmontant = Format$(Mtc, "0.00")
                    If sens = "Débit" Then Cmontant = Format$(Mtd, "0.00")
                    Cmontant = Replace(Cmontant, ",", ".")
                  Endif
                  Intitcompte = Replace$(CStr(rResult!intitule), "'", " ")
                  If Left$(Tpj.Text, 1) = "1" Then
                    If Not Bcol Then Donnees1(CStr(rResult!compte), CStr(Intitcompte), CStr(dte), CStr(rResult!numdoc), Replace$(CStr(rResult!libelle), "'", "\'"), CStr(Format$(Mtd, "0.00")), CStr(Format$(Mtc, "0.00")), CStr(Format$(solde, "0.00")), CStr(""))
                  Else
                    If Left$(Tpj.Text, 1) = "2" Then
                      If Not Bcol Then Donnees3(CStr(.CSlash(.CDate_Aff(rResult!dte) & String$(12 - Len(.CDate_Aff(rResult!dte)), " "))), CStr(rResult!compte & String$(10 - Len(rResult!compte), " ")), CStr(rResult!numdoc & " " & Intitcompte & String$(40 - Len(rResult!numdoc & " " & Intitcompte), " ")), Replace$(CStr(rResult!libelle & String$(40 - Len(rResult!libelle), " ")), "'", "\'"), CStr(Format$(montant, "0.00") & String$(13 - Len(Format$(montant, "0.00")), " ")), CStr(Format$(montant, "0.00") & String$(13 - Len(Format$(montant, "0.00")), " ")))
                    Else
                      If Left$(Tpj.Text, 1) = "3" Then
                        If Not Bcol Then
                          Donnees2(CStr(rResult!compte), CStr(Conv(Intitcompte, "UTF-8", "windows-1252")), CStr(dte), CStr(rResult!numdoc), CStr(Replace$(rResult!libelle, "'", "\'")), CStr(Format$(Mtd, "0.00")), CStr(Format$(Mtc, "0.00")), CStr(Conv(sens, "UTF-8", "windows-1252")))
                          montant = 0
                        Endif
                      Else
                        If Left$(Tpj.Text, 1) = "4" Then
                          If Not Bcol Then
                            NbEcritures = NbEcritures - 1
                            Donnees4(CStr(NbEcritures), CStr(dte), CStr(rResult!numdoc), Replace$(CStr(Conv(Left$(rResult!libelle, 32), "UTF-8", "windows-1252")), "'", "\'"), CStr(cpt.text), CStr(rResult!compte), CStr("\"" & Mid$(rResult!numdoc, 5, 6) & "\""), CStr(Format$(Mtd, "0.00")), CStr(Format$(Mtc, "0.00")))
                            montant = 0
                          Endif
                        Else
                          If Left$(Tpj.Text, 1) = "5" Then
                            If Not Bcol Then
                              Clibelle = .Accent(rResult!libelle)
                              If type_jour = "VE" Then Ctypejo = Compt & "  V"
                              If type_jour = "TR" Then Ctypejo = Compt & "  T"
                              If Len(Clibelle) < 32 Then Clibelle = Clibelle & String$(32 - Len(Left$(Clibelle, 32)), " ")
                              Clibelle = Numdoc & " " & Left$(Clibelle, 21)
                              If Len(Cintitule) < 30 Then Cintitule = Cintitule & String$(30 - Len(Cintitule), " ")
                              Cintitule = Left$(Cintitule, 30)
                              NbEcritures = 2
                              Donnees6(CStr(NbEcritures & "  " & dte), CStr(Format$(Val(numero), "00000")), CStr(Clibelle), CStr(Type & rResult!compte & String$(8 - Len(rResult!compte), "0")) & String$(4, " "), CStr(Cdc), CStr(Format$(Val(Cmontant), "000000000000")), CStr(dte & "00              "), CStr(Left$(Cintitule, 30)), CStr(Ctypejo), CStr(String$(25, " ") & "E"), CStr(String$(10, "0")), CStr(String$(171, " ")), CStr(String$(10, "0")), CStr(String$(33, " ")), CStr(String$(12, "0")), CStr(String$(65, " ")) & Chr$(13))
                              montant = 0
                            Endif
                          Else
                            If Left$(Tpj.Text, 1) = "6" Then
                              If Not Bcol Then
                                Clibelle = .Accent(rResult!libelle)
                                If Len(Clibelle) <= 25 Then 
                                  Clibelle = Clibelle & String$(25 - Len(Left$(Clibelle, 25)), " ")
                                Else
                                  Clibelle = Left$(Clibelle, 25)
                                Endif
                                $ech = Utils.Cdate_Sage(rResult!dateech)
                                If IsNull($ech) Then $ech = "      "
                                CliResult = Utils.db.Exec("SELECT cli_collectif, cli_sage, cli_code FROM " & Cbase.Table("TabCli") & " where cli_code = &1", rResult!compte)
                                If CliResult.Available Then
                                  Collectif = CliResult!cli_collectif
                                  If Settings["/Soc" & Start.Societe & "/Sage"] Then
                                    If IsNull(CliResult!cli_sage) Then  
                                      Clicode = CliResult!cli_code
                                    Else
                                      Clicode = CliResult!cli_sage
                                    Endif
                                  Else
                                    Clicode = CliResult!cli_code
                                  Endif
                                Else
                                  collectif = ""
                                  Clicode = rResult!compte
                                Endif
                                NbEcritures = NbEcritures - 1
                                If typecompte = "X" Then
                                  Print #hfile, cpt.text & String$(3 - Len(cpt.text), " ") & dte & Typepiece & collectif & String$(13 - Len(collectif), " ") & typecompte & clicode & String$(13 - Len(clicode), " ") & rResult!numdoc & String$(13 - Len(rResult!numdoc), " ") & Clibelle & modepaiement & $ech & Left$(sens, 1) & String$(20 - Len(cmontant), " ") & Cmontant & "N" & String$(59, " ") & Chr$(13)
                                Else
                                  Print #hfile, cpt.text & String$(3 - Len(cpt.text), " ") & dte & Typepiece & clicode & String$(13 - Len(clicode), " ") & String$(14, " ") & rResult!numdoc & String$(13 - Len(rResult!numdoc), " ") & Clibelle & modepaiement & $ech & Left$(sens, 1) & String$(20 - Len(cmontant), " ") & Cmontant & "N" & String$(59, " ") & Chr$(13)
                                Endif  
                                montant = 0
                              Endif
                            Endif
                          Endif
                        Endif
                      Endif
                    Endif
                  Endif
                  If Bcol Then solde = 0
                  If Left$(rResult!compte, 2) <> "40" And Left$(rResult!compte, 2) <> "41" And type_jour <> "OD" Then
                    rrrResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE cd_cent = &1", rResult!compte)
                    If rrrResult.Available Then
                      Db_Ction = rrrResult!db_cent
                      Cd_Ction = rrrResult!crd_cent
                      Db_Ction = Db_Ction + debit
                      Utils.db.Exec("UPdate " & Tab & " SET cd_cent = '" & rResult!compte & "', intitule ='" & CStr(Intitcompte) & "', db_cent = '" & Db_Ction & "', crd_cent = '" & Cd_Ction & "', njournal = '" & Compt & "' WHERE cd_cent = '" & rResult!compte & "' and njournal = '" & Compt & "'")
                    Else
                      Db_Ction = Db_Ction + debit
                      Cd_Ction = Cd_Ction + credit
                      Utils.db.Exec("INSERT INTO " & Tab & " (cd_cent, intitule,db_cent, crd_cent, njournal) Values ('" & rResult!compte & "', '" & CStr(Intitcompte) & "', '" & Debit & "', '" & Credit & "', '" & Compt & "')")
                    Endif
                    Db_Ction = 0
                    Cd_Ction = 0
                  Else
                    If Bcol Then
                      If Left$(rResult!compte, 2) = "40" Then
                        type = "fournisseurs"
                      Else
                        If Left$(rResult!compte, 2) = "41" Then
                          type = "Clients"
                        Endif
                      Endif
                      rrrResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE cd_cent = &1", rResult!compte)
                      If rrrResult.Available Then
                        Db_Ction = rrrResult!db_cent
                        Cd_Ction = rrrResult!crd_cent
                        Db_Ction = Db_Ction + debitcol
                        Cd_Ction = Cd_Ction + creditcol
                        Utils.db.Exec("UPdate " & Tab & " SET cd_cent = '" & rResult!compte & "', intitule ='" & Intitcol & "', db_cent = '" & Db_Ction & "', crd_cent = '" & Cd_Ction & "', njournal = '" & Compt & "' WHERE cd_cent = '" & rResult!compte & "' and njournal = '" & Compt & "'")
                      Else
                        Db_Ction = Db_Ction + debitcol
                        Cd_Ction = Cd_Ction + creditcol
                        Utils.db.Exec("INSERT INTO " & Tab & " (cd_cent, intitule,db_cent, crd_cent, njournal) Values ('" & rResult!compte & "', '" & Intitcol & "', '" & Db_Ction & "', '" & Cd_Ction & "', '" & Compt & "')")
                      Endif
                    Endif
                  Endif
                  'ENDIF
                  Utils.db.Exec("update " & Tab0 & " set export = &2 WHERE numero = &1", rResult!numero, "1")
                Until rResult.MoveNext()
                If Left$(Tpj.Text, 1) = "5" Then
                  TEcritures = "3"
                  Donnees5(CStr(TEcritures))
                Endif
                If NbEcritures <> 0 Then
                  totdeb = totdeb + debhp
                  totcred = totcred + credhp
                  totsld = totdeb - totdeb
                  If Totsld = 0 Then
                    raz()
                    Close #hFile
                    If son Then
                      Music.Play
                    Endif
                    Me.Mouse = Mouse.Default
                    Shell "chmod 666 " & Filetxt Wait
                    Shell "chmod 666 " & Filetxt2 Wait
                    If Left$(Tpj.Text, 1) = "6" Then
                      Msg = "Les fichiers  ecritures" & Cpt.Text & ".pnm et clients.pnc ont été correctement copiés sous votre répertoire. \n Voulez-vous ouvrir ecritures" & Cpt.Text & ".pnm"
                    Else
                      Msg = "Les fichiers  ecritures" & Cpt.Text & "." & extension & " et clients.txt ont été correctement copiés sous votre répertoire. \n Voulez-vous ouvrir ecritures" & Cpt.Text & "." & extension & " ?"
                    Endif
                    If message.question(msg, "Oui", "Non") = 1 Then
                      Editeur.Prog_Editeur(Filetxt)
                    Endif
                    If Envoi.value = True Then
                      Export()
                    Endif
                    Me.close
                  Else
                    If son Then
                      Music.Play
                    Endif
                    Me.Mouse = Mouse.Default
                    message(" Le solde du journal est différent de 0, export impossible !", "OK")
                    If Exist(filetxt) Then Kill filetxt
                  Endif
                Else
                  Me.Mouse = Mouse.Default
                  message(" Aucune écriture pour cette demande", "OK")
                Endif
              Else
                Me.Mouse = Mouse.Default
                message(" Aucune écriture pour cette demande.\nPensez a vérifier la période demandée\nRappel : On ne peut pas exporter deux fois les écritures.", "OK")
              Endif
            Else
              If son Then
                Music.Play
              Endif
              Me.Mouse = Mouse.Default
              message(" Ce journal n'existe pas !", "OK")
              cpt.Select
              cpt.SetFocus
            Endif
          Else
            If son Then
              Music.Play
            Endif
            Me.Mouse = Mouse.Default
            message(" Veuillez saisir un code journal SVP !", "OK")
            cpt.Select
            cpt.SetFocus
          Endif
          Settings["/Soc" & start.societe & "/Dte_exprt"] = Dten0.Text
          Settings["/Soc" & start.societe & "/Dte2_exprt"] = Dten1.Text
          Settings["/Soc" & start.societe & "/Numdoc_exprt"] = Numdoc
          Shell "cp" & " " & Chmexport.Text & "/ecritures" & cpt.text & "." & extension & " " & Chmexport.Text & "/JDV" & Left$(Dten1.Text, 2) & Mid$(Dten1.Text, 4, 2) & Right$(Dten1.Text, 4) & "." & extension Wait
        Endif
      Else
        Message.Warning("Veuillez saisir le type d'export SVP !")
        Tpj.SetFocus
      Endif
    Endif
  End With
Catch
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub Controle()
  
  Dim nResult As Result
  Dim nbc As Integer
  ' On vérifie que cli_sage soit bien mouvementé
  bsage = True
  nResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabJour") & " WHERE code_jo = &1 ", cpt.text)
  If nResult.Available Then
    compt = nResult!code_jo
    nResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMvt") & " WHERE jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 or jour = &1 and validee = &2 and dte >= &3 and dte <= &4 and jour = &5 order by dte, numero, compte", compt, 1, Utils.Cdate_Dbase(dten0.Text), Utils.Cdate_Dbase(dten1.Text), Cpt.text)
    If nResult.count <> 0 Then
      Repeat
        CliResult = Utils.db.Exec("SELECT cli_sage, cli_code, cli_nom, cli_pnm FROM " & Cbase.Table("TabCli") & " where cli_code = &1", nResult!compte)
        If CliResult.Available Then
          If IsNull(CliResult!cli_sage) Then  
            bsage = False
            Inc nbc
            donnees8(CStr(CliResult!cli_code) & "  ", CStr(CliResult!cli_nom) & "  ", CStr(CliResult!cli_pnm))
          Endif
        Endif
      Until nResult.MoveNext()
      If bsage = False Then 
        If son Then
          Music.Play
        Endif
        If nbc = 1 Then
          message.Warning("Attention ! Traitement impossible car " & nbc & " client est sans code Sage.\nVeuillez completer ce compte SVP.")
        Else
          message.Warning("Attention ! Traitement impossible car " & nbc & " clients sont sans code Sage.\nVeuillez completer ces comptes SVP.")
        Endif
        Editeur.Prog_Editeur(Filetxt)
      Endif
    Endif
  Endif
  
End

Public Sub Svs2_Click()
  
  Dialog.Title = "Choisir un repertoire"
  Dialog.Path = User.home
  If Not Dialog.SelectDirectory() Then
    Chmexport.Text = Dialog.Path
  Else
    Chmexport.Text = User.Home
  Endif
  
End

Public Sub export()
  
  Dim Fle1, Fle2, stext, stext2 As String
  Dim Email As String = Adrexport.Text
  
  Me.Mouse = Mouse.Wait
  Fle1 = Settings["/Soc" & start.societe & "/Chemin-export"] & "/clients.txt"
  Fle2 = Settings["/Soc" & start.societe & "/Chemin-export"] & "/ecritures" & cpt.text & "." & extension
  Stext = "Envoi des fichiers d export"
  If Left$(Tpj.Text, 1) = "2" Then
    stext2 = "Veuillez trouver ci-joints les deux fichiers d export pour le journal " & cpt.text
  Else
    stext2 = "Veuillez trouver ci-joint le fichier d'export pour le journal " & cpt.text
  Endif
  If Left$(Tpj.Text, 1) = "2"
    EnvMail.Envoi3(Email, stext, sText2, Fle1, Fle2)
  Else
    EnvMail.Envoi2(Email, stext, stext2, Fle2)
  Endif
  Me.mouse = mouse.Default
Catch
  If son Then
    Music.Play
  Endif
  Me.mouse = mouse.Default
  message.Error("Le fichier n'a pas pu être envoyé. vérifiez vos préferences SVP !")
  
End

Public Sub Button3_Click()
  
  Exec ["xdg-open", Application.Path &/ "Ecrans/Export.html"]
  
End
