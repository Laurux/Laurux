' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Lettrage.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/11/2004
'# Lettrage des écritures
'################################################
'

Private TT As Float
Private TD As String
Private TC As String
Private Compt As String
Private type As String
Private rResult As Result
Private rrResult As Result
Private Tab2 As String
Private b As Integer
Private son As Integer = Start.Son
Private Lettrable As Integer
Private Tri As String
Public Bsel As Boolean = False
Public Desg As String
Private $lstex As Listextcpt

Public Function convBool(bln As Boolean) As String

  Dim sRet As String

  If bln Then
    sRet = "1"
  Else
    sRet = "0"
  Endif
  Return sRet

End

Public Function cpoint(mtt As String) As String

  Return (Replace$(mtt, ".", ","))

End

Public Sub _New(cpte As String, tpc As String)

  Utils.Observers(Me)

  Music.Load(Start.Musique)
  Me.Center
  Tab2 = "Fiches_Comptes"
  colcli.Columns.count = 9
  colcli.Columns[0].Alignment = 4
  colcli.Columns[0].Width = 76
  colcli.Columns[1].Width = 80
  colcli.Columns[2].Width = 190
  colcli.Columns[3].Width = 100
  colcli.Columns[4].Width = 100
  colcli.Columns[5].Width = 90
  colcli.Columns[6].Width = 90
  colcli.Columns[7].Width = 70
  colcli.Columns[8].Width = 10
  colcli.Columns[0].Text = "Code"
  colcli.Columns[1].Text = "Date"
  colcli.Columns[2].Text = "Libellé"
  colcli.Columns[3].Text = "Document"
  colcli.Columns[4].Text = "Lot"
  colcli.Columns[5].Alignment = 2
  colcli.Columns[5].Text = "Débit"
  colcli.Columns[6].Alignment = 2
  colcli.Columns[6].Text = "Crédit"
  colcli.Columns[7].Alignment = 2
  colcli.Columns[7].Text = "numéro"
  colcli.Columns[8].Alignment = 3
  colcli.Columns[8].Text = "Let."
  If IsNull(tpc) Then
    type = "C"
  Else
    type = tpc
  Endif
  If type = "C" Then
    Bclient.value = True
  Else
    If type = "F" Then
      Bfournisseur.Value = True
    Else
      If type = "B" Then
        Bbilan.Value = True
      Endif
    Endif
  Endif
  rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE type_cc = &1 and lettrable = &2 order by cast(compte_cc AS char)", type, True)
  If Not IsNull(cpte) Then
    cpt.text = cpte
    compteman()
  Endif
  cpt.SetFocus
  cpt.Select

End

Public Sub Let_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Or Key.code = Key.Tab Then

    Select Case Last.tag

      Case 1
        compteman()
        If b = 0 Then
          cpt.SetFocus
          cpt.Select
        Else
          clear()
          colcli.clear
          affichage()
          numlot.SetFocus
          numlot.Select
        Endif
        Stop Event

      Case 2
        cpt.SetFocus
        cpt.Select
        Stop Event
    End Select
  Endif

  If key.code = key.F1 Then
    Button8_Click()
    Stop Event
  Endif

  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        Button9_Click()
        Stop Event
    End Select
  Endif

End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Let_GotFocus()

  With Utils
    .SetEditColor(Me, Last)
  End With

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      Button8_Click()

    Case 2
      Button7_Click()

    Case 3
      Button5_Click()

    Case 4
      Me.Close
  End Select

End

Public Sub Button9_Click()

  Dim MyForm As TriComptes

  Tri = "cast(compte_cc AS char)"
  MyForm = New TriComptes(Tri, Type, "", "Lettrage")
  MyForm.Showmodal()
  If Comptabilite.Bsel = True Then
    Cpt.text = Comptabilite.sCmpt
    Label2.Text = Comptabilite.sDesg
    compteman()
    Indexation()
  Endif

End

Public Sub compteman()

  Dim Tab As String

  Tab = "Fiches_Comptes"
  If Bclient.value Then
    type = "C"
  Else
    If Bfournisseur.Value Then
      type = "F"
    Else
      If Bbilan.Value Then
        type = "B"
      Endif
    Endif
  Endif
  If cpt.Text Then
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte_cc = &1 and type_cc = &2 and lettrable <> false", cpt.text, type)
    If rResult.Available Then
      Label2.Text = rResult!intitule_cc
      Indexation()
      affichage()
      b = 1
    Else
      If son Then
        Music.Play
      Endif
      Message.Warning(" Ce compte n'existe pas ou n'est pas du type selectionné ou ce n'est pas un compte lettrable !")
      b = 0
    Endif
  Else
    b = 1
  Endif

End

Public Sub Indexation()

  If rrResult.count > 0 Then
    rrResult.MoveFirst()
    Repeat
      If rrResult!compte_cc = cpt.Text Then
        Break
      Endif
    Until rrResult.Movenext()
  Endif

End

Public Sub clear()

  totselection.Text = "0,00"
  numlot.Text = ""
  Td = 0
  Tc = 0
  TT = 0

End

Public Sub affichage()

  Dim Tab As String
  Dim Totd, Totc As Float
  Dim odr As String
  Dim dtei, dtes As LDate

  Tab = "Fiches_Mvt"
  Tab2 = "Fiches_Comptes"
  With Utils
    Colcli.clear
    If Compt = "0" Then
      rrResult.MoveFirst()
      cpt.Text = rrResult!compte_cc
      Label2.Text = rrResult!intitule_cc
      Compt = ""
    Endif
    If rrResult.Available And Compt = "1" Then
      cpt.Text = rrResult!compte_cc
      Label2.Text = rrResult!intitule_cc
      Compt = ""
    Endif
    If rrResult.Available And Compt = "2" Then
      rrResult.Movenext()
      If rrResult.Available Then
        cpt.Text = rrResult!compte_cc
        Label2.Text = rrResult!intitule_cc
      Else
        rrResult.MoveLast()
      Endif
      Compt = ""
    Endif
    If rrResult.Available And Compt = "3" Then
      rrResult.MovePrevious()
      If rrResult.Available Then
        cpt.Text = rrResult!compte_cc
        Label2.Text = rrResult!intitule_cc
      Else
        rrResult.MoveFirst()
      Endif
      Compt = ""
    Endif
    If Compt = "4" Then
      rrResult.MoveLast()
      cpt.Text = rrResult!compte_cc
      Label2.Text = rrResult!intitule_cc
      Compt = ""
    Endif
    If Tdate.Value Then
      odr = "dte DESC"
    Else
      odr = "dte Asc"
    Endif
    dtei = New LDate(DateAdd(Now, gb.Year, -8))
    dtes = New LDate(DateAdd(Now, gb.Year, 8))
    If ConvBool(Enl.value) = 1 Then
    '  If Tdate.value = False Then
        $lstex = New Listextcpt(cpt.Text, dtei.L, dtes.L, "n", True, odr)
        rResult = $lstex.resext
 '       rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1 and lettree = &2  and validee = &3 order by dte", cpt.text, 0, 1)
     ' Else
 '       lstex = New Listextcpt(cpt.Text, "01.01.1900", "31.12.9999", "n", True, odr)
  '      rResult = lstex.resext
        'rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1 and lettree = &2  and validee = &3  order by dte", cpt.text, 0, 1)
      'Endif
    Else
      If ConvBool(El.value) = 1 Then
        $lstex = New Listextcpt(cpt.Text, dtei.L, dtes.L, "o", True, odr)
        rResult = $lstex.resext
 '       rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1 and lettree = &2 and validee = &3   order by dte", cpt.text, 1, 1)
      Else
        If ConvBool(Toutes.value) = 1 Then
          $lstex = New Listextcpt(cpt.Text, dtei.L, dtes.L, "t", True, odr)
          rResult = $lstex.resext
          'rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1  and validee = &2 order by dte", cpt.text, 1)
        Endif
      Endif
    Endif
    If rResult.Available Then
      Repeat
        Colcli.Add(rResult!lind, rResult!lind)
        Colcli.Item[0] = rResult!compte
        Colcli.Item[1] = .Cdate_Aff(rResult!dte)
        Colcli.Item[2] = rResult!libelle
        Colcli.Item[3] = rResult!numdoc
        Colcli.Item[4] = rResult!numlot
        Colcli.Item[5] = Format$(rResult!montantd, "0.00")
        Colcli.Item[6] = Format$(rResult!montantc, "0.00")
        Colcli.Item[7] = rResult!numero
        Colcli.Item[9] = rResult!lind
        If rResult!lettree = True Then Colcli.Item[8] = "L"
        Totd = Totd + Val(.cpoint(Format$(rResult!montantd, "0.00")))
        Totc = Totc + Val(.cpoint(Format$(rResult!montantc, "0.00")))
      Until rResult.MoveNext()
    Else
    Endif
    Sld.Text = Format$(TotD - TotC, "0.00")
    Colcli.MoveFirst()
    Colcli.Item.Selected = True
    Colcli.setfocus
  End With

End

Public Sub Colcli_Click()

  If Colcli.current[8] = "L" Or If Colcli.current[8] = "" Then
    Colcli.current[8] = "*"
  Else
    Colcli.current[8] = ""
  Endif
  TD = cpoint(Colcli.current[5])
  If Val(TD) = Null Then TD = "0"
  TC = cpoint(Colcli.Current[6])
  If Val(TC) = Null Then TC = "0"
  If Colcli.Item[8] = "*" Then
    TT = TT + Val(TD) - Val(TC)
  Else
    TT = TT - Val(TD) + Val(TC)
  Endif
  numlot.Text = Colcli.Current[4]
  Totselection.Text = Format$(TT, "0.00")
  If Val(Utils.CPoint(Totselection.Text)) = 0 Then Totselection.Text = "0,00"

End

Public Sub Colcli_KeyPress()

  Try Colcli.Item.Selected = True
  '  IF key.code = key.F2 THEN Quit_Click
  If key.code = key.Space Then
    Colcli_Click()
  Endif
  If key.code = key.Up Then
    Colcli.MovePrevious()
    Try Colcli.Item.Selected = True
  Endif
  If key.code = key.Down Then
    Colcli.MoveNext()
    Try Colcli.Item.Selected = True
  Endif

End

Public Sub Button5_Click()

  Dim num As String
  Dim Tab As String
  Dim lot As Integer

  Tab = "Fiches_Mvt"
  Randomize
  lot = Rnd(1000000, 9999999)
  If Numlot.text = "" Then Numlot.Text = lot
  If colcli.count <> 0 Then
    Colcli.MoveFirst()
    Repeat
      If Colcli.Item[8] = "*" Then
'        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE lind = &1 ", Colcli.Item[9])
'        If rResult.Available Then
        $lstex.letcpt(Val(Colcli.Item[9]), True, numlot.Text, "lettrage")
 '         Utils.db.Exec("Update " & Tab & " SET numlot = &1 where lind = &2 ", numlot.Text, Colcli.Item[9])
        'Endif
      Endif
    Until Colcli.Movenext()
    If Totselection.Text <> "0,00" Then
      If son Then
        Music.Play
      Endif
      Message.Warning("Lettrage impossible ! Le total de votre sélection est différent de zéro ou vous n'avez pas sélectionné de lignes.")
      numlot.Clear
      affichage()
      clear()
    Else
      Lettrable = $lstex.Controle(numlot.Text, True)
      Colcli.MoveFirst
      If Lettrable = 1 And IsNull(numlot.text) Then numlot.Text = Colcli.Current[4]
      Repeat
        If Colcli.Item[8] = "*" And Lettrable = 1 Then
          Compt = Colcli.Item[0]
          num = Colcli.Item[7]
'          rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1 and lind =&2 ", Compt, Colcli.Item[9])
 '         If rResult.Available Then
          $lstex.letcpt(Val(Colcli.Item[9]), True, numlot.Text, "lettrage")
'            Utils.db.Exec("Update " & Tab & " SET numlot = &1, lettree = &2 where lind = &3 ", numlot.Text, 1, Colcli.Item[9])
         ' Endif
        Endif
      Until Colcli.Movenext()
      Colcli.Clear
      Affichage()
      clear()
    Endif
  Endif

End

Public Sub Toutes_Click()

  clear()
  affichage()

End

Public Sub Enl_Click()

  clear()
  affichage()

End

Public Sub El_Click()

  clear()
  affichage()

End

Public Sub Bclient_Click()

  clear()
  Colcli.clear
  cpt.Text = ""
  cpt.Setfocus
  type = "C"
  rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE type_cc = &1 and lettrable = &2  order by cast(compte_cc AS char)", type, True)

End

Public Sub Bfournisseur_Click()

  clear()
  Colcli.clear
  cpt.Text = ""
  cpt.Setfocus
  type = "F"
  rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE type_cc = &1 and lettrable = &2  order by cast(compte_cc AS char)", type, True)

End

Public Sub Bbilan_Click()

  clear()
  Colcli.clear
  cpt.Text = ""
  cpt.Setfocus
  type = "B"
  rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " WHERE type_cc = &1 and lettrable = &2  order by cast(compte_cc AS char)", type, True)

End

Public Sub Button7_Click()

  If Colcli.Available Then
    Colcli.MoveFirst
    Repeat
      If Colcli.Item[8] = "*" Then
'        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE lind = &1 ", Colcli.Item[9])
'        If rResult.Available Then
        $lstex.letcpt(Val(Colcli.Item[9]), False, numlot.Text, "lettrage")
'          Utils.db.Exec("UPdate " & Tab & " SET numlot = &1, lettree = &2 where lind = &3", numlot.Text, 0, Colcli.Item[9])
'          Sha1Calc.CalcSha1(Tab, rResult!numero) 'PATRICKMAG Revoir le lettrage exercice clot avec Sha1
'        Endif
      Endif
    Until Colcli.Movenext()
    Colcli.Clear
    Affichage()
    Clear()
  Endif

End

Public Sub Button1_Click()

  clear()
  If cpt.Text = "" Then
    Compt = "1"
  Else
    Compt = "3"
  Endif
  affichage()

End

Public Sub Button2_Click()

  clear()
  If cpt.Text = "" Then
    Compt = "1"
  Else
    Compt = "2"
  Endif
  affichage()

End

Public Sub Button3_Click()

  clear()
  Compt = "4"
  affichage()

End

Public Sub Button4_Click()

  clear()
  Compt = "0"
  affichage()

End

Public Sub Button8_Click()

  Doc.Open("Lettrage")

End

Public Sub Tdate_Click()

  If Tdate.Value = True Then
    Colcli.Sorted = False
  Else
    Colcli.sorted = True
  Endif
  affichage
End
