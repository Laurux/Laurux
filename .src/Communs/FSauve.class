' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : FSauve.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/11/2004
'# Sauvegarde de la base Laurux
'################################################
'
Private son As Integer = Start.Son
Private Lg As Integer = 0
Private txterror As String

Public Sub _New()

  Utils.Observers(Me)

  Try Sauves.Text = Start.LocalSettings["/Rep_Sauv"]
  Try Compb.Value = Start.LocalSettings["/Compression"]
  Music.Load(Start.Musique)
  Me.Center

End

Public Sub Button3_Click()

  Start.LocalSettings["/Compression"] = Compb.Value
  Start.LocalSettings.Save
  Me.close

End

Public Sub Button2_Click()

  Dim cp As New Compress

  cp.type = "zlib"
  Me.Mouse = Mouse.Wait
  'If Not Exist(User.home & "/tmp") Then Mkdir User.home & "/tmp"
  If Exist(Sauves.Text & "/" & Utils.db.Name & ".sql") Then Kill Sauves.Text & "/" & Utils.db.Name & ".sql"
  If Exist(User.home & "/" & Utils.db.Name & ".sql") Then Kill User.home & "/" & Utils.db.Name & ".sql"
  lg = Mmysql.Process_List(0)
  If lg = 0 Then
    Message.Error("Mot de passe invalide !")
    Me.Mouse = Mouse.Default
  Else
    If lg > 7 Then
      Me.Mouse = Mouse.Default
      Hbox1.Visible = True
    Else
      Shell "mysqldump --lock-tables=0 -h " & Start.LocalSettings["/dbase/Host"] & " -u " & Utils.db.Login & " -p" & Utils.db.Password & " " & Utils.db.Name & " --add-drop-table > " & Sauves.Text & "/" & Utils.db.Name & ".sql" Wait
      If Exist(Sauves.Text & "/" & Utils.db.Name & ".sql") Then
        txterror = Sauves.Text & "/" & Utils.db.Name & ".sql"
        If Left$(Txterror, 9) = "mysqldump" Then
          If son Then
            Music.Play
          Endif
          Me.Mouse = Mouse.Default
          Message.Info(Txterror & "La base " & Utils.db.Name & " n'a pas pu être sauvegardée ! \n Veuillez vérifier le chemin de sauvegarde ou le support de sauvegarde SVP ! ")
        Else
          Shell "cp" & " " & User.Home & "/.config/gambas3/" & Application.Name & ".conf" & " " & Sauves.Text Wait
          If Exist(Sauves.Text & "/" & Utils.db.Name & ".sql") Then
            If Compb.Value Then
              cp.File(Sauves.Text & "/" & Utils.db.Name & ".sql", Sauves.Text & "/" & Utils.db.Name & ".sql.gz", cp.Max)
            Endif
            If son Then
              Music.Play
            Endif
            Me.Mouse = Mouse.Default
            Message.Info("La base " & Utils.db.Name & " a été correctement sauvegardée.")
            Me.Close
          Else
            If son Then
              Music.Play
            Endif
            Me.Mouse = Mouse.Default
            Message.Error("La base " & Utils.db.Name & " n'a pas pu être sauvegardée ! \n Veuillez vérifier le chemin de sauvegarde ou le support de sauvegarde SVP ! ")
          Endif
        Endif
      Endif
    Endif
  Endif

End

Public Sub Svs_Click()

  Dialog.Title = "Choisir un repertoire"
  Dialog.Path = User.home
  If Not Dialog.SelectDirectory() Then
    Sauves.Text = Dialog.Path
  Else
    Sauves.Text = User.Home
  Endif

End

Public Sub Button1_Click()

  Doc.Open("Sauvegarde")

End

Public Sub Button4_Click()

  Editeur.Prog_Editeur(User.Home & "/tmp/resultat")

End

Public Sub Button5_Click()

  Me.mouse = mouse.Wait
  Mmysql.Init()
  Button2_Click()
  Hbox1.Visible = False
  Me.mouse = mouse.DEFAULT

End

Public Sub Button6_Click()

  Hbox1.Visible = False

End
