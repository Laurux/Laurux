' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Parametre.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 01/11/2004
'# Gestion de la table des parametres
'################################################
'
Private Tab As String
Private B As Integer ' Flag gestion erreur
Private son As String
Private $soption As String

Public Sub _New()

  Dim chn As Chainage
  
  chn = New Chainage([datec, date1, date2, date3, date4, date5, datepc, Datetdec, datefedec, regulplus, regulmoins, Ecart, Jod, Jreport, Resultplus, Resultmoins, devise, dnclient, dnfournisseur, dnbon, dnfac, coretro, jrnal, jrnal2, Viremc, Viremchq, Virema, jrnal3, mc, mc2, jrnal4, jrnal5, version, VersionPos])
  chn = New Chainage([frais, cptfrais, tvafrais])
  chn = New Chainage([conscli, consfou, nvign, css, tvass, ident, caution, arretdr])
  chn = New Chainage([CuTicket, DnTicket])
  
  Utils.Observers(Me)
  Me.Center
  
  $soption = utils.Option()
  If $soption = "B" Or $soption = "T" Then
    Frame1.Visible = True
  Endif
  datec.Dat = True
  Date1.dat = True
  date2.Dat = True
  date3.Dat = True
  date4.Dat = True
  date5.Dat = True
  datetdec.Dat = True
  datepc.Dat = True
  datefedec.Dat = True
  regulplus.reg = "[0-9]{1,8}"
  Regulmoins.reg = regulplus.reg
  Resultplus.reg = regulplus.reg
  resultmoins.reg = regulplus.reg
  Viremchq.reg = regulplus.reg
  Virema.reg = regulplus.reg
  cptfrais.reg = regulplus.reg
  consfou.reg = regulplus.reg
  conscli.reg = regulplus.reg
  css.reg = regulplus.reg
  Jod.reg = "[0-9]{1,2}"
  Jreport.reg = Jod.reg
  jrnal.reg = Jod.reg
  jrnal2.reg = Jod.reg
  Jrnal3.reg = Jod.reg
  Jrnal4.reg = Jod.reg
  Jrnal5.reg = Jod.reg
  Ecart.numerique = True
  Ecart.nbdec = "2"
  frais.numerique = True
  frais.nbdec = "2"
  version.reg = "[0-9]{0,2}[.]?[0-9]{0,2}"
  VersionPos.reg = version.reg
  coretro.numerique = True
  coretro.nbdec = "2"
  
End

Public Sub Form_Open()

  Dim rResult As Result

  Tab = "Fiches_Parametres"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  
  DocActif.Get_Lock("Parametres", "0")

  Music.Load(Start.Musique)
  Balloon.Delay = 2000
  With Utils
    Try datec.dte.G = rResult!dteclec ' date de cloture de l'exercice en cours
    Try date1.dte.G = rResult!dteclec1 ' date de cloture de l'exercice N -1
    Try date2.dte.G = rResult!dteclec2 ' date de cloture de l'exercice N -2
    Try date3.dte.G = rResult!dteclec3 ' date de cloture de l'exercice N -3
    Try date4.dte.G = rResult!dteclec4 ' date de cloture de l'exercice N -4
    Try date5.dte.G = rResult!dteclec5 ' date de cloture de l'exercice N -5
    Try datepc.dte.G = rResult!dtepc ' date dernière période cloturée
    Try datetdec.dte.G = rResult!dtetdec ' date de traitement du dernier exercice cloturé
    Try datefedec.dte.G = rResult!dtefedec ' date fin d'exrcice du dernier exercice cloturé
    Try regulplus.Text = rResult!cptrplus ' Compte de resultat plus
    Try regulmoins.Text = rResult!cptrmoins 'Compte de résultat moins
    Try Jreport.Text = rResult!jdr ' Journal de report
    Try Resultplus.Text = rResult!cptrsplus ' Compte de régul plus
    Try resultmoins.Text = rResult!cptrsmoins ' Compte de régul moins
    Try dnclient.Text = rResult!dnc ' dernier numéro client
    If Error Then dnclient.Text = "411000"
    Try dnfournisseur.Text = rResult!dnf ' dernier numéro fournisseur
    If Error Then dnfournisseur.Text = "401000"
    Try dnbon.Text = rResult!dnbon ' dernier numero de bon
    If Error Then dnbon.Text = "0"
    Try dnfac.Text = rResult!dnfac 'Dernier numéro de facture
    If Error Then dnfac.Text = "0"
    Try coretro.Text = rResult!coretro 'Coefficient retrocession
    If Error Then coretro.Text = "1"
    Try jrnal.Text = rResult!jrnal ' Numéro du journal de ventes
    Try jrnal2.Text = rResult!jrnal2 ' Numéro du journal de caisse
    Try jrnal3.Text = rResult!jrnal3 ' Numéro du journal de banque
    Try jrnal4.Text = rResult!jrnal4 ' Numéro du journal de ventes caisse
    Try jrnal5.Text = rResult!jrnal5 ' Numéro du journal d'achat
    Try Jod.Text = rResult!jrnod      'Numéro du journal d'od
    Try Ecart.Value = rResult!ecart
    Try devise.Text = rResult!devise
    Try mc.Text = rResult!dtepp
    Try mc2.Text = rResult!dtepec
    Try Viremc.Text = rResult!viremc
    Try Viremchq.Text = rResult!viremchq
    Try Virema.Text = rResult!virema
    Try NfacM.value = rResult!nfac
    Try Version.Text = rResult!version
    Try VersionPos.Text = rResult!version_pos
    Try Frais.Value = rResult!frais
    Try cptfrais.Text = rResult!cptfrais
    Try tvafrais.Text = rResult!tvafrais
    Try DnTicket.Text = rResult!dntk
    Try CuTicket.Text = rResult!cutk
    If $soption = "B" Or $soption = "T" Then
      Try conscli.Text = rResult!conscli
      Try consfou.Text = rResult!consfou
      Try css.Text = rResult!css
      Try nvign.Text = rResult!nvign
      Try tvass.Text = rResult!tvass
      Try arretdr.Text = rResult!arrete
      Jod.Text = rResult!jrnod
      rResult = utils.db.Exec("SELECT * FROM Fiches_Societes")
      If rResult.Available Then
        Try ident.Text = rResult!ident
        Try caution.Text = rResult!caution
      Endif
    Endif
    If $soption = "P" Or $soption = "T" Then
      rResult = utils.db.Exec("SELECT * FROM Fiches_Societes")
      If rResult.Available Then
        Try reg.Text = rResult!tipp
      Endif
    Endif
  End With
  datec.SetFocus
  datec.Select

End

Public Sub Par_DblClick()

  Select Case Last.tag

    Case 15
      Dnclient.ReadOnly = False
      Stop Event

    Case 16
      Dnfournisseur.ReadOnly = False
      Stop Event
  End Select

End

Public Sub par_keypress()

  Select Case Last.tag
      Case 15
      ' Control + M pour modidier le code client
      If Key.Control Then
        If Key.code = 77 Then
          dnclient.ReadOnly = False
        Endif
        Stop Event
      Endif

    Case 16
      ' Control + M pour modidier le code fournisseur
      If Key.Control Then
        If Key.code = 77 Then
          dnfournisseur.ReadOnly = False
        Endif
        Stop Event
      Endif
  End Select

  If key.code = key.F1 Then
    Button3_Click()
    Stop Event
  Endif

End

Public Sub Par_lostfocus()

  Dim i, j As Integer
  Dim chaine As String
  
  Select Case Last.tag

      
    Case 31
        If IsNull(Frais.Text) Then Frais.Text = "0,00"
        Frais.Text = Replace(Frais.Text, ".", ",")
        If Not IsNumber(Frais.Text) Then Frais.Text = "0,00"
      
    Case 33
        If Not Veriftva(tvafrais.Text) Then
            If Message.question("ATTENTION ! Ce compte de TVA n'existe pas.\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then
              FTvav.Show
              tvafrais.SetFocus
              tvafrais.Select
            Else
              tvafrais.SetFocus
              tvafrais.Select
            Endif
        Endif


      Case 36
          If Not IsInteger(nvign.Text) Then
            nvign.Clear
            nvign.SetFocus
            nvign.Select
            Stop Event
            Return
          Endif
          chaine = "0000000000000000000000000"
          j = 25
          For i = Len(nvign.Text) To 1 Step -1
            If InStr("0123456789", Mid(nvign.Text, i, 1)) <> 0 Then
              Mid(chaine, j, 1) = Mid(nvign.Text, i, 1)
              j -= 1
            Endif
          Next
          nvign.Text = chaine
          css.SetFocus
          css.Select
          Stop Event
        
      Case 38
          If Not Veriftva(tvass.Text) Then
            If Message.question("ATTENTION ! Ce compte de TVA n'existe pas.\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then
              FTvav.Show
              tvass.SetFocus
              tvass.Select
            Else
              tvass.SetFocus
              tvass.Select
            Endif
          Endif
    
  End Select

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      Button3_Click()

    Case 2
      Button2_Click()

    Case 3
      Button2_Click()
      If b <> 1 Then Me.Close

  End Select

End

Public Sub Form_Close()

  Button2_Click()
  DocActif.Free_Lock("Parametres", "0")
  If b <> 1 Then
    Me.Close
  Else
    Stop Event
  Endif

End


Public Sub cpts_LostFocus()

  Dim bcompte As Boolean

  B = 1
  If son Then
    Music.Play
  Endif
  bcompte = Verif_Compte(Last.Text)
  If Not bcompte Then
    Stop Event
    If Message.question("ATTENTION ! Le compte " & Last.Text & " n'existe pas.\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then
      Fcomptes.Show()
      Last.SetFocus
      Try Last.Select
    Else
      B = 1
      Last.SetFocus
      Try Last.Select
    Endif
  Else
    b = 0
  Endif

End



Public Sub Dnbon_LostFocus()

  If IsNull(Dnbon.text) Then
    If son Then
      Music.Play
    Endif
    Balloon.Warning(("ATTENTION ! Veuillez saisir le numéro du dernier bon SVP !"), Dnbon)
    B = 1
    Dnbon.SetFocus
  Endif

End

Public Sub Dnfac_LostFocus()

  If IsNull(Dnfac.text) Then
    If son Then
      Music.Play
    Endif
    Balloon.Warning(("ATTENTION ! Veuillez saisir le numéro de la dernière facture SVP !"), Dnfac)
    B = 1
    Dnfac.SetFocus
  Endif

End

Public Sub coretro_LostFocus()

  If Coretro.Value = 0 Then
    Coretro.Value = 1
  Endif

End

Public Sub jrnal_LostFocus()

  Dim Jnal As Result
  Dim jal As String

  Jnal = Utils.db.Exec("SELECT * FROM Fiches_Journaux WHERE code_jo = &1", Last.Text)
  If Not Jnal.Available Then
    If son Then
      Music.Play
    Endif
    If Message.Question("Le journal " & Last.Text & "  n'existe pas !\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then
      Fjournaux.show
      Last.SetFocus
      Try Last.Select
    Else
      Last.SetFocus
    Endif
  Else
    Select Case Last
      Case jrnal, jrnal4
        If Jnal!type_jo <> "VE" Then jal = " ventes !"
      Case jrnal2, jrnal3
        If Jnal!type_jo <> "TR" Then jal = " trésorerie !"
      Case jrnal5
        If Jnal!type_jo <> "AC" Then jal = " achat !"
      Case Jod, Jreport
        If Jnal!type_jo <> "OD" Then jal = " OD"
      Case Else
        jal = ""
 
    End Select
    If jal Then
      Message.Warning("Le journal " & Last.Text & "  n'est pas un journal de" & Jal)
      Last.SetFocus
      Try Last.Select
    Endif
  Endif
  
End


Public Sub Dnclient_LostFocus()

  If Left$(Dnclient.Text, 3) <> "411" Then
    b = 1
    If son Then
      Music.Play
    Endif
    Balloon.Warning("Veuillez verifier votre saisie SVP, un compte client doit commencer par 411 !", Dnclient)
  Else
    b = 0
  Endif

End

Public Sub Dnfournisseur_LostFocus()

  If Left$(Dnfournisseur.Text, 3) <> "401" Then
    b = 1
    dnfournisseur.Border = True
    If son Then
      Music.Play
    Endif
    Balloon.Warning("Veuillez verifier votre saisie SVP, un compte fournisseur doit commencer par 401 !", Dnfournisseur)
  Else
    b = 0
    Dnfournisseur.Border = False
  Endif

End

Public Sub mcdt(mc As TextReg)

  Dim smc As String

  With Utils
    smc = mc.text
    smc = "01." & smc
    smc = .Cdate_calc(smc)
    smc = .Cdate_aff(smc)
    mc.text = Mid$(smc, 4, 3) & Right$(smc, 4)
    If mc.Text = "00.0:00" Then
      B = 1
      Mc.SetFocus
      Mc.Select
    Endif
  End With

End

Public Sub Button2_Click()

  Tab = "Fiches_Parametres"
  b = 0
  If IsNull(datec.dte.G) Then b = 1
  If IsNull(date1.dte.G) Then b = 1
  If IsNull(date2.dte.G) Then b = 1
  If IsNull(date3.dte.G) Then b = 1
  If IsNull(date4.dte.G) Then b = 1
  If IsNull(date5.dte.G) Then b = 1
  If IsNull(datepc.dte.G) Then b = 1
  If IsNull(datetdec.dte.G) Then b = 1
  If IsNan(datefedec.dte.G) Then b = 1
  If IsNull(Regulplus.Text) Then b = 1
  If IsNull(Regulmoins.Text) Then b = 1
  If IsNull(jrnal4.Text) Then b = 1
  If IsNull(Jod.Text) Then b = 1
  If IsNull(Resultmoins.Text) Then b = 1
  If IsNull(Resultplus.Text) Then b = 1
  If cptfrais.Text <> Null And Not Verif_Compte(cptfrais.Text) And b = 0 Then meserrc(cptfrais)
  If tvafrais.Text <> Null And Not Veriftva(tvafrais.Text) And b = 0 Then meserrt(tvafrais)
  If IsNull(jrnal.Text) Then b = 1
  If IsNull(jrnal2.Text) Then b = 1
  If IsNull(jrnal3.Text) Then b = 1
  If IsNull(Dnfournisseur.Text) Then b = 1
  If IsNull(Dnclient.Text) Then b = 1
  If IsNull(Coretro.Text) Then b = 1
  If IsNull(Dnbon.Text) Then b = 1
  If IsNull(Dnfac.Text) Then b = 1
  If b = 0 Then mcdt(mc)
  If b = 0 Then mcdt(mc2)
  If IsNull(Viremc.Text) Then b = 1
  If IsNull(Viremchq.Text) Then b = 1
  If IsNull(Virema.Text) Then b = 1
  If Start.LocalSettings["/Soc" & Start.Societe & "/Caisse"] = True Then
    If IsNull(jrnal4.Text) Then b = 1
  Endif
  If IsNull(jrnal5.Text) Then b = 1
  If $soption = "B" Or $soption = "T" Then
    If Not Verif_Compte(conscli.Text) And b = 0 Then meserrc(conscli)
    If Not Verif_Compte(consfou.Text) And b = 0 Then meserrc(consfou)
    If Not Verif_Compte(css.Text) And b = 0 Then meserrc(css)
    If Not Veriftva(tvass.Text) And b = 0 Then meserrt(tvass)
    
  Endif
  With utils
    If b <> 1 Then
      Utils.db.Exec("UPdate  " & Tab & "  SET  dteclec = &1, dteclec1 = &2, dteclec2 =&3,  dteclec3 =&4, dteclec4 =&5, dteclec5 =&6,  dtepc =&7, dtetdec =&8, dtefedec =&9, cptrplus =&{10}, cptrmoins =&{11}, jdr =&{12}, cptrsplus =&{13}, cptrsmoins =&{14},dnc = &{15}, dnf = &{16}, dnbon = &{17}, dnfac = &{18}, coretro = &{19}, jrnal = &{20}, jrnal2 = &{21}, jrnal3 = &{22}, devise = &{23}, dtepp = &{24}, dtepec = &{25}, viremc = &{26}, viremchq = &{27}, virema = &{28}, jrnal4 = &{29}, jrnal5 = &{30}, nfac = &{31}, version = &{32}, version_pos = &{33}", datec.dte.G, date1.dte.G, date2.dte.G, date3.dte.G, date4.dte.G, date5.dte.G, datepc.dte.G, datetdec.dte.G, datefedec.dte.G, regulplus.Text, regulmoins.Text, Jreport.Text, Resultplus.Text, Resultmoins.Text, dnclient.Text, dnfournisseur.Text, dnbon.Text, dnfac.Text, coretro.Text, jrnal.Text, jrnal2.Text, jrnal3.Text, devise.text, mc.Text, mc2.Text, Viremc.Text, Viremchq.Text, Virema.Text, jrnal4.Text, jrnal5.Text, NfacM.value, Version.text, VersionPos.text)
      Utils.db.Exec("UPdate  " & Tab & "  SET  frais = &1, cptfrais = &2, tvafrais = &3, cutk = &4, dntk = &5, jrnod = &6, ecart = &7", frais.Value, cptfrais.Text, tvafrais.Text, CuTicket.Text, DnTicket.Text, Jod.Text, Ecart.Value)
      If $soption = "B" Or $soption = "T" Then
         Utils.db.Exec("UPdate  " & Tab & "  SET conscli = &1, consfou = &2, nvign = &3, css = &4, tvass = &5,arrete=&6", conscli.Text, consfou.Text, nvign.Text, css.Text, tvass.Text, arretdr.Text) 
         utils.db.Exec("UPdate Fiches_Societes SET ident=&1, caution=&2", ident.Text, caution.Text)
      Endif
      If $soption = "P" Or $soption = "T" Then 
        utils.db.Exec("UPdate Fiches_Societes SET tipp=&1", reg.Text)
      Endif
      datec.SetFocus
      datec.Select
    Else
      Message.Error("Veuillez complèter correctement l'ensemble des zones SVP !")
    Endif
  End With

End

Public Sub meserrc(txtbox As TextBox)

  b = 1
  If Message.question("ATTENTION ! Ce compte n'existe pas.\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then Fcomptes.Show()
  txtbox.SetFocus
  txtbox.Select

End

Public Sub meserrt(txtbox As TextBox)

  b = 1
  If Message.question("ATTENTION ! Ce compte de TVA n'existe pas.\nVoulez-vous le créer ?", "Oui", "Non") = 1 Then FTvav.Show
  txtbox.SetFocus
  txtbox.Select

End

Public Sub Verif_Compte(Compte As String) As Boolean

  Dim Cpt As Result

  Cpt = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " WHERE compte_cc = &1", Compte)
  If Not Cpt.Available Then
    Return False
  Else
    Return True
  Endif

End

Private Function Veriftva(tva As String) As Boolean
  
  Dim res As Result
  
  res = utils.db.Exec("SELECT * FROM Fiches_Tvaav WHERE code_tva=&1", tva) 
  Return res.Available
  
End

Public Sub Button3_Click()

  Doc.Open("Parametres")

End

Public Sub Version_DblClick()

  Version.ReadOnly = False

End


Public Sub VersionPos_KeyPress()

  VersionPos.ReadOnly = False

End
